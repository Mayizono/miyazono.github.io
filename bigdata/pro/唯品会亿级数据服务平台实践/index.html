<!-- build time:Thu May 22 2025 09:49:59 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/atom.xml"><link rel="alternate" type="application/json" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E5%94%AF%E5%93%81%E4%BC%9A%E4%BA%BF%E7%BA%A7%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%E5%AE%9E%E8%B7%B5/"><title>唯品会亿级数据服务平台实践 - 大厂学习 - 大数据 | Yume Shoka = 冬樱茶</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">唯品会亿级数据服务平台实践</h1><div class="meta"><span class="item" title="创建时间：2021-08-23 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-08-23T00:00:00+08:00">2021-08-23</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>6.4k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>6 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Yume Shoka</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1giclize41wj20zk0m87gk.jpg"></li><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1gicis081o9j20zk0m8dmr.jpg"></li><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1gipeun65urj20zk0m81ii.jpg"></li><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1gipeyonbf9j20zk0m8e81.jpg"></li><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1gicitzannuj20zk0m8b29.jpg"></li><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1giclh3brzpj20zk0m8ann.jpg"></li></ul></div><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div></header><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/bigdata/" itemprop="item" rel="index" title="分类于 大数据"><span itemprop="name">大数据</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/bigdata/pro/" itemprop="item" rel="index" title="分类于 大厂学习"><span itemprop="name">大厂学习</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E5%94%AF%E5%93%81%E4%BC%9A%E4%BA%BF%E7%BA%A7%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%E5%AE%9E%E8%B7%B5/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Miyazono"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="冬樱茶"></span><div class="body md" itemprop="articleBody"><p>数据服务是数据中台体系中的关键组成部分。作为数仓对接上层应用的统一出入口，数据服务将数仓当作一个统一的 DB 来访问，提供统一的 API 接口控制数据的流入及流出，能够满足用户对不同类型数据的访问需求。</p><p>电商平台唯品会的数据服务自 2019 年开始建设，在公司内经历了从无到有落地，再到为超过 30 + 业务方提供 To B、To C 的数据服务的过程。本文主要介绍唯品会自研数据服务 Hera 的相关背景、架构设计和核心功能。</p><h2 id="背景介绍"><a class="anchor" href="#背景介绍">#</a> <strong>背景介绍</strong></h2><p>在统一数仓数据服务之前，数仓提供的访问接入方式往往存在效率问题低、数据指标难统一等问题，具体而言有以下几个比较突出的情况：</p><ul><li>广告人群 USP、DMP 系统每天需要通过 HiveServer 以流的方式从数仓导出数据到本地，每个人群的数据量从几十万到几个亿，人群数量 2w+，每个人群运行时间在 30min +，部分大人群的运行直接超过 1h，在资源紧张的情况下，人群延迟情况严重。</li><li>数仓的数据在被数据产品使用时，需要为每个表新生成一个单独的接口，应用端需要为每一种访问方式（如 Presto、ClickHouse）区分使用不同的接口，导致数据产品接口暴涨，不方便维护，影响开发及维护效率。数据在不同的存储时，需要包含 clickhouse-client，presto-client 等等第三方 jar 包。</li><li>不同数据产品中都需要使用一些常用的数据指标，如销售额、订单数、PV、UV 等，而这些数据在不同数据产品的实现口径、实现方式都不一样，无法形成数据共享，每个数据产品都重复进行相同的指标建设。因此，在不同数据产品查看相同指标却发现数值不同的情况下，难以判断哪个数据产品提供的数据是准确的。</li></ul><p><img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/11a5ebc6b5fb6e3a5f8eded58ed33b42.png" alt="img"></p><p>图 1. 数据流入流出方式</p><p>为解决以上问题，数据服务应运而生。目前数据服务的主要优势有：屏蔽底层的存储引擎、计算引擎，使用同一个 API（one service），数仓数据分层存储，不同 Engine 的 SQL 生成能力，自适应 SQL 执行以及统一缓存架构保障业务 SLA，支持数据注册并授权给任何调用方进行使用，提高数据交付效率。</p><p>通过唯一的 ID 标识，数据产品可通过 ID 查阅数据，而非直接访问对应的数仓表。一方面，指标服务统一了指标的口径，同时也支持快速构建新的数据产品。</p><h2 id="架构设计"><a class="anchor" href="#架构设计">#</a> <strong>架构设计</strong></h2><p>数据服务能给业务带来运营和商业价值，核心在于给用户提供自助分析数据能力。Hera 整体架构基于典型的 Master/slave 模型，数据流与控制流单独链路，从而保障系统的高可用性。数据服务系统主要分为三层：</p><ol><li>应用接入层：业务申请接入时，可以根据业务要求选择数据服务 API（TCP Client)，HTTP 以及 OSP 服务接口（公司内部 RPC 框架）。</li><li>数据服务层：主要执行业务提交的任务，并返回结果。主要功能点包括：路由策略，多引擎支持，引擎资源配置，引擎参数动态组装，SQL Lispengine 生成，SQL 自适应执行，统一数据查询缓存，FreeMaker SQL 动态生成等功能。</li><li>数据层：业务查询的数据无论在数仓、Clickhouse、MySQL 还是 Redis 中，都可以很好地得到支持，用户都使用同一套 API。</li></ol><p><img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/af2c0810cdc4d45854f90cce7a854bd1.png" alt="img"></p><p>图 2. 数据服务整体架构图</p><p>调度系统的整体流程大致包含以下模块：</p><ul><li>Master：负责管理所有的 Worker、TransferServer、AdhocWorker 节点，同时负责调度分发作业；</li><li>Worker：负责执行 ETL 和数据文件导出类型的作业，拉起 AdhocWorker 进程（Adhoc 任务在 AdhocWorker 进程中的线程池中执行），ETL 类型的作业通过子进程的方式完成；</li><li>Client：客户端，用于编程式地提交 SQL 作业；</li><li>ConfigCenter：负责向集群推送统一配置信息及其它运行时相关的配置和 SQLParser （根据给定的规则解析、替换、生成改写 SQL 语句，以支持不同计算引擎的执行）；</li><li>TransferServer：文件传输服务。</li></ul><p><img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/d2a5cf2c11e929194fe55db196cf5f5b.png" alt="img"></p><p>图 3. 数据服务调度流程图</p><h2 id="主要功能"><a class="anchor" href="#主要功能">#</a> <strong>主要功能</strong></h2><p>Hera 数据服务的主要功能有：多队列调度策略、多引擎查询、多任务类型、文件导出、资源隔离、引擎参数动态组装、自适应 Engine 执行和 SQL 构建。</p><h3 id="多队列调度策略"><a class="anchor" href="#多队列调度策略">#</a> <strong>多队列调度策略</strong></h3><p>数据服务支持按照不同用户、不同任务类型并根据权重划分不同调度队列，以满足不同任务类型的 SLA。</p><h3 id="多引擎查询"><a class="anchor" href="#多引擎查询">#</a> <strong>多引擎查询</strong></h3><p>数据服务支持目前公司内部所有 OLAP 和数据库类型，包括 Spark、Presto、Clickhouse、Hive 、MySQL、Redis。会根据业务具体场景和要求，选择当前最佳的查询引擎。</p><h3 id="多任务类型"><a class="anchor" href="#多任务类型">#</a> <strong>多任务类型</strong></h3><p>数据服务支持的任务类型有：ETL、Adhoc、文件导出、数据导入。加上多引擎功能，实现多种功能组合，如 Spark adhoc 和 Presto adhoc。</p><h3 id="文件导出"><a class="anchor" href="#文件导出">#</a> <strong>文件导出</strong></h3><p>主要是支持大量的数据从数据仓库中导出，便于业务分析和处理，比如供应商发券和信息推送等。</p><p>具体执行过程如下：用户提交需要导出数据的 SQL，通过分布式 engine 执行完成后，落地文件到 hdfs/alluxio. 客户端通过 TCP 拉取文件到本地。千万亿级的数据导出耗时最多 10min。数据导出在人群数据导出上性能由原来的 30min+ ，提升到最多不超过 3min，性能提升 10~30 倍。具体流程如下：</p><p><img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/18a0f8bb17025642866ab5c212b31508.png" alt="img"></p><p>图 4. 数据服务文件下载流程图</p><h3><a class="anchor" href="#">#</a></h3><h3 id="资源隔离worker-资源和计算资源"><a class="anchor" href="#资源隔离worker-资源和计算资源">#</a> <strong>资源隔离（Worker 资源和计算资源）</strong></h3><p>业务一般分为核心和非核心，在资源分配和调度上也不同。主要是从执行任务 Worker 和引擎资源，都可以实现物理级别的隔离，最大化减少不同业务之间相互影响。</p><h3 id="引擎参数动态组装"><a class="anchor" href="#引擎参数动态组装">#</a> <strong>引擎参数动态组装</strong></h3><p>线上业务执行需要根据业务情况进行调优，动态限制用户资源使用，集群整体切换等操作，这个时候就需要对用户作业参数动态修改，如 OLAP 引擎执行任务时，经常都要根据任务调优，设置不同参数。针对这类问题，数据服务提供了根据引擎类型自动组装引擎参数，并且引擎参数支持动态调整，也可以针对特定任务、执行账号、业务类型来设定 OLAP 引擎执行参数。</p><h3 id="自适应-engine-执行"><a class="anchor" href="#自适应-engine-执行">#</a> <strong>自适应 Engine 执行</strong></h3><p>业务方在查询时，有可能因为引擎资源不足或者查询条件数据类型不匹配从而导致执行失败。为了提高查询成功率和服务 SLA 保障，设计了 Ad Hoc 自适应引擎执行，当一个引擎执行报错后，会切换到另外一个引擎继续执行。具体自适应执行逻辑如下图所示：</p><p><img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/4536195ec8db494c31a5764d4309d0a9.png" alt="img"></p><p>图 5. 自适应 Engine 执行</p><h3 id="-2"><a class="anchor" href="#-2">#</a></h3><h3 id="sql构建"><a class="anchor" href="#sql构建">#</a> <strong>SQL 构建</strong></h3><p>数据服务 SQL 构建基于维度事实建模，支持单表模型、星型模型和雪花模型。</p><ul><li>单表模型：一张事实表，一般为 DWS 或者 ADS 的汇总事实表。</li><li>星型模型：1 张事实表（如 DWD 明细事实表）+ N 张维表，例如订单明细表 (事实表 FK = 商品 ID) + 商品维表 (维度表 PK = 商品 ID) 。</li><li>雪花模型：1 张事实表（如 DWD 明细事实表）+ N 张维表 + M 张没有直接连接到事实表的维表，例如订单明细表 (事实表 FK = 商品 ID)　+ 商品维表 (维度表 PK = 商品 ID，FK = 品类 ID) + 品类维表 (维度表 PK = 品类 ID）。</li></ul><p><img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/d6f1e283133d7bfc1ccb4d66398677cf.png" alt="img"></p><p>图 6.SQL 维度模型</p><h4 id="-3"><a class="anchor" href="#-3">#</a></h4><h3 id="任务调度"><a class="anchor" href="#任务调度">#</a> <strong>任务调度</strong></h3><p>基于 Netty 库收发集群消息，系统仅仅使用同一个线程池对象 EventLoopGroup 来收发消息，而用户的业务逻辑，则交由一个单独的线程池。</p><p>选用 Netty 的另外一个原因是 “零拷贝” 的能力，在大量数据返回时，通过文件的形式直接将结果送给调用者。</p><h4 id="多队列多用户调度"><a class="anchor" href="#多队列多用户调度">#</a> <strong>多队列 + 多用户调度</strong></h4><p>业务需求通常包含时间敏感与不敏感作业，为了提高作业的稳定性和系统的可配置性，Hera 提供了多队列作业调度的功能。</p><p>用户在提交作业时可以显式地指定一个作业队列名，当这个作业在提交到集群时，如果相应的队列有空闲，则就会被添加进相应的队列中，否则返回具体的错误给客户端，如任务队列满、队列名不存在、队列已经关闭等，客户端可以选择 “是否重试提交”。</p><p>当一个作业被添加进队列之后，Master 就会立即尝试调度这个队列中的作业，基于以下条件选择合适的作业运行：</p><ol><li>每个队列都有自己的权重，同时会设置占用整个集群的资源总量，如最多使用多少内存、最多运行的任务数量等。</li><li>队列中的任务也有自己的权重，同时会记录这个作业入队的时间，在排序当前队列的作业时，利用入队的时间偏移量和总的超时时间，计算得到一个最终的评分。</li><li>除了调度系统本身的调度策略外，还需要考虑外部计算集群的负载，在从某个队列中拿出一个作业后，再进行一次过滤，或者是先过滤，再进行作业的评分计算。</li></ol><p>一个可用的计算作业评分模型如下：</p><p>队列动态因子 = 队列大小 / 队列容量 * (1 - 作业运行数 / 队列并行度)</p><p>这个等式表示的意义是：如果某个队列正在等待的作业的占比比较大，同时并行运行的作业数占比也比较大时，这个队列的作业就拥有一个更大的因子，也就意味着在队列权重相同时，这个队列中的作业应该被优先调度。</p><p>作业权重 = 1 - (当前时间 - 入队时间) / 超时时间</p><p>这个等式表示的意义是：在同一个队列中，如果一个作业的剩余超时时间越少，则意味着此作业将更快达到超时，因此它应该获得更大的选择机会。</p><p>Score = 作业权重 + 队列动态因子 + 队列权重</p><p>这个等式表示的意义是：对于所有的队列中的所有任务，首先决定一个作业是否优先被调度的因子是设置的队列权重，例如权重为 10 的队列的作业，应该比权重为 1 的队列中的作业被优先调度，而不管作业本身的权重（是否会有很大的机率超时）；其次影响作业调度优先级的因子是队列动态因子，例如有两个相同权重的队列时，如果一个队列的动态因子为 0.5，另外一个队列的动态因子是 0.3，那么应该优先选择动态因子为 0.5 的队列作业进行调度，而不管作业本身的权重；最后影响作业调度优先级的因子是作业权重，例如在同一个队列中，有两个权重分别为 0.2 和 0.5 的作业，那么为了避免更多的作业超时，权重为 0.2 的作业应该被优先调度。</p><p>简单描述作业的排序过程就是，首先按队列权重排序所有的队列；对于有重复的队列，则会计算每个队列的动态因子，并按此因子排序；对于每一个队列，作业的排序规则按作业的超时比率来排序；最终依次按序遍历每一个队列，尝试从中选择足够多的作业运行，直到作业都被运行或是达到集群限制条件。这里说足够多，是指每一个队列都会有一个最大的并行度和最大资源占比，这两个限制队列的参数组合，是为了避免因某一个队列的容量和并行度被设置的过大，可能超过了整个集群，导致其它队列被 “饿死” 的情况。</p><h4 id="sql作业流程"><a class="anchor" href="#sql作业流程">#</a> <strong>SQL 作业流程</strong></h4><p>用户通过 Client 提交原始 SQL，这里以 Presto SQL 为例，Client 在提交作业时，指定了 SQL 路由，则会首先通过访问 SQLParser 服务，在发送给 Master 之前，会首先提交 SQL 语句到 SQLParser 服务器，将 SQL 解析成后端计算集群可以支持的 SQL 语句，如 Spark、Presto、ClickHouse 等，为了能够减少 RPC 交互次数，SQLParser 会一次返回所有可能被改写的 SQL 语句。</p><p>在接收到 SQLParser 服务返回的多个可能 SQL 语句后，就会填充当前的作业对象，真正开始向 Master 提交运行。</p><p>Master 在收到用户提交的作业后，会根据一定的调度策略，最终将任务分发到合适的 Worker 上，开始执行。Worker 会首先采用 SQL 作业默认的执行引擎，比如 Presto，提交到对应的计算集群运行，但如果因为某种原因不能得到结果，则会尝试使用其它的计算引擎进行计算。当然这里也可以同时向多个计算集群提交作业，一旦某个集群首先返回结果时，就取消所有其它的作业，不过这需要其它计算集群的入口能够支持取消操作。</p><p>当 SQL 作业完成后，将结果返回到 Worker 端，为了能够更加高效地将查询结果返回给 Client 端，Worker 会从 Master 发送的任务对象中提取 Client 侧信息，并将结果直接发送给 Client，直到收到确认信息，至此整个任务才算执行完毕。</p><p>在整个作业的流转过程中，会以任务的概念在调度系统中进行传播，并经历几个状态的更新，分别标识 new、waiting、running、succeed、failed 阶段。</p><p><img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/49067d5554cb67edbf7807d0aabd9d59.png" alt="img"></p><p>图 9. SQL 作业处理流程</p><h4 id="metrics-采集"><a class="anchor" href="#metrics-采集">#</a> <strong>Metrics 采集</strong></h4><p>数据服务搜集两类 metrics，一类静态的，用于描述 master/worker/client 的基本信息；一类是动态的，描述 master/worker 的运行时信息。这里主要说明一下有关集群动态信息的采集过程及作用。以 worker 为例，当 worker 成功注册到 master 时，就会开启定时心跳汇报动作，并借道心跳请求，将自己的运行时信息汇报给 master。这里主要是内存使用情况，例如当前 worker 通过估算方法，统计目前运行的任务占据了多少内存，以便 master 能够在后续的任务分发过程中，能够根据内存信息进行决策。master 会统计它所管理的集群整个情况，例如每个任务队列的快照信息、worker 的快照信息、集群的运行时配置信息等，并通过参数控制是否打印这些信息，以便调试。</p><h2 id="解决的性能问题"><a class="anchor" href="#解决的性能问题">#</a> <strong>解决的性能问题</strong></h2><p>数据服务主要解决 SLA 方面的问题。如人群计算、数据无缝迁移、数据产品 SLA 等，这里用人群举例说明如下：</p><p>人群计算遇到的问题：</p><ol><li>人群计算任务的数据本地性不好；</li><li>HDFS 存在数据热点问题；</li><li>HDFS 读写本身存在长尾现象。</li></ol><p>数据服务改造新的架构方案：</p><ul><li>计算与存储同置，这样数据就不需通过网络反复读取，造成网络流量浪费。</li><li>减少 HDFS 读写长尾对人群计算造成的额外影响，同时减少人群计算对于 HDFS 稳定性的影响。</li><li>广告人群计算介于线上生产任务跟离线任务之间的任务类型。这里我们希望能保证这类应用的可靠性和稳定性，从而更好地为公司业务赋能</li><li>通过数据服务执行人群计算。</li></ul><p><img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/6eec9872a3827c1d42782fb13b4a5875.png" alt="img"></p><p>图 10. Alluxio 和 Spark 集群混部</p><h4 id="基于-alluxio-的缓存表同步"><a class="anchor" href="#基于-alluxio-的缓存表同步">#</a> <strong>基于 Alluxio 的缓存表同步</strong></h4><p>将 Hive 表的 location 从 HDFS 路径替换为 Alluxio 路径，即表示该表的数据存储于 Alluxio 中。我们使用的方案不是直接写通过 ETL 任务写 Alluxio 表的数据，而是由 Alluxio 主动去拉取同样 Hive 表结构的 HDFS 中的数据，即我们创建了一个 HDFS 表的 Alluxio 缓存表。</p><p>由于 Alluxio 不能感知到分区表的变化，我们开发了一个定时任务去自动感知源表的分区变化，使得 Hive 表的数据能够同步到 Alluxio 中。</p><p>具体步骤如下：</p><ol><li>定时任务发起轮询，检测源表是否有新增分区。</li><li>发起一个 SYN2ALLUXIO 的任务由数据服务执行。</li><li>任务执行脚本为将 Alluxio 表添加与 HDFS 表相同的分区。</li><li>分区添加完成之后，Alluxio 会自动从 mount 的 HDFS 路径完成数据同步。</li></ol><p><img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/9eacc05249185b5190799eb46cacc6e6.png" alt="img"></p><p>图 11. Alluxio 缓存表同步</p><h4 id="人群计算任务"><a class="anchor" href="#人群计算任务">#</a> <strong>人群计算任务</strong></h4><p>上小节介绍了如何让 Alluxio 和 HDFS 的 Hive 表保持数据同步，接下来需要做的就是让任务计算的 Spark 任务跑在 Spark 与 Alluxio 混部的集群上，充分利用数据的本地性以及计算资源的隔离性，提高人群计算效率。</p><p>人群服务通过调用数据服务执行。数据服务根据底表分区是否同步到 Alluxio 决定是否需要下推是用 Alluxio 表来完成计算。如果底表数据已经同步到 Alluxio，则使用 Alluxio 表来做为底表计算人群。</p><p>依靠数据服务调度系统，通过用户 SQL 改写以及 Alluxio 和 Spark 计算结点混部模式，人群计算任务提速了 10%~30%。</p><h2 id="小结"><a class="anchor" href="#小结">#</a> <strong>小结</strong></h2><p>虽然截至今天，Hera 数据服务已经支持了很多生产业务，但目前仍有很多需要完善的地方：</p><ul><li>不同 engine 存在同一个含义函数写法不一致的情况。这种情况在 Presto 跟 ClickHouse 的函数比较时尤为突出，如 Presto 的 strpos（string, substring）函数，在 Clickhouse 中为 position (haystack, needle [, start_pos])，且这些函数的参数顺序存在不一致的情况，如何更优雅地支持不同 engine 的差异情况还需要进一步思考。</li><li>人群计算采用业界通用的 ClickHouse BitMap 解决方案落地，提升人群的计算效率同时扩展数据服务的业务边界。</li></ul></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-09-30 10:48:29" itemprop="dateModified" datetime="2021-09-30T10:48:29+08:00">2021-09-30</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Miyazono <i class="ic i-at"><em>@</em></i>冬樱茶</li><li class="link"><strong>本文链接：</strong> <a href="https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E5%94%AF%E5%93%81%E4%BC%9A%E4%BA%BF%E7%BA%A7%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%E5%AE%9E%E8%B7%B5/" title="唯品会亿级数据服务平台实践">https://github.com/Mayizono/miyazono.github.io/bigdata/pro/唯品会亿级数据服务平台实践/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/bigdata/pro/%E6%BB%B4%E6%BB%B4%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97%E5%8F%91%E5%B1%95%E4%B9%8B%E8%B7%AF%E5%8F%8A%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;i3.wp.com&#x2F;wx4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipeuv80yoj20zk0m8kjl.jpg" title="滴滴实时计算发展之路及平台架构实践"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 大厂学习</span><h3>滴滴实时计算发展之路及平台架构实践</h3></a></div><div class="item right"><a href="/cipher/cg/%E6%96%B0%E5%BB%BA%E6%96%87%E6%9C%AC%E6%96%87%E6%A1%A3/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;i3.wp.com&#x2F;wx4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclil3m4ej20zk0m8tn8.jpg" title="数据集市搭建过程"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> CG</span><h3>数据集市搭建过程</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">背景介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">架构设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-number">3.</span> <span class="toc-text">主要功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E9%98%9F%E5%88%97%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5"><span class="toc-number">3.1.</span> <span class="toc-text">多队列调度策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%BC%95%E6%93%8E%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.</span> <span class="toc-text">多引擎查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.3.</span> <span class="toc-text">多任务类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%AF%BC%E5%87%BA"><span class="toc-number">3.4.</span> <span class="toc-text">文件导出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">3.5.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BBworker-%E8%B5%84%E6%BA%90%E5%92%8C%E8%AE%A1%E7%AE%97%E8%B5%84%E6%BA%90"><span class="toc-number">3.6.</span> <span class="toc-text">资源隔离（Worker 资源和计算资源）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E6%93%8E%E5%8F%82%E6%95%B0%E5%8A%A8%E6%80%81%E7%BB%84%E8%A3%85"><span class="toc-number">3.7.</span> <span class="toc-text">引擎参数动态组装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E9%80%82%E5%BA%94-engine-%E6%89%A7%E8%A1%8C"><span class="toc-number">3.8.</span> <span class="toc-text">自适应 Engine 执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-2"><span class="toc-number">3.9.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sql%E6%9E%84%E5%BB%BA"><span class="toc-number">3.10.</span> <span class="toc-text">SQL 构建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#-3"><span class="toc-number">3.10.1.</span> <span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6"><span class="toc-number">3.11.</span> <span class="toc-text">任务调度</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E9%98%9F%E5%88%97%E5%A4%9A%E7%94%A8%E6%88%B7%E8%B0%83%E5%BA%A6"><span class="toc-number">3.11.1.</span> <span class="toc-text">多队列 + 多用户调度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sql%E4%BD%9C%E4%B8%9A%E6%B5%81%E7%A8%8B"><span class="toc-number">3.11.2.</span> <span class="toc-text">SQL 作业流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#metrics-%E9%87%87%E9%9B%86"><span class="toc-number">3.11.3.</span> <span class="toc-text">Metrics 采集</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%9A%84%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="toc-number">4.</span> <span class="toc-text">解决的性能问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-alluxio-%E7%9A%84%E7%BC%93%E5%AD%98%E8%A1%A8%E5%90%8C%E6%AD%A5"><span class="toc-number">4.0.1.</span> <span class="toc-text">基于 Alluxio 的缓存表同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%BA%E7%BE%A4%E8%AE%A1%E7%AE%97%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.0.2.</span> <span class="toc-text">人群计算任务</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a></li></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/bigdata/pro/%E6%BB%B4%E6%BB%B4%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97%E5%8F%91%E5%B1%95%E4%B9%8B%E8%B7%AF%E5%8F%8A%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5/" rel="bookmark" title="滴滴实时计算发展之路及平台架构实践">滴滴实时计算发展之路及平台架构实践</a></li><li class="active"><a href="/bigdata/pro/%E5%94%AF%E5%93%81%E4%BC%9A%E4%BA%BF%E7%BA%A7%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%E5%AE%9E%E8%B7%B5/" rel="bookmark" title="唯品会亿级数据服务平台实践">唯品会亿级数据服务平台实践</a></li><li><a href="/bigdata/pro/%E8%85%BE%E8%AE%AF%20ClickHouse%20%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5/" rel="bookmark" title="腾讯 ClickHouse 应用实践">腾讯 ClickHouse 应用实践</a></li><li><a href="/bigdata/pro/%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4OneData/" rel="bookmark" title="阿里巴巴OneData">阿里巴巴OneData</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Miyazono" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Miyazono</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">24</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">11</span> <span class="name">分类</span></a></div></nav><div class="social"><a href="https://github.com/Mayizono" title="https:&#x2F;&#x2F;github.com&#x2F;Mayizono" class="item github"><i class="ic i-github"></i></a> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEzNDMzNjQzOQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;134336439"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vdS8yOTAwNzY4Nzky" title="https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;2900768792"><i class="ic i-weibo"></i></span> <span class="exturl item email" data-url="aHR0cHM6Ly94eW5zdHVkeUAxNjMuY29t" title="https:&#x2F;&#x2F;xynstudy@163.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/mikutap/" rel="section"><i class="ic i-star"></i>mikutap</a></li><li class="item"><a href="/time" rel="section"><i class="ic i-heart"></i>time</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/bigdata/pro/%E6%BB%B4%E6%BB%B4%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97%E5%8F%91%E5%B1%95%E4%B9%8B%E8%B7%AF%E5%8F%8A%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/cipher/cg/%E6%96%B0%E5%BB%BA%E6%96%87%E6%9C%AC%E6%96%87%E6%A1%A3/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/flink/" title="分类于 Flink">Flink</a></div><span><a href="/bigdata/flink/Flink%E7%9A%84Window%E6%9C%BA%E5%88%B6/" title="Flink的窗口机制">Flink的窗口机制</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/flink/" title="分类于 Flink">Flink</a></div><span><a href="/bigdata/flink/Flink%E7%9A%84%E6%9E%B6%E6%9E%84/" title="Flink的架构">Flink的架构</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/zookeeper/" title="分类于 Zookeeper">Zookeeper</a></div><span><a href="/bigdata/zookeeper/zookeeper%E6%80%BB%E7%BB%93/" title="zookeeper总结">zookeeper总结</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/hive/" title="分类于 Hive">Hive</a></div><span><a href="/bigdata/hive/HQL%E7%BB%83%E4%B9%A0%E9%A2%98/" title="HQL练习题">HQL练习题</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/kafka/" title="分类于 Kafka">Kafka</a></div><span><a href="/bigdata/kafka/Kafka%E6%80%BB%E7%BB%93/" title="Kafka学习">Kafka学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/hive/" title="分类于 Hive">Hive</a></div><span><a href="/bigdata/hive/Hive%20%E5%AD%A6%E4%B9%A0/" title="Hive学习">Hive学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/kafka/" title="分类于 Kafka">Kafka</a></div><span><a href="/bigdata/kafka/Kafka%E3%80%81Redis%E3%80%81Pulsar%E5%AF%B9%E6%AF%94/" title="Kafka、Redis、Pulsar对比">Kafka、Redis、Pulsar对比</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/flink/" title="分类于 Flink">Flink</a></div><span><a href="/bigdata/flink/1_Nginx/" title="负载均衡Nginx的使用">负载均衡Nginx的使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/pgsql/" title="分类于 PostgreSQL">PostgreSQL</a></div><span><a href="/bigdata/pgsql/Postgresql%E5%AD%A6%E4%B9%A0/" title="PgSql学习">PgSql学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/flink/" title="分类于 Flink">Flink</a></div><span><a href="/bigdata/flink/Flink%E7%AE%A1%E7%90%86Kafka%E7%9A%84%E6%B6%88%E8%B4%B9%E4%BD%8D%E7%82%B9/" title="Flink管理 Kafka 消费位点">Flink管理 Kafka 消费位点</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Miyazono @ Yume Shoka</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">463k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">7:01</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<a href="https://github.com/amehime/hexo-theme-shoka">Shoka</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"bigdata/pro/唯品会亿级数据服务平台实践/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->