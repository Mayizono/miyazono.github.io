<!-- build time:Thu May 22 2025 09:30:34 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/atom.xml"><link rel="alternate" type="application/json" title="冬樱茶" href="https://github.com/Mayizono/miyazono.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://github.com/Mayizono/miyazono.github.io/bigdata/flume/Flume/"><title>Flume 基础学习 - Flume - 大数据 | Yume Shoka = 冬樱茶</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Flume 基础学习</h1><div class="meta"><span class="item" title="创建时间：2019-01-02 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2019-01-02T00:00:00+08:00">2019-01-02</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>12k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>11 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Yume Shoka</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1gipewf5l51j20zk0m8b29.jpg"></li><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1giclj61ylzj20zk0m8b29.jpg"></li><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1giciryrr3rj20zk0m8nhk.jpg"></li><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1gipeubcbajj20zk0m8h1h.jpg"></li><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1giclip4jbpj20zk0m87cv.jpg"></li><li class="item" data-background-image="https://i3.wp.com/wx4.sinaimg.cn/large/6833939bly1gipeun65urj20zk0m81ii.jpg"></li></ul></div><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div></header><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/bigdata/" itemprop="item" rel="index" title="分类于 大数据"><span itemprop="name">大数据</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/bigdata/flume/" itemprop="item" rel="index" title="分类于 Flume"><span itemprop="name">Flume</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://github.com/Mayizono/miyazono.github.io/bigdata/flume/Flume/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Miyazono"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="冬樱茶"></span><div class="body md" itemprop="articleBody"><h2 id="一-写flume的步骤"><a class="anchor" href="#一-写flume的步骤">#</a> 一、写 flume 的步骤</h2><h3 id="100-flume-事务"><a class="anchor" href="#100-flume-事务">#</a> 1.0.0 Flume 事务</h3><p><img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20210820202104.png" alt="image-flume-事务"></p><h3 id="11-画拓扑图"><a class="anchor" href="#11-画拓扑图">#</a> 1.1 画拓扑图</h3><blockquote><p>总结：一个 channel 只能输出一个结果文件。</p><p>一个 flume agent 由 source + channel + sink 构成，类比于 mapper + shuffer + reducer。</p></blockquote><h4 id="111-确定source类型"><a class="anchor" href="#111-确定source类型">#</a> 1.1.1 确定 source 类型</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>常用类型：</pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token number">1</span><span class="token punctuation">)</span> arvo:  用于Flume agent 之间的数据源传递</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token number">2</span><span class="token punctuation">)</span> netcat: 用于监听端口</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token number">3</span>）<span class="token keyword">exec</span>: 用于执行linux中的操作指令</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token number">4</span><span class="token punctuation">)</span> spooldir: 用于监视文件或目录</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token number">5</span><span class="token punctuation">)</span> taildir: 用于监视文件或目录，同时支持追加的监听</pre></td></tr><tr><td data-num="7"></td><td><pre>	总结 ，<span class="token number">3</span><span class="token operator">/</span><span class="token number">4</span><span class="token operator">/</span><span class="token number">5</span>三种方式，最常用的是<span class="token number">5</span>，适合用于监听多个实时追加的文件，并且能够实现断点续传。</pre></td></tr></table></figure><h4 id="112-确定channel-selector-的选择器"><a class="anchor" href="#112-确定channel-selector-的选择器">#</a> 1.1.2 <strong>确定 channel selector 的选择器</strong></h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span>）replicating channel selector：复制，每个channel发一份数据 <span class="token comment">-- 默认的选择器</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token number">2</span><span class="token punctuation">)</span> multiplexing channel selector : 根据配置配件，指定source源获取的数据发往一个或多个channel</pre></td></tr></table></figure><h4 id="113-确认channel类型参数"><a class="anchor" href="#113-确认channel类型参数">#</a> <strong>1.1.3 确认 channel 类型参数</strong></h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span>） Memory Channel ： 加载在内存中，存在数据丢失的风险 <span class="token comment">-- 学习阶段使用此参数</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token number">2</span>） <span class="token keyword">File</span> Channel ：落入磁盘</pre></td></tr></table></figure><h4 id="114-确定sinkprocessor参数"><a class="anchor" href="#114-确定sinkprocessor参数">#</a> <strong>1.1.4 确定 sinkprocessor 参数</strong></h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span>） DefaultSinkProcessor：对应的是单个的Sink</pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token number">2</span>） LoadBalancingSinkProcessor ：对应的是多个的Sink，可以实现负载均衡的功能</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token number">3</span>） FailoverSinkProcessor ：对应的是多个的Sink，容错功能，先指定一个sink，所有的数据都走指定的sink，当sink故障以后，其他的sink顶上，如果开始sink恢复了，那么数据继续走原有指定的sink。</pre></td></tr></table></figure><h4 id="115-确定sink的类型"><a class="anchor" href="#115-确定sink的类型">#</a> <strong>1.1.5 确定 sink 的类型</strong></h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>常使用的类型有：</pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token number">1</span><span class="token punctuation">)</span> avro: 用于输出到下一个Flume Agent ，一个开源的序列化框架</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token number">2</span><span class="token punctuation">)</span> hdfs: 输出到hdfs</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token number">3</span><span class="token punctuation">)</span> fill_roll: 输出到本地</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token number">4</span><span class="token punctuation">)</span> logger: 输出到控制台</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token number">5</span><span class="token punctuation">)</span> hbase: 输出到hbase</pre></td></tr></table></figure><h4 id="116-拓扑例图"><a class="anchor" href="#116-拓扑例图">#</a> 1.1.6 拓扑例图</h4><p>​ <img data-src="https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20210820202537.png" alt="图3"></p><p>​	图 3</p><h3 id="12-写配置文件"><a class="anchor" href="#12-写配置文件">#</a> 1.2 写配置文件</h3><h4 id="121-配置文件的构成"><a class="anchor" href="#121-配置文件的构成">#</a> 1.2.1 配置文件的构成</h4><ol><li>Name the components on this agent -- agent Name</li><li>Describe/configure the source -- source</li><li>channel selector</li><li>Describe the channel -- channel</li><li>sinkprocessor</li><li>Describe the sink --sink</li><li>Bind the source and sink to the channel -- 连接 source、channel、sink</li></ol><h4 id="122-agent-name"><a class="anchor" href="#122-agent-name">#</a> 1.2.2 agent Name</h4><p>情况 1：source、channel、sink 各一个</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sources <span class="token operator">=</span> r1</pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sinks <span class="token operator">=</span> k1</pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>channels <span class="token operator">=</span> c1</pre></td></tr></table></figure><p>情况 2：source 一个、channel 一个、sink 多个</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sources <span class="token operator">=</span> r1</pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>channels <span class="token operator">=</span> c1</pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sinkgroups <span class="token operator">=</span> g1</pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>sinks <span class="token operator">=</span> k1 k2</pre></td></tr></table></figure><p>情况 3：source 一个、channel 多个、sink 多个</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sources <span class="token operator">=</span> r1</pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sinks <span class="token operator">=</span> k1 k2</pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>channels <span class="token operator">=</span> c1 c2</pre></td></tr></table></figure><h4 id="123-source"><a class="anchor" href="#123-source">#</a> 1.2.3 source</h4><p>情况 1：avro</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> avro</pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>bind <span class="token operator">=</span> hadoop102 <span class="token comment">-- hosename</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token number">4141</span> <span class="token comment">-- 端口号</span></pre></td></tr></table></figure><p>情况 2：netcat</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> netcat</pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>bind <span class="token operator">=</span> localhost <span class="token comment">-- 指接收来自 ip 为 localhost 发来的数据，如果是 0.0.0.0，则表示可以接收来自任意 ip 地址发来的数据</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token number">44444</span>  <span class="token comment">-- 本机的端口号，从该端口接收数据</span></pre></td></tr></table></figure><p>情况 3：exec</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> <span class="token keyword">exec</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>command <span class="token operator">=</span> tail <span class="token operator">-</span>F <span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>hive<span class="token operator">/</span>logs<span class="token operator">/</span>hive<span class="token punctuation">.</span>log <span class="token comment">-->linux 执行的命令</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>shell <span class="token operator">=</span> <span class="token operator">/</span>bin<span class="token operator">/</span>bash <span class="token operator">-</span>c <span class="token comment">-- linux 的解析器</span></pre></td></tr></table></figure><p>情况 4: sqooldir</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Describe/configure the source</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> spooldir <span class="token comment">-- 定义 source 类型</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>spoolDir <span class="token operator">=</span> <span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>flume<span class="token operator">/</span>upload <span class="token comment">-- 定义监控的文件或目录</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>fileSuffix <span class="token operator">=</span> <span class="token punctuation">.</span>COMPLETED <span class="token comment">-- 定义文件上传后的后缀</span></pre></td></tr><tr><td data-num="5"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>fileHeader <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">-- 是否有文件头</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">#忽略所有以.tmp 结尾的文件，不上传</span></pre></td></tr><tr><td data-num="7"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>ignorePattern <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">^</span> <span class="token punctuation">]</span><span class="token operator">*</span>\<span class="token punctuation">.</span>tmp<span class="token punctuation">)</span></pre></td></tr></table></figure><p>情况 5：talidir</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Describe/configure the source</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> TAILDIR </pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>positionFile <span class="token operator">=</span> <span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>flume<span class="token operator">/</span>tail_dir<span class="token punctuation">.</span>json <span class="token comment">-- 指定 position_file 的位置，(记录每次上传后的偏移量，实现断点续传的关键)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>batchSize<span class="token operator">=</span><span class="token number">500</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>filegroups <span class="token operator">=</span> f1 f2 <span class="token comment">-- 监控的文件目录集合</span></pre></td></tr><tr><td data-num="6"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>filegroups<span class="token punctuation">.</span>f1 <span class="token operator">=</span> <span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>flume<span class="token operator">/</span>files<span class="token operator">/</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token keyword">file</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token comment">-- 定义监控的文件目录 1</span></pre></td></tr><tr><td data-num="7"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>filegroups<span class="token punctuation">.</span>f2 <span class="token operator">=</span> <span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>flume<span class="token operator">/</span>files<span class="token operator">/</span><span class="token punctuation">.</span><span class="token operator">*</span>log<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token comment">-- 定义监控的文件目录 2</span></pre></td></tr></table></figure><h4 id="124-channel-selector"><a class="anchor" href="#124-channel-selector">#</a> 1.2.4 channel selector</h4><p>情况 1： replicating channel selector</p><pre><code># 将数据流复制给所有channel
a1.sources.r1.selector.type = replicating
</code></pre><p>情况 2：multiplexing channel selector 需配合指定的拦截器使用（interceptor）</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 指定拦截器</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>interceptors <span class="token operator">=</span> i1 <span class="token comment">-- 指定拦截器的名称</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>i1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> com<span class="token punctuation">.</span>miyazono<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span>CustomInterceptor$Builder</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">-- 指定拦截器的类型 = 自定义拦截器中 builder 的实现类的全类名</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">-- 指定 channel 的选择器</span></pre></td></tr><tr><td data-num="7"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> multiplexing  <span class="token comment">-- 定义 channel 的选择器类型</span></pre></td></tr><tr><td data-num="8"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>header <span class="token operator">=</span> <span class="token keyword">type</span>  <span class="token comment">-- 自定义拦截器的 header 的 k</span></pre></td></tr><tr><td data-num="9"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span>letter <span class="token operator">=</span> c1 <span class="token comment">-- letter 是 map 中一个 value 值，相同的 letter 进入一个 channel 中</span></pre></td></tr><tr><td data-num="10"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span>number <span class="token operator">=</span> c2 <span class="token comment">-- number 是 map 中一个 value 值，相同的 number 进入一个 channel 中</span></pre></td></tr></table></figure><h4 id="125-channel"><a class="anchor" href="#125-channel">#</a> 1.2.5 channel</h4><p>情况 1： memory</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Describe the channel</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> memory</pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span>capacity <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">-- 表示 channel 总容量为 1000 个 event</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span>transactionCapacity <span class="token operator">=</span> <span class="token number">100</span> <span class="token comment">-- 表示 channel 传输时收集到的 100 条 event</span></pre></td></tr></table></figure><p>情况 2 ： flie</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token operator">=</span><span class="token keyword">file</span>  <span class="token comment">--channel 类型</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span>checkpointDir<span class="token operator">=</span><span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>flume<span class="token operator">/</span><span class="token keyword">checkpoint</span><span class="token operator">/</span>behavior1 <span class="token comment">--checkpoint 文件存储的地址</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span>dataDirs<span class="token operator">=</span><span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>flume<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>behavior1<span class="token operator">/</span>  <span class="token comment">-- channel 中 event 文件在磁盘中存储的地址</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span>capacity<span class="token operator">=</span><span class="token number">1000000</span> <span class="token comment">--checkpoint 个数的最大容量</span></pre></td></tr><tr><td data-num="5"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span>maxFileSize<span class="token operator">=</span><span class="token number">2146435071</span> <span class="token comment">-- 一个 event 文件存储的最大的大小</span></pre></td></tr><tr><td data-num="6"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span>keep<span class="token operator">-</span>alive<span class="token operator">=</span><span class="token number">6</span> <span class="token comment">-- 当 put 事务将数据提交到 channel 队列中，channel 队列没有足够的空间时，提交事务等待的最大时间</span></pre></td></tr></table></figure><h4 id="126-sinkprocessor"><a class="anchor" href="#126-sinkprocessor">#</a> 1.2.6 sinkprocessor</h4><p>情况 1：DefaultSinkProcessor -- 对应单个 Sink</p><pre><code>不用写任何配置信息，默认值。
</code></pre><p>情况 2：FailoverSinkProcessor -- 对应的是 Sink Group</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sinkgroups<span class="token punctuation">.</span>g1<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> failover <span class="token comment">-- 指定类型</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sinkgroups<span class="token punctuation">.</span>g1<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>priority<span class="token punctuation">.</span>k1 <span class="token operator">=</span> <span class="token number">5</span> <span class="token comment">-- 设置 K1 的 sink 的优先级</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sinkgroups<span class="token punctuation">.</span>g1<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>priority<span class="token punctuation">.</span>k2 <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment">-- 设置 K2 的 sink 的优先级</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>sinkgroups<span class="token punctuation">.</span>g1<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>maxpenalty <span class="token operator">=</span> <span class="token number">10000</span> <span class="token comment">-- 设置故障的转换时间 10s。默认值为 30s</span></pre></td></tr></table></figure><p>情况 3：LoadBalancingSinkProcessor -- 对应的是 Sink Group</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sinkgroups<span class="token punctuation">.</span>g1<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span>load_balance <span class="token comment">-- 指定类型</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sinkgroups<span class="token punctuation">.</span>g1<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>backoff <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">-- 暂不讨论</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sinkgroups<span class="token punctuation">.</span>g1<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>selector <span class="token operator">=</span>round_robin <span class="token comment">-- 暂不讨论</span></pre></td></tr></table></figure><h4 id="127-sink"><a class="anchor" href="#127-sink">#</a> 1.2.7 sink</h4><p>情况 1：avro</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Describe the sink</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> avro</pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hostname <span class="token operator">=</span> hadoop104 <span class="token comment">-- hosaname</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token number">4141</span>  <span class="token comment">-- 端口</span></pre></td></tr></table></figure><p>情况 2：hdfs</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> hdfs</pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>path <span class="token operator">=</span> hdfs:<span class="token comment">//hadoop102:9820/flume/upload2/% Y% m% d/% H   -- 上传到 HDFS 的路径</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#上传文件的前缀</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>filePrefix <span class="token operator">=</span> upload<span class="token operator">-</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#是否按照时间滚动文件夹</span></pre></td></tr><tr><td data-num="6"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>round <span class="token operator">=</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#多少时间单位创建一个新的文件夹</span></pre></td></tr><tr><td data-num="8"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>roundValue <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#重新定义时间单位</span></pre></td></tr><tr><td data-num="10"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>roundUnit <span class="token operator">=</span> <span class="token keyword">hour</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#是否使用本地时间戳</span></pre></td></tr><tr><td data-num="12"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>useLocalTimeStamp <span class="token operator">=</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#积攒多少个 Event 才 flush 到 HDFS 一次</span></pre></td></tr><tr><td data-num="14"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>batchSize <span class="token operator">=</span> <span class="token number">100</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#设置文件类型，可支持压缩</span></pre></td></tr><tr><td data-num="16"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>fileType <span class="token operator">=</span> DataStream</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#多久生成一个新的文件</span></pre></td></tr><tr><td data-num="18"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>rollInterval <span class="token operator">=</span> <span class="token number">60</span>  <span class="token comment">-- 单位是秒</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#设置每个文件的滚动大小大概是 128M</span></pre></td></tr><tr><td data-num="20"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>rollSize <span class="token operator">=</span> <span class="token number">134217700</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#文件的滚动与 Event 数量无关</span></pre></td></tr><tr><td data-num="22"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>rollCount <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr></table></figure><p>情况 3：fill_roll</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Describe the sink</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> file_roll</pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>sink<span class="token punctuation">.</span>directory <span class="token operator">=</span> <span class="token operator">/</span>opt<span class="token operator">/</span>module<span class="token operator">/</span>flume<span class="token operator">/</span>datas<span class="token operator">/</span>flume3 <span class="token comment">-- 指定上传到本地的路径</span></pre></td></tr></table></figure><p>情况 4：logger</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Describe the sink</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> logger</pre></td></tr></table></figure><p>情况 5：hbase --- 暂时不讨论</p><h4 id="128-连接source-channel-sink"><a class="anchor" href="#128-连接source-channel-sink">#</a> 1.2.8 连接 source、channel、sink</h4><p>情况 1：source、channel、sink 各一个、</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>channels <span class="token operator">=</span> c1</pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>channel <span class="token operator">=</span> c1</pre></td></tr></table></figure><p>情况 2：source 一个、channel 一个、sink 多个</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Bind the source and sink to the channel</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>channels <span class="token operator">=</span> c1</pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sinkgroups<span class="token punctuation">.</span>g1<span class="token punctuation">.</span>sinks <span class="token operator">=</span> k1 k2</pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>channel <span class="token operator">=</span> c1</pre></td></tr><tr><td data-num="5"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k2<span class="token punctuation">.</span>channel <span class="token operator">=</span> c1</pre></td></tr></table></figure><p>情况 3：source 一个、channel 多个、sink 多个</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Bind the source and sink to the channel</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>channels <span class="token operator">=</span> c1 c2</pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>channel <span class="token operator">=</span> c1</pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k2<span class="token punctuation">.</span>channel <span class="token operator">=</span> c2 <span class="token comment">-- 特别注意 channel 没有 “s”</span></pre></td></tr></table></figure><h4 id="129-端口和ip的区别"><a class="anchor" href="#129-端口和ip的区别">#</a> 1.2.9 端口和 ip 的区别</h4><ul><li>sink 端：向指定 ip 地址的端口发送数据</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>端口：</pre></td></tr><tr><td data-num="2"></td><td><pre>ip（hostname）：</pre></td></tr></table></figure><ul><li>source 端：监视指定端口并接收指定 ip 发送来的数据</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>端口：该端口只能是自己机器的端口</pre></td></tr><tr><td data-num="2"></td><td><pre>ip（hostname）：指能够接受来自此ip的数据</pre></td></tr></table></figure><h3 id="13-连接flume"><a class="anchor" href="#13-连接flume">#</a> 1.3 连接 flume</h3><h4 id="131-查看指定ip的通信端口"><a class="anchor" href="#131-查看指定ip的通信端口">#</a> 1.3.1 查看指定 ip 的通信端口</h4><pre><code>sudo netstat -ntlp | grep 端口号
</code></pre><h4 id="132-关闭端口"><a class="anchor" href="#132-关闭端口">#</a> 1.3.2 关闭端口</h4><pre><code>sudo kill 端口的进程号
</code></pre><h4 id="133-连接指定ip地址的指定端口"><a class="anchor" href="#133-连接指定ip地址的指定端口">#</a> 1.3.3 连接指定 ip 地址的指定端口</h4><pre><code>nc ip 端口号
</code></pre><h4 id="134-启动flume"><a class="anchor" href="#134-启动flume">#</a> 1.3.4 启动 flume</h4><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>bin<span class="token operator">/</span>flume<span class="token operator">-</span>ng agent <span class="token operator">-</span>n <span class="token punctuation">[</span>agent name<span class="token punctuation">]</span> <span class="token operator">-</span>c conf <span class="token operator">-</span>f <span class="token punctuation">[</span>自定义flume配置文件<span class="token punctuation">]</span> <span class="token operator">-</span>Dflume<span class="token punctuation">.</span>root<span class="token punctuation">.</span>logger<span class="token operator">=</span>INFO<span class="token punctuation">,</span>console</pre></td></tr></table></figure><h2 id="二-自定义interceptorsource-sink"><a class="anchor" href="#二-自定义interceptorsource-sink">#</a> 二、自定义 interceptor，source、 sink</h2><h3 id="21-自定义intercepor"><a class="anchor" href="#21-自定义intercepor">#</a> 2.1 自定义 intercepor</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">flume_interceptor</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">Context</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">Event</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">Interceptor</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre> * @author lianzhipeng</pre></td></tr><tr><td data-num="12"></td><td><pre> * @Description</pre></td></tr><tr><td data-num="13"></td><td><pre> * @create 2020-05-05 10:45</pre></td></tr><tr><td data-num="14"></td><td><pre> */</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     * Description: 初始化方法，新建 Interceptor 时使用</pre></td></tr><tr><td data-num="20"></td><td><pre>     *</pre></td></tr><tr><td data-num="21"></td><td><pre>     * @Author: lianzhipeng</pre></td></tr><tr><td data-num="22"></td><td><pre>     * @Date: 2020/5/5 10:45</pre></td></tr><tr><td data-num="23"></td><td><pre>     * @return: void</pre></td></tr><tr><td data-num="24"></td><td><pre>     */</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="30"></td><td><pre>     * Description: 更改方法，对 event 进行处理</pre></td></tr><tr><td data-num="31"></td><td><pre>     *</pre></td></tr><tr><td data-num="32"></td><td><pre>     * @param event 传入的数据</pre></td></tr><tr><td data-num="33"></td><td><pre>     * @Author: lianzhipeng</pre></td></tr><tr><td data-num="34"></td><td><pre>     * @Date: 2020/5/5 10:47</pre></td></tr><tr><td data-num="35"></td><td><pre>     * @return: org.apache.flume.Event 返回处理好的数据</pre></td></tr><tr><td data-num="36"></td><td><pre>     */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">// 获取 event 的 header</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> headers <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token comment">// 获取 event 的 body</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">// 处理数据</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token class-name">String</span> string <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">char</span> c <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">>=</span> <span class="token string">'a'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token string">'z'</span> <span class="token operator">||</span> c <span class="token operator">>=</span> <span class="token string">'A'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token string">'Z'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"char"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"not-char"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// 返回数据</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">return</span> event<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">></span></span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">></span></span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Event</span> event <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token function">intercept</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">return</span> list<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="79"></td><td><pre>     * 框架会调用 MyBulider 来创建自定义拦截器实例</pre></td></tr><tr><td data-num="80"></td><td><pre>     */</pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyBulider</span> <span class="token keyword">implements</span> <span class="token class-name">Builder</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="84"></td><td><pre>         * Description: 创建自定义拦截器实例的方法</pre></td></tr><tr><td data-num="85"></td><td><pre>         *</pre></td></tr><tr><td data-num="86"></td><td><pre>         * @Author: lianzhipeng</pre></td></tr><tr><td data-num="87"></td><td><pre>         * @Date: 2020/5/5 10:54</pre></td></tr><tr><td data-num="88"></td><td><pre>         * @return: org.apache.flume.interceptor.Interceptor</pre></td></tr><tr><td data-num="89"></td><td><pre>         */</pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">Interceptor</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="95"></td><td><pre>         * Description: 读取配置信息</pre></td></tr><tr><td data-num="96"></td><td><pre>         *</pre></td></tr><tr><td data-num="97"></td><td><pre>         * @param context</pre></td></tr><tr><td data-num="98"></td><td><pre>         * @Author: lianzhipeng</pre></td></tr><tr><td data-num="99"></td><td><pre>         * @Date: 2020/5/5 10:54</pre></td></tr><tr><td data-num="100"></td><td><pre>         * @return: void</pre></td></tr><tr><td data-num="101"></td><td><pre>         */</pre></td></tr><tr><td data-num="102"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="22-自定义source"><a class="anchor" href="#22-自定义source">#</a> 2.2 自定义 source</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">flume_interceptor</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">Context</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">Event</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">EventDeliveryException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">PollableSource</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelProcessor</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configurable</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">SimpleEvent</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">AbstractSource</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="13"></td><td><pre> * @author lianzhipeng</pre></td></tr><tr><td data-num="14"></td><td><pre> * @Description</pre></td></tr><tr><td data-num="15"></td><td><pre> * @create 2020-05-05 14:31</pre></td></tr><tr><td data-num="16"></td><td><pre> */</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSource</span> <span class="token keyword">implements</span> <span class="token class-name">Configurable</span><span class="token punctuation">,</span> <span class="token class-name">PollableSource</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> prefix<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> interval<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>     * Description: 拉取事件并交给 ChannelProcessor 处理的方法</pre></td></tr><tr><td data-num="25"></td><td><pre>     *</pre></td></tr><tr><td data-num="26"></td><td><pre>     * @Author: lianzhipeng</pre></td></tr><tr><td data-num="27"></td><td><pre>     * @Date: 2020/5/5 14:33</pre></td></tr><tr><td data-num="28"></td><td><pre>     * @return: org.apache.flume.PollableSource.Status</pre></td></tr><tr><td data-num="29"></td><td><pre>     */</pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Status</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">EventDeliveryException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">Status</span> status <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token comment">// 通过外部方法拉取数据</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token class-name">Event</span> e <span class="token operator">=</span> <span class="token function">getSomeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token comment">// Store the Event into this Source's associated Channel(s)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token class-name">ChannelProcessor</span> channelProcessor <span class="token operator">=</span> <span class="token function">getChannelProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>            channelProcessor<span class="token punctuation">.</span><span class="token function">processEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>            status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>READY<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token comment">// Log exception, handle individual exceptions as needed</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>            status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>BACKOFF<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token comment">// re-throw all Errors</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">)</span>t<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">return</span> status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="59"></td><td><pre>     * Description: 拉取数据并包装成 event 的过程</pre></td></tr><tr><td data-num="60"></td><td><pre>     * @Author: lianzhipeng</pre></td></tr><tr><td data-num="61"></td><td><pre>     * @Date: 2020/5/5 14:55</pre></td></tr><tr><td data-num="62"></td><td><pre>     * @return: org.apache.flume.Event 拉取到的数据</pre></td></tr><tr><td data-num="63"></td><td><pre>    */</pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Event</span> <span class="token function">getSomeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token comment">// 添加前缀</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token class-name">String</span> message <span class="token operator">=</span> prefix <span class="token operator">+</span> i <span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token comment">//</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token class-name">SimpleEvent</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>        event<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token keyword">return</span>  event<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="80"></td><td><pre>     * Description: 如果拉取不到数据，backoff 时间的增长速度</pre></td></tr><tr><td data-num="81"></td><td><pre>     *</pre></td></tr><tr><td data-num="82"></td><td><pre>     * @Author: lianzhipeng</pre></td></tr><tr><td data-num="83"></td><td><pre>     * @Date: 2020/5/5 14:34</pre></td></tr><tr><td data-num="84"></td><td><pre>     * @return: long 增长量</pre></td></tr><tr><td data-num="85"></td><td><pre>     */</pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getBackOffSleepIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="91"></td><td><pre>     * Description: 最大的等待时间</pre></td></tr><tr><td data-num="92"></td><td><pre>     *</pre></td></tr><tr><td data-num="93"></td><td><pre>     * @Author: lianzhipeng</pre></td></tr><tr><td data-num="94"></td><td><pre>     * @Date: 2020/5/5 14:38</pre></td></tr><tr><td data-num="95"></td><td><pre>     * @return: long</pre></td></tr><tr><td data-num="96"></td><td><pre>     */</pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getMaxBackOffSleepInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">10000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="102"></td><td><pre>     * Description: 配置参数，来自于 configurable，可以定义我们自己定义的 source</pre></td></tr><tr><td data-num="103"></td><td><pre>     *</pre></td></tr><tr><td data-num="104"></td><td><pre>     * @param context 配置文件</pre></td></tr><tr><td data-num="105"></td><td><pre>     * @Author: lianzhipeng</pre></td></tr><tr><td data-num="106"></td><td><pre>     * @Date: 2020/5/5 14:39</pre></td></tr><tr><td data-num="107"></td><td><pre>     * @return: void</pre></td></tr><tr><td data-num="108"></td><td><pre>     */</pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre>        prefix <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"prefff"</span><span class="token punctuation">,</span><span class="token string">"xxxx"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>        interval <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">"interval"</span><span class="token punctuation">,</span><span class="token number">500L</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="23-自定义sink"><a class="anchor" href="#23-自定义sink">#</a> 2.3 自定义 sink</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">flume_interceptor</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configurable</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>sink<span class="token punctuation">.</span></span><span class="token class-name">AbstractSink</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * @author lianzhipeng</pre></td></tr><tr><td data-num="11"></td><td><pre> * @Description</pre></td></tr><tr><td data-num="12"></td><td><pre> * @create 2020-05-05 14:31</pre></td></tr><tr><td data-num="13"></td><td><pre> */</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySiink</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSink</span> <span class="token keyword">implements</span> <span class="token class-name">Configurable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * Description: 改方法调用时，会从 Channel 中拉取数据并处理</pre></td></tr><tr><td data-num="18"></td><td><pre>     *</pre></td></tr><tr><td data-num="19"></td><td><pre>     * @Author: lianzhipeng</pre></td></tr><tr><td data-num="20"></td><td><pre>     * @Date: 2020/5/5 15:09</pre></td></tr><tr><td data-num="21"></td><td><pre>     * @return: org.apache.flume.Sink.Status 处理的状态</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Status</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">EventDeliveryException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">Status</span> status <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// Start transaction</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 获取 channel</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">Channel</span> ch <span class="token operator">=</span> <span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 拉取数据的事务</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token class-name">Transaction</span> txn <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// 开始拉取</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        txn<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token comment">// This try clause includes whatever Channel operations you want to do</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token comment">// 拉取的数据，如果拉取不到，则返回 null</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token class-name">Event</span> event<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token comment">// 如果拉取的数据为 null，则等 0.1 秒后继续拉取数据，知道拉取数据</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>event <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token comment">// Send the Event to the external repository.</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token comment">// 如果拉取到了数据，将数据进行处理</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token function">storeSomeData</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>            txn<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>READY<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            txn<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token comment">// Log exception, handle individual exceptions as needed</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>            status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>BACKOFF<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token comment">// re-throw all Errors</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">)</span> t<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token comment">// 拉取事务的关闭</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            txn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">return</span> status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">storeSomeData</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token comment">// 获取 event 的 body 数据</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token comment">// 将数据写出到控制台</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="三-kafka与flume的结合"><a class="anchor" href="#三-kafka与flume的结合">#</a> 三、kafka 与 flume 的结合</h2><p>kafka：数据的中转站，主要功能由 topic 体现；</p><p>flume：数据的采集，通过 source 和 sink 体现。</p><h3 id="31-kafka-source"><a class="anchor" href="#31-kafka-source">#</a> 3.1 kafka source</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 问题 ：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>fulme在kafka中的作用</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 答案：</span></pre></td></tr><tr><td data-num="4"></td><td><pre>消费者</pre></td></tr></table></figure><p>配置文件：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>source<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>KafkaSource <span class="token comment">--source 类型</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span>servers <span class="token operator">=</span> hadoop105:<span class="token number">9092</span><span class="token punctuation">,</span>hadoop106:<span class="token number">9092</span> <span class="token comment">-- kafka 的集群</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>topics<span class="token operator">=</span>topic_log <span class="token comment">-- 订阅的话题</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>batchSize<span class="token operator">=</span><span class="token number">6000</span> <span class="token comment">--putlist 中数据达到了 6K 以后提交到 channel 中</span></pre></td></tr><tr><td data-num="5"></td><td><pre>a1<span class="token punctuation">.</span>sources<span class="token punctuation">.</span>r1<span class="token punctuation">.</span>batchDurationMillis<span class="token operator">=</span><span class="token number">2000</span> <span class="token comment">-- 拉取数据的时间达到 2s 以后，将获取的数据提交到 channel 中</span></pre></td></tr></table></figure><h3 id="32-kakfa-channel"><a class="anchor" href="#32-kakfa-channel">#</a> 3.2 kakfa channel</h3><ul><li>kakfa channel 这种情况使用的最多，此时的 flume 可以是消费者、生产者、source 和 sink 之间的缓冲区（具有高吞吐量的优势），Channel 是位于 Source 和 Sink 之间的缓冲区。</li><li>一共有三种情况，分别是:</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 情况一： 有 Flume source and sink -- 缓冲区</span></pre></td></tr><tr><td data-num="2"></td><td><pre>kakfa channel为事件提供了可靠且高可用的通道；</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">-- 情况二： 有 source and interceptor but no sink -- 生产者</span></pre></td></tr><tr><td data-num="5"></td><td><pre>it allows writing Flume events <span class="token keyword">into</span> a Kafka topic<span class="token punctuation">,</span> <span class="token keyword">for</span> <span class="token keyword">use</span> <span class="token keyword">by</span> other app</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">-- 情况三： 有 sink, but no source -- 消费者</span></pre></td></tr><tr><td data-num="8"></td><td><pre>it <span class="token operator">is</span> a low<span class="token operator">-</span>latency<span class="token punctuation">,</span> fault tolerant way <span class="token keyword">to</span> send events <span class="token keyword">from</span> Kafka <span class="token keyword">to</span> Flume sinks such <span class="token keyword">as</span> HDFS<span class="token punctuation">,</span> HBase <span class="token operator">or</span> Solr</pre></td></tr></table></figure><p>配置文件：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>KafkaChannel <span class="token comment">----channel 类型</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span>servers <span class="token operator">=</span> hadoop105:<span class="token number">9092</span><span class="token punctuation">,</span>hadoop106:<span class="token number">9092</span><span class="token punctuation">,</span>hadoop107:<span class="token number">9092</span> <span class="token comment">--kafka 集群</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>topic <span class="token operator">=</span>topic_log <span class="token comment">-- 话题</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>c1<span class="token punctuation">.</span>parseAsFlumeEvent<span class="token operator">=</span><span class="token boolean">false</span> <span class="token comment">-- 不需要 event 的 header 数据</span></pre></td></tr></table></figure><h3 id="33-kafka-sink"><a class="anchor" href="#33-kafka-sink">#</a> 3.3 kafka sink</h3><p>作用：将数据拉取到 kafka 的 topic 中。</p><p>配置文件：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>sink<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>KafkaSink <span class="token comment">--sink 类型</span></pre></td></tr><tr><td data-num="2"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>topic <span class="token operator">=</span>topic_log <span class="token comment">-- 话题</span></pre></td></tr><tr><td data-num="3"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span>servers <span class="token operator">=</span> hadoop105:<span class="token number">9092</span><span class="token punctuation">,</span>hadoop106:<span class="token number">9092</span><span class="token punctuation">,</span>hadoop107:<span class="token number">9092</span> <span class="token comment">--kafka 集群</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>flumeBatchSize <span class="token operator">=</span> <span class="token number">20</span></pre></td></tr><tr><td data-num="5"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>acks <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">-- 副本策略</span></pre></td></tr><tr><td data-num="6"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>linger<span class="token punctuation">.</span>ms <span class="token operator">=</span> <span class="token number">1</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>compression<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> snappy  <span class="token comment">-- 压缩格式</span></pre></td></tr></table></figure></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-09-29 23:08:17" itemprop="dateModified" datetime="2021-09-29T23:08:17+08:00">2021-09-29</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Miyazono <i class="ic i-at"><em>@</em></i>冬樱茶</li><li class="link"><strong>本文链接：</strong> <a href="https://github.com/Mayizono/miyazono.github.io/bigdata/flume/Flume/" title="Flume 基础学习">https://github.com/Mayizono/miyazono.github.io/bigdata/flume/Flume/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"></div><div class="item right"><a href="/bigdata/flume/Flume%E7%BB%83%E4%B9%A0/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;i3.wp.com&#x2F;wx4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipet4bz0yj20zk0m8e81.jpg" title="Flume练习题"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Flume</span><h3>Flume练习题</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%86%99flume%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.</span> <span class="toc-text">一、写 flume 的步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#100-flume-%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.1.</span> <span class="toc-text">1.0.0 Flume 事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E7%94%BB%E6%8B%93%E6%89%91%E5%9B%BE"><span class="toc-number">1.2.</span> <span class="toc-text">1.1 画拓扑图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#111-%E7%A1%AE%E5%AE%9Asource%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1.1 确定 source 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#112-%E7%A1%AE%E5%AE%9Achannel-selector-%E7%9A%84%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.1.2 确定 channel selector 的选择器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#113-%E7%A1%AE%E8%AE%A4channel%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.1.3 确认 channel 类型参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#114-%E7%A1%AE%E5%AE%9Asinkprocessor%E5%8F%82%E6%95%B0"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.1.4 确定 sinkprocessor 参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#115-%E7%A1%AE%E5%AE%9Asink%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.5.</span> <span class="toc-text">1.1.5 确定 sink 的类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#116-%E6%8B%93%E6%89%91%E4%BE%8B%E5%9B%BE"><span class="toc-number">1.2.6.</span> <span class="toc-text">1.1.6 拓扑例图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">1.2 写配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#121-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E6%9E%84%E6%88%90"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.2.1 配置文件的构成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#122-agent-name"><span class="toc-number">1.3.2.</span> <span class="toc-text">1.2.2 agent Name</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#123-source"><span class="toc-number">1.3.3.</span> <span class="toc-text">1.2.3 source</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#124-channel-selector"><span class="toc-number">1.3.4.</span> <span class="toc-text">1.2.4 channel selector</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#125-channel"><span class="toc-number">1.3.5.</span> <span class="toc-text">1.2.5 channel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#126-sinkprocessor"><span class="toc-number">1.3.6.</span> <span class="toc-text">1.2.6 sinkprocessor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#127-sink"><span class="toc-number">1.3.7.</span> <span class="toc-text">1.2.7 sink</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#128-%E8%BF%9E%E6%8E%A5source-channel-sink"><span class="toc-number">1.3.8.</span> <span class="toc-text">1.2.8 连接 source、channel、sink</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#129-%E7%AB%AF%E5%8F%A3%E5%92%8Cip%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.3.9.</span> <span class="toc-text">1.2.9 端口和 ip 的区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-%E8%BF%9E%E6%8E%A5flume"><span class="toc-number">1.4.</span> <span class="toc-text">1.3 连接 flume</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#131-%E6%9F%A5%E7%9C%8B%E6%8C%87%E5%AE%9Aip%E7%9A%84%E9%80%9A%E4%BF%A1%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.4.1.</span> <span class="toc-text">1.3.1 查看指定 ip 的通信端口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#132-%E5%85%B3%E9%97%AD%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.4.2.</span> <span class="toc-text">1.3.2 关闭端口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#133-%E8%BF%9E%E6%8E%A5%E6%8C%87%E5%AE%9Aip%E5%9C%B0%E5%9D%80%E7%9A%84%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.4.3.</span> <span class="toc-text">1.3.3 连接指定 ip 地址的指定端口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#134-%E5%90%AF%E5%8A%A8flume"><span class="toc-number">1.4.4.</span> <span class="toc-text">1.3.4 启动 flume</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E8%87%AA%E5%AE%9A%E4%B9%89interceptorsource-sink"><span class="toc-number">2.</span> <span class="toc-text">二、自定义 interceptor，source、 sink</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E8%87%AA%E5%AE%9A%E4%B9%89intercepor"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 自定义 intercepor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E8%87%AA%E5%AE%9A%E4%B9%89source"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 自定义 source</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-%E8%87%AA%E5%AE%9A%E4%B9%89sink"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 自定义 sink</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-kafka%E4%B8%8Eflume%E7%9A%84%E7%BB%93%E5%90%88"><span class="toc-number">3.</span> <span class="toc-text">三、kafka 与 flume 的结合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-kafka-source"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 kafka source</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-kakfa-channel"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 kakfa channel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-kafka-sink"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 kafka sink</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/bigdata/flume/Flume/" rel="bookmark" title="Flume基础学习">Flume基础学习</a></li><li><a href="/bigdata/flume/Flume%E7%BB%83%E4%B9%A0/" rel="bookmark" title="Flume练习题">Flume练习题</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Miyazono" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Miyazono</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">25</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">13</span> <span class="name">分类</span></a></div></nav><div class="social"><a href="https://github.com/Mayizono" title="https:&#x2F;&#x2F;github.com&#x2F;Mayizono" class="item github"><i class="ic i-github"></i></a> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEzNDMzNjQzOQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;134336439"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vdS8yOTAwNzY4Nzky" title="https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;2900768792"><i class="ic i-weibo"></i></span> <span class="exturl item email" data-url="aHR0cHM6Ly94eW5zdHVkeUAxNjMuY29t" title="https:&#x2F;&#x2F;xynstudy@163.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/mikutap/" rel="section"><i class="ic i-star"></i>mikutap</a></li><li class="item"><a href="/time" rel="section"><i class="ic i-heart"></i>time</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/flink/" title="分类于 Flink">Flink</a></div><span><a href="/bigdata/flink/Flink%E7%9A%84Window%E6%9C%BA%E5%88%B6/" title="Flink的窗口机制">Flink的窗口机制</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/kafka/" title="分类于 Kafka">Kafka</a></div><span><a href="/bigdata/kafka/Kafka%E3%80%81Redis%E3%80%81Pulsar%E5%AF%B9%E6%AF%94/" title="Kafka、Redis、Pulsar对比">Kafka、Redis、Pulsar对比</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/pgsql/" title="分类于 PostgreSQL">PostgreSQL</a></div><span><a href="/bigdata/pgsql/Postgresql%E5%AD%A6%E4%B9%A0/" title="PgSql学习">PgSql学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/pro/" title="分类于 大厂学习">大厂学习</a></div><span><a href="/bigdata/pro/%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4OneData/" title="阿里巴巴OneData">阿里巴巴OneData</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/pro/" title="分类于 大厂学习">大厂学习</a></div><span><a href="/bigdata/pro/%E6%BB%B4%E6%BB%B4%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97%E5%8F%91%E5%B1%95%E4%B9%8B%E8%B7%AF%E5%8F%8A%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5/" title="滴滴实时计算发展之路及平台架构实践">滴滴实时计算发展之路及平台架构实践</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/hadoop/" title="分类于 Hadoop">Hadoop</a></div><span><a href="/bigdata/hadoop/hadoop/" title="Hadoop学习">Hadoop学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/flink/" title="分类于 Flink">Flink</a></div><span><a href="/bigdata/flink/Flink%E7%9A%84%E5%BC%82%E6%AD%A5IO/" title="Flink的异步IO">Flink的异步IO</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/hive/" title="分类于 Hive">Hive</a></div><span><a href="/kawaii/moments/%E5%8F%AF%E7%88%B1%E5%A5%B3%E9%AD%94%E5%A4%B4/" title="力扣数据库">力扣数据库</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/flink/" title="分类于 Flink">Flink</a></div><span><a href="/bigdata/flink/1_Nginx/" title="负载均衡Nginx的使用">负载均衡Nginx的使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/bigdata/" title="分类于 大数据">大数据</a> <i class="ic i-angle-right"></i> <a href="/categories/bigdata/flink/" title="分类于 Flink">Flink</a></div><span><a href="/bigdata/flink/Flink%E7%9A%84%E6%9E%B6%E6%9E%84/" title="Flink的架构">Flink的架构</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Miyazono @ Yume Shoka</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">463k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">7:01</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<a href="https://github.com/amehime/hexo-theme-shoka">Shoka</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"bigdata/flume/Flume/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->