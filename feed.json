{
    "version": "https://jsonfeed.org/version/1",
    "title": "冬樱茶",
    "subtitle": "",
    "icon": "https://github.com/Mayizono/miyazono.github.io/images/favicon.ico",
    "description": "",
    "home_page_url": "https://github.com/Mayizono/miyazono.github.io",
    "items": [
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/kawaii/%E5%8F%AF%E7%88%B1%E5%A5%B3%E9%AD%94%E5%A4%B4/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/kawaii/%E5%8F%AF%E7%88%B1%E5%A5%B3%E9%AD%94%E5%A4%B4/",
            "title": "可爱女魔头",
            "date_published": "2025-05-20T16:00:00.000Z",
            "content_html": "<h2 id=\"经典语录\"><a class=\"anchor\" href=\"#经典语录\">#</a> 经典语录</h2>\n<ol>\n<li>我有点害羞了</li>\n</ol>\n",
            "tags": [
                "可爱女魔头",
                "kawaii"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E5%AE%9E%E6%88%98%E8%AE%A1%E7%AE%97%E7%83%AD%E9%97%A8%E5%95%86%E5%93%81/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E5%AE%9E%E6%88%98%E8%AE%A1%E7%AE%97%E7%83%AD%E9%97%A8%E5%95%86%E5%93%81/",
            "title": "Flink实战计算热门商品",
            "date_published": "2024-01-15T16:00:00.000Z",
            "content_html": "<h2 id=\"实战案例介绍\"><a class=\"anchor\" href=\"#实战案例介绍\">#</a> 实战案例介绍</h2>\n<p>本案例将实现一个 “实时热门商品” 的需求，我们可以将 “实时热门商品” 翻译成程序员更好理解的需求：每隔 5 分钟输出最近一小时内点击量最多的前 N 个商品。将这个需求进行分解我们大概要做这么几件事情：</p>\n<ul>\n<li>抽取出业务时间戳，告诉 Flink 框架基于业务时间做窗口</li>\n<li>过滤出点击行为数据</li>\n<li>按一小时的窗口大小，每 5 分钟统计一次，做滑动窗口聚合（Sliding Window）</li>\n<li>按每个窗口聚合，输出每个窗口中点击量前 N 名的商品</li>\n</ul>\n<h2 id=\"数据准备\"><a class=\"anchor\" href=\"#数据准备\">#</a> 数据准备</h2>\n<p>这里准备了一份淘宝用户行为数据集。本数据集包含了淘宝上某一天随机一百万用户的所有行为（包括点击、购买、加购、收藏）。数据集的每一行表示一条用户行为，由用户 ID、商品 ID、商品类目 ID、行为类型和时间戳组成，并以逗号分隔。关于数据集中每一列的详细描述如下：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">列名称</th>\n<th style=\"text-align:left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">用户 ID</td>\n<td style=\"text-align:left\">整数类型，加密后的用户 ID</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">商品 ID</td>\n<td style=\"text-align:left\">整数类型，加密后的商品 ID</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">商品类目 ID</td>\n<td style=\"text-align:left\">整数类型，加密后的商品所属类目 ID</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">行为类型</td>\n<td style=\"text-align:left\">字符串，枚举类型，包括 (‘pv’, ‘buy’, ‘cart’, ‘fav’)</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">时间戳</td>\n<td style=\"text-align:left\">行为发生的时间戳，单位秒</td>\n</tr>\n</tbody>\n</table>\n<p>你可以通过下面的命令下载数据集到项目的  <code>resources</code>  目录下：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token builtin class-name\">cd</span> my-flink-project/src/main/resources</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ <span class=\"token function\">curl</span> https://raw.githubusercontent.com/wuchong/my-flink-project/master/src/main/resources/UserBehavior.csv <span class=\"token operator\">></span> UserBehavior.csv</pre></td></tr></table></figure><p>这里是否使用 curl 命令下载数据并不重要，你也可以使用 wget 命令或者直接访问链接下载数据。关键是，<strong>将数据文件保存到项目的  <code>resources</code>  目录下</strong>，方便应用程序访问。</p>\n<h2 id=\"编写程序\"><a class=\"anchor\" href=\"#编写程序\">#</a> 编写程序</h2>\n<p>在  <code>src/main/java/myflink</code>  下创建  <code>HotItems.java</code>  文件：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">myflink</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HotItems</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>与上文一样，我们会一步步往里面填充代码。第一步仍然是创建一个  <code>StreamExecutionEnvironment</code> ，我们把它添加到 main 函数中。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">StreamExecutionEnvironment</span> env <span class=\"token operator\">=</span> <span class=\"token class-name\">StreamExecutionEnvironment</span><span class=\"token punctuation\">.</span><span class=\"token function\">getExecutionEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// 为了打印到控制台的结果不乱序，我们配置全局的并发为 1，这里改变并发对结果正确性没有影响</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>env<span class=\"token punctuation\">.</span><span class=\"token function\">setParallelism</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"创建模拟数据源\"><a class=\"anchor\" href=\"#创建模拟数据源\">#</a> 创建模拟数据源</h3>\n<p>在数据准备章节，我们已经将测试的数据集下载到本地了。由于是一个 csv 文件，我们将使用  <code>CsvInputFormat</code>  创建模拟数据源。</p>\n<blockquote>\n<p>注：虽然一个流式应用应该是一个一直运行着的程序，需要消费一个无限数据源。但是在本案例教程中，为了省去构建真实数据源的繁琐，我们使用了文件来模拟真实数据源，这并不影响下文要介绍的知识点。这也是一种本地验证 Flink 应用程序正确性的常用方式。</p>\n</blockquote>\n<p>我们先创建一个  <code>UserBehavior</code>  的 POJO 类（所有成员变量声明成 <code>public</code>  便是 POJO 类），强类型化后能方便后续的处理。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/** 用户行为数据结构 **/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserBehavior</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> userId<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// 用户 ID</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> itemId<span class=\"token punctuation\">;</span>         <span class=\"token comment\">// 商品 ID</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> categoryId<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 商品类目 ID</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> behavior<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 用户行为，包括 (\"pv\", \"buy\", \"cart\", \"fav\")</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> timestamp<span class=\"token punctuation\">;</span>      <span class=\"token comment\">// 行为发生的时间戳，单位秒</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>接下来我们就可以创建一个  <code>PojoCsvInputFormat</code>  了， 这是一个读取 csv 文件并将每一行转成指定 POJO<br />\n 类型（在我们案例中是  <code>UserBehavior</code> ）的输入器。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// UserBehavior.csv 的本地文件路径</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">URL</span> fileUrl <span class=\"token operator\">=</span> <span class=\"token class-name\">HotItems2</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UserBehavior.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token class-name\">Path</span> filePath <span class=\"token operator\">=</span> <span class=\"token class-name\">Path</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromLocalFile</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span>fileUrl<span class=\"token punctuation\">.</span><span class=\"token function\">toURI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// 抽取 UserBehavior 的 TypeInformation，是一个 PojoTypeInfo</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">PojoTypeInfo</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserBehavior</span><span class=\"token punctuation\">></span></span> pojoType <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">PojoTypeInfo</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserBehavior</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">TypeExtractor</span><span class=\"token punctuation\">.</span><span class=\"token function\">createTypeInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserBehavior</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// 由于 Java 反射抽取出的字段顺序是不确定的，需要显式指定下文件中字段的顺序</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> fieldOrder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"userId\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"itemId\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"categoryId\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"behavior\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"timestamp\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// 创建 PojoCsvInputFormat</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\">PojoCsvInputFormat</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserBehavior</span><span class=\"token punctuation\">></span></span> csvInput <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PojoCsvInputFormat</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> pojoType<span class=\"token punctuation\">,</span> fieldOrder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>下一步我们用  <code>PojoCsvInputFormat</code>  创建输入源。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserBehavior</span><span class=\"token punctuation\">></span></span> dataSource <span class=\"token operator\">=</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">createInput</span><span class=\"token punctuation\">(</span>csvInput<span class=\"token punctuation\">,</span> pojoType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这就创建了一个  <code>UserBehavior</code>  类型的  <code>DataStream</code> 。</p>\n<h3 id=\"eventtime-与-watermark\"><a class=\"anchor\" href=\"#eventtime-与-watermark\">#</a> EventTime 与 Watermark</h3>\n<p>当我们说 “统计过去一小时内点击量”，这里的 “一小时” 是指什么呢？ 在 Flink 中它可以是指 ProcessingTime ，也可以是 EventTime，由用户决定。</p>\n<ul>\n<li>ProcessingTime：事件被处理的时间。也就是由机器的系统时间来决定。</li>\n<li>EventTime：事件发生的时间。一般就是数据本身携带的时间。</li>\n</ul>\n<p>在本案例中，我们需要统计业务时间上的每小时的点击量，所以要基于 EventTime 来处理。那么如果让 Flink 按照我们想要的业务时间来处理呢？这里主要有两件事情要做。</p>\n<p>第一件是告诉 Flink 我们现在按照 EventTime 模式进行处理，Flink 默认使用 ProcessingTime 处理，所以我们要显式设置下。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>env<span class=\"token punctuation\">.</span><span class=\"token function\">setStreamTimeCharacteristic</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TimeCharacteristic<span class=\"token punctuation\">.</span>EventTime</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>第二件事情是指定如何获得业务时间，以及生成 Watermark。Watermark 是用来追踪业务事件的概念，可以理解成 EventTime 世界中的时钟，用来指示当前处理到什么时刻的数据了。由于我们的数据源的数据已经经过整理，没有乱序，即事件的时间戳是单调递增的，所以可以将每条数据的业务时间就当做 Watermark。这里我们用  <code>AscendingTimestampExtractor</code>  来实现时间戳的抽取和 Watermark 的生成。</p>\n<blockquote>\n<p>注：真实业务场景一般都是存在乱序的，所以一般使用  <code>BoundedOutOfOrdernessTimestampExtractor</code> 。</p>\n</blockquote>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserBehavior</span><span class=\"token punctuation\">></span></span> timedData <span class=\"token operator\">=</span> dataSource</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">assignTimestampsAndWatermarks</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AscendingTimestampExtractor</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserBehavior</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> <span class=\"token function\">extractAscendingTimestamp</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserBehavior</span> userBehavior<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// 原始数据单位秒，将其转成毫秒</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> userBehavior<span class=\"token punctuation\">.</span>timestamp <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这样我们就得到了一个带有时间标记的数据流了，后面就能做一些窗口的操作。</p>\n<h3 id=\"过滤出点击事件\"><a class=\"anchor\" href=\"#过滤出点击事件\">#</a> 过滤出点击事件</h3>\n<p>在开始窗口操作之前，先回顾下需求 “每隔 5 分钟输出过去一小时内<strong>点击量</strong>最多的前 N 个商品”。由于原始数据中存在点击、加购、购买、收藏各种行为的数据，但是我们只需要统计点击量，所以先使用  <code>FilterFunction</code>  将点击行为数据过滤出来。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserBehavior</span><span class=\"token punctuation\">></span></span> pvData <span class=\"token operator\">=</span> timedData</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">FilterFunction</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserBehavior</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserBehavior</span> userBehavior<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// 过滤出只有点击的数据</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> userBehavior<span class=\"token punctuation\">.</span>behavior<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"窗口统计点击量\"><a class=\"anchor\" href=\"#窗口统计点击量\">#</a> 窗口统计点击量</h3>\n<p>由于要每隔 5 分钟统计一次最近一小时每个商品的点击量，所以窗口大小是一小时，每隔 5 分钟滑动一次。即分别要统计 [09:00, 10:00), [09:05, 10:05), [09:10, 10:10)… 等窗口的商品点击量。是一个常见的滑动窗口需求（Sliding Window）。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">></span></span> windowedData <span class=\"token operator\">=</span> pvData</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">keyBy</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"itemId\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">timeWindow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Time</span><span class=\"token punctuation\">.</span><span class=\"token function\">minutes</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Time</span><span class=\"token punctuation\">.</span><span class=\"token function\">minutes</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">aggregate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CountAgg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WindowResultFunction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>我们使用 <code>.keyBy(&quot;itemId&quot;)</code>  对商品进行分组，使用 <code>.timeWindow(Time size, Time slide)</code>  对每个商品做滑动窗口（1 小时窗口，5 分钟滑动一次）。然后我们使用  <code>.aggregate(AggregateFunction af, WindowFunction wf)</code>  做增量的聚合操作，它能使用 <code>AggregateFunction</code>  提前聚合掉数据，减少 state 的存储压力。较之 <code>.apply(WindowFunction wf)</code>  会将窗口中的数据都存储下来，最后一起计算要高效地多。 <code>aggregate()</code>  方法的第一个参数用于</p>\n<p>这里的 <code>CountAgg</code>  实现了 <code>AggregateFunction</code>  接口，功能是统计窗口中的条数，即遇到一条数据就加一。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/** COUNT 统计的聚合函数实现，每出现一条记录加一 */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CountAgg</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">AggregateFunction</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserBehavior</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Long</span> <span class=\"token function\">createAccumulator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0L</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Long</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserBehavior</span> userBehavior<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> acc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> acc <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Long</span> <span class=\"token function\">getResult</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> acc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span> acc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Long</span> <span class=\"token function\">merge</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> acc1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> acc2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span> acc1 <span class=\"token operator\">+</span> acc2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>.aggregate(AggregateFunction af, WindowFunction wf)</code>  的第二个参数 <code>WindowFunction</code>  将每个 key 每个窗口聚合后的结果带上其他信息进行输出。我们这里实现的 <code>WindowResultFunction</code>  将主键商品 ID，窗口，点击量封装成了 <code>ItemViewCount</code>  进行输出。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/** 用于输出窗口的结果 */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WindowResultFunction</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">WindowFunction</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Tuple</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeWindow</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token class-name\">Tuple</span> key<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 窗口的主键，即 itemId</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token class-name\">TimeWindow</span> window<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 窗口</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token class-name\">Iterable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> aggregateResult<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 聚合函数的结果，即 count 值</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token class-name\">Collector</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">></span></span> collector  <span class=\"token comment\">// 输出类型为 ItemViewCount</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token class-name\">Long</span> itemId <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Tuple1</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>f0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token class-name\">Long</span> count <span class=\"token operator\">=</span> aggregateResult<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    collector<span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>itemId<span class=\"token punctuation\">,</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">getEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">/** 商品点击量 (窗口操作的输出类型) */</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemViewCount</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> itemId<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// 商品 ID</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> windowEnd<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 窗口结束时间戳</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> viewCount<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 商品的点击量</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">ItemViewCount</span> <span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> itemId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> windowEnd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> viewCount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token class-name\">ItemViewCount</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    result<span class=\"token punctuation\">.</span>itemId <span class=\"token operator\">=</span> itemId<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    result<span class=\"token punctuation\">.</span>windowEnd <span class=\"token operator\">=</span> windowEnd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    result<span class=\"token punctuation\">.</span>viewCount <span class=\"token operator\">=</span> viewCount<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>现在我们得到了每个商品在每个窗口的点击量的数据流。</p>\n<h3 id=\"topn-计算最热门商品\"><a class=\"anchor\" href=\"#topn-计算最热门商品\">#</a> TopN 计算最热门商品</h3>\n<p>为了统计每个窗口下最热门的商品，我们需要再次按窗口进行分组，这里根据 <code>ItemViewCount</code>  中的 <code>windowEnd</code>  进行 <code>keyBy()</code>  操作。然后使用  <code>ProcessFunction</code>  实现一个自定义的 TopN 函数  <code>TopNHotItems</code>  来计算点击量排名前 3 名的商品，并将排名结果格式化成字符串，便于后续输出。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> topItems <span class=\"token operator\">=</span> windowedData</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">keyBy</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"windowEnd\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TopNHotItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 求点击量前 3 名的商品</span></pre></td></tr></table></figure><p><code>ProcessFunction</code>  是 Flink 提供的一个 low-level API，用于实现更高级的功能。它主要提供了定时器 timer 的功能（支持 EventTime 或 ProcessingTime）。本案例中我们将利用 timer 来判断何时<strong>收齐</strong>了某个 window 下所有商品的点击量数据。由于 Watermark 的进度是全局的，</p>\n<p>在  <code>processElement</code>  方法中，每当收到一条数据（ <code>ItemViewCount</code> ），我们就注册一个  <code>windowEnd+1</code>  的定时器（Flink 框架会自动忽略同一时间的重复注册）。 <code>windowEnd+1</code>  的定时器被触发时，意味着收到了 <code>windowEnd+1</code>  的 Watermark，即收齐了该 <code>windowEnd</code>  下的所有商品窗口统计值。我们在  <code>onTimer()</code>  中处理将收集的所有商品及点击量进行排序，选出 TopN，并将排名信息格式化成字符串后进行输出。</p>\n<p>这里我们还使用了  <code>ListState&lt;ItemViewCount&gt;</code>  来存储收到的每条  <code>ItemViewCount</code>  消息，保证在发生故障时，状态数据的不丢失和一致性。 <code>ListState</code>  是 Flink 提供的类似 Java  <code>List</code>  接口的 State API，它集成了框架的 checkpoint 机制，自动做到了 exactly-once 的语义保证。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/** 求某个窗口中前 N 名的热门点击商品，key 为窗口时间戳，输出为 TopN 的结果字符串 */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TopNHotItems</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">KeyedProcessFunction</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tuple</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> topSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token class-name\">TopNHotItems</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> topSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>topSize <span class=\"token operator\">=</span> topSize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// 用于存储商品与点击数的状态，待收齐同一个窗口的数据后，再触发 TopN 计算</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token class-name\">ListState</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">></span></span> itemState<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Configuration</span> parameters<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span>parameters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// 状态的注册</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token class-name\">ListStateDescriptor</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">></span></span> itemsStateDesc <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ListStateDescriptor</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token string\">\"itemState-state\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    itemState <span class=\"token operator\">=</span> <span class=\"token function\">getRuntimeContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getListState</span><span class=\"token punctuation\">(</span>itemsStateDesc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">processElement</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token class-name\">ItemViewCount</span> input<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token class-name\">Context</span> context<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token class-name\">Collector</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> collector<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token comment\">// 每条数据都保存到状态中</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    itemState<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// 注册 windowEnd+1 的 EventTime Timer, 当触发时，说明收齐了属于 windowEnd 窗口的所有商品数据</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    context<span class=\"token punctuation\">.</span><span class=\"token function\">timerService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">registerEventTimeTimer</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span>windowEnd <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onTimer</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token keyword\">long</span> timestamp<span class=\"token punctuation\">,</span> <span class=\"token class-name\">OnTimerContext</span> ctx<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Collector</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> out<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">// 获取收到的所有商品点击量</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">></span></span> allItems <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ItemViewCount</span> item <span class=\"token operator\">:</span> itemState<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      allItems<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token comment\">// 提前清除状态中的数据，释放空间</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    itemState<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">// 按照点击量从大到小排序</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    allItems<span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Comparator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemViewCount</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ItemViewCount</span> o1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ItemViewCount</span> o2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>o2<span class=\"token punctuation\">.</span>viewCount <span class=\"token operator\">-</span> o1<span class=\"token punctuation\">.</span>viewCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token comment\">// 将排名信息格式化成 String, 便于打印</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token class-name\">StringBuilder</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    result<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"====================================\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    result<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"时间: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Timestamp</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>topSize<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token class-name\">ItemViewCount</span> currentItem <span class=\"token operator\">=</span> allItems<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token comment\">// No1:  商品 ID=12224  浏览量 = 2413</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      result<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"  商品ID=\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>currentItem<span class=\"token punctuation\">.</span>itemId<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"  浏览量=\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>currentItem<span class=\"token punctuation\">.</span>viewCount<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    result<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"====================================\\n\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    out<span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"打印输出\"><a class=\"anchor\" href=\"#打印输出\">#</a> 打印输出</h3>\n<p>最后一步我们将结果打印输出到控制台，并调用 <code>env.execute</code>  执行任务。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>topItems<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>env<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hot Items Job\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"运行程序\"><a class=\"anchor\" href=\"#运行程序\">#</a> 运行程序</h2>\n<p>直接运行 main 函数，就能看到不断输出的每个时间点的热门商品 ID。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1o_fIn3TqK1RjSZPhXXXfOFXa-1534-1270.png\" alt=\"image\" /></p>\n",
            "tags": [
                "大数据",
                "Flink"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E7%AE%A1%E7%90%86Kafka%E7%9A%84%E6%B6%88%E8%B4%B9%E4%BD%8D%E7%82%B9/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E7%AE%A1%E7%90%86Kafka%E7%9A%84%E6%B6%88%E8%B4%B9%E4%BD%8D%E7%82%B9/",
            "title": "Flink管理 Kafka 消费位点",
            "date_published": "2024-01-02T16:00:00.000Z",
            "content_html": "<p>检查点（Checkpoint）是使 Apache Flink 能从故障恢复的一种内部机制。检查点是 Flink 应用状态的一个一致性副本，包括了输入的读取位点。在发生故障时，Flink 通过从检查点加载应用程序状态来恢复，并从恢复的读取位点继续处理，就好像什么事情都没发生一样。你可以把检查点想象成电脑游戏的存档一样。如果你在游戏中发生了什么事情，你可以随时读档重来一次。</p>\n<p>检查点使得 Apache Flink 具有容错能力，并确保了即时发生故障也能保证流应用程序的语义。检查点是以固定的间隔来触发的，该间隔可以在应用中配置。</p>\n<p>Apache Flink 中实现的 Kafka 消费者是一个有状态的算子（operator），它集成了 Flink 的检查点机制，它的状态是所有 Kafka 分区的读取偏移量。当一个检查点被触发时，每一个分区的偏移量都被存到了这个检查点中。Flink 的检查点机制保证了所有 operator task 的存储状态都是一致的。这里的 “一致的” 是什么意思呢？意思是它们存储的状态都是<strong>基于相同的输入数据</strong>。当所有的 operator task 成功存储了它们的状态，一个检查点才算完成。因此，当从潜在的系统故障中恢复时，系统提供了 excatly-once 的状态更新语义。</p>\n<p>下面我们将一步步地介绍 Apache Flink 中的 Kafka 消费位点是如何做检查点的。在本文的例子中，数据被存在了 Flink 的 JobMaster 中。值得注意的是，在 POC 或生产用例下，这些数据最好是能存到一个外部文件系统（如 HDFS 或 S3）中。</p>\n<h3 id=\"第一步\"><a class=\"anchor\" href=\"#第一步\">#</a> 第一步：</h3>\n<p>如下所示，一个 Kafka topic，有两个 partition，每个 partition 都含有 “A”, “B”, “C”, ”D”, “E” 5 条消息。我们将两个 partition 的偏移量（offset）都设置为 0.</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1QQ91nhTpK1RjSZR0XXbEwXXa-842-415.png\" alt=\"image\" /></p>\n<h3 id=\"第二步\"><a class=\"anchor\" href=\"#第二步\">#</a> 第二步：</h3>\n<p>Kafka comsumer（消费者）开始从 partition 0 读取消息。消息 “A” 正在被处理，第一个 consumer 的 offset 变成了 1。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1jBS2nb2pK1RjSZFsXXaNlXXa-842-420.png\" alt=\"image\" /></p>\n<h3 id=\"第三步\"><a class=\"anchor\" href=\"#第三步\">#</a> 第三步：</h3>\n<p>消息 “A” 到达了 Flink Map Task。两个 consumer 都开始读取他们下一条消息（partition 0 读取 “B”，partition 1 读取 “A”）。各自将 offset 更新成 2 和 1 。同时，Flink 的 JobMaster 开始在 source 触发了一个检查点。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1ZNS8nkvoK1RjSZFNXXcxMVXa-842-423.png\" alt=\"image\" /></p>\n<h3 id=\"第四步\"><a class=\"anchor\" href=\"#第四步\">#</a> 第四步：</h3>\n<p>接下来，由于 source 触发了检查点，Kafka consumer 创建了它们状态的第一个快照（”offset = 2, 1”），并将快照存到了 Flink 的 JobMaster 中。Source 在消息 “B” 和 “A” 从 partition 0 和 1 发出后，发了一个 checkpoint barrier。Checkopint barrier 用于各个 operator task 之间对齐检查点，保证了整个检查点的一致性。消息 “A” 到达了 Flink Map Task，而上面的 consumer 继续读取下一条消息（消息 “C”）。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1o4TbnkzoK1RjSZFlXXai4VXa-842-447.png\" alt=\"image\" /></p>\n<h3 id=\"第五步\"><a class=\"anchor\" href=\"#第五步\">#</a> 第五步：</h3>\n<p>Flink Map Task 收齐了同一版本的全部 checkpoint barrier 后，那么就会将它自己的状态也存储到 JobMaster。同时，consumer 会继续从 Kafka 读取消息。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1EI2XngHqK1RjSZFkXXX.WFXa-842-439.png\" alt=\"image\" /></p>\n<h3 id=\"第六步\"><a class=\"anchor\" href=\"#第六步\">#</a> 第六步：</h3>\n<p>Flink Map Task 完成了它自己状态的快照流程后，会向 Flink JobMaster 汇报它已经完成了这个 checkpoint。当所有的 task 都报告完成了它们的状态 checkpoint 后，JobMaster 就会将这个 checkpoint 标记为成功。从此刻开始，这个 checkpoint 就可以用于故障恢复了。值得一提的是，Flink 并不依赖 Kafka offset 从系统故障中恢复。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1huHtnhnaK1RjSZFBXXcW7VXa-842-417.png\" alt=\"image\" /></p>\n<h3 id=\"故障恢复\"><a class=\"anchor\" href=\"#故障恢复\">#</a> 故障恢复</h3>\n<p>在发生故障时（比如，某个 worker 挂了），所有的 operator task 会被重启，而他们的状态会被重置到最近一次成功的 checkpoint。Kafka source 分别从 offset 2 和 1 重新开始读取消息（因为这是完成的 checkpoint 中存的 offset）。当作业重启后，我们可以期待正常的系统操作，就好像之前没有发生故障一样。如下图所示：</p>\n<p><img data-src=\"https://img.alicdn.com/tfs/TB1o8zXnmzqK1RjSZFjXXblCFXa-842-411.png\" alt=\"image\" /></p>\n",
            "tags": [
                "大数据",
                "Flink"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E5%85%B3%E8%81%94%E7%BB%B4%E8%A1%A8%E6%96%B9%E6%A1%88/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E5%85%B3%E8%81%94%E7%BB%B4%E8%A1%A8%E6%96%B9%E6%A1%88/",
            "title": "Flink关联维表方案",
            "date_published": "2023-12-19T16:00:00.000Z",
            "content_html": "<p><strong>衡量指标</strong></p>\n<p>总体来讲，关联维表有三个基础的方式：实时数据库查找关联（Per-Record Reference Data Lookup）、预加载维表关联（Pre-Loading of Reference Data）和维表变更日志关联（Reference Data Change Stream），而根据实现上的优化可以衍生出多种关联方式，且这些优化还可以灵活组合产生不同效果（不过为了简单性这里不讨论同时应用多种优化的实现方式）。对于不同的关联方式，我们可以从以下 7 个关键指标来衡量（每个指标的得分将以 1-5 五档来表示）:</p>\n<ol>\n<li><strong>实现简单性</strong>：设计是否足够简单，易于迭代和维护。</li>\n<li><strong>吞吐量</strong>：性能是否足够好。</li>\n<li><strong>维表数据的实时性</strong>：维度表的更新是否可以立刻对作业可见。</li>\n<li><strong>数据库的负载:</strong> 是否对外部数据库造成较大的负载（负载越低分越高）。</li>\n<li><strong>内存资源占用</strong>：是否需要大量内存来缓存维表数据（内存占用越少分越高）。</li>\n<li><strong>可拓展性</strong>：在更大规模的数据下会不会出现瓶颈。</li>\n<li><strong>结果确定性</strong>：在数据延迟或者数据重放情况下，是否可以得到一致的结果。</li>\n</ol>\n<p>和大多数架构设计一样，这三类关联方式不存在绝对的好坏，更多的是针对业务场景在各指标上的权衡取舍，因此这里的得分也仅仅是针对通用场景来说。</p>\n<p><strong>实时数据库查找关联</strong></p>\n<p>实时数据库查找关联是在 DataStream API 用户函数中直接访问数据库来进行关联的方式。这种方式通常开发量最小，但一般会给数据库带来很大的压力，而且因为关联是基于 Processing Time 的，如果数据有延迟或者重放，会得到和原来不一致的数据。</p>\n<p><strong>同步数据库查找关联</strong></p>\n<p>同步实时数据库查找关联是最为简单的关联方式，只需要在一个 Map 或者 FlatMap 函数中访问数据库，处理好关联逻辑后，将结果数据输出。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIcXlndnBDQ3loeDJtam82cTVPNzBuZHhTSVdibXduN2liakN4RmR6NG9RNXRuWkp6aGYzMkJzUS82NDA\" alt=\"img\" /></p>\n<p>图 1. 同步数据库查找关联架构</p>\n<p>这种方式的主要优点在于实现简单、不需要额外内存且维表的更新延迟很低，然而缺点也很明显:</p>\n<ol>\n<li>因为每条数据都需要请求一次数据库，给数据库造成的压力很大；</li>\n<li>访问数据库是同步调用，导致 subtask 线程会被阻塞，影响吞吐量；</li>\n<li>关联是基于 Processing Time 的，结果并不具有确定性；</li>\n<li>瓶颈在数据库端，但实时计算的流量通常远大于普通数据库的设计流量，因此可拓展性比较低。</li>\n</ol>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIanlQN0ZhM3FBN01pYnZDV2ZkckZqa1F6TG9STG12N0xyaWFuVzNVdjlrY2NkQkxnN1RUdGdjRGcvNjQw\" alt=\"img\" /></p>\n<p>图 2. 同步数据库查找关联关键指标</p>\n<p>从应用场景来说，同步数据库查找关联可以用于流量比较低的作业，但通常不是最好的选择。</p>\n<p><strong>异步数据库查找关联</strong></p>\n<p>异步数据库查找关联是通过 AsyncIO [2] 来访问外部数据库的方式。利用数据库提供的异步客户端，AsyncIO 可以并发地处理多个请求，很大程度上减少了对 subtask 线程的阻塞。</p>\n<p>因为数据库请求响应时长是不确定的，可能导致后输入的数据反而先完成计算，所以 AsyncIO 提供有序和无序两种输出模式，前者会按请求返回顺序输出数据，后者则会缓存提前完成计算的数据，并按输入顺序逐个输出结果。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIRGJsZXNOaWFvcHNpYnhwdVRPbngzdVFWb3BsMEFiNTVJdVJQREtPSGpUTExKcFJpYmlja1laZFNYUS82NDA\" alt=\"img\" /> 图 3. 异步数据库查找关联架构</p>\n<p>比起同步数据库查找关联，异步数据库查找关联稍微复杂一点，但是大部分的逻辑都由 Flink AsyncIO API 封装，因此总体来看还是比较简单。然而，有序输出模式下的 AsyncIO 会需要缓存数据，且这些数据会被写入 checkpoint，因此在内容资源方面的得分会低一点。另一方面，同步数据库查找关联的吞吐量问题得到解决，但仍不可避免地有数据库负载高和结果不确定两个问题。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIcGZJeXBNTHpIN2VXMFNPY0N5UEpCTm9jbG1pYWdKM2NCdjh3c3Fjb1NwY0Nac2hMajBOZURpYVEvNjQw\" alt=\"img\" /></p>\n<p>图 4. 异步数据库查找关联关键指标</p>\n<p>从应用场景来说，异步数据库查找关联比较适合流量低的实时计算。</p>\n<p><strong>带缓存的数据库查找关联</strong></p>\n<p>为了解决上述两种关联方式对数据库造成太大压力的问题，可以引入一层缓存来减少直接对数据库的请求。缓存并一般不需要通过 checkpoint 机制持久化，因此简单地用一个 WeakHashMap 或者 Guava Cache 就可以实现。</p>\n<p><img data-src=\"https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIcGZJeXBNTHpIN2VXMFNPY0N5UEpCTm9jbG1pYWdKM2NCdjh3c3Fjb1NwY0Nac2hMajBOZURpYVEvNjQw?x-oss-process=image/format,png\" alt=\"img\" /></p>\n<p>图 5. 带缓存的数据库查找关联架构</p>\n<p>虽然在冷启动的时候仍会给数据库造成一定压力，但后续取决于缓存命中率，数据库的压力将得到一定程度的缓解。然而使用缓存带来的问题是维表的更新并不能及时反应到关联操作上，当然这也和缓存剔除的策略有关，需要根据维度表更新频率和业务对过时维表数据的容忍程度来设计。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIMmFBcFMyVzlEekRaVVZmWjRHQjlsdkphQ0lpYWxxV2pBZFRsME1raWJLb2RnZFlWeDAxV3AwWVEvNjQw\" alt=\"img\" /></p>\n<p>图 6. 带缓存的数据库查找关联关键指标</p>\n<p>总而言之，带缓存的数据库查找关联适合于流量比较低，且对维表数据实时性要求不太高或维表更新比较少的业务场景。</p>\n<p><strong>预加载维表关联</strong></p>\n<p>相比起实时数据库查找在运行期间为每条数据访问一次数据库，预加载维表关联是在作业启动时就将维表读到内存中，而在后续运行期间，每条数据都会和内存中的维表进行关联，而不会直接触发对数据的访问。与带缓存的实时数据库查找关联相比，区别是后者如果不命中缓存还可以 fallback 到数据库访问，而前者如果不名中则会关联不到数据。</p>\n<p><strong>启动预加载维表</strong></p>\n<p>启动预加载维表是最为简单的一种方式，即在作业初始化的时候，比如用户函数的 open () 方法，直接从数据库将维表拷贝到内存中。维表并不需要用 State 来保存，因为无论是手动重启或者是 Flink 的错误重试机制导致的重启，open () 方法都会被执行，从而得到最新的维表数据。</p>\n<p><img data-src=\"https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIb21LcktCY0hRam5PV3RCZWliUXBRdFlDdWI1SUxISnBFMm1KNmhwZ0tBVzRvbno1dnB4aWFaM1EvNjQw?x-oss-process=image/format,png\" alt=\"img\" /></p>\n<p>图 7. 启动预加载维表架构</p>\n<p>启动预加载维表对数据库的压力只持续很短时间，但因为是拷贝整个维表所以压力是很大的，而换来的优势是在运行期间不需要再访问数据库，可以提高效率，有点类似离线计算。相对地，问题在于运行期间维表数据不能更新，且对 TaskManager 内存的要求比较高。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZINmlhMVFtN1JCUDU1Q1oxWGVuUXJSaFM2NW4wb0NRTlFrc1RsYTFNaWJJSFV0emJvT3Z6a0xtZEEvNjQw\" alt=\"img\" /></p>\n<p>图 8. 启动预加载维表关键指标</p>\n<p>启动预加载维表适合于维表比较小、变更实时性要求不高的场景，比如根据 ip 库解析国家地区，如果 ip 库有新版本，重启作业即可。</p>\n<p><strong>启动预加载分区维表</strong></p>\n<p>对于维表比较大的情况，可以启动预加载维表基础之上增加分区功能。简单来说就是将数据流按字段进行分区，然后每个 Subtask 只需要加在对应分区范围的维表数据。值得注意的是，这里的分区方式并不是用 keyby 这种通用的 hash 分区，而是需要根据业务数据定制化分区策略，然后调用 DataStream#partitionCustom。比如按照 userId 等区间划分，0-999 划分到 subtask 1，1000-1999 划分到 subtask 2，以此类推。而在 open () 方法中，我们再根据 subtask 的 id 和总并行度来计算应该加载的维表数据范围。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIV0EzU3ZlUzlJUFNWcndYMm9zeWFhRnA2aGg3bWpOT0hIV004Q2swRTZoTkdGbzlnY2Y0ZExRLzY0MA\" alt=\"img\" /></p>\n<p>图 9. 启动预加载分区维表架构</p>\n<p>通过这种分区方式，维表的大小上限理论上可以线性拓展，解决了维表大小受限于单个 TaskManager 内存的问题（现在是取决于所有 TaskManager 的内存总量），但同时给带来设计和维护分区策略的复杂性。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIMDBNNEVYVm1aeXB1M3NWZmljbjhScnRpY2JFWVN0cERpYjhTaFIwMTFSTjVTQVM4Y1ZUcUx4UDRnLzY0MA\" alt=\"img\" /></p>\n<p>图 10. 启动预加载分区维表关键指标</p>\n<p>总而言之，启动预加载分区维表适合维表比较大而变更实时性要求不高的场景，比如用户点击数据关联用户所在地。</p>\n<p><strong>启动预加载维表并定时刷新</strong></p>\n<p>除了维表大小的限制，启动预加载维表的另一个主要问题在于维度数据的更新，我们可以通过引入定时刷新机制的办法来缓解这个问题。定时刷新可以通过 Flink ProcessFucntion 提供的 Timer 或者直接在 open () 初始化一个线程（池）来做这件事。不过 Timer 要求 KeyedStream，而上述的 DataStream#partitionCustom 并不会返回一个 KeyedStream，因此两者并不兼容。而如果使用额外线程定时刷新的办法则不受这个限制。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIdGo0MXR0YXJZUjZmb3dPTUI4dEV1aE82VEJJS2d2NE9TYXVUaWMwMDJ0N0oxMFNoV0VGUkdjZy82NDA\" alt=\"img\" /></p>\n<p>图 11. 启动预加载维表并定时刷新架构</p>\n<p>比起基础的启动预加载维表 ，这种方式在于引入比较小复杂性的情况下大大缓解了的维度表更新问题，但也给维表数据库带来更多压力，因为每次 reload 的时候都是一次请求高峰。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIdzlyaWNmSUQ5Nk5TeDFzN2hFRzhwODh3TUp4RG5mVUhkSTFQRk9yZDNrdzdmalRpYm9BSkh6cncvNjQw\" alt=\"img\" /></p>\n<p>图 12. 启动预加载维表并定时刷新关键指标</p>\n<p>启动预加载维表和定时刷新的组合适合维表变更实时性要求不是特别高的场景。取决于定时刷新的频率和数据库的性能，这种方式可以满足大部分关联维表的业务。</p>\n<p><strong>启动预加载维表 + 实时数据库查找</strong></p>\n<p>启动预加载维表还可以和实时数据库查找混合使用，即将预加载的维表作为缓存给实时关联时使用，若未名中则 fallback 到数据库查找。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIMEpPRzB5QTdZUjVHNFFkODlBRWNxZ2JsaWI3TUxDNmhhZWxwZFBGbEVIeG1IRE53SjI4UjlqZy82NDA\" alt=\"img\" /></p>\n<p>图 13. 启动预加载维表结合实时数据库查找架构</p>\n<p>这种方式实际是带缓存的数据库查找关联的衍生，不同之处在于相比冷启动时未命中缓存导致的多次实时数据库访问，该方式直接批量拉取整个维表效率更高，但也有可能拉取到不会访问到的多余数据。下面雷达图中显示的是用异步数据库查找，如果是同步数据库查找吞吐量上会低一些。</p>\n<p><img data-src=\"https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIZU1LYWZDaWE0bVlyYXZHSHkyZkxwYmxCY0kwYVpjZWdWbmFnMjJ1U0E3ZGxDUFptaWFjdTlTWFEvNjQw?x-oss-process=image/format,png\" alt=\"img\" /></p>\n<p>图 14. 启动预加载维表结合实时数据库查找关键指标</p>\n<p>这种方式和带缓存的实时数据库查找关联基本相同，适合流量比较低，且对维表数据实时性要求不太高或维表更新比较少的业务场景。</p>\n<p><strong>维表变更日志关联</strong></p>\n<p>不同于上述两者将维表作为静态表关联的方式，维表变更日志关联将维表以 changelog 数据流的方式表示，从而将维表关联转变为两个数据流的 join。这里的 changelog 数据流类似于 MySQL 的 binlog，通常需要维表数据库端以 push 的方式将日志写到 Kafka 等消息队列中。Changelog 数据流称为 build 数据流，另外待关联的主要数据流成为 probe 数据流。</p>\n<p>维表变更日志关联的好处在于可以获取某个 key 数据变化的时间，从而使得我们能在关联中使用 Event Time（当然也可以使用 Processing Time）。</p>\n<p><strong>Processing Time 维表变更日志关联</strong></p>\n<p>如果基于 Processing Time 做关联，我们可以利用 keyby 将两个数据流中关联字段值相同的数据划分到 KeyedCoProcessFunction 的同一个分区，然后用 ValueState 或者 MapState 将维表数据保存下来。在普通数据流的一条记录进到函数时，到 State 中查找有无符合条件的 join 对象，若有则关联输出结果，若无则根据 join 的类型决定是直接丢弃还是与空值关联。这里要注意的是，State 的大小要尽量控制好。首先是只保存每个 key 最新的维度数据值，其次是要给 State 设置好 TTL，让 Flink 可以自动清理。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIZEY4WXA2bm5UaDl5M1JINXVDMnJ0QVpGUGZFQURkaWNlSG9zZ2F6UEg0RXM1YXRtcXZBZGgyZy82NDA\" alt=\"img\" /></p>\n<p>图 15.Processing Time 维表变更日志关联架构</p>\n<p>基于 Processing Time 的维表变更日志关联优点是不需要直接请求数据库，不会对数据库造成压力；缺点是比较复杂，相当于使用 changelog 在 Flink 应用端重新构建一个维表，会占用一定的 CPU 和比较多的内存和磁盘资源。值得注意的是，我们可以利用 Flink 提供的 RocksDB StateBackend，将大部分的维表数据存在磁盘而不是内存中，所以并不会占用很高的内存。不过基于 Processing Time 的这种关联对两个数据流的延迟要求比较高，否则如果其中一个数据流出现 lag 时，关联得到的结果可能并不是我们想要的，比如可能会关联到未来时间点的维表数据。</p>\n<p><img data-src=\"https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIYUhFNU4zdG40M3ZOdjJ0UlJvUEpleTRxUE51TVNaaFR3YUIyWTlxSG5pY3lRb1VzYm55cXBzdy82NDA?x-oss-process=image/format,png\" alt=\"img\" /></p>\n<p>图 16.Processing Time 维表变更日志关联关键指标</p>\n<p>基于 Processing Time 的维表变更日志关联比较适用于不便直接访问数据的场景（比如维表数据库是业务线上数据库，出于安全和负载的原因不能直接访问），或者对维表的变更实时性要求比较高的场景（但因为数据准确性的关系，一般用下文的 Event Time 关联会更好）。</p>\n<p><strong>Event Time 维表变更日志关联</strong></p>\n<p>基于 Event Time 的维表关联实际上和基于 Processing Time 的十分相似，不同之处在于我们将维表 changelog 的多个时间版本都记录下来，然后每当一条记录进来，我们会找到对应时间版本的维表数据来和它关联，而不是总用最新版本，因此延迟数据的关联准确性大大提高。不过因为目前 State 并没有提供 Event Time 的 TTL，因此我们需要自己设计和实现 State 的清理策略，比如直接设置一个 Event Time Timer（但要注意 Timer 不能太多导致性能问题），再比如对于单个 key 只保存最近的 10 个版本，当有更新版本的维表数据到达时，要清理掉最老版本的数据。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIbE5aUHJBaWFKalJjbFplUzYzTjJCbko0SjhQNDJDaWJIb3pYTlpBRGhWUWRuWkFSUkFhYVp0QVEvNjQw\" alt=\"图17.Event Time 维表变更日志关联架构\" /></p>\n<p>图 17.Event Time 维表变更日志关联架构</p>\n<p>基于 Event Time 的维表变更日志关联相对基于 Processing Time 的方式来说是一个改进，虽然多个维表版本导致空间资源要求更大，但确保准确性对于大多数场景来说都是十分重要的。相比 Processing Time 对两个数据的延迟都有要求，Event Time 要求 build 数据流的延迟低，否则可能一条数据到达时关联不到对应维表数据或者关联了一个过时版本的维表数据，</p>\n<p><img data-src=\"https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIbWozR21KRTlGYVJBVjU4VmR4RXUybndtWXNqWnVsU1U5QVJFaWE5MXFnS1Q2WUtaR2c0bWVNQS82NDA?x-oss-process=image/format,png\" alt=\"img\" /></p>\n<p>图 18.Event Time 维表变更日志关联关键指标</p>\n<p>基于 Event Time 的维表变更日志关联比较适合于维表变更比较多且对变更实时性要求较高的场景 同时也适合于不便直接访问数据库的场景。</p>\n<p><strong>Temporal Table Join</strong></p>\n<p>Temporal Table Join 是 Flink SQL/Table API 的原生支持，它对两个数据流的输入都进行了缓存，因此比起上述的基于 Event Time 的维表变更日志关联，它可以容忍任意数据流的延迟，数据准确性更好。Temporal Table Join 在 SQL/Table API 使用时是十分简单的，但如果想在 DataStream API 中使用，则需要自己实现对应的逻辑。</p>\n<p>总体思路是使用一个 CoProcessFunction，将 build 数据流以时间版本为 key 保存在 MapState 中（与基于 Event Time 的维表变更日志关联相同），再将 probe 数据流和输出结果也用 State 缓存起来（同样以 Event Time 为 key），一直等到 Watermark 提升到它们对应的 Event Time，才把结果输出和将两个数据流的输入清理掉。</p>\n<p>这个 Watermark 触发很自然地是用 Event Time Timer 来实现，但要注意不要为每条数据都设置一遍 Timer，因为一旦 Watermark 提升会触发很多个 Timer 导致性能急剧下降。比较好的实践是为每个 key 只注册一个 Timer。实现上可以记录当前未处理的最早一个 Event Time，并用来注册 Timer。当前 Watermark。每当 Watermark 触发 Timer 时，我们检查处理掉未处理的最早 Event Time 到当前 Event Time 的所有数据，并将未处理的最早 Event Time 更新为当前时间。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIS3VEeE45QWVmVFMwc0RGMUtpY0dGelhneG10TGR4cXJnQmljZ3BmbHl6Qlp0alVBQ0RuWGZLQUEvNjQw\" alt=\"img\" /></p>\n<p>图 19.Temporal Table Join 架构</p>\n<p>Temporal Table Join 的好处在于对于两边数据流的延迟的容忍度较大，但作为代价会引入一定的输出结果的延迟，这也是基于 Watermark 机制的计算的常见问题，或者说，妥协。另外因为吞吐量较大的 probe 数据流也需要缓存，Flink 应用对空间资源的需求会大很多。最好，要注意的是如果维表变更太慢，导致 Watermark 提升太慢，会导致 probe 数据流被大量缓存，所以最好要确保 build 数据流尽量实时，同时给 Source 设置一个比较短的 idle timeout。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy84QXNZQmljRWVQdTRSbDg5YVk2QTZaVVVhdGliMm1odjZIaWFTZTlXUU9qbk55Zm9Ba2xHM1QwT2ZpY1ZxM1FqT1ZNY2wwaWJFUGpGVmxKSkJLZ1d2dExJZU13LzY0MA\" alt=\"img\" /></p>\n<p>图 20.Temporal Table Join 关键指标</p>\n<p>Temporal Table Join 这种方式最为复杂，但数据准确性最好，适合一些对数据准确性要求高且可以容忍一定延迟（一般分钟级别）的关键业务。</p>\n<p><strong>衡量指标</strong></p>\n<p>用 Flink DataStream API 实现关联维表的方式十分丰富，可以直接访问数据库查找（实时数据库查找关联），可以启动时就将全量维表读到内存（预加载维表关联），也可以通过维表的 changelog 在 Flink 应用端实时构建一个新的维表（维表变更日志关联）。我们可以从实现简单性、吞吐量、维表数据的实时性、数据库的负载、内存资源占用、可拓展性和结果确定性这 7 个维度来衡量一个具体实现方式，并根据业务需求来选择最合适的实现。</p>\n",
            "tags": [
                "大数据",
                "Flink"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E7%9A%84%E5%BC%82%E6%AD%A5IO/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E7%9A%84%E5%BC%82%E6%AD%A5IO/",
            "title": "Flink的异步IO",
            "date_published": "2023-12-09T16:00:00.000Z",
            "content_html": "<h2 id=\"背景\"><a class=\"anchor\" href=\"#背景\">#</a> 背景</h2>\n<p>Async I/O 是阿里巴巴贡献给社区的一个呼声非常高的特性，于 1.2 版本引入。主要目的是为了解决与外部系统交互时网络延迟成为了系统瓶颈的问题。</p>\n<p>流计算系统中经常需要与外部系统进行交互，比如需要查询外部数据库以关联上用户的额外信息。通常，我们的实现方式是向数据库发送用户 <code>a</code>  的查询请求，然后等待结果返回，在这之前，我们无法发送用户 <code>b</code>  的查询请求。这是一种同步访问的模式，如下图左边所示。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB11fwcRXXXXXXwXpXXXXXXXXXX\" alt=\"image\" /></p>\n<p>图中棕色的长条表示等待时间，可以发现网络等待时间极大地阻碍了吞吐和延迟。为了解决同步访问的问题，异步模式可以并发地处理多个请求和回复。也就是说，你可以连续地向数据库发送用户 <code>a</code> 、 <code>b</code> 、 <code>c</code>  等的请求，与此同时，哪个请求的回复先返回了就处理哪个回复，从而连续的请求之间不需要阻塞等待，如上图右边所示。这也正是 Async I/O 的实现原理。</p>\n<h2 id=\"async-io\"><a class=\"anchor\" href=\"#async-io\">#</a> Async I/O</h2>\n<p>使用 Async I/O 的前提是需要一个支持异步请求的客户端。当然，没有异步请求客户端的话也可以将同步客户端丢到线程池中执行作为异步客户端。Flink 提供了非常简洁的 API，让用户只需要关注业务逻辑，一些脏活累活比如消息顺序性和一致性保证都由框架处理了，多么棒的事情！</p>\n<p>使用方式如下方代码片段所示（来自官网文档）：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/** 'AsyncFunction' 的一个实现，向数据库发送异步请求并设置回调 */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">AsyncDatabaseRequest</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AsyncFunction</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">/** 可以异步请求的特定数据库的客户端 */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    lazy val client<span class=\"token operator\">:</span> <span class=\"token class-name\">DatabaseClient</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DatabaseClient</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> post<span class=\"token punctuation\">,</span> credentials<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">/** future 的回调的执行上下文（当前线程） */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    implicit lazy val executor<span class=\"token operator\">:</span> <span class=\"token class-name\">ExecutionContext</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">ExecutionContext</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromExecutor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">directExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    override def <span class=\"token function\">asyncInvoke</span><span class=\"token punctuation\">(</span>str<span class=\"token operator\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> asyncCollector<span class=\"token operator\">:</span> <span class=\"token class-name\">AsyncCollector</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Unit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// 发起一个异步请求，返回结果的 future</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        val resultFuture<span class=\"token operator\">:</span> <span class=\"token class-name\">Future</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// 设置请求完成时的回调：将结果传递给 collector</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        resultFuture<span class=\"token punctuation\">.</span>onSuccess <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">case</span> result<span class=\"token operator\">:</span> <span class=\"token class-name\">String</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> asyncCollector<span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Iterable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// 创建一个原始的流</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>val stream<span class=\"token operator\">:</span> <span class=\"token class-name\">DataStream</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">// 添加一个 async I/O 的转换</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>val resultStream<span class=\"token operator\">:</span> <span class=\"token class-name\">DataStream</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token class-name\">AsyncDataStream</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>un<span class=\"token punctuation\">)</span><span class=\"token function\">orderedWait</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      stream<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AsyncDatabaseRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span>MILLISECONDS<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 超时时间</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token number\">100</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// 进行中的异步请求的最大数量</span></pre></td></tr></table></figure><p><code>AsyncDataStream</code>  有两个静态方法， <code>orderedWait</code>  和  <code>unorderedWait</code> ，对应了两种输出模式：有序和无序。</p>\n<ul>\n<li>有序：消息的发送顺序与接受到的顺序相同（包括 watermark ），也就是先进先出。</li>\n<li>无序：\n<ul>\n<li>在 ProcessingTime 的情况下，完全无序，先返回的结果先发送。</li>\n<li>在 EventTime 的情况下，watermark 不能超越消息，消息也不能超越 watermark，也就是说 watermark 定义的顺序的边界。在两个 watermark 之间的消息的发送是无序的，但是在 watermark 之后的消息不能先于该 watermark 之前的消息发送。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"原理实现\"><a class=\"anchor\" href=\"#原理实现\">#</a> 原理实现</h2>\n<p><code>AsyncDataStream.(un)orderedWait</code>  的主要工作就是创建了一个  <code>AsyncWaitOperator</code> 。 <code>AsyncWaitOperator</code>  是支持异步 IO 访问的算子实现，该算子会运行  <code>AsyncFunction</code>  并处理异步返回的结果，其内部原理如下图所示。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1tBPQRXXXXXX2aXXXXXXXXXXX\" alt=\"image\" /></p>\n<p>如图所示， <code>AsyncWaitOperator</code>  主要由两部分组成： <code>StreamElementQueue</code>  和  <code>Emitter</code> 。StreamElementQueue 是一个 Promise 队列，所谓 Promise 是一种异步抽象表示将来会有一个值（参考 <span class=\"exturl\" data-url=\"aHR0cDovL2RvY3Muc2NhbGEtbGFuZy5vcmcvemgtY24vb3ZlcnZpZXdzL2NvcmUvZnV0dXJlcy5odG1sI3Byb21pc2Vz\">Scala Promise</span> 了解更多），这个队列是未完成的 Promise 队列，也就是进行中的请求队列。Emitter 是一个单独的线程，负责发送消息（收到的异步回复）给下游。</p>\n<p>图中 <code>E5</code>  表示进入该算子的第五个元素（”Element-5”），在执行过程中首先会将其包装成一个 “Promise”  <code>P5</code> ，然后将 <code>P5</code>  放入队列。最后调用  <code>AsyncFunction</code>  的  <code>ayncInvoke</code>  方法，该方法会向外部服务发起一个异步的请求，并注册回调。该回调会在异步请求成功返回时调用  <code>AsyncCollector.collect</code>  方法将返回的结果交给框架处理。实际上  <code>AsyncCollector</code>  是一个 Promise ，也就是  <code>P5</code> ，在调用  <code>collect</code>  的时候会标记 Promise 为完成状态，并通知 Emitter 线程有完成的消息可以发送了。Emitter 就会从队列中拉取完成的 Promise ，并从 Promise 中取出消息发送给下游。</p>\n<h3 id=\"消息的顺序性\"><a class=\"anchor\" href=\"#消息的顺序性\">#</a> 消息的顺序性</h3>\n<p>上文提到 Async I/O 提供了两种输出模式。其实细分有三种模式：有序，ProcessingTime 无序，EventTime 无序。Flink 使用队列来实现不同的输出模式，并抽象出一个队列的接口（ <code>StreamElementQueue</code> ），这种分层设计使得 <code>AsyncWaitOperator</code>  和 <code>Emitter</code>  不用关心消息的顺序问题。 <code>StreamElementQueue</code>  有两种具体实现，分别是  <code>OrderedStreamElementQueue</code>  和  <code>UnorderedStreamElementQueue</code> 。 <code>UnorderedStreamElementQueue</code>  比较有意思，它使用了一套逻辑巧妙地实现完全无序和 EventTime 无序。</p>\n<h4 id=\"有序\"><a class=\"anchor\" href=\"#有序\">#</a> 有序</h4>\n<p>有序比较简单，使用一个队列就能实现。所有新进入该算子的元素（包括 watermark），都会包装成 Promise 并按到达顺序放入该队列。如下图所示，尽管 <code>P4</code>  的结果先返回，但并不会发送，只有  <code>P1</code>  （队首）的结果返回了才会触发 Emitter 拉取队首元素进行发送。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB16DYTRXXXXXbWXVXXXXXXXXXX\" alt=\"image\" /></p>\n<h4 id=\"processingtime-无序\"><a class=\"anchor\" href=\"#processingtime-无序\">#</a> ProcessingTime 无序</h4>\n<p>ProcessingTime 无序也比较简单，因为没有 watermark，不需要协调 watermark 与消息的顺序性，所以使用两个队列就能实现，一个  <code>uncompletedQueue</code>  一个  <code>completedQueue</code> 。所有新进入该算子的元素，同样的包装成 Promise 并放入  <code>uncompletedQueue</code>  队列，当 <code>uncompletedQueue</code>  队列中任意的 Promise 返回了数据，则将该 Promise 移到  <code>completedQueue</code>  队列中，并通知 Emitter 消费。如下图所示：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1zzsnRXXXXXbNXXXXXXXXXXXX\" alt=\"image\" /></p>\n<h4 id=\"eventtime-无序\"><a class=\"anchor\" href=\"#eventtime-无序\">#</a> EventTime 无序</h4>\n<p>EventTime 无序类似于有序与 ProcessingTime 无序的结合体。因为有 watermark，需要协调 watermark 与消息之间的顺序性，所以 <code>uncompletedQueue</code>  中存放的元素从原先的 Promise 变成了 Promise 集合。如果进入算子的是消息元素，则会包装成 Promise 放入队尾的集合中。如果进入算子的是 watermark，也会包装成 Promise 并放到一个独立的集合中，再将该集合加入到  <code>uncompletedQueue</code>  队尾，最后再创建一个空集合加到  <code>uncompletedQueue</code>  队尾。这样，watermark 就成了消息顺序的边界。只有处在队首的集合中的 Promise 返回了数据，才能将该 Promise 移到  <code>completedQueue</code>  队列中，由 Emitter 消费发往下游。只有队首集合空了，才能处理第二个集合。这样就保证了当且仅当某个 watermark 之前所有的消息都已经被发送了，该 watermark 才能被发送。过程如下图所示：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1TnrsRXXXXXaKaVXXXXXXXXXX\" alt=\"image\" /></p>\n<h3 id=\"快照与恢复\"><a class=\"anchor\" href=\"#快照与恢复\">#</a> 快照与恢复</h3>\n<p>分布式快照机制是为了保证状态的一致性。我们需要分析哪些状态是需要快照的，哪些是不需要的。首先，已经完成回调并且已经发往下游的元素是不需要快照的。否则，会导致重发，那就不是 exactly-once 了。而已经完成回调且未发往下游的元素，加上未完成回调的元素，就是上述队列中的所有元素。</p>\n<p>所以快照的逻辑也非常简单，(1) 清空原有的状态存储，(2) 遍历队列中的所有 Promise，从中取出  <code>StreamElement</code> （消息或 watermark）并放入状态存储中，(3) 执行快照操作。</p>\n<p>恢复的时候，从快照中读取所有的元素全部再处理一次，当然包括之前已完成回调的元素。所以在失败恢复后，会有元素重复请求外部服务，但是每个回调的结果只会被发往下游一次。</p>\n",
            "tags": [
                "大数据",
                "Flink"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E7%9A%84%E6%9E%B6%E6%9E%84/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E7%9A%84%E6%9E%B6%E6%9E%84/",
            "title": "Flink的架构",
            "date_published": "2023-11-04T16:00:00.000Z",
            "content_html": "<h2 id=\"架构\"><a class=\"anchor\" href=\"#架构\">#</a> 架构</h2>\n<p>要了解一个系统，一般都是从架构开始。我们关心的问题是：系统部署成功后各个节点都启动了哪些服务，各个服务之间又是怎么交互和协调的。下方是 Flink 集群启动后架构图。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1ObBnJFXXXXXtXVXXXXXXXXXX\" alt=\"image\" /></p>\n<p>当 Flink 集群启动后，首先会启动一个 JobManger 和一个或多个的 TaskManager。由 Client 提交任务给 JobManager，JobManager 再调度任务到各个 TaskManager 去执行，然后 TaskManager 将心跳和统计信息汇报给 JobManager。TaskManager 之间以流的形式进行数据的传输。上述三者均为独立的 JVM 进程。</p>\n<ul>\n<li><strong>Client</strong> 为提交 Job 的客户端，可以是运行在任何机器上（与 JobManager 环境连通即可）。提交 Job 后，Client 可以结束进程（Streaming 的任务），也可以不结束并等待结果返回。</li>\n<li><strong>JobManager</strong> 主要负责调度 Job 并协调 Task 做 checkpoint，职责上很像 Storm 的 Nimbus。从 Client 处接收到 Job 和 JAR 包等资源后，会生成优化后的执行计划，并以 Task 的单元调度到各个 TaskManager 去执行。</li>\n<li><strong>TaskManager</strong> 在启动的时候就设置好了槽位数（Slot），每个 slot 能启动一个 Task，Task 为线程。从 JobManager 处接收需要部署的 Task，部署启动后，与自己的上游建立 Netty 连接，接收数据并处理。</li>\n</ul>\n<p>可以看到 Flink 的任务调度是多线程模型，并且不同 Job/Task 混合在一个 TaskManager 进程中。虽然这种方式可以有效提高 CPU 利用率，但是个人不太喜欢这种设计，因为不仅缺乏资源隔离机制，同时也不方便调试。类似 Storm 的进程模型，一个 JVM 中只跑该 Job 的 Tasks 实际应用中更为合理。</p>\n<h2 id=\"job-例子\"><a class=\"anchor\" href=\"#job-例子\">#</a> Job 例子</h2>\n<blockquote>\n<p>本文所示例子为 flink-1.0.x 版本</p>\n</blockquote>\n<p>我们使用 Flink 自带的 examples 包中的  <code>SocketTextStreamWordCount</code> ，这是一个从 socket 流中统计单词出现次数的例子。</p>\n<ul>\n<li>\n<p>首先，使用 <strong>netcat</strong> 启动本地服务器：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">nc</span> -l <span class=\"token number\">9000</span></pre></td></tr></table></figure></li>\n<li>\n<p>然后提交 Flink 程序</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ bin/flink run examples/streaming/SocketTextStreamWordCount.jar <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  --hostname <span class=\"token number\">10.218</span>.130.9 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  --port <span class=\"token number\">9000</span></pre></td></tr></table></figure></li>\n</ul>\n<p>在 netcat 端输入单词并监控 taskmanager 的输出可以看到单词统计的结果。</p>\n<p><code>SocketTextStreamWordCount</code>  的具体代码如下：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// 检查输入</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">final</span> <span class=\"token class-name\">ParameterTool</span> params <span class=\"token operator\">=</span> <span class=\"token class-name\">ParameterTool</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromArgs</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// set up the execution environment</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">final</span> <span class=\"token class-name\">StreamExecutionEnvironment</span> env <span class=\"token operator\">=</span> <span class=\"token class-name\">StreamExecutionEnvironment</span><span class=\"token punctuation\">.</span><span class=\"token function\">getExecutionEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// get input data</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> text <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      env<span class=\"token punctuation\">.</span><span class=\"token function\">socketTextStream</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hostname\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">.</span><span class=\"token function\">getInt</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"port\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\n'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tuple2</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> counts <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token comment\">// split up the lines in pairs (2-tuples) containing: (word,1)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      text<span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Tokenizer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token comment\">// group by the tuple field \"0\" and sum up tuple field \"1\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          <span class=\"token punctuation\">.</span><span class=\"token function\">keyBy</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          <span class=\"token punctuation\">.</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  counts<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">// execute program</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  env<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WordCount from SocketTextStream Example\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>我们将最后一行代码  <code>env.execute</code>  替换成  <code>System.out.println(env.getExecutionPlan());</code>  并在本地运行该代码（并发度设为 2），可以得到该拓扑的逻辑执行计划图的 JSON 串，将该 JSON 串粘贴到 <span class=\"exturl\" data-url=\"aHR0cDovL2ZsaW5rLmFwYWNoZS5vcmcvdmlzdWFsaXplci8=\">http://flink.apache.org/visualizer/</span> 中，能可视化该执行图。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1vB1uJFXXXXbaXpXXXXXXXXXX\" alt=\"image\" /></p>\n<p>但这并不是最终在 Flink 中运行的执行图，只是一个表示拓扑节点关系的计划图，在 Flink 中对应了 SteramGraph。另外，提交拓扑后（并发度设为 2）还能在 UI 中看到另一张执行计划图，如下所示，该图对应了 Flink 中的 JobGraph。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1QKR2JFXXXXbyaXXXXXXXXXXX\" alt=\"image\" /></p>\n<h2 id=\"graph\"><a class=\"anchor\" href=\"#graph\">#</a> Graph</h2>\n<p>看起来有点乱，怎么有这么多不一样的图。实际上，还有更多的图。Flink 中的执行图可以分成四层：StreamGraph -&gt; JobGraph -&gt; ExecutionGraph -&gt; 物理执行图。</p>\n<ul>\n<li>**StreamGraph：** 是根据用户通过 Stream API 编写的代码生成的最初的图。用来表示程序的拓扑结构。</li>\n<li>**JobGraph：**StreamGraph 经过优化后生成了 JobGraph，提交给 JobManager 的数据结构。主要的优化为，将多个符合条件的节点 chain 在一起作为一个节点，这样可以减少数据在节点之间流动所需要的序列化 / 反序列化 / 传输消耗。</li>\n<li>**ExecutionGraph：**JobManager 根据 JobGraph 生成 ExecutionGraph。ExecutionGraph 是 JobGraph 的并行化版本，是调度层最核心的数据结构。</li>\n<li>** 物理执行图：**JobManager 根据 ExecutionGraph 对 Job 进行调度后，在各个 TaskManager 上部署 Task 后形成的 “图”，并不是一个具体的数据结构。</li>\n</ul>\n<p>例如上文中的 2 个并发度（Source 为 1 个并发度）的  <code>SocketTextStreamWordCount</code>  四层执行图的演变过程如下图所示（点击查看大图）：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1tA_GJFXXXXapXFXXXXXXXXXX\" alt=\"image\" /></p>\n<p>这里对一些名词进行简单的解释。</p>\n<ul>\n<li>\n<p>StreamGraph：</p>\n<p>根据用户通过 Stream API 编写的代码生成的最初的图。</p>\n<ul>\n<li>StreamNode：用来代表 operator 的类，并具有所有相关的属性，如并发度、入边和出边等。</li>\n<li>StreamEdge：表示连接两个 StreamNode 的边。</li>\n</ul>\n</li>\n<li>\n<p>JobGraph：</p>\n<p>StreamGraph 经过优化后生成了 JobGraph，提交给 JobManager 的数据结构。</p>\n<ul>\n<li>JobVertex：经过优化后符合条件的多个 StreamNode 可能会 chain 在一起生成一个 JobVertex，即一个 JobVertex 包含一个或多个 operator，JobVertex 的输入是 JobEdge，输出是 IntermediateDataSet。</li>\n<li>IntermediateDataSet：表示 JobVertex 的输出，即经过 operator 处理产生的数据集。producer 是 JobVertex，consumer 是 JobEdge。</li>\n<li>JobEdge：代表了 job graph 中的一条数据传输通道。source 是 IntermediateDataSet，target 是 JobVertex。即数据通过 JobEdge 由 IntermediateDataSet 传递给目标 JobVertex。</li>\n</ul>\n</li>\n<li>\n<p>ExecutionGraph：</p>\n<p>JobManager 根据 JobGraph 生成 ExecutionGraph。ExecutionGraph 是 JobGraph 的并行化版本，是调度层最核心的数据结构。</p>\n<ul>\n<li>ExecutionJobVertex：和 JobGraph 中的 JobVertex 一一对应。每一个 ExecutionJobVertex 都有和并发度一样多的 ExecutionVertex。</li>\n<li>ExecutionVertex：表示 ExecutionJobVertex 的其中一个并发子任务，输入是 ExecutionEdge，输出是 IntermediateResultPartition。</li>\n<li>IntermediateResult：和 JobGraph 中的 IntermediateDataSet 一一对应。一个 IntermediateResult 包含多个 IntermediateResultPartition，其个数等于该 operator 的并发度。</li>\n<li>IntermediateResultPartition：表示 ExecutionVertex 的一个输出分区，producer 是 ExecutionVertex，consumer 是若干个 ExecutionEdge。</li>\n<li>ExecutionEdge：表示 ExecutionVertex 的输入，source 是 IntermediateResultPartition，target 是 ExecutionVertex。source 和 target 都只能是一个。</li>\n<li>Execution：是执行一个 ExecutionVertex 的一次尝试。当发生故障或者数据需要重算的情况下 ExecutionVertex 可能会有多个 ExecutionAttemptID。一个 Execution 通过 ExecutionAttemptID 来唯一标识。JM 和 TM 之间关于 task 的部署和 task status 的更新都是通过 ExecutionAttemptID 来确定消息接受者。</li>\n</ul>\n</li>\n<li>\n<p>物理执行图：</p>\n<p>JobManager 根据 ExecutionGraph 对 Job 进行调度后，在各个 TaskManager 上部署 Task 后形成的 “图”，并不是一个具体的数据结构。</p>\n<ul>\n<li>Task：Execution 被调度后在分配的 TaskManager 中启动对应的 Task。Task 包裹了具有用户执行逻辑的 operator。</li>\n<li>ResultPartition：代表由一个 Task 的生成的数据，和 ExecutionGraph 中的 IntermediateResultPartition 一一对应。</li>\n<li>ResultSubpartition：是 ResultPartition 的一个子分区。每个 ResultPartition 包含多个 ResultSubpartition，其数目要由下游消费 Task 数和 DistributionPattern 来决定。</li>\n<li>InputGate：代表 Task 的输入封装，和 JobGraph 中 JobEdge 一一对应。每个 InputGate 消费了一个或多个的 ResultPartition。</li>\n<li>InputChannel：每个 InputGate 会包含一个以上的 InputChannel，和 ExecutionGraph 中的 ExecutionEdge 一一对应，也和 ResultSubpartition 一对一地相连，即一个 InputChannel 接收一个 ResultSubpartition 的输出。</li>\n</ul>\n</li>\n</ul>\n<p>那么 Flink 为什么要设计这 4 张图呢，其目的是什么呢？Spark 中也有多张图，数据依赖图以及物理执行的 DAG。其目的都是一样的，就是解耦，每张图各司其职，每张图对应了 Job 不同的阶段，更方便做该阶段的事情。我们给出更完整的 Flink Graph 的层次图。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1qmtpJVXXXXagXXXXXXXXXXXX\" alt=\"image\" /></p>\n<p>首先我们看到，JobGraph 之上除了 StreamGraph 还有 OptimizedPlan。OptimizedPlan 是由 Batch API 转换而来的。StreamGraph 是由 Stream API 转换而来的。为什么 API 不直接转换成 JobGraph？因为，Batch 和 Stream 的图结构和优化方法有很大的区别，比如 Batch 有很多执行前的预分析用来优化图的执行，而这种优化并不普适于 Stream，所以通过 OptimizedPlan 来做 Batch 的优化会更方便和清晰，也不会影响 Stream。JobGraph 的责任就是统一 Batch 和 Stream 的图，用来描述清楚一个拓扑图的结构，并且做了 chaining 的优化，chaining 是普适于 Batch 和 Stream 的，所以在这一层做掉。ExecutionGraph 的责任是方便调度和各个 tasks 状态的监控和跟踪，所以 ExecutionGraph 是并行化的 JobGraph。而 “物理执行图” 就是最终分布式在各个机器上运行着的 tasks 了。所以可以看到，这种解耦方式极大地方便了我们在各个层所做的工作，各个层之间是相互隔离的。</p>\n",
            "tags": [
                "大数据",
                "Flink"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E7%9A%84Window%E6%9C%BA%E5%88%B6/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/Flink%E7%9A%84Window%E6%9C%BA%E5%88%B6/",
            "title": "Flink的窗口机制",
            "date_published": "2023-10-16T16:00:00.000Z",
            "content_html": "<p>Flink 认为 Batch 是 Streaming 的一个特例，所以 Flink 底层引擎是一个流式引擎，在上面实现了流处理和批处理。而窗口（window）就是从 Streaming 到 Batch 的一个桥梁。Flink 提供了非常完善的窗口机制，这是 Flink 最大的亮点之一（其他的亮点包括消息乱序处理，和 checkpoint 机制）。这里介绍流式处理中的窗口概念，介绍 Flink 内建的一些窗口和 Window API，最后讨论下窗口在底层是如何实现的。</p>\n<h2 id=\"什么是-window\"><a class=\"anchor\" href=\"#什么是-window\">#</a> 什么是 Window</h2>\n<p>在流处理应用中，数据是连续不断的，因此我们不可能等到所有数据都到了才开始处理。当然我们可以每来一个消息就处理一次，但是有时我们需要做一些聚合类的处理，例如：在过去的 1 分钟内有多少用户点击了我们的网页。在这种情况下，我们必须定义一个窗口，用来收集最近一分钟内的数据，并对这个窗口内的数据进行计算。</p>\n<p>窗口可以是时间驱动的（Time Window，例如：每 30 秒钟），也可以是数据驱动的（Count Window，例如：每一百个元素）。一种经典的窗口分类可以分成：翻滚窗口（Tumbling Window，无重叠），滚动窗口（Sliding Window，有重叠），和会话窗口（Session Window，活动间隙）。</p>\n<p>我们举个具体的场景来形象地理解不同窗口的概念。假设，淘宝网会记录每个用户每次购买的商品个数，我们要做的是统计不同窗口中用户购买商品的总数。下图给出了几种经典的窗口切分概述图：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1bwsTJVXXXXaBaXXXXXXXXXXX\" alt=\"image\" /></p>\n<p>上图中，raw data stream 代表用户的购买行为流，圈中的数字代表该用户本次购买的商品个数，事件是按时间分布的，所以可以看出事件之间是有 time gap 的。Flink 提供了上图中所有的窗口类型，下面我们会逐一进行介绍。</p>\n<h3 id=\"time-window\"><a class=\"anchor\" href=\"#time-window\">#</a> Time Window</h3>\n<p>就如名字所说的，Time Window 是根据时间对数据流进行分组的。这里我们涉及到了流处理中的时间问题，时间问题和消息乱序问题是紧密关联的，这是流处理中现存的难题之一，这里我们只需要知道 Flink 提出了三种时间的概念，分别是 event time（事件时间：事件发生时的时间），ingestion time（摄取时间：事件进入流处理系统的时间），processing time（处理时间：消息被计算处理的时间）。Flink 中窗口机制和时间类型是完全解耦的，也就是说当需要改变时间类型时不需要更改窗口逻辑相关的代码。</p>\n<ul>\n<li>\n<p><strong>Tumbling Time Window</strong><br />\n 例如，我们需要统计每一分钟中用户购买的商品的总数，需要将用户的行为事件按每一分钟进行切分，这种切分被成为翻滚时间窗口（Tumbling Time Window）。翻滚窗口能将数据流切分成不重叠的窗口，每一个事件只能属于一个窗口。通过使用 DataStream API，我们可以这样实现：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Stream of (userId, buyCnt)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>val buyCnts<span class=\"token operator\">:</span> <span class=\"token class-name\">DataStream</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>val tumblingCnts<span class=\"token operator\">:</span> <span class=\"token class-name\">DataStream</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> buyCnts</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// key stream by userId</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">keyBy</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// tumbling time window of 1 minute length</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">timeWindow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Time</span><span class=\"token punctuation\">.</span><span class=\"token function\">minutes</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// compute sum over buyCnt</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>Sliding Time Window</strong><br />\n 但是对于某些应用，它们需要的窗口是不间断的，需要平滑地进行窗口聚合。比如，我们可以每 30 秒计算一次最近一分钟用户购买的商品总数。这种窗口我们称为滑动时间窗口（Sliding Time Window）。在滑窗中，一个元素可以对应多个窗口。通过使用 DataStream API，我们可以这样实现：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>val slidingCnts<span class=\"token operator\">:</span> <span class=\"token class-name\">DataStream</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> buyCnts</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">keyBy</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// sliding time window of 1 minute length and 30 secs trigger interval</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">timeWindow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Time</span><span class=\"token punctuation\">.</span><span class=\"token function\">minutes</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Time</span><span class=\"token punctuation\">.</span><span class=\"token function\">seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"count-window\"><a class=\"anchor\" href=\"#count-window\">#</a> Count Window</h3>\n<p>Count Window 是根据元素个数对数据流进行分组的。</p>\n<ul>\n<li>\n<p><strong>Tumbling Count Window</strong><br />\n 当我们想要每 100 个用户购买行为事件统计购买总数，那么每当窗口中填满 100 个元素了，就会对窗口进行计算，这种窗口我们称之为翻滚计数窗口（Tumbling Count Window），上图所示窗口大小为 3 个。通过使用 DataStream API，我们可以这样实现：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Stream of (userId, buyCnts)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>val buyCnts<span class=\"token operator\">:</span> <span class=\"token class-name\">DataStream</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>val tumblingCnts<span class=\"token operator\">:</span> <span class=\"token class-name\">DataStream</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> buyCnts</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// key stream by sensorId</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">keyBy</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// tumbling count window of 100 elements size</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">countWindow</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// compute the buyCnt sum </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure></li>\n<li>\n<p><strong>Sliding Count Window</strong><br />\n 当然 Count Window 也支持 Sliding Window，虽在上图中未描述出来，但和 Sliding Time Window 含义是类似的，例如计算每 10 个元素计算一次最近 100 个元素的总和，代码示例如下。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>val slidingCnts<span class=\"token operator\">:</span> <span class=\"token class-name\">DataStream</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> vehicleCnts</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">keyBy</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// sliding count window of 100 elements size and 10 elements trigger interval</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">countWindow</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"session-window\"><a class=\"anchor\" href=\"#session-window\">#</a> Session Window</h3>\n<p>在这种用户交互事件流中，我们首先想到的是将事件聚合到会话窗口中（一段用户持续活跃的周期），由非活跃的间隙分隔开。如上图所示，就是需要计算每个用户在活跃期间总共购买的商品数量，如果用户 30 秒没有活动则视为会话断开（假设 raw data stream 是单个用户的购买行为流）。Session Window 的示例代码如下：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Stream of (userId, buyCnts)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>val buyCnts<span class=\"token operator\">:</span> <span class=\"token class-name\">DataStream</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>val sessionCnts<span class=\"token operator\">:</span> <span class=\"token class-name\">DataStream</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> vehicleCnts</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">keyBy</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// session window based on a 30 seconds session gap interval </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">window</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProcessingTimeSessionWindows</span><span class=\"token punctuation\">.</span><span class=\"token function\">withGap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Time</span><span class=\"token punctuation\">.</span><span class=\"token function\">seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>一般而言，window 是在无限的流上定义了一个有限的元素集合。这个集合可以是基于时间的，元素个数的，时间和个数结合的，会话间隙的，或者是自定义的。Flink 的 DataStream API 提供了简洁的算子来满足常用的窗口操作，同时提供了通用的窗口机制来允许用户自己定义窗口分配逻辑。下面我们会对 Flink 窗口相关的 API 进行剖析。</p>\n<h2 id=\"剖析-window-api\"><a class=\"anchor\" href=\"#剖析-window-api\">#</a> 剖析 Window API</h2>\n<p>得益于 Flink Window API 松耦合设计，我们可以非常灵活地定义符合特定业务的窗口。Flink 中定义一个窗口主要需要以下三个组件。</p>\n<ul>\n<li>\n<p>**Window Assigner：** 用来决定某个元素被分配到哪个 / 哪些窗口中去。</p>\n<p>如下类图展示了目前内置实现的 Window Assigners：<br />\n<img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1plkxJVXXXXXqXpXXXXXXXXXX\" alt=\"image\" /></p>\n</li>\n<li>\n<p>**Trigger：** 触发器。决定了一个窗口何时能够被计算或清除，每个窗口都会拥有一个自己的 Trigger。</p>\n<p>如下类图展示了目前内置实现的 Triggers：<br />\n<img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB15yMeJVXXXXbbXFXXXXXXXXXX\" alt=\"img\" /></p>\n</li>\n<li>\n<p>**Evictor：** 可以译为 “驱逐者”。在 Trigger 触发之后，在窗口被处理之前，Evictor（如果有 Evictor 的话）会用来剔除窗口中不需要的元素，相当于一个 filter。</p>\n<p>如下类图展示了目前内置实现的 Evictors：<br />\n<img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1OCT6JVXXXXcjXVXXXXXXXXXX\" alt=\"img\" /></p>\n</li>\n</ul>\n<p>上述三个组件的不同实现的不同组合，可以定义出非常复杂的窗口。Flink 中内置的窗口也都是基于这三个组件构成的，当然内置窗口有时候无法解决用户特殊的需求，所以 Flink 也暴露了这些窗口机制的内部接口供用户实现自定义的窗口。下面我们将基于这三者探讨窗口的实现机制。</p>\n<h2 id=\"window-的实现\"><a class=\"anchor\" href=\"#window-的实现\">#</a> Window 的实现</h2>\n<p>下图描述了 Flink 的窗口机制以及各组件之间是如何相互工作的。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1swNgKXXXXXc4XpXXXXXXXXXX\" alt=\"image\" /></p>\n<p>首先上图中的组件都位于一个算子（window operator）中，数据流源源不断地进入算子，每一个到达的元素都会被交给 WindowAssigner。WindowAssigner 会决定元素被放到哪个或哪些窗口（window），可能会创建新窗口。因为一个元素可以被放入多个窗口中，所以同时存在多个窗口是可能的。注意， <code>Window</code>  本身只是一个 ID 标识符，其内部可能存储了一些元数据，如 <code>TimeWindow</code>  中有开始和结束时间，但是并不会存储窗口中的元素。窗口中的元素实际存储在 Key/Value State 中，key 为 <code>Window</code> ，value 为元素集合（或聚合值）。为了保证窗口的容错性，该实现依赖了 Flink 的 State 机制。</p>\n<p>每一个窗口都拥有一个属于自己的 Trigger，Trigger 上会有定时器，用来决定一个窗口何时能够被计算或清除。每当有元素加入到该窗口，或者之前注册的定时器超时了，那么 Trigger 都会被调用。Trigger 的返回结果可以是 continue（不做任何操作），fire（处理窗口数据），purge（移除窗口和窗口中的数据），或者 fire + purge。一个 Trigger 的调用结果只是 fire 的话，那么会计算窗口并保留窗口原样，也就是说窗口中的数据仍然保留不变，等待下次 Trigger fire 的时候再次执行计算。一个窗口可以被重复计算多次知道它被 purge 了。在 purge 之前，窗口会一直占用着内存。</p>\n<p>当 Trigger fire 了，窗口中的元素集合就会交给 <code>Evictor</code> （如果指定了的话）。Evictor 主要用来遍历窗口中的元素列表，并决定最先进入窗口的多少个元素需要被移除。剩余的元素会交给用户指定的函数进行窗口的计算。如果没有 Evictor 的话，窗口中的所有元素会一起交给函数进行计算。</p>\n<p>计算函数收到了窗口的元素（可能经过了 Evictor 的过滤），并计算出窗口的结果值，并发送给下游。窗口的结果值可以是一个也可以是多个。DataStream API 上可以接收不同类型的计算函数，包括预定义的 <code>sum()</code> , <code>min()</code> , <code>max()</code> ，还有  <code>ReduceFunction</code> ， <code>FoldFunction</code> ，还有 <code>WindowFunction</code> 。WindowFunction 是最通用的计算函数，其他的预定义的函数基本都是基于该函数实现的。</p>\n<p>Flink 对于一些聚合类的窗口计算（如 sum,min）做了优化，因为聚合类的计算不需要将窗口中的所有数据都保存下来，只需要保存一个 result 值就可以了。每个进入窗口的元素都会执行一次聚合函数并修改 result 值。这样可以大大降低内存的消耗并提升性能。但是如果用户定义了 Evictor，则不会启用对聚合窗口的优化，因为 Evictor 需要遍历窗口中的所有元素，必须要将窗口中所有元素都存下来。</p>\n<h2 id=\"源码分析\"><a class=\"anchor\" href=\"#源码分析\">#</a> 源码分析</h2>\n<p>上述的三个组件构成了 Flink 的窗口机制。为了更清楚地描述窗口机制，以及解开一些疑惑（比如 purge 和 Evictor 的区别和用途），我们将一步步地解释 Flink 内置的一些窗口（Time Window，Count Window，Session Window）是如何实现的。</p>\n<h3 id=\"count-window-实现\"><a class=\"anchor\" href=\"#count-window-实现\">#</a> Count Window 实现</h3>\n<p>Count Window 是使用三组件的典范，我们可以在  <code>KeyedStream</code>  上创建 Count Window，其源码如下所示：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// tumbling count window</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">WindowedStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> KEY<span class=\"token punctuation\">,</span> <span class=\"token class-name\">GlobalWindow</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">countWindow</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">window</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">GlobalWindows</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// create window stream using GlobalWindows</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token punctuation\">.</span><span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PurgingTrigger</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CountTrigger</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// trigger is window size</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// sliding count window</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">WindowedStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> KEY<span class=\"token punctuation\">,</span> <span class=\"token class-name\">GlobalWindow</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">countWindow</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> size<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> slide<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">window</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">GlobalWindows</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">evictor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CountEvictor</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// evictor is window size</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CountTrigger</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>slide<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// trigger is slide size</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>第一个函数是申请翻滚计数窗口，参数为窗口大小。第二个函数是申请滑动计数窗口，参数分别为窗口大小和滑动大小。它们都是基于  <code>GlobalWindows</code>  这个 WindowAssigner 来创建的窗口，该 assigner 会将所有元素都分配到同一个 global window 中，所有 <code>GlobalWindows</code>  的返回值一直是  <code>GlobalWindow</code>  单例。基本上自定义的窗口都会基于该 assigner 实现。</p>\n<p>翻滚计数窗口并不带 evictor，只注册了一个 trigger。该 trigger 是带 purge 功能的 CountTrigger。也就是说每当窗口中的元素数量达到了 window-size，trigger 就会返回 fire+purge，窗口就会执行计算并清空窗口中的所有元素，再接着储备新的元素。从而实现了 tumbling 的窗口之间无重叠。</p>\n<p>滑动计数窗口的各窗口之间是有重叠的，但我们用的 GlobalWindows assinger 从始至终只有一个窗口，不像 sliding time assigner 可以同时存在多个窗口。所以 trigger 结果不能带 purge，也就是说计算完窗口后窗口中的数据要保留下来（供下个滑窗使用）。另外，trigger 的间隔是 slide-size，evictor 的保留的元素个数是 window-size。也就是说，每个滑动间隔就触发一次窗口计算，并保留下最新进入窗口的 window-size 个元素，剔除旧元素。</p>\n<p>假设有一个滑动计数窗口，每 2 个元素计算一次最近 4 个元素的总和，那么窗口工作示意图如下所示：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB15vcUJVXXXXcGXVXXXXXXXXXX\" alt=\"img\" /></p>\n<p>图中所示的各个窗口逻辑上是不同的窗口，但在物理上是同一个窗口。该滑动计数窗口，trigger 的触发条件是元素个数达到 2 个（每进入\u00102 个元素就会触发一次），evictor 保留的元素个数是 4 个，每次计算完窗口总和后会保留剩余的元素。所以第一次触发 trigger 是当元素 5 进入，第三次触发 trigger 是当元素 2 进入，并驱逐 5 和 2，计算剩余的 4 个元素的总和（22）并发送出去，保留下 2,4,9,7 元素供下个逻辑窗口使用。</p>\n<h3 id=\"time-window-实现\"><a class=\"anchor\" href=\"#time-window-实现\">#</a> Time Window 实现</h3>\n<p>同样的，我们也可以在  <code>KeyedStream</code>  上申请 Time Window，其源码如下所示：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// tumbling time window</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">WindowedStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> KEY<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeWindow</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">timeWindow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Time</span> size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>environment<span class=\"token punctuation\">.</span><span class=\"token function\">getStreamTimeCharacteristic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">TimeCharacteristic<span class=\"token punctuation\">.</span>ProcessingTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">window</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TumblingProcessingTimeWindows</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">window</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TumblingEventTimeWindows</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// sliding time window</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">WindowedStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> KEY<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeWindow</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">timeWindow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Time</span> size<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Time</span> slide<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>environment<span class=\"token punctuation\">.</span><span class=\"token function\">getStreamTimeCharacteristic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">TimeCharacteristic<span class=\"token punctuation\">.</span>ProcessingTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">window</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SlidingProcessingTimeWindows</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">,</span> slide<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">window</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SlidingEventTimeWindows</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">,</span> slide<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在方法体内部会根据当前环境注册的时间类型，使用不同的 WindowAssigner 创建 window。可以看到，EventTime 和 IngestTime 都使用了 <code>XXXEventTimeWindows</code>  这个 assigner，因为 EventTime 和 IngestTime 在底层的实现上只是在 Source 处为 Record 打时间戳的实现不同，在 window operator 中的处理逻辑是一样的。</p>\n<p>这里我们主要分析 sliding process time window，如下是相关源码：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SlidingProcessingTimeWindows</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">WindowAssigner</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeWindow</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> serialVersionUID <span class=\"token operator\">=</span> <span class=\"token number\">1L</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> slide<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token class-name\">SlidingProcessingTimeWindows</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> size<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> slide<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>slide <span class=\"token operator\">=</span> slide<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TimeWindow</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">assignWindows</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> element<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> timestamp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    timestamp <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TimeWindow</span><span class=\"token punctuation\">></span></span> windows <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">/</span> slide<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// 对齐时间戳</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">long</span> lastStart <span class=\"token operator\">=</span> timestamp <span class=\"token operator\">-</span> timestamp <span class=\"token operator\">%</span> slide<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> lastStart<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      start <span class=\"token operator\">></span> timestamp <span class=\"token operator\">-</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      start <span class=\"token operator\">-=</span> slide<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token comment\">// 当前时间戳对应了多个 window</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      windows<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TimeWindow</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> start <span class=\"token operator\">+</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">return</span> windows<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProcessingTimeTrigger</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Trigger</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeWindow</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\">// 每个元素进入窗口都会调用该方法</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token class-name\">TriggerResult</span> <span class=\"token function\">onElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> element<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> timestamp<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeWindow</span> window<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TriggerContext</span> ctx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">// 注册定时器，当系统时间到达 window end timestamp 时会回调该 trigger 的 onProcessingTime 方法</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">registerProcessingTimeTimer</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span><span class=\"token function\">getEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token class-name\">TriggerResult</span><span class=\"token punctuation\">.</span>CONTINUE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token comment\">// 返回结果表示执行窗口计算并清空窗口</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token class-name\">TriggerResult</span> <span class=\"token function\">onProcessingTime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> time<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeWindow</span> window<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TriggerContext</span> ctx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token class-name\">TriggerResult</span><span class=\"token punctuation\">.</span>FIRE_AND_PURGE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>首先， <code>SlidingProcessingTimeWindows</code>  会对每个进入窗口的元素根据系统时间分配到 <code>(size / slide)</code>  个不同的窗口，并会在每个窗口上根据窗口结束时间注册一个定时器（相同窗口只会注册一份），当定时器超时时意味着该窗口完成了，这时会回调对应窗口的 Trigger 的 <code>onProcessingTime</code>  方法，返回 FIRE_AND_PURGE，也就是会执行窗口计算并清空窗口。整个过程示意图如下：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/TB1iihcKXXXXXavXFXXXXXXXXXX\" alt=\"img\" /></p>\n<p>如上图所示横轴代表时间戳（为简化问题，时间戳从 0 开始），第一条 record 会被分配到 [-5,5) 和 [0,10) 两个窗口中，当系统时间到 5 时，就会计算 [-5,5) 窗口中的数据，并将结果发送出去，最后清空窗口中的数据，释放该窗口资源。</p>\n<h3 id=\"session-window-实现\"><a class=\"anchor\" href=\"#session-window-实现\">#</a> Session Window 实现</h3>\n<p>Session Window 是一个需求很强烈的窗口机制，但 Session 也比之前的 Window 更复杂。</p>\n",
            "tags": [
                "大数据",
                "Flink"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4OneData/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4OneData/",
            "title": "阿里巴巴OneData",
            "date_published": "2023-04-10T16:00:00.000Z",
            "content_html": "<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/dda2d3d79eb57aabacc7b692af814867.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/ac1c20a73f5a765a757ba75844a2ab85.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/48c4f82a595acefb21da2115a513af94.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/f7fb9c903ae7bfa26830987335f3b1f6.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/a2271252de31b7c34811b0e54b33456b.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/c69dfefac662220b2e3a846db3a87cde.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/173e6ecbe9caf153873041dea0344207.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/8fb09962709d475d86273622fdfe96c5.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/e2644fbd9fc525303d16537beb312fee.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/4a71c3ae770f99b5630ac72442773d01.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/e0367763c656a4fa86ba7c0326bebdd5.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/a66faf3fd04e86aa5261df7d74be0be1.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/33dd22ace0a8ffc5369c801856a00301.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/c67e693aa46af5fc7634a63c0587a9dc.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/34208b736a49e265b9fe37272ed5e520.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/8a503bdd234aeb54115027d86f757588.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/77298d29b6ba0751ee8e91098eee3e5c.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/6a8a1faa71ad1c5c20b31e6257692cb5.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/2e8568556628b529b8c777969406dc21.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/b87731efe6d450fd7c08ef01339d55cd.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/7892fde6a24db0ccb33eb941fa6ff695.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/754dd47e8f284997ba25aa09e57e6a7f.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/6fc14aa234e6714b1cfd2d055de7eb34.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/38ba250797076a7ef006840c73f3373b.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/c7f15a84ab90e8fb017d083a400077eb.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/ca6be504aea76d94f33fb565c484bfad.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/5758a0f0e76be9d81885a57a5324150c.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/2edf5de3fe7e356c62bfdf042c4dfa49.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/25e1da501ab7fa717ba91213becbfff2.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/bcb87740c9f22851f4c51971bd51ec71.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/98731c7977d0bee5470aefe4714613c3.png\" alt=\"img\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/a47c7f4d759b88b2238193fc2af742b3.png\" alt=\"img\" /></p>\n",
            "tags": [
                "大数据",
                "大厂学习"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/hive/HQL%E4%B8%8A%E7%BA%BF%E4%BA%BA%E6%95%B0/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/hive/HQL%E4%B8%8A%E7%BA%BF%E4%BA%BA%E6%95%B0/",
            "title": "HQL之同时在线人数",
            "date_published": "2022-11-10T16:00:00.000Z",
            "content_html": "<h2 id=\"1-计算平台同时在线的主播人数最大值为多少以及出现高峰期的时间段\"><a class=\"anchor\" href=\"#1-计算平台同时在线的主播人数最大值为多少以及出现高峰期的时间段\">#</a> 1. 计算平台同时在线的主播人数最大值为多少，以及出现高峰期的时间段</h2>\n<h3 id=\"主播表\"><a class=\"anchor\" href=\"#主播表\">#</a> 主播表</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> zhubo</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    id  <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    stt string<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    edt string</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"数据\"><a class=\"anchor\" href=\"#数据\">#</a> 数据</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">insert</span> overwrite <span class=\"token keyword\">table</span> zhubo <span class=\"token keyword\">VALUES</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1001</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 12:12:12'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 20:12:12'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1002</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 12:13:12'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 19:12:12'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1003</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 13:12:12'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 19:50:12'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1004</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 13:15:12'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 18:12:12'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1005</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 14:12:12'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 19:12:15'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1006</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 14:16:12'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 20:12:23'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1003</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 20:12:12'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 23:12:12'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1001</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 21:12:12'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2021-09-04 22:12:12'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol>\n<li>把时间段转成时间点，模拟流式数据，标记位上线 + 1，下线 - 1</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> stt dt<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> flag</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> zhubo</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> edt dt<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> flag</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> zhubo<span class=\"token punctuation\">;</span> t1</pre></td></tr></table></figure><ol start=\"2\">\n<li>统计每个时间点的在线人数</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>       dt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>       <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> dt<span class=\"token punctuation\">)</span> people</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> stt dt<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> flag</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token keyword\">from</span> zhubo</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> edt dt<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> flag</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token keyword\">from</span> zhubo<span class=\"token punctuation\">)</span> t1<span class=\"token punctuation\">;</span> t2</pre></td></tr></table></figure><ol start=\"3\">\n<li>按照 时间流将下一个时间点移至当前行</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> dt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>       people<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>       lead<span class=\"token punctuation\">(</span>dt<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> dt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> dt<span class=\"token punctuation\">,</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> dt<span class=\"token punctuation\">)</span> people</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> stt dt<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> flag</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">from</span> zhubo</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> edt dt<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> flag</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">from</span> zhubo<span class=\"token punctuation\">)</span> t1<span class=\"token punctuation\">)</span> t2<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li>求最大在线人数</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>people<span class=\"token punctuation\">)</span> max_p</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> dt<span class=\"token punctuation\">,</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> dt<span class=\"token punctuation\">)</span> people</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> stt dt<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> flag</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">from</span> zhubo</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> edt dt<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> flag</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">from</span> zhubo<span class=\"token punctuation\">)</span> t1<span class=\"token punctuation\">)</span> t2<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li>最后将 3、4 做 join</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>同时在线人数的表多次被使用</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">with</span> t <span class=\"token keyword\">as</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>           dt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>           <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> dt<span class=\"token punctuation\">)</span> people</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> stt dt<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> flag</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>          <span class=\"token keyword\">from</span> zhubo</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>          <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> edt dt<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> flag</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          <span class=\"token keyword\">from</span> zhubo<span class=\"token punctuation\">)</span> t1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">select</span> dt<span class=\"token punctuation\">,</span> people<span class=\"token punctuation\">,</span> dtt</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>         <span class=\"token keyword\">select</span> dt<span class=\"token punctuation\">,</span> people<span class=\"token punctuation\">,</span> lead<span class=\"token punctuation\">(</span>dt<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> dt<span class=\"token punctuation\">)</span> dtt</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>         <span class=\"token keyword\">from</span> t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>     <span class=\"token punctuation\">)</span> t1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>         <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>people<span class=\"token punctuation\">)</span> max_p</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">from</span> t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">)</span> t2 <span class=\"token keyword\">on</span> t1<span class=\"token punctuation\">.</span>people <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>max_p</pre></td></tr></table></figure>",
            "tags": [
                "大数据",
                "Hive"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/pgsql/Postgresql%E5%AD%A6%E4%B9%A0/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/pgsql/Postgresql%E5%AD%A6%E4%B9%A0/",
            "title": "PgSql学习",
            "date_published": "2022-10-25T16:00:00.000Z",
            "content_html": "<h1 id=\"postgresql\"><a class=\"anchor\" href=\"#postgresql\">#</a> Postgresql</h1>\n<h2 id=\"表的继承\"><a class=\"anchor\" href=\"#表的继承\">#</a> 表的继承</h2>\n<h3 id=\"1继承\"><a class=\"anchor\" href=\"#1继承\">#</a> 1. 继承</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>第一张表</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> cities（<span class=\"token comment\">-- 父表</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tname <span class=\"token keyword\">text</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tpopulation <span class=\"token keyword\">float</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\taltitude <span class=\"token keyword\">int</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>第二张表</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> capital<span class=\"token punctuation\">(</span><span class=\"token comment\">-- 子表</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tstate <span class=\"token keyword\">char</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span>inherits<span class=\"token punctuation\">(</span>cities<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>插入数据</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> cities <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Las Vegas'</span><span class=\"token punctuation\">,</span><span class=\"token number\">1.53</span><span class=\"token punctuation\">,</span><span class=\"token number\">2174</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> cities <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Marposa'</span><span class=\"token punctuation\">,</span><span class=\"token number\">3.30</span><span class=\"token punctuation\">,</span><span class=\"token number\">1953</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> capital <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Madison'</span><span class=\"token punctuation\">,</span><span class=\"token number\">4.34</span><span class=\"token punctuation\">,</span><span class=\"token number\">845</span><span class=\"token punctuation\">,</span><span class=\"token string\">'WI'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>从父表中查询所有数据<span class=\"token punctuation\">,</span>结果集包括父子表中所有数据<span class=\"token punctuation\">,</span>如果只想查询父表中数据需要在表名前加上only关键字</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>从子表中查询所有数据<span class=\"token punctuation\">,</span>结果集只有子表中数据</pre></td></tr></table></figure><p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/3nTGt4WDrFHSg1L.png\" alt=\"\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/CF6GOiz48c32hMv.png\" alt=\"image\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/Dquv6y3h1IzkGj5.png\" alt=\"image-20211026132512191\" /></p>\n<h3 id=\"2确定数据来源\"><a class=\"anchor\" href=\"#2确定数据来源\">#</a> 2. 确定数据来源</h3>\n<p>在所有的表中国都有隐含字段 tableoid, 通过这个可以知道表的来源</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/5oUlepvZGHPn9dM.png\" alt=\"image-20211026132736807\" /></p>\n<p>如果需要看实际的表名需要和系统表 pg_class 进行关联，通过 tableoid 获取表名</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/vglyJRVrBOA2hLG.png\" alt=\"image-20211026141018363\" /></p>\n<h3 id=\"3数据插入注意事项\"><a class=\"anchor\" href=\"#3数据插入注意事项\">#</a> 3. 数据插入注意事项</h3>\n<p>继承不会自动从 insert 或者 copy 中想继承级中的表填充数据。以下的 insert 语句不会成功:</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/image-20211026142710675.png\" alt=\"image-20211026142710675\" /></p>\n<h3 id=\"4多表继承\"><a class=\"anchor\" href=\"#4多表继承\">#</a> 4. 多表继承</h3>\n<p>一个表可以从多个父表继承，这种情况下子表拥有父表们的所有数据，其中包括父表的所有字段和子表的字段。如果同一字段名出现在多个父表中，或者同时出现在父表和子表中，那么这些字段就会被合并，这样只会有一个同名字段，合并的前提是数据类型相同，否则会抛出异常。被合并的字段会拥有它继承的所有约束.</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/image-20211026143206169.png\" alt=\"image-20211026143206169\" /></p>\n<h2 id=\"表的分区\"><a class=\"anchor\" href=\"#表的分区\">#</a> 表的分区</h2>\n<h3 id=\"1分区的概念\"><a class=\"anchor\" href=\"#1分区的概念\">#</a> 1. 分区的概念</h3>\n<p>把逻辑上的一个大表分割成物理是哪个的大块，分区的优点是:</p>\n<ol>\n<li>某些类型的查询性能得到极大的提升.</li>\n<li>更新的性能也可以得到提升，以为表的每块的索引要比在数据集的索引要小。如果索引不能全部都在内存中，那么索引上的读和写都会产生更多的磁盘访问.</li>\n<li>批量删除可以用删除某个分区来实现.</li>\n<li>将冷数据存放到便宜，存储性能低的介质上</li>\n</ol>\n",
            "tags": [
                "大数据",
                "PostgreSQL"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E8%85%BE%E8%AE%AF%20ClickHouse%20%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E8%85%BE%E8%AE%AF%20ClickHouse%20%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5/",
            "title": "腾讯 ClickHouse 应用实践",
            "date_published": "2022-06-07T16:00:00.000Z",
            "content_html": "<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2Zmlib2RUeFg2eFVlQXNwTXlrY2ljbDNzdmhrbjVRRWlhV2xhaDZjRkNpYkRvWFFtZXVpYjJDRHE0SkRWdy82NDA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliYU5jY0VLVUN4UzhDcGNZZEExUWxtejVYRlBOTGVmS2hKVlRWNTFHUUJ1QXpoeDh0d2EybVRnLzY0MA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliTUFjeXJGSzFZdzVpYnB6RUJZaWFLVEE2TWZ3ZGliSVM4bEQzVkp0amtmQXhsSnF0cGliNmtKR0V5Zy82NDA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliajZpYWZNZGljZFI5djdMUFZxclVBNnVYaWNteWlhNVBQdkVYY0xBVGhLU3ZKd0Vnbk9CM2c1Z3JJUS82NDA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliSnVUR2ZPdzh3TmRxcFpxVzhVVERsdW9JN3NHR2hmaWJKc1F2QWRpYTJjMnJIeFJxejU3SWVSVmcvNjQw\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmlidXZiRWxpYWI1TUtpY1VraWMySFU5ZFhhS1NGaGNadEUwYVNYSlZpYldoc29BV2liWnA1YWdHNE1KcFEvNjQw\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliTWliaE9EYnpJdmhOaWFwNGJaenV1QVpiSFNTaWFBOUYxamZMWHhrdzlJdGwzTk1JMmVYWEY1VDJRLzY0MA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliT0J3T1RjNFlyVzdtSFRoN2JXRkhyaWE1WFBxOHBBTU9kSzdkRFBIV2dVaWNpYWRKcWpScGlhcXBkUS82NDA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliN01MSzEzSmw4ZDAyZ1ExaFBvdnY1bnBmdDk1QTQzakNqalV6MTJnZmxTbVhBcGljYWhhTW9MQS82NDA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliVWZPRWV6bWxDZGcxbW5ia3EybkZoTFpNbDVZalF6djBpYVhpYW9Rb2NrMlB2bjhQMlg2bDRGZmcvNjQw\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliQ002aHJ0Q1RCV1JqclZ2ZWNuNHNoeFkwNWdoT2xpY3J4UVB2SDlSSER5VnNMNEtwZm9mZkh1QS82NDA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2Zmlic2VpYVB5azRJTFZTUkhmamRrekRBRmJ1OGppYkdOWTJpYzFjdzJuTmFWQlJpYXhWTEZLc0EweWZhUS82NDA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliT2pqRXJRcTlOVWljVXEzTUhpYzlGbXZrSWdFV0RKVkRlZFNzYVdPcEhUNmt3WDBXakNac0pvVWcvNjQw\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmlicllVTEhabHE1SEx3Z2cyNjJYMzM3UTM0b01tT1poNkRqcmlid082WmFLY2Z2c0pVOFM3YTc2Zy82NDA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliRGliSlhDaWNOdW1tVVVBQzEwdHM4RlhST0pVdVhrSGljbVkwWXZtWDVkUTRDZ3VRTkVKNHpvaFhnLzY0MA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliNDhGVEpCZXFrVzFTOXBDM281RkVZNFhsUkdpYm0yWXlsUk1nbHNrRnozaWFaZGliYloyUG9URFFBLzY0MA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmlidFhoN2RjS3ROdE5UZ0Y3bVZERlJmRG1pYzdLbnpaS0JoV1ljU2liTndMRUdqaWFqTllKUjNQcWVnLzY0MA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2Zmlic3hNNEdBUzFCVjRHYUZSbFVlZWhRM0Vjd1RpYlNLQlA5elhPU1RXcTFrNlFUaWFGM25xTzNQdlEvNjQw\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliZjVhM2o2UHcwVVdJQTlza1NKT3Bua3hlZWljV3JyMW9ydlF3QUV5RlFzbHBJaWFwT0RWNzJnNncvNjQw\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2Zmlicno1UmlhY1RRNWVBY0lHaElmWXVJUllkVEkwSHhCUHRGaWFEeEdOY21SU3VmcDRXd0lXaWF3M2ZBLzY0MA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliTUpFVGg0anFudFRmeHNLdXUycDl2TEx6Sm9OYWQwRWtyd3loQjVNMGhsNVRsMHBHckRRV2xRLzY0MA\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliSWRLeVhWWWd2aDNURnppYlVzVEdUNjY0UGpNbzFWNWV6aWM2dGppYWhDWmpHNWJZRmJ0SDNpY2liZ1EvNjQw\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliV0pZaWJBaWJUMUJnT0M2VXZiUzZDSEhEMGJVNDNKTTNxRG45QXVtNENadzk0YlN0c0tvOXBxdGcvNjQw\" alt=\"img\" /><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy8xZmxIT0hadzZSdUI1eDhXVURXbGljc3ZrdnZzNXQ2ZmliVzhIVmdNRnlJMFY5aWNMaWF4ZjY2UDE3bzdpYzRXb2tCZmNCY0Z2a2E4T1VFaWFwY0hXd3g5V3VlZy82NDA\" alt=\"img\" /></p>\n",
            "tags": [
                "大数据",
                "大厂学习"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/hive/HQL%E7%BB%83%E4%B9%A0%E9%A2%98/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/hive/HQL%E7%BB%83%E4%B9%A0%E9%A2%98/",
            "title": "HQL练习题",
            "date_published": "2022-04-09T16:00:00.000Z",
            "content_html": "<p>本文通过简单易懂的业务场景，旨在提高大家的 SQL 水平。把文中所有的 SQL 全理解了，工作中遇到的各种 SQL 场景和面试中遇到的各种 SQL 问题都能灵活应对。文中所有的 SQL 都支持 Hive 语法，学会了 Hive 的 SQL，那么 MySQL 的 SQL 题也都可以 cover 住，下面的题目难度从简单到困难的都有。笔者在之前练习 SQL 过程中，发现了网上一些比较好的 SQL 题目，但是苦于好多博客提供的 SQL 可读性、规范性、执行效率并不高，因此才有了今天这篇博文，后续如果发现有可优化的的 SQL，笔者会持续更新本博文。</p>\n<h2 id=\"数据表介绍\"><a class=\"anchor\" href=\"#数据表介绍\">#</a> 数据表介绍</h2>\n<h3 id=\"学生表\"><a class=\"anchor\" href=\"#学生表\">#</a> 学生表</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> study<span class=\"token punctuation\">.</span>student</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    student_id string <span class=\"token punctuation\">,</span><span class=\"token comment\">-- 学生编号</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    name       string <span class=\"token punctuation\">,</span><span class=\"token comment\">-- 学生姓名</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    birthday   string <span class=\"token punctuation\">,</span><span class=\"token comment\">-- 学生生日</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    sex        string <span class=\"token comment\">-- 学生性别</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"教师表\"><a class=\"anchor\" href=\"#教师表\">#</a> 教师表</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> study<span class=\"token punctuation\">.</span>teacher</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    teacher_id string <span class=\"token punctuation\">,</span><span class=\"token comment\">-- 教师编号</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    name       string <span class=\"token comment\">-- 教师姓名</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"课程表\"><a class=\"anchor\" href=\"#课程表\">#</a> 课程表</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> study<span class=\"token punctuation\">.</span>course</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    course_id  string <span class=\"token punctuation\">,</span><span class=\"token comment\">-- 课程编号</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    name       string <span class=\"token punctuation\">,</span><span class=\"token comment\">-- 课程名</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    teacher_id string <span class=\"token comment\">-- 课程对应的教师编号</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"成绩表\"><a class=\"anchor\" href=\"#成绩表\">#</a> 成绩表</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> study<span class=\"token punctuation\">.</span>score</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    student_id string <span class=\"token punctuation\">,</span><span class=\"token comment\">-- 学生编号</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    course_id  string <span class=\"token punctuation\">,</span><span class=\"token comment\">-- 课程编号</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    score      <span class=\"token keyword\">int</span>    <span class=\"token comment\">-- 对应的成绩</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"答题时请注意\"><a class=\"anchor\" href=\"#答题时请注意\">#</a> 答题时请注意：</h3>\n<ul>\n<li>这里认为课程可能是选修课，学生不一定学了所有课程</li>\n<li>成绩表里的课程都应该在课程表里存在，而且每门课程都应该有对应的教师，且在教师表里可以找到</li>\n<li>成绩表里的学生也应该在学生表里存在</li>\n<li>下面的导入数据也是随机写的，读者也可以自己随机制造生成数据导入</li>\n</ul>\n<h3 id=\"导入数据\"><a class=\"anchor\" href=\"#导入数据\">#</a> 导入数据</h3>\n<h3 id=\"学生表-2\"><a class=\"anchor\" href=\"#学生表-2\">#</a> 学生表</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">insert</span> overwrite <span class=\"token keyword\">table</span> study<span class=\"token punctuation\">.</span>student <span class=\"token keyword\">VALUES</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'赵雷'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'1990-01-01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'男'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'钱电'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'1990-12-21'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'男'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'孙风'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'1990-12-20'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'男'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'04'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'李云'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'1990-12-06'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'男'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'05'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'周梅'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'1991-12-01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'女'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'06'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'吴兰'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'1992-01-01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'女'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'07'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'郑竹'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'1989-01-01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'女'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'09'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'张三'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'2017-12-20'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'女'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'10'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'李四'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'2017-12-25'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'女'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'11'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'李四'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'2012-06-06'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'女'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'12'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'赵六'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'2013-06-13'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'女'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'13'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'孙七'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'2014-06-01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'女'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"教师表-2\"><a class=\"anchor\" href=\"#教师表-2\">#</a> 教师表</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">insert</span> overwrite <span class=\"token keyword\">table</span> study<span class=\"token punctuation\">.</span>teacher <span class=\"token keyword\">VALUES</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'张三'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'李四'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'王五'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"课程表-2\"><a class=\"anchor\" href=\"#课程表-2\">#</a> 课程表</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">insert</span> overwrite <span class=\"token keyword\">table</span> study<span class=\"token punctuation\">.</span>course <span class=\"token keyword\">VALUES</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'语文'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'02'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'数学'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'英语'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'03'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"成绩表-2\"><a class=\"anchor\" href=\"#成绩表-2\">#</a> 成绩表</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">insert</span> overwrite <span class=\"token keyword\">table</span> study<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">VALUES</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">90</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">99</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">70</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'04'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'04'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'04'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'05'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">76</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'05'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">87</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'06'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'01'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'06'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">34</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'07'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'02'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">89</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token string\">'07'</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">'03'</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">98</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"练习题\"><a class=\"anchor\" href=\"#练习题\">#</a> 练习题</h2>\n<ol>\n<li>查询所有教师的全部信息（教师编号和姓名）</li>\n<li>输出所有学生中男生的全部信息</li>\n<li>查询所有学生中男生的全部信息，按照生日排降序</li>\n<li>查询所有学生的全部信息，先按照性别排序，再按照生日排降序</li>\n<li>求出学生总数</li>\n<li>查询学生中男生、女生人数</li>\n<li>参加考试的学生中，查出每个学生的学生编号、选了几门课</li>\n<li>检索至少选修三门课程的学生学号</li>\n<li>查询存在不及格的课程编号</li>\n<li>输出所有课程的课程编号、课程名、对应的教师姓名</li>\n<li>求每门课程的学生人数及平均分，输出课程编号、对应学生人数、平均分</li>\n<li>求每门课程的学生人数及平均分，输出课程名称、对应学生人数、平均分</li>\n<li>查询同时学习 &quot;01&quot; 课程和 &quot;02&quot; 课程的学生编号及 01 和 02 课程分数</li>\n<li>查询 &quot;01&quot; 课程比 &quot;02&quot; 课程成绩高的学生编号及 01 和 02 课程分数</li>\n<li>查询 &quot;01&quot; 课程比 &quot;02&quot; 课程成绩高的学生姓名及 01 和 02 课程分数</li>\n<li>查询选择了 &quot;01&quot; 课程但没选择 &quot;02&quot; 课程的学生姓名</li>\n<li>查询学过 ' 张三 ' 老师课程的所有同学姓名、生日、性别</li>\n<li>查询同时学习 &quot;01&quot;、&quot;02&quot; 课程学生的学生编号以及 &quot;01&quot; 和 &quot;02&quot; 课程成绩</li>\n<li>查询学习 &quot;01&quot; 课程但没有学习 &quot;02&quot; 课程学生的学生编号以及 &quot;01&quot; 课程成绩</li>\n<li>查询学习 &quot;02&quot; 课程但没有学习 &quot;01&quot; 课程学生的学生编号以及 &quot;02&quot; 课程成绩</li>\n<li>查询选课的同学的学生姓名、选课总数、所有课程的成绩总和、课程平均分</li>\n<li>查询考试平均分大于 60 分同学的学生姓名、选课总数、所有课程的成绩总和、课程平均分，按照科目数排降序、科目数相同按照分数排降序</li>\n<li>检索 &quot;01&quot; 课程分数小于 60 分的学生信息及 &quot;01&quot; 课程分数，按照分数排降序</li>\n<li>查询两门及其以上不及格课程的同学的姓名及其平均成绩</li>\n<li>查询没有学全所有课程的同学的编号 （包含无选课的同学）</li>\n<li>查询 1990 年出生的学生名单</li>\n<li>查询名字中含有「风」字的学生信息</li>\n<li>查询「李」姓老师的数量</li>\n<li>查询至少有两门课与学号为 &quot;01&quot; 的学生所学相同的学生 id</li>\n<li>查询选修了全部课程的学生 id 的姓名和姓名</li>\n<li>查询和 &quot;01&quot; 号的同学学习的课程完全相同的其他同学的学生 id</li>\n<li>统计各科成绩各分数段人数：课程编号，课程名称，[100-85]，[85-70]，[70-60]，[60-0] 及所占百分比</li>\n<li>查询学生的总成绩，并进行排名</li>\n<li>查询各科成绩前三名的记录</li>\n<li>查询出只选修两门课程的学生学号和姓名</li>\n<li>查询每门课程的平均成绩，结果按平均成绩降序排列，平均成绩相同时，按课程编号升序排列</li>\n<li>查询平均成绩大于等于 85 的所有学生的学号、姓名和平均成绩</li>\n<li>查询课程名称为「数学」，且分数低于 60 的学生姓名和分数</li>\n<li>查询课程编号为 01 且课程成绩在 80 分及以上的学生的学号和姓名</li>\n<li>查询选修「张三」老师所授课程的学生中，成绩最高的学生编号、课程编号及其成绩</li>\n<li>统计每门课程的学生选修人数（超过 5 人的课程才统计）。</li>\n<li>查询该学生有不同课程但成绩相同的学生编号、课程编号、学生成绩</li>\n</ol>\n<h2 id=\"答案请先独立思考后再参考答案\"><a class=\"anchor\" href=\"#答案请先独立思考后再参考答案\">#</a> 答案（请先独立思考后，再参考答案）</h2>\n<ol>\n<li>查询所有教师的全部信息（教师编号和姓名）</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> teacher<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>输出所有学生中男生的全部信息</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> student</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> sex <span class=\"token operator\">=</span> <span class=\"token string\">'男'</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>查询所有学生中男生的全部信息，按照生日排降序</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> student</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> sex<span class=\"token operator\">=</span><span class=\"token string\">'男'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> birthday <span class=\"token keyword\">desc</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li>查询所有学生的全部信息，先按照性别排序，再按照生日排降序</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> student</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> sex<span class=\"token punctuation\">,</span>birthday <span class=\"token keyword\">desc</span> <span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li>求出学生总数</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> student<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>查询学生中男生、女生人数</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> sex<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> student</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> sex<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"7\">\n<li>参加考试的学生中，查出每个学生的学生编号、选了几门课</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>course_id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> student_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"8\">\n<li>检索至少选修三门课程的学生学号</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>course_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> course_ct</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> student_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> course_ct <span class=\"token operator\">>=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"9\">\n<li>查询存在不及格的课程编号</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> 写法一</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> course_id<span class=\"token punctuation\">,</span> score</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span> score <span class=\"token operator\">&lt;</span> <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2.</span> 写法二</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">select</span> course_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> score<span class=\"token operator\">&lt;</span><span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> course_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"10\">\n<li>输出所有课程的课程编号、课程名、对应的教师姓名</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> 写法一</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> c<span class=\"token punctuation\">.</span>course_id<span class=\"token punctuation\">,</span>c<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">.</span>name</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>course c <span class=\"token keyword\">join</span> teacher t <span class=\"token keyword\">on</span> c<span class=\"token punctuation\">.</span>teacher_id <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>teacher_id<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2.</span> 写法二</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">select</span> course_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> course_name<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> teacher_name</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> course_id<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> teacher_id <span class=\"token keyword\">from</span> study<span class=\"token punctuation\">.</span>course<span class=\"token punctuation\">)</span> a <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">select</span> teacher_id<span class=\"token punctuation\">,</span> name</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">from</span> study<span class=\"token punctuation\">.</span>teacher <span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>teacher_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>teacher_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"11\">\n<li>求每门课程的学生人数及平均分，输出课程编号、对应学生人数、平均分</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> course_id<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span>student_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> course_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"12\">\n<li>求每门课程的学生人数及平均分，输出课程名称、对应学生人数、平均分</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> c<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>student_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> course c <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> score s <span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>course_id</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> c<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"13\">\n<li>查询同时学习 &quot;01&quot; 课程和 &quot;02&quot; 课程的学生编号及 01 和 02 课程分数</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> 写法一</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> s1<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span>s1<span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">,</span>s2<span class=\"token punctuation\">.</span>score</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> score s1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>         <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> score s2 <span class=\"token keyword\">on</span> s1<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> s2<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> s1<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span> <span class=\"token operator\">and</span> s2<span class=\"token punctuation\">.</span>course_id<span class=\"token operator\">=</span> <span class=\"token string\">'02'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">2.</span> 写法二</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">as</span> score_01<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">as</span> score_02</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>         <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'02'</span><span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>              <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"14\">\n<li>查询 &quot;01&quot; 课程比 &quot;02&quot; 课程成绩高的学生编号及 01 和 02 课程分数</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> 写法一</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> s1<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> s1<span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">,</span> s2<span class=\"token punctuation\">.</span>score</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> score s1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>         <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> score s2 <span class=\"token keyword\">on</span> s1<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> s2<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> s1<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token operator\">and</span> s2<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span> <span class=\"token string\">'02'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token operator\">and</span> s1<span class=\"token punctuation\">.</span>score <span class=\"token operator\">></span> s2<span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">2.</span> 写法二</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">as</span> score_01<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">as</span> score_02</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>         <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'02'</span><span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">where</span> a<span class=\"token punctuation\">.</span>score <span class=\"token operator\">></span> b<span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"15\">\n<li>查询 &quot;01&quot; 课程比 &quot;02&quot; 课程成绩高的学生姓名及 01 和 02 课程分数</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">as</span> score_01<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">as</span> score_02</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'02'</span><span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>         <span class=\"token keyword\">join</span> student s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>              <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span> a<span class=\"token punctuation\">.</span>score <span class=\"token operator\">></span> b<span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"16\">\n<li>连续三道题都是有关联的，前两道题给这道题做铺垫，所以当我们拿到一个向这种比较复杂的需求时，可以进行拆分需求，先拆分成 1、在做 2，最后达到完整的需求 ------ 查询选择了 &quot;01&quot; 课程但没选择 &quot;02&quot; 课程的学生姓名</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> 找出选择了 <span class=\"token string\">\"01\"</span>课程但没选择 <span class=\"token string\">\"02\"</span>课程的学生编号</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>         <span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'02'</span><span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                         <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">where</span> b<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">2.</span> 拿着学生编号关联学生表找到姓名</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">select</span> name</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token keyword\">as</span> student_id</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>               <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'02'</span><span class=\"token punctuation\">)</span> b <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token keyword\">where</span> b<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>         <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">from</span> student<span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>              <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr></table></figure><ol start=\"17\">\n<li>\n<ul>\n<li>查询学过 ' 张三 ' 老师课程的所有同学姓名、生日、性别</li>\n<li>找出 ' 张三 ' 老师的教师编号</li>\n<li>找出 ' 张三 ' 老师所有教授的课程编号</li>\n<li>找出这些课程对应的学生编号</li>\n<li>根据学生编号找到对应的学生信息</li>\n</ul>\n</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> student s</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> student_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> score s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>             <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">select</span> c<span class=\"token punctuation\">.</span>course_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                 <span class=\"token keyword\">select</span> teacher_id<span class=\"token punctuation\">,</span> name</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                 <span class=\"token keyword\">from</span> teacher</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                 <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'张三'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>             <span class=\"token punctuation\">)</span> t1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                 <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">select</span> teacher_id<span class=\"token punctuation\">,</span> course_id</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">from</span> course</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">)</span> c <span class=\"token keyword\">on</span> t1<span class=\"token punctuation\">.</span>teacher_id <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>teacher_id</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">)</span> t2 <span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>course_id</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">)</span> t3 <span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> t3<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"18\">\n<li>查询同时学习 &quot;01&quot;、&quot;02&quot; 课程学生的学生编号以及 &quot;01&quot; 和 &quot;02&quot; 课程成绩</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token keyword\">as</span> student_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">as</span> score_01<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">as</span> score_02</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'02'</span><span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>              <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"19\">\n<li>查询学习 &quot;01&quot; 课程但没有学习 &quot;02&quot; 课程学生的学生编号以及 &quot;01&quot; 课程成绩</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token keyword\">as</span> student_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">as</span> score_01</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'02'</span><span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                   <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> b<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"20\">\n<li>查询学习 &quot;02&quot; 课程但没有学习 &quot;01&quot; 课程学生的学生编号以及 &quot;02&quot; 课程成绩</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> b<span class=\"token punctuation\">.</span>student_id <span class=\"token keyword\">as</span> student_id<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>score <span class=\"token keyword\">as</span> score_02</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         <span class=\"token keyword\">right</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'02'</span><span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                    <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"21\">\n<li>查询选课的同学的学生姓名、选课总数、所有课程的成绩总和、课程平均分</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name      <span class=\"token punctuation\">,</span>course_num      <span class=\"token punctuation\">,</span>score_sum      <span class=\"token punctuation\">,</span>score_avg  <span class=\"token keyword\">from</span>    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span>name          <span class=\"token keyword\">from</span> student    <span class=\"token punctuation\">)</span> ajoin    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span>course_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> course_num              <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> score_sum              <span class=\"token punctuation\">,</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> score_avg           <span class=\"token keyword\">from</span> score           <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> student_id    <span class=\"token punctuation\">)</span> b  <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token operator\">=</span>b<span class=\"token punctuation\">.</span>student_idorder <span class=\"token keyword\">by</span> course_num <span class=\"token keyword\">desc</span>         <span class=\"token punctuation\">,</span>score_sum <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><ol start=\"26\">\n<li>查询考试平均分大于 60 分同学的学生姓名、选课总数、所有课程的成绩总和、课程平均分，按照科目数排降序、科目数相同按照分数排降序</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name      <span class=\"token punctuation\">,</span>course_num      <span class=\"token punctuation\">,</span>score_sum      <span class=\"token punctuation\">,</span>score_avg  <span class=\"token keyword\">from</span>    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span>name          <span class=\"token keyword\">from</span> student    <span class=\"token punctuation\">)</span> ajoin    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span>course_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> course_num              <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> score_sum              <span class=\"token punctuation\">,</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> score_avg           <span class=\"token keyword\">from</span> score        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> student_id    <span class=\"token punctuation\">)</span> b  <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token operator\">=</span>b<span class=\"token punctuation\">.</span>student_idwhere score_avg <span class=\"token operator\">></span> <span class=\"token number\">60</span>order <span class=\"token keyword\">by</span> course_num <span class=\"token keyword\">desc</span>         <span class=\"token punctuation\">,</span>score_sum <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><ol start=\"27\">\n<li>检索 &quot;01&quot; 课程分数小于 60 分的学生信息及 &quot;01&quot; 课程分数，按照分数排降序</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token keyword\">as</span> student_id      <span class=\"token punctuation\">,</span>name      <span class=\"token punctuation\">,</span>birthday      <span class=\"token punctuation\">,</span>sex      <span class=\"token punctuation\">,</span>score  <span class=\"token keyword\">from</span>     <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>          <span class=\"token keyword\">from</span> student    <span class=\"token punctuation\">)</span> ajoin     <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span>score          <span class=\"token keyword\">from</span> score        <span class=\"token keyword\">where</span> course_id<span class=\"token operator\">=</span><span class=\"token string\">'01'</span>            <span class=\"token operator\">and</span> score <span class=\"token operator\">&lt;</span> <span class=\"token number\">60</span>    <span class=\"token punctuation\">)</span> b  <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_idorder <span class=\"token keyword\">by</span> score <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><ol start=\"28\">\n<li>查询两门及其以上不及格课程的同学的姓名及其平均成绩</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name      <span class=\"token punctuation\">,</span>score_avg  <span class=\"token keyword\">from</span>     <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>          <span class=\"token keyword\">from</span> student    <span class=\"token punctuation\">)</span> ajoin    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span>score_avg          <span class=\"token keyword\">from</span>             <span class=\"token punctuation\">(</span>                <span class=\"token keyword\">select</span> student_id                      <span class=\"token punctuation\">,</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> score_avg                      <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> score <span class=\"token operator\">&lt;</span> <span class=\"token number\">60</span> <span class=\"token keyword\">then</span> <span class=\"token number\">1</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> fail_count                  <span class=\"token keyword\">from</span> score                <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> student_id            <span class=\"token punctuation\">)</span> a        <span class=\"token keyword\">where</span> fail_count <span class=\"token operator\">></span> <span class=\"token number\">1</span>     <span class=\"token punctuation\">)</span> b  <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"29\">\n<li>\n<p>查询没有学全所有课程的同学的编号 （包含无选课的同学）</p>\n<p>- 在成绩表中找出不满足课程总数的学生 id - 找出学生表中无成绩的学生 id - 二者之和</p>\n</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> b<span class=\"token punctuation\">.</span>student_id    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> course_num          <span class=\"token keyword\">from</span> score    <span class=\"token punctuation\">)</span> ajoin    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> course_num          <span class=\"token keyword\">from</span> score    <span class=\"token punctuation\">)</span> b  <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>course_num <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>course_numunion     <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id          <span class=\"token keyword\">from</span>            <span class=\"token punctuation\">(</span>                <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>                  <span class=\"token keyword\">from</span> student            <span class=\"token punctuation\">)</span> a        <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span>            <span class=\"token punctuation\">(</span>                <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>                  <span class=\"token keyword\">from</span> score            <span class=\"token punctuation\">)</span> b          <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id        <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span>    <span class=\"token punctuation\">)</span> b</pre></td></tr></table></figure><ol start=\"30\">\n<li>查询 1990 年出生的学生名单</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>  <span class=\"token keyword\">from</span> studentwhere substr<span class=\"token punctuation\">(</span>birthday<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token string\">'1990'</span></pre></td></tr></table></figure><ol start=\"31\">\n<li>查询名字中含有「风」字的学生信息</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>  <span class=\"token keyword\">from</span> studentwhere name <span class=\"token operator\">like</span> <span class=\"token string\">'%风%'</span></pre></td></tr></table></figure><ol start=\"32\">\n<li>查询「李」姓老师的数量</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>  <span class=\"token keyword\">from</span> teacherwhere name <span class=\"token operator\">like</span> <span class=\"token string\">'李%'</span></pre></td></tr></table></figure><ol start=\"33\">\n<li>查询至少有两门课与学号为 &quot;01&quot; 的学生所学相同的学生 id</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> b<span class=\"token punctuation\">.</span>student_id <span class=\"token keyword\">as</span> student_id<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>course_id <span class=\"token keyword\">as</span> course_id</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> course_id <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> student_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>               <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span> course_id <span class=\"token keyword\">from</span> score <span class=\"token keyword\">where</span> student_id <span class=\"token operator\">&lt;></span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                    <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>course_id<span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> a<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>course_id<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"34\">\n<li>查询选修了全部课程的学生 id 的姓名和姓名</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> b<span class=\"token punctuation\">.</span>student_id <span class=\"token keyword\">as</span> student_id    <span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name    <span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">.</span>course_num <span class=\"token keyword\">as</span> course_numfrom  <span class=\"token punctuation\">(</span>      <span class=\"token keyword\">select</span> student_id            <span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">.</span>course_num <span class=\"token keyword\">as</span> course_num        <span class=\"token keyword\">from</span>          <span class=\"token punctuation\">(</span>              <span class=\"token keyword\">select</span> student_id                    <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span>course_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> course_num                <span class=\"token keyword\">from</span> course          <span class=\"token punctuation\">)</span> a      <span class=\"token keyword\">join</span>          <span class=\"token punctuation\">(</span>              <span class=\"token keyword\">select</span> student_id                    <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> course_num                <span class=\"token keyword\">from</span> score              <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> student_id          <span class=\"token punctuation\">)</span> b        <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>course_num <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>course_num  <span class=\"token punctuation\">)</span> ajoin  <span class=\"token punctuation\">(</span>      <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>        <span class=\"token keyword\">from</span> student  <span class=\"token punctuation\">)</span> bon  a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr></table></figure><ol start=\"35\">\n<li>查询和 &quot;01&quot; 号的同学学习的课程完全相同的其他同学的学生 id</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> student_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         <span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span> ct<span class=\"token punctuation\">,</span> ct1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>         <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                  <span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> ct</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                  <span class=\"token keyword\">from</span> score <span class=\"token keyword\">as</span> a</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                           <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                       <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> course_id</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                        <span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                        <span class=\"token keyword\">where</span> student_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> b</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                       <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>course_id</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                  <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> student_id</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>              <span class=\"token punctuation\">)</span> t1</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                  <span class=\"token keyword\">join</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>             <span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> ct1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>             <span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>             <span class=\"token keyword\">where</span> student_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>         <span class=\"token punctuation\">)</span> t2</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     <span class=\"token punctuation\">)</span> t3</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">where</span> ct <span class=\"token operator\">=</span> ct1</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token operator\">and</span> student_id <span class=\"token operator\">!=</span> <span class=\"token string\">'01'</span></pre></td></tr></table></figure><ol start=\"36\">\n<li>\n<ul>\n<li>先选出‘01’同学所学的课程 id</li>\n<li>然后选出学过这些课程 id 的学生 id 及其选过这些课程数的课程总数</li>\n<li>匹配 “01” 同学学的课程总数（存在某同学学的课程超过 “01” 同学学的课程）</li>\n<li>匹配成绩表中学生的课程总数</li>\n</ul>\n</li>\n<li>\n<p>统计各科成绩各分数段人数：课程编号，课程名称，[100-85]，[85-70]，[70-60]，[60-0] 及所占百分比</p>\n<p>- 根据课程号在成绩表中查询分数段的个数除以该学习该课程的总数</p>\n</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>course_id <span class=\"token keyword\">as</span> course_id        <span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name        <span class=\"token punctuation\">,</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> score <span class=\"token operator\">></span> <span class=\"token number\">85</span> <span class=\"token keyword\">then</span> <span class=\"token number\">1</span> <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token string\">'100-85'</span>        <span class=\"token punctuation\">,</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> score <span class=\"token operator\">between</span> <span class=\"token number\">70</span> <span class=\"token operator\">and</span> <span class=\"token number\">84</span> <span class=\"token keyword\">then</span> <span class=\"token number\">1</span> <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token string\">'85-70'</span>        <span class=\"token punctuation\">,</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> score <span class=\"token operator\">between</span> <span class=\"token number\">60</span> <span class=\"token operator\">and</span>  <span class=\"token number\">69</span> <span class=\"token keyword\">then</span> <span class=\"token number\">1</span> <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token string\">'70-60'</span>        <span class=\"token punctuation\">,</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> score <span class=\"token operator\">&lt;</span> <span class=\"token number\">60</span> <span class=\"token keyword\">then</span> <span class=\"token number\">1</span> <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token string\">'60-0'</span>    <span class=\"token keyword\">from</span>      <span class=\"token punctuation\">(</span>          <span class=\"token keyword\">select</span> course_id                <span class=\"token punctuation\">,</span>score            <span class=\"token keyword\">from</span> score      <span class=\"token punctuation\">)</span> a  <span class=\"token keyword\">join</span>      <span class=\"token punctuation\">(</span>          <span class=\"token keyword\">select</span> course_id                <span class=\"token punctuation\">,</span>name            <span class=\"token keyword\">from</span> course      <span class=\"token punctuation\">)</span> b    <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>course_id  <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> a<span class=\"token punctuation\">.</span>course_id          <span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">.</span>name</pre></td></tr></table></figure><ol start=\"38\">\n<li>查询学生的总成绩，并进行排名</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> student_id      <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> score_sum      <span class=\"token punctuation\">,</span>row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> rank  <span class=\"token keyword\">from</span> scoregroup <span class=\"token keyword\">by</span> student_id</pre></td></tr></table></figure><ol start=\"39\">\n<li>查询各科成绩前三名的记录</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> course_id<span class=\"token punctuation\">,</span>student_id<span class=\"token punctuation\">,</span>rk</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>               rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> course_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> score<span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk<span class=\"token operator\">&lt;=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"40\">\n<li>查询出只选修两门课程的学生学号和姓名</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token keyword\">as</span> student_id      <span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name  <span class=\"token keyword\">from</span>    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span>name           <span class=\"token keyword\">from</span> student    <span class=\"token punctuation\">)</span> ajoin     <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id          <span class=\"token keyword\">from</span> score        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> student_id        <span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>course_id<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span>    <span class=\"token punctuation\">)</span> b    <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"41\">\n<li>查询每门课程的平均成绩，结果按平均成绩降序排列，平均成绩相同时，按课程编号升序排列</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> course_id      <span class=\"token punctuation\">,</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> score_avg  <span class=\"token keyword\">from</span> scoreorder <span class=\"token keyword\">by</span> score_avg <span class=\"token keyword\">desc</span>        <span class=\"token punctuation\">,</span>course_id <span class=\"token keyword\">asc</span></pre></td></tr></table></figure><ol start=\"42\">\n<li>查询平均成绩大于等于 85 的所有学生的学号、姓名和平均成绩</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token keyword\">as</span> student_id      <span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name      <span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">.</span>score_avg  <span class=\"token keyword\">from</span>    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span>name          <span class=\"token keyword\">from</span> student    <span class=\"token punctuation\">)</span> ajoin    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> score_avg          <span class=\"token keyword\">from</span> score        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> student_id        <span class=\"token keyword\">having</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">85</span>    <span class=\"token punctuation\">)</span> b  <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr></table></figure><ol start=\"43\">\n<li>查询课程名称为「数学」，且分数低于 60 的学生姓名和分数</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name       <span class=\"token punctuation\">,</span>score  <span class=\"token keyword\">from</span>    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span>score          <span class=\"token keyword\">from</span>             <span class=\"token punctuation\">(</span>                <span class=\"token keyword\">select</span> course_id                  <span class=\"token keyword\">from</span> course                <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'数学'</span>            <span class=\"token punctuation\">)</span> a        <span class=\"token keyword\">join</span>             <span class=\"token punctuation\">(</span>                <span class=\"token keyword\">select</span> student_id                      <span class=\"token punctuation\">,</span>course_id                      <span class=\"token punctuation\">,</span>score                  <span class=\"token keyword\">from</span> score                <span class=\"token keyword\">where</span> score <span class=\"token operator\">&lt;</span> <span class=\"token number\">60</span>            <span class=\"token punctuation\">)</span> b          <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>course_id    <span class=\"token punctuation\">)</span> ajoin    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span>name          <span class=\"token keyword\">from</span> student    <span class=\"token punctuation\">)</span> b  <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr></table></figure><ol start=\"44\">\n<li>查询课程编号为 01 且课程成绩在 80 分及以上的学生的学号和姓名</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token keyword\">as</span> student_id    <span class=\"token punctuation\">,</span>name   <span class=\"token keyword\">from</span>    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id          <span class=\"token keyword\">from</span> score        <span class=\"token keyword\">where</span> course_id <span class=\"token operator\">=</span> <span class=\"token string\">'01'</span>          <span class=\"token operator\">and</span> score <span class=\"token operator\">>=</span> <span class=\"token number\">80</span>              <span class=\"token punctuation\">)</span> ajoin    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span>name          <span class=\"token keyword\">from</span> student    <span class=\"token punctuation\">)</span> b  <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr></table></figure><ol start=\"45\">\n<li>查询选修「张三」老师所授课程的学生中，成绩最高的学生编号、课程编号及其成绩</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> student_id      <span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">.</span>course_id <span class=\"token keyword\">as</span> course_id      <span class=\"token punctuation\">,</span>score  <span class=\"token keyword\">from</span>    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> course_id          <span class=\"token keyword\">from</span>             <span class=\"token punctuation\">(</span>                <span class=\"token keyword\">select</span> course_id                      <span class=\"token punctuation\">,</span>teacher_id                  <span class=\"token keyword\">from</span> course              <span class=\"token punctuation\">)</span> a        <span class=\"token keyword\">join</span>            <span class=\"token punctuation\">(</span>                <span class=\"token keyword\">select</span> teacher_id                  <span class=\"token keyword\">from</span> teacher                <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'张三'</span>            <span class=\"token punctuation\">)</span> b          <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>teacher_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>teacher_id    <span class=\"token punctuation\">)</span> ajoin     <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> student_id              <span class=\"token punctuation\">,</span>course_id              <span class=\"token punctuation\">,</span>score          <span class=\"token keyword\">from</span> score    <span class=\"token punctuation\">)</span> b  <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>course_idorder <span class=\"token keyword\">by</span> score desclimit <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"46\">\n<li>统计每门课程的学生选修人数（超过 5 人的课程才统计）。</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>course_id <span class=\"token keyword\">as</span> course_id      <span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">.</span>name      <span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">.</span>num <span class=\"token keyword\">as</span> num  <span class=\"token keyword\">from</span>    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> course_id              <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> num          <span class=\"token keyword\">from</span> score        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> course_id        <span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">5</span>    <span class=\"token punctuation\">)</span> ajoin    <span class=\"token punctuation\">(</span>        <span class=\"token keyword\">select</span> course_id              <span class=\"token punctuation\">,</span>name          <span class=\"token keyword\">from</span> course    <span class=\"token punctuation\">)</span> b  <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">=</span>b<span class=\"token punctuation\">.</span>course_id</pre></td></tr></table></figure><ol start=\"42\">\n<li>查询该学生有不同课程但成绩相同的学生编号、课程编号、学生成绩</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> 写法一</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>course_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>score</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>         <span class=\"token keyword\">select</span> student_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>              <span class=\"token punctuation\">,</span> course_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>              <span class=\"token punctuation\">,</span> score</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>         <span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     <span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>         <span class=\"token keyword\">join</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>         <span class=\"token keyword\">select</span> student_id</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>              <span class=\"token punctuation\">,</span> course_id</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>              <span class=\"token punctuation\">,</span> score</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>         <span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     <span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>     <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>         <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>score <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>score</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>         <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">&lt;></span> b<span class=\"token punctuation\">.</span>course_id</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>course_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>score</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token number\">2.</span> 写法二</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">DISTINCT</span> b<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>course_id<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>score</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">from</span> score a<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     score b</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">where</span> a<span class=\"token punctuation\">.</span>course_id <span class=\"token operator\">!=</span> b<span class=\"token punctuation\">.</span>course_id</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>score <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>score</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token number\">3.</span> 写法三</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">from</span> score <span class=\"token keyword\">as</span> t</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                  <span class=\"token keyword\">from</span> score</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                  <span class=\"token keyword\">where</span> student_id <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    <span class=\"token operator\">and</span> course_id <span class=\"token operator\">&lt;></span> t<span class=\"token punctuation\">.</span>course_id</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    <span class=\"token operator\">and</span> score <span class=\"token operator\">&lt;></span> t<span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": [
                "大数据",
                "Hive"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/cipher/cg/%E6%96%B0%E5%BB%BA%E6%96%87%E6%9C%AC%E6%96%87%E6%A1%A3/",
            "url": "https://github.com/Mayizono/miyazono.github.io/cipher/cg/%E6%96%B0%E5%BB%BA%E6%96%87%E6%9C%AC%E6%96%87%E6%A1%A3/",
            "title": "数据集市搭建过程",
            "date_published": "2021-10-26T16:00:00.000Z",
            "content_html": "<h1 id=\"数据集市\"><a class=\"anchor\" href=\"#数据集市\">#</a> 数据集市</h1>\n<h2 id=\"维度设计\"><a class=\"anchor\" href=\"#维度设计\">#</a> 维度设计</h2>\n<h3 id=\"时间维度\"><a class=\"anchor\" href=\"#时间维度\">#</a> 时间维度</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> dim_date_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">CREATE</span> EXTERNAL <span class=\"token keyword\">TABLE</span> dim_date_info<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">`</span>date_id<span class=\"token punctuation\">`</span> STRING <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'日'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">`</span>week_id<span class=\"token punctuation\">`</span> STRING <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'周ID'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">`</span>week_day<span class=\"token punctuation\">`</span> STRING <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'周几'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">`</span><span class=\"token keyword\">day</span><span class=\"token punctuation\">`</span> STRING <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'每月的第几天'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> STRING <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'第几月'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">`</span>quarter<span class=\"token punctuation\">`</span> STRING <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'第几季度'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">`</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">`</span> STRING <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'年'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">`</span>is_workday<span class=\"token punctuation\">`</span> STRING <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'是否是工作日'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">`</span>holiday_id<span class=\"token punctuation\">`</span> STRING <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'节假日'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'时间维度表'</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>STORED <span class=\"token keyword\">AS</span> PARQUET</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>LOCATION <span class=\"token string\">'/warehouse/cggene/dim/dim_date_info/'</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>TBLPROPERTIES <span class=\"token punctuation\">(</span><span class=\"token string\">\"parquet.compression\"</span><span class=\"token operator\">=</span><span class=\"token string\">\"lzo\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "CG工作",
                "CG"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E5%94%AF%E5%93%81%E4%BC%9A%E4%BA%BF%E7%BA%A7%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%E5%AE%9E%E8%B7%B5/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E5%94%AF%E5%93%81%E4%BC%9A%E4%BA%BF%E7%BA%A7%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%E5%AE%9E%E8%B7%B5/",
            "title": "唯品会亿级数据服务平台实践",
            "date_published": "2021-08-22T16:00:00.000Z",
            "content_html": "<p>数据服务是数据中台体系中的关键组成部分。作为数仓对接上层应用的统一出入口，数据服务将数仓当作一个统一的 DB 来访问，提供统一的 API 接口控制数据的流入及流出，能够满足用户对不同类型数据的访问需求。</p>\n<p>电商平台唯品会的数据服务自 2019 年开始建设，在公司内经历了从无到有落地，再到为超过 30 + 业务方提供 To B、To C 的数据服务的过程。本文主要介绍唯品会自研数据服务 Hera 的相关背景、架构设计和核心功能。</p>\n<h2 id=\"背景介绍\"><a class=\"anchor\" href=\"#背景介绍\">#</a> <strong>背景介绍</strong></h2>\n<p>在统一数仓数据服务之前，数仓提供的访问接入方式往往存在效率问题低、数据指标难统一等问题，具体而言有以下几个比较突出的情况：</p>\n<ul>\n<li>广告人群 USP、DMP 系统每天需要通过 HiveServer 以流的方式从数仓导出数据到本地，每个人群的数据量从几十万到几个亿，人群数量 2w+，每个人群运行时间在 30min +，部分大人群的运行直接超过 1h，在资源紧张的情况下，人群延迟情况严重。</li>\n<li>数仓的数据在被数据产品使用时，需要为每个表新生成一个单独的接口，应用端需要为每一种访问方式（如 Presto、ClickHouse）区分使用不同的接口，导致数据产品接口暴涨，不方便维护，影响开发及维护效率。数据在不同的存储时，需要包含 clickhouse-client，presto-client 等等第三方 jar 包。</li>\n<li>不同数据产品中都需要使用一些常用的数据指标，如销售额、订单数、PV、UV 等，而这些数据在不同数据产品的实现口径、实现方式都不一样，无法形成数据共享，每个数据产品都重复进行相同的指标建设。因此，在不同数据产品查看相同指标却发现数值不同的情况下，难以判断哪个数据产品提供的数据是准确的。</li>\n</ul>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/11a5ebc6b5fb6e3a5f8eded58ed33b42.png\" alt=\"img\" /></p>\n<p>图 1. 数据流入流出方式</p>\n<p>为解决以上问题，数据服务应运而生。目前数据服务的主要优势有：屏蔽底层的存储引擎、计算引擎，使用同一个 API（one service），数仓数据分层存储，不同 Engine 的 SQL 生成能力，自适应 SQL 执行以及统一缓存架构保障业务 SLA，支持数据注册并授权给任何调用方进行使用，提高数据交付效率。</p>\n<p>通过唯一的 ID 标识，数据产品可通过 ID 查阅数据，而非直接访问对应的数仓表。一方面，指标服务统一了指标的口径，同时也支持快速构建新的数据产品。</p>\n<h2 id=\"架构设计\"><a class=\"anchor\" href=\"#架构设计\">#</a> <strong>架构设计</strong></h2>\n<p>数据服务能给业务带来运营和商业价值，核心在于给用户提供自助分析数据能力。Hera 整体架构基于典型的 Master/slave 模型，数据流与控制流单独链路，从而保障系统的高可用性。数据服务系统主要分为三层：</p>\n<ol>\n<li>应用接入层：业务申请接入时，可以根据业务要求选择数据服务 API（TCP Client)，HTTP 以及 OSP 服务接口（公司内部 RPC 框架）。</li>\n<li>数据服务层：主要执行业务提交的任务，并返回结果。主要功能点包括：路由策略，多引擎支持，引擎资源配置，引擎参数动态组装，SQL Lispengine 生成，SQL 自适应执行，统一数据查询缓存，FreeMaker SQL 动态生成等功能。</li>\n<li>数据层：业务查询的数据无论在数仓、Clickhouse、MySQL 还是 Redis 中，都可以很好地得到支持，用户都使用同一套 API。</li>\n</ol>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/af2c0810cdc4d45854f90cce7a854bd1.png\" alt=\"img\" /></p>\n<p>图 2. 数据服务整体架构图</p>\n<p>调度系统的整体流程大致包含以下模块：</p>\n<ul>\n<li>Master：负责管理所有的 Worker、TransferServer、AdhocWorker 节点，同时负责调度分发作业；</li>\n<li>Worker：负责执行 ETL 和数据文件导出类型的作业，拉起 AdhocWorker 进程（Adhoc 任务在 AdhocWorker 进程中的线程池中执行），ETL 类型的作业通过子进程的方式完成；</li>\n<li>Client：客户端，用于编程式地提交 SQL 作业；</li>\n<li>ConfigCenter：负责向集群推送统一配置信息及其它运行时相关的配置和 SQLParser （根据给定的规则解析、替换、生成改写 SQL 语句，以支持不同计算引擎的执行）；</li>\n<li>TransferServer：文件传输服务。</li>\n</ul>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/d2a5cf2c11e929194fe55db196cf5f5b.png\" alt=\"img\" /></p>\n<p>图 3. 数据服务调度流程图</p>\n<h2 id=\"主要功能\"><a class=\"anchor\" href=\"#主要功能\">#</a> <strong>主要功能</strong></h2>\n<p>Hera 数据服务的主要功能有：多队列调度策略、多引擎查询、多任务类型、文件导出、资源隔离、引擎参数动态组装、自适应 Engine 执行和 SQL 构建。</p>\n<h3 id=\"多队列调度策略\"><a class=\"anchor\" href=\"#多队列调度策略\">#</a> <strong>多队列调度策略</strong></h3>\n<p>数据服务支持按照不同用户、不同任务类型并根据权重划分不同调度队列，以满足不同任务类型的 SLA。</p>\n<h3 id=\"多引擎查询\"><a class=\"anchor\" href=\"#多引擎查询\">#</a> <strong>多引擎查询</strong></h3>\n<p>数据服务支持目前公司内部所有 OLAP 和数据库类型，包括 Spark、Presto、Clickhouse、Hive 、MySQL、Redis。会根据业务具体场景和要求，选择当前最佳的查询引擎。</p>\n<h3 id=\"多任务类型\"><a class=\"anchor\" href=\"#多任务类型\">#</a> <strong>多任务类型</strong></h3>\n<p>数据服务支持的任务类型有：ETL、Adhoc、文件导出、数据导入。加上多引擎功能，实现多种功能组合，如 Spark adhoc 和 Presto adhoc。</p>\n<h3 id=\"文件导出\"><a class=\"anchor\" href=\"#文件导出\">#</a> <strong>文件导出</strong></h3>\n<p>主要是支持大量的数据从数据仓库中导出，便于业务分析和处理，比如供应商发券和信息推送等。</p>\n<p>具体执行过程如下：用户提交需要导出数据的 SQL，通过分布式 engine 执行完成后，落地文件到 hdfs/alluxio. 客户端通过 TCP 拉取文件到本地。千万亿级的数据导出耗时最多 10min。数据导出在人群数据导出上性能由原来的 30min+ ，提升到最多不超过 3min，性能提升 10~30 倍。具体流程如下：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/18a0f8bb17025642866ab5c212b31508.png\" alt=\"img\" /></p>\n<p>图 4. 数据服务文件下载流程图</p>\n<h3 id=\"\"><a class=\"anchor\" href=\"#\">#</a> </h3>\n<h3 id=\"资源隔离worker-资源和计算资源\"><a class=\"anchor\" href=\"#资源隔离worker-资源和计算资源\">#</a> <strong>资源隔离（Worker 资源和计算资源）</strong></h3>\n<p>业务一般分为核心和非核心，在资源分配和调度上也不同。主要是从执行任务 Worker 和引擎资源，都可以实现物理级别的隔离，最大化减少不同业务之间相互影响。</p>\n<h3 id=\"引擎参数动态组装\"><a class=\"anchor\" href=\"#引擎参数动态组装\">#</a> <strong>引擎参数动态组装</strong></h3>\n<p>线上业务执行需要根据业务情况进行调优，动态限制用户资源使用，集群整体切换等操作，这个时候就需要对用户作业参数动态修改，如 OLAP 引擎执行任务时，经常都要根据任务调优，设置不同参数。针对这类问题，数据服务提供了根据引擎类型自动组装引擎参数，并且引擎参数支持动态调整，也可以针对特定任务、执行账号、业务类型来设定 OLAP 引擎执行参数。</p>\n<h3 id=\"自适应-engine-执行\"><a class=\"anchor\" href=\"#自适应-engine-执行\">#</a> <strong>自适应 Engine 执行</strong></h3>\n<p>业务方在查询时，有可能因为引擎资源不足或者查询条件数据类型不匹配从而导致执行失败。为了提高查询成功率和服务 SLA 保障，设计了 Ad Hoc 自适应引擎执行，当一个引擎执行报错后，会切换到另外一个引擎继续执行。具体自适应执行逻辑如下图所示：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/4536195ec8db494c31a5764d4309d0a9.png\" alt=\"img\" /></p>\n<p>图 5. 自适应 Engine 执行</p>\n<h3 id=\"-2\"><a class=\"anchor\" href=\"#-2\">#</a> </h3>\n<h3 id=\"sql构建\"><a class=\"anchor\" href=\"#sql构建\">#</a> <strong>SQL 构建</strong></h3>\n<p>数据服务 SQL 构建基于维度事实建模，支持单表模型、星型模型和雪花模型。</p>\n<ul>\n<li>单表模型：一张事实表，一般为 DWS 或者 ADS 的汇总事实表。</li>\n<li>星型模型：1 张事实表（如 DWD 明细事实表）+ N 张维表，例如订单明细表 (事实表 FK = 商品 ID) + 商品维表 (维度表 PK = 商品 ID) 。</li>\n<li>雪花模型：1 张事实表（如 DWD 明细事实表）+ N 张维表 + M 张没有直接连接到事实表的维表，例如订单明细表 (事实表 FK = 商品 ID)　+ 商品维表 (维度表 PK = 商品 ID，FK = 品类 ID) + 品类维表 (维度表 PK = 品类 ID）。</li>\n</ul>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/d6f1e283133d7bfc1ccb4d66398677cf.png\" alt=\"img\" /></p>\n<p>图 6.SQL 维度模型</p>\n<h4 id=\"-3\"><a class=\"anchor\" href=\"#-3\">#</a> </h4>\n<h3 id=\"任务调度\"><a class=\"anchor\" href=\"#任务调度\">#</a> <strong>任务调度</strong></h3>\n<p>基于 Netty 库收发集群消息，系统仅仅使用同一个线程池对象 EventLoopGroup 来收发消息，而用户的业务逻辑，则交由一个单独的线程池。</p>\n<p>选用 Netty 的另外一个原因是 “零拷贝” 的能力，在大量数据返回时，通过文件的形式直接将结果送给调用者。</p>\n<h4 id=\"多队列多用户调度\"><a class=\"anchor\" href=\"#多队列多用户调度\">#</a> <strong>多队列 + 多用户调度</strong></h4>\n<p>业务需求通常包含时间敏感与不敏感作业，为了提高作业的稳定性和系统的可配置性，Hera 提供了多队列作业调度的功能。</p>\n<p>用户在提交作业时可以显式地指定一个作业队列名，当这个作业在提交到集群时，如果相应的队列有空闲，则就会被添加进相应的队列中，否则返回具体的错误给客户端，如任务队列满、队列名不存在、队列已经关闭等，客户端可以选择 “是否重试提交”。</p>\n<p>当一个作业被添加进队列之后，Master 就会立即尝试调度这个队列中的作业，基于以下条件选择合适的作业运行：</p>\n<ol>\n<li>每个队列都有自己的权重，同时会设置占用整个集群的资源总量，如最多使用多少内存、最多运行的任务数量等。</li>\n<li>队列中的任务也有自己的权重，同时会记录这个作业入队的时间，在排序当前队列的作业时，利用入队的时间偏移量和总的超时时间，计算得到一个最终的评分。</li>\n<li>除了调度系统本身的调度策略外，还需要考虑外部计算集群的负载，在从某个队列中拿出一个作业后，再进行一次过滤，或者是先过滤，再进行作业的评分计算。</li>\n</ol>\n<p>一个可用的计算作业评分模型如下：</p>\n<p>队列动态因子 = 队列大小 / 队列容量 * (1 - 作业运行数 / 队列并行度)</p>\n<p>这个等式表示的意义是：如果某个队列正在等待的作业的占比比较大，同时并行运行的作业数占比也比较大时，这个队列的作业就拥有一个更大的因子，也就意味着在队列权重相同时，这个队列中的作业应该被优先调度。</p>\n<p>作业权重 = 1 - (当前时间 - 入队时间) / 超时时间</p>\n<p>这个等式表示的意义是：在同一个队列中，如果一个作业的剩余超时时间越少，则意味着此作业将更快达到超时，因此它应该获得更大的选择机会。</p>\n<p>Score = 作业权重 + 队列动态因子 + 队列权重</p>\n<p>这个等式表示的意义是：对于所有的队列中的所有任务，首先决定一个作业是否优先被调度的因子是设置的队列权重，例如权重为 10 的队列的作业，应该比权重为 1 的队列中的作业被优先调度，而不管作业本身的权重（是否会有很大的机率超时）；其次影响作业调度优先级的因子是队列动态因子，例如有两个相同权重的队列时，如果一个队列的动态因子为 0.5，另外一个队列的动态因子是 0.3，那么应该优先选择动态因子为 0.5 的队列作业进行调度，而不管作业本身的权重；最后影响作业调度优先级的因子是作业权重，例如在同一个队列中，有两个权重分别为 0.2 和 0.5 的作业，那么为了避免更多的作业超时，权重为 0.2 的作业应该被优先调度。</p>\n<p>简单描述作业的排序过程就是，首先按队列权重排序所有的队列；对于有重复的队列，则会计算每个队列的动态因子，并按此因子排序；对于每一个队列，作业的排序规则按作业的超时比率来排序；最终依次按序遍历每一个队列，尝试从中选择足够多的作业运行，直到作业都被运行或是达到集群限制条件。这里说足够多，是指每一个队列都会有一个最大的并行度和最大资源占比，这两个限制队列的参数组合，是为了避免因某一个队列的容量和并行度被设置的过大，可能超过了整个集群，导致其它队列被 “饿死” 的情况。</p>\n<h4 id=\"sql作业流程\"><a class=\"anchor\" href=\"#sql作业流程\">#</a> <strong>SQL 作业流程</strong></h4>\n<p>用户通过 Client 提交原始 SQL，这里以 Presto SQL 为例，Client 在提交作业时，指定了 SQL 路由，则会首先通过访问 SQLParser 服务，在发送给 Master 之前，会首先提交 SQL 语句到 SQLParser 服务器，将 SQL 解析成后端计算集群可以支持的 SQL 语句，如 Spark、Presto、ClickHouse 等，为了能够减少 RPC 交互次数，SQLParser 会一次返回所有可能被改写的 SQL 语句。</p>\n<p>在接收到 SQLParser 服务返回的多个可能 SQL 语句后，就会填充当前的作业对象，真正开始向 Master 提交运行。</p>\n<p>Master 在收到用户提交的作业后，会根据一定的调度策略，最终将任务分发到合适的 Worker 上，开始执行。Worker 会首先采用 SQL 作业默认的执行引擎，比如 Presto，提交到对应的计算集群运行，但如果因为某种原因不能得到结果，则会尝试使用其它的计算引擎进行计算。当然这里也可以同时向多个计算集群提交作业，一旦某个集群首先返回结果时，就取消所有其它的作业，不过这需要其它计算集群的入口能够支持取消操作。</p>\n<p>当 SQL 作业完成后，将结果返回到 Worker 端，为了能够更加高效地将查询结果返回给 Client 端，Worker 会从 Master 发送的任务对象中提取 Client 侧信息，并将结果直接发送给 Client，直到收到确认信息，至此整个任务才算执行完毕。</p>\n<p>在整个作业的流转过程中，会以任务的概念在调度系统中进行传播，并经历几个状态的更新，分别标识 new、waiting、running、succeed、failed 阶段。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/49067d5554cb67edbf7807d0aabd9d59.png\" alt=\"img\" /></p>\n<p>图 9. SQL 作业处理流程</p>\n<h4 id=\"metrics-采集\"><a class=\"anchor\" href=\"#metrics-采集\">#</a> <strong>Metrics 采集</strong></h4>\n<p>数据服务搜集两类 metrics，一类静态的，用于描述 master/worker/client 的基本信息；一类是动态的，描述 master/worker 的运行时信息。这里主要说明一下有关集群动态信息的采集过程及作用。以 worker 为例，当 worker 成功注册到 master 时，就会开启定时心跳汇报动作，并借道心跳请求，将自己的运行时信息汇报给 master。这里主要是内存使用情况，例如当前 worker 通过估算方法，统计目前运行的任务占据了多少内存，以便 master 能够在后续的任务分发过程中，能够根据内存信息进行决策。master 会统计它所管理的集群整个情况，例如每个任务队列的快照信息、worker 的快照信息、集群的运行时配置信息等，并通过参数控制是否打印这些信息，以便调试。</p>\n<h2 id=\"解决的性能问题\"><a class=\"anchor\" href=\"#解决的性能问题\">#</a> <strong>解决的性能问题</strong></h2>\n<p>数据服务主要解决 SLA 方面的问题。如人群计算、数据无缝迁移、数据产品 SLA 等，这里用人群举例说明如下：</p>\n<p>人群计算遇到的问题：</p>\n<ol>\n<li>人群计算任务的数据本地性不好；</li>\n<li>HDFS 存在数据热点问题；</li>\n<li>HDFS 读写本身存在长尾现象。</li>\n</ol>\n<p>数据服务改造新的架构方案：</p>\n<ul>\n<li>计算与存储同置，这样数据就不需通过网络反复读取，造成网络流量浪费。</li>\n<li>减少 HDFS 读写长尾对人群计算造成的额外影响，同时减少人群计算对于 HDFS 稳定性的影响。</li>\n<li>广告人群计算介于线上生产任务跟离线任务之间的任务类型。这里我们希望能保证这类应用的可靠性和稳定性，从而更好地为公司业务赋能</li>\n<li>通过数据服务执行人群计算。</li>\n</ul>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/6eec9872a3827c1d42782fb13b4a5875.png\" alt=\"img\" /></p>\n<p>图 10. Alluxio 和 Spark 集群混部</p>\n<h4 id=\"基于-alluxio-的缓存表同步\"><a class=\"anchor\" href=\"#基于-alluxio-的缓存表同步\">#</a> <strong>基于 Alluxio 的缓存表同步</strong></h4>\n<p>将 Hive 表的 location 从 HDFS 路径替换为 Alluxio 路径，即表示该表的数据存储于 Alluxio 中。我们使用的方案不是直接写通过 ETL 任务写 Alluxio 表的数据，而是由 Alluxio 主动去拉取同样 Hive 表结构的 HDFS 中的数据，即我们创建了一个 HDFS 表的 Alluxio 缓存表。</p>\n<p>由于 Alluxio 不能感知到分区表的变化，我们开发了一个定时任务去自动感知源表的分区变化，使得 Hive 表的数据能够同步到 Alluxio 中。</p>\n<p>具体步骤如下：</p>\n<ol>\n<li>定时任务发起轮询，检测源表是否有新增分区。</li>\n<li>发起一个 SYN2ALLUXIO 的任务由数据服务执行。</li>\n<li>任务执行脚本为将 Alluxio 表添加与 HDFS 表相同的分区。</li>\n<li>分区添加完成之后，Alluxio 会自动从 mount 的 HDFS 路径完成数据同步。</li>\n</ol>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/9eacc05249185b5190799eb46cacc6e6.png\" alt=\"img\" /></p>\n<p>图 11. Alluxio 缓存表同步</p>\n<h4 id=\"人群计算任务\"><a class=\"anchor\" href=\"#人群计算任务\">#</a> <strong>人群计算任务</strong></h4>\n<p>上小节介绍了如何让 Alluxio 和 HDFS 的 Hive 表保持数据同步，接下来需要做的就是让任务计算的 Spark 任务跑在 Spark 与 Alluxio 混部的集群上，充分利用数据的本地性以及计算资源的隔离性，提高人群计算效率。</p>\n<p>人群服务通过调用数据服务执行。数据服务根据底表分区是否同步到 Alluxio 决定是否需要下推是用 Alluxio 表来完成计算。如果底表数据已经同步到 Alluxio，则使用 Alluxio 表来做为底表计算人群。</p>\n<p>依靠数据服务调度系统，通过用户 SQL 改写以及 Alluxio 和 Spark 计算结点混部模式，人群计算任务提速了 10%~30%。</p>\n<h2 id=\"小结\"><a class=\"anchor\" href=\"#小结\">#</a> <strong>小结</strong></h2>\n<p>虽然截至今天，Hera 数据服务已经支持了很多生产业务，但目前仍有很多需要完善的地方：</p>\n<ul>\n<li>不同 engine 存在同一个含义函数写法不一致的情况。这种情况在 Presto 跟 ClickHouse 的函数比较时尤为突出，如 Presto 的 strpos（string, substring）函数，在 Clickhouse 中为 position (haystack, needle [, start_pos])，且这些函数的参数顺序存在不一致的情况，如何更优雅地支持不同 engine 的差异情况还需要进一步思考。</li>\n<li>人群计算采用业界通用的 ClickHouse BitMap 解决方案落地，提升人群的计算效率同时扩展数据服务的业务边界。</li>\n</ul>\n",
            "tags": [
                "大数据",
                "大厂学习"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E6%BB%B4%E6%BB%B4%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97%E5%8F%91%E5%B1%95%E4%B9%8B%E8%B7%AF%E5%8F%8A%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/pro/%E6%BB%B4%E6%BB%B4%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97%E5%8F%91%E5%B1%95%E4%B9%8B%E8%B7%AF%E5%8F%8A%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5/",
            "title": "滴滴实时计算发展之路及平台架构实践",
            "date_published": "2021-05-09T16:00:00.000Z",
            "content_html": "<p>滴滴的核心业务是一个实时在线服务，因此具有丰富的实时数据和实时计算场景。本文将介绍滴滴实时计算发展之路以及平台架构实践。</p>\n<p><strong>一、实时计算演进</strong></p>\n<p>随着滴滴业务的发展，滴滴的实时计算架构也在快速演变。到目前为止大概经历了三个阶段：</p>\n<ul>\n<li>业务方自建小集群阶段；</li>\n<li>集中式大集群、平台化阶段；</li>\n<li>SQL 化阶段。</li>\n</ul>\n<p>下图标识了其中重要的里程碑，稍后会给出详细阐述：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/640\" alt=\"640?wx_fmt=jpeg\" /></p>\n<p>在 2017 年以前，滴滴并没有统一的实时计算平台，而是各个业务方自建小集群。其中用到的引擎有 Storm、JStorm、Spark Streaming、Samza 等。业务方自建小集群模式存在如下弊端：</p>\n<ul>\n<li>需要预先采购大量机器，由于单个业务独占，资源利用率通常比较低；</li>\n<li>缺乏有效的监控报警体系；</li>\n<li>维护难度大，需要牵涉业务方大量精力来保障集群的稳定性；</li>\n<li>缺乏有效技术支持，且各自沉淀的东西难以共享。</li>\n</ul>\n<p>为了有效解决以上问题，滴滴从 2017 年年初开始构建统一的实时计算集群及平台。</p>\n<p>技术选型上，我们基于滴滴现状选择了内部用大规模数据清洗的 Spark Streaming 引擎，同时引入 On-YARN 模式，并利用 YARN 的多租户体系构建了认证、鉴权、资源隔离、计费等机制。</p>\n<p>相对于离线计算，实时计算任务对于稳定性有着更高的要求，为此我们构建了两层资源隔离体系：</p>\n<ul>\n<li>第一层是基于 CGroup 做进程（Container）级别的 CPU 及内存隔离；</li>\n<li>第二层是物理机器级别的隔离。</li>\n</ul>\n<p>我们通过改造 YARN 的 FairScheduler 使其支持 Node Label。达到的效果如下图所示：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/tibrg3AoIJTvCSqW7nBQvTQfIswHvv6zWZCr5wMkxI7NpJU5LHCialxRVh84vON658M6DMykuhqfKibbc8LXVOxqA\" alt=\"640?wx_fmt=jpeg\" /></p>\n<p>普通业务的任务混跑在同一个 Label 机器上，而特殊业务的任务跑在专用 Label 的机器上。</p>\n<p>通过集中式大集群和平台化建设，基本消除了业务方自建小集群带来的弊端，实时计算也进入了第二阶段。</p>\n<p>伴随着业务的发展，我们发现 Spark Streaming 的 Micro Batch 模式在一些低延时的报警业务及在线业务上显得捉襟见肘。于是我们引入了基于 Native Streaming 模式的 Flink 作为新一代实时计算引擎。</p>\n<p>Flink 不仅延时可以做到毫秒级，而且提供了基于 Process Time/Event Time 丰富的窗口函数。基于 Flink 我们联合业务方构架了滴滴流量最大的业务网关监控系统，并快速支持了诸如乘客位置变化通知、轨迹异常检测等多个线上业务。</p>\n<p><strong>二、实时计算平台架构</strong></p>\n<p>为了最大程度方便业务方开发和管理流计算任务，我们构建了如图所示的实时计算平台：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/tibrg3AoIJTvCSqW7nBQvTQfIswHvv6zWvFZkOk4tXu4bmvSfLyvtg8jdcZYk4h5sibickfCSicZrImQLgIibnUYZ7g\" alt=\"640?wx_fmt=jpeg\" /></p>\n<p>在流计算引擎基础上提供了 StreamSQL IDE、监控报警、诊断体系、血缘关系、任务管控等能力。各自的作用如下：</p>\n<ul>\n<li>**StreamSQL IDE。** 下文会介绍，是一个 Web 化的 SQL IDE；</li>\n<li>** 监控报警。** 提供任务级的存活、延时、流量等监控以及基于监控的报警能力；</li>\n<li>** 诊断体系。** 包括流量曲线、Checkpoint、GC、资源使用等曲线视图，以及实时日志检索能力。</li>\n<li>** 血缘关系。** 我们在流计算引擎中内置了血缘上报能力，进而在平台上呈现流任务与上下游的血缘关系；</li>\n<li>** 任务管控。** 实现了多租户体系下任务提交、启停、资产管理等能力。通过 Web 化任务提交消除了传统客户机模式，使得平台入口完全可控，内置参数及版本优化得以快速上线。</li>\n</ul>\n<p><strong>三、实时规则匹配服务建设</strong></p>\n<p>在滴滴内部有大的实时运营场景，比如 “某城市乘客冒泡后 10 秒没有下单”。针对这类检测事件之间依赖关系的场景，用 Fink 的 CEP 是非常合适的。</p>\n<p>但是社区版本的 CEP 不支持描述语言，每个规则需要开发一个应用，同时不支持动态更新规则。为了解决这些问题，滴滴做了大量功能扩展及优化工作。功能扩展方面主要改动有：</p>\n<ul>\n<li>\n<p>** 支持 wait 算子。** 对于刚才例子中的运营规则，社区版本是表达不了的。滴滴通过增加 wait 算子，实现了这类需求；</p>\n</li>\n<li>\n<p>** 支持 DSL 语言。** 基于 Groovy 和 Aviator 解析引擎，我们实现了如下图所示的 DSL 描述规则能力：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/tibrg3AoIJTvCSqW7nBQvTQfIswHvv6zWPsOYFJL1AkziaNtl9fWwicZKFicTPjj43RicJsm0XElxr5IvEYibJqicicARw\" alt=\"640?wx_fmt=png\" /></p>\n</li>\n<li>\n<p>** 单任务多规则及规则动态更新。** 由于实时运营规则由一线运营同学来配置，所以规则数量，规则内容及规则生命周期会经常发生变化。这种情况每个规则一个应用是不太现实的。为此我们开发了多规则模式且支持了动态更新。</p>\n</li>\n</ul>\n<p>除了功能拓展之外，为了应对大规模运营规则的挑战，滴滴在 CEP 性能上也做了大量优化，主要有：</p>\n<ul>\n<li>**SharedBuffer 重构。** 基于 Flink MapState 重构 SharedBuffer，减少每次数据处理过程中的状态交互。同时剥离规则和用户数据极大降低每次匹配的时候从状态中反序列化的数据量；</li>\n<li>** 增加访问缓存（已贡献社区）。** 缓存 SharedBuffer 数据中每次处理所需要更新的引用计数，延缓更新；</li>\n<li>** 简化 event time 语义处理。** 避免 key 在很分散情况下每次 watermark 更新时要遍历所有 key 的数据；</li>\n<li>** 复用 conditionContext（已贡献社区）。** 减少条件查询时对 partialMatch 元素的反复查询。</li>\n</ul>\n<p>以上优化将 CEP 性能提升了多个数量级。配合功能扩展，我们在滴滴内部提供了如图所示的服务模式：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/tibrg3AoIJTvCSqW7nBQvTQfIswHvv6zW17icWVUiaXFevRlE4nPuibnRtZZzm91FzaZQytSjV7KknUBfgGFA1PRew\" alt=\"640?wx_fmt=jpeg\" /></p>\n<p>业务方只需要清洗数据并提供规则列表 API 即可具备负责规则的实时匹配能力。</p>\n<p>目前滴滴 CEP 已经在快车个性化运营、实时异常工单检测等业务上落地，取得了良好的效果。</p>\n<p><strong>四、StreamSQL 建设</strong></p>\n<p>正如离线计算中 Hive 之于 MapReduce 一样，流式 SQL 也是必然的发展趋势。通过 SQL 化可以大幅度降低业务方开发流计算的难度，业务方不再需要学习 Java/Scala，也不需要理解引擎执行细节及各类参数调优。</p>\n<p>为此我们在 2018 年启动了 StreamSQL 建设项目，在社区 Flink SQL 基础上拓展了以下能力：</p>\n<ul>\n<li>\n<p>** 扩展 DDL 语法。** 如下图所示，打通了滴滴内部主流的消息队列以及实时存储系统：</p>\n</li>\n<li>\n<p>StreamSQL 内置打通消息队列及实施存储</p>\n<p>通过内置常见消息格式（如 json、binlog、标准日志）的解析能力，使得用户可以轻松写出 DDL 语法，并避免重复写格式解析语句。</p>\n</li>\n<li>\n<p>** 拓展 UDF。** 针对滴滴内部常见处理逻辑，内置了大量 UDF，包括字符串处理、日期处理、Map 对象处理、空间位置处理等。</p>\n</li>\n<li>\n<p>** 支持分流语法。** 单个输入源多个输出流在滴滴内部非常常见，为此我们改造了 Calcite 使其支持分流语义。</p>\n</li>\n<li>\n<p>** 支持基于 TTL 的 join 语义。** 传统的 Window Join 因为存在 window 边界数据突变情况，不能满足滴滴内部的需求。为此我们引入了 TTL State，并基于此开发了基于 TTL Join 的双流 join 以及维表 join。</p>\n</li>\n<li>\n<p>**StreamSQL IDE。** 前文提到平台化之后我们没有提供客户机，而是通过 Web 提交和管控任务。因此我们也相应开发了 StreamSQL IDE，实现 Web 上开发 StreamSQL，同时提供了语法检测、DEBUG、诊断等能力。</p>\n</li>\n</ul>\n<p>目前 StreamSQL 在滴滴已经成功落地，流计算开发成本得到大幅度降低。预期未来将承担 80% 的流计算业务量。</p>\n<p><strong>五、总结</strong></p>\n<p>作为一家出行领域的互联网公司，滴滴对实时计算有天然的需求。</p>\n<p>过去的一年多时间里，我们从零构建了集中式实时计算平台，改变了业务方自建小集群的局面。为满足低延时业务的需求，成功落地了 Flink Streaming，并基于 Flink 构建了实时规则匹配（CEP）服务以及 StreamSQL，使得流计算开发能力大幅度降低。未来将进一步拓展 StreamSQL，并在批流统一、IoT、实时机器学习等领域探索和建设。</p>\n",
            "tags": [
                "大数据",
                "大厂学习"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/kafka/Kafka%E3%80%81Redis%E3%80%81Pulsar%E5%AF%B9%E6%AF%94/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/kafka/Kafka%E3%80%81Redis%E3%80%81Pulsar%E5%AF%B9%E6%AF%94/",
            "title": "Kafka、Redis、Pulsar对比",
            "date_published": "2021-03-11T16:00:00.000Z",
            "content_html": "<p><strong>一、最基础的队列</strong></p>\n<p>最基础的消息队列其实就是一个双端队列，我们可以用双向链表来实现，如下图所示：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/bcb026e372acf98f49200c94e074e7b3.png\" alt=\"img\" /></p>\n<ul>\n<li>push_front：添加元素到队首；</li>\n<li>pop_tail：从队尾取出元素。</li>\n</ul>\n<p>有了这样的数据结构之后，我们就可以在内存中构建一个消息队列，一些任务不停地往队列里添加消息，同时另一些任务不断地从队尾有序地取出这些消息。添加消息的任务我们称为 producer，而取出并使用消息的任务，我们称之为 consumer。</p>\n<p>要实现这样的内存消息队列并不难，甚至可以说很容易。但是如果要让它能在应对海量的并发读写时保持高效，还是需要下很多功夫的。</p>\n<h3 id=\"\"><a class=\"anchor\" href=\"#\">#</a> </h3>\n<p><strong>二、Redis 的队列</strong></p>\n<p>redis 刚好提供了上述的数据结构 ——list。redis list 支持：</p>\n<ul>\n<li>lpush：从队列左边插入数据；</li>\n<li>rpop：从队列右边取出数据。</li>\n</ul>\n<p>这正好对应了我们队列抽象的 push_front 和 pop_tail，因此我们可以直接把 redis 的 list 当成一个消息队列来使用。而且 redis 本身对高并发做了很好的优化，内部数据结构经过了精心地设计和优化。所以从某种意义上讲，用 redis 的 list 大概率比你自己重新实现一个 list 强很多。</p>\n<p>但另一方面，使用 redis list 作为消息队列也有一些不足，比如：</p>\n<ul>\n<li><strong>消息持久化</strong>：redis 是内存数据库，虽然有 aof 和 rdb 两种机制进行持久化，但这只是辅助手段，这两种手段都是不可靠的。当 redis 服务器宕机时一定会丢失一部分数据，这对于很多业务都是没法接受的。</li>\n<li><strong>热 key 性能问题</strong>：不论是用 codis 还是 twemproxy 这种集群方案，对某个队列的读写请求最终都会落到同一台 redis 实例上，并且无法通过扩容来解决问题。如果对某个 list 的并发读写非常高，就产生了无法解决的热 key，严重可能导致系统崩溃。</li>\n<li><strong>没有确认机制</strong>：每当执行 rpop 消费一条数据，那条消息就被从 list 中永久删除了。如果消费者消费失败，这条消息也没法找回了。你可能说消费者可以在失败时把这条消息重新投递到进队列，但这太理想了，极端一点万一消费者进程直接崩了呢，比如被 kill -9，panic，coredump…</li>\n<li><strong>不支持多订阅者</strong>：一条消息只能被一个消费者消费，rpop 之后就没了。如果队列中存储的是应用的日志，对于同一条消息，监控系统需要消费它来进行可能的报警，BI 系统需要消费它来绘制报表，链路追踪需要消费它来绘制调用关系…… 这种场景 redis list 就没办法支持了。</li>\n<li><strong>不支持二次消费</strong>：一条消息 rpop 之后就没了。如果消费者程序运行到一半发现代码有 bug，修复之后想从头再消费一次就不行了。</li>\n</ul>\n<p>对于上述的不足，目前看来第一条（持久化）是可以解决的。很多公司都有团队基于 rocksdb leveldb 进行二次开发，实现了支持 redis 协议的 kv 存储。这些存储已经不是 redis 了，但是用起来和 redis 几乎一样。它们能够保证数据的持久化，但对于上述的其他缺陷也无能为力了。</p>\n<p>其实 redis 5.0 开始新增了一个 stream 数据类型，它是专门设计成为消息队列的数据结构，借鉴了很多 kafka 的设计，但是依然还有很多问题… 直接进入到 kafka 的世界它不香吗？</p>\n<h3 id=\"-2\"><a class=\"anchor\" href=\"#-2\">#</a> </h3>\n<p><strong>三、Kafka</strong></p>\n<p>从上面你可以看到，一个真正的消息中间件不仅仅是一个队列那么简单。尤其是当它承载了公司大量业务的时候，它的功能完备性、吞吐量、稳定性、扩展性都有非常苛刻的要求。kafka 应运而生，它是专门设计用来做消息中间件的系统。</p>\n<p>前面说 redis list 的不足时，虽然有很多不足，但是如果你仔细思考，其实可以归纳为两点：</p>\n<ul>\n<li><strong>热 key 的问题无法解决</strong>，即：无法通过加机器解决性能问题；</li>\n<li><strong>数据会被删除</strong>：rpop 之后就没了，因此无法满足多个订阅者，无法重新从头再消费，无法做 ack。</li>\n</ul>\n<p>这两点也是 kafka 要解决的核心问题。</p>\n<p>热 key 的本质问题是数据都集中在一台实例上，所以想办法把它分散到多个机器上就好了。为此，kafka 提出了<strong> partition</strong> 的概念。一个队列（redis 中的 list），对应到 kafka 里叫 topic。kafka 把一个 topic 拆成了多个 partition，每个 partition 可以分散到不同的机器上，这样就可以把单机的压力分散到多台机器上。因此 topic 在 kafka 中更多是一个逻辑上的概念，实际存储单元都是 partition。</p>\n<p>其实 redis 的 list 也能实现这种效果，不过这需要在业务代码中增加额外的逻辑。比如可以建立 n 个 list，key1, key2, ..., keyn，客户端每次往不同的 key 里 push，消费端也可以同时从 key1 到 keyn 这 n 个 list 中 rpop 消费数据，这就能达到 kafka 多 partition 的效果。所以你可以看到，partition 就是一个非常朴素的概念，用来把请求分散到多台机器。</p>\n<p>redis list 中另一个大问题是 rpop 会删除数据，所以 kafka 的解决办法也很简单，不删就行了嘛。kafka 用游标（cursor）解决这个问题。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/3c2f1dbfe074e73a354013d23b3c6416.png\" alt=\"img\" /></p>\n<p>和 redis list 不同的是，首先 kafka 的 topic（实际上是 partion）是用的单向队列来存储数据的，新数据每次直接追加到队尾。同时它维护了一个游标 cursor，从头开始，每次指向即将被消费的数据的下标。每消费一条，cursor+1 。通过这种方式，kafka 也能和 redis list 一样实现先入先出的语义，但是 kafka 每次只需要更新游标，并不会去删数据。</p>\n<p>这样设计的好处太多了，尤其是性能方面，顺序写一直是最大化利用磁盘带宽的不二法门。但我们主要讲讲游标这种设计带来功能上的优势。</p>\n<p>首先可以支持消息的 ACK 机制了。由于消息不会被删除，因此可以等消费者明确告知 kafka 这条消息消费成功以后，再去更新游标。这样的话，只要 kafka 持久化存储了游标的位置，即使消费失败进程崩溃，等它恢复时依然可以重新消费</p>\n<p>第二是可以支持分组消费：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/dd8228204f43c53480c5763812e15a08.png\" alt=\"img\" /></p>\n<p>这里需要引入一个消费组的概念，这个概念非常简单，因为消费组本质上就是一组游标。对于同一个 topic，不同的消费组有各自的游标。监控组的游标指向第二条，BI 组的游标指向第 4 条，trace 组指向到了第 10000 条…… 各消费者游标彼此隔离，互不影响。</p>\n<p>通过引入消费组的概念，就可以非常容易地支持多业务方同时消费一个 topic，也就是说所谓的 1-N 的 “广播”，一条消息广播给 N 个订阅方。</p>\n<p>最后，通过游标也很容易实现重新消费。因为游标仅仅就是记录当前消费到哪一条数据了，要重新消费的话直接修改游标的值就可以了。你可以把游标重置为任何你想要指定的位置，比如重置到 0 重新开始消费，也可以直接重置到最后，相当于忽略现有所有数据。</p>\n<p>因此你可以看到，kafka 这种数据结构相比于 redis 的双向链表有了一个质的飞跃，不仅是性能上，同时也是功能上，全面的领先。</p>\n<p>我们可以来看看 kafka 的一个简单的架构图：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/40559be6f69236e00c636e6bc279d619.png\" alt=\"img\" /></p>\n<p>从这个图里我们可以看出，topic 是一个逻辑上的概念，不是一个实体。一个 topic 包含多个 partition，partition 分布在多台机器上。这个机器，kafka 中称之为<strong> broker</strong>。（kafka 集群中的一个 broker 对应 redis 集群中的一个实例）。对于一个 topic，可以有多个不同的消费组同时进行消费。一个消费组内部可以有多个消费者实例同时进行消费，这样可以提高消费速率。</p>\n<p>但是这里需要非常注意的是，一个 partition 只能被消费组中的一个消费者实例来消费。换句话说，消费组中如果有多个消费者，不能够存在两个消费者同时消费一个 partition 的场景。</p>\n<p>为什么呢？其实 kafka 要在 partition 级别提供顺序消费的语义，如果多个 consumer 消费一个 partition，即使 kafka 本身是按顺序分发数据的，但是由于网络延迟等各种情况，consumer 并不能保证按 kafka 的分发顺序接收到数据，这样达到消费者的消息顺序就是无法保证的。因此一个 partition 只能被一个 consumer 消费。kafka 各 consumer group 的游标可以表示成类似这样的数据结构：</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token property\">\"topic-foo\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token property\">\"groupA\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token property\">\"partition-0\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token property\">\"partition-1\"</span><span class=\"token operator\">:</span> <span class=\"token number\">123</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token property\">\"partition-2\"</span><span class=\"token operator\">:</span> <span class=\"token number\">78</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token property\">\"groupB\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token property\">\"partition-0\"</span><span class=\"token operator\">:</span> <span class=\"token number\">85</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token property\">\"partition-1\"</span><span class=\"token operator\">:</span> <span class=\"token number\">9991</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token property\">\"partition-2\"</span><span class=\"token operator\">:</span> <span class=\"token number\">772</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>了解了 kafka 的宏观架构，你可能会有个疑惑，kafka 的消费如果只是移动游标并不删除数据，那么随着时间的推移数据肯定会把磁盘打满，这个问题该如何解决呢？这就涉及到 kafka 的 retention 机制，也就是消息过期，类似于 redis 中的 expire。</p>\n<p>不同的是，redis 是按 key 来过期的，如果你给 redis list 设置了 1 分钟有效期，1 分钟之后 redis 直接把整个 list 删除了。而 kafka 的过期是针对消息的，不会删除整个 topic (partition)，只会删除 partition 中过期的消息。不过好在 kafka 的 partition 是单向的队列，因此队列中消息的生产时间都是有序的。因此每次过期删除消息时，从头开始删就行了。</p>\n<p>看起来似乎很简单，但仔细想一下还是有不少问题。举例来说，假如 topicA-partition-0 的所有消息被写入到一个文件中，比如就叫 topicA-partition-0.log。我们再把问题简化一下，假如生产者生产的消息在 topicA-partition-0.log 中一条消息占一行，很快这个文件就到 200G 了。现在告诉你，这个文件前 x 行失效了，你应该怎么删除呢？非常难办，这和让你删除一个数组中的前 n 个元素一样，需要把后续的元素向前移动，这涉及到大量的 CPU copy 操作。假如这个文件有 10M，这个删除操作的代价都非常大，更别说 200G 了。</p>\n<p>因此，kafka 在实际存储 partition 时又进行了一个拆分。topicA-partition-0 的数据并不是写到一个文件里，而是写到多个 segment 文件里。假如设置的一个 segment 文件大小上限是 100M，当写满 100M 时就会创建新的 segment 文件，后续的消息就写到新创建的 segment 文件，就像我们业务系统的日志文件切割一样。这样做的好处是，当 segment 中所有消息都过期时，可以很容易地直接删除整个文件。而由于 segment 中消息是有序的，看是否都过期就看最后一条是否过期就行了。</p>\n<h4 id=\"1-kafka中的数据查找\"><a class=\"anchor\" href=\"#1-kafka中的数据查找\">#</a> <strong>1. Kafka 中的数据查找</strong></h4>\n<p>topic 的一个 partition 是一个逻辑上的数组，由多个 segment 组成，如下图所示：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/1b452acde512872d8ca7fd85e3d31a01.png\" alt=\"img\" /></p>\n<p>这时候就有一个问题，如果我把游标重置到一个任意位置，比如第 2897 条消息，我怎么读取数据呢？</p>\n<p>根据上面的文件组织结构，你可以发现我们需要确定两件事才能读出对应的数据：</p>\n<ul>\n<li>第 2897 条消息在哪个 segment 文件里；</li>\n<li>第 2897 条消息在 segment 文件里的什么位置。</li>\n</ul>\n<p>为了解决上面两个问题，kafka 有一个非常巧妙的设计。首先，segment 文件的文件名是以该文件里第一条消息的 offset 来命名的。一开始的 segment 文件名是 0.log，然后一直写直到写了 18234 条消息后，发现达到了设置的文件大小上限 100M，然后就创建一个新的 segment 文件，名字是 18234.log……</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>- /kafka/topic/order_create/partition-0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    - <span class=\"token number\">0</span>.log</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    - <span class=\"token number\">18234</span>.log <span class=\"token comment\">#segment file</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - <span class=\"token number\">39712</span>.log</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - <span class=\"token number\">54101</span>.log</pre></td></tr></table></figure><p>当我们要找 offset 为 x 的消息在哪个 segment 时，只需要通过文件名做一次二分查找就行了。比如 offset 为 2879 的消息（第 2880 条消息），显然就在 0.log 这个 segment 文件里。</p>\n<p>定位到 segment 文件之后，另一个问题就是要找到该消息在文件中的位置，也就是偏移量。如果从头开始一条条地找，这个耗时肯定是无法接受的！kafka 的解决办法就是索引文件。</p>\n<p>就如 mysql 的索引一样，kafka 为每个 segment 文件创建了一个对应的索引文件。索引文件很简单，每条记录就是一个 kv 组，key 是消息的 offset，value 是该消息在 segment 文件中的偏移量：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">offset</th>\n<th style=\"text-align:left\">position</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">0</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">124</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">336</td>\n</tr>\n</tbody>\n</table>\n<p>每个 segment 文件对应一个索引文件：</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>- /kafka/topic/order_create/partition-0</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    - <span class=\"token number\">0</span>.log</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    - <span class=\"token number\">0</span>.index</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    - <span class=\"token number\">18234</span>.log <span class=\"token comment\">#segment file</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    - <span class=\"token number\">18234</span>.index <span class=\"token comment\">#index file</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - <span class=\"token number\">39712</span>.log</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    - <span class=\"token number\">39712</span>.index</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    - <span class=\"token number\">54101</span>.log</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - <span class=\"token number\">54101</span>.index</pre></td></tr></table></figure><p>有了索引文件，我们就可以拿到某条消息具体的位置，从而直接进行读取。再捋一遍这个流程：</p>\n<ul>\n<li>当要查询 offset 为 x 的消息</li>\n<li>利用二分查找找到这条消息在 y.log</li>\n<li>读取 y.index 文件找到消息 x 的 y.log 中的位置</li>\n<li>读取 y.log 的对应位置，获取数据</li>\n</ul>\n<p>通过这种文件组织形式，我们可以在 kafka 中非常快速地读取出任何一条消息。但这又引出了另一个问题，如果消息量特别大，每条消息都在 index 文件中加一条记录，这将浪费很多空间。</p>\n<p>可以简单地计算一下，假如 index 中一条记录 16 个字节（offset 8 + position 8），一亿条消息就是 16*10^8 字节 = 1.6G。对于一个稍微大一点的公司，kafka 用来收集日志的话，一天的量远远不止 1 亿条，可能是数十倍上百倍。这样的话，index 文件就会占用大量的存储。因此，权衡之下 kafka 选择了使用”<strong> 稀疏索引</strong> “。</p>\n<p>所谓稀疏索引就是并非所有消息都会在 index 文件中记录它的 position，每间隔多少条消息记录一条，比如每间隔 10 条消息记录一条 offset-position：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">offset</th>\n<th style=\"text-align:left\">position</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">0</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">10</td>\n<td style=\"text-align:left\">1852</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">20</td>\n<td style=\"text-align:left\">4518</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">30</td>\n<td style=\"text-align:left\">6006</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">40</td>\n<td style=\"text-align:left\">8756</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">50</td>\n<td style=\"text-align:left\">10844</td>\n</tr>\n</tbody>\n</table>\n<p>这样的话，如果当要查询 offset 为 x 的消息，我们可能没办法查到它的精确位置，但是可以利用二分查找，快速地确定离他最近的那条消息的位置，然后往后多读几条数据就可以读到我们想要的消息了。</p>\n<p>比如，当我们要查到 offset 为 33 的消息，按照上表，我们可以利用二分查找定位到 offset 为 30 的消息所在的位置，然后去对应的 log 文件中从该位置开始向后读取 3 条消息，第四条就是我们要找的 33。这种方式其实就是在性能和存储空间上的一个折中，很多系统设计时都会面临类似的选择，牺牲时间换空间还是牺牲空间换时间。</p>\n<p>到这里，我们对 kafka 的整体架构应该有了一个比较清晰的认识了。不过在上面的分析中，我故意隐去了 kafka 中另一个非常非常重要的点，就是高可用方面的设计。因为这部分内容比较晦涩，会引入很多分布式理论的复杂性，妨碍我们理解 kafka 的基本模型。在接下来的部分，将着重讨论这个主题。</p>\n<h4 id=\"2-kafka高可用\"><a class=\"anchor\" href=\"#2-kafka高可用\">#</a> <strong>2. Kafka 高可用</strong></h4>\n<p>高可用（HA）对于企业的核心系统来说是至关重要的。因为随着业务的发展，集群规模会不断增大，而大规模集群中总会出现故障，硬件、网络都是不稳定的。当系统中某些节点各种原因无法正常使用时，整个系统可以容忍这个故障，继续正常对外提供服务，这就是所谓的高可用性。对于有状态服务来说，容忍局部故障本质上就是容忍丢数据（不一定是永久，但是至少一段时间内读不到数据）。</p>\n<p>系统要容忍丢数据，最朴素也是唯一的办法就是做备份，让同一份数据复制到多台机器，所谓的<strong>冗余</strong>，或者说<strong>多副本</strong>。为此，kafka 引入 leader-follower 的概念。topic 的每个 partition 都有一个 leader，所有对这个 partition 的读写都在该 partition leader 所在的 broker 上进行。partition 的数据会被复制到其它 broker 上，这些 broker 上对应的 partition 就是 follower:</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/16d56aa1d2945a73113142c7348ece1b.png\" alt=\"img\" /></p>\n<p>producer 在生产消息时，会直接把消息发送到 partition leader 上，partition leader 把消息写入自己的 log 中，然后等待 follower 来拉取数据进行同步。具体交互如下：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/60966465a573abc9ac1e2073db6d712e.png\" alt=\"img\" /></p>\n<p>上图中对 producer 进行 ack 的时机非常关键，这直接关系到 kafka 集群的可用性和可靠性。</p>\n<ul>\n<li>\n<p>如果 producer 的数据到达 leader 并成功写入 leader 的 log 就进行 ack</p>\n<p><strong>优点</strong>：不用等数据同步完成，速度快，吞吐率高，可用性高；</p>\n<p><strong>缺点</strong>：如果 follower 数据同步未完成时 leader 挂了，就会造成数据丢失，可靠性低。</p>\n</li>\n<li>\n<p>如果等 follower 都同步完数据时进行 ack</p>\n<p><strong>优点</strong>：当 leader 挂了之后 follower 中也有完备的数据，可靠性高；</p>\n<p><strong>缺点</strong>：等所有 follower 同步完成很慢，性能差，容易造成生产方超时，可用性低。</p>\n</li>\n</ul>\n<p>而具体什么时候进行 ack，对于 kafka 来说是可以根据实际应用场景配置的。</p>\n<p>其实 kafka 真正的数据同步过程还是非常复杂的，本文主要是想讲一讲 kafka 的一些核心原理，数据同步里面涉及到的很多技术细节，HW epoch 等，就不在此一一展开了。最后展示一下 kafka 的一个全景图：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/56e585f54a703fdc8a74d42af833c245.png\" alt=\"img\" /></p>\n<p>最后对 kafka 进行一个简要地总结：kafka 通过引入 partition 的概念，让 topic 能够分散到多台 broker 上，提高吞吐率。但是引入多 partition 的代价就是无法保证 topic 维度的全局顺序性，需要这种特性的场景只能使用单个 partition。在内部，每个 partition 以多个 segment 文件的方式进行存储，新来的消息 append 到最新的 segment log 文件中，并使用稀疏索引记录消息在 log 文件中的位置，方便快速读取消息。当数据过期时，直接删除过期的 segment 文件即可。为了实现高可用，每个 partition 都有多个副本，其中一个是 leader，其它是 follower，分布在不同的 broker 上。对 partition 的读写都在 leader 所在的 broker 上完成，follower 只会定时地拉取 leader 的数据进行同步。当 leader 挂了，系统会选出和 leader 保持同步的 follower 作为新的 leader，继续对外提供服务，大大提高可用性。在消费端，kafka 引入了消费组的概念，每个消费组都可以互相独立地消费 topic，但一个 partition 只能被消费组中的唯一一个消费者消费。消费组通过记录游标，可以实现 ACK 机制、重复消费等多种特性。除了真正的消息记录在 segment 中，其它几乎所有 meta 信息都保存在全局的 zookeeper 中。</p>\n<h4 id=\"3-优缺点\"><a class=\"anchor\" href=\"#3-优缺点\">#</a> <strong>3. 优缺点</strong></h4>\n<p><strong>（1）优点：kafka 的优点非常多</strong></p>\n<ul>\n<li>高性能：单机测试能达到 100w tps；</li>\n<li>低延时：生产和消费的延时都很低，e2e 的延时在正常的 cluster 中也很低；</li>\n<li>可用性高：replicate + isr + 选举 机制保证；</li>\n<li>工具链成熟：监控 运维 管理 方案齐全；</li>\n<li>生态成熟：大数据场景必不可少 kafka stream.</li>\n</ul>\n<p><strong>（2）不足</strong></p>\n<ul>\n<li>无法弹性扩容：对 partition 的读写都在 partition leader 所在的 broker，如果该 broker 压力过大，也无法通过新增 broker 来解决问题；</li>\n<li>扩容成本高：集群中新增的 broker 只会处理新 topic，如果要分担老 topic-partition 的压力，需要手动迁移 partition，这时会占用大量集群带宽；</li>\n<li>消费者新加入和退出会造成整个消费组 rebalance：导致数据重复消费，影响消费速度，增加 e2e 延迟；</li>\n<li>partition 过多会使得性能显著下降：ZK 压力大，broker 上 partition 过多让磁盘顺序写几乎退化成随机写。</li>\n</ul>\n<p>在了解了 kafka 的架构之后，你可以仔细想一想，为什么 kafka 扩容这么费劲呢？其实这本质上和 redis 集群扩容是一样的！当 redis 集群出现热 key 时，某个实例扛不住了，你通过加机器并不能解决什么问题，因为那个热 key 还是在之前的某个实例中，新扩容的实例起不到分流的作用。kafka 类似，它扩容有两种：新加机器（加 broker）以及给 topic 增加 partition。给 topic 新加 partition 这个操作，你可以联想一下 mysql 的分表。比如用户订单表，由于量太大把它按用户 id 拆分成 1024 个子表 user_order_{0..1023}，如果到后期发现还不够用，要增加这个分表数，就会比较麻烦。因为分表总数增多，会让 user_id 的 hash 值发生变化，从而导致老的数据无法查询。所以只能停服做数据迁移，然后再重新上线。kafka 给 topic 新增 partition 一样的道理，比如在某些场景下 msg 包含 key，那 producer 就要保证相同的 key 放到相同的 partition。但是如果 partition 总量增加了，根据 key 去进行 hash，比如 hash (key) % parition_num，得到的结果就不同，就无法保证相同的 key 存到同一个 partition。当然也可以在 producer 上实现一个自定义的 partitioner，保证不论怎么扩 partition 相同的 key 都落到相同的 partition 上，但是这又会使得新增加的 partition 没有任何数据。</p>\n<p>其实你可以发现一个问题，kafka 的核心复杂度几乎都在存储这一块。数据如何分片，如何高效的存储，如何高效地读取，如何保证一致性，如何从错误中恢复，如何扩容再平衡……</p>\n<p>上面这些不足总结起来就是一个词：scalebility。通过直接加机器就能解决问题的系统才是大家的终极追求。Pulsar 号称云原生时代的分布式消息和流平台，所以接下来我们看看 pulsar 是怎么样的。</p>\n<h3 id=\"-3\"><a class=\"anchor\" href=\"#-3\">#</a> </h3>\n<p><strong>四、Pulsar</strong></p>\n<p>kafka 的核心复杂度是它的存储，高性能、高可用、低延迟、支持快速扩容的分布式存储不仅仅是 kafka 的需求，应该是现代所有系统共同的追求。而 apache 项目底下刚好有一个专门就是为日志存储打造的这样的系统，它叫 bookeeper！</p>\n<p>有了专门的存储组件，那么实现一个消息系统剩下的就是如何来使用这个存储系统来实现 feature 了。pulsar 就是这样一个” 计算 - 存储 分离 “的消息系统：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/a392b078534a9a1d34e7ce03cf6c14e2.png\" alt=\"img\" /></p>\n<p>pulsar 利用 bookeeper 作为存储服务，剩下的是计算层。这其实是目前非常流行的架构也是一种趋势，很多新型的存储都是这种” 存算分离 “的架构。比如 tidb，底层存储其实是 tikv 这种 kv 存储。tidb 是更上层的计算层，自己实现 sql 相关的功能。还有的例子就是很多 &quot;持久化&quot;redis 产品，大部分底层依赖于 rocksdb 做 kv 存储，然后基于 kv 存储关系实现 redis 的各种数据结构。</p>\n<p>在 pulsar 中，broker 的含义和 kafka 中的 broker 是一致的，就是一个运行的 pulsar 实例。但是和 kafka 不同的是，pulsar 的 broker 是无状态服务，它只是一个”API 接口层 “，负责处理海量的用户请求，当用户消息到来时负责调用 bookeeper 的接口写数据，当用户要查询消息时从 bookeeper 中查数据，当然这个过程中 broker 本身也会做很多缓存之类的。同时 broker 也依赖于 zookeeper 来保存很多元数据的关系。</p>\n<p>由于 broker 本身是无状态的，因此这一层可以非常非常容易地进行扩容，尤其是在 k8s 环境下，点下鼠标的事儿。至于消息的持久化，高可用，容错，存储的扩容，这些都通通交给 bookeeper 来解决。</p>\n<p>但就像能量守恒定律一样，系统的复杂性也是守恒的。实现既高性能又可靠的存储需要的技术复杂性，不会凭空消失，只会从一个地方转移到另一个地方。就像你写业务逻辑，产品经理提出了 20 个不同的业务场景，就至少对应 20 个 if else，不论你用什么设计模式和架构，这些 if else 不会被消除，只会从从一个文件放到另一个文件，从一个对象放到另一个对象而已。所以那些复杂性一定会出现在 bookeeper 中，并且会比 kafka 的存储实现更为复杂。</p>\n<p>但是 pulsar 存算分离架构的一个好处就是，当我们在学习 pulsar 时可以有一个比较明确的界限，所谓的 concern segregation。只要理解 bookeeper 对上层的 broker 提供的 API 语义，即使不了解 bookeeper 内部的实现，也能很好的理解 pulsar 的原理。</p>\n<p>接下来你可以思考一个问题：既然 pulsar 的 broker 层是无状态的服务，那么我们是否可以随意在某个 broker 进行对某个 topic 的数据生产呢？</p>\n<p>看起来似乎没什么问题，但答案还是否定的 —— 不可以。为什么呢？想一想，假如生产者可以在任意一台 broker 上对 topic 进行生产，比如生产 3 条消息 a b c，三条生产消息的请求分别发送到 broker A B C，那最终怎么保证消息按照 a b c 的顺序写入 bookeeper 呢？这是没办法保证，只有让 a b c 三条消息都发送到同一台 broker，才能保证消息写入的顺序。</p>\n<p>既然如此，那似乎又回到和 kafka 一样的问题，如果某个 topic 写入量特别特别大，一个 broker 扛不住怎么办？所以 pulsar 和 kafka 一样，也有 partition 的概念。一个 topic 可以分成多个 partition，为了每个 partition 内部消息的顺序一致，对每个 partition 的生产必须对应同一台 broker。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/bd4f953a31b8a90a2cacb86855e27d4f.png\" alt=\"img\" /></p>\n<p>这里看起来似乎和 kafka 没区别，也是每个 partition 对应一个 broker，但是其实差别很大。为了保证对 partition 的顺序写入，不论 kafka 还是 pulsar 都要求写入请求发送到 partition 对应的 broker 上，由该 broker 来保证写入的顺序性。然而区别在于，kafka 同时会把消息存储到该 broker 上，而 pulsar 是存储到 bookeeper 上。这样的好处是，当 pulsar 的某台 broker 挂了，可以立刻把 partition 对应的 broker 切换到另一个 broker，只要保证全局只有一个 broker 对 topic-partition-x 有写权限就行了，本质上只是做一个所有权转移而已，不会有任何数据的搬迁。</p>\n<p>当对 partition 的写请求到达对应 broker 时，broker 就需要调用 bookeeper 提供的接口进行消息存储。和 kafka 一样，pulsar 在这里也有 segment 的概念，而且和 kafka 一样的是，pulsar 也是以 segment 为单位进行存储的（respect respect respect）。</p>\n<p>为了说清楚这里，就不得不引入一个 bookeeper 的概念，叫 ledger，也就是账本。可以把 ledger 类比为文件系统上的一个文件，比如在 kafka 中就是写入到 xxx.log 这个文件里。pulsar 以 segment 为单位，存入 bookeeper 中的 ledger。</p>\n<p>在 bookeeper 集群中每个节点叫 bookie（为什么集群的实例在 kafka 叫 broker 在 bookeeper 又叫 bookie…… 无所谓，名字而已，作者写了那么多代码，还不能让人开心地命个名啊）。在实例化一个 bookeeper 的 writer 时，就需要提供 3 个参数：</p>\n<ul>\n<li>节点数 n：bookeeper 集群的 bookie 数；</li>\n<li>副本数 m：某一个 ledger 会写入到 n 个 bookie 中的 m 个里，也就是说所谓的 m 副本；</li>\n<li>确认写入数 t：每次向 ledger 写入数据时（并发写入到 m 个 bookie），需要确保收到 t 个 acks，才返回成功。</li>\n</ul>\n<p>bookeeper 会根据这三个参数来为我们做复杂的数据同步，所以我们不用担心那些副本啊一致性啊的东西，直接调 bookeeper 的提供的 append 接口就行了，剩下的交给它来完成。</p>\n<p><a href=\"http://mp.weixin.qq.com/s?__biz=MzIxMTE0ODU5NQ%3D%3D&amp;chksm=8f5ae249b82d6b5f486d4f0d861417abc45b46f04b88ad8b95f46f1bdde8fc3c038700d5240b&amp;idx=2&amp;mid=2650245141&amp;scene=21&amp;sn=0f60792baff42d2070b10f045d8557d8#wechat_redirect\"><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/f954135e627f7b2c24ea441c56f9c468.png\" alt=\"img\" /></a></p>\n<p>如上图所示，parition 被分为了多个 segment，每个 segment 会写入到 4 个 bookie 其中的 3 个中。比如 segment1 就写入到了 bookie1,2,4 中，segment2 写入到 bookie1,3,4 中…</p>\n<p>这其实就相当于把 kafka 某个 partition 的 segment 均匀分布到了多台存储节点上。这样的好处是什么呢？在 kafka 中某个 partition 是一直往同一个 broker 的文件系统中进行写入，当磁盘不够用了，就需要做非常麻烦的扩容 + 迁移数据的操作。而对于 pulsar，由于 partition 中不同 segment 可以保存在 bookeeper 不同的 bookies 上，当大量写入导致现有集群 bookie 磁盘不够用时，我们可以快速地添加机器解决问题，让新的 segment 寻找最合适的 bookie（磁盘空间剩余最多或者负载最低等）进行写入，只要记住 segment 和 bookies 的关系就好了。</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/2c14c19b2200c6aa27555da27fd0c9f5.png\" alt=\"img\" /></p>\n<p>由于 partition 以 segment 为粒度均匀的分散到 bookeeper 上的节点上，这使得存储的扩容变得非常非常容易。这也是 Pulsar 一直宣称的存算分离架构的先进性的体现：</p>\n<ul>\n<li>broker 是无状态的，随便扩容；</li>\n<li>partition 以 segment 为单位分散到整个 bookeeper 集群，没有单点，也可以轻易地扩容；</li>\n<li>当某个 bookie 发生故障，由于多副本的存在，可以另外 t-1 个副本中随意选出一个来读取数据，不间断地对外提供服务，实现高可用。</li>\n</ul>\n<p>其实在理解 kafka 的架构之后再来看 pulsar，你会发现 pulsar 的核心就在于 bookeeper 的使用以及一些 metadata 的存储。但是换个角度，正是这个恰当的存储和计算分离的架构，帮助我们分离了关注点，从而能够快速地去学习上手。</p>\n<h4 id=\"消费模型\"><a class=\"anchor\" href=\"#消费模型\">#</a> <strong>消费模型</strong></h4>\n<p>Pulsar 相比于 kafka 另一个比较先进的设计就是对消费模型的抽象，叫做 subscription。通过这层抽象，可以支持用户各种各样的消费场景。还是和 kafka 进行对比，kafka 中只有一种消费模式，即一个或多个 partition 对一个 consumer。如果想要让一个 partition 对多个 consumer，就无法实现了。pulsar 通过 subscription，目前支持 4 种消费方式：</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/595208caa0b30ebdc58c3936fe847329.png\" alt=\"img\" /></p>\n<p>可以把 pulsar 的 subscription 看成 kafka 的 consumer group，但 subscription 更进一步，可以设置这个”consumer group“的消费类型：</p>\n<ul>\n<li>exclusive：消费组里有且仅有一个 consumer 能够进行消费，其它的根本连不上 pulsar；</li>\n<li>failover：消费组里的每个消费者都能连上每个 partition 所在的 broker，但有且仅有一个 consumer 能消费到数据。当这个消费者崩溃了，其它的消费者会被选出一个来接班；</li>\n<li>shared：消费组里所有消费者都能消费 topic 中的所有 partition，消息以 round-robin 的方式来分发；</li>\n<li>key-shared：消费组里所有消费者都能消费到 topic 中所有 partition，但是带有相同 key 的消息会保证发送给同一个消费者。</li>\n</ul>\n<p>这些消费模型可以满足多种业务场景，用户可以根据实际情况进行选择。通过这层抽象，pulsar 既支持了 queue 消费模型，也支持了 stream 消费模型，还可以支持其它无数的消费模型（只要有人提 pr），这就是 pulsar 所说的统一了消费模型。</p>\n<p>其实在消费模型抽象的底下，就是不同的 cursor 管理逻辑。怎么 ack，游标怎么移动，怎么快速查找下一条需要重试的 msg…… 这都是一些技术细节，但是通过这层抽象，可以把这些细节进行隐藏，让大家更关注于应用。</p>\n<h3 id=\"-4\"><a class=\"anchor\" href=\"#-4\">#</a> </h3>\n<p><strong>五、存算分离架构</strong></p>\n<p>其实技术的发展都是螺旋式的，很多时候你会发现最新的发展方向又回到了 20 年前的技术路线了。</p>\n<p>在 20 年前，由于普通计算机硬件设备的局限性，对大量数据的存储是通过 NAS (Network Attached Storage) 这样的 “云端” 集中式存储来完成。但这种方式的局限性也很多，不仅需要专用硬件设备，而且最大的问题就是难以扩容来适应海量数据的存储。</p>\n<p>数据库方面也主要是以 Oracle 小型机为主的方案。然而随着互联网的发展，数据量越来越大，Google 后来又推出了以普通计算机为主的分布式存储方案，任意一台计算机都能作为一个存储节点，然后通过让这些节点协同工作组成一个更大的存储系统，这就是 HDFS。</p>\n<p>然而移动互联网使得数据量进一步增大，并且 4G 5G 的普及让用户对延迟也非常敏感，既要可靠，又要快，又要可扩容的存储逐渐变成了一种企业的刚需。而且随着时间的推移，互联网应用的流量集中度会越来越高，大企业的这种刚需诉求也越来越强烈。</p>\n<p>因此，可靠的分布式存储作为一种基础设施也在不断地完善。它们都有一个共同的目标，就是让你像使用 filesystem 一样使用它们，并且具有高性能高可靠自动错误恢复等多种功能。然而我们需要面对的一个问题就是 CAP 理论的限制，线性一致性（C），可用性（A），分区容错性（P），三者只能同时满足两者。因此不可能存在完美的存储系统，总有那么一些 “不足”。我们需要做的其实就是根据不同的业务场景，选用合适的存储设施，来构建上层的应用。这就是 pulsar 的逻辑，也是 tidb 等 newsql 的逻辑，也是未来大型分布式系统的基本逻辑，所谓的 “云原生”。</p>\n",
            "tags": [
                "大数据",
                "Kafka"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/1_Nginx/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/flink/1_Nginx/",
            "title": "负载均衡Nginx的使用",
            "date_published": "2020-09-20T16:00:00.000Z",
            "content_html": "<h2 id=\"负载均衡nginx的使用\"><a class=\"anchor\" href=\"#负载均衡nginx的使用\">#</a> 负载均衡 Nginx 的使用</h2>\n<hr />\n<blockquote>\n<p>该部分从属于数据采集部分，主要作用为实现几台数采服务器的负载均衡，因涉及新的技术 ---Nginx，所以单独成为一个 part</p>\n</blockquote>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20200719233514.png\" alt=\"1594748402220\" /></p>\n<h3 id=\"11-nginx概述\"><a class=\"anchor\" href=\"#11-nginx概述\">#</a> 1.1 Nginx 概述</h3>\n<p>Nginx 是一个高性能的 HTTP 和反向代理服务器，特点是占有内存少，并发能力强</p>\n<ul>\n<li>与 tomcat 的关系</li>\n</ul>\n<p>除了 tomcat 以外， apache,nginx,jboss,jetty 等都是 http 服务器。</p>\n<p>nginx 和 apache 只支持静态页面和 CGI 协议的动态语言，比如 perl 、 php 等， 但是 nginx 不支持 java 。</p>\n<p>Java 程序只能通过与 tomcat 配合完成。   nginx 与 tomcat 配合，为 tomcat 集群提供反向代理服务、负载均衡等服务</p>\n<h4 id=\"111-nginx三大功能\"><a class=\"anchor\" href=\"#111-nginx三大功能\">#</a> 1.1.1 Nginx 三大功能</h4>\n<h5 id=\"反向代理\"><a class=\"anchor\" href=\"#反向代理\">#</a> 反向代理</h5>\n<ul>\n<li>正向代理</li>\n</ul>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20200719233520.png\" alt=\"1594748623769\" /></p>\n<blockquote>\n<p>服务器代理用户的请求，从用户的角度看，没法直接获取请求，需要通过代理<br />\n特点：代理用户，用户清楚知道访问哪台服务器</p>\n</blockquote>\n<ul>\n<li>反向代理</li>\n</ul>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20200719233526.png\" alt=\"1594748632948\" /></p>\n<blockquote>\n<p>反向代理：服务器代理真正服务器，用户不确定去哪台真实服务器，</p>\n</blockquote>\n<h5 id=\"负载均衡\"><a class=\"anchor\" href=\"#负载均衡\">#</a> 负载均衡</h5>\n<p>・轮询（默认） 每个请求按时间顺序逐一分配到不同的后端服务器，如果后端某台服务器宕机，则自动剔除故障机器，使用户访问不受影响</p>\n<p>・weight 指定轮询权重，weight 值越大，分配到的几率就越高，主要用于后端每台服务器性能不均衡的情况。</p>\n<p>・备机模式 平时不工作，只有其他 down 机的时候才会开始工作</p>\n<p>・公平模式 (第三方) 更智能的一个负载均衡算法，此算法可以根据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。如果想要使用此调度算法，需要 Nginx 的 upstream_fair 模块。</p>\n<h5 id=\"动静分离\"><a class=\"anchor\" href=\"#动静分离\">#</a> 动静分离</h5>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20200719233531.png\" alt=\"1594748722077\" /></p>\n<h3 id=\"12-nginx安装\"><a class=\"anchor\" href=\"#12-nginx安装\">#</a> 1.2 Nginx 安装</h3>\n<ul>\n<li>yum 安装依赖包</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> yum -y <span class=\"token function\">install</span>    openssl openssl-devel pcre pcre-devel    zlib zlib-devel gcc gcc-c++</pre></td></tr></table></figure><ul>\n<li>下载 Nginx</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/opt/software » <span class=\"token function\">wget</span> http://nginx.org/download/nginx-1.12.2.tar.gz</pre></td></tr></table></figure><ul>\n<li>解压</li>\n</ul>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">tar</span> -zxvf nginx-1.12.2.tar.gz -C /opt/module</pre></td></tr></table></figure><ul>\n<li>编译和安装</li>\n</ul>\n<p>进入解压缩的目录</p>\n<p>为了防止出现权限问题，建议切换到 root 用户</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./configure   --prefix<span class=\"token operator\">=</span>/usr/local/webserver/nginx</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">make</span> <span class=\"token function\">install</span></pre></td></tr></table></figure><ul>\n<li><strong>启停 Nginx</strong></li>\n</ul>\n<p>进入目录: /usr/local/webserver/nginx</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>启动 nginx: sbin/nginx</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>关闭 nginx: sbin/nginx -s stop</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>重新加载: sbin/nginx -s reload</pre></td></tr></table></figure><blockquote>\n<p>注意：</p>\n<ul>\n<li>Nginx 默认使用的是 80 端口，由于非 root 用户不能使用 1024 以内的端口，所以建议使用 root 用户启动 Nginx</li>\n<li>如果使用普通用户启动 Nginx, 需要先执行下面的命令来突破上面的限制:</li>\n</ul>\n<pre><code>sudo setcap cap_net_bind_service=+eip /usr/local/webserver/nginx\n</code></pre>\n</blockquote>\n<ul>\n<li>查看 Nginx 进程</li>\n</ul>\n<p>![1594748930149](<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saWFuLXpwLm9zcy1jbi1zaGVuemhlbi5hbGl5dW5jcy5jb20vcGlj\">https://lian-zp.oss-cn-shenzhen.aliyuncs.com/pic</span> GO/20200719233543.png)</p>\n<p>通过网页访问: <span class=\"exturl\" data-url=\"aHR0cDovL2hhZG9vcDEwOQ==\">http://hadoop109</span></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20200719233548.png\" alt=\"1594748945767\" /></p>\n<h3 id=\"13-配置负载均衡\"><a class=\"anchor\" href=\"#13-配置负载均衡\">#</a> 1.3 配置负载均衡</h3>\n<h4 id=\"131-nginx配置修改\"><a class=\"anchor\" href=\"#131-nginx配置修改\">#</a> 1.3.1 Nginx 配置修改</h4>\n<ul>\n<li>修改 /usr/local/webserver/nginx/conf/nginx.conf</li>\n</ul>\n<figure class=\"highlight properties\"><figcaption data-lang=\".properties\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token attr-name\">http</span> <span class=\"token attr-value\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    .....</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">    # 配置上游服务器：其实就被代理的服务器，springboot</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token attr-name\">    upstream</span> <span class=\"token attr-value\">logserver&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token attr-name\">        server</span> <span class=\"token attr-value\">hadoop109:8081 weight=1;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token attr-name\">        server</span> <span class=\"token attr-value\">hadoop110:8081 weight=1;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token attr-name\">        server</span> <span class=\"token attr-value\">hadoop111:8081 weight=1;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token attr-name\">    server</span> <span class=\"token attr-value\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token attr-name\">        listen</span> <span class=\"token attr-value\">      80;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token attr-name\">        server_name</span> <span class=\"token attr-value\"> logserver;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token attr-name\">        location</span> <span class=\"token attr-value\">/ &#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token attr-name\">            root</span> <span class=\"token attr-value\">  html;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token attr-name\">            index</span> <span class=\"token attr-value\"> index.html index.htm;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">            # 配置代理</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token attr-name\">            proxy_pass</span> <span class=\"token attr-value\">http://logserver;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token attr-name\">            proxy_connect_timeout</span> <span class=\"token attr-value\">10;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        &#125;</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        ...</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>&#125;</pre></td></tr></table></figure><blockquote>\n<p><strong>Q：为什么不配置日志服务器端口为 8080</strong></p>\n<p>在 kafka 启动消费数据前要先打开 zookeeper 集群，在 zookeeper3.5.0 之后的版本中，集群打开后会默认占用 8080 端口</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>atguigu@hadoop109 module<span class=\"token punctuation\">]</span>$ jps</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">13317</span> Jps</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">13229</span> QuorumPeerMain</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>atguigu@hadoop109 module<span class=\"token punctuation\">]</span>$ <span class=\"token function\">netstat</span> -tunlp <span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span>Not all processes could be identified, non-owned process info</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>will not be shown, you would have to be root to see it all.<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8080                 :::*                    LISTEN      <span class=\"token number\">13229</span>/java</pre></td></tr></table></figure><p>通过观察日志可以发现确实启动了一个叫 adminServer 的服务</p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20200719233556.png\" alt=\"1594749317598\" /></p>\n<p>这是一个内嵌的 jetty 服务。如果想在 zookeeper 上解决这个问题，有以下三种方法</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>（1）.删除jetty。（2）修改端口。修改方法的方法有两种，一种是在启动脚本中增加 -Dzookeeper.admin.serverPort<span class=\"token operator\">=</span>你的端口号.一种是在zoo.cfg中增加admin.serverPort<span class=\"token operator\">=</span>没有被占用的端口号（3）停用这个服务，在启动脚本中增加”-Dzookeeper.admin.enableServer<span class=\"token operator\">=</span>false”</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">netstat</span> -tunlp<span class=\"token operator\">|</span><span class=\"token function\">grep</span> 端口号 查看占用端口的进程</pre></td></tr></table></figure></blockquote>\n<h4 id=\"132-日志采集服务器群起脚本制作\"><a class=\"anchor\" href=\"#132-日志采集服务器群起脚本制作\">#</a> 1.3.2 日志采集服务器群起脚本制作</h4>\n<p>分别在 3 个节点启动 jar 比较麻烦，制作统一启动脚本.</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/bashcase $1 in    \"start\")    &#123;        for i in hadoop201 hadoop202 hadoop203        do            echo \"========启动日志服务: $i===============\"            ssh $i  \"source /etc/profile ; java -jar /opt/module/gmall/gmall-logger-1.0-SNAPSHOT.jar >/dev/null 2>&amp;1  &amp;\"        done     &#125;;;    \"stop\")    &#123;        for i in hadoop201 hadoop202 hadoop203        do            echo \"========关闭日志服务: $i===============\"            ssh $i \"ps -ef|grep gmall-logger-1.0-SNAPSHOT.jar | grep -v grep|awk '&#123;print \\$2&#125;'|xargs kill\" >/dev/null 2>&amp;1        done    &#125;;;        *)    &#123;        echo 启动姿势不对, 请使用参数 start 启动日志服务, 使用参数 stop 停止服务    &#125;;;esac</span></pre></td></tr></table></figure><h4 id=\"133-其他操作\"><a class=\"anchor\" href=\"#133-其他操作\">#</a> 1.3.3 其他操作</h4>\n<ul>\n<li>分发启动采集服务器 jar 包到其余设备</li>\n<li>给编写好的脚本增加执行权限</li>\n<li>启动 Nginx</li>\n<li>启动脚本</li>\n</ul>\n<blockquote>\n<p>脚本编写的注意事项：</p>\n<p>如果在 windows 环境下编写脚本后复制到 linux 系统中出现如下报错：</p>\n<pre><code>bad interpreter:/bin/bash^M: no such file or directory\n</code></pre>\n<p>是因为在 window 下写的脚本回车的时候使用的是 \\r\\n, 而在 linux 使用 \\n 就可以了，所在每行的末尾多了一个 \\r.</p>\n<p>使用下面的命令去掉行尾的 \\r:</p>\n<pre><code>sed -i -e 's/\\r$//' gmall_cluster\n</code></pre>\n</blockquote>\n<ul>\n<li>测试日志生成能否在集群中生成落盘日志与控制台打印</li>\n</ul>\n",
            "tags": [
                "大数据",
                "Flink"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/hive/leetcode%E6%95%B0%E6%8D%AE%E5%BA%93%E9%A2%98%E7%9B%AE1-123%E9%A2%98%EF%BC%8820-08-14)/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/hive/leetcode%E6%95%B0%E6%8D%AE%E5%BA%93%E9%A2%98%E7%9B%AE1-123%E9%A2%98%EF%BC%8820-08-14)/",
            "title": "力扣数据库",
            "date_published": "2020-08-31T16:00:00.000Z",
            "content_html": "<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXNldC9kYXRhYmFzZS8=\">https://leetcode-cn.com/problemset/database/</span></p>\n<p>题目都是 leetcode 上了可以点击题目会有相应的链接</p>\n<p>由于个人比较喜欢用开窗函数，所以都优先用了开窗 ，当然这些并不一定都是最优解，答案仅供参考</p>\n<p>每道题后面都应相应的难度等级，如果没时间做的话 可以在 leetcode 按出题频率刷题</p>\n<p>我是安顺序刷的题，后续还会继续更新</p>\n<p>祝大家面试取得好的成绩</p>\n</blockquote>\n<h4 id=\"175-组合两个表\"><a class=\"anchor\" href=\"#175-组合两个表\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY29tYmluZS10d28tdGFibGVzLw==\">175. 组合两个表</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表 1:  <code>Person</code></p>\n<pre><code>+-------------+---------+\n| 列名         | 类型     |\n+-------------+---------+\n| PersonId    | int     |\n| FirstName   | varchar |\n| LastName    | varchar |\n+-------------+---------+\nPersonId 是上表主键\n</code></pre>\n<p>表 2:  <code>Address</code></p>\n<pre><code>+-------------+---------+\n| 列名         | 类型    |\n+-------------+---------+\n| AddressId   | int     |\n| PersonId    | int     |\n| City        | varchar |\n| State       | varchar |\n+-------------+---------+\nAddressId 是上表主键\n</code></pre>\n<p>编写一个 SQL 查询，满足条件：无论 person 是否有地址信息，都需要基于上述两表提供 person 的以下信息：</p>\n<pre><code>FirstName, LastName, City, State\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> FirstName<span class=\"token punctuation\">,</span>LastName<span class=\"token punctuation\">,</span>City<span class=\"token punctuation\">,</span>State</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Person  p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span>  Address a </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>PersonId <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>PersonId</pre></td></tr></table></figure><h4 id=\"176-第二高的薪水\"><a class=\"anchor\" href=\"#176-第二高的薪水\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2Vjb25kLWhpZ2hlc3Qtc2FsYXJ5Lw==\">176. 第二高的薪水</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>编写一个 SQL 查询，获取  <code>Employee</code>  表中第二高的薪水（Salary） 。</p>\n<pre><code>+----+--------+\n| Id | Salary |\n+----+--------+\n| 1  | 100    |\n| 2  | 200    |\n| 3  | 300    |\n+----+--------+\n</code></pre>\n<p>例如上述  <code>Employee</code>  表，SQL 查询应该返回  <code>200</code>  作为第二高的薪水。如果不存在第二高的薪水，那么查询应返回  <code>null</code> 。</p>\n<pre><code>+---------------------+\n| SecondHighestSalary |\n+---------------------+\n| 200                 |\n+---------------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    IFNULL<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span> Salary</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>       <span class=\"token keyword\">FROM</span> Employee</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>       <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> Salary <span class=\"token keyword\">DESC</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">1</span> <span class=\"token keyword\">OFFSET</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> SecondHighestSalary</pre></td></tr></table></figure><h4 id=\"177-第n高的薪水\"><a class=\"anchor\" href=\"#177-第n高的薪水\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbnRoLWhpZ2hlc3Qtc2FsYXJ5Lw==\">177. 第 N 高的薪水</span></h4>\n<p>难度中等</p>\n<p>编写一个 SQL 查询，获取  <code>Employee</code>  表中第 <em>n</em> 高的薪水（Salary）。</p>\n<pre><code>+----+--------+\n| Id | Salary |\n+----+--------+\n| 1  | 100    |\n| 2  | 200    |\n| 3  | 300    |\n+----+--------+\n</code></pre>\n<p>例如上述  <code>Employee</code>  表，<em>n = 2</em> 时，应返回第二高的薪水  <code>200</code> 。如果不存在第 <em>n</em> 高的薪水，那么查询应返回  <code>null</code> 。</p>\n<pre><code>+------------------------+\n| getNthHighestSalary(2) |\n+------------------------+\n| 200                    |\n+------------------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">FUNCTION</span> getNthHighestSalary<span class=\"token punctuation\">(</span>N <span class=\"token keyword\">INT</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">RETURNS</span> <span class=\"token keyword\">INT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">BEGIN</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">RETURN</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token keyword\">SELECT</span> IFNULL<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> salary  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token keyword\">select</span> salary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\trank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> salary <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token keyword\">from</span> Employee</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> salary</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token keyword\">where</span> rk<span class=\"token operator\">=</span>N<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span> SecondHighestSalary</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">END</span></pre></td></tr></table></figure><h4 id=\"178-分数排名\"><a class=\"anchor\" href=\"#178-分数排名\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmFuay1zY29yZXMv\">178. 分数排名</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>编写一个 SQL 查询来实现分数排名。</p>\n<p>如果两个分数相同，则两个分数排名（Rank）相同。请注意，平分后的下一个名次应该是下一个连续的整数值。换句话说，名次之间不应该有 “间隔”。</p>\n<pre><code>+----+-------+\n| Id | Score |\n+----+-------+\n| 1  | 3.50  |\n| 2  | 3.65  |\n| 3  | 4.00  |\n| 4  | 3.85  |\n| 5  | 4.00  |\n| 6  | 3.65  |\n+----+-------+\n</code></pre>\n<p>例如，根据上述给定的  <code>Scores</code>  表，你的查询应该返回（按分数从高到低排列）：</p>\n<pre><code>+-------+------+\n| Score | Rank |\n+-------+------+\n| 4.00  | 1    |\n| 4.00  | 1    |\n| 3.85  | 2    |\n| 3.65  | 3    |\n| 3.65  | 3    |\n| 3.50  | 4    |\n+-------+------+\n</code></pre>\n<p>** 重要提示：** 对于 MySQL 解决方案，如果要转义用作列名的保留字，可以在关键字之前和之后使用撇号。例如 <strong> <code>Rank</code> </strong></p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Score<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dense_rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Score <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">`</span>rank<span class=\"token punctuation\">`</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> Scores</pre></td></tr></table></figure><h4 id=\"180-连续出现的数字\"><a class=\"anchor\" href=\"#180-连续出现的数字\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY29uc2VjdXRpdmUtbnVtYmVycy8=\">180. 连续出现的数字</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>编写一个 SQL 查询，查找所有至少连续出现三次的数字。</p>\n<pre><code>+----+-----+\n| Id | Num |\n+----+-----+\n| 1  |  1  |\n| 2  |  1  |\n| 3  |  1  |\n| 4  |  2  |\n| 5  |  1  |\n| 6  |  2  |\n| 7  |  2  |\n+----+-----+\n</code></pre>\n<p>例如，给定上面的  <code>Logs</code>  表，  <code>1</code>  是唯一连续出现至少三次的数字。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------------+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span> ConsecutiveNums <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">1</span>               <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> Num ConsecutiveNums</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Num<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>lead<span class=\"token punctuation\">(</span>Num<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> n2<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>lead<span class=\"token punctuation\">(</span>Num<span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> n3</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> Logs</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">where</span> Num <span class=\"token operator\">=</span> n2 <span class=\"token operator\">and</span> Num <span class=\"token operator\">=</span> n3</pre></td></tr></table></figure><h4 id=\"181-超过经理收入的员工\"><a class=\"anchor\" href=\"#181-超过经理收入的员工\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZW1wbG95ZWVzLWVhcm5pbmctbW9yZS10aGFuLXRoZWlyLW1hbmFnZXJzLw==\">181. 超过经理收入的员工</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p><code>Employee</code>  表包含所有员工，他们的经理也属于员工。每个员工都有一个 Id，此外还有一列对应员工的经理的 Id。</p>\n<pre><code>+----+-------+--------+-----------+\n| Id | Name  | Salary | ManagerId |\n+----+-------+--------+-----------+\n| 1  | Joe   | 70000  | 3         |\n| 2  | Henry | 80000  | 4         |\n| 3  | Sam   | 60000  | NULL      |\n| 4  | Max   | 90000  | NULL      |\n+----+-------+--------+-----------+\n</code></pre>\n<p>给定  <code>Employee</code>  表，编写一个 SQL 查询，该查询可以获取收入超过他们经理的员工的姓名。在上面的表格中，Joe 是唯一一个收入超过他的经理的员工。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span> Employee <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> Joe      <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>Name  Employee </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Employee a </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">join</span> Employee b</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>ManagerId <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> a<span class=\"token punctuation\">.</span>Salary<span class=\"token operator\">></span>b<span class=\"token punctuation\">.</span>Salary</pre></td></tr></table></figure><h4 id=\"182-查找重复的电子邮箱\"><a class=\"anchor\" href=\"#182-查找重复的电子邮箱\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZHVwbGljYXRlLWVtYWlscy8=\">182. 查找重复的电子邮箱</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>编写一个 SQL 查询，查找  <code>Person</code>  表中所有重复的电子邮箱。</p>\n<p><strong>示例：</strong></p>\n<pre><code>+----+---------+\n| Id | Email   |\n+----+---------+\n| 1  | a@b.com |\n| 2  | c@d.com |\n| 3  | a@b.com |\n+----+---------+\n</code></pre>\n<p>根据以上输入，你的查询应返回以下结果：</p>\n<pre><code>+---------+\n| Email   |\n+---------+\n| a@b.com |\n+---------+\n</code></pre>\n<p>** 说明：** 所有电子邮箱都是小写字母。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Email</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Person</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> Email</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"183-从不订购的客户\"><a class=\"anchor\" href=\"#183-从不订购的客户\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3VzdG9tZXJzLXdoby1uZXZlci1vcmRlci8=\">183. 从不订购的客户</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>某网站包含两个表， <code>Customers</code>  表和  <code>Orders</code>  表。编写一个 SQL 查询，找出所有从不订购任何东西的客户。</p>\n<p><code>Customers</code>  表：</p>\n<pre><code>+----+-------+\n| Id | Name  |\n+----+-------+\n| 1  | Joe   |\n| 2  | Henry |\n| 3  | Sam   |\n| 4  | Max   |\n+----+-------+\n</code></pre>\n<p><code>Orders</code>  表：</p>\n<pre><code>+----+------------+\n| Id | CustomerId |\n+----+------------+\n| 1  | 3          |\n| 2  | 1          |\n+----+------------+\n</code></pre>\n<p>例如给定上述表格，你的查询应返回：</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span> Customers <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> Henry     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> Max       <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  c<span class=\"token punctuation\">.</span>Name Customers</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Customers  c <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Orders  o</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> c<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> o<span class=\"token punctuation\">.</span>CustomerId</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span> o<span class=\"token punctuation\">.</span>id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span></pre></td></tr></table></figure><h4 id=\"184-部门工资最高的员工\"><a class=\"anchor\" href=\"#184-部门工资最高的员工\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZGVwYXJ0bWVudC1oaWdoZXN0LXNhbGFyeS8=\">184. 部门工资最高的员工</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Employee</code>  表包含所有员工信息，每个员工有其对应的 Id, salary 和 department Id。</p>\n<pre><code>+----+-------+--------+--------------+\n| Id | Name  | Salary | DepartmentId |\n+----+-------+--------+--------------+\n| 1  | Joe   | 70000  | 1            |\n| 2  | Henry | 80000  | 2            |\n| 3  | Sam   | 60000  | 2            |\n| 4  | Max   | 90000  | 1            |\n+----+-------+--------+--------------+\n</code></pre>\n<p><code>Department</code>  表包含公司所有部门的信息。</p>\n<pre><code>+----+----------+\n| Id | Name     |\n+----+----------+\n| 1  | IT       |\n| 2  | Sales    |\n+----+----------+\n</code></pre>\n<p>编写一个 SQL 查询，找出每个部门工资最高的员工。例如，根据上述给定的表格，Max 在 IT 部门有最高工资，Henry 在 Sales 部门有最高工资。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+----------+--------+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span> Department <span class=\"token operator\">|</span> Employee <span class=\"token operator\">|</span> Salary <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+----------+--------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> IT         <span class=\"token operator\">|</span> Max      <span class=\"token operator\">|</span> <span class=\"token number\">90000</span>  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> Sales      <span class=\"token operator\">|</span> Henry    <span class=\"token operator\">|</span> <span class=\"token number\">80000</span>  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+----------+--------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Department<span class=\"token punctuation\">,</span>Employee<span class=\"token punctuation\">,</span>Salary</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> d<span class=\"token punctuation\">.</span>Name  Department<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>Name Employee<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>Salary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> d<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Salary <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Employee e <span class=\"token keyword\">join</span> Department d</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">on</span> e<span class=\"token punctuation\">.</span>DepartmentId<span class=\"token operator\">=</span>d<span class=\"token punctuation\">.</span>id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>tmp</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"185-部门工资前三高的所有员工\"><a class=\"anchor\" href=\"#185-部门工资前三高的所有员工\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZGVwYXJ0bWVudC10b3AtdGhyZWUtc2FsYXJpZXMv\">185. 部门工资前三高的所有员工</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Employee</code>  表包含所有员工信息，每个员工有其对应的工号  <code>Id</code> ，姓名  <code>Name</code> ，工资  <code>Salary</code>  和部门编号  <code>DepartmentId</code>  。</p>\n<pre><code>+----+-------+--------+--------------+\n| Id | Name  | Salary | DepartmentId |\n+----+-------+--------+--------------+\n| 1  | Joe   | 85000  | 1            |\n| 2  | Henry | 80000  | 2            |\n| 3  | Sam   | 60000  | 2            |\n| 4  | Max   | 90000  | 1            |\n| 5  | Janet | 69000  | 1            |\n| 6  | Randy | 85000  | 1            |\n| 7  | Will  | 70000  | 1            |\n+----+-------+--------+--------------+\n</code></pre>\n<p><code>Department</code>  表包含公司所有部门的信息。</p>\n<pre><code>+----+----------+\n| Id | Name     |\n+----+----------+\n| 1  | IT       |\n| 2  | Sales    |\n+----+----------+\n</code></pre>\n<p>编写一个 SQL 查询，找出每个部门获得前三高工资的所有员工。例如，根据上述给定的表，查询结果应返回：</p>\n<pre><code>+------------+----------+--------+\n| Department | Employee | Salary |\n+------------+----------+--------+\n| IT         | Max      | 90000  |\n| IT         | Randy    | 85000  |\n| IT         | Joe      | 85000  |\n| IT         | Will     | 70000  |\n| Sales      | Henry    | 80000  |\n| Sales      | Sam      | 60000  |\n+------------+----------+--------+\n</code></pre>\n<p><strong>解释：</strong></p>\n<p>IT 部门中，Max 获得了最高的工资，Randy 和 Joe 都拿到了第二高的工资，Will 的工资排第三。销售部门（Sales）只有两名员工，Henry 的工资最高，Sam 的工资排第二。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Department<span class=\"token punctuation\">,</span>Employee<span class=\"token punctuation\">,</span>Salary</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> d<span class=\"token punctuation\">.</span>Name  Department<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>Name Employee<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>Salary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dense_rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> d<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Salary <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Employee e <span class=\"token keyword\">join</span> Department d</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">on</span> e<span class=\"token punctuation\">.</span>DepartmentId<span class=\"token operator\">=</span>d<span class=\"token punctuation\">.</span>id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>tmp</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">&lt;=</span><span class=\"token number\">3</span></pre></td></tr></table></figure><h4 id=\"196-删除重复的电子邮箱\"><a class=\"anchor\" href=\"#196-删除重复的电子邮箱\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZGVsZXRlLWR1cGxpY2F0ZS1lbWFpbHMv\">196. 删除重复的电子邮箱</span></h4>\n<p>难度简单</p>\n<p>编写一个 SQL 查询，来删除  <code>Person</code>  表中所有重复的电子邮箱，重复的邮箱里只保留 <strong>Id</strong> <em>最小</em> 的那个。</p>\n<pre><code>+----+------------------+\n| Id | Email            |\n+----+------------------+\n| 1  | john@example.com |\n| 2  | bob@example.com  |\n| 3  | john@example.com |\n+----+------------------+\nId 是这个表的主键。\n</code></pre>\n<p>例如，在运行你的查询语句之后，上面的  <code>Person</code>  表应返回以下几行:</p>\n<pre><code>+----+------------------+\n| Id | Email            |\n+----+------------------+\n| 1  | john@example.com |\n| 2  | bob@example.com  |\n+----+------------------+\n</code></pre>\n<p><strong>提示：</strong></p>\n<ul>\n<li>\n<p>执行 SQL 之后，输出是整个  <code>Person</code>  表。</p>\n</li>\n<li>\n<p>使用  <code>delete</code>  语句。</p>\n</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">DELETE</span> p1 <span class=\"token keyword\">FROM</span> Person p1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Person p2</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">WHERE</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    p1<span class=\"token punctuation\">.</span>Email <span class=\"token operator\">=</span> p2<span class=\"token punctuation\">.</span>Email <span class=\"token operator\">AND</span> p1<span class=\"token punctuation\">.</span>Id <span class=\"token operator\">></span> p2<span class=\"token punctuation\">.</span>Id</pre></td></tr></table></figure><blockquote>\n<p>注意是删除 ，不是查询</p>\n</blockquote>\n<h4 id=\"197-上升的温度\"><a class=\"anchor\" href=\"#197-上升的温度\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmlzaW5nLXRlbXBlcmF0dXJlLw==\">197. 上升的温度</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>给定一个  <code>Weather</code>  表，编写一个 SQL 查询，来查找与之前（昨天的）日期相比温度更高的所有日期的 Id。</p>\n<pre><code>+---------+------------------+------------------+\n| Id(INT) | RecordDate(DATE) | Temperature(INT) |\n+---------+------------------+------------------+\n|       1 |       2015-01-01 |               10 |\n|       2 |       2015-01-02 |               25 |\n|       3 |       2015-01-03 |               20 |\n|       4 |       2015-01-04 |               30 |\n+---------+------------------+------------------+\n</code></pre>\n<p>例如，根据上述给定的  <code>Weather</code>  表格，返回如下 Id:</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span> Id <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Id</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">select</span> Id<span class=\"token punctuation\">,</span>RecordDate<span class=\"token punctuation\">,</span>Temperature<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>lag<span class=\"token punctuation\">(</span>RecordDate<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">9999</span><span class=\"token operator\">-</span><span class=\"token number\">99</span><span class=\"token operator\">-</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> RecordDate<span class=\"token punctuation\">)</span> yd<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>lag<span class=\"token punctuation\">(</span>Temperature<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">999</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> RecordDate <span class=\"token punctuation\">)</span> yt</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> Weather </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span>tmp</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">where</span> Temperature <span class=\"token operator\">></span>yt</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">and</span> datediff<span class=\"token punctuation\">(</span>RecordDate<span class=\"token punctuation\">,</span>yd<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"262-行程和用户\"><a class=\"anchor\" href=\"#262-行程和用户\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdHJpcHMtYW5kLXVzZXJzLw==\">262. 行程和用户</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Trips</code>  表中存所有出租车的行程信息。每段行程有唯一键 Id，Client_Id 和 Driver_Id 是  <code>Users</code>  表中 Users_Id 的外键。Status 是枚举类型，枚举成员为 (‘completed’, ‘cancelled_by_driver’, ‘cancelled_by_client’)。</p>\n<pre><code>+----+-----------+-----------+---------+--------------------+----------+\n| Id | Client_Id | Driver_Id | City_Id |        Status      |Request_at|\n+----+-----------+-----------+---------+--------------------+----------+\n| 1  |     1     |    10     |    1    |     completed      |2013-10-01|\n| 2  |     2     |    11     |    1    | cancelled_by_driver|2013-10-01|\n| 3  |     3     |    12     |    6    |     completed      |2013-10-01|\n| 4  |     4     |    13     |    6    | cancelled_by_client|2013-10-01|\n| 5  |     1     |    10     |    1    |     completed      |2013-10-02|\n| 6  |     2     |    11     |    6    |     completed      |2013-10-02|\n| 7  |     3     |    12     |    6    |     completed      |2013-10-02|\n| 8  |     2     |    12     |    12   |     completed      |2013-10-03|\n| 9  |     3     |    10     |    12   |     completed      |2013-10-03| \n| 10 |     4     |    13     |    12   | cancelled_by_driver|2013-10-03|\n+----+-----------+-----------+---------+--------------------+----------+\n</code></pre>\n<p><code>Users</code>  表存所有用户。每个用户有唯一键 Users_Id。Banned 表示这个用户是否被禁止，Role 则是一个表示（‘client’, ‘driver’, ‘partner’）的枚举类型。</p>\n<pre><code>+----------+--------+--------+\n| Users_Id | Banned |  Role  |\n+----------+--------+--------+\n|    1     |   No   | client |\n|    2     |   Yes  | client |\n|    3     |   No   | client |\n|    4     |   No   | client |\n|    10    |   No   | driver |\n|    11    |   No   | driver |\n|    12    |   No   | driver |\n|    13    |   No   | driver |\n+----------+--------+--------+\n</code></pre>\n<p>写一段 SQL 语句查出 <strong>2013 年 10 月 1 日</strong> 至 <strong>2013 年 10 月 3 日</strong> 期间非禁止用户的取消率。基于上表，你的 SQL 语句应返回如下结果，取消率（Cancellation Rate）保留两位小数。</p>\n<p>取消率的计算方式如下：(被司机或乘客取消的非禁止用户生成的订单数量) / (非禁止用户生成的订单总数)</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+-------------------+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span>     <span class=\"token keyword\">Day</span>    <span class=\"token operator\">|</span> Cancellation Rate <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+-------------------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2013</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token operator\">|</span>       <span class=\"token number\">0.33</span>        <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2013</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">02</span> <span class=\"token operator\">|</span>       <span class=\"token number\">0.00</span>        <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2013</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">03</span> <span class=\"token operator\">|</span>       <span class=\"token number\">0.50</span>        <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+-------------------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> T<span class=\"token punctuation\">.</span>request_at <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">Day</span><span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t\t<span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span><span class=\"token keyword\">STATUS</span> <span class=\"token operator\">=</span> <span class=\"token string\">'completed'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\t<span class=\"token operator\">/</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t<span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span><span class=\"token keyword\">STATUS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">`</span>Cancellation Rate<span class=\"token punctuation\">`</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">FROM</span> trips <span class=\"token keyword\">AS</span> T</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">WHERE</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>T<span class=\"token punctuation\">.</span>Client_Id <span class=\"token operator\">NOT</span> <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">SELECT</span> users_id</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">FROM</span> users</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token keyword\">WHERE</span> banned <span class=\"token operator\">=</span> <span class=\"token string\">'Yes'</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">AND</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>T<span class=\"token punctuation\">.</span>Driver_Id <span class=\"token operator\">NOT</span> <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">SELECT</span> users_id</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">FROM</span> users</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">WHERE</span> banned <span class=\"token operator\">=</span> <span class=\"token string\">'Yes'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token operator\">AND</span> T<span class=\"token punctuation\">.</span>request_at <span class=\"token operator\">BETWEEN</span> <span class=\"token string\">'2013-10-01'</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'2013-10-03'</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> T<span class=\"token punctuation\">.</span>request_at</pre></td></tr></table></figure><h4 id=\"511-游戏玩法分析-i\"><a class=\"anchor\" href=\"#511-游戏玩法分析-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2FtZS1wbGF5LWFuYWx5c2lzLWkv\">511. 游戏玩法分析 I</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>活动表  <code>Activity</code> ：</p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| player_id    | int     |\n| device_id    | int     |\n| event_date   | date    |\n| games_played | int     |\n+--------------+---------+\n表的主键是 (player_id, event_date)。\n这张表展示了一些游戏玩家在游戏平台上的行为活动。\n每行数据记录了一名玩家在退出平台之前，当天使用同一台设备登录平台后打开的游戏的数目（可能是 0 个）。\n</code></pre>\n<p>写一条 SQL 查询语句获取每位玩家 <strong>第一次登陆平台的日期</strong>。</p>\n<p>查询结果的格式如下所示：</p>\n<pre><code>Activity 表：\n+-----------+-----------+------------+--------------+\n| player_id | device_id | event_date | games_played |\n+-----------+-----------+------------+--------------+\n| 1         | 2         | 2016-03-01 | 5            |\n| 1         | 2         | 2016-05-02 | 6            |\n| 2         | 3         | 2017-06-25 | 1            |\n| 3         | 1         | 2016-03-02 | 0            |\n| 3         | 4         | 2018-07-03 | 5            |\n+-----------+-----------+------------+--------------+\n\nResult 表：\n+-----------+-------------+\n| player_id | first_login |\n+-----------+-------------+\n| 1         | 2016-03-01  |\n| 2         | 2017-06-25  |\n| 3         | 2016-03-02  |\n+-----------+-------------+\n</code></pre>\n<ol>\n<li></li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> player_id <span class=\"token punctuation\">,</span>event_date first_login</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> player_id <span class=\"token punctuation\">,</span>event_date<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> player_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> event_date<span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span> tmp</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><p>2. 最优 （选最小日期）</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> player_id <span class=\"token punctuation\">,</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>event_date<span class=\"token punctuation\">)</span> first_login</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> player_id</pre></td></tr></table></figure><h4 id=\"512-游戏玩法分析-ii\"><a class=\"anchor\" href=\"#512-游戏玩法分析-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2FtZS1wbGF5LWFuYWx5c2lzLWlpLw==\">512. 游戏玩法分析 II</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Activity</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| player_id    | int     |\n| device_id    | int     |\n| event_date   | date    |\n| games_played | int     |\n+--------------+---------+\n(player_id, event_date) 是这个表的两个主键\n这个表显示的是某些游戏玩家的游戏活动情况\n每一行是在某天使用某个设备登出之前登录并玩多个游戏（可能为0）的玩家的记录\n</code></pre>\n<p>请编写一个 SQL 查询，描述每一个玩家首次登陆的设备名称</p>\n<p>查询结果格式在以下示例中：</p>\n<pre><code>Activity table:\n+-----------+-----------+------------+--------------+\n| player_id | device_id | event_date | games_played |\n+-----------+-----------+------------+--------------+\n| 1         | 2         | 2016-03-01 | 5            |\n| 1         | 2         | 2016-05-02 | 6            |\n| 2         | 3         | 2017-06-25 | 1            |\n| 3         | 1         | 2016-03-02 | 0            |\n| 3         | 4         | 2018-07-03 | 5            |\n+-----------+-----------+------------+--------------+\n\nResult table:\n+-----------+-----------+\n| player_id | device_id |\n+-----------+-----------+\n| 1         | 2         |\n| 2         | 3         |\n| 3         | 1         |\n+-----------+-----------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> player_id <span class=\"token punctuation\">,</span>device_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> player_id <span class=\"token punctuation\">,</span>event_date<span class=\"token punctuation\">,</span>device_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> player_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> event_date<span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span> tmp</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"534-游戏玩法分析-iii\"><a class=\"anchor\" href=\"#534-游戏玩法分析-iii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2FtZS1wbGF5LWFuYWx5c2lzLWlpaS8=\">534. 游戏玩法分析 III</span></h4>\n<p>难度中等 20 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Activity</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| player_id    | int     |\n| device_id    | int     |\n| event_date   | date    |\n| games_played | int     |\n+--------------+---------+\n（player_id，event_date）是此表的主键。\n这张表显示了某些游戏的玩家的活动情况。\n每一行是一个玩家的记录，他在某一天使用某个设备注销之前登录并玩了很多游戏（可能是 0 ）。\n</code></pre>\n<p>编写一个 SQL 查询，同时报告每组玩家和日期，以及玩家到目前为止玩了多少游戏。也就是说，在此日期之前玩家所玩的游戏总数。详细情况请查看示例。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Activity table:\n+-----------+-----------+------------+--------------+\n| player_id | device_id | event_date | games_played |\n+-----------+-----------+------------+--------------+\n| 1         | 2         | 2016-03-01 | 5            |\n| 1         | 2         | 2016-05-02 | 6            |\n| 1         | 3         | 2017-06-25 | 1            |\n| 3         | 1         | 2016-03-02 | 0            |\n| 3         | 4         | 2018-07-03 | 5            |\n+-----------+-----------+------------+--------------+\n\nResult table:\n+-----------+------------+---------------------+\n| player_id | event_date | games_played_so_far |\n+-----------+------------+---------------------+\n| 1         | 2016-03-01 | 5                   |\n| 1         | 2016-05-02 | 11                  |\n| 1         | 2017-06-25 | 12                  |\n| 3         | 2016-03-02 | 0                   |\n| 3         | 2018-07-03 | 5                   |\n+-----------+------------+---------------------+\n对于 ID 为 1 的玩家，2016-05-02 共玩了 5+6=11 个游戏，2017-06-25 共玩了 5+6+1=12 个游戏。\n对于 ID 为 3 的玩家，2018-07-03 共玩了 0+5=5 个游戏。\n请注意，对于每个玩家，我们只关心玩家的登录日期。\n</code></pre>\n<p>开窗</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> player_id<span class=\"token punctuation\">,</span>event_date <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>games_played<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> player_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span>  event_date <span class=\"token punctuation\">)</span>games_played_so_far</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr></table></figure><p>自连接</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    a1<span class=\"token punctuation\">.</span>player_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    a1<span class=\"token punctuation\">.</span>event_date<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>a2<span class=\"token punctuation\">.</span>games_played<span class=\"token punctuation\">)</span> games_played_so_far</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Activity a1<span class=\"token punctuation\">,</span>Activity a2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">where</span> a1<span class=\"token punctuation\">.</span>player_id<span class=\"token operator\">=</span>a2<span class=\"token punctuation\">.</span>player_id <span class=\"token operator\">and</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      a1<span class=\"token punctuation\">.</span>event_date<span class=\"token operator\">>=</span>a2<span class=\"token punctuation\">.</span>event_date</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"550-游戏玩法分析-iv\"><a class=\"anchor\" href=\"#550-游戏玩法分析-iv\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2FtZS1wbGF5LWFuYWx5c2lzLWl2Lw==\">550. 游戏玩法分析 IV</span></h4>\n<p>难度中等 17 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Activity</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| player_id    | int     |\n| device_id    | int     |\n| event_date   | date    |\n| games_played | int     |\n+--------------+---------+\n（player_id，event_date）是此表的主键。\n这张表显示了某些游戏的玩家的活动情况。\n每一行是一个玩家的记录，他在某一天使用某个设备注销之前登录并玩了很多游戏（可能是 0）。\n</code></pre>\n<p>编写一个 SQL 查询，报告在首次登录的第二天再次登录的玩家的分数，四舍五入到小数点后两位。换句话说，您需要计算从首次登录日期开始至少连续两天登录的玩家的数量，然后除以玩家总数。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Activity table:\n+-----------+-----------+------------+--------------+\n| player_id | device_id | event_date | games_played |\n+-----------+-----------+------------+--------------+\n| 1         | 2         | 2016-03-01 | 5            |\n| 1         | 2         | 2016-03-02 | 6            |\n| 2         | 3         | 2017-06-25 | 1            |\n| 3         | 1         | 2016-03-02 | 0            |\n| 3         | 4         | 2018-07-03 | 5            |\n+-----------+-----------+------------+--------------+\n\nResult table:\n+-----------+\n| fraction  |\n+-----------+\n| 0.33      |\n+-----------+\n只有 ID 为 1 的玩家在第一天登录后才重新登录，所以答案是 1/3 = 0.33\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>event_date <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> fraction</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> player_id<span class=\"token punctuation\">,</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>event_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> login</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">from</span> activity</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> player_id<span class=\"token punctuation\">)</span> p </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> activity a </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">on</span> p<span class=\"token punctuation\">.</span>player_id<span class=\"token operator\">=</span>a<span class=\"token punctuation\">.</span>player_id <span class=\"token operator\">and</span> datediff<span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>event_date<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>login<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><blockquote>\n<p>这个 avg 用的妙</p>\n<p>is not null 判断后，有 eventdate 值的返回 1，null 的返回 0，avg 相当于求和后 (即符合条件的 id 个数) 除以总 id 数即所求比例</p>\n</blockquote>\n<h4 id=\"569-员工薪水中位数\"><a class=\"anchor\" href=\"#569-员工薪水中位数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbWVkaWFuLWVtcGxveWVlLXNhbGFyeS8=\">569. 员工薪水中位数</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Employee</code>  表包含所有员工。 <code>Employee</code>  表有三列：员工 Id，公司名和薪水。</p>\n<pre><code>+-----+------------+--------+\n|Id   | Company    | Salary |\n+-----+------------+--------+\n|1    | A          | 2341   |\n|2    | A          | 341    |\n|3    | A          | 15     |\n|4    | A          | 15314  |\n|5    | A          | 451    |\n|6    | A          | 513    |\n|7    | B          | 15     |\n|8    | B          | 13     |\n|9    | B          | 1154   |\n|10   | B          | 1345   |\n|11   | B          | 1221   |\n|12   | B          | 234    |\n|13   | C          | 2345   |\n|14   | C          | 2645   |\n|15   | C          | 2645   |\n|16   | C          | 2652   |\n|17   | C          | 65     |\n+-----+------------+--------+\n</code></pre>\n<p>请编写 SQL 查询来查找每个公司的薪水中位数。挑战点：你是否可以在不使用任何内置的 SQL 函数的情况下解决此问题。</p>\n<pre><code>+-----+------------+--------+\n|Id   | Company    | Salary |\n+-----+------------+--------+\n|5    | A          | 451    |\n|6    | A          | 513    |\n|12   | B          | 234    |\n|9    | B          | 1154   |\n|14   | C          | 2645   |\n+-----+------------+--------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Id<span class=\"token punctuation\">,</span>Company<span class=\"token punctuation\">,</span>Salary</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> Id<span class=\"token punctuation\">,</span>Company<span class=\"token punctuation\">,</span>Salary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ROW_NUMBER<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> Company <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Salary<span class=\"token punctuation\">)</span> rk<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> Company<span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Employee</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cnt <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> FLOOR<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cnt <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><blockquote>\n<p>中位数：</p>\n<p>+1 向下取整 +2 向下取整数</p>\n</blockquote>\n<h4 id=\"570-至少有5名直接下属的经理\"><a class=\"anchor\" href=\"#570-至少有5名直接下属的经理\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbWFuYWdlcnMtd2l0aC1hdC1sZWFzdC01LWRpcmVjdC1yZXBvcnRzLw==\">570. 至少有 5 名直接下属的经理</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Employee</code>  表包含所有员工和他们的经理。每个员工都有一个 Id，并且还有一列是经理的 Id。</p>\n<pre><code>+------+----------+-----------+----------+\n|Id    |Name \t  |Department |ManagerId |\n+------+----------+-----------+----------+\n|101   |John \t  |A \t      |null      |\n|102   |Dan \t  |A \t      |101       |\n|103   |James \t  |A \t      |101       |\n|104   |Amy \t  |A \t      |101       |\n|105   |Anne \t  |A \t      |101       |\n|106   |Ron \t  |B \t      |101       |\n+------+----------+-----------+----------+\n</code></pre>\n<p>给定  <code>Employee</code>  表，请编写一个 SQL 查询来查找至少有 5 名直接下属的经理。对于上表，您的 SQL 查询应该返回：</p>\n<pre><code>+-------+\n| Name  |\n+-------+\n| John  |\n+-------+\n</code></pre>\n<p><strong>注意:</strong><br />\n 没有人是自己的下属。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Employee</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> Id <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> ManagerId</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Employee</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> ManagerId</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"571-给定数字的频率查询中位数\"><a class=\"anchor\" href=\"#571-给定数字的频率查询中位数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC1tZWRpYW4tZ2l2ZW4tZnJlcXVlbmN5LW9mLW51bWJlcnMv\">571. 给定数字的频率查询中位数</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Numbers</code>  表保存数字的值及其频率。</p>\n<pre><code>+----------+-------------+\n|  Number  |  Frequency  |\n+----------+-------------|\n|  0       |  7          |\n|  1       |  1          |\n|  2       |  3          |\n|  3       |  1          |\n+----------+-------------+\n</code></pre>\n<p>在此表中，数字为  <code>0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 3</code> ，所以中位数是  <code>(0 + 0) / 2 = 0</code> 。</p>\n<pre><code>+--------+\n| median |\n+--------|\n| 0.0000 |\n+--------+\n</code></pre>\n<p>请编写一个查询来查找所有数字的中位数并将结果命名为  <code>median</code>  。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>number <span class=\"token keyword\">as</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> median</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            Number<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            Frequency<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>Frequency<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Number<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> Frequency prev_sum<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>Frequency<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Number<span class=\"token punctuation\">)</span> curr_sum</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">from</span> Numbers</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">)</span> t1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>Frequency<span class=\"token punctuation\">)</span> total_sum</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">from</span> Numbers</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">)</span> t2</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">where</span> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    t1<span class=\"token punctuation\">.</span>prev_sum <span class=\"token operator\">&lt;=</span> <span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">.</span>total_sum <span class=\"token keyword\">as</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">and</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    t1<span class=\"token punctuation\">.</span>curr_sum <span class=\"token operator\">>=</span> <span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">.</span>total_sum <span class=\"token keyword\">as</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>如果 n1.Number 为中位数，n1.Number（包含本身）前累计的数字应大于等于总数 / 2 同时 n1.Number（不包含本身）前累计数字应小于等于总数 / 2</p>\n<p>例如：0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 3 共 12 个数</p>\n<p>中位数 0（包含本身）前累计的数字 7 &gt;=6  0（不包含本身）前累计数字 0 &lt;=6<br />\n 例如：0，0，0，3，3，3 共 6 个数</p>\n<p>中位数 0（包含本身）前累计的数字 3 &gt;=3  0（不包含本身）前累计数字 0 &lt;=3</p>\n<p>中位数 3（包含本身）前累计的数字 6 &gt;=3  3（不包含本身）前累计数字 3 &lt;=3</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">AVG</span><span class=\"token punctuation\">(</span>Number<span class=\"token punctuation\">)</span>median </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> n1<span class=\"token punctuation\">.</span>Number <span class=\"token keyword\">FROM</span> Numbers n1 <span class=\"token keyword\">JOIN</span> Numbers n2 <span class=\"token keyword\">ON</span> n1<span class=\"token punctuation\">.</span>Number<span class=\"token operator\">>=</span>n2<span class=\"token punctuation\">.</span>Number </pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre> n1<span class=\"token punctuation\">.</span>Number </pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token keyword\">HAVING</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>n2<span class=\"token punctuation\">.</span>Frequency<span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>Frequency<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> Numbers<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token operator\">AND</span> </pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>n2<span class=\"token punctuation\">.</span>Frequency<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token function\">AVG</span><span class=\"token punctuation\">(</span>n1<span class=\"token punctuation\">.</span>Frequency<span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;=</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>Frequency<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> Numbers<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span>s</pre></td></tr></table></figure><h4 id=\"574-当选者\"><a class=\"anchor\" href=\"#574-当选者\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvd2lubmluZy1jYW5kaWRhdGUv\">574. 当选者</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Candidate</code></p>\n<pre><code>+-----+---------+\n| id  | Name    |\n+-----+---------+\n| 1   | A       |\n| 2   | B       |\n| 3   | C       |\n| 4   | D       |\n| 5   | E       |\n+-----+---------+  \n</code></pre>\n<p>表:  <code>Vote</code></p>\n<pre><code>+-----+--------------+\n| id  | CandidateId  |\n+-----+--------------+\n| 1   |     2        |\n| 2   |     4        |\n| 3   |     3        |\n| 4   |     2        |\n| 5   |     5        |\n+-----+--------------+\nid 是自动递增的主键，\nCandidateId 是 Candidate 表中的 id.\n</code></pre>\n<p>请编写 sql 语句来找到当选者的名字，上面的例子将返回当选者  <code>B</code> .</p>\n<pre><code>+------+\n| Name |\n+------+\n| B    |\n+------+\n</code></pre>\n<p>用了 order by 全局排序 不够好</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Name</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> Candidate c</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Vote v</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">on</span> c<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>CandidateId</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> Name</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><p>先过滤再  效率高很多</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Candidate</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> id <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">select</span> CandidateId</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span>    </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">select</span> CandidateId<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> CandidateId <span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">from</span> Vote</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> cnt <span class=\"token keyword\">desc</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"577-员工奖金\"><a class=\"anchor\" href=\"#577-员工奖金\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZW1wbG95ZWUtYm9udXMv\">577. 员工奖金</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>选出所有 bonus &lt; 1000 的员工的 name 及其 bonus。</p>\n<p><code>Employee</code>  表单</p>\n<pre><code>+-------+--------+-----------+--------+\n| empId |  name  | supervisor| salary |\n+-------+--------+-----------+--------+\n|   1   | John   |  3        | 1000   |\n|   2   | Dan    |  3        | 2000   |\n|   3   | Brad   |  null     | 4000   |\n|   4   | Thomas |  3        | 4000   |\n+-------+--------+-----------+--------+\nempId 是这张表单的主关键字\n</code></pre>\n<p><code>Bonus</code>  表单</p>\n<pre><code>+-------+-------+\n| empId | bonus |\n+-------+-------+\n| 2     | 500   |\n| 4     | 2000  |\n+-------+-------+\nempId 是这张表单的主关键字\n</code></pre>\n<p>输出示例：</p>\n<pre><code>+-------+-------+\n| name  | bonus |\n+-------+-------+\n| John  | null  |\n| Dan   | 500   |\n| Brad  | null  |\n+-------+-------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span>bonus</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Employee e</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Bonus b <span class=\"token keyword\">on</span>  e<span class=\"token punctuation\">.</span>empId<span class=\"token operator\">=</span>b<span class=\"token punctuation\">.</span>empId</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span> bonus<span class=\"token operator\">&lt;</span><span class=\"token number\">1000</span> <span class=\"token operator\">or</span> bonus <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span></pre></td></tr></table></figure><h4 id=\"578-查询回答率最高的问题\"><a class=\"anchor\" href=\"#578-查询回答率最高的问题\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2V0LWhpZ2hlc3QtYW5zd2VyLXJhdGUtcXVlc3Rpb24v\">578. 查询回答率最高的问题</span></h4>\n<p>难度中等 3 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>从  <code>survey_log</code>  表中获得回答率最高的问题， <code>survey_log</code>  表包含这些列 **：id**, <strong>action</strong>, <strong>question_id</strong>, <strong>answer_id</strong>, <strong>q_num</strong>, <strong>timestamp</strong>。</p>\n<p>id 表示用户 id；action 有以下几种值：&quot;show&quot;，&quot;answer&quot;，&quot;skip&quot;；当 action 值为 &quot;answer&quot; 时 answer_id 非空，而 action 值为 &quot;show&quot; 或者 &quot;skip&quot; 时 answer_id 为空；q_num 表示当前会话中问题的编号。</p>\n<p>请编写 SQL 查询来找到具有最高回答率的问题。</p>\n<p><strong>示例：</strong></p>\n<pre><code>输入：\n+------+-----------+--------------+------------+-----------+------------+\n| id   | action    | question_id  | answer_id  | q_num     | timestamp  |\n+------+-----------+--------------+------------+-----------+------------+\n| 5    | show      | 285          | null       | 1         | 123        |\n| 5    | answer    | 285          | 124124     | 1         | 124        |\n| 5    | show      | 369          | null       | 2         | 125        |\n| 5    | skip      | 369          | null       | 2         | 126        |\n+------+-----------+--------------+------------+-----------+------------+\n输出：\n+-------------+\n| survey_log  |\n+-------------+\n|    285      |\n+-------------+\n解释：\n问题 285 的回答率为 1/1，而问题 369 回答率为 0/1，因此输出 285 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> question_id  survey_log</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      question_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'answer'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> AnswerCnt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'show'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> ShowCnt</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      survey_log</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> question_id</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> tbl</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token punctuation\">(</span>AnswerCnt <span class=\"token operator\">/</span> ShowCnt<span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><p>直接不嵌套</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> question_id  survey_log</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> survey_log</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> question_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'answer'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'show'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"579-查询员工的累计薪水\"><a class=\"anchor\" href=\"#579-查询员工的累计薪水\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC1jdW11bGF0aXZlLXNhbGFyeS1vZi1hbi1lbXBsb3llZS8=\">579. 查询员工的累计薪水</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><strong>Employee</strong> 表保存了一年内的薪水信息。</p>\n<p>请你编写 SQL 语句，对于每个员工，查询他除最近一个月（即最大月）之外，剩下每个月的近三个月的累计薪水（不足三个月也要计算）。</p>\n<p>结果请按  <code>Id</code>  升序，然后按  <code>Month</code>  降序显示。</p>\n<p><strong>示例：</strong><br />\n<strong>输入：</strong></p>\n<table>\n<thead>\n<tr>\n<th>Id</th>\n<th>Month</th>\n<th>Salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>20</td>\n</tr>\n<tr>\n<td>2</td>\n<td>1</td>\n<td>20</td>\n</tr>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>30</td>\n</tr>\n<tr>\n<td>2</td>\n<td>2</td>\n<td>30</td>\n</tr>\n<tr>\n<td>3</td>\n<td>2</td>\n<td>40</td>\n</tr>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>40</td>\n</tr>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>60</td>\n</tr>\n<tr>\n<td>1</td>\n<td>4</td>\n<td>60</td>\n</tr>\n<tr>\n<td>3</td>\n<td>4</td>\n<td>70</td>\n</tr>\n</tbody>\n</table>\n<p><strong>输出：</strong></p>\n<table>\n<thead>\n<tr>\n<th>Id</th>\n<th>Month</th>\n<th>Salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>90</td>\n</tr>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>50</td>\n</tr>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>20</td>\n</tr>\n<tr>\n<td>2</td>\n<td>1</td>\n<td>20</td>\n</tr>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>100</td>\n</tr>\n<tr>\n<td>3</td>\n<td>2</td>\n<td>40</td>\n</tr>\n</tbody>\n</table>\n<p><strong>解释：</strong></p>\n<p>员工 '1' 除去最近一个月（月份 '4'），有三个月的薪水记录：月份 '3' 薪水为 40，月份 '2' 薪水为 30，月份 '1' 薪水为 20。</p>\n<p>所以近 3 个月的薪水累计分别为 (40 + 30 + 20) = 90，(30 + 20) = 50 和 20。</p>\n<table>\n<thead>\n<tr>\n<th>Id</th>\n<th>Month</th>\n<th>Salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>90</td>\n</tr>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>50</td>\n</tr>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>20</td>\n</tr>\n</tbody>\n</table>\n<p>员工 '2' 除去最近的一个月（月份 '2'）的话，只有月份 '1' 这一个月的薪水记录。</p>\n<table>\n<thead>\n<tr>\n<th>Id</th>\n<th>Month</th>\n<th>Salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>2</td>\n<td>1</td>\n<td>20</td>\n</tr>\n</tbody>\n</table>\n<p>员工 '3' 除去最近一个月（月份 '4'）后有两个月，分别为：月份 '4' 薪水为 60 和 月份 '2' 薪水为 40。所以各月的累计情况如下：</p>\n<table>\n<thead>\n<tr>\n<th>Id</th>\n<th>Month</th>\n<th>Salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>100</td>\n</tr>\n<tr>\n<td>3</td>\n<td>2</td>\n<td>40</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Id<span class=\"token punctuation\">,</span><span class=\"token keyword\">Month</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>Salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> Id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">Month</span> <span class=\"token keyword\">ROWS</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token number\">2</span> <span class=\"token keyword\">PRECEDING</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">CURRENT</span> <span class=\"token keyword\">ROW</span><span class=\"token punctuation\">)</span> Salary</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> Id<span class=\"token punctuation\">,</span><span class=\"token keyword\">Month</span><span class=\"token punctuation\">,</span>Salary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    lead<span class=\"token punctuation\">(</span><span class=\"token keyword\">Month</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> Id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">Month</span><span class=\"token punctuation\">)</span> lm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">from</span> Employee </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span> lm <span class=\"token operator\">!=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span>  Id<span class=\"token punctuation\">,</span><span class=\"token keyword\">Month</span> <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><h4 id=\"580-统计各专业学生人数\"><a class=\"anchor\" href=\"#580-统计各专业学生人数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY291bnQtc3R1ZGVudC1udW1iZXItaW4tZGVwYXJ0bWVudHMv\">580. 统计各专业学生人数</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>一所大学有 2 个数据表，分别是 <em><strong>student</strong></em> 和 <em><strong>department</strong></em> ，这两个表保存着每个专业的学生数据和院系数据。</p>\n<p>写一个查询语句，查询 <em><strong>department</strong></em> 表中每个专业的学生人数 （即使没有学生的专业也需列出）。</p>\n<p>将你的查询结果按照学生人数降序排列。 如果有两个或两个以上专业有相同的学生数目，将这些部门按照部门名字的字典序从小到大排列。</p>\n<p>*<strong>student*</strong> 表格如下：</p>\n<table>\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>student_id</td>\n<td>Integer</td>\n</tr>\n<tr>\n<td>student_name</td>\n<td>String</td>\n</tr>\n<tr>\n<td>gender</td>\n<td>Character</td>\n</tr>\n<tr>\n<td>dept_id</td>\n<td>Integer</td>\n</tr>\n</tbody>\n</table>\n<p>其中， student_id 是学生的学号， student_name 是学生的姓名， gender 是学生的性别， dept_id 是学生所属专业的专业编号。</p>\n<p>*<strong>department*</strong> 表格如下：</p>\n<table>\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>dept_id</td>\n<td>Integer</td>\n</tr>\n<tr>\n<td>dept_name</td>\n<td>String</td>\n</tr>\n</tbody>\n</table>\n<p>dept_id 是专业编号， dept_name 是专业名字。</p>\n<p>这里是一个示例输入：<br />\n*<strong>student*</strong> 表格：</p>\n<table>\n<thead>\n<tr>\n<th>student_id</th>\n<th>student_name</th>\n<th>gender</th>\n<th>dept_id</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>Jack</td>\n<td>M</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2</td>\n<td>Jane</td>\n<td>F</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3</td>\n<td>Mark</td>\n<td>M</td>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>*<strong>department*</strong> 表格：</p>\n<table>\n<thead>\n<tr>\n<th>dept_id</th>\n<th>dept_name</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>Engineering</td>\n</tr>\n<tr>\n<td>2</td>\n<td>Science</td>\n</tr>\n<tr>\n<td>3</td>\n<td>Law</td>\n</tr>\n</tbody>\n</table>\n<p>示例输出为：</p>\n<table>\n<thead>\n<tr>\n<th>dept_name</th>\n<th>student_number</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Engineering</td>\n<td>2</td>\n</tr>\n<tr>\n<td>Science</td>\n<td>1</td>\n</tr>\n<tr>\n<td>Law</td>\n<td>0</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  dept_name <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span>student_id<span class=\"token punctuation\">)</span> student_number</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> department d <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> student s</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> d<span class=\"token punctuation\">.</span>dept_id<span class=\"token operator\">=</span>s<span class=\"token punctuation\">.</span>dept_id </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> dept_name</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> student_number <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><h4 id=\"584-寻找用户推荐人\"><a class=\"anchor\" href=\"#584-寻找用户推荐人\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC1jdXN0b21lci1yZWZlcmVlLw==\">584. 寻找用户推荐人</span></h4>\n<p>难度简单 9 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>给定表  <code>customer</code>  ，里面保存了所有客户信息和他们的推荐人。</p>\n<pre><code>+------+------+-----------+\n| id   | name | referee_id|\n+------+------+-----------+\n|    1 | Will |      NULL |\n|    2 | Jane |      NULL |\n|    3 | Alex |         2 |\n|    4 | Bill |      NULL |\n|    5 | Zack |         1 |\n|    6 | Mark |         2 |\n+------+------+-----------+\n</code></pre>\n<p>写一个查询语句，返回一个编号列表，列表中编号的推荐人的编号都 <strong>不是</strong> 2。</p>\n<p>对于上面的示例数据，结果为：</p>\n<pre><code>+------+\n| name |\n+------+\n| Will |\n| Jane |\n| Bill |\n| Zack |\n+------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> name <span class=\"token keyword\">FROM</span> customer <span class=\"token keyword\">WHERE</span> referee_id <span class=\"token operator\">!=</span> <span class=\"token number\">2</span> <span class=\"token operator\">OR</span> referee_id <span class=\"token operator\">IS</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><blockquote>\n<p>MySQL 使用三值逻辑 —— TRUE, FALSE 和 UNKNOWN。任何与 NULL 值进行的比较都会与第三种值 UNKNOWN 做比较。这个 “任何值” 包括 NULL 本身！这就是为什么 MySQL 提供 IS NULL 和 IS NOT NULL 两种操作来对 NULL 特殊判断。</p>\n<p>因此，在 WHERE 语句中我们需要做一个额外的条件判断 `referee_id IS NULL'。</p>\n</blockquote>\n<h4 id=\"585-2016年的投资\"><a class=\"anchor\" href=\"#585-2016年的投资\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvaW52ZXN0bWVudHMtaW4tMjAxNi8=\">585. 2016 年的投资</span></h4>\n<p>难度中等 14 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>写一个查询语句，将 2016 年 (<strong>TIV_2016</strong>) 所有成功投资的金额加起来，保留 2 位小数。</p>\n<p>对于一个投保人，他在 2016 年成功投资的条件是：</p>\n<ol>\n<li>他在 2015 年的投保额 (<strong>TIV_2015</strong>) 至少跟一个其他投保人在 2015 年的投保额相同。</li>\n<li>他所在的城市必须与其他投保人都不同（也就是说维度和经度不能跟其他任何一个投保人完全相同）。</li>\n</ol>\n<p><strong>输入格式:</strong><br />\n 表 *<strong>insurance*</strong> 格式如下：</p>\n<table>\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PID</td>\n<td>INTEGER(11)</td>\n</tr>\n<tr>\n<td>TIV_2015</td>\n<td>NUMERIC(15,2)</td>\n</tr>\n<tr>\n<td>TIV_2016</td>\n<td>NUMERIC(15,2)</td>\n</tr>\n<tr>\n<td>LAT</td>\n<td>NUMERIC(5,2)</td>\n</tr>\n<tr>\n<td>LON</td>\n<td>NUMERIC(5,2)</td>\n</tr>\n</tbody>\n</table>\n<p><strong>PID</strong> 字段是投保人的投保编号， <strong>TIV_2015</strong> 是该投保人在 2015 年的总投保金额， <strong>TIV_2016</strong> 是该投保人在 2016 年的投保金额， <strong>LAT</strong> 是投保人所在城市的维度， <strong>LON</strong> 是投保人所在城市的经度。</p>\n<p><strong>样例输入</strong></p>\n<table>\n<thead>\n<tr>\n<th>PID</th>\n<th>TIV_2015</th>\n<th>TIV_2016</th>\n<th>LAT</th>\n<th>LON</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>10</td>\n<td>5</td>\n<td>10</td>\n<td>10</td>\n</tr>\n<tr>\n<td>2</td>\n<td>20</td>\n<td>20</td>\n<td>20</td>\n<td>20</td>\n</tr>\n<tr>\n<td>3</td>\n<td>10</td>\n<td>30</td>\n<td>20</td>\n<td>20</td>\n</tr>\n<tr>\n<td>4</td>\n<td>10</td>\n<td>40</td>\n<td>40</td>\n<td>40</td>\n</tr>\n</tbody>\n</table>\n<p><strong>样例输出</strong></p>\n<table>\n<thead>\n<tr>\n<th>TIV_2016</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>45.00</td>\n</tr>\n</tbody>\n</table>\n<p><strong>解释</strong></p>\n<pre><code>就如最后一个投保人，第一个投保人同时满足两个条件：\n1. 他在 2015 年的投保金额 TIV_2015 为 '10' ，与第三个和第四个投保人在 2015 年的投保金额相同。\n2. 他所在城市的经纬度是独一无二的。\n\n第二个投保人两个条件都不满足。他在 2015 年的投资 TIV_2015 与其他任何投保人都不相同。\n且他所在城市的经纬度与第三个投保人相同。基于同样的原因，第三个投保人投资失败。\n\n所以返回的结果是第一个投保人和最后一个投保人的 TIV_2016 之和，结果是 45 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>TIV_2016<span class=\"token punctuation\">)</span> TIV_2016</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> PID<span class=\"token punctuation\">,</span>TIV_2016<span class=\"token punctuation\">,</span>cnt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> loc <span class=\"token punctuation\">)</span> lcnt</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">select</span> PID<span class=\"token punctuation\">,</span>TIV_2016<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>TIV_2015<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> TIV_2015 <span class=\"token punctuation\">)</span> cnt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        concat_ws<span class=\"token punctuation\">(</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">,</span>LAT<span class=\"token punctuation\">,</span>LON<span class=\"token punctuation\">)</span> loc</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">from</span> insurance </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">where</span> lcnt<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> cnt<span class=\"token operator\">!=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><blockquote>\n<p>注意去重顺序 不要先对 TIV_2015 去重  不然 local 去重时会丢失数据</p>\n</blockquote>\n<p>优化 窗口</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>TIV_2016<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> TIV_2016</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> TIV_2015<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> cnt_1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> LAT<span class=\"token punctuation\">,</span> LON<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> cnt_2</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        insurance</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span> a </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">WHERE</span> a<span class=\"token punctuation\">.</span>cnt_1 <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>cnt_2 <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span></pre></td></tr></table></figure><h4 id=\"586-订单最多的客户\"><a class=\"anchor\" href=\"#586-订单最多的客户\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3VzdG9tZXItcGxhY2luZy10aGUtbGFyZ2VzdC1udW1iZXItb2Ytb3JkZXJzLw==\">586. 订单最多的客户</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>在表 <strong>orders</strong> 中找到订单数最多客户对应的 <strong>customer_number</strong> 。</p>\n<p>数据保证订单数最多的顾客恰好只有一位。</p>\n<p>表 *<strong>orders*</strong> 定义如下：</p>\n<table>\n<thead>\n<tr>\n<th>Column</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>order_number (PK)</td>\n<td>int</td>\n</tr>\n<tr>\n<td>customer_number</td>\n<td>int</td>\n</tr>\n<tr>\n<td>order_date</td>\n<td>date</td>\n</tr>\n<tr>\n<td>required_date</td>\n<td>date</td>\n</tr>\n<tr>\n<td>shipped_date</td>\n<td>date</td>\n</tr>\n<tr>\n<td>status</td>\n<td>char(15)</td>\n</tr>\n<tr>\n<td>comment</td>\n<td>char(200)</td>\n</tr>\n</tbody>\n</table>\n<p><strong>样例输入</strong></p>\n<table>\n<thead>\n<tr>\n<th>order_number</th>\n<th>customer_number</th>\n<th>order_date</th>\n<th>required_date</th>\n<th>shipped_date</th>\n<th>status</th>\n<th>comment</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>2017-04-09</td>\n<td>2017-04-13</td>\n<td>2017-04-12</td>\n<td>Closed</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>2</td>\n<td>2017-04-15</td>\n<td>2017-04-20</td>\n<td>2017-04-18</td>\n<td>Closed</td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>2017-04-16</td>\n<td>2017-04-25</td>\n<td>2017-04-20</td>\n<td>Closed</td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td>3</td>\n<td>2017-04-18</td>\n<td>2017-04-28</td>\n<td>2017-04-25</td>\n<td>Closed</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p><strong>样例输出</strong></p>\n<table>\n<thead>\n<tr>\n<th>customer_number</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<p><strong>解释</strong></p>\n<pre><code>customer_number 为 '3' 的顾客有两个订单，比顾客 '1' 或者 '2' 都要多，因为他们只有一个订单\n所以结果是该顾客的 customer_number ，也就是 3 。\n</code></pre>\n<p><strong>进阶：</strong> 如果有多位顾客订单数并列最多，你能找到他们所有的 customer_number 吗？</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> customer_number</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> orders</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_number </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>  <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><blockquote>\n<p>如果 数据量很大 order by 不太好</p>\n</blockquote>\n<h4 id=\"595-大的国家\"><a class=\"anchor\" href=\"#595-大的国家\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYmlnLWNvdW50cmllcy8=\">595. 大的国家</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>这里有张  <code>World</code>  表</p>\n<pre><code>+-----------------+------------+------------+--------------+---------------+\n| name            | continent  | area       | population   | gdp           |\n+-----------------+------------+------------+--------------+---------------+\n| Afghanistan     | Asia       | 652230     | 25500100     | 20343000      |\n| Albania         | Europe     | 28748      | 2831741      | 12960000      |\n| Algeria         | Africa     | 2381741    | 37100000     | 188681000     |\n| Andorra         | Europe     | 468        | 78115        | 3712000       |\n| Angola          | Africa     | 1246700    | 20609294     | 100990000     |\n+-----------------+------------+------------+--------------+---------------+\n</code></pre>\n<p>如果一个国家的面积超过 300 万平方公里，或者人口超过 2500 万，那么这个国家就是大国家。</p>\n<p>编写一个 SQL 查询，输出表中所有大国家的名称、人口和面积。</p>\n<p>例如，根据上表，我们应该输出:</p>\n<pre><code>+--------------+-------------+--------------+\n| name         | population  | area         |\n+--------------+-------------+--------------+\n| Afghanistan  | 25500100    | 652230       |\n| Algeria      | 37100000    | 2381741      |\n+--------------+-------------+--------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  name <span class=\"token punctuation\">,</span>population<span class=\"token punctuation\">,</span>area  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> World</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> area  <span class=\"token operator\">></span><span class=\"token number\">3000000</span> <span class=\"token operator\">or</span> population <span class=\"token operator\">></span><span class=\"token number\">25000000</span></pre></td></tr></table></figure><h4 id=\"596-超过5名学生的课\"><a class=\"anchor\" href=\"#596-超过5名学生的课\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY2xhc3Nlcy1tb3JlLXRoYW4tNS1zdHVkZW50cy8=\">596. 超过 5 名学生的课</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>有一个 <code>courses</code>  表 ，有: <strong>student (学生)</strong> 和 <strong>class (课程)</strong>。</p>\n<p>请列出所有超过或等于 5 名学生的课。</p>\n<p>例如，表:</p>\n<pre><code>+---------+------------+\n| student | class      |\n+---------+------------+\n| A       | Math       |\n| B       | English    |\n| C       | Math       |\n| D       | Biology    |\n| E       | Math       |\n| F       | Computer   |\n| G       | Math       |\n| H       | Math       |\n| I       | Math       |\n+---------+------------+\n</code></pre>\n<p>应该输出:</p>\n<pre><code>+---------+\n| class   |\n+---------+\n| Math    |\n+---------+\n</code></pre>\n<p><strong>Note:</strong><br />\n 学生在每个课中不应被重复计算。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  class </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> courses</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> class </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> student<span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">5</span></pre></td></tr></table></figure><blockquote>\n<p>一个学生可能多次选课。。记得 distinct</p>\n</blockquote>\n<h4 id=\"597-好友申请-i-总体通过率\"><a class=\"anchor\" href=\"#597-好友申请-i-总体通过率\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZnJpZW5kLXJlcXVlc3RzLWktb3ZlcmFsbC1hY2NlcHRhbmNlLXJhdGUv\">597. 好友申请 I ：总体通过率</span></h4>\n<p>难度简单 21 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>在 Facebook 或者 Twitter 这样的社交应用中，人们经常会发好友申请也会收到其他人的好友申请。现在给如下两个表：</p>\n<p>表： friend_request</p>\n<table>\n<thead>\n<tr>\n<th>sender_id</th>\n<th>send_to_id</th>\n<th>request_date</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>2016_06-01</td>\n</tr>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>2016_06-01</td>\n</tr>\n<tr>\n<td>1</td>\n<td>4</td>\n<td>2016_06-01</td>\n</tr>\n<tr>\n<td>2</td>\n<td>3</td>\n<td>2016_06-02</td>\n</tr>\n<tr>\n<td>3</td>\n<td>4</td>\n<td>2016-06-09</td>\n</tr>\n</tbody>\n</table>\n<p>表： request_accepted</p>\n<table>\n<thead>\n<tr>\n<th>requester_id</th>\n<th>accepter_id</th>\n<th>accept_date</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>2016_06-03</td>\n</tr>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>2016-06-08</td>\n</tr>\n<tr>\n<td>2</td>\n<td>3</td>\n<td>2016-06-08</td>\n</tr>\n<tr>\n<td>3</td>\n<td>4</td>\n<td>2016-06-09</td>\n</tr>\n<tr>\n<td>3</td>\n<td>4</td>\n<td>2016-06-10</td>\n</tr>\n</tbody>\n</table>\n<p>写一个查询语句，求出好友申请的通过率，用 2 位小数表示。通过率由接受好友申请的数目除以申请总数。</p>\n<p>对于上面的样例数据，你的查询语句应该返回如下结果。</p>\n<table>\n<thead>\n<tr>\n<th>accept_rate</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0.80</td>\n</tr>\n</tbody>\n</table>\n<p>注意:</p>\n<p>通过的好友申请不一定都在表 friend_request 中。在这种情况下，你只需要统计总的被通过的申请数（不管它们在不在原来的申请中），并将它除以申请总数，得到通过率<br />\n一个好友申请发送者有可能会给接受者发几条好友申请，也有可能一个好友申请会被通过好几次。这种情况下，重复的好友申请只统计一次。<br />\n如果一个好友申请都没有，通过率为 0.00 。</p>\n<p>解释： 总共有 5 个申请，其中 4 个是不重复且被通过的好友申请，所以成功率是 0.80 。</p>\n<p>进阶:</p>\n<p>你能写一个查询语句得到每个月的通过率吗？<br />\n你能求出每一天的累计通过率吗？</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">round</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ifnull<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> requester_id<span class=\"token punctuation\">,</span> accepter_id <span class=\"token keyword\">from</span> request_accepted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> A<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> sender_id<span class=\"token punctuation\">,</span> send_to_id <span class=\"token keyword\">from</span> friend_request<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> B<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> accept_rate<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"601-体育馆的人流量\"><a class=\"anchor\" href=\"#601-体育馆的人流量\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvaHVtYW4tdHJhZmZpYy1vZi1zdGFkaXVtLw==\">601. 体育馆的人流量</span></h4>\n<p>难度困难 113 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>X 市建了一个新的体育馆，每日人流量信息被记录在这三列信息中：<strong>序号</strong> (id)、<strong>日期</strong> (visit_date)、 <strong>人流量</strong> (people)。</p>\n<p>请编写一个查询语句，找出人流量的高峰期。高峰期时，至少连续三行记录中的人流量不少于 100。</p>\n<p>例如，表  <code>stadium</code> ：</p>\n<pre><code>+------+------------+-----------+\n| id   | visit_date | people    |\n+------+------------+-----------+\n| 1    | 2017-01-01 | 10        |\n| 2    | 2017-01-02 | 109       |\n| 3    | 2017-01-03 | 150       |\n| 4    | 2017-01-04 | 99        |\n| 5    | 2017-01-05 | 145       |\n| 6    | 2017-01-06 | 1455      |\n| 7    | 2017-01-07 | 199       |\n| 8    | 2017-01-08 | 188       |\n+------+------------+-----------+\n</code></pre>\n<p>对于上面的示例数据，输出为：</p>\n<pre><code>+------+------------+-----------+\n| id   | visit_date | people    |\n+------+------------+-----------+\n| 5    | 2017-01-05 | 145       |\n| 6    | 2017-01-06 | 1455      |\n| 7    | 2017-01-07 | 199       |\n| 8    | 2017-01-08 | 188       |\n+------+------------+-----------+ \n</code></pre>\n<p><strong>提示：</strong><br />\n每天只有一行记录，日期随着 id 的增加而增加。</p>\n<p>3 表相连 (244 ms)</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> t1<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> stadium t1<span class=\"token punctuation\">,</span> stadium t2<span class=\"token punctuation\">,</span> stadium t3</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> t1<span class=\"token punctuation\">.</span>people <span class=\"token operator\">>=</span> <span class=\"token number\">100</span> <span class=\"token operator\">and</span> t2<span class=\"token punctuation\">.</span>people <span class=\"token operator\">>=</span> <span class=\"token number\">100</span> <span class=\"token operator\">and</span> t3<span class=\"token punctuation\">.</span>people <span class=\"token operator\">>=</span> <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">and</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span>t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">and</span> t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">-- t1, t2, t3</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token operator\">or</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">and</span> t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">-- t2, t1, t3</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token operator\">or</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">(</span>t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">-- t3, t2, t1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> t1<span class=\"token punctuation\">.</span>id</pre></td></tr></table></figure><p>窗口函数 (272 ms)</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>visit_date<span class=\"token punctuation\">,</span>people <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">,</span>lead<span class=\"token punctuation\">(</span>people<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> ld</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">,</span>lead<span class=\"token punctuation\">(</span>people<span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> ld2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">,</span>visit_date</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">,</span>lag<span class=\"token punctuation\">(</span>people<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> lg</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">,</span>lag<span class=\"token punctuation\">(</span>people<span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> lg2</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">,</span>people</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">from</span> stadium</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>ld<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>lg<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>people<span class=\"token operator\">>=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">or</span> <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>ld<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>ld2<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>people<span class=\"token operator\">>=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token operator\">or</span> <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>lg<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>lg2<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>people<span class=\"token operator\">>=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"602-好友申请-ii-谁有最多的好友\"><a class=\"anchor\" href=\"#602-好友申请-ii-谁有最多的好友\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZnJpZW5kLXJlcXVlc3RzLWlpLXdoby1oYXMtdGhlLW1vc3QtZnJpZW5kcy8=\">602. 好友申请 II ：谁有最多的好友</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>在 Facebook 或者 Twitter 这样的社交应用中，人们经常会发好友申请也会收到其他人的好友申请。</p>\n<p>表  <code>request_accepted</code>  存储了所有好友申请通过的数据记录，其中， <strong>requester_id</strong> 和 <strong>accepter_id</strong> 都是用户的编号。</p>\n<table>\n<thead>\n<tr>\n<th>requester_id</th>\n<th>accepter_id</th>\n<th>accept_date</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>2016_06-03</td>\n</tr>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>2016-06-08</td>\n</tr>\n<tr>\n<td>2</td>\n<td>3</td>\n<td>2016-06-08</td>\n</tr>\n<tr>\n<td>3</td>\n<td>4</td>\n<td>2016-06-09</td>\n</tr>\n</tbody>\n</table>\n<p>写一个查询语句，求出谁拥有最多的好友和他拥有的好友数目。对于上面的样例数据，结果为：</p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>num</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<p><strong>注意：</strong></p>\n<ul>\n<li>保证拥有最多好友数目的只有 1 个人。</li>\n<li>好友申请只会被接受一次，所以不会有 <strong>requester_id</strong> 和 <strong>accepter_id</strong> 值都相同的重复记录。</li>\n</ul>\n<p><strong>解释：</strong></p>\n<p>编号为 '3' 的人是编号为 '1'，'2' 和 '4' 的好友，所以他总共有 3 个好友，比其他人都多。</p>\n<p><strong>进阶：</strong></p>\n<p>在真实世界里，可能会有多个人拥有好友数相同且最多，你能找到所有这些人吗？</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> rid <span class=\"token keyword\">as</span> <span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span>aid<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token punctuation\">`</span>num<span class=\"token punctuation\">`</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> R1<span class=\"token punctuation\">.</span>requester_id <span class=\"token keyword\">as</span> rid<span class=\"token punctuation\">,</span>R1<span class=\"token punctuation\">.</span>accepter_id <span class=\"token keyword\">as</span> aid</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> request_accepted <span class=\"token keyword\">as</span> R1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">all</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">select</span> R2<span class=\"token punctuation\">.</span>accepter_id <span class=\"token keyword\">as</span> rid<span class=\"token punctuation\">,</span>R2<span class=\"token punctuation\">.</span>requester_id <span class=\"token keyword\">as</span> aid</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">from</span> request_accepted <span class=\"token keyword\">as</span> R2</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> A</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> rid</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> num <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"603-连续空余座位\"><a class=\"anchor\" href=\"#603-连续空余座位\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY29uc2VjdXRpdmUtYXZhaWxhYmxlLXNlYXRzLw==\">603. 连续空余座位</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>几个朋友来到电影院的售票处，准备预约连续空余座位。</p>\n<p>你能利用表  <code>cinema</code>  ，帮他们写一个查询语句，获取所有空余座位，并将它们按照 seat_id 排序后返回吗？</p>\n<table>\n<thead>\n<tr>\n<th>seat_id</th>\n<th>free</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2</td>\n<td>0</td>\n</tr>\n<tr>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>4</td>\n<td>1</td>\n</tr>\n<tr>\n<td>5</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>对于如上样例，你的查询语句应该返回如下结果。</p>\n<table>\n<thead>\n<tr>\n<th>seat_id</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3</td>\n</tr>\n<tr>\n<td>4</td>\n</tr>\n<tr>\n<td>5</td>\n</tr>\n</tbody>\n</table>\n<p><strong>注意：</strong></p>\n<ul>\n<li>seat_id 字段是一个自增的整数，free 字段是布尔类型（'1' 表示空余， '0' 表示已被占据）。</li>\n<li>连续空余座位的定义是大于等于 2 个连续空余的座位。</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> seat_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> seat_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>lag<span class=\"token punctuation\">(</span>seat_id<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token operator\">-</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> seat_id<span class=\"token punctuation\">)</span> ls<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>lead<span class=\"token punctuation\">(</span>seat_id<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token operator\">-</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> seat_id<span class=\"token punctuation\">)</span> rs</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> cinema</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> free<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span>  seat_id<span class=\"token operator\">-</span>ls <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">or</span> rs<span class=\"token operator\">-</span>seat_id <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"607-销售员\"><a class=\"anchor\" href=\"#607-销售员\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2FsZXMtcGVyc29uLw==\">607. 销售员</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p><strong>描述</strong></p>\n<p>给定 3 个表：  <code>salesperson</code> ，  <code>company</code> ，  <code>orders</code> 。<br />\n输出所有表  <code>salesperson</code>  中，没有向公司 'RED' 销售任何东西的销售员。</p>\n<p><strong>示例：</strong><br />\n<strong>输入</strong></p>\n<p>表：  <code>salesperson</code></p>\n<pre><code>+----------+------+--------+-----------------+-----------+\n| sales_id | name | salary | commission_rate | hire_date |\n+----------+------+--------+-----------------+-----------+\n|   1      | John | 100000 |     6           | 4/1/2006  |\n|   2      | Amy  | 120000 |     5           | 5/1/2010  |\n|   3      | Mark | 65000  |     12          | 12/25/2008|\n|   4      | Pam  | 25000  |     25          | 1/1/2005  |\n|   5      | Alex | 50000  |     10          | 2/3/2007  |\n+----------+------+--------+-----------------+-----------+\n</code></pre>\n<p>表  <code>salesperson</code>  存储了所有销售员的信息。每个销售员都有一个销售员编号 <strong>sales_id</strong> 和他的名字 <strong>name</strong> 。</p>\n<p>表：  <code>company</code></p>\n<pre><code>+---------+--------+------------+\n| com_id  |  name  |    city    |\n+---------+--------+------------+\n|   1     |  RED   |   Boston   |\n|   2     | ORANGE |   New York |\n|   3     | YELLOW |   Boston   |\n|   4     | GREEN  |   Austin   |\n+---------+--------+------------+\n</code></pre>\n<p>表  <code>company</code>  存储了所有公司的信息。每个公司都有一个公司编号 <strong>com_id</strong> 和它的名字 <strong>name</strong> 。</p>\n<p>表：  <code>orders</code></p>\n<pre><code>+----------+------------+---------+----------+--------+\n| order_id | order_date | com_id  | sales_id | amount |\n+----------+------------+---------+----------+--------+\n| 1        |   1/1/2014 |    3    |    4     | 100000 |\n| 2        |   2/1/2014 |    4    |    5     | 5000   |\n| 3        |   3/1/2014 |    1    |    1     | 50000  |\n| 4        |   4/1/2014 |    1    |    4     | 25000  |\n+----------+----------+---------+----------+--------+\n</code></pre>\n<p>表  <code>orders</code>  存储了所有的销售数据，包括销售员编号 <strong>sales_id</strong> 和公司编号 <strong>com_id</strong> 。</p>\n<p><strong>输出</strong></p>\n<pre><code>+------+\n| name | \n+------+\n| Amy  | \n| Mark | \n| Alex |\n+------+\n</code></pre>\n<p><strong>解释</strong></p>\n<p>根据表  <code>orders</code>  中的订单 '3' 和 '4' ，容易看出只有 'John' 和 'Pam' 两个销售员曾经向公司 'RED' 销售过。</p>\n<p>所以我们需要输出表  <code>salesperson</code>  中所有其他人的名字。\\</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> salesperson</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> sales_id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> sales_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> orders</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">where</span> com_id <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">select</span> com_id </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">from</span> company</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span><span class=\"token string\">'RED'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"608-树节点\"><a class=\"anchor\" href=\"#608-树节点\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdHJlZS1ub2RlLw==\">608. 树节点</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>给定一个表  <code>tree</code> ，<strong>id</strong> 是树节点的编号， <strong>p_id</strong> 是它父节点的 <strong>id 。</strong></p>\n<pre><code>+----+------+\n| id | p_id |\n+----+------+\n| 1  | null |\n| 2  | 1    |\n| 3  | 1    |\n| 4  | 2    |\n| 5  | 2    |\n+----+------+\n</code></pre>\n<p>树中每个节点属于以下三种类型之一：</p>\n<ul>\n<li>叶子：如果这个节点没有任何孩子节点。</li>\n<li>根：如果这个节点是整棵树的根，即没有父节点。</li>\n<li>内部节点：如果这个节点既不是叶子节点也不是根节点。</li>\n</ul>\n<p>写一个查询语句，输出所有节点的编号和节点的类型，并将结果按照节点编号排序。上面样例的结果为：</p>\n<pre><code>+----+------+\n| id | Type |\n+----+------+\n| 1  | Root |\n| 2  | Inner|\n| 3  | Leaf |\n| 4  | Leaf |\n| 5  | Leaf |\n+----+------+\n</code></pre>\n<p><strong>解释</strong></p>\n<ul>\n<li>\n<p>节点 '1' 是根节点，因为它的父节点是 NULL ，同时它有孩子节点 '2' 和 '3' 。</p>\n</li>\n<li>\n<p>节点 '2' 是内部节点，因为它有父节点 '1' ，也有孩子节点 '4' 和 '5' 。</p>\n</li>\n<li>\n<p>节点 '3', '4' 和 '5' 都是叶子节点，因为它们都有父节点同时没有孩子节点。</p>\n</li>\n<li>\n<p>样例中树的形态如下：</p>\n<p>​\t\t\t  1<br />\n​\t\t\t/   <br />\n​          2       3<br />\n​        /   <br />\n​     4       5</p>\n</li>\n</ul>\n<p><strong>注意</strong></p>\n<p>如果树中只有一个节点，你只需要输出它的根属性。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> p_id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">then</span> <span class=\"token string\">\"Root\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">when</span> id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> ifnull<span class=\"token punctuation\">(</span>p_id<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> tree<span class=\"token punctuation\">)</span> <span class=\"token keyword\">then</span> <span class=\"token string\">\"Leaf\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token string\">\"Inner\"</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span>  <span class=\"token keyword\">Type</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> tree</pre></td></tr></table></figure><h4 id=\"610-判断三角形\"><a class=\"anchor\" href=\"#610-判断三角形\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdHJpYW5nbGUtanVkZ2VtZW50Lw==\">610. 判断三角形</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>一个小学生 Tim 的作业是判断三条线段是否能形成一个三角形。</p>\n<p>然而，这个作业非常繁重，因为有几百组线段需要判断。</p>\n<p>假设表  <code>triangle</code>  保存了所有三条线段的三元组 x, y, z ，你能帮 Tim 写一个查询语句，来判断每个三元组是否可以组成一个三角形吗？</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>y</th>\n<th>z</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>13</td>\n<td>15</td>\n<td>30</td>\n</tr>\n<tr>\n<td>10</td>\n<td>20</td>\n<td>15</td>\n</tr>\n</tbody>\n</table>\n<p>对于如上样例数据，你的查询语句应该返回如下结果：</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>y</th>\n<th>z</th>\n<th>triangle</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>13</td>\n<td>15</td>\n<td>30</td>\n<td>No</td>\n</tr>\n<tr>\n<td>10</td>\n<td>20</td>\n<td>15</td>\n<td>Yes</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">+</span>y<span class=\"token operator\">></span>z <span class=\"token operator\">&amp;&amp;</span> x<span class=\"token operator\">+</span>z<span class=\"token operator\">></span>y <span class=\"token operator\">&amp;&amp;</span> y<span class=\"token operator\">+</span>z<span class=\"token operator\">></span>x<span class=\"token punctuation\">,</span><span class=\"token string\">'Yes'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'No'</span><span class=\"token punctuation\">)</span> triangle</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> triangle</pre></td></tr></table></figure><h4 id=\"612-平面上的最近距离\"><a class=\"anchor\" href=\"#612-平面上的最近距离\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2hvcnRlc3QtZGlzdGFuY2UtaW4tYS1wbGFuZS8=\">612. 平面上的最近距离</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表  <code>point_2d</code>  保存了所有点（多于 2 个点）的坐标 (x,y) ，这些点在平面上两两不重合。</p>\n<p>写一个查询语句找到两点之间的最近距离，保留 2 位小数。</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>y</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>-1</td>\n<td>-1</td>\n</tr>\n<tr>\n<td>0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>-1</td>\n<td>-2</td>\n</tr>\n</tbody>\n</table>\n<p>最近距离在点 (-1,-1) 和 (-1,2) 之间，距离为 1.00 。所以输出应该为：</p>\n<table>\n<thead>\n<tr>\n<th>shortest</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1.00</td>\n</tr>\n</tbody>\n</table>\n<p>** 注意：** 任意点之间的最远距离小于 10000 。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span>SQRT<span class=\"token punctuation\">(</span><span class=\"token function\">MIN</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>POW<span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p2<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> POW<span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> p2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> shortest</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    point_2d p1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    point_2d p2 <span class=\"token keyword\">ON</span> p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">!=</span> p2<span class=\"token punctuation\">.</span>x <span class=\"token operator\">OR</span> p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">!=</span> p2<span class=\"token punctuation\">.</span>y</pre></td></tr></table></figure><p>优化 ：减少重复计算</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span>SQRT<span class=\"token punctuation\">(</span><span class=\"token function\">MIN</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>POW<span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p2<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> POW<span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> p2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> shortest</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    point_2d p1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    point_2d p2 <span class=\"token keyword\">ON</span> <span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;=</span> p2<span class=\"token punctuation\">.</span>x <span class=\"token operator\">AND</span> p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">&lt;</span> p2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token operator\">OR</span> <span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;=</span> p2<span class=\"token punctuation\">.</span>x <span class=\"token operator\">AND</span> p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">></span> p2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token operator\">OR</span> <span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;</span> p2<span class=\"token punctuation\">.</span>x <span class=\"token operator\">AND</span> p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> p2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"613-直线上的最近距离\"><a class=\"anchor\" href=\"#613-直线上的最近距离\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2hvcnRlc3QtZGlzdGFuY2UtaW4tYS1saW5lLw==\">613. 直线上的最近距离</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表  <code>point</code>  保存了一些点在 x 轴上的坐标，这些坐标都是整数。</p>\n<p>写一个查询语句，找到这些点中最近两个点之间的距离。</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>-1</td>\n</tr>\n<tr>\n<td>0</td>\n</tr>\n<tr>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>最近距离显然是 '1' ，是点 '-1' 和 '0' 之间的距离。所以输出应该如下：</p>\n<table>\n<thead>\n<tr>\n<th>shortest</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>** 注意：** 每个点都与其他点坐标不同，表  <code>table</code>  不会有重复坐标出现。</p>\n<p>** 进阶：** 如果这些点在 x 轴上从左到右都有一个编号，输出结果时需要输出最近点对的编号呢？</p>\n<p>开窗方法 178m</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>l<span class=\"token operator\">-</span>x<span class=\"token punctuation\">)</span> shortest</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> x<span class=\"token punctuation\">,</span>lead<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> x<span class=\"token punctuation\">)</span> l</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token keyword\">point</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr></table></figure><p>join 方法 268m</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">MIN</span><span class=\"token punctuation\">(</span>ABS<span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p2<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> shortest</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">point</span> p1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">point</span> p2 <span class=\"token keyword\">ON</span> p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">!=</span> p2<span class=\"token punctuation\">.</span>x</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"614-二级关注者\"><a class=\"anchor\" href=\"#614-二级关注者\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2Vjb25kLWRlZ3JlZS1mb2xsb3dlci8=\">614. 二级关注者</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>在 facebook 中，表  <code>follow</code>  会有 2 个字段： <strong>followee</strong>, <strong>follower</strong> ，分别表示被关注者和关注者。</p>\n<p>请写一个 sql 查询语句，对每一个关注者，查询关注他的关注者的数目。</p>\n<p>比方说：</p>\n<pre><code>+-------------+------------+\n| followee    | follower   |\n+-------------+------------+\n|     A       |     B      |\n|     B       |     C      |\n|     B       |     D      |\n|     D       |     E      |\n+-------------+------------+\n</code></pre>\n<p>应该输出：</p>\n<pre><code>+-------------+------------+\n| follower    | num        |\n+-------------+------------+\n|     B       |  2         |\n|     D       |  1         |\n+-------------+------------+\n</code></pre>\n<p><strong>解释：</strong></p>\n<p>B 和 D 都在在 <strong>follower</strong> 字段中出现，作为被关注者，B 被 C 和 D 关注，D 被 E 关注。A 不在 <strong>follower</strong> 字段内，所以 A 不在输出列表中。</p>\n<p><strong>注意：</strong></p>\n<ul>\n<li>被关注者永远不会被他 / 她自己关注。</li>\n<li>将结果按照字典序返回。</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> followee follower<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> follower<span class=\"token punctuation\">)</span> num</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> follow</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> followee  <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> follower</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> follow</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> follower</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> followee</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> follower</pre></td></tr></table></figure><blockquote>\n<p>这里出现了重复关注 ，需要去重</p>\n</blockquote>\n<h4 id=\"615-平均工资部门与公司比较\"><a class=\"anchor\" href=\"#615-平均工资部门与公司比较\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYXZlcmFnZS1zYWxhcnktZGVwYXJ0bWVudHMtdnMtY29tcGFueS8=\">615. 平均工资：部门与公司比较</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>给如下两个表，写一个查询语句，求出在每一个工资发放日，每个部门的平均工资与公司的平均工资的比较结果 （高 / 低 / 相同）。</p>\n<p>表：  <code>salary</code></p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>employee_id</th>\n<th>amount</th>\n<th>pay_date</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>9000</td>\n<td>2017-03-31</td>\n</tr>\n<tr>\n<td>2</td>\n<td>2</td>\n<td>6000</td>\n<td>2017-03-31</td>\n</tr>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>10000</td>\n<td>2017-03-31</td>\n</tr>\n<tr>\n<td>4</td>\n<td>1</td>\n<td>7000</td>\n<td>2017-02-28</td>\n</tr>\n<tr>\n<td>5</td>\n<td>2</td>\n<td>6000</td>\n<td>2017-02-28</td>\n</tr>\n<tr>\n<td>6</td>\n<td>3</td>\n<td>8000</td>\n<td>2017-02-28</td>\n</tr>\n</tbody>\n</table>\n<p><strong>employee_id</strong> 字段是表  <code>employee</code>  中 <strong>employee_id</strong> 字段的外键。</p>\n<table>\n<thead>\n<tr>\n<th>employee_id</th>\n<th>department_id</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>3</td>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>对于如上样例数据，结果为：</p>\n<table>\n<thead>\n<tr>\n<th>pay_month</th>\n<th>department_id</th>\n<th>comparison</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>2017-03</td>\n<td>1</td>\n<td>higher</td>\n</tr>\n<tr>\n<td>2017-03</td>\n<td>2</td>\n<td>lower</td>\n</tr>\n<tr>\n<td>2017-02</td>\n<td>1</td>\n<td>same</td>\n</tr>\n<tr>\n<td>2017-02</td>\n<td>2</td>\n<td>same</td>\n</tr>\n</tbody>\n</table>\n<p><strong>解释</strong></p>\n<p>在三月，公司的平均工资是 (9000+6000+10000)/3 = 8333.33...</p>\n<p>由于部门 '1' 里只有一个 <strong>employee_id</strong> 为 '1' 的员工，所以部门 '1' 的平均工资就是此人的工资 9000 。因为 9000 &gt; 8333.33 ，所以比较结果是 'higher'。</p>\n<p>第二个部门的平均工资为 <strong>employee_id</strong> 为 '2' 和 '3' 两个人的平均工资，为 (6000+10000)/2=8000 。因为 8000 &lt; 8333.33 ，所以比较结果是 'lower' 。</p>\n<p>在二月用同样的公式求平均工资并比较，比较结果为'same' ，因为部门 '1' 和部门 '2' 的平均工资与公司的平均工资相同，都是 7000 。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    pay_month<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    department_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     <span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> avgs<span class=\"token operator\">></span>ts <span class=\"token keyword\">then</span> <span class=\"token string\">'higher'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">when</span> avgs<span class=\"token operator\">&lt;</span>ts <span class=\"token keyword\">then</span> <span class=\"token string\">'lower'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">else</span> <span class=\"token string\">'same'</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> comparison</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        date_format<span class=\"token punctuation\">(</span>pay_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span>pay_month<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        department_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> date_format<span class=\"token punctuation\">(</span>pay_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span>ts<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> date_format<span class=\"token punctuation\">(</span>pay_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>department_id<span class=\"token punctuation\">)</span> avgs</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">from</span> salary s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> employee e</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>employee_id <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>employee_id</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> pay_month<span class=\"token punctuation\">,</span> department_id</pre></td></tr></table></figure><blockquote>\n<p>也可以用 if</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>avgs<span class=\"token operator\">></span>ts<span class=\"token punctuation\">,</span><span class=\"token string\">'higher'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>avgs<span class=\"token operator\">=</span>ts<span class=\"token punctuation\">,</span><span class=\"token string\">'same'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'lower'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> comparison</pre></td></tr></table></figure><h4 id=\"618-学生地理信息报告\"><a class=\"anchor\" href=\"#618-学生地理信息报告\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc3R1ZGVudHMtcmVwb3J0LWJ5LWdlb2dyYXBoeS8=\">618. 学生地理信息报告</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>一所美国大学有来自亚洲、欧洲和美洲的学生，他们的地理信息存放在如下  <code>student</code>  表中。</p>\n<table>\n<thead>\n<tr>\n<th>name</th>\n<th>continent</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Jack</td>\n<td>America</td>\n</tr>\n<tr>\n<td>Pascal</td>\n<td>Europe</td>\n</tr>\n<tr>\n<td>Xi</td>\n<td>Asia</td>\n</tr>\n<tr>\n<td>Jane</td>\n<td>America</td>\n</tr>\n</tbody>\n</table>\n<p>写一个查询语句实现对大洲（continent）列的 <span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU5JTgwJThGJUU4JUE3JTg2JUU4JUExJUE4\">透视表</span> 操作，使得每个学生按照姓名的字母顺序依次排列在对应的大洲下面。输出的标题应依次为美洲（America）、亚洲（Asia）和欧洲（Europe）。数据保证来自美洲的学生不少于来自亚洲或者欧洲的学生。</p>\n<p>对于样例输入，它的对应输出是：</p>\n<table>\n<thead>\n<tr>\n<th>America</th>\n<th>Asia</th>\n<th>Europe</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Jack</td>\n<td>Xi</td>\n<td>Pascal</td>\n</tr>\n<tr>\n<td>Jane</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>** 进阶：** 如果不能确定哪个大洲的学生数最多，你可以写出一个查询去生成上述学生报告吗？</p>\n<p>开窗</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>continent<span class=\"token operator\">=</span><span class=\"token string\">'America'</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> America<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>continent<span class=\"token operator\">=</span><span class=\"token string\">'Asia'</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> Asia<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>continent<span class=\"token operator\">=</span><span class=\"token string\">'Europe'</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> Europe</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> continent <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> name<span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">from</span> student<span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> rk</pre></td></tr></table></figure><p>变量</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    America<span class=\"token punctuation\">,</span> Asia<span class=\"token punctuation\">,</span> Europe</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token variable\">@as</span>:<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@am</span>:<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@eu</span>:<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> t<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token variable\">@as</span>:<span class=\"token operator\">=</span><span class=\"token variable\">@as</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">AS</span> asid<span class=\"token punctuation\">,</span> name <span class=\"token keyword\">AS</span> Asia</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        student</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">WHERE</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        continent <span class=\"token operator\">=</span> <span class=\"token string\">'Asia'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> Asia<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> t1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">RIGHT</span> <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token variable\">@am</span>:<span class=\"token operator\">=</span><span class=\"token variable\">@am</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">AS</span> amid<span class=\"token punctuation\">,</span> name <span class=\"token keyword\">AS</span> America</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        student</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">WHERE</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        continent <span class=\"token operator\">=</span> <span class=\"token string\">'America'</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> America<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> t2 <span class=\"token keyword\">ON</span> asid <span class=\"token operator\">=</span> amid</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token variable\">@eu</span>:<span class=\"token operator\">=</span><span class=\"token variable\">@eu</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">AS</span> euid<span class=\"token punctuation\">,</span> name <span class=\"token keyword\">AS</span> Europe</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        student</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">WHERE</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        continent <span class=\"token operator\">=</span> <span class=\"token string\">'Europe'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> Europe<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> t3 <span class=\"token keyword\">ON</span> amid <span class=\"token operator\">=</span> euid</pre></td></tr></table></figure><blockquote>\n<p>官方给出的。。同下方开窗</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> America<span class=\"token punctuation\">,</span>Asia<span class=\"token punctuation\">,</span>Europe </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> rn<span class=\"token punctuation\">,</span>name <span class=\"token keyword\">as</span> America <span class=\"token keyword\">from</span> student</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">where</span> continent<span class=\"token operator\">=</span><span class=\"token string\">'America'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">select</span> row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> rn<span class=\"token punctuation\">,</span>name <span class=\"token keyword\">as</span> Asia <span class=\"token keyword\">from</span> student</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">where</span> continent<span class=\"token operator\">=</span><span class=\"token string\">'Asia'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span> b <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>rn<span class=\"token operator\">=</span>b<span class=\"token punctuation\">.</span>rn</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">select</span> row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> rn<span class=\"token punctuation\">,</span>name <span class=\"token keyword\">as</span> Europe <span class=\"token keyword\">from</span> student</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">where</span> continent<span class=\"token operator\">=</span><span class=\"token string\">'Europe'</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">)</span> c <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>rn<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span>rn</pre></td></tr></table></figure><h4 id=\"619-只出现一次的最大数字\"><a class=\"anchor\" href=\"#619-只出现一次的最大数字\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYmlnZ2VzdC1zaW5nbGUtbnVtYmVyLw==\">619. 只出现一次的最大数字</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表  <code>my_numbers</code>  的 <strong>num</strong> 字段包含很多数字，其中包括很多重复的数字。</p>\n<p>你能写一个 SQL 查询语句，找到只出现过一次的数字中，最大的一个数字吗？</p>\n<pre><code>+---+\n|num|\n+---+\n| 8 |\n| 8 |\n| 3 |\n| 3 |\n| 1 |\n| 4 |\n| 5 |\n| 6 | \n</code></pre>\n<p>对于上面给出的样例数据，你的查询语句应该返回如下结果：</p>\n<pre><code>+---+\n|num|\n+---+\n| 6 |\n</code></pre>\n<p><strong>注意：</strong></p>\n<p>如果没有只出现一次的数字，输出 <strong>null</strong> 。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">MAX</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> num</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        num</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        my_numbers</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> num</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">HAVING</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> t1</pre></td></tr></table></figure><h4 id=\"620-有趣的电影\"><a class=\"anchor\" href=\"#620-有趣的电影\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbm90LWJvcmluZy1tb3ZpZXMv\">620. 有趣的电影</span></h4>\n<p>难度简单 86 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>某城市开了一家新的电影院，吸引了很多人过来看电影。该电影院特别注意用户体验，专门有个 LED 显示板做电影推荐，上面公布着影评和相关电影描述。</p>\n<p>作为该电影院的信息部主管，您需要编写一个 SQL 查询，找出所有影片描述为<strong>非</strong>  <code>boring</code>  (不无聊) 的并且 <strong>id 为奇数</strong> 的影片，结果请按等级  <code>rating</code>  排列。</p>\n<p>例如，下表  <code>cinema</code> :</p>\n<pre><code>+---------+-----------+--------------+-----------+\n|   id    | movie     |  description |  rating   |\n+---------+-----------+--------------+-----------+\n|   1     | War       |   great 3D   |   8.9     |\n|   2     | Science   |   fiction    |   8.5     |\n|   3     | irish     |   boring     |   6.2     |\n|   4     | Ice song  |   Fantacy    |   8.6     |\n|   5     | House card|   Interesting|   9.1     |\n+---------+-----------+--------------+-----------+\n</code></pre>\n<p>对于上面的例子，则正确的输出是为：</p>\n<pre><code>+---------+-----------+--------------+-----------+\n|   id    | movie     |  description |  rating   |\n+---------+-----------+--------------+-----------+\n|   5     | House card|   Interesting|   9.1     |\n|   1     | War       |   great 3D   |   8.9     |\n+---------+-----------+--------------+-----------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  id<span class=\"token punctuation\">,</span>movie<span class=\"token punctuation\">,</span>description<span class=\"token punctuation\">,</span>rating </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> cinema</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> id<span class=\"token operator\">%</span><span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> description <span class=\"token operator\">!=</span><span class=\"token string\">'boring'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> rating <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>id<span class=\"token punctuation\">,</span>movie<span class=\"token punctuation\">,</span>description</pre></td></tr></table></figure><h4 id=\"626-换座位\"><a class=\"anchor\" href=\"#626-换座位\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZXhjaGFuZ2Utc2VhdHMv\">626. 换座位</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>小美是一所中学的信息科技老师，她有一张  <code>seat</code>  座位表，平时用来储存学生名字和与他们相对应的座位 id。</p>\n<p>其中纵列的 <strong>id</strong> 是连续递增的</p>\n<p>小美想改变相邻俩学生的座位。</p>\n<p>你能不能帮她写一个 SQL query 来输出小美想要的结果呢？</p>\n<p><strong>示例：</strong></p>\n<pre><code>+---------+---------+\n|    id   | student |\n+---------+---------+\n|    1    | Abbot   |\n|    2    | Doris   |\n|    3    | Emerson |\n|    4    | Green   |\n|    5    | Jeames  |\n+---------+---------+\n</code></pre>\n<p>假如数据输入的是上表，则输出结果如下：</p>\n<pre><code>+---------+---------+\n|    id   | student |\n+---------+---------+\n|    1    | Doris   |\n|    2    | Abbot   |\n|    3    | Green   |\n|    4    | Emerson |\n|    5    | Jeames  |\n+---------+---------+\n</code></pre>\n<p><strong>注意：</strong></p>\n<p>如果学生人数是奇数，则不需要改变最后一个同学的座位。</p>\n<p>开窗</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> id<span class=\"token operator\">%</span><span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token keyword\">then</span> f</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token keyword\">when</span> id<span class=\"token operator\">%</span><span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> b <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">then</span> b</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token keyword\">else</span> student <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> student</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>student<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    lag<span class=\"token punctuation\">(</span>student<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> f<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    lead<span class=\"token punctuation\">(</span>student<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">from</span> seat</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr></table></figure><p>非嵌套</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">%</span><span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        id<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> seat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            id<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">as</span> id<span class=\"token punctuation\">,</span>student </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> seat </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>用异或</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> b<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">.</span>student <span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>seat <span class=\"token keyword\">as</span> a<span class=\"token punctuation\">,</span>seat <span class=\"token keyword\">as</span> b<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> cnt <span class=\"token keyword\">from</span> seat<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> c </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> b<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token operator\">^</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>id<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">-- where a.id=1^(b.id-1)+1; 也可以这样写，更容易理解</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>cnt<span class=\"token operator\">%</span><span class=\"token number\">2</span> <span class=\"token operator\">&amp;&amp;</span> b<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span>cnt <span class=\"token operator\">&amp;&amp;</span> a<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span>cnt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"627-交换工资\"><a class=\"anchor\" href=\"#627-交换工资\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc3dhcC1zYWxhcnkv\">627. 交换工资</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>给定一个  <code>salary</code>  表，如下所示，有 m = 男性 和 f = 女性 的值。交换所有的 f 和 m 值（例如，将所有 f 值更改为 m，反之亦然）。要求只使用一个更新（Update）语句，并且没有中间的临时表。</p>\n<p>注意，您必只能写一个 Update 语句，请不要编写任何 Select 语句。</p>\n<p><strong>例如：</strong></p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>name</th>\n<th>sex</th>\n<th>salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>A</td>\n<td>m</td>\n<td>2500</td>\n</tr>\n<tr>\n<td>2</td>\n<td>B</td>\n<td>f</td>\n<td>1500</td>\n</tr>\n<tr>\n<td>3</td>\n<td>C</td>\n<td>m</td>\n<td>5500</td>\n</tr>\n<tr>\n<td>4</td>\n<td>D</td>\n<td>f</td>\n<td>500</td>\n</tr>\n</tbody>\n</table>\n<p>运行你所编写的更新语句之后，将会得到以下表:</p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>name</th>\n<th>sex</th>\n<th>salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>A</td>\n<td>f</td>\n<td>2500</td>\n</tr>\n<tr>\n<td>2</td>\n<td>B</td>\n<td>m</td>\n<td>1500</td>\n</tr>\n<tr>\n<td>3</td>\n<td>C</td>\n<td>f</td>\n<td>5500</td>\n</tr>\n<tr>\n<td>4</td>\n<td>D</td>\n<td>m</td>\n<td>500</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">UPDATE</span> salary</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">SET</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    sex <span class=\"token operator\">=</span> <span class=\"token keyword\">CASE</span> sex</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'m'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'f'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">ELSE</span> <span class=\"token string\">'m'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><blockquote>\n<p>Update 和 set 的使用</p>\n</blockquote>\n<h4 id=\"1045-买下所有产品的客户\"><a class=\"anchor\" href=\"#1045-买下所有产品的客户\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3VzdG9tZXJzLXdoby1ib3VnaHQtYWxsLXByb2R1Y3RzLw==\">1045. 买下所有产品的客户</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Customer</code>  表：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| customer_id | int     |\n| product_key | int     |\n+-------------+---------+\nproduct_key 是 Customer 表的外键。\n</code></pre>\n<p><code>Product</code>  表：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| product_key | int     |\n+-------------+---------+\nproduct_key 是这张表的主键。\n</code></pre>\n<p>写一条 SQL 查询语句，从  <code>Customer</code>  表中查询购买了  <code>Product</code>  表中所有产品的客户的 id。</p>\n<p><strong>示例：</strong></p>\n<pre><code>Customer 表：\n+-------------+-------------+\n| customer_id | product_key |\n+-------------+-------------+\n| 1           | 5           |\n| 2           | 6           |\n| 3           | 5           |\n| 3           | 6           |\n| 1           | 6           |\n+-------------+-------------+\n\nProduct 表：\n+-------------+\n| product_key |\n+-------------+\n| 5           |\n| 6           |\n+-------------+\n\nResult 表：\n+-------------+\n| customer_id |\n+-------------+\n| 1           |\n| 3           |\n+-------------+\n购买了所有产品（5 和 6）的客户的 id 是 1 和 3 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> customer_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Customer</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> product_key<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Product<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1050-合作过至少三次的演员和导演\"><a class=\"anchor\" href=\"#1050-合作过至少三次的演员和导演\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWN0b3JzLWFuZC1kaXJlY3RvcnMtd2hvLWNvb3BlcmF0ZWQtYXQtbGVhc3QtdGhyZWUtdGltZXMv\">1050. 合作过至少三次的演员和导演</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p><code>ActorDirector</code>  表：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| actor_id    | int     |\n| director_id | int     |\n| timestamp   | int     |\n+-------------+---------+\ntimestamp 是这张表的主键.\n</code></pre>\n<p>写一条 SQL 查询语句获取合作过至少三次的演员和导演的 id 对  <code>(actor_id, director_id)</code></p>\n<p><strong>示例：</strong></p>\n<pre><code>ActorDirector 表：\n+-------------+-------------+-------------+\n| actor_id    | director_id | timestamp   |\n+-------------+-------------+-------------+\n| 1           | 1           | 0           |\n| 1           | 1           | 1           |\n| 1           | 1           | 2           |\n| 1           | 2           | 3           |\n| 1           | 2           | 4           |\n| 2           | 1           | 5           |\n| 2           | 1           | 6           |\n+-------------+-------------+-------------+\n\nResult 表：\n+-------------+-------------+\n| actor_id    | director_id |\n+-------------+-------------+\n| 1           | 1           |\n+-------------+-------------+\n唯一的 id 对是 (1, 1)，他们恰好合作了 3 次。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> actor_id<span class=\"token punctuation\">,</span>director_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> ActorDirector</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> actor_id<span class=\"token punctuation\">,</span>director_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">3</span></pre></td></tr></table></figure><h4 id=\"1068-产品销售分析-i\"><a class=\"anchor\" href=\"#1068-产品销售分析-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvZHVjdC1zYWxlcy1hbmFseXNpcy1pLw==\">1068. 产品销售分析 I</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>销售表  <code>Sales</code> ：</p>\n<pre><code>+-------------+-------+\n| Column Name | Type  |\n+-------------+-------+\n| sale_id     | int   |\n| product_id  | int   |\n| year        | int   |\n| quantity    | int   |\n| price       | int   |\n+-------------+-------+\n(sale_id, year) 是销售表 Sales 的主键.\nproduct_id 是产品表 Product 的外键.\n注意: price 表示每单位价格\n</code></pre>\n<p>产品表  <code>Product</code> ：</p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n+--------------+---------+\nproduct_id 是表的主键.\n</code></pre>\n<p>写一条 SQL 查询语句获取产品表  <code>Product</code>  中所有的 <strong>产品名称 product name</strong> 以及 该产品在  <code>Sales</code>  表中相对应的 <strong>上市年份 year</strong> 和 <strong>价格 price</strong>。</p>\n<p>示例：</p>\n<pre><code>Sales 表：\n+---------+------------+------+----------+-------+\n| sale_id | product_id | year | quantity | price |\n+---------+------------+------+----------+-------+ \n| 1       | 100        | 2008 | 10       | 5000  |\n| 2       | 100        | 2009 | 12       | 5000  |\n| 7       | 200        | 2011 | 15       | 9000  |\n+---------+------------+------+----------+-------+\n\nProduct 表：\n+------------+--------------+\n| product_id | product_name |\n+------------+--------------+\n| 100        | Nokia        |\n| 200        | Apple        |\n| 300        | Samsung      |\n+------------+--------------+\n\nResult 表：\n+--------------+-------+-------+\n| product_name | year  | price |\n+--------------+-------+-------+\n| Nokia        | 2008  | 5000  |\n| Nokia        | 2009  | 5000  |\n| Apple        | 2011  | 9000  |\n+--------------+-------+-------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_name<span class=\"token punctuation\">,</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">,</span>price</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Sales s <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Product p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>product_id  <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr></table></figure><h4 id=\"1069-产品销售分析-ii\"><a class=\"anchor\" href=\"#1069-产品销售分析-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvZHVjdC1zYWxlcy1hbmFseXNpcy1paS8=\">1069. 产品销售分析 II</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>销售表： <code>Sales</code></p>\n<pre><code>+-------------+-------+\n| Column Name | Type  |\n+-------------+-------+\n| sale_id     | int   |\n| product_id  | int   |\n| year        | int   |\n| quantity    | int   |\n| price       | int   |\n+-------------+-------+\nsale_id 是这个表的主键。\nproduct_id 是 Product 表的外键。\n请注意价格是每单位的。\n</code></pre>\n<p>产品表： <code>Product</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n+--------------+---------+\nproduct_id 是这个表的主键。\n</code></pre>\n<p>编写一个 SQL 查询，按产品 id  <code>product_id</code>  来统计每个产品的销售总量。</p>\n<p>查询结果格式如下面例子所示:</p>\n<pre><code>Sales 表：\n+---------+------------+------+----------+-------+\n| sale_id | product_id | year | quantity | price |\n+---------+------------+------+----------+-------+ \n| 1       | 100        | 2008 | 10       | 5000  |\n| 2       | 100        | 2009 | 12       | 5000  |\n| 7       | 200        | 2011 | 15       | 9000  |\n+---------+------------+------+----------+-------+\n\nProduct 表：\n+------------+--------------+\n| product_id | product_name |\n+------------+--------------+\n| 100        | Nokia        |\n| 200        | Apple        |\n| 300        | Samsung      |\n+------------+--------------+\n\nResult 表：\n+--------------+----------------+\n| product_id   | total_quantity |\n+--------------+----------------+\n| 100          | 22             |\n| 200          | 15             |\n+--------------+----------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span> total_quantity</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Sales s <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Product p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>product_id  <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> s<span class=\"token punctuation\">.</span>product_id</pre></td></tr></table></figure><h4 id=\"1070-产品销售分析-iii\"><a class=\"anchor\" href=\"#1070-产品销售分析-iii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvZHVjdC1zYWxlcy1hbmFseXNpcy1paWkv\">1070. 产品销售分析 III</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>销售表  <code>Sales</code> ：</p>\n<pre><code>+-------------+-------+\n| Column Name | Type  |\n+-------------+-------+\n| sale_id     | int   |\n| product_id  | int   |\n| year        | int   |\n| quantity    | int   |\n| price       | int   |\n+-------------+-------+\nsale_id 是此表的主键。\nproduct_id 是产品表的外键。\n请注意，价格是按每单位计的。\n</code></pre>\n<p>产品表  <code>Product</code> ：</p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n+--------------+---------+\nproduct_id 是此表的主键。\n</code></pre>\n<p>编写一个 SQL 查询，选出每个销售产品的 <strong>第一年</strong> 的 <strong>产品 id</strong>、<strong>年份</strong>、<strong>数量</strong> 和 <strong>价格</strong>。</p>\n<p>查询结果格式如下：</p>\n<pre><code>Sales table:\n+---------+------------+------+----------+-------+\n| sale_id | product_id | year | quantity | price |\n+---------+------------+------+----------+-------+ \n| 1       | 100        | 2008 | 10       | 5000  |\n| 2       | 100        | 2009 | 12       | 5000  |\n| 7       | 200        | 2011 | 15       | 9000  |\n+---------+------------+------+----------+-------+\n\nProduct table:\n+------------+--------------+\n| product_id | product_name |\n+------------+--------------+\n| 100        | Nokia        |\n| 200        | Apple        |\n| 300        | Samsung      |\n+------------+--------------+\n\nResult table:\n+------------+------------+----------+-------+\n| product_id | first_year | quantity | price |\n+------------+------------+----------+-------+ \n| 100        | 2008       | 10       | 5000  |\n| 200        | 2011       | 15       | 9000  |\n+------------+------------+----------+-------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_id<span class=\"token punctuation\">,</span><span class=\"token keyword\">year</span> first_year<span class=\"token punctuation\">,</span>quantity<span class=\"token punctuation\">,</span>price</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">,</span>quantity<span class=\"token punctuation\">,</span>price<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> product_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Sales s <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Product p</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>product_id  <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1075-项目员工-i\"><a class=\"anchor\" href=\"#1075-项目员工-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvamVjdC1lbXBsb3llZXMtaS8=\">1075. 项目员工 I</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>项目表  <code>Project</code> ：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| project_id  | int     |\n| employee_id | int     |\n+-------------+---------+\n主键为 (project_id, employee_id)。\nemployee_id 是员工表 Employee 表的外键。\n</code></pre>\n<p>员工表  <code>Employee</code> ：</p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| employee_id      | int     |\n| name             | varchar |\n| experience_years | int     |\n+------------------+---------+\n主键是 employee_id。\n</code></pre>\n<p>请写一个 SQL 语句，查询每一个项目中员工的 <strong>平均</strong> 工作年限，<strong>精确到小数点后两位</strong>。</p>\n<p>查询结果的格式如下：</p>\n<pre><code>Project 表：\n+-------------+-------------+\n| project_id  | employee_id |\n+-------------+-------------+\n| 1           | 1           |\n| 1           | 2           |\n| 1           | 3           |\n| 2           | 1           |\n| 2           | 4           |\n+-------------+-------------+\n\nEmployee 表：\n+-------------+--------+------------------+\n| employee_id | name   | experience_years |\n+-------------+--------+------------------+\n| 1           | Khaled | 3                |\n| 2           | Ali    | 2                |\n| 3           | John   | 1                |\n| 4           | Doe    | 2                |\n+-------------+--------+------------------+\n\nResult 表：\n+-------------+---------------+\n| project_id  | average_years |\n+-------------+---------------+\n| 1           | 2.00          |\n| 2           | 2.50          |\n+-------------+---------------+\n第一个项目中，员工的平均工作年限是 (3 + 2 + 1) / 3 = 2.00；第二个项目中，员工的平均工作年限是 (3 + 2) / 2 = 2.50\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> project_id<span class=\"token punctuation\">,</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>experience_years<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> average_years</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Project p <span class=\"token keyword\">join</span> Employee e</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> p<span class=\"token punctuation\">.</span>employee_id<span class=\"token operator\">=</span>e<span class=\"token punctuation\">.</span>employee_id </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> project_id</pre></td></tr></table></figure><h4 id=\"1076-项目员工ii\"><a class=\"anchor\" href=\"#1076-项目员工ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvamVjdC1lbXBsb3llZXMtaWkv\">1076. 项目员工 II</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Project</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| project_id  | int     |\n| employee_id | int     |\n+-------------+---------+\n主键为 (project_id, employee_id)。\nemployee_id 是员工表 Employee 表的外键。\n</code></pre>\n<p>Table:  <code>Employee</code></p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| employee_id      | int     |\n| name             | varchar |\n| experience_years | int     |\n+------------------+---------+\n主键是 employee_id。\n</code></pre>\n<p>编写一个 SQL 查询，报告所有雇员最多的项目。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Project table:\n+-------------+-------------+\n| project_id  | employee_id |\n+-------------+-------------+\n| 1           | 1           |\n| 1           | 2           |\n| 1           | 3           |\n| 2           | 1           |\n| 2           | 4           |\n+-------------+-------------+\n\nEmployee table:\n+-------------+--------+------------------+\n| employee_id | name   | experience_years |\n+-------------+--------+------------------+\n| 1           | Khaled | 3                |\n| 2           | Ali    | 2                |\n| 3           | John   | 1                |\n| 4           | Doe    | 2                |\n+-------------+--------+------------------+\n\nResult table:\n+-------------+\n| project_id  |\n+-------------+\n| 1           |\n+-------------+\n第一个项目有3名员工，第二个项目有2名员工。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> project_id </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Project </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> project_id </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">`</span>num<span class=\"token punctuation\">`</span> <span class=\"token keyword\">from</span> Project <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> project_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span> <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>开窗</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> project_id <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> project_id<span class=\"token punctuation\">,</span>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>employee_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> ranking <span class=\"token keyword\">from</span> Project <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> project_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">temp</span> <span class=\"token keyword\">where</span> ranking<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1077-项目员工-iii\"><a class=\"anchor\" href=\"#1077-项目员工-iii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvamVjdC1lbXBsb3llZXMtaWlpLw==\">1077. 项目员工 III</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>项目表  <code>Project</code> ：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| project_id  | int     |\n| employee_id | int     |\n+-------------+---------+\n(project_id, employee_id) 是这个表的主键\nemployee_id 是员工表 Employee 的外键\n</code></pre>\n<p>员工表  <code>Employee</code> ：</p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| employee_id      | int     |\n| name             | varchar |\n| experience_years | int     |\n+------------------+---------+\nemployee_id 是这个表的主键\n</code></pre>\n<p>写 一个 SQL 查询语句，报告在每一个项目中经验最丰富的雇员是谁。如果出现经验年数相同的情况，请报告所有具有最大经验年数的员工。</p>\n<p>查询结果格式在以下示例中：</p>\n<pre><code>Project 表：\n+-------------+-------------+\n| project_id  | employee_id |\n+-------------+-------------+\n| 1           | 1           |\n| 1           | 2           |\n| 1           | 3           |\n| 2           | 1           |\n| 2           | 4           |\n+-------------+-------------+\n\nEmployee 表：\n+-------------+--------+------------------+\n| employee_id | name   | experience_years |\n+-------------+--------+------------------+\n| 1           | Khaled | 3                |\n| 2           | Ali    | 2                |\n| 3           | John   | 3                |\n| 4           | Doe    | 2                |\n+-------------+--------+------------------+\n\nResult 表：\n+-------------+---------------+\n| project_id  | employee_id   |\n+-------------+---------------+\n| 1           | 1             |\n| 1           | 3             |\n| 2           | 1             |\n+-------------+---------------+\nemployee_id 为 1 和 3 的员工在 project_id 为 1 的项目中拥有最丰富的经验。在 project_id 为 2 的项目中，employee_id 为 1 的员工拥有最丰富的经验。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> project_id <span class=\"token punctuation\">,</span>employee_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> project_id<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>employee_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> project_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> experience_years <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Project p <span class=\"token keyword\">join</span> Employee e</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">on</span> p<span class=\"token punctuation\">.</span>employee_id<span class=\"token operator\">=</span>e<span class=\"token punctuation\">.</span>employee_id </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> rk<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1082-销售分析-i\"><a class=\"anchor\" href=\"#1082-销售分析-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2FsZXMtYW5hbHlzaXMtaS8=\">1082. 销售分析 I </span></h4>\n<p>难度简单 22</p>\n<p>SQL 架构</p>\n<p>产品表： <code>Product</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n| unit_price   | int     |\n+--------------+---------+\nproduct_id 是这个表的主键.\n</code></pre>\n<p>销售表： <code>Sales</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| seller_id   | int     |\n| product_id  | int     |\n| buyer_id    | int     |\n| sale_date   | date    |\n| quantity    | int     |\n| price       | int     |\n+------ ------+---------+\n这个表没有主键，它可以有重复的行.\nproduct_id 是 Product 表的外键.\n</code></pre>\n<p>编写一个 SQL 查询，查询总销售额最高的销售者，如果有并列的，就都展示出来。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Product 表：\n+------------+--------------+------------+\n| product_id | product_name | unit_price |\n+------------+--------------+------------+\n| 1          | S8           | 1000       |\n| 2          | G4           | 800        |\n| 3          | iPhone       | 1400       |\n+------------+--------------+------------+\n\nSales 表：\n+-----------+------------+----------+------------+----------+-------+\n| seller_id | product_id | buyer_id | sale_date  | quantity | price |\n+-----------+------------+----------+------------+----------+-------+\n| 1         | 1          | 1        | 2019-01-21 | 2        | 2000  |\n| 1         | 2          | 2        | 2019-02-17 | 1        | 800   |\n| 2         | 2          | 3        | 2019-06-02 | 1        | 800   |\n| 3         | 3          | 4        | 2019-05-13 | 2        | 2800  |\n+-----------+------------+----------+------------+----------+-------+\n\nResult 表：\n+-------------+\n| seller_id   |\n+-------------+\n| 1           |\n| 3           |\n+-------------+\nId 为 1 和 3 的销售者，销售总金额都为最高的 2800。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> seller_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> seller_id <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>price<span class=\"token punctuation\">)</span> tp<span class=\"token punctuation\">,</span>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>price<span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Sales</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> seller_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1083-销售分析-ii\"><a class=\"anchor\" href=\"#1083-销售分析-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2FsZXMtYW5hbHlzaXMtaWkv\">1083. 销售分析 II</span></h4>\n<p>难度简单 13</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Product</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n| unit_price   | int     |\n+--------------+---------+\nproduct_id 是这张表的主键\n</code></pre>\n<p>Table:  <code>Sales</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| seller_id   | int     |\n| product_id  | int     |\n| buyer_id    | int     |\n| sale_date   | date    |\n| quantity    | int     |\n| price       | int     |\n+------ ------+---------+\n这个表没有主键，它可以有重复的行.\nproduct_id 是 Product 表的外键.\n</code></pre>\n<p>编写一个 SQL 查询，查询购买了 S8 手机却没有购买 iPhone 的买家。注意这里 S8 和 iPhone 是 Product 表中的产品。</p>\n<p>查询结果格式如下图表示：</p>\n<pre><code>Product table:\n+------------+--------------+------------+\n| product_id | product_name | unit_price |\n+------------+--------------+------------+\n| 1          | S8           | 1000       |\n| 2          | G4           | 800        |\n| 3          | iPhone       | 1400       |\n+------------+--------------+------------+\n\nSales table:\n+-----------+------------+----------+------------+----------+-------+\n| seller_id | product_id | buyer_id | sale_date  | quantity | price |\n+-----------+------------+----------+------------+----------+-------+\n| 1         | 1          | 1        | 2019-01-21 | 2        | 2000  |\n| 1         | 2          | 2        | 2019-02-17 | 1        | 800   |\n| 2         | 1          | 3        | 2019-06-02 | 1        | 800   |\n| 3         | 3          | 3        | 2019-05-13 | 2        | 2800  |\n+-----------+------------+----------+------------+----------+-------+\n\nResult table:\n+-------------+\n| buyer_id    |\n+-------------+\n| 1           |\n+-------------+\nid 为 1 的买家购买了一部 S8，但是却没有购买 iPhone，而 id 为 3 的买家却同时购买了这 2 部手机。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> t<span class=\"token punctuation\">.</span>buyer_id <span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>buyer_id<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>product_name</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> sales s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>product p</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>product_id<span class=\"token operator\">=</span>p<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'S8'</span> <span class=\"token operator\">or</span> p<span class=\"token punctuation\">.</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'iPhone'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> s<span class=\"token punctuation\">.</span>buyer_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> p<span class=\"token punctuation\">.</span>product_name<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">where</span> t<span class=\"token punctuation\">.</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'S8'</span></pre></td></tr></table></figure><p>效率低</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>buyer_id </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> sales <span class=\"token keyword\">as</span> s <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> product <span class=\"token keyword\">as</span> p </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>product_id<span class=\"token operator\">=</span>p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> buyer_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'S8'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token number\">0</span> <span class=\"token operator\">and</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'iPhone'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><h4 id=\"1084-销售分析iii\"><a class=\"anchor\" href=\"#1084-销售分析iii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2FsZXMtYW5hbHlzaXMtaWlpLw==\">1084. 销售分析 III</span></h4>\n<p>难度简单 13</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Product</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n| unit_price   | int     |\n+--------------+---------+\nproduct_id 是这个表的主键\n</code></pre>\n<p>Table:  <code>Sales</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| seller_id   | int     |\n| product_id  | int     |\n| buyer_id    | int     |\n| sale_date   | date    |\n| quantity    | int     |\n| price       | int     |\n+------ ------+---------+\n这个表没有主键，它可以有重复的行.\nproduct_id 是 Product 表的外键.\n</code></pre>\n<p>编写一个 SQL 查询，报告 2019 年春季才售出的产品。即<strong>仅</strong>在<strong> 2019-01-01</strong> 至<strong> 2019-03-31</strong>（含）之间出售的商品。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Product table:\n+------------+--------------+------------+\n| product_id | product_name | unit_price |\n+------------+--------------+------------+\n| 1          | S8           | 1000       |\n| 2          | G4           | 800        |\n| 3          | iPhone       | 1400       |\n+------------+--------------+------------+\n\nSales table:\n+-----------+------------+----------+------------+----------+-------+\n| seller_id | product_id | buyer_id | sale_date  | quantity | price |\n+-----------+------------+----------+------------+----------+-------+\n| 1         | 1          | 1        | 2019-01-21 | 2        | 2000  |\n| 1         | 2          | 2        | 2019-02-17 | 1        | 800   |\n| 2         | 2          | 3        | 2019-06-02 | 1        | 800   |\n| 3         | 3          | 4        | 2019-05-13 | 2        | 2800  |\n+-----------+------------+----------+------------+----------+-------+\n\nResult table:\n+-------------+--------------+\n| product_id  | product_name |\n+-------------+--------------+\n| 1           | S8           |\n+-------------+--------------+\nid为1的产品仅在2019年春季销售，其他两个产品在之后销售。\n</code></pre>\n<p>876ms</p>\n<p>正常解法</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_id<span class=\"token punctuation\">,</span> product_name  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> product </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> product_id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> product_id <span class=\"token keyword\">from</span> sales </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> sale_date <span class=\"token operator\">></span> <span class=\"token string\">'2019-03-31'</span> <span class=\"token operator\">or</span> sale_date <span class=\"token operator\">&lt;</span> <span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>867ms</p>\n<p>sum = count</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_id<span class=\"token punctuation\">,</span> product_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Sales <span class=\"token keyword\">join</span> Product</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">using</span><span class=\"token punctuation\">(</span>product_id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> product_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>sale_date <span class=\"token operator\">between</span> <span class=\"token string\">\"2019-01-01\"</span> <span class=\"token operator\">and</span> <span class=\"token string\">\"2019-03-31\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>sale_date<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>987ms</p>\n<p>sum 为 0 类似于第一种解法，计算了 sum 效率就低了</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> p<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>product_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> sales s<span class=\"token punctuation\">,</span> product p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> s<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> s<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>sale_date<span class=\"token operator\">></span> <span class=\"token string\">'2019-03-31'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token operator\">and</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>sale_date <span class=\"token operator\">&lt;</span> <span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr></table></figure><p>上一解法 sum 换成 max</p>\n<p>859ms</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> p<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>product_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> sales s<span class=\"token punctuation\">,</span> product p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> s<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> s<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>sale_date<span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token string\">'2019-01-01'</span> <span class=\"token operator\">and</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>sale_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token string\">'2019-03-31'</span></pre></td></tr></table></figure><h4 id=\"1097-游戏玩法分析-v\"><a class=\"anchor\" href=\"#1097-游戏玩法分析-v\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2FtZS1wbGF5LWFuYWx5c2lzLXYv\">1097. 游戏玩法分析 V</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Activity</code>  活动记录表</p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| player_id    | int     |\n| device_id    | int     |\n| event_date   | date    |\n| games_played | int     |\n+--------------+---------+\n（player_id，event_date）是此表的主键\n这张表显示了某些游戏的玩家的活动情况\n每一行是一个玩家的记录，他在某一天使用某个设备注销之前登录并玩了很多游戏（可能是 0）\n</code></pre>\n<p>我们将玩家的安装日期定义为该玩家的第一个登录日。</p>\n<p>我们还将某个日期  <code>X</code>  的第 1 天留存时间定义为安装日期为  <code>X</code>  的玩家的数量，他们在  <code>X</code>  之后的一天重新登录，除以安装日期为  <code>X</code>  的玩家的数量，四舍五入到小数点后两位。</p>\n<p>编写一个 SQL 查询，报告每个安装日期、当天安装游戏的玩家数量和第一天的留存时间。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Activity 表：\n+-----------+-----------+------------+--------------+\n| player_id | device_id | event_date | games_played |\n+-----------+-----------+------------+--------------+\n| 1         | 2         | 2016-03-01 | 5            |\n| 1         | 2         | 2016-03-02 | 6            |\n| 2         | 3         | 2017-06-25 | 1            |\n| 3         | 1         | 2016-03-01 | 0            |\n| 3         | 4         | 2016-07-03 | 5            |\n+-----------+-----------+------------+--------------+\n\nResult 表：\n+------------+----------+----------------+\n| install_dt | installs | Day1_retention |\n+------------+----------+----------------+\n| 2016-03-01 | 2        | 0.50           |\n| 2017-06-25 | 1        | 0.00           |\n+------------+----------+----------------+\n玩家 1 和 3 在 2016-03-01 安装了游戏，但只有玩家 1 在 2016-03-02 重新登录，所以 2016-03-01 的第一天留存时间是 1/2=0.50\n玩家 2 在 2017-06-25 安装了游戏，但在 2017-06-26 没有重新登录，因此 2017-06-25 的第一天留存时间为 0/1=0.00\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> install_dt<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> player_id<span class=\"token punctuation\">)</span>installs<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>       <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>datediff<span class=\"token punctuation\">(</span>event_date<span class=\"token punctuation\">,</span>install_dt<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> player_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> Day1_retention </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>event_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> player_id<span class=\"token punctuation\">)</span> install_dt</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1   </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> install_dt</pre></td></tr></table></figure><h4 id=\"1098-小众书籍\"><a class=\"anchor\" href=\"#1098-小众书籍\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdW5wb3B1bGFyLWJvb2tzLw==\">1098. 小众书籍</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>书籍表  <code>Books</code> ：</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| book_id        | int     |\n| name           | varchar |\n| available_from | date    |\n+----------------+---------+\nbook_id 是这个表的主键。\n</code></pre>\n<p>订单表  <code>Orders</code> ：</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| order_id       | int     |\n| book_id        | int     |\n| quantity       | int     |\n| dispatch_date  | date    |\n+----------------+---------+\norder_id 是这个表的主键。\nbook_id  是 Books 表的外键。\n</code></pre>\n<p>你需要写一段 SQL 命令，筛选出过去一年中订单总量 <strong>少于 10 本</strong> 的 <strong>书籍</strong> 。</p>\n<p>注意：<strong>不考虑</strong> 上架（available from）距今 <strong>不满一个月</strong> 的书籍。并且 <strong>假设今天是</strong> <strong>2019-06-23</strong> 。</p>\n<p>Write an SQL query that reports the books that have sold less than 10 copies in the last year, excluding books that have been available for less than 1 month from today. Assume today is 2019-06-23.</p>\n<p>下面是样例输出结果：</p>\n<pre><code>Books 表：\n+---------+--------------------+----------------+\n| book_id | name               | available_from |\n+---------+--------------------+----------------+\n| 1       | &quot;Kalila And Demna&quot; | 2010-01-01     |\n| 2       | &quot;28 Letters&quot;       | 2012-05-12     |\n| 3       | &quot;The Hobbit&quot;       | 2019-06-10     |\n| 4       | &quot;13 Reasons Why&quot;   | 2019-06-01     |\n| 5       | &quot;The Hunger Games&quot; | 2008-09-21     |\n+---------+--------------------+----------------+\n\nOrders 表：\n+----------+---------+----------+---------------+\n| order_id | book_id | quantity | dispatch_date |\n+----------+---------+----------+---------------+\n| 1        | 1       | 2        | 2018-07-26    |\n| 2        | 1       | 1        | 2018-11-05    |\n| 3        | 3       | 8        | 2019-06-11    |\n| 4        | 4       | 6        | 2019-06-05    |\n| 5        | 4       | 5        | 2019-06-20    |\n| 6        | 5       | 9        | 2009-02-02    |\n| 7        | 5       | 8        | 2010-04-13    |\n+----------+---------+----------+---------------+\n\nResult 表：\n+-----------+--------------------+\n| book_id   | name               |\n+-----------+--------------------+\n| 1         | &quot;Kalila And Demna&quot; |\n| 2         | &quot;28 Letters&quot;       |\n| 5         | &quot;The Hunger Games&quot; |\n+-----------+--------------------+\n</code></pre>\n<blockquote>\n<p>这题中英文 都有歧义，看结果进行分析</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> a<span class=\"token punctuation\">.</span>book_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>name </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> books a <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> orders b <span class=\"token keyword\">ON</span> a<span class=\"token punctuation\">.</span>book_id<span class=\"token operator\">=</span>b<span class=\"token punctuation\">.</span>book_id </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">AND</span> dispatch_date <span class=\"token operator\">BETWEEN</span> DATE_ADD<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-06-23'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">YEAR</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'2019-06-23'</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">WHERE</span> a<span class=\"token punctuation\">.</span>available_from <span class=\"token operator\">&lt;=</span> DATE_ADD<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-06-23'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">INTERVAL</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">MONTH</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>book_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>name </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">HAVING</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>IFNULL<span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>quantity<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>book_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><blockquote>\n<p>此题有坑，首先订单近一年，再者 quantity 为 null，还有近一月出版，sum 不是订单是本数</p>\n<p>还有就是 date_add 这个函数在 hive 里和 mysql 语法上有点小区别</p>\n</blockquote>\n<h4 id=\"1107-每日新用户统计\"><a class=\"anchor\" href=\"#1107-每日新用户统计\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbmV3LXVzZXJzLWRhaWx5LWNvdW50Lw==\">1107. 每日新用户统计</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Traffic</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| activity      | enum    |\n| activity_date | date    |\n+---------------+---------+\n该表没有主键，它可能有重复的行。\nactivity 列是 ENUM 类型，可能取 ('login', 'logout', 'jobs', 'groups', 'homepage') 几个值之一。\n</code></pre>\n<p>编写一个 SQL 查询，以查询从今天起最多 90 天内，每个日期该日期首次登录的用户数。假设今天是 <strong>2019-06-30</strong>.</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Traffic 表：\n+---------+----------+---------------+\n| user_id | activity | activity_date |\n+---------+----------+---------------+\n| 1       | login    | 2019-05-01    |\n| 1       | homepage | 2019-05-01    |\n| 1       | logout   | 2019-05-01    |\n| 2       | login    | 2019-06-21    |\n| 2       | logout   | 2019-06-21    |\n| 3       | login    | 2019-01-01    |\n| 3       | jobs     | 2019-01-01    |\n| 3       | logout   | 2019-01-01    |\n| 4       | login    | 2019-06-21    |\n| 4       | groups   | 2019-06-21    |\n| 4       | logout   | 2019-06-21    |\n| 5       | login    | 2019-03-01    |\n| 5       | logout   | 2019-03-01    |\n| 5       | login    | 2019-06-21    |\n| 5       | logout   | 2019-06-21    |\n+---------+----------+---------------+\n\nResult 表：\n+------------+-------------+\n| login_date | user_count  |\n+------------+-------------+\n| 2019-05-01 | 1           |\n| 2019-06-21 | 2           |\n+------------+-------------+\n请注意，我们只关心用户数非零的日期.\nID 为 5 的用户第一次登陆于 2019-03-01，因此他不算在 2019-06-21 的的统计内。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> login_date<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> user_count</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> user_id<span class=\"token punctuation\">,</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>activity_date<span class=\"token punctuation\">)</span> login_date</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">from</span> Traffic</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">where</span> activity <span class=\"token operator\">=</span> <span class=\"token string\">'login'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> user_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">having</span> login_date<span class=\"token operator\">>=</span> DATE_ADD<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-06-30'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">INTERVAL</span> <span class=\"token operator\">-</span><span class=\"token number\">90</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> login_date</pre></td></tr></table></figure><h4 id=\"1112-每位学生的最高成绩\"><a class=\"anchor\" href=\"#1112-每位学生的最高成绩\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvaGlnaGVzdC1ncmFkZS1mb3ItZWFjaC1zdHVkZW50Lw==\">1112. 每位学生的最高成绩</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表： <code>Enrollments</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| student_id    | int     |\n| course_id     | int     |\n| grade         | int     |\n+---------------+---------+\n(student_id, course_id) 是该表的主键。\n</code></pre>\n<p>编写一个 SQL 查询，查询每位学生获得的最高成绩和它所对应的科目，若科目成绩并列，取  <code>course_id</code>  最小的一门。查询结果需按  <code>student_id</code>  增序进行排序。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Enrollments 表：\n+------------+-------------------+\n| student_id | course_id | grade |\n+------------+-----------+-------+\n| 2          | 2         | 95    |\n| 2          | 3         | 95    |\n| 1          | 1         | 90    |\n| 1          | 2         | 99    |\n| 3          | 1         | 80    |\n| 3          | 2         | 75    |\n| 3          | 3         | 82    |\n+------------+-----------+-------+\n\nResult 表：\n+------------+-------------------+\n| student_id | course_id | grade |\n+------------+-----------+-------+\n| 1          | 2         | 99    |\n| 2          | 2         | 95    |\n| 3          | 3         | 82    |\n+------------+-----------+-------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span>course_id <span class=\"token punctuation\">,</span>grade</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span>course_id <span class=\"token punctuation\">,</span>grade<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> student_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> grade <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>course_id<span class=\"token punctuation\">)</span> rK</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Enrollments</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1113-报告的记录\"><a class=\"anchor\" href=\"#1113-报告的记录\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVwb3J0ZWQtcG9zdHMv\">1113. 报告的记录</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>动作表： <code>Actions</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| post_id       | int     |\n| action_date   | date    | \n| action        | enum    |\n| extra         | varchar |\n+---------------+---------+\n此表没有主键，所以可能会有重复的行。\naction 字段是 ENUM 类型的，包含:('view', 'like', 'reaction', 'comment', 'report', 'share')\nextra 字段是可选的信息（可能为 null），其中的信息例如有：1.报告理由(a reason for report) 2.反应类型(a type of reaction)\n</code></pre>\n<p>编写一条 SQL，查询每种 <em><strong>报告理由</strong></em>（report reason）在昨天的报告数量。假设今天是 <strong>2019-07-05</strong>。</p>\n<p>查询及结果的格式示例：</p>\n<pre><code>Actions table:\n+---------+---------+-------------+--------+--------+\n| user_id | post_id | action_date | action | extra  |\n+---------+---------+-------------+--------+--------+\n| 1       | 1       | 2019-07-01  | view   | null   |\n| 1       | 1       | 2019-07-01  | like   | null   |\n| 1       | 1       | 2019-07-01  | share  | null   |\n| 2       | 4       | 2019-07-04  | view   | null   |\n| 2       | 4       | 2019-07-04  | report | spam   |\n| 3       | 4       | 2019-07-04  | view   | null   |\n| 3       | 4       | 2019-07-04  | report | spam   |\n| 4       | 3       | 2019-07-02  | view   | null   |\n| 4       | 3       | 2019-07-02  | report | spam   |\n| 5       | 2       | 2019-07-04  | view   | null   |\n| 5       | 2       | 2019-07-04  | report | racism |\n| 5       | 5       | 2019-07-04  | view   | null   |\n| 5       | 5       | 2019-07-04  | report | racism |\n+---------+---------+-------------+--------+--------+\n\nResult table:\n+---------------+--------------+\n| report_reason | report_count |\n+---------------+--------------+\n| spam          | 1            |\n| racism        | 2            |\n+---------------+--------------+ \n注意，我们只关心报告数量非零的结果。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\textra <span class=\"token keyword\">AS</span> report_reason<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> post_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> report_count</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tActions</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">WHERE</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">`</span><span class=\"token keyword\">action</span><span class=\"token punctuation\">`</span> <span class=\"token operator\">=</span> <span class=\"token string\">'report'</span> <span class=\"token operator\">AND</span> action_date <span class=\"token operator\">=</span> date_add<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-07-05'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">Interval</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">day</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\textra<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"1132-报告的记录-ii\"><a class=\"anchor\" href=\"#1132-报告的记录-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVwb3J0ZWQtcG9zdHMtaWkv\">1132. 报告的记录 II</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>动作表：  <code>Actions</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| post_id       | int     |\n| action_date   | date    |\n| action        | enum    |\n| extra         | varchar |\n+---------------+---------+\n这张表没有主键，并有可能存在重复的行。\naction 列的类型是 ENUM，可能的值为 ('view', 'like', 'reaction', 'comment', 'report', 'share')。\nextra 列拥有一些可选信息，例如：报告理由（a reason for report）或反应类型（a type of reaction）等。\n</code></pre>\n<p>移除表：  <code>Removals</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| post_id       | int     |\n| remove_date   | date    | \n+---------------+---------+\n这张表的主键是 post_id。\n这张表的每一行表示一个被移除的帖子，原因可能是由于被举报或被管理员审查。\n</code></pre>\n<p>编写一段 SQL 来查找：在被报告为垃圾广告的帖子中，被移除的帖子的每日平均占比，<strong>四舍五入到小数点后 2 位</strong>。</p>\n<p>查询结果的格式如下：</p>\n<pre><code>Actions table:\n+---------+---------+-------------+--------+--------+\n| user_id | post_id | action_date | action | extra  |\n+---------+---------+-------------+--------+--------+\n| 1       | 1       | 2019-07-01  | view   | null   |\n| 1       | 1       | 2019-07-01  | like   | null   |\n| 1       | 1       | 2019-07-01  | share  | null   |\n| 2       | 2       | 2019-07-04  | view   | null   |\n| 2       | 2       | 2019-07-04  | report | spam   |\n| 3       | 4       | 2019-07-04  | view   | null   |\n| 3       | 4       | 2019-07-04  | report | spam   |\n| 4       | 3       | 2019-07-02  | view   | null   |\n| 4       | 3       | 2019-07-02  | report | spam   |\n| 5       | 2       | 2019-07-03  | view   | null   |\n| 5       | 2       | 2019-07-03  | report | racism |\n| 5       | 5       | 2019-07-03  | view   | null   |\n| 5       | 5       | 2019-07-03  | report | racism |\n+---------+---------+-------------+--------+--------+\n\nRemovals table:\n+---------+-------------+\n| post_id | remove_date |\n+---------+-------------+\n| 2       | 2019-07-20  |\n| 3       | 2019-07-18  |\n+---------+-------------+\n\nResult table:\n+-----------------------+\n| average_daily_percent |\n+-----------------------+\n| 75.00                 |\n+-----------------------+\n2019-07-04 的垃圾广告移除率是 50%，因为有两张帖子被报告为垃圾广告，但只有一个得到移除。\n2019-07-02 的垃圾广告移除率是 100%，因为有一张帖子被举报为垃圾广告并得到移除。\n其余几天没有收到垃圾广告的举报，因此平均值为：(50 + 100) / 2 = 75%\n注意，输出仅需要一个平均值即可，我们并不关注移除操作的日期。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span><span class=\"token function\">AVG</span><span class=\"token punctuation\">(</span>proportion<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> average_daily_percent  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> actions<span class=\"token punctuation\">.</span>action_date<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> removals<span class=\"token punctuation\">.</span>post_id<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> actions<span class=\"token punctuation\">.</span>post_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> proportion</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">FROM</span> actions</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> removals</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">ON</span> actions<span class=\"token punctuation\">.</span>post_id <span class=\"token operator\">=</span> removals<span class=\"token punctuation\">.</span>post_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">WHERE</span> extra <span class=\"token operator\">=</span> <span class=\"token string\">'spam'</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> actions<span class=\"token punctuation\">.</span>action_date</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span> a</pre></td></tr></table></figure><blockquote>\n<p>要理解 spam 的含义</p>\n</blockquote>\n<h4 id=\"1126-查询活跃业务\"><a class=\"anchor\" href=\"#1126-查询活跃业务\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWN0aXZlLWJ1c2luZXNzZXMv\">1126. 查询活跃业务</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>事件表： <code>Events</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| business_id   | int     |\n| event_type    | varchar |\n| occurences    | int     | \n+---------------+---------+\n此表的主键是 (business_id, event_type)。\n表中的每一行记录了某种类型的事件在某些业务中多次发生的信息。\n</code></pre>\n<p>写一段 SQL 来查询所有活跃的业务。</p>\n<p>如果一个业务的某个事件类型的发生次数大于此事件类型在所有业务中的平均发生次数，并且该业务至少有两个这样的事件类型，那么该业务就可被看做是活跃业务。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Events table:\n+-------------+------------+------------+\n| business_id | event_type | occurences |\n+-------------+------------+------------+\n| 1           | reviews    | 7          |\n| 3           | reviews    | 3          |\n| 1           | ads        | 11         |\n| 2           | ads        | 7          |\n| 3           | ads        | 6          |\n| 1           | page views | 3          |\n| 2           | page views | 12         |\n+-------------+------------+------------+\n\n结果表\n+-------------+\n| business_id |\n+-------------+\n| 1           |\n+-------------+ \n'reviews'、 'ads' 和 'page views' 的总平均发生次数分别是 (7+3)/2=5, (11+7+6)/3=8, (3+12)/2=7.5。\nid 为 1 的业务有 7 个 'reviews' 事件（大于 5）和 11 个 'ads' 事件（大于 8），所以它是活跃业务。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> business_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> business_id<span class=\"token punctuation\">,</span>occurences<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>occurences<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> event_type<span class=\"token punctuation\">)</span> avo</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> Events</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span>  occurences <span class=\"token operator\">></span> avo</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> business_id</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">2</span></pre></td></tr></table></figure><h4 id=\"1127-用户购买平台\"><a class=\"anchor\" href=\"#1127-用户购买平台\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdXNlci1wdXJjaGFzZS1wbGF0Zm9ybS8=\">1127. 用户购买平台</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>支出表:  <code>Spending</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| user_id     | int     |\n| spend_date  | date    |\n| platform    | enum    | \n| amount      | int     |\n+-------------+---------+\n这张表记录了用户在一个在线购物网站的支出历史，该在线购物平台同时拥有桌面端（'desktop'）和手机端（'mobile'）的应用程序。\n这张表的主键是 (user_id, spend_date, platform)。\n平台列 platform 是一种 ENUM ，类型为（'desktop', 'mobile'）。\n</code></pre>\n<p>写一段 SQL 来查找每天 <strong>仅</strong> 使用手机端用户、<strong>仅</strong> 使用桌面端用户和 <strong>同时</strong> 使用桌面端和手机端的用户人数和总支出金额。</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Spending table:\n+---------+------------+----------+--------+\n| user_id | spend_date | platform | amount |\n+---------+------------+----------+--------+\n| 1       | 2019-07-01 | mobile   | 100    |\n| 1       | 2019-07-01 | desktop  | 100    |\n| 2       | 2019-07-01 | mobile   | 100    |\n| 2       | 2019-07-02 | mobile   | 100    |\n| 3       | 2019-07-01 | desktop  | 100    |\n| 3       | 2019-07-02 | desktop  | 100    |\n+---------+------------+----------+--------+\n\nResult table:\n+------------+----------+--------------+-------------+\n| spend_date | platform | total_amount | total_users |\n+------------+----------+--------------+-------------+\n| 2019-07-01 | desktop  | 100          | 1           |\n| 2019-07-01 | mobile   | 100          | 1           |\n| 2019-07-01 | both     | 200          | 1           |\n| 2019-07-02 | desktop  | 100          | 1           |\n| 2019-07-02 | mobile   | 100          | 1           |\n| 2019-07-02 | both     | 0            | 0           |\n+------------+----------+--------------+-------------+ \n在 2019-07-01, 用户1 同时 使用桌面端和手机端购买, 用户2 仅 使用了手机端购买，而用户3 仅 使用了桌面端购买。\n在 2019-07-02, 用户2 仅 使用了手机端购买, 用户3 仅 使用了桌面端购买，且没有用户 同时 使用桌面端和手机端购买。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    spend_date<span class=\"token punctuation\">,</span> platform<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ifnull<span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>total_am<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> total_amount<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    ifnull<span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>total_u<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> total_users</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">select</span> p<span class=\"token punctuation\">.</span>spend_date<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>platform<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span>total_am<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span>total_u</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> spend_date<span class=\"token punctuation\">,</span> <span class=\"token string\">\"desktop\"</span> platform <span class=\"token keyword\">from</span> Spending</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> spend_date<span class=\"token punctuation\">,</span> <span class=\"token string\">\"mobile\"</span> platform <span class=\"token keyword\">from</span> Spending</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> spend_date<span class=\"token punctuation\">,</span> <span class=\"token string\">\"both\"</span> platform <span class=\"token keyword\">from</span> Spending</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">)</span> p</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">select</span> spend_date<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> platform<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> platform<span class=\"token punctuation\">,</span> <span class=\"token string\">'both'</span><span class=\"token punctuation\">)</span> plat<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> total_am<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> user_id<span class=\"token punctuation\">)</span> total_u</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">from</span> Spending</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> spend_date<span class=\"token punctuation\">,</span> user_id</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">on</span> p<span class=\"token punctuation\">.</span>platform <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>plat <span class=\"token operator\">and</span> p<span class=\"token punctuation\">.</span>spend_date <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>spend_date</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">temp</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> spend_date<span class=\"token punctuation\">,</span> platform</pre></td></tr></table></figure><blockquote>\n<p>必须保证 desktop mobile both 的顺序 ，所以 先列出三个字段</p>\n</blockquote>\n<h4 id=\"1141-查询近30天活跃用户数\"><a class=\"anchor\" href=\"#1141-查询近30天活跃用户数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdXNlci1hY3Rpdml0eS1mb3ItdGhlLXBhc3QtMzAtZGF5cy1pLw==\">1141. 查询近 30 天活跃用户数</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>活动记录表： <code>Activity</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| session_id    | int     |\n| activity_date | date    |\n| activity_type | enum    |\n+---------------+---------+\n该表是用户在社交网站的活动记录。\n该表没有主键，可能包含重复数据。\nactivity_type 字段为以下四种值 ('open_session', 'end_session', 'scroll_down', 'send_message')。\n每个 session_id 只属于一个用户。\n</code></pre>\n<p>请写 SQL 查询出截至 <strong>2019-07-27</strong>（包含 2019-07-27）<strong>，近</strong> 30 天的每日活跃用户数（当天只要有一条活动记录，即为活跃用户）。</p>\n<p>查询结果示例如下：</p>\n<pre><code>Activity table:\n+---------+------------+---------------+---------------+\n| user_id | session_id | activity_date | activity_type |\n+---------+------------+---------------+---------------+\n| 1       | 1          | 2019-07-20    | open_session  |\n| 1       | 1          | 2019-07-20    | scroll_down   |\n| 1       | 1          | 2019-07-20    | end_session   |\n| 2       | 4          | 2019-07-20    | open_session  |\n| 2       | 4          | 2019-07-21    | send_message  |\n| 2       | 4          | 2019-07-21    | end_session   |\n| 3       | 2          | 2019-07-21    | open_session  |\n| 3       | 2          | 2019-07-21    | send_message  |\n| 3       | 2          | 2019-07-21    | end_session   |\n| 4       | 3          | 2019-06-25    | open_session  |\n| 4       | 3          | 2019-06-25    | end_session   |\n+---------+------------+---------------+---------------+\n\nResult table:\n+------------+--------------+ \n| day        | active_users |\n+------------+--------------+ \n| 2019-07-20 | 2            |\n| 2019-07-21 | 2            |\n+------------+--------------+ \n非活跃用户的记录不需要展示。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> activity_date <span class=\"token keyword\">day</span><span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> user_id<span class=\"token punctuation\">)</span> active_users</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> activity_date <span class=\"token operator\">></span> date_add<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-07-27'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">INTERVAL</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">MONTH</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> activity_date</pre></td></tr></table></figure><h4 id=\"1142-过去30天的用户活动-ii\"><a class=\"anchor\" href=\"#1142-过去30天的用户活动-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdXNlci1hY3Rpdml0eS1mb3ItdGhlLXBhc3QtMzAtZGF5cy1paS8=\">1142. 过去 30 天的用户活动 II</span></h4>\n<p>难度简单 7 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Activity</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| session_id    | int     |\n| activity_date | date    |\n| activity_type | enum    |\n+---------------+---------+\n该表没有主键，它可能有重复的行。\nactivity_type列是一种类型的ENUM（“ open_session”，“ end_session”，“ scroll_down”，“ send_message”）。\n该表显示了社交媒体网站的用户活动。\n请注意，每个会话完全属于一个用户。\n</code></pre>\n<p>编写 SQL 查询以查找截至 2019 年 7 月 27 日（含）的 30 天内每个用户的平均会话数，四舍五入到小数点后两位。我们只统计那些会话期间用户至少进行一项活动的有效会话。</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Activity table:\n+---------+------------+---------------+---------------+\n| user_id | session_id | activity_date | activity_type |\n+---------+------------+---------------+---------------+\n| 1       | 1          | 2019-07-20    | open_session  |\n| 1       | 1          | 2019-07-20    | scroll_down   |\n| 1       | 1          | 2019-07-20    | end_session   |\n| 2       | 4          | 2019-07-20    | open_session  |\n| 2       | 4          | 2019-07-21    | send_message  |\n| 2       | 4          | 2019-07-21    | end_session   |\n| 3       | 2          | 2019-07-21    | open_session  |\n| 3       | 2          | 2019-07-21    | send_message  |\n| 3       | 2          | 2019-07-21    | end_session   |\n| 3       | 5          | 2019-07-21    | open_session  |\n| 3       | 5          | 2019-07-21    | scroll_down   |\n| 3       | 5          | 2019-07-21    | end_session   |\n| 4       | 3          | 2019-06-25    | open_session  |\n| 4       | 3          | 2019-06-25    | end_session   |\n+---------+------------+---------------+---------------+\n\nResult table:\n+---------------------------+ \n| average_sessions_per_user |\n+---------------------------+ \n| 1.33                      |\n+---------------------------+ \nUser 1 和 2 在过去30天内各自进行了1次会话，而用户3进行了2次会话，因此平均值为（1 +1 + 2）/ 3 = 1.33。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> IFNULL<span class=\"token punctuation\">(</span><span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span><span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> session_id<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> user_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> average_sessions_per_user</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> activity_date <span class=\"token operator\">></span> date_add<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-07-27'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">INTERVAL</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">MONTH</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><blockquote>\n<p>1 个 session id 代表一次会话</p>\n</blockquote>\n<h4 id=\"1148-文章浏览-i\"><a class=\"anchor\" href=\"#1148-文章浏览-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYXJ0aWNsZS12aWV3cy1pLw==\">1148. 文章浏览 I</span></h4>\n<p>难度简单 3 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p><code>Views</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| article_id    | int     |\n| author_id     | int     |\n| viewer_id     | int     |\n| view_date     | date    |\n+---------------+---------+\n此表无主键，因此可能会存在重复行。\n此表的每一行都表示某人在某天浏览了某位作者的某篇文章。\n请注意，同一人的 author_id 和 viewer_id 是相同的。\n</code></pre>\n<p>请编写一条 SQL 查询以找出所有浏览过自己文章的作者，结果按照 id 升序排列。</p>\n<p>查询结果的格式如下所示：</p>\n<pre><code>Views 表：\n+------------+-----------+-----------+------------+\n| article_id | author_id | viewer_id | view_date  |\n+------------+-----------+-----------+------------+\n| 1          | 3         | 5         | 2019-08-01 |\n| 1          | 3         | 6         | 2019-08-02 |\n| 2          | 7         | 7         | 2019-08-01 |\n| 2          | 7         | 6         | 2019-08-02 |\n| 4          | 7         | 1         | 2019-07-22 |\n| 3          | 4         | 4         | 2019-07-21 |\n| 3          | 4         | 4         | 2019-07-21 |\n+------------+-----------+-----------+------------+\n\n结果表：\n+------+\n| id   |\n+------+\n| 4    |\n| 7    |\n+------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> author_id id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Views</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> author_id<span class=\"token operator\">=</span>  viewer_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id</pre></td></tr></table></figure><h4 id=\"1149-文章浏览-ii\"><a class=\"anchor\" href=\"#1149-文章浏览-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYXJ0aWNsZS12aWV3cy1paS8=\">1149. 文章浏览 II</span></h4>\n<p>难度中等 4 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Views</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| article_id    | int     |\n| author_id     | int     |\n| viewer_id     | int     |\n| view_date     | date    |\n+---------------+---------+\n此表无主键，因此可能会存在重复行。此表的每一行都表示某人在某天浏览了某位作者的某篇文章。 请注意，同一人的 author_id 和 viewer_id 是相同的。\n</code></pre>\n<p>编写一条 SQL 查询来找出在同一天阅读至少两篇文章的人，结果按照 id 升序排序。</p>\n<p>查询结果的格式如下：</p>\n<pre><code>Views table:\n+------------+-----------+-----------+------------+\n| article_id | author_id | viewer_id | view_date  |\n+------------+-----------+-----------+------------+\n| 1          | 3         | 5         | 2019-08-01 |\n| 3          | 4         | 5         | 2019-08-01 |\n| 1          | 3         | 6         | 2019-08-02 |\n| 2          | 7         | 7         | 2019-08-01 |\n| 2          | 7         | 6         | 2019-08-02 |\n| 4          | 7         | 1         | 2019-07-22 |\n| 3          | 4         | 4         | 2019-07-21 |\n| 3          | 4         | 4         | 2019-07-21 |\n+------------+-----------+-----------+------------+\n\nResult table:\n+------+\n| id   |\n+------+\n| 5    |\n| 6    |\n+------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span> viewer_id <span class=\"token keyword\">AS</span> id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> Views</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> view_date<span class=\"token punctuation\">,</span> viewer_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">HAVING</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> article_id<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> viewer_id</pre></td></tr></table></figure><h4 id=\"1158-市场分析-i\"><a class=\"anchor\" href=\"#1158-市场分析-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbWFya2V0LWFuYWx5c2lzLWkv\">1158. 市场分析 I</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Users</code></p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| user_id        | int     |\n| join_date      | date    |\n| favorite_brand | varchar |\n+----------------+---------+\n此表主键是 user_id，表中描述了购物网站的用户信息，用户可以在此网站上进行商品买卖。\n</code></pre>\n<p>Table:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| order_date    | date    |\n| item_id       | int     |\n| buyer_id      | int     |\n| seller_id     | int     |\n+---------------+---------+\n此表主键是 order_id，外键是 item_id 和（buyer_id，seller_id）。\n</code></pre>\n<p>Table:  <code>Item</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| item_id       | int     |\n| item_brand    | varchar |\n+---------------+---------+\n此表主键是 item_id。\n</code></pre>\n<p>请写出一条 SQL 语句以查询每个用户的注册日期和在 <strong>2019</strong> 年作为买家的订单总数。</p>\n<p>查询结果格式如下：</p>\n<pre><code>Users table:\n+---------+------------+----------------+\n| user_id | join_date  | favorite_brand |\n+---------+------------+----------------+\n| 1       | 2018-01-01 | Lenovo         |\n| 2       | 2018-02-09 | Samsung        |\n| 3       | 2018-01-19 | LG             |\n| 4       | 2018-05-21 | HP             |\n+---------+------------+----------------+\n\nOrders table:\n+----------+------------+---------+----------+-----------+\n| order_id | order_date | item_id | buyer_id | seller_id |\n+----------+------------+---------+----------+-----------+\n| 1        | 2019-08-01 | 4       | 1        | 2         |\n| 2        | 2018-08-02 | 2       | 1        | 3         |\n| 3        | 2019-08-03 | 3       | 2        | 3         |\n| 4        | 2018-08-04 | 1       | 4        | 2         |\n| 5        | 2018-08-04 | 1       | 3        | 4         |\n| 6        | 2019-08-05 | 2       | 2        | 4         |\n+----------+------------+---------+----------+-----------+\n\nItems table:\n+---------+------------+\n| item_id | item_brand |\n+---------+------------+\n| 1       | Samsung    |\n| 2       | Lenovo     |\n| 3       | LG         |\n| 4       | HP         |\n+---------+------------+\n\nResult table:\n+-----------+------------+----------------+\n| buyer_id  | join_date  | orders_in_2019 |\n+-----------+------------+----------------+\n| 1         | 2018-01-01 | 1              |\n| 2         | 2018-02-09 | 2              |\n| 3         | 2018-01-19 | 0              |\n| 4         | 2018-05-21 | 0              |\n+-----------+------------+----------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> user_id buyer_id<span class=\"token punctuation\">,</span>join_date<span class=\"token punctuation\">,</span> ifnull<span class=\"token punctuation\">(</span>cnt<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>orders_in_2019</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Users u <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> buyer_id<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Orders</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">2019</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span>  buyer_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">on</span> u<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span>t1<span class=\"token punctuation\">.</span>buyer_id</pre></td></tr></table></figure><h4 id=\"1159-市场分析-ii\"><a class=\"anchor\" href=\"#1159-市场分析-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbWFya2V0LWFuYWx5c2lzLWlpLw==\">1159. 市场分析 II</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>表:  <code>Users</code></p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| user_id        | int     |\n| join_date      | date    |\n| favorite_brand | varchar |\n+----------------+---------+\nuser_id 是该表的主键\n表中包含一位在线购物网站用户的个人信息，用户可以在该网站出售和购买商品。\n</code></pre>\n<p>表:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| order_date    | date    |\n| item_id       | int     |\n| buyer_id      | int     |\n| seller_id     | int     |\n+---------------+---------+\norder_id 是该表的主键\nitem_id 是 Items 表的外键\nbuyer_id 和 seller_id 是 Users 表的外键\n</code></pre>\n<p>表:  <code>Items</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| item_id       | int     |\n| item_brand    | varchar |\n+---------------+---------+\nitem_id 是该表的主键\n</code></pre>\n<p>写一个 SQL 查询确定每一个用户按日期顺序卖出的第二件商品的品牌是否是他们最喜爱的品牌。如果一个用户卖出少于两件商品，查询的结果是  <code>no</code>  。</p>\n<p>题目保证没有一个用户在一天中卖出超过一件商品</p>\n<p>下面是查询结果格式的例子：</p>\n<pre><code>Users table:\n+---------+------------+----------------+\n| user_id | join_date  | favorite_brand |\n+---------+------------+----------------+\n| 1       | 2019-01-01 | Lenovo         |\n| 2       | 2019-02-09 | Samsung        |\n| 3       | 2019-01-19 | LG             |\n| 4       | 2019-05-21 | HP             |\n+---------+------------+----------------+\n\nOrders table:\n+----------+------------+---------+----------+-----------+\n| order_id | order_date | item_id | buyer_id | seller_id |\n+----------+------------+---------+----------+-----------+\n| 1        | 2019-08-01 | 4       | 1        | 2         |\n| 2        | 2019-08-02 | 2       | 1        | 3         |\n| 3        | 2019-08-03 | 3       | 2        | 3         |\n| 4        | 2019-08-04 | 1       | 4        | 2         |\n| 5        | 2019-08-04 | 1       | 3        | 4         |\n| 6        | 2019-08-05 | 2       | 2        | 4         |\n+----------+------------+---------+----------+-----------+\n\nItems table:\n+---------+------------+\n| item_id | item_brand |\n+---------+------------+\n| 1       | Samsung    |\n| 2       | Lenovo     |\n| 3       | LG         |\n| 4       | HP         |\n+---------+------------+\n\nResult table:\n+-----------+--------------------+\n| seller_id | 2nd_item_fav_brand |\n+-----------+--------------------+\n| 1         | no                 |\n| 2         | yes                |\n| 3         | yes                |\n| 4         | no                 |\n+-----------+--------------------+\n\nid 为 1 的用户的查询结果是 no，因为他什么也没有卖出\nid为 2 和 3 的用户的查询结果是 yes，因为他们卖出的第二件商品的品牌是他们自己最喜爱的品牌\nid为 4 的用户的查询结果是 no，因为他卖出的第二件商品的品牌不是他最喜爱的品牌\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> user_id seller_id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>item_brand<span class=\"token operator\">=</span>favorite_brand<span class=\"token punctuation\">,</span><span class=\"token string\">'yes'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'no'</span><span class=\"token punctuation\">)</span> <span class=\"token number\">2</span>nd_item_fav_brand </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Users u</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> i<span class=\"token punctuation\">.</span>item_id<span class=\"token punctuation\">,</span>seller_id<span class=\"token punctuation\">,</span>item_brand</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> Items i</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">join</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">select</span> seller_id<span class=\"token punctuation\">,</span>item_id<span class=\"token punctuation\">,</span>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> seller_id  <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> order_date <span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">from</span> Orders </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">)</span>t1 </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">on</span> i<span class=\"token punctuation\">.</span>item_id <span class=\"token operator\">=</span> t1<span class=\"token punctuation\">.</span>item_id </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">where</span> rk  <span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">on</span> u<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>seller_id</pre></td></tr></table></figure><h4 id=\"1164-指定日期的产品价格\"><a class=\"anchor\" href=\"#1164-指定日期的产品价格\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvZHVjdC1wcmljZS1hdC1hLWdpdmVuLWRhdGUv\">1164. 指定日期的产品价格</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>产品数据表:  <code>Products</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| new_price     | int     |\n| change_date   | date    |\n+---------------+---------+\n这张表的主键是 (product_id, change_date)。\n这张表的每一行分别记录了 某产品 在某个日期 更改后 的新价格。\n</code></pre>\n<p>写一段 SQL 来查找在 <strong>2019-08-16</strong> 时全部产品的价格，假设所有产品在修改前的价格都是 <strong>10。</strong></p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Products table:\n+------------+-----------+-------------+\n| product_id | new_price | change_date |\n+------------+-----------+-------------+\n| 1          | 20        | 2019-08-14  |\n| 2          | 50        | 2019-08-14  |\n| 1          | 30        | 2019-08-15  |\n| 1          | 35        | 2019-08-16  |\n| 2          | 65        | 2019-08-17  |\n| 3          | 20        | 2019-08-18  |\n+------------+-----------+-------------+\n\nResult table:\n+------------+-------+\n| product_id | price |\n+------------+-------+\n| 2          | 50    |\n| 1          | 35    |\n| 3          | 10    |\n+------------+-------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> p<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>t1<span class=\"token punctuation\">.</span>new_price<span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> price</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Products p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> product_id<span class=\"token punctuation\">,</span>new_price</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">select</span> product_id<span class=\"token punctuation\">,</span>new_price<span class=\"token punctuation\">,</span>change_date<span class=\"token punctuation\">,</span><span class=\"token function\">Max</span><span class=\"token punctuation\">(</span>change_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> product_id  <span class=\"token punctuation\">)</span> md</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">from</span>  Products</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">where</span> change_date<span class=\"token operator\">&lt;=</span><span class=\"token string\">'2019-08-16'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">)</span>tmp</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">where</span> change_date <span class=\"token operator\">=</span> md</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">on</span> p<span class=\"token punctuation\">.</span> product_id <span class=\"token operator\">=</span> t1<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> price <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><h4 id=\"1173-即时食物配送-i\"><a class=\"anchor\" href=\"#1173-即时食物配送-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvaW1tZWRpYXRlLWZvb2QtZGVsaXZlcnktaS8=\">1173. 即时食物配送 I</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>配送表:  <code>Delivery</code></p>\n<pre><code>+-----------------------------+---------+\n| Column Name                 | Type    |\n+-----------------------------+---------+\n| delivery_id                 | int     |\n| customer_id                 | int     |\n| order_date                  | date    |\n| customer_pref_delivery_date | date    |\n+-----------------------------+---------+\ndelivery_id 是表的主键。\n该表保存着顾客的食物配送信息，顾客在某个日期下了订单，并指定了一个期望的配送日期（和下单日期相同或者在那之后）。\n</code></pre>\n<p>如果顾客期望的配送日期和下单日期相同，则该订单称为 「即时订单」，否则称为「计划订单」。</p>\n<p>写一条 SQL 查询语句获取即时订单所占的百分比， <strong>保留两位小数。</strong></p>\n<p>查询结果如下所示：</p>\n<pre><code>Delivery 表:\n+-------------+-------------+------------+-----------------------------+\n| delivery_id | customer_id | order_date | customer_pref_delivery_date |\n+-------------+-------------+------------+-----------------------------+\n| 1           | 1           | 2019-08-01 | 2019-08-02                  |\n| 2           | 5           | 2019-08-02 | 2019-08-02                  |\n| 3           | 1           | 2019-08-11 | 2019-08-11                  |\n| 4           | 3           | 2019-08-24 | 2019-08-26                  |\n| 5           | 4           | 2019-08-21 | 2019-08-22                  |\n| 6           | 2           | 2019-08-11 | 2019-08-13                  |\n+-------------+-------------+------------+-----------------------------+\n\nResult 表:\n+----------------------+\n| immediate_percentage |\n+----------------------+\n| 33.33                |\n+----------------------+\n2 和 3 号订单为即时订单，其他的为计划订单。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>order_date<span class=\"token operator\">=</span>customer_pref_delivery_date<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> immediate_percentage</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Delivery</pre></td></tr></table></figure><h4 id=\"1174-即时食物配送-ii\"><a class=\"anchor\" href=\"#1174-即时食物配送-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvaW1tZWRpYXRlLWZvb2QtZGVsaXZlcnktaWkv\">1174. 即时食物配送 II</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>配送表:  <code>Delivery</code></p>\n<pre><code>+-----------------------------+---------+\n| Column Name                 | Type    |\n+-----------------------------+---------+\n| delivery_id                 | int     |\n| customer_id                 | int     |\n| order_date                  | date    |\n| customer_pref_delivery_date | date    |\n+-----------------------------+---------+\ndelivery_id 是表的主键。\n该表保存着顾客的食物配送信息，顾客在某个日期下了订单，并指定了一个期望的配送日期（和下单日期相同或者在那之后）。\n</code></pre>\n<p>如果顾客期望的配送日期和下单日期相同，则该订单称为 「即时订单」，否则称为「计划订单」。</p>\n<p>「首次订单」是顾客最早创建的订单。我们保证一个顾客只会有一个「首次订单」。</p>\n<p>写一条 SQL 查询语句获取即时订单在所有用户的首次订单中的比例。<strong>保留两位小数。</strong></p>\n<p>查询结果如下所示：</p>\n<pre><code>Delivery 表：\n+-------------+-------------+------------+-----------------------------+\n| delivery_id | customer_id | order_date | customer_pref_delivery_date |\n+-------------+-------------+------------+-----------------------------+\n| 1           | 1           | 2019-08-01 | 2019-08-02                  |\n| 2           | 2           | 2019-08-02 | 2019-08-02                  |\n| 3           | 1           | 2019-08-11 | 2019-08-12                  |\n| 4           | 3           | 2019-08-24 | 2019-08-24                  |\n| 5           | 3           | 2019-08-21 | 2019-08-22                  |\n| 6           | 2           | 2019-08-11 | 2019-08-13                  |\n| 7           | 4           | 2019-08-09 | 2019-08-09                  |\n+-------------+-------------+------------+-----------------------------+\n\nResult 表：\n+----------------------+\n| immediate_percentage |\n+----------------------+\n| 50.00                |\n+----------------------+\n1 号顾客的 1 号订单是首次订单，并且是计划订单。\n2 号顾客的 2 号订单是首次订单，并且是即时订单。\n3 号顾客的 5 号订单是首次订单，并且是计划订单。\n4 号顾客的 7 号订单是首次订单，并且是即时订单。\n因此，一半顾客的首次订单是即时的。\n</code></pre>\n<p>开窗</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>order_date <span class=\"token operator\">=</span> fo <span class=\"token operator\">&amp;&amp;</span> fo<span class=\"token operator\">=</span>d<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> customer_id<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> immediate_percentage </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> customer_id<span class=\"token punctuation\">,</span>order_date<span class=\"token punctuation\">,</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> customer_id<span class=\"token punctuation\">)</span> fo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>order_date<span class=\"token operator\">=</span>customer_pref_delivery_date<span class=\"token punctuation\">,</span>order_date <span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> d</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Delivery</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr></table></figure><p>另一种思路</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">round</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>order_date <span class=\"token operator\">=</span> customer_pref_delivery_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span> <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> immediate_percentage</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Delivery</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token punctuation\">(</span>customer_id<span class=\"token punctuation\">,</span> order_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">select</span> customer_id<span class=\"token punctuation\">,</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">from</span> delivery</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_id</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1179-重新格式化部门表\"><a class=\"anchor\" href=\"#1179-重新格式化部门表\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVmb3JtYXQtZGVwYXJ0bWVudC10YWJsZS8=\">1179. 重新格式化部门表</span></h4>\n<p>难度</p>\n<p>SQL 架构</p>\n<p>部门表  <code>Department</code> ：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| revenue       | int     |\n| month         | varchar |\n+---------------+---------+\n(id, month) 是表的联合主键。\n这个表格有关于每个部门每月收入的信息。\n月份（month）可以取下列值 [&quot;Jan&quot;,&quot;Feb&quot;,&quot;Mar&quot;,&quot;Apr&quot;,&quot;May&quot;,&quot;Jun&quot;,&quot;Jul&quot;,&quot;Aug&quot;,&quot;Sep&quot;,&quot;Oct&quot;,&quot;Nov&quot;,&quot;Dec&quot;]。\n</code></pre>\n<p>编写一个 SQL 查询来重新格式化表，使得新的表中有一个部门 id 列和一些对应 <strong>每个月</strong> 的收入（revenue）列。</p>\n<p>查询结果格式如下面的示例所示：</p>\n<pre><code>Department 表：\n+------+---------+-------+\n| id   | revenue | month |\n+------+---------+-------+\n| 1    | 8000    | Jan   |\n| 2    | 9000    | Jan   |\n| 3    | 10000   | Feb   |\n| 1    | 7000    | Feb   |\n| 1    | 6000    | Mar   |\n+------+---------+-------+\n\n查询得到的结果表：\n+------+-------------+-------------+-------------+-----+-------------+\n| id   | Jan_Revenue | Feb_Revenue | Mar_Revenue | ... | Dec_Revenue |\n+------+-------------+-------------+-------------+-----+-------------+\n| 1    | 8000        | 7000        | 6000        | ... | null        |\n| 2    | 9000        | null        | null        | ... | null        |\n| 3    | null        | 10000       | null        | ... | null        |\n+------+-------------+-------------+-------------+-----+-------------+\n\n注意，结果表有 13 列 (1个部门 id 列 + 12个月份的收入列)。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Jan'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Jan_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Feb'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Feb_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Mar'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Mar_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Apr'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Apr_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'May'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> May_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Jun'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Jun_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Jul'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Jul_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Aug'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Aug_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Sep'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Sep_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Oct'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Oct_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Nov'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Nov_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Dec'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Dec_Revenue</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">FROM</span> Department</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1193.</span> 每月交易 I</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">SQL</span>架构</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">Table</span>: <span class=\"token keyword\">Transactions</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+---------+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token keyword\">Column</span> Name   <span class=\"token operator\">|</span> <span class=\"token keyword\">Type</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+---------+</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">|</span> id            <span class=\"token operator\">|</span> <span class=\"token keyword\">int</span>     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">|</span> country       <span class=\"token operator\">|</span> <span class=\"token keyword\">varchar</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">|</span> state         <span class=\"token operator\">|</span> <span class=\"token keyword\">enum</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">|</span> amount        <span class=\"token operator\">|</span> <span class=\"token keyword\">int</span>     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">|</span> trans_date    <span class=\"token operator\">|</span> <span class=\"token keyword\">date</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+---------+</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>id 是这个表的主键。</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>该表包含有关传入事务的信息。</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>state 列类型为 “<span class=\"token punctuation\">[</span>”批准“，”拒绝“<span class=\"token punctuation\">]</span> 之一。</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>编写一个 <span class=\"token keyword\">sql</span> 查询来查找每个月和每个国家<span class=\"token operator\">/</span>地区的事务数及其总金额、已批准的事务数及其总金额。</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>查询结果格式如下所示：</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">Transactions</span> <span class=\"token keyword\">table</span>:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------+---------+----------+--------+------------+</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token operator\">|</span> id   <span class=\"token operator\">|</span> country <span class=\"token operator\">|</span> state    <span class=\"token operator\">|</span> amount <span class=\"token operator\">|</span> trans_date <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------+---------+----------+--------+------------+</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">121</span>  <span class=\"token operator\">|</span> US      <span class=\"token operator\">|</span> approved <span class=\"token operator\">|</span> <span class=\"token number\">1000</span>   <span class=\"token operator\">|</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">12</span><span class=\"token operator\">-</span><span class=\"token number\">18</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">122</span>  <span class=\"token operator\">|</span> US      <span class=\"token operator\">|</span> declined <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>   <span class=\"token operator\">|</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">12</span><span class=\"token operator\">-</span><span class=\"token number\">19</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">123</span>  <span class=\"token operator\">|</span> US      <span class=\"token operator\">|</span> approved <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>   <span class=\"token operator\">|</span> <span class=\"token number\">2019</span><span class=\"token operator\">-</span><span class=\"token number\">01</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">124</span>  <span class=\"token operator\">|</span> DE      <span class=\"token operator\">|</span> approved <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>   <span class=\"token operator\">|</span> <span class=\"token number\">2019</span><span class=\"token operator\">-</span><span class=\"token number\">01</span><span class=\"token operator\">-</span><span class=\"token number\">07</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------+---------+----------+--------+------------+</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Result <span class=\"token keyword\">table</span>:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+---------+-------------+----------------+--------------------+-----------------------+</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token keyword\">month</span>    <span class=\"token operator\">|</span> country <span class=\"token operator\">|</span> trans_count <span class=\"token operator\">|</span> approved_count <span class=\"token operator\">|</span> trans_total_amount <span class=\"token operator\">|</span> approved_total_amount <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+---------+-------------+----------------+--------------------+-----------------------+</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">12</span>  <span class=\"token operator\">|</span> US      <span class=\"token operator\">|</span> <span class=\"token number\">2</span>           <span class=\"token operator\">|</span> <span class=\"token number\">1</span>              <span class=\"token operator\">|</span> <span class=\"token number\">3000</span>               <span class=\"token operator\">|</span> <span class=\"token number\">1000</span>                  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2019</span><span class=\"token operator\">-</span><span class=\"token number\">01</span>  <span class=\"token operator\">|</span> US      <span class=\"token operator\">|</span> <span class=\"token number\">1</span>           <span class=\"token operator\">|</span> <span class=\"token number\">1</span>              <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>               <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>                  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2019</span><span class=\"token operator\">-</span><span class=\"token number\">01</span>  <span class=\"token operator\">|</span> DE      <span class=\"token operator\">|</span> <span class=\"token number\">1</span>           <span class=\"token operator\">|</span> <span class=\"token number\">1</span>              <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>               <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>                  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+---------+-------------+----------------+--------------------+-----------------------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> DATE_FORMAT<span class=\"token punctuation\">(</span>trans_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    country<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> trans_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> approved_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> trans_total_amount<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> approved_total_amount</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token keyword\">Transactions</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span> country</pre></td></tr></table></figure><h4 id=\"1193-每月交易-i\"><a class=\"anchor\" href=\"#1193-每月交易-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbW9udGhseS10cmFuc2FjdGlvbnMtaS8=\">1193. 每月交易 I</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Transactions</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| country       | varchar |\n| state         | enum    |\n| amount        | int     |\n| trans_date    | date    |\n+---------------+---------+\nid 是这个表的主键。\n该表包含有关传入事务的信息。\nstate 列类型为 “[”批准“，”拒绝“] 之一。\n</code></pre>\n<p>编写一个 sql 查询来查找每个月和每个国家 / 地区的事务数及其总金额、已批准的事务数及其总金额。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Transactions table:\n+------+---------+----------+--------+------------+\n| id   | country | state    | amount | trans_date |\n+------+---------+----------+--------+------------+\n| 121  | US      | approved | 1000   | 2018-12-18 |\n| 122  | US      | declined | 2000   | 2018-12-19 |\n| 123  | US      | approved | 2000   | 2019-01-01 |\n| 124  | DE      | approved | 2000   | 2019-01-07 |\n+------+---------+----------+--------+------------+\n\nResult table:\n+----------+---------+-------------+----------------+--------------------+-----------------------+\n| month    | country | trans_count | approved_count | trans_total_amount | approved_total_amount |\n+----------+---------+-------------+----------------+--------------------+-----------------------+\n| 2018-12  | US      | 2           | 1              | 3000               | 1000                  |\n| 2019-01  | US      | 1           | 1              | 2000               | 2000                  |\n| 2019-01  | DE      | 1           | 1              | 2000               | 2000                  |\n+----------+---------+-------------+----------------+--------------------+-----------------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> DATE_FORMAT<span class=\"token punctuation\">(</span>trans_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    country<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> trans_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> approved_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> trans_total_amount<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> approved_total_amount</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token keyword\">Transactions</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span> country</pre></td></tr></table></figure><h4 id=\"1205-每月交易ii\"><a class=\"anchor\" href=\"#1205-每月交易ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbW9udGhseS10cmFuc2FjdGlvbnMtaWkv\">1205. 每月交易 II</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Transactions</code>  记录表</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| id             | int     |\n| country        | varchar |\n| state          | enum    |\n| amount         | int     |\n| trans_date     | date    |\n+----------------+---------+\nid 是这个表的主键。\n该表包含有关传入事务的信息。\n状态列是类型为 [approved（已批准）、declined（已拒绝）] 的枚举。\n</code></pre>\n<p><code>Chargebacks</code>  表</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| trans_id       | int     |\n| charge_date    | date    |\n+----------------+---------+\n退单包含有关放置在事务表中的某些事务的传入退单的基本信息。\ntrans_id 是 transactions 表的 id 列的外键。\n每项退单都对应于之前进行的交易，即使未经批准。\n</code></pre>\n<p>编写一个 SQL 查询，以查找每个月和每个国家 / 地区的已批准交易的数量及其总金额、退单的数量及其总金额。</p>\n<p>注意：在您的查询中，给定月份和国家，忽略所有为零的行。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Transactions 表：\n+------+---------+----------+--------+------------+\n| id   | country | state    | amount | trans_date |\n+------+---------+----------+--------+------------+\n| 101  | US      | approved | 1000   | 2019-05-18 |\n| 102  | US      | declined | 2000   | 2019-05-19 |\n| 103  | US      | approved | 3000   | 2019-06-10 |\n| 104  | US      | declined | 4000   | 2019-06-13 |\n| 105  | US      | approved | 5000   | 2019-06-15 |\n+------+---------+----------+--------+------------+\n\nChargebacks 表：\n+------------+------------+\n| trans_id   | trans_date |\n+------------+------------+\n| 102        | 2019-05-29 |\n| 101        | 2019-06-30 |\n| 105        | 2019-09-18 |\n+------------+------------+\n\nResult 表：\n+----------+---------+----------------+-----------------+-------------------+--------------------+\n| month    | country | approved_count | approved_amount | chargeback_count  | chargeback_amount  |\n+----------+---------+----------------+-----------------+-------------------+--------------------+\n| 2019-05  | US      | 1              | 1000            | 1                 | 2000               |\n| 2019-06  | US      | 2              | 8000            | 1                 | 1000               |\n| 2019-09  | US      | 0              | 0               | 1                 | 5000               |\n+----------+---------+----------------+-----------------+-------------------+--------------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    date_format<span class=\"token punctuation\">(</span>trans_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    country<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">)</span> approved_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> approved_amount<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'chargeback'</span><span class=\"token punctuation\">)</span> chargeback_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'chargeback'</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> chargeback_amount</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token keyword\">transactions</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token keyword\">all</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> country<span class=\"token punctuation\">,</span> <span class=\"token string\">'chargeback'</span> state<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>trans_date</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">from</span> chargebacks c <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token keyword\">transactions</span> t </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">on</span> c<span class=\"token punctuation\">.</span>trans_id <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>id</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span> tmp </pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span> country</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">having</span> approved_amount <span class=\"token operator\">or</span> chargeback_amount</pre></td></tr></table></figure><h4 id=\"1194-锦标赛优胜者\"><a class=\"anchor\" href=\"#1194-锦标赛优胜者\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdG91cm5hbWVudC13aW5uZXJzLw==\">1194. 锦标赛优胜者</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Players</code>  玩家表</p>\n<pre><code>+-------------+-------+\n| Column Name | Type  |\n+-------------+-------+\n| player_id   | int   |\n| group_id    | int   |\n+-------------+-------+\n玩家 ID 是此表的主键。\n此表的每一行表示每个玩家的组。\n</code></pre>\n<p><code>Matches</code>  赛事表</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| match_id      | int     |\n| first_player  | int     |\n| second_player | int     | \n| first_score   | int     |\n| second_score  | int     |\n+---------------+---------+\nmatch_id 是此表的主键。\n每一行是一场比赛的记录，第一名和第二名球员包含每场比赛的球员 ID。\n第一个玩家和第二个玩家的分数分别包含第一个玩家和第二个玩家的分数。\n你可以假设，在每一场比赛中，球员都属于同一组。\n</code></pre>\n<p>每组的获胜者是在组内得分最高的选手。如果平局，player_id <strong>最小</strong> 的选手获胜。</p>\n<p>编写一个 SQL 查询来查找每组中的获胜者。</p>\n<p>查询结果格式如下所示</p>\n<pre><code>Players 表:\n+-----------+------------+\n| player_id | group_id   |\n+-----------+------------+\n| 15        | 1          |\n| 25        | 1          |\n| 30        | 1          |\n| 45        | 1          |\n| 10        | 2          |\n| 35        | 2          |\n| 50        | 2          |\n| 20        | 3          |\n| 40        | 3          |\n+-----------+------------+\n\nMatches 表:\n+------------+--------------+---------------+-------------+--------------+\n| match_id   | first_player | second_player | first_score | second_score |\n+------------+--------------+---------------+-------------+--------------+\n| 1          | 15           | 45            | 3           | 0            |\n| 2          | 30           | 25            | 1           | 2            |\n| 3          | 30           | 15            | 2           | 0            |\n| 4          | 40           | 20            | 5           | 2            |\n| 5          | 35           | 50            | 1           | 1            |\n+------------+--------------+---------------+-------------+--------------+\n\nResult 表:\n+-----------+------------+\n| group_id  | player_id  |\n+-----------+------------+ \n| 1         | 15         |\n| 2         | 35         |\n| 3         | 40         |\n+-----------+------------+\n</code></pre>\n<p>union all</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> group_id<span class=\"token punctuation\">,</span> player_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> group_id<span class=\"token punctuation\">,</span> player_id<span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> score</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">-- 每个用户总的 first_score</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">SELECT</span> Players<span class=\"token punctuation\">.</span>group_id<span class=\"token punctuation\">,</span> Players<span class=\"token punctuation\">.</span>player_id<span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>Matches<span class=\"token punctuation\">.</span>first_score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> score</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">FROM</span> Players <span class=\"token keyword\">JOIN</span> Matches <span class=\"token keyword\">ON</span> Players<span class=\"token punctuation\">.</span>player_id <span class=\"token operator\">=</span> Matches<span class=\"token punctuation\">.</span>first_player</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> Players<span class=\"token punctuation\">.</span>player_id</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">-- 每个用户总的 second_score</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">SELECT</span> Players<span class=\"token punctuation\">.</span>group_id<span class=\"token punctuation\">,</span> Players<span class=\"token punctuation\">.</span>player_id<span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>Matches<span class=\"token punctuation\">.</span>second_score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> score</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">FROM</span> Players <span class=\"token keyword\">JOIN</span> Matches <span class=\"token keyword\">ON</span> Players<span class=\"token punctuation\">.</span>player_id <span class=\"token operator\">=</span> Matches<span class=\"token punctuation\">.</span>second_player</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> Players<span class=\"token punctuation\">.</span>player_id</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">)</span> s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> player_id</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> score <span class=\"token keyword\">DESC</span><span class=\"token punctuation\">,</span> player_id</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">)</span> result</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> group_id</pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> group_id<span class=\"token punctuation\">,</span> player_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> players<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>player_id <span class=\"token operator\">=</span> first_player<span class=\"token punctuation\">,</span> first_score<span class=\"token punctuation\">,</span> second_score<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> score</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">from</span> players <span class=\"token keyword\">join</span> matches</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">on</span> player_id <span class=\"token operator\">=</span> first_player <span class=\"token operator\">or</span> player_id <span class=\"token operator\">=</span> second_player</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> player_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> score <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span> player_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span> tmp</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> group_id</pre></td></tr></table></figure><h4 id=\"1204-最后一个能进入电梯的人\"><a class=\"anchor\" href=\"#1204-最后一个能进入电梯的人\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbGFzdC1wZXJzb24tdG8tZml0LWluLXRoZS1lbGV2YXRvci8=\">1204. 最后一个能进入电梯的人</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Queue</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| person_id   | int     |\n| person_name | varchar |\n| weight      | int     |\n| turn        | int     |\n+-------------+---------+\nperson_id 是这个表的主键。\n该表展示了所有等待电梯的人的信息。\n表中 person_id 和 turn 列将包含从 1 到 n 的所有数字，其中 n 是表中的行数。\n</code></pre>\n<p>电梯最大载重量为 <strong>1000</strong>。</p>\n<p>写一条 SQL 查询语句查找最后一个能进入电梯且不超过重量限制的  <code>person_name</code>  。题目确保队列中第一位的人可以进入电梯 。</p>\n<p>查询结果如下所示 :</p>\n<pre><code>Queue 表\n+-----------+-------------------+--------+------+\n| person_id | person_name       | weight | turn |\n+-----------+-------------------+--------+------+\n| 5         | George Washington | 250    | 1    |\n| 3         | John Adams        | 350    | 2    |\n| 6         | Thomas Jefferson  | 400    | 3    |\n| 2         | Will Johnliams    | 200    | 4    |\n| 4         | Thomas Jefferson  | 175    | 5    |\n| 1         | James Elephant    | 500    | 6    |\n+-----------+-------------------+--------+------+\n\nResult 表\n+-------------------+\n| person_name       |\n+-------------------+\n| Thomas Jefferson  |\n+-------------------+\n\n为了简化，Queue 表按 turn 列由小到大排序。\n上例中 George Washington(id 5), John Adams(id 3) 和 Thomas Jefferson(id 6) 将可以进入电梯,因为他们的体重和为 250 + 350 + 400 = 1000。\nThomas Jefferson(id 6) 是最后一个体重合适并进入电梯的人。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> person_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> person_name  <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>weight<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> turn<span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">from</span> Queue</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">where</span> t<span class=\"token operator\">&lt;=</span><span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> t <span class=\"token keyword\">desc</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1211-查询结果的质量和占比\"><a class=\"anchor\" href=\"#1211-查询结果的质量和占比\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcXVlcmllcy1xdWFsaXR5LWFuZC1wZXJjZW50YWdlLw==\">1211. 查询结果的质量和占比</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>查询表  <code>Queries</code> ：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| query_name  | varchar |\n| result      | varchar |\n| position    | int     |\n| rating      | int     |\n+-------------+---------+\n此表没有主键，并可能有重复的行。\n此表包含了一些从数据库中收集的查询信息。\n“位置”（position）列的值为 1 到 500 。\n“评分”（rating）列的值为 1 到 5 。评分小于 3 的查询被定义为质量很差的查询。\n</code></pre>\n<p>将查询结果的质量  <code>quality</code>  定义为：</p>\n<blockquote>\n<p>各查询结果的评分与其位置之间比率的平均值。</p>\n</blockquote>\n<p>将劣质查询百分比  <code>poor_query_percentage</code>  为：</p>\n<blockquote>\n<p>评分小于 3 的查询结果占全部查询结果的百分比。</p>\n</blockquote>\n<p>编写一组 SQL 来查找每次查询的 <code>名称</code>  ( <code>query_name</code> )、 <code>质量</code>  ( <code>quality</code> ) 和  <code>劣质查询百分比</code>  ( <code>poor_query_percentage</code> )。</p>\n<p><code>质量</code>  ( <code>quality</code> ) 和 <code>劣质查询百分比</code>  ( <code>poor_query_percentage</code> ) 都应四舍五入到小数点后两位。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Queries table:\n+------------+-------------------+----------+--------+\n| query_name | result            | position | rating |\n+------------+-------------------+----------+--------+\n| Dog        | Golden Retriever  | 1        | 5      |\n| Dog        | German Shepherd   | 2        | 5      |\n| Dog        | Mule              | 200      | 1      |\n| Cat        | Shirazi           | 5        | 2      |\n| Cat        | Siamese           | 3        | 3      |\n| Cat        | Sphynx            | 7        | 4      |\n+------------+-------------------+----------+--------+\n\nResult table:\n+------------+---------+-----------------------+\n| query_name | quality | poor_query_percentage |\n+------------+---------+-----------------------+\n| Dog        | 2.50    | 33.33                 |\n| Cat        | 0.66    | 33.33                 |\n+------------+---------+-----------------------+\n\nDog 查询结果的质量为 ((5 / 1) + (5 / 2) + (1 / 200)) / 3 = 2.50\nDog 查询结果的劣质查询百分比为 (1 / 3) * 100 = 33.33\n\nCat 查询结果的质量为 ((2 / 5) + (3 / 3) + (4 / 7)) / 3 = 0.66\nCat 查询结果的劣质查询百分比为 (1 / 3) * 100 = 33.33\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> query_name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>rating<span class=\"token operator\">/</span>position<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> quality<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>rating<span class=\"token operator\">&lt;</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> poor_query_percentage</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Queries</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> query_name</pre></td></tr></table></figure><h4 id=\"1212-查询球队积分\"><a class=\"anchor\" href=\"#1212-查询球队积分\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdGVhbS1zY29yZXMtaW4tZm9vdGJhbGwtdG91cm5hbWVudC8=\">1212. 查询球队积分</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Teams</code></p>\n<pre><code>+---------------+----------+\n| Column Name   | Type     |\n+---------------+----------+\n| team_id       | int      |\n| team_name     | varchar  |\n+---------------+----------+\n此表的主键是 team_id，表中的每一行都代表一支独立足球队。\n</code></pre>\n<p>Table:  <code>Matches</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| match_id      | int     |\n| host_team     | int     |\n| guest_team    | int     | \n| host_goals    | int     |\n| guest_goals   | int     |\n+---------------+---------+\n此表的主键是 match_id，表中的每一行都代表一场已结束的比赛，比赛的主客队分别由它们自己的 id 表示，他们的进球由 host_goals 和 guest_goals 分别表示。\n</code></pre>\n<p>积分规则如下：</p>\n<ul>\n<li>赢一场得三分；</li>\n<li>平一场得一分；</li>\n<li>输一场不得分。</li>\n</ul>\n<p>写出一条 SQL 语句以查询每个队的 <strong>team_id</strong>，<strong>team_name</strong> 和 <strong>num_points</strong>。结果根据 num_points <strong>降序排序</strong>，如果有两队积分相同，那么这两队按 team_id <strong>升序排序</strong>。</p>\n<p>查询结果格式如下：</p>\n<pre><code>Teams table:\n+-----------+--------------+\n| team_id   | team_name    |\n+-----------+--------------+\n| 10        | Leetcode FC  |\n| 20        | NewYork FC   |\n| 30        | Atlanta FC   |\n| 40        | Chicago FC   |\n| 50        | Toronto FC   |\n+-----------+--------------+\n\nMatches table:\n+------------+--------------+---------------+-------------+--------------+\n| match_id   | host_team    | guest_team    | host_goals  | guest_goals  |\n+------------+--------------+---------------+-------------+--------------+\n| 1          | 10           | 20            | 3           | 0            |\n| 2          | 30           | 10            | 2           | 2            |\n| 3          | 10           | 50            | 5           | 1            |\n| 4          | 20           | 30            | 1           | 0            |\n| 5          | 50           | 30            | 1           | 0            |\n+------------+--------------+---------------+-------------+--------------+\n\nResult table:\n+------------+--------------+---------------+\n| team_id    | team_name    | num_points    |\n+------------+--------------+---------------+\n| 10         | Leetcode FC  | 7             |\n| 20         | NewYork FC   | 3             |\n| 50         | Toronto FC   | 3             |\n| 30         | Atlanta FC   | 1             |\n| 40         | Chicago FC   | 0             |\n+------------+--------------+---------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> team_id <span class=\"token punctuation\">,</span> team_name <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>team_id <span class=\"token operator\">=</span> host_team <span class=\"token operator\">&amp;&amp;</span> host_goals<span class=\"token operator\">></span>guest_goals <span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>team_id <span class=\"token operator\">=</span> host_team <span class=\"token operator\">&amp;&amp;</span> host_goals<span class=\"token operator\">=</span>guest_goals<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>team_id <span class=\"token operator\">=</span> guest_team <span class=\"token operator\">&amp;&amp;</span> host_goals<span class=\"token operator\">=</span>guest_goals<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>team_id <span class=\"token operator\">=</span> guest_team <span class=\"token operator\">&amp;&amp;</span> host_goals<span class=\"token operator\">&lt;</span>guest_goals <span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>num_points</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> Teams t <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Matches m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">on</span> t<span class=\"token punctuation\">.</span>team_id <span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>host_team  <span class=\"token operator\">or</span> t<span class=\"token punctuation\">.</span>team_id <span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>guest_team  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> team_id <span class=\"token punctuation\">,</span>team_name</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> num_points <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>team_id</pre></td></tr></table></figure><h4 id=\"1225-报告系统状态的连续日期\"><a class=\"anchor\" href=\"#1225-报告系统状态的连续日期\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVwb3J0LWNvbnRpZ3VvdXMtZGF0ZXMv\">1225. 报告系统状态的连续日期</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Failed</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| fail_date    | date    |\n+--------------+---------+\n该表主键为 fail_date。\n该表包含失败任务的天数.\n</code></pre>\n<p>Table:  <code>Succeeded</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| success_date | date    |\n+--------------+---------+\n该表主键为 success_date。\n该表包含成功任务的天数.\n</code></pre>\n<p>系统 <strong>每天</strong> 运行一个任务。每个任务都独立于先前的任务。任务的状态可以是失败或是成功。</p>\n<p>编写一个 SQL 查询 <strong>2019-01-01</strong> 到 <strong>2019-12-31</strong> 期间任务连续同状态  <code>period_state</code>  的起止日期（ <code>start_date</code>  和  <code>end_date</code> ）。即如果任务失败了，就是失败状态的起止日期，如果任务成功了，就是成功状态的起止日期。</p>\n<p>最后结果按照起始日期  <code>start_date</code>  排序</p>\n<p>查询结果样例如下所示:</p>\n<pre><code>Failed table:\n+-------------------+\n| fail_date         |\n+-------------------+\n| 2018-12-28        |\n| 2018-12-29        |\n| 2019-01-04        |\n| 2019-01-05        |\n+-------------------+\n\nSucceeded table:\n+-------------------+\n| success_date      |\n+-------------------+\n| 2018-12-30        |\n| 2018-12-31        |\n| 2019-01-01        |\n| 2019-01-02        |\n| 2019-01-03        |\n| 2019-01-06        |\n+-------------------+\n\n\nResult table:\n+--------------+--------------+--------------+\n| period_state | start_date   | end_date     |\n+--------------+--------------+--------------+\n| succeeded    | 2019-01-01   | 2019-01-03   |\n| failed       | 2019-01-04   | 2019-01-05   |\n| succeeded    | 2019-01-06   | 2019-01-06   |\n+--------------+--------------+--------------+\n\n结果忽略了 2018 年的记录，因为我们只关心从 2019-01-01 到 2019-12-31 的记录\n从 2019-01-01 到 2019-01-03 所有任务成功，系统状态为 &quot;succeeded&quot;。\n从 2019-01-04 到 2019-01-05 所有任务失败，系统状态为 &quot;failed&quot;。\n从 2019-01-06 到 2019-01-06 所有任务成功，系统状态为 &quot;succeeded&quot;。\n</code></pre>\n<p>开窗函数</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">type</span>  period_state<span class=\"token punctuation\">,</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span> start_date<span class=\"token punctuation\">,</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> end_date</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">,</span> subdate<span class=\"token punctuation\">(</span><span class=\"token keyword\">date</span><span class=\"token punctuation\">,</span>row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">type</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> diff</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token string\">'failed'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span> fail_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span> <span class=\"token keyword\">from</span> Failed</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">where</span> fail_date <span class=\"token operator\">between</span> <span class=\"token string\">'2019-01-01'</span> <span class=\"token operator\">and</span> <span class=\"token string\">'2019-12-31'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">union</span> <span class=\"token keyword\">all</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token string\">'succeeded'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span> success_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span> <span class=\"token keyword\">from</span> Succeeded</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">where</span> success_date <span class=\"token operator\">between</span> <span class=\"token string\">'2019-01-01'</span> <span class=\"token operator\">and</span> <span class=\"token string\">'2019-12-31'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">)</span>b</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span>diff</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> start_date</pre></td></tr></table></figure><h4 id=\"1241-每个帖子的评论数\"><a class=\"anchor\" href=\"#1241-每个帖子的评论数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbnVtYmVyLW9mLWNvbW1lbnRzLXBlci1wb3N0Lw==\">1241. 每个帖子的评论数</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表  <code>Submissions</code>  结构如下：</p>\n<pre><code>+---------------+----------+\n| 列名           | 类型     |\n+---------------+----------+\n| sub_id        | int      |\n| parent_id     | int      |\n+---------------+----------+\n上表没有主键, 所以可能会出现重复的行。\n每行可以是一个帖子或对该帖子的评论。\n如果是帖子的话，parent_id 就是 null。\n对于评论来说，parent_id 就是表中对应帖子的 sub_id。\n</code></pre>\n<p>编写 SQL 语句以查找每个帖子的评论数。</p>\n<p>结果表应包含帖子的  <code>post_id</code>  和对应的评论数  <code>number_of_comments</code>  并且按  <code>post_id</code>  升序排列。</p>\n<p><code>Submissions</code>  可能包含重复的评论。您应该计算每个帖子的唯一评论数。</p>\n<p><code>Submissions</code>  可能包含重复的帖子。您应该将它们视为一个帖子。</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Submissions table:\n+---------+------------+\n| sub_id  | parent_id  |\n+---------+------------+\n| 1       | Null       |\n| 2       | Null       |\n| 1       | Null       |\n| 12      | Null       |\n| 3       | 1          |\n| 5       | 2          |\n| 3       | 1          |\n| 4       | 1          |\n| 9       | 1          |\n| 10      | 2          |\n| 6       | 7          |\n+---------+------------+\n\n结果表：\n+---------+--------------------+\n| post_id | number_of_comments |\n+---------+--------------------+\n| 1       | 3                  |\n| 2       | 2                  |\n| 12      | 0                  |\n+---------+--------------------+\n\n表中 ID 为 1 的帖子有 ID 为 3、4 和 9 的三个评论。表中 ID 为 3 的评论重复出现了，所以我们只对它进行了一次计数。\n表中 ID 为 2 的帖子有 ID 为 5 和 10 的两个评论。\nID 为 12 的帖子在表中没有评论。\n表中 ID 为 6 的评论是对 ID 为 7 的已删除帖子的评论，因此我们将其忽略。\n</code></pre>\n<p>后 join</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>sub_id post_id<span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>number_of_comments<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> number_of_comments</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Submissions s</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">select</span> parent_id <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> sub_id<span class=\"token punctuation\">)</span> number_of_comments</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">from</span> Submissions </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> parent_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span> t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>sub_id <span class=\"token operator\">=</span> t1<span class=\"token punctuation\">.</span>parent_id</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span> s<span class=\"token punctuation\">.</span>parent_id  <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> post_id<span class=\"token punctuation\">,</span>number_of_comments</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> sub_id</pre></td></tr></table></figure><p>先 join</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> post_id<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>sub_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> number_of_comments</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span> post<span class=\"token punctuation\">.</span>sub_id <span class=\"token keyword\">AS</span> post_id<span class=\"token punctuation\">,</span> sub<span class=\"token punctuation\">.</span>sub_id <span class=\"token keyword\">AS</span> sub_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">FROM</span> Submissions post</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> Submissions sub</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">ON</span> post<span class=\"token punctuation\">.</span>sub_id <span class=\"token operator\">=</span> sub<span class=\"token punctuation\">.</span>parent_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">WHERE</span> post<span class=\"token punctuation\">.</span>parent_id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span> T</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> post_id</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> post_id <span class=\"token keyword\">ASC</span></pre></td></tr></table></figure><h4 id=\"1251-平均售价\"><a class=\"anchor\" href=\"#1251-平均售价\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYXZlcmFnZS1zZWxsaW5nLXByaWNlLw==\">1251. 平均售价</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Prices</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| start_date    | date    |\n| end_date      | date    |\n| price         | int     |\n+---------------+---------+\n(product_id，start_date，end_date) 是 Prices 表的主键。\nPrices 表的每一行表示的是某个产品在一段时期内的价格。\n每个产品的对应时间段是不会重叠的，这也意味着同一个产品的价格时段不会出现交叉。\n</code></pre>\n<p>Table:  <code>UnitsSold</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| purchase_date | date    |\n| units         | int     |\n+---------------+---------+\nUnitsSold 表没有主键，它可能包含重复项。\nUnitsSold 表的每一行表示的是每种产品的出售日期，单位和产品 id。\n</code></pre>\n<p>编写 SQL 查询以查找每种产品的平均售价。<br />\n <code>average_price</code>  应该四舍五入到小数点后两位。<br />\n查询结果格式如下例所示：</p>\n<pre><code>Prices table:\n+------------+------------+------------+--------+\n| product_id | start_date | end_date   | price  |\n+------------+------------+------------+--------+\n| 1          | 2019-02-17 | 2019-02-28 | 5      |\n| 1          | 2019-03-01 | 2019-03-22 | 20     |\n| 2          | 2019-02-01 | 2019-02-20 | 15     |\n| 2          | 2019-02-21 | 2019-03-31 | 30     |\n+------------+------------+------------+--------+\n \nUnitsSold table:\n+------------+---------------+-------+\n| product_id | purchase_date | units |\n+------------+---------------+-------+\n| 1          | 2019-02-25    | 100   |\n| 1          | 2019-03-01    | 15    |\n| 2          | 2019-02-10    | 200   |\n| 2          | 2019-03-22    | 30    |\n+------------+---------------+-------+\n\nResult table:\n+------------+---------------+\n| product_id | average_price |\n+------------+---------------+\n| 1          | 6.96          |\n| 2          | 16.96         |\n+------------+---------------+\n平均售价 = 产品总价 / 销售的产品数量。\n产品 1 的平均售价 = ((100 * 5)+(15 * 20) )/ 115 = 6.96\n产品 2 的平均售价 = ((200 * 15)+(30 * 30) )/ 230 = 16.96\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    product_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">Round</span><span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>sales<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>units<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> average_price</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        Prices<span class=\"token punctuation\">.</span>product_id <span class=\"token keyword\">AS</span> product_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        Prices<span class=\"token punctuation\">.</span>price <span class=\"token operator\">*</span> UnitsSold<span class=\"token punctuation\">.</span>units <span class=\"token keyword\">AS</span> sales<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        UnitsSold<span class=\"token punctuation\">.</span>units <span class=\"token keyword\">AS</span> units</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">FROM</span> Prices </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">JOIN</span> UnitsSold <span class=\"token keyword\">ON</span> Prices<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> UnitsSold<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">WHERE</span> UnitsSold<span class=\"token punctuation\">.</span>purchase_date <span class=\"token operator\">BETWEEN</span> Prices<span class=\"token punctuation\">.</span>start_date <span class=\"token operator\">AND</span> Prices<span class=\"token punctuation\">.</span>end_date</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span> T</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> product_id</pre></td></tr></table></figure><blockquote>\n<p>2 表关联的时候直接把日期做过滤</p>\n</blockquote>\n<h4 id=\"1264-页面推荐\"><a class=\"anchor\" href=\"#1264-页面推荐\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcGFnZS1yZWNvbW1lbmRhdGlvbnMv\">1264. 页面推荐</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>朋友关系列表：  <code>Friendship</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user1_id      | int     |\n| user2_id      | int     |\n+---------------+---------+\n这张表的主键是 (user1_id, user2_id)。\n这张表的每一行代表着 user1_id 和 user2_id 之间存在着朋友关系。\n</code></pre>\n<p>喜欢列表：  <code>Likes</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| user_id     | int     |\n| page_id     | int     |\n+-------------+---------+\n这张表的主键是 (user_id, page_id)。\n这张表的每一行代表着 user_id 喜欢 page_id。\n</code></pre>\n<p>写一段 SQL  向 <code>user_id</code>  = 1 的用户，推荐其朋友们喜欢的页面。不要推荐该用户已经喜欢的页面。</p>\n<p>你返回的结果中不应当包含重复项。</p>\n<p>返回结果的格式如下例所示：</p>\n<pre><code>Friendship table:\n+----------+----------+\n| user1_id | user2_id |\n+----------+----------+\n| 1        | 2        |\n| 1        | 3        |\n| 1        | 4        |\n| 2        | 3        |\n| 2        | 4        |\n| 2        | 5        |\n| 6        | 1        |\n+----------+----------+\n \nLikes table:\n+---------+---------+\n| user_id | page_id |\n+---------+---------+\n| 1       | 88      |\n| 2       | 23      |\n| 3       | 24      |\n| 4       | 56      |\n| 5       | 11      |\n| 6       | 33      |\n| 2       | 77      |\n| 3       | 77      |\n| 6       | 88      |\n+---------+---------+\n\nResult table:\n+------------------+\n| recommended_page |\n+------------------+\n| 23               |\n| 24               |\n| 56               |\n| 33               |\n| 77               |\n+------------------+\n用户1 同 用户2, 3, 4, 6 是朋友关系。\n推荐页面为： 页面23 来自于 用户2, 页面24 来自于 用户3, 页面56 来自于 用户3 以及 页面33 来自于 用户6。\n页面77 同时被 用户2 和 用户3 推荐。\n页面88 没有被推荐，因为 用户1 已经喜欢了它。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> page_id  recommended_page</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Likes</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> user_id <span class=\"token operator\">in</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>user1_id<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>user2_id<span class=\"token punctuation\">,</span>user1_id<span class=\"token punctuation\">)</span> user_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span>  Friendship</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">where</span>  user1_id <span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">or</span> user2_id <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">and</span> page_id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> page_id <span class=\"token keyword\">from</span> Likes <span class=\"token keyword\">where</span> user_id<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1270-向公司ceo汇报工作的所有人\"><a class=\"anchor\" href=\"#1270-向公司ceo汇报工作的所有人\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWxsLXBlb3BsZS1yZXBvcnQtdG8tdGhlLWdpdmVuLW1hbmFnZXIv\">1270. 向公司 CEO 汇报工作的所有人</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>员工表： <code>Employees</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| employee_id   | int     |\n| employee_name | varchar |\n| manager_id    | int     |\n+---------------+---------+\nemployee_id 是这个表的主键。\n这个表中每一行中，employee_id 表示职工的 ID，employee_name 表示职工的名字，manager_id 表示该职工汇报工作的直线经理。\n这个公司 CEO 是 employee_id = 1 的人。\n</code></pre>\n<p>用 SQL 查询出所有直接或间接向公司 CEO 汇报工作的职工的 employee_id 。</p>\n<p>由于公司规模较小，经理之间的间接关系不超过 3 个经理。</p>\n<p>可以以任何顺序返回的结果，不需要去重。</p>\n<p>查询结果示例如下：</p>\n<pre><code>Employees table:\n+-------------+---------------+------------+\n| employee_id | employee_name | manager_id |\n+-------------+---------------+------------+\n| 1           | Boss          | 1          |\n| 3           | Alice         | 3          |\n| 2           | Bob           | 1          |\n| 4           | Daniel        | 2          |\n| 7           | Luis          | 4          |\n| 8           | Jhon          | 3          |\n| 9           | Angela        | 8          |\n| 77          | Robert        | 1          |\n+-------------+---------------+------------+\n\nResult table:\n+-------------+\n| employee_id |\n+-------------+\n| 2           |\n| 77          |\n| 4           |\n| 7           |\n+-------------+\n\n公司 CEO 的 employee_id 是 1.\nemployee_id 是 2 和 77 的职员直接汇报给公司 CEO。\nemployee_id 是 4 的职员间接汇报给公司 CEO 4 --&gt; 2 --&gt; 1 。\nemployee_id 是 7 的职员间接汇报给公司 CEO 7 --&gt; 4 --&gt; 2 --&gt; 1 。\nemployee_id 是 3, 8 ，9 的职员不会直接或间接的汇报给公司 CEO。 \n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> employee_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>employee_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Employees a </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Employees b <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>manager_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>employee_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Employees c <span class=\"token keyword\">on</span> b<span class=\"token punctuation\">.</span>manager_id <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>employee_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> a<span class=\"token punctuation\">.</span>manager_id<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">or</span> b<span class=\"token punctuation\">.</span>manager_id<span class=\"token operator\">=</span><span class=\"token number\">1</span>  <span class=\"token operator\">or</span> c<span class=\"token punctuation\">.</span>manager_id<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">where</span> employee_id<span class=\"token operator\">!=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1280-学生们参加各科测试的次数\"><a class=\"anchor\" href=\"#1280-学生们参加各科测试的次数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc3R1ZGVudHMtYW5kLWV4YW1pbmF0aW9ucy8=\">1280. 学生们参加各科测试的次数</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>学生表:  <code>Students</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| student_id    | int     |\n| student_name  | varchar |\n+---------------+---------+\n主键为 student_id（学生ID），该表内的每一行都记录有学校一名学生的信息。\n</code></pre>\n<p>科目表:  <code>Subjects</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| subject_name | varchar |\n+--------------+---------+\n主键为 subject_name（科目名称），每一行记录学校的一门科目名称。\n</code></pre>\n<p>考试表:  <code>Examinations</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| student_id   | int     |\n| subject_name | varchar |\n+--------------+---------+\n这张表压根没有主键，可能会有重复行。\n学生表里的一个学生修读科目表里的每一门科目，而这张考试表的每一行记录就表示学生表里的某个学生参加了一次科目表里某门科目的测试。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>student_name<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>subject_name<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>subject_name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> attended_exams</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> Students a <span class=\"token keyword\">CROSS</span> <span class=\"token keyword\">JOIN</span> Subjects b</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> Examinations e <span class=\"token keyword\">ON</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">AND</span> b<span class=\"token punctuation\">.</span>subject_name <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>subject_name</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>subject_name</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>subject_name</pre></td></tr></table></figure><blockquote>\n<p>CROSS JOIN Mysql 中没有 full outer join \thive 中可以用</p>\n</blockquote>\n<h4 id=\"1285-找到连续区间的开始和结束数字\"><a class=\"anchor\" href=\"#1285-找到连续区间的开始和结束数字\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC10aGUtc3RhcnQtYW5kLWVuZC1udW1iZXItb2YtY29udGludW91cy1yYW5nZXMv\">1285. 找到连续区间的开始和结束数字</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表： <code>Logs</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| log_id        | int     |\n+---------------+---------+\nid 是上表的主键。\n上表的每一行包含日志表中的一个 ID。\n</code></pre>\n<p>后来一些 ID 从  <code>Logs</code>  表中删除。编写一个 SQL 查询得到  <code>Logs</code>  表中的连续区间的开始数字和结束数字。</p>\n<p>将查询表按照  <code>start_id</code>  排序。</p>\n<p>查询结果格式如下面的例子：</p>\n<pre><code>Logs 表：\n+------------+\n| log_id     |\n+------------+\n| 1          |\n| 2          |\n| 3          |\n| 7          |\n| 8          |\n| 10         |\n+------------+\n\n结果表：\n+------------+--------------+\n| start_id   | end_id       |\n+------------+--------------+\n| 1          | 3            |\n| 7          | 8            |\n| 10         | 10           |\n+------------+--------------+\n结果表应包含 Logs 表中的所有区间。\n从 1 到 3 在表中。\n从 4 到 6 不在表中。\n从 7 到 8 在表中。\n9 不在表中。\n10 在表中。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">MIN</span><span class=\"token punctuation\">(</span>log_id<span class=\"token punctuation\">)</span> start_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">MAX</span><span class=\"token punctuation\">(</span>log_id<span class=\"token punctuation\">)</span> end_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        log_id<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        log_id <span class=\"token operator\">-</span> row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">OVER</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> log_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> diff</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">FROM</span> Logs<span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> diff</pre></td></tr></table></figure><blockquote>\n<p>相似 1225 题</p>\n</blockquote>\n<h4 id=\"1294-不同国家的天气类型\"><a class=\"anchor\" href=\"#1294-不同国家的天气类型\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvd2VhdGhlci10eXBlLWluLWVhY2gtY291bnRyeS8=\">1294. 不同国家的天气类型</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>国家表： <code>Countries</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| country_id    | int     |\n| country_name  | varchar |\n+---------------+---------+\ncountry_id 是这张表的主键。\n该表的每行有 country_id 和 country_name 两列。\n</code></pre>\n<p>天气表： <code>Weather</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| country_id    | int     |\n| weather_state | varchar |\n| day           | date    |\n+---------------+---------+\n(country_id, day) 是该表的复合主键。\n该表的每一行记录了某个国家某一天的天气情况。\n</code></pre>\n<p>写一段 SQL 来找到表中每个国家在 2019 年 11 月的天气类型。</p>\n<p>天气类型的定义如下：当 weather_state 的平均值小于或等于 15 返回 <strong>Cold</strong>，当 weather_state 的平均值大于或等于 25 返回 <strong>Hot</strong>，否则返回 <strong>Warm</strong>。</p>\n<p>你可以以任意顺序返回你的查询结果。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Countries table:\n+------------+--------------+\n| country_id | country_name |\n+------------+--------------+\n| 2          | USA          |\n| 3          | Australia    |\n| 7          | Peru         |\n| 5          | China        |\n| 8          | Morocco      |\n| 9          | Spain        |\n+------------+--------------+\nWeather table:\n+------------+---------------+------------+\n| country_id | weather_state | day        |\n+------------+---------------+------------+\n| 2          | 15            | 2019-11-01 |\n| 2          | 12            | 2019-10-28 |\n| 2          | 12            | 2019-10-27 |\n| 3          | -2            | 2019-11-10 |\n| 3          | 0             | 2019-11-11 |\n| 3          | 3             | 2019-11-12 |\n| 5          | 16            | 2019-11-07 |\n| 5          | 18            | 2019-11-09 |\n| 5          | 21            | 2019-11-23 |\n| 7          | 25            | 2019-11-28 |\n| 7          | 22            | 2019-12-01 |\n| 7          | 20            | 2019-12-02 |\n| 8          | 25            | 2019-11-05 |\n| 8          | 27            | 2019-11-15 |\n| 8          | 31            | 2019-11-25 |\n| 9          | 7             | 2019-10-23 |\n| 9          | 3             | 2019-12-23 |\n+------------+---------------+------------+\nResult table:\n+--------------+--------------+\n| country_name | weather_type |\n+--------------+--------------+\n| USA          | Cold         |\n| Austraila    | Cold         |\n| Peru         | Hot          |\n| China        | Warm         |\n| Morocco      | Hot          |\n+--------------+--------------+\nUSA 11 月的平均 weather_state 为 (15) / 1 = 15 所以天气类型为 Cold。\nAustralia 11 月的平均 weather_state 为 (-2 + 0 + 3) / 3 = 0.333 所以天气类型为 Cold。\nPeru 11 月的平均 weather_state 为 (25) / 1 = 25 所以天气类型为 Hot。\nChina 11 月的平均 weather_state 为 (16 + 18 + 21) / 3 = 18.333 所以天气类型为 Warm。\nMorocco 11 月的平均 weather_state 为 (25 + 27 + 31) / 3 = 27.667 所以天气类型为 Hot。\n我们并不知道 Spain 在 11 月的 weather_state 情况所以无需将他包含在结果中。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> country_name<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>weather_state<span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;=</span><span class=\"token number\">15</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'Cold'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                        <span class=\"token keyword\">when</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>weather_state<span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">25</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'Hot'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                        <span class=\"token keyword\">else</span> <span class=\"token string\">'Warm'</span> <span class=\"token keyword\">end</span> <span class=\"token punctuation\">)</span> weather_type</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Countries c <span class=\"token keyword\">join</span> Weather w <span class=\"token keyword\">on</span> c<span class=\"token punctuation\">.</span>country_id <span class=\"token operator\">=</span> w<span class=\"token punctuation\">.</span>country_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> date_format<span class=\"token punctuation\">(</span><span class=\"token keyword\">day</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"%Y-%m\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token string\">'2019-11'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> country_name</pre></td></tr></table></figure><h4 id=\"1303-求团队人数\"><a class=\"anchor\" href=\"#1303-求团队人数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC10aGUtdGVhbS1zaXplLw==\">1303. 求团队人数</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>员工表： <code>Employee</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| employee_id   | int     |\n| team_id       | int     |\n+---------------+---------+\nemployee_id 字段是这张表的主键，表中的每一行都包含每个员工的 ID 和他们所属的团队。\n</code></pre>\n<p>编写一个 SQL 查询，以求得每个员工所在团队的总人数。</p>\n<p>查询结果中的顺序无特定要求。</p>\n<p>查询结果格式示例如下：</p>\n<pre><code>Employee Table:\n+-------------+------------+\n| employee_id | team_id    |\n+-------------+------------+\n|     1       |     8      |\n|     2       |     8      |\n|     3       |     8      |\n|     4       |     7      |\n|     5       |     9      |\n|     6       |     9      |\n+-------------+------------+\nResult table:\n+-------------+------------+\n| employee_id | team_size  |\n+-------------+------------+\n|     1       |     3      |\n|     2       |     3      |\n|     3       |     3      |\n|     4       |     1      |\n|     5       |     2      |\n|     6       |     2      |\n+-------------+------------+\nID 为 1、2、3 的员工是 team_id 为 8 的团队的成员，\nID 为 4 的员工是 team_id 为 7 的团队的成员，\nID 为 5、6 的员工是 team_id 为 9 的团队的成员。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> employee_id<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> team_id<span class=\"token punctuation\">)</span> team_size </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Employee</pre></td></tr></table></figure><h4 id=\"1308-不同性别每日分数总计\"><a class=\"anchor\" href=\"#1308-不同性别每日分数总计\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcnVubmluZy10b3RhbC1mb3ItZGlmZmVyZW50LWdlbmRlcnMv\">1308. 不同性别每日分数总计</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Scores</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| player_name   | varchar |\n| gender        | varchar |\n| day           | date    |\n| score_points  | int     |\n+---------------+---------+\n(gender, day)是该表的主键\n一场比赛是在女队和男队之间举行的\n该表的每一行表示一个名叫 (player_name) 性别为 (gender) 的参赛者在某一天获得了 (score_points) 的分数\n如果参赛者是女性，那么 gender 列为 'F'，如果参赛者是男性，那么 gender 列为 'M'\n</code></pre>\n<p>写一条 SQL 语句查询每种性别在每一天的总分，并按性别和日期对查询结果排序</p>\n<p>下面是查询结果格式的例子：</p>\n<pre><code>Scores表:\n+-------------+--------+------------+--------------+\n| player_name | gender | day        | score_points |\n+-------------+--------+------------+--------------+\n| Aron        | F      | 2020-01-01 | 17           |\n| Alice       | F      | 2020-01-07 | 23           |\n| Bajrang     | M      | 2020-01-07 | 7            |\n| Khali       | M      | 2019-12-25 | 11           |\n| Slaman      | M      | 2019-12-30 | 13           |\n| Joe         | M      | 2019-12-31 | 3            |\n| Jose        | M      | 2019-12-18 | 2            |\n| Priya       | F      | 2019-12-31 | 23           |\n| Priyanka    | F      | 2019-12-30 | 17           |\n+-------------+--------+------------+--------------+\n结果表:\n+--------+------------+-------+\n| gender | day        | total |\n+--------+------------+-------+\n| F      | 2019-12-30 | 17    |\n| F      | 2019-12-31 | 40    |\n| F      | 2020-01-01 | 57    |\n| F      | 2020-01-07 | 80    |\n| M      | 2019-12-18 | 2     |\n| M      | 2019-12-25 | 13    |\n| M      | 2019-12-30 | 26    |\n| M      | 2019-12-31 | 29    |\n| M      | 2020-01-07 | 36    |\n+--------+------------+-------+\n女性队伍:\n第一天是 2019-12-30，Priyanka 获得 17 分，队伍的总分是 17 分\n第二天是 2019-12-31, Priya 获得 23 分，队伍的总分是 40 分\n第三天是 2020-01-01, Aron 获得 17 分，队伍的总分是 57 分\n第四天是 2020-01-07, Alice 获得 23 分，队伍的总分是 80 分\n男性队伍：\n第一天是 2019-12-18, Jose 获得 2 分，队伍的总分是 2 分\n第二天是 2019-12-25, Khali 获得 11 分，队伍的总分是 13 分\n第三天是 2019-12-30, Slaman 获得 13 分，队伍的总分是 26 分\n第四天是 2019-12-31, Joe 获得 3 分，队伍的总分是 29 分\n第五天是 2020-01-07, Bajrang 获得 7 分，队伍的总分是 36 分\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> gender <span class=\"token punctuation\">,</span> <span class=\"token keyword\">day</span>  <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span> score_points<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> gender <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">day</span><span class=\"token punctuation\">)</span>  total</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Scores</pre></td></tr></table></figure><h4 id=\"1321-餐馆营业额变化增长\"><a class=\"anchor\" href=\"#1321-餐馆营业额变化增长\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVzdGF1cmFudC1ncm93dGgv\">1321. 餐馆营业额变化增长</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Customer</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| customer_id   | int     |\n| name          | varchar |\n| visited_on    | date    |\n| amount        | int     |\n+---------------+---------+\n(customer_id, visited_on) 是该表的主键\n该表包含一家餐馆的顾客交易数据\nvisited_on 表示 (customer_id) 的顾客在 visited_on 那天访问了餐馆\namount 是一个顾客某一天的消费总额\n</code></pre>\n<p>你是餐馆的老板，现在你想分析一下可能的营业额变化增长（每天至少有一位顾客）</p>\n<p>写一条 SQL 查询计算以 7 天（某日期 + 该日期前的 6 天）为一个时间段的顾客消费平均值</p>\n<p>查询结果格式的例子如下：</p>\n<ul>\n<li>查询结果按  <code>visited_on</code>  排序</li>\n<li><code>average_amount</code>  要 <strong>保留两位小数</strong>，日期数据的格式为 ('YYYY-MM-DD')</li>\n</ul>\n<pre><code>Customer 表:\n+-------------+--------------+--------------+-------------+\n| customer_id | name         | visited_on   | amount      |\n+-------------+--------------+--------------+-------------+\n| 1           | Jhon         | 2019-01-01   | 100         |\n| 2           | Daniel       | 2019-01-02   | 110         |\n| 3           | Jade         | 2019-01-03   | 120         |\n| 4           | Khaled       | 2019-01-04   | 130         |\n| 5           | Winston      | 2019-01-05   | 110         | \n| 6           | Elvis        | 2019-01-06   | 140         | \n| 7           | Anna         | 2019-01-07   | 150         |\n| 8           | Maria        | 2019-01-08   | 80          |\n| 9           | Jaze         | 2019-01-09   | 110         | \n| 1           | Jhon         | 2019-01-10   | 130         | \n| 3           | Jade         | 2019-01-10   | 150         | \n+-------------+--------------+--------------+-------------+\n\n结果表:\n+--------------+--------------+----------------+\n| visited_on   | amount       | average_amount |\n+--------------+--------------+----------------+\n| 2019-01-07   | 860          | 122.86         |\n| 2019-01-08   | 840          | 120            |\n| 2019-01-09   | 840          | 120            |\n| 2019-01-10   | 1000         | 142.86         |\n+--------------+--------------+----------------+\n\n第一个七天消费平均值从 2019-01-01 到 2019-01-07 是 (100 + 110 + 120 + 130 + 110 + 140 + 150)/7 = 122.86\n第二个七天消费平均值从 2019-01-02 到 2019-01-08 是 (110 + 120 + 130 + 110 + 140 + 150 + 80)/7 = 120\n第三个七天消费平均值从 2019-01-03 到 2019-01-09 是 (120 + 130 + 110 + 140 + 150 + 80 + 110)/7 = 120\n第四个七天消费平均值从 2019-01-04 到 2019-01-10 是 (130 + 110 + 140 + 150 + 80 + 110 + 130 + 150)/7 = 142.86\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  visited_on<span class=\"token punctuation\">,</span>amount<span class=\"token punctuation\">,</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>amount<span class=\"token operator\">/</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> average_amount</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> visited_on<span class=\"token punctuation\">,</span>ant<span class=\"token punctuation\">,</span>lag<span class=\"token punctuation\">(</span>visited_on<span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> visited_on<span class=\"token punctuation\">)</span> lg<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>ant<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> visited_on <span class=\"token keyword\">rows</span> <span class=\"token operator\">between</span> <span class=\"token number\">6</span> <span class=\"token keyword\">PRECEDING</span> <span class=\"token operator\">and</span> <span class=\"token keyword\">current</span> <span class=\"token keyword\">row</span><span class=\"token punctuation\">)</span> amount</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">select</span>  visited_on  <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> ant</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">from</span> Customer</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> visited_on</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">where</span> lg <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span></pre></td></tr></table></figure><h4 id=\"1322-广告效果\"><a class=\"anchor\" href=\"#1322-广告效果\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWRzLXBlcmZvcm1hbmNlLw==\">1322. 广告效果</span></h4>\n<p>难度简单 8 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>表:  <code>Ads</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| ad_id         | int     |\n| user_id       | int     |\n| action        | enum    |\n+---------------+---------+\n(ad_id, user_id) 是该表的主键\n该表的每一行包含一条广告的 ID(ad_id)，用户的 ID(user_id) 和用户对广告采取的行为 (action)\naction 列是一个枚举类型 ('Clicked', 'Viewed', 'Ignored') 。\n</code></pre>\n<p>一家公司正在运营这些广告并想计算每条广告的效果。</p>\n<p>广告效果用点击通过率（Click-Through Rate：CTR）来衡量，公式如下:</p>\n<p><img data-src=\"https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/03/06/sql1.png\" alt=\"img\" /></p>\n<p>写一条 SQL 语句来查询每一条广告的  <code>ctr</code>  ，</p>\n<p><code>ctr</code>  要保留两位小数。结果需要按  <code>ctr</code>  <strong>降序</strong>、按  <code>ad_id</code>  <strong>升序</strong> 进行排序。</p>\n<p>查询结果示例如下：</p>\n<pre><code>Ads 表:\n+-------+---------+---------+\n| ad_id | user_id | action  |\n+-------+---------+---------+\n| 1     | 1       | Clicked |\n| 2     | 2       | Clicked |\n| 3     | 3       | Viewed  |\n| 5     | 5       | Ignored |\n| 1     | 7       | Ignored |\n| 2     | 7       | Viewed  |\n| 3     | 5       | Clicked |\n| 1     | 4       | Viewed  |\n| 2     | 11      | Viewed  |\n| 1     | 2       | Clicked |\n+-------+---------+---------+\n结果表:\n+-------+-------+\n| ad_id | ctr   |\n+-------+-------+\n| 1     | 66.67 |\n| 3     | 50.00 |\n| 2     | 33.33 |\n| 5     | 0.00  |\n+-------+-------+\n对于 ad_id = 1, ctr = (2/(2+1)) * 100 = 66.67\n对于 ad_id = 2, ctr = (1/(1+2)) * 100 = 33.33\n对于 ad_id = 3, ctr = (1/(1+1)) * 100 = 50.00\n对于 ad_id = 5, ctr = 0.00, 注意 ad_id = 5 没有被点击 (Clicked) 或查看 (Viewed) 过\n注意我们不关心 action 为 Ingnored 的广告\n结果按 ctr（降序），ad_id（升序）排序\n</code></pre>\n<p>精简</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> ad_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span>IFNULL<span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'Clicked'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'Clicked'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'Viewed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> ctr</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">FROM</span> Ads</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> ad_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> ctr <span class=\"token keyword\">DESC</span><span class=\"token punctuation\">,</span> ad_id <span class=\"token keyword\">ASC</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>笨方法</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>ad_id<span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>ctr<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> ctr</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Ads a</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> ad_id<span class=\"token punctuation\">,</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span><span class=\"token operator\">=</span><span class=\"token string\">'Clicked'</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> ctr </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> Ads </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">where</span> <span class=\"token keyword\">action</span> <span class=\"token operator\">!=</span><span class=\"token string\">'Ignored'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> ad_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1 </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>ad_id<span class=\"token operator\">=</span> t1<span class=\"token punctuation\">.</span>ad_id</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> ad_id<span class=\"token punctuation\">,</span>ctr</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> ctr <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>ad_id</pre></td></tr></table></figure><h4 id=\"1327-列出指定时间段内所有的下单产品\"><a class=\"anchor\" href=\"#1327-列出指定时间段内所有的下单产品\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbGlzdC10aGUtcHJvZHVjdHMtb3JkZXJlZC1pbi1hLXBlcmlvZC8=\">1327. 列出指定时间段内所有的下单产品</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表:  <code>Products</code></p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| product_id       | int     |\n| product_name     | varchar |\n| product_category | varchar |\n+------------------+---------+\nproduct_id 是该表主键。\n该表包含该公司产品的数据。\n</code></pre>\n<p>表:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| order_date    | date    |\n| unit          | int     |\n+---------------+---------+\n该表无主键，可能包含重复行。\nproduct_id 是表单 Products 的外键。\nunit 是在日期 order_date 内下单产品的数目。\n</code></pre>\n<p>写一个 SQL 语句，要求获取在 2020 年 2 月份下单的数量不少于 100 的产品的名字和数目。</p>\n<p>返回结果表单的顺序无要求。</p>\n<p>查询结果的格式如下：</p>\n<pre><code>Products 表:\n+-------------+-----------------------+------------------+\n| product_id  | product_name          | product_category |\n+-------------+-----------------------+------------------+\n| 1           | Leetcode Solutions    | Book             |\n| 2           | Jewels of Stringology | Book             |\n| 3           | HP                    | Laptop           |\n| 4           | Lenovo                | Laptop           |\n| 5           | Leetcode Kit          | T-shirt          |\n+-------------+-----------------------+------------------+\n\nOrders 表:\n+--------------+--------------+----------+\n| product_id   | order_date   | unit     |\n+--------------+--------------+----------+\n| 1            | 2020-02-05   | 60       |\n| 1            | 2020-02-10   | 70       |\n| 2            | 2020-01-18   | 30       |\n| 2            | 2020-02-11   | 80       |\n| 3            | 2020-02-17   | 2        |\n| 3            | 2020-02-24   | 3        |\n| 4            | 2020-03-01   | 20       |\n| 4            | 2020-03-04   | 30       |\n| 4            | 2020-03-04   | 60       |\n| 5            | 2020-02-25   | 50       |\n| 5            | 2020-02-27   | 50       |\n| 5            | 2020-03-01   | 50       |\n+--------------+--------------+----------+\n\nResult 表:\n+--------------------+---------+\n| product_name       | unit    |\n+--------------------+---------+\n| Leetcode Solutions | 130     |\n| Leetcode Kit       | 100     |\n+--------------------+---------+\n\n2020 年 2 月份下单 product_id = 1 的产品的数目总和为 (60 + 70) = 130 。\n2020 年 2 月份下单 product_id = 2 的产品的数目总和为 80 。\n2020 年 2 月份下单 product_id = 3 的产品的数目总和为 (2 + 3) = 5 。\n2020 年 2 月份 product_id = 4 的产品并没有下单。\n2020 年 2 月份下单 product_id = 5 的产品的数目总和为 (50 + 50) = 100 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_name<span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>unit<span class=\"token punctuation\">)</span> unit </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Orders o <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Products p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> o<span class=\"token punctuation\">.</span>product_id<span class=\"token operator\">=</span>p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span> date_format<span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token string\">'2020-02'</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> product_name</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">having</span> unit<span class=\"token operator\">>=</span><span class=\"token number\">100</span></pre></td></tr></table></figure><h4 id=\"1336-每次访问的交易次数\"><a class=\"anchor\" href=\"#1336-每次访问的交易次数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbnVtYmVyLW9mLXRyYW5zYWN0aW9ucy1wZXItdmlzaXQv\">1336. 每次访问的交易次数</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>表:  <code>Visits</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| visit_date    | date    |\n+---------------+---------+\n(user_id, visit_date) 是该表的主键\n该表的每行表示 user_id 在 visit_date 访问了银行\n</code></pre>\n<p>表:  <code>Transactions</code></p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| user_id          | int     |\n| transaction_date | date    |\n| amount           | int     |\n+------------------+---------+\n该表没有主键，所以可能有重复行\n该表的每一行表示 user_id 在 transaction_date 完成了一笔 amount 数额的交易\n可以保证用户 (user) 在 transaction_date 访问了银行 (也就是说 Visits 表包含 (user_id, transaction_date) 行)\n</code></pre>\n<p>银行想要得到银行客户在一次访问时的交易次数和相应的在一次访问时该交易次数的客户数量的图表</p>\n<p>写一条 SQL 查询多少客户访问了银行但没有进行任何交易，多少客户访问了银行进行了一次交易等等</p>\n<p>结果包含两列：</p>\n<ul>\n<li><code>transactions_count：</code>  客户在一次访问中的交易次数</li>\n<li><code>visits_count：</code>  在  <code>transactions_count</code>  交易次数下相应的一次访问时的客户数量</li>\n</ul>\n<pre><code>transactions_count` 的值从 `0` 到所有用户一次访问中的 `max(transactions_count)\n</code></pre>\n<p>按  <code>transactions_count</code>  排序</p>\n<p>下面是查询结果格式的例子：</p>\n<pre><code>Visits 表:\n+---------+------------+\n| user_id | visit_date |\n+---------+------------+\n| 1       | 2020-01-01 |\n| 2       | 2020-01-02 |\n| 12      | 2020-01-01 |\n| 19      | 2020-01-03 |\n| 1       | 2020-01-02 |\n| 2       | 2020-01-03 |\n| 1       | 2020-01-04 |\n| 7       | 2020-01-11 |\n| 9       | 2020-01-25 |\n| 8       | 2020-01-28 |\n+---------+------------+\nTransactions 表:\n+---------+------------------+--------+\n| user_id | transaction_date | amount |\n+---------+------------------+--------+\n| 1       | 2020-01-02       | 120    |\n| 2       | 2020-01-03       | 22     |\n| 7       | 2020-01-11       | 232    |\n| 1       | 2020-01-04       | 7      |\n| 9       | 2020-01-25       | 33     |\n| 9       | 2020-01-25       | 66     |\n| 8       | 2020-01-28       | 1      |\n| 9       | 2020-01-25       | 99     |\n+---------+------------------+--------+\n结果表:\n+--------------------+--------------+\n| transactions_count | visits_count |\n+--------------------+--------------+\n| 0                  | 4            |\n| 1                  | 5            |\n| 2                  | 0            |\n| 3                  | 1            |\n+--------------------+--------------+\n* 对于 transactions_count = 0, visits 中 (1, &quot;2020-01-01&quot;), (2, &quot;2020-01-02&quot;), (12, &quot;2020-01-01&quot;) 和 (19, &quot;2020-01-03&quot;) 没有进行交易，所以 visits_count = 4 。\n* 对于 transactions_count = 1, visits 中 (2, &quot;2020-01-03&quot;), (7, &quot;2020-01-11&quot;), (8, &quot;2020-01-28&quot;), (1, &quot;2020-01-02&quot;) 和 (1, &quot;2020-01-04&quot;) 进行了一次交易，所以 visits_count = 5 。\n* 对于 transactions_count = 2, 没有客户访问银行进行了两次交易，所以 visits_count = 0 。\n* 对于 transactions_count = 3, visits 中 (9, &quot;2020-01-25&quot;) 进行了三次交易，所以 visits_count = 1 。\n* 对于 transactions_count &gt;= 4, 没有客户访问银行进行了超过3次交易，所以我们停止在 transactions_count = 3 。\n\n如下是这个例子的图表：\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> t5<span class=\"token punctuation\">.</span>rnb <span class=\"token keyword\">AS</span> transactions_count<span class=\"token punctuation\">,</span> IFNULL<span class=\"token punctuation\">(</span>visits_count<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> visits_count</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">SELECT</span> <span class=\"token number\">0</span> <span class=\"token keyword\">AS</span> rnb</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">UNION</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">SELECT</span> ROW_NUMBER<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">OVER</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> rnb</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">FROM</span> <span class=\"token keyword\">Transactions</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">)</span> t5</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            cnt <span class=\"token keyword\">AS</span> transactions_count</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">,</span><span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>user_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> visits_count</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">SELECT</span> t1<span class=\"token punctuation\">.</span>user_id<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">.</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> cnt</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">FROM</span> Visits t1</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> <span class=\"token keyword\">Transactions</span> t2</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">ON</span> t1<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">AND</span> t1<span class=\"token punctuation\">.</span>visit_date <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>transaction_date</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> user_id<span class=\"token punctuation\">,</span> visit_date</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">)</span> t3</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> cnt</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">)</span> t4</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">ON</span> t5<span class=\"token punctuation\">.</span>rnb <span class=\"token operator\">=</span> t4<span class=\"token punctuation\">.</span>transactions_count</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">)</span> t6</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">WHERE</span> transactions_count <span class=\"token operator\">&lt;=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">.</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> cnt</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">FROM</span> Visits t1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> <span class=\"token keyword\">Transactions</span> t2</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">ON</span> t1<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">AND</span> t1<span class=\"token punctuation\">.</span>visit_date <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>transaction_date</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> t1<span class=\"token punctuation\">.</span>user_id<span class=\"token punctuation\">,</span> visit_date</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> cnt <span class=\"token keyword\">DESC</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><blockquote>\n<p>难点 从 0 自增序列，2 交易的人数为 0</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> pcnt transactions_count<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> visits_count</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> visit_date<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>amount <span class=\"token operator\">is</span>  <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> transaction_date <span class=\"token punctuation\">)</span> pcnt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span>  visit_date <span class=\"token punctuation\">)</span> tcnt</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Visits v <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token keyword\">Transactions</span> t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">on</span> v<span class=\"token punctuation\">.</span>user_id<span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">and</span> v<span class=\"token punctuation\">.</span>visit_date<span class=\"token operator\">=</span>t<span class=\"token punctuation\">.</span>transaction_date</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> pcnt</pre></td></tr></table></figure><p>这个得出结果是 [0, 4], [1, 5], [3, 3] 少了 [2,0] 还没想到什么好办法能把 [2，0] 加进去。。。</p>\n<h4 id=\"1341-电影评分\"><a class=\"anchor\" href=\"#1341-电影评分\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbW92aWUtcmF0aW5nLw==\">1341. 电影评分</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表： <code>Movies</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| movie_id      | int     |\n| title         | varchar |\n+---------------+---------+\nmovie_id 是这个表的主键。\ntitle 是电影的名字。\n</code></pre>\n<p>表： <code>Users</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| name          | varchar |\n+---------------+---------+\nuser_id 是表的主键。\n</code></pre>\n<p>表： <code>Movie_Rating</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| movie_id      | int     |\n| user_id       | int     |\n| rating        | int     |\n| created_at    | date    |\n+---------------+---------+\n(movie_id, user_id) 是这个表的主键。\n这个表包含用户在其评论中对电影的评分 rating 。\ncreated_at 是用户的点评日期。 \n</code></pre>\n<p>请你编写一组 SQL 查询：</p>\n<ul>\n<li>\n<p>查找评论电影数量最多的用户名。</p>\n<p>如果出现平局，返回字典序较小的用户名。</p>\n</li>\n<li>\n<p>查找在</p>\n<p>2020 年 2 月 平均评分最高</p>\n<p>的电影名称。</p>\n<p>如果出现平局，返回字典序较小的电影名称。</p>\n</li>\n</ul>\n<p>查询分两行返回，查询结果格式如下例所示：</p>\n<pre><code>Movies 表：\n+-------------+--------------+\n| movie_id    |  title       |\n+-------------+--------------+\n| 1           | Avengers     |\n| 2           | Frozen 2     |\n| 3           | Joker        |\n+-------------+--------------+\n\nUsers 表：\n+-------------+--------------+\n| user_id     |  name        |\n+-------------+--------------+\n| 1           | Daniel       |\n| 2           | Monica       |\n| 3           | Maria        |\n| 4           | James        |\n+-------------+--------------+\n\nMovie_Rating 表：\n+-------------+--------------+--------------+-------------+\n| movie_id    | user_id      | rating       | created_at  |\n+-------------+--------------+--------------+-------------+\n| 1           | 1            | 3            | 2020-01-12  |\n| 1           | 2            | 4            | 2020-02-11  |\n| 1           | 3            | 2            | 2020-02-12  |\n| 1           | 4            | 1            | 2020-01-01  |\n| 2           | 1            | 5            | 2020-02-17  | \n| 2           | 2            | 2            | 2020-02-01  | \n| 2           | 3            | 2            | 2020-03-01  |\n| 3           | 1            | 3            | 2020-02-22  | \n| 3           | 2            | 4            | 2020-02-25  | \n+-------------+--------------+--------------+-------------+\n\nResult 表：\n+--------------+\n| results      |\n+--------------+\n| Daniel       |\n| Frozen 2     |\n+--------------+\n\nDaniel 和 Monica 都点评了 3 部电影（&quot;Avengers&quot;, &quot;Frozen 2&quot; 和 &quot;Joker&quot;） 但是 Daniel 字典序比较小。\nFrozen 2 和 Joker 在 2 月的评分都是 3.5，但是 Frozen 2 的字典序比较小。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name results </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> m<span class=\"token punctuation\">.</span>user_id <span class=\"token punctuation\">,</span>u<span class=\"token punctuation\">.</span>name </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> Movie_Rating m <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Users u </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">on</span> m<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> u<span class=\"token punctuation\">.</span>user_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> user_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>name</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">union</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">select</span> title results</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">from</span> Movie_Rating r <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Movies m</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">on</span> r<span class=\"token punctuation\">.</span>movie_id <span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>movie_id </pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">where</span> date_format<span class=\"token punctuation\">(</span>created_at<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token string\">'2020-02'</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> r<span class=\"token punctuation\">.</span>movie_id</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>rating<span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>title </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1350-院系无效的学生\"><a class=\"anchor\" href=\"#1350-院系无效的学生\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc3R1ZGVudHMtd2l0aC1pbnZhbGlkLWRlcGFydG1lbnRzLw==\">1350. 院系无效的学生</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>院系表:  <code>Departments</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n+---------------+---------+\nid 是该表的主键\n该表包含一所大学每个院系的 id 信息\n</code></pre>\n<p>学生表:  <code>Students</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n| department_id | int     |\n+---------------+---------+\nid 是该表的主键\n该表包含一所大学每个学生的 id 和他/她就读的院系信息\n</code></pre>\n<p>写一条 SQL 语句以查询那些所在院系不存在的学生的 id 和姓名</p>\n<p>可以以任何顺序返回结果</p>\n<p>下面是返回结果格式的例子</p>\n<pre><code>Departments 表:\n+------+--------------------------+\n| id   | name                     |\n+------+--------------------------+\n| 1    | Electrical Engineering   |\n| 7    | Computer Engineering     |\n| 13   | Bussiness Administration |\n+------+--------------------------+\n\nStudents 表:\n+------+----------+---------------+\n| id   | name     | department_id |\n+------+----------+---------------+\n| 23   | Alice    | 1             |\n| 1    | Bob      | 7             |\n| 5    | Jennifer | 13            |\n| 2    | John     | 14            |\n| 4    | Jasmine  | 77            |\n| 3    | Steve    | 74            |\n| 6    | Luis     | 1             |\n| 8    | Jonathan | 7             |\n| 7    | Daiana   | 33            |\n| 11   | Madelynn | 1             |\n+------+----------+---------------+\n\n结果表:\n+------+----------+\n| id   | name     |\n+------+----------+\n| 2    | John     |\n| 7    | Daiana   |\n| 4    | Jasmine  |\n| 3    | Steve    |\n+------+----------+\n\nJohn, Daiana, Steve 和 Jasmine 所在的院系分别是 14, 33, 74 和 77， 其中 14, 33, 74 和 77 并不存在于院系表\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>name  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Students </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> department_id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> id </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> Departments</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1355-活动参与者\"><a class=\"anchor\" href=\"#1355-活动参与者\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWN0aXZpdHktcGFydGljaXBhbnRzLw==\">1355. 活动参与者</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Friends</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n| activity      | varchar |\n+---------------+---------+\nid 是朋友的 id 和该表的主键\nname 是朋友的名字\nactivity 是朋友参加的活动的名字\n</code></pre>\n<p>表:  <code>Activities</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n+---------------+---------+\nid 是该表的主键\nname 是活动的名字\n</code></pre>\n<p>写一条 SQL 查询那些既没有最多，也没有最少参与者的活动的名字</p>\n<p>可以以任何顺序返回结果，Activities 表的每项活动的参与者都来自 Friends 表</p>\n<p>下面是查询结果格式的例子：</p>\n<pre><code>Friends 表:\n+------+--------------+---------------+\n| id   | name         | activity      |\n+------+--------------+---------------+\n| 1    | Jonathan D.  | Eating        |\n| 2    | Jade W.      | Singing       |\n| 3    | Victor J.    | Singing       |\n| 4    | Elvis Q.     | Eating        |\n| 5    | Daniel A.    | Eating        |\n| 6    | Bob B.       | Horse Riding  |\n+------+--------------+---------------+\n\nActivities 表:\n+------+--------------+\n| id   | name         |\n+------+--------------+\n| 1    | Eating       |\n| 2    | Singing      |\n| 3    | Horse Riding |\n+------+--------------+\n\nResult 表:\n+--------------+\n| activity     |\n+--------------+\n| Singing      |\n+--------------+\n\nEating 活动有三个人参加, 是最多人参加的活动 (Jonathan D. , Elvis Q. and Daniel A.)\nHorse Riding 活动有一个人参加, 是最少人参加的活动 (Bob B.)\nSinging 活动有两个人参加 (Victor J. and Jade W.)\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> activity</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">select</span> activity<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> cnt<span class=\"token punctuation\">)</span> rk1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> cnt <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">select</span>  activity  <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">from</span>  Friends</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span>  activity </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">where</span> rk1 <span class=\"token operator\">!=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> rk2 <span class=\"token operator\">!=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><blockquote>\n<p>不需要关联 Activities 表，因为 至少有一人参加</p>\n</blockquote>\n<h4 id=\"1364-顾客的可信联系人数量\"><a class=\"anchor\" href=\"#1364-顾客的可信联系人数量\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbnVtYmVyLW9mLXRydXN0ZWQtY29udGFjdHMtb2YtYS1jdXN0b21lci8=\">1364. 顾客的可信联系人数量</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>顾客表： <code>Customers</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| customer_id   | int     |\n| customer_name | varchar |\n| email         | varchar |\n+---------------+---------+\ncustomer_id 是这张表的主键。\n此表的每一行包含了某在线商店顾客的姓名和电子邮件。\n</code></pre>\n<p>联系方式表： <code>Contacts</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | id      |\n| contact_name  | varchar |\n| contact_email | varchar |\n+---------------+---------+\n(user_id, contact_email) 是这张表的主键。\n此表的每一行表示编号为 user_id 的顾客的某位联系人的姓名和电子邮件。\n此表包含每位顾客的联系人信息，但顾客的联系人不一定存在于顾客表中。\n</code></pre>\n<p>发票表： <code>Invoices</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| invoice_id   | int     |\n| price        | int     |\n| user_id      | int     |\n+--------------+---------+\ninvoice_id 是这张表的主键。\n此表的每一行分别表示编号为 user_id 的顾客拥有有一张编号为 invoice_id、价格为 price 的发票。\n</code></pre>\n<p>为每张发票  <code>invoice_id</code>  编写一个 SQL 查询以查找以下内容：</p>\n<ul>\n<li><code>customer_name</code> ：与发票相关的顾客名称。</li>\n<li><code>price</code> ：发票的价格。</li>\n<li><code>contacts_cnt</code> ：该顾客的联系人数量。</li>\n<li><code>trusted_contacts_cnt</code> ：可信联系人的数量：既是该顾客的联系人又是商店顾客的联系人数量（即：可信联系人的电子邮件存在于客户表中）。</li>\n</ul>\n<p>将查询的结果按照  <code>invoice_id</code>  排序。</p>\n<p>查询结果的格式如下例所示：</p>\n<pre><code>Customers table:\n+-------------+---------------+--------------------+\n| customer_id | customer_name | email              |\n+-------------+---------------+--------------------+\n| 1           | Alice         | alice@leetcode.com |\n| 2           | Bob           | bob@leetcode.com   |\n| 13          | John          | john@leetcode.com  |\n| 6           | Alex          | alex@leetcode.com  |\n+-------------+---------------+--------------------+\nContacts table:\n+-------------+--------------+--------------------+\n| user_id     | contact_name | contact_email      |\n+-------------+--------------+--------------------+\n| 1           | Bob          | bob@leetcode.com   |\n| 1           | John         | john@leetcode.com  |\n| 1           | Jal          | jal@leetcode.com   |\n| 2           | Omar         | omar@leetcode.com  |\n| 2           | Meir         | meir@leetcode.com  |\n| 6           | Alice        | alice@leetcode.com |\n+-------------+--------------+--------------------+\nInvoices table:\n+------------+-------+---------+\n| invoice_id | price | user_id |\n+------------+-------+---------+\n| 77         | 100   | 1       |\n| 88         | 200   | 1       |\n| 99         | 300   | 2       |\n| 66         | 400   | 2       |\n| 55         | 500   | 13      |\n| 44         | 60    | 6       |\n+------------+-------+---------+\nResult table:\n+------------+---------------+-------+--------------+----------------------+\n| invoice_id | customer_name | price | contacts_cnt | trusted_contacts_cnt |\n+------------+---------------+-------+--------------+----------------------+\n| 44         | Alex          | 60    | 1            | 1                    |\n| 55         | John          | 500   | 0            | 0                    |\n| 66         | Bob           | 400   | 2            | 0                    |\n| 77         | Alice         | 100   | 3            | 2                    |\n| 88         | Alice         | 200   | 3            | 2                    |\n| 99         | Bob           | 300   | 2            | 0                    |\n+------------+---------------+-------+--------------+----------------------+\nAlice 有三位联系人，其中两位(Bob 和 John)是可信联系人。\nBob 有两位联系人, 他们中的任何一位都不是可信联系人。\nAlex 只有一位联系人(Alice)，并是一位可信联系人。\nJohn 没有任何联系人。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> invoice_id <span class=\"token punctuation\">,</span>customer_name<span class=\"token punctuation\">,</span>price<span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>cnt<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> contacts_cnt<span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>bc<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> trusted_contacts_cnt </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Invoices i</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> user_id <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Contacts</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> user_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span> t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">on</span> i<span class=\"token punctuation\">.</span>user_id<span class=\"token operator\">=</span>t1<span class=\"token punctuation\">.</span>user_id</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">select</span>  user_id <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> bc</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">from</span> Contacts</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">where</span> contact_name <span class=\"token operator\">in</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">select</span> customer_name</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">from</span> Customers</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> user_id </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">on</span> i<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>user_id</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Customers c</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">on</span> i<span class=\"token punctuation\">.</span>user_id<span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>customer_id</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> invoice_id</pre></td></tr></table></figure><blockquote>\n<p>就是麻烦点 各种 join</p>\n</blockquote>\n<h4 id=\"1369-获取最近第二次的活动\"><a class=\"anchor\" href=\"#1369-获取最近第二次的活动\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2V0LXRoZS1zZWNvbmQtbW9zdC1yZWNlbnQtYWN0aXZpdHkv\">1369. 获取最近第二次的活动</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>表:  <code>UserActivity</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| username      | varchar |\n| activity      | varchar |\n| startDate     | Date    |\n| endDate       | Date    |\n+---------------+---------+\n该表不包含主键\n该表包含每个用户在一段时间内进行的活动的信息\n名为 username 的用户在 startDate 到 endDate 日内有一次活动\n</code></pre>\n<p>写一条 SQL 查询展示每一位用户 <strong>最近第二次</strong> 的活动</p>\n<p>如果用户仅有一次活动，返回该活动</p>\n<p>一个用户不能同时进行超过一项活动，以 <strong>任意</strong> 顺序返回结果</p>\n<p>下面是查询结果格式的例子：</p>\n<pre><code>UserActivity 表:\n+------------+--------------+-------------+-------------+\n| username   | activity     | startDate   | endDate     |\n+------------+--------------+-------------+-------------+\n| Alice      | Travel       | 2020-02-12  | 2020-02-20  |\n| Alice      | Dancing      | 2020-02-21  | 2020-02-23  |\n| Alice      | Travel       | 2020-02-24  | 2020-02-28  |\n| Bob        | Travel       | 2020-02-11  | 2020-02-18  |\n+------------+--------------+-------------+-------------+\n\nResult 表:\n+------------+--------------+-------------+-------------+\n| username   | activity     | startDate   | endDate     |\n+------------+--------------+-------------+-------------+\n| Alice      | Dancing      | 2020-02-21  | 2020-02-23  |\n| Bob        | Travel       | 2020-02-11  | 2020-02-18  |\n+------------+--------------+-------------+-------------+\n\nAlice 最近第二次的活动是从 2020-02-24 到 2020-02-28 的旅行, 在此之前的 2020-02-21 到 2020-02-23 她进行了舞蹈\nBob 只有一条记录，我们就取这条记录\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> username<span class=\"token punctuation\">,</span> activity <span class=\"token punctuation\">,</span>startDate<span class=\"token punctuation\">,</span>endDate </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> username<span class=\"token punctuation\">,</span> activity <span class=\"token punctuation\">,</span>startDate<span class=\"token punctuation\">,</span>endDate <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> username <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> startDate <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    lag<span class=\"token punctuation\">(</span> startDate <span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> username <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> startDate <span class=\"token punctuation\">)</span> lg</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> UserActivity</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span> rk<span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token operator\">or</span>  <span class=\"token punctuation\">(</span>rk <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span>  lg <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1378-使用唯一标识码替换员工id\"><a class=\"anchor\" href=\"#1378-使用唯一标识码替换员工id\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVwbGFjZS1lbXBsb3llZS1pZC13aXRoLXRoZS11bmlxdWUtaWRlbnRpZmllci8=\">1378. 使用唯一标识码替换员工 ID</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p><code>Employees</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n+---------------+---------+\nid 是这张表的主键。\n这张表的每一行分别代表了某公司其中一位员工的名字和 ID 。\n</code></pre>\n<p><code>EmployeeUNI</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| unique_id     | int     |\n+---------------+---------+\n(id, unique_id) 是这张表的主键。\n这张表的每一行包含了该公司某位员工的 ID 和他的唯一标识码（unique ID）。\n</code></pre>\n<p>写一段 SQL 查询来展示每位用户的 <strong>唯一标识码（unique ID ）</strong>；如果某位员工没有唯一标识码，使用 null 填充即可。</p>\n<p>你可以以 <strong>任意</strong> 顺序返回结果表。</p>\n<p>查询结果的格式如下例所示：</p>\n<pre><code>Employees table:\n+----+----------+\n| id | name     |\n+----+----------+\n| 1  | Alice    |\n| 7  | Bob      |\n| 11 | Meir     |\n| 90 | Winston  |\n| 3  | Jonathan |\n+----+----------+\n\nEmployeeUNI table:\n+----+-----------+\n| id | unique_id |\n+----+-----------+\n| 3  | 1         |\n| 11 | 2         |\n| 90 | 3         |\n+----+-----------+\n\nEmployeeUNI table:\n+-----------+----------+\n| unique_id | name     |\n+-----------+----------+\n| null      | Alice    |\n| null      | Bob      |\n| 2         | Meir     |\n| 3         | Winston  |\n| 1         | Jonathan |\n+-----------+----------+\n\nAlice and Bob 没有唯一标识码, 因此我们使用 null 替代。\nMeir 的唯一标识码是 2 。\nWinston 的唯一标识码是 3 。\nJonathan 唯一标识码是 1 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> unique_id<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Employees  e <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> EmployeeUNI u</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> e<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> u<span class=\"token punctuation\">.</span>id</pre></td></tr></table></figure><h4 id=\"1384-按年度列出销售总额\"><a class=\"anchor\" href=\"#1384-按年度列出销售总额\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdG90YWwtc2FsZXMtYW1vdW50LWJ5LXllYXIv\">1384. 按年度列出销售总额</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Product</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| product_name  | varchar |\n+---------------+---------+\nproduct_id 是这张表的主键。\nproduct_name 是产品的名称。\n</code></pre>\n<p><code>Sales</code>  表：</p>\n<pre><code>+---------------------+---------+\n| Column Name         | Type    |\n+---------------------+---------+\n| product_id          | int     |\n| period_start        | varchar |\n| period_end          | date    |\n| average_daily_sales | int     |\n+---------------------+---------+\nproduct_id 是这张表的主键。\nperiod_start 和 period_end 是该产品销售期的起始日期和结束日期，且这两个日期包含在销售期内。\naverage_daily_sales 列存储销售期内该产品的日平均销售额。\n</code></pre>\n<p>编写一段 SQL 查询每个产品每年的总销售额，并包含 product_id, product_name 以及 report_year 等信息。</p>\n<p>销售年份的日期介于 2018 年到 2020 年之间。你返回的结果需要按 product_id 和 report_year <strong>排序</strong>。</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Product table:\n+------------+--------------+\n| product_id | product_name |\n+------------+--------------+\n| 1          | LC Phone     |\n| 2          | LC T-Shirt   |\n| 3          | LC Keychain  |\n+------------+--------------+\n\nSales table:\n+------------+--------------+-------------+---------------------+\n| product_id | period_start | period_end  | average_daily_sales |\n+------------+--------------+-------------+---------------------+\n| 1          | 2019-01-25   | 2019-02-28  | 100                 |\n| 2          | 2018-12-01   | 2020-01-01  | 10                  |\n| 3          | 2019-12-01   | 2020-01-31  | 1                   |\n+------------+--------------+-------------+---------------------+\n\nResult table:\n+------------+--------------+-------------+--------------+\n| product_id | product_name | report_year | total_amount |\n+------------+--------------+-------------+--------------+\n| 1          | LC Phone     |    2019     | 3500         |\n| 2          | LC T-Shirt   |    2018     | 310          |\n| 2          | LC T-Shirt   |    2019     | 3650         |\n| 2          | LC T-Shirt   |    2020     | 10           |\n| 3          | LC Keychain  |    2019     | 31           |\n| 3          | LC Keychain  |    2020     | 31           |\n+------------+--------------+-------------+--------------+\nLC Phone 在 2019-01-25 至 2019-02-28 期间销售，该产品销售时间总计35天。销售总额 35*100 = 3500。\nLC T-shirt 在 2018-12-01 至 2020-01-01 期间销售，该产品在2018年、2019年、2020年的销售时间分别是31天、365天、1天，2018年、2019年、2020年的销售总额分别是31*10=310、365*10=3650、1*10=10。\nLC Keychain 在 2019-12-01 至 2020-01-31 期间销售，该产品在2019年、2020年的销售时间分别是：31天、31天，2019年、2020年的销售总额分别是31*1=31、31*1=31。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">select</span> Sales<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span> product_name<span class=\"token punctuation\">,</span> <span class=\"token string\">'2018'</span> <span class=\"token keyword\">as</span> <span class=\"token string\">'report_year'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_start<span class=\"token operator\">&lt;</span><span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>datediff<span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_end<span class=\"token operator\">&lt;</span><span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">,</span> period_end<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2018-12-31'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_start<span class=\"token operator\">>=</span><span class=\"token string\">'2018-01-01'</span><span class=\"token punctuation\">,</span> period_start<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2018-01-01'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>average_daily_sales<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total_amount</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> Sales  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">join</span> Product <span class=\"token keyword\">on</span> Sales<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> Product<span class=\"token punctuation\">.</span>product_id </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span>  total_amount<span class=\"token operator\">></span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">union</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">select</span> Sales<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span> product_name<span class=\"token punctuation\">,</span> <span class=\"token string\">'2019'</span> <span class=\"token keyword\">as</span> <span class=\"token string\">'report_year'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> period_start<span class=\"token operator\">&lt;</span><span class=\"token string\">'2020-01-01'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>datediff<span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_end<span class=\"token operator\">&lt;</span><span class=\"token string\">'2020-01-01'</span><span class=\"token punctuation\">,</span> period_end<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2019-12-31'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_start<span class=\"token operator\">>=</span><span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">,</span> period_start<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>average_daily_sales <span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total_amount</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">from</span> Sales  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">join</span> Product <span class=\"token keyword\">on</span> <span class=\"token punctuation\">(</span>Sales<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> Product<span class=\"token punctuation\">.</span>product_id <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">having</span>  total_amount<span class=\"token operator\">></span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">union</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">select</span> Sales<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span> product_name<span class=\"token punctuation\">,</span> <span class=\"token string\">'2020'</span> <span class=\"token keyword\">as</span> <span class=\"token string\">'report_year'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>datediff<span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_end<span class=\"token operator\">&lt;</span><span class=\"token string\">'2021-01-01'</span><span class=\"token punctuation\">,</span> period_end<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2020-12-31'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_start<span class=\"token operator\">>=</span><span class=\"token string\">'2020-01-01'</span><span class=\"token punctuation\">,</span> period_start<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2020-01-01'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>average_daily_sales <span class=\"token keyword\">as</span> total_amount</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">from</span> Sales  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">join</span> Product  <span class=\"token keyword\">on</span> <span class=\"token punctuation\">(</span>Sales<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> Product<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">having</span> total_amount<span class=\"token operator\">></span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> product_id<span class=\"token punctuation\">,</span> report_year</pre></td></tr></table></figure><blockquote>\n<p>各个年份进行 union, 就是年份判断的时候麻烦些</p>\n</blockquote>\n<h4 id=\"1393-股票的资本损益\"><a class=\"anchor\" href=\"#1393-股票的资本损益\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY2FwaXRhbC1nYWlubG9zcy8=\">1393. 股票的资本损益</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Stocks</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| stock_name    | varchar |\n| operation     | enum    |\n| operation_day | int     |\n| price         | int     |\n+---------------+---------+\n(stock_name, day) 是这张表的主键\noperation 列使用的是一种枚举类型，包括：('Sell','Buy')\n此表的每一行代表了名为 stock_name 的某支股票在 operation_day 这一天的操作价格。\n保证股票的每次'Sell'操作前，都有相应的'Buy'操作。\n</code></pre>\n<p>编写一个 SQL 查询来报告每支股票的资本损益。</p>\n<p>股票的资本损益是一次或多次买卖股票后的全部收益或损失。</p>\n<p>以任意顺序返回结果即可。</p>\n<p>SQL 查询结果的格式如下例所示：</p>\n<pre><code>Stocks 表:\n+---------------+-----------+---------------+--------+\n| stock_name    | operation | operation_day | price  |\n+---------------+-----------+---------------+--------+\n| Leetcode      | Buy       | 1             | 1000   |\n| Corona Masks  | Buy       | 2             | 10     |\n| Leetcode      | Sell      | 5             | 9000   |\n| Handbags      | Buy       | 17            | 30000  |\n| Corona Masks  | Sell      | 3             | 1010   |\n| Corona Masks  | Buy       | 4             | 1000   |\n| Corona Masks  | Sell      | 5             | 500    |\n| Corona Masks  | Buy       | 6             | 1000   |\n| Handbags      | Sell      | 29            | 7000   |\n| Corona Masks  | Sell      | 10            | 10000  |\n+---------------+-----------+---------------+--------+\n\nResult 表:\n+---------------+-------------------+\n| stock_name    | capital_gain_loss |\n+---------------+-------------------+\n| Corona Masks  | 9500              |\n| Leetcode      | 8000              |\n| Handbags      | -23000            |\n+---------------+-------------------+\nLeetcode 股票在第一天以1000美元的价格买入，在第五天以9000美元的价格卖出。资本收益=9000-1000=8000美元。\nHandbags 股票在第17天以30000美元的价格买入，在第29天以7000美元的价格卖出。资本损失=7000-30000=-23000美元。\nCorona Masks 股票在第1天以10美元的价格买入，在第3天以1010美元的价格卖出。在第4天以1000美元的价格再次购买，在第5天以500美元的价格出售。最后，它在第6天以1000美元的价格被买走，在第10天以10000美元的价格被卖掉。资本损益是每次（’Buy'-&gt;'Sell'）操作资本收益或损失的和=（1010-10）+（500-1000）+（10000-1000）=1000-500+9000=9500美元。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> stock_name<span class=\"token punctuation\">,</span>sell<span class=\"token operator\">-</span>buy capital_gain_loss</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> stock_name <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>       <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>operation<span class=\"token operator\">=</span><span class=\"token string\">'Buy'</span><span class=\"token punctuation\">,</span> price<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> stock_name <span class=\"token punctuation\">)</span> buy<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>       <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>operation<span class=\"token operator\">=</span><span class=\"token string\">'Sell'</span><span class=\"token punctuation\">,</span>price<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> stock_name<span class=\"token punctuation\">)</span> sell</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Stocks s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> stock_name<span class=\"token punctuation\">,</span>buy<span class=\"token punctuation\">,</span>sell</pre></td></tr></table></figure><h4 id=\"1398-购买了产品a和产品b却没有购买产品c的顾客\"><a class=\"anchor\" href=\"#1398-购买了产品a和产品b却没有购买产品c的顾客\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3VzdG9tZXJzLXdoby1ib3VnaHQtcHJvZHVjdHMtYS1hbmQtYi1idXQtbm90LWMv\">1398. 购买了产品 A 和产品 B 却没有购买产品 C 的顾客</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Customers</code>  表：</p>\n<pre><code>+---------------------+---------+\n| Column Name         | Type    |\n+---------------------+---------+\n| customer_id         | int     |\n| customer_name       | varchar |\n+---------------------+---------+\ncustomer_id 是这张表的主键。\ncustomer_name 是顾客的名称。\n</code></pre>\n<p><code>Orders</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| customer_id   | int     |\n| product_name  | varchar |\n+---------------+---------+\norder_id 是这张表的主键。\ncustomer_id 是购买了名为 &quot;product_name&quot; 产品顾客的id。\n</code></pre>\n<p>请你设计 SQL 查询来报告购买了产品 A 和产品 B 却没有购买产品 C 的顾客的 ID 和姓名（  <code>customer_id</code>  和  <code>customer_name</code>  ），我们将基于此结果为他们推荐产品 C 。<br />\n您返回的查询结果需要按照  <code>customer_id</code>  <strong>排序</strong>。</p>\n<p>查询结果如下例所示。</p>\n<pre><code>Customers table:\n+-------------+---------------+\n| customer_id | customer_name |\n+-------------+---------------+\n| 1           | Daniel        |\n| 2           | Diana         |\n| 3           | Elizabeth     |\n| 4           | Jhon          |\n+-------------+---------------+\n\nOrders table:\n+------------+--------------+---------------+\n| order_id   | customer_id  | product_name  |\n+------------+--------------+---------------+\n| 10         |     1        |     A         |\n| 20         |     1        |     B         |\n| 30         |     1        |     D         |\n| 40         |     1        |     C         |\n| 50         |     2        |     A         |\n| 60         |     3        |     A         |\n| 70         |     3        |     B         |\n| 80         |     3        |     D         |\n| 90         |     4        |     C         |\n+------------+--------------+---------------+\n\nResult table:\n+-------------+---------------+\n| customer_id | customer_name |\n+-------------+---------------+\n| 3           | Elizabeth     |\n+-------------+---------------+\n只有 customer_id 为 3 的顾客购买了产品 A 和产品 B ，却没有购买产品 C 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  o<span class=\"token punctuation\">.</span>customer_id<span class=\"token punctuation\">,</span> customer_name </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Orders o <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span>  Customers c</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> o<span class=\"token punctuation\">.</span>customer_id<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span>customer_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>product_name <span class=\"token operator\">=</span><span class=\"token string\">'A'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'B'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'C'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><h4 id=\"1407-排名靠前的旅行者\"><a class=\"anchor\" href=\"#1407-排名靠前的旅行者\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdG9wLXRyYXZlbGxlcnMv\">1407. 排名靠前的旅行者</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表单:  <code>Users</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n+---------------+---------+\nid 是该表单主键.\nname 是用户名字.\n</code></pre>\n<p>表单:  <code>Rides</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| user_id       | int     |\n| distance      | int     |\n+---------------+---------+\nid 是该表单主键.\nuser_id 是本次行程的用户的 id, 而该用户此次行程距离为 distance.\n</code></pre>\n<p>写一段 SQL , 报告每个用户的旅行距离.</p>\n<p>返回的结果表单，以  <code>travelled_distance</code>  降序排列，如果有两个或者更多的用户旅行了相同的距离，那么再以  <code>name</code>  升序排列.</p>\n<p>查询结果格式，如下例所示.</p>\n<pre><code>Users 表单:\n+------+-----------+\n| id   | name      |\n+------+-----------+\n| 1    | Alice     |\n| 2    | Bob       |\n| 3    | Alex      |\n| 4    | Donald    |\n| 7    | Lee       |\n| 13   | Jonathan  |\n| 19   | Elvis     |\n+------+-----------+\n\nRides 表单:\n+------+----------+----------+\n| id   | user_id  | distance |\n+------+----------+----------+\n| 1    | 1        | 120      |\n| 2    | 2        | 317      |\n| 3    | 3        | 222      |\n| 4    | 7        | 100      |\n| 5    | 13       | 312      |\n| 6    | 19       | 50       |\n| 7    | 7        | 120      |\n| 8    | 19       | 400      |\n| 9    | 7        | 230      |\n+------+----------+----------+\n\nResult 表单:\n+----------+--------------------+\n| name     | travelled_distance |\n+----------+--------------------+\n| Elvis    | 450                |\n| Lee      | 450                |\n| Bob      | 317                |\n| Jonathan | 312                |\n| Alex     | 222                |\n| Alice    | 120                |\n| Donald   | 0                  |\n+----------+--------------------+\nElvis 和 Lee 旅行了 450 英里, Elvis 是排名靠前的旅行者, 因为他的名字在字母表上的排序比 Lee 更小.\nBob, Jonathan, Alex 和 Alice 只有一次行程, 我们只按此次行程的全部距离对他们排序.\nDonald 没有任何行程, 他的旅行距离为 0.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>ifnull<span class=\"token punctuation\">(</span>distance<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> travelled_distance </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Users u <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Rides r</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> u<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span>user_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> name</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> travelled_distance  <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span> name</pre></td></tr></table></figure><h4 id=\"1412-查找成绩处于中游的学生\"><a class=\"anchor\" href=\"#1412-查找成绩处于中游的学生\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC10aGUtcXVpZXQtc3R1ZGVudHMtaW4tYWxsLWV4YW1zLw==\">1412. 查找成绩处于中游的学生</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>表:  <code>Student</code></p>\n<pre><code>+---------------------+---------+\n| Column Name         | Type    |\n+---------------------+---------+\n| student_id          | int     |\n| student_name        | varchar |\n+---------------------+---------+\nstudent_id 是该表主键.\nstudent_name 学生名字.\n</code></pre>\n<p>表:  <code>Exam</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| exam_id       | int     |\n| student_id    | int     |\n| score         | int     |\n+---------------+---------+\n(exam_id, student_id) 是该表主键.\n学生 student_id 在测验 exam_id 中得分为 score.\n</code></pre>\n<p>成绩处于中游的学生是指至少参加了一次测验，且得分既不是最高分也不是最低分的学生。</p>\n<p>写一个 SQL 语句，找出在所有测验中都处于中游的学生  <code>(student_id, student_name)</code> 。</p>\n<p>不要返回从来没有参加过测验的学生。返回结果表按照  <code>student_id</code>  排序。</p>\n<p>查询结果格式如下。</p>\n<pre><code>Student 表：\n+-------------+---------------+\n| student_id  | student_name  |\n+-------------+---------------+\n| 1           | Daniel        |\n| 2           | Jade          |\n| 3           | Stella        |\n| 4           | Jonathan      |\n| 5           | Will          |\n+-------------+---------------+\n\nExam 表：\n+------------+--------------+-----------+\n| exam_id    | student_id   | score     |\n+------------+--------------+-----------+\n| 10         |     1        |    70     |\n| 10         |     2        |    80     |\n| 10         |     3        |    90     |\n| 20         |     1        |    80     |\n| 30         |     1        |    70     |\n| 30         |     3        |    80     |\n| 30         |     4        |    90     |\n| 40         |     1        |    60     |\n| 40         |     2        |    70     |\n| 40         |     4        |    80     |\n+------------+--------------+-----------+\n\nResult 表：\n+-------------+---------------+\n| student_id  | student_name  |\n+-------------+---------------+\n| 2           | Jade          |\n+-------------+---------------+\n\n对于测验 1: 学生 1 和 3 分别获得了最低分和最高分。\n对于测验 2: 学生 1 既获得了最高分, 也获得了最低分。\n对于测验 3 和 4: 学生 1 和 4 分别获得了最低分和最高分。\n学生 2 和 5 没有在任一场测验中获得了最高分或者最低分。\n因为学生 5 从来没有参加过任何测验, 所以他被排除于结果表。\n由此, 我们仅仅返回学生 2 的信息。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> e<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span>student_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Exam e <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Student s</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> e<span class=\"token punctuation\">.</span>student_id<span class=\"token operator\">=</span>s<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span> e<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> student_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> exam_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> score <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rkmax<span class=\"token punctuation\">,</span> rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> exam_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> score <span class=\"token punctuation\">)</span> rkmin</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">from</span> Exam </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">where</span> rkmax <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">or</span> rkmin <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> e<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span>student_name</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> e<span class=\"token punctuation\">.</span>student_id</pre></td></tr></table></figure><h4 id=\"1421-净现值查询\"><a class=\"anchor\" href=\"#1421-净现值查询\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbnB2LXF1ZXJpZXMv\">1421. 净现值查询</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>NPV</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| year          | int     |\n| npv           | int     |\n+---------------+---------+\n(id, year) 是该表主键.\n该表有每一笔存货的年份, id 和对应净现值的信息.\n</code></pre>\n<p>表:  <code>Queries</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| year          | int     |\n+---------------+---------+\n(id, year) 是该表主键.\n该表有每一次查询所对应存货的 id 和年份的信息.\n</code></pre>\n<p>写一个 SQL, 找到 Queries 表中每一次查询的净现值.</p>\n<p>结果表没有顺序要求.</p>\n<p>查询结果的格式如下所示:</p>\n<pre><code>NPV 表:\n+------+--------+--------+\n| id   | year   | npv    |\n+------+--------+--------+\n| 1    | 2018   | 100    |\n| 7    | 2020   | 30     |\n| 13   | 2019   | 40     |\n| 1    | 2019   | 113    |\n| 2    | 2008   | 121    |\n| 3    | 2009   | 12     |\n| 11   | 2020   | 99     |\n| 7    | 2019   | 0      |\n+------+--------+--------+\n\nQueries 表:\n+------+--------+\n| id   | year   |\n+------+--------+\n| 1    | 2019   |\n| 2    | 2008   |\n| 3    | 2009   |\n| 7    | 2018   |\n| 7    | 2019   |\n| 7    | 2020   |\n| 13   | 2019   |\n+------+--------+\n\n结果表:\n+------+--------+--------+\n| id   | year   | npv    |\n+------+--------+--------+\n| 1    | 2019   | 113    |\n| 2    | 2008   | 121    |\n| 3    | 2009   | 12     |\n| 7    | 2018   | 0      |\n| 7    | 2019   | 0      |\n| 7    | 2020   | 30     |\n| 13   | 2019   | 40     |\n+------+--------+--------+\n\n(7, 2018)的净现值不在 NPV 表中, 我们把它看作是 0.\n所有其它查询的净现值都能在 NPV 表中找到.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> q<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>q<span class=\"token punctuation\">.</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>npv<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> npv</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Queries q <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> NPV n</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> q<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> n<span class=\"token punctuation\">.</span>id <span class=\"token operator\">and</span> q<span class=\"token punctuation\">.</span><span class=\"token keyword\">year</span> <span class=\"token operator\">=</span> n<span class=\"token punctuation\">.</span><span class=\"token keyword\">year</span></pre></td></tr></table></figure><blockquote>\n<p>npv 净现值概念 了解下</p>\n</blockquote>\n<h4 id=\"1435-制作会话柱状图\"><a class=\"anchor\" href=\"#1435-制作会话柱状图\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3JlYXRlLWEtc2Vzc2lvbi1iYXItY2hhcnQv\">1435. 制作会话柱状图</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表： <code>Sessions</code></p>\n<pre><code>+---------------------+---------+\n| Column Name         | Type    |\n+---------------------+---------+\n| session_id          | int     |\n| duration            | int     |\n+---------------------+---------+\nsession_id 是该表主键\nduration 是用户访问应用的时间, 以秒为单位\n</code></pre>\n<p>你想知道用户在你的 app 上的访问时长情况。因此决定统计访问时长区间分别为 &quot;[0-5&gt;&quot;, &quot;[5-10&gt;&quot;, &quot;[10-15&gt;&quot; 和 &quot;15 or more&quot; （单位：分钟）的会话数量，并以此绘制柱状图。</p>\n<p>写一个 SQL 查询来报告（访问时长区间，会话总数）。结果可用任何顺序呈现。</p>\n<p><strong>下方为查询的输出格式：</strong></p>\n<pre><code>Sessions 表：\n+-------------+---------------+\n| session_id  | duration      |\n+-------------+---------------+\n| 1           | 30            |\n| 2           | 199           |\n| 3           | 299           |\n| 4           | 580           |\n| 5           | 1000          |\n+-------------+---------------+\n\nResult 表：\n+--------------+--------------+\n| bin          | total        |\n+--------------+--------------+\n| [0-5&gt;        | 3            |\n| [5-10&gt;       | 1            |\n| [10-15&gt;      | 0            |\n| 15 or more   | 1            |\n+--------------+--------------+\n\n对于 session_id 1，2 和 3 ，它们的访问时间大于等于 0 分钟且小于 5 分钟。\n对于 session_id 4，它的访问时间大于等于 5 分钟且小于 10 分钟。\n没有会话的访问时间大于等于 10 分钟且小于 15 分钟。\n对于 session_id 5, 它的访问时间大于等于 15 分钟。\n</code></pre>\n<p>Union</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token string\">'[0-5>'</span> <span class=\"token keyword\">as</span> bin<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total <span class=\"token keyword\">from</span> Sessions <span class=\"token keyword\">where</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">>=</span><span class=\"token number\">0</span> <span class=\"token operator\">and</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">&lt;</span><span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token string\">'[5-10>'</span> <span class=\"token keyword\">as</span> bin<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total <span class=\"token keyword\">from</span> Sessions <span class=\"token keyword\">where</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">>=</span><span class=\"token number\">5</span> <span class=\"token operator\">and</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">&lt;</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token string\">'[10-15>'</span> <span class=\"token keyword\">as</span> bin<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total <span class=\"token keyword\">from</span> Sessions <span class=\"token keyword\">where</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">>=</span><span class=\"token number\">10</span> <span class=\"token operator\">and</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">&lt;</span><span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token string\">'15 or more'</span><span class=\"token keyword\">as</span> bin<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total <span class=\"token keyword\">from</span> Sessions <span class=\"token keyword\">where</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">>=</span><span class=\"token number\">15</span></pre></td></tr></table></figure><p>还有很多其他解法</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>bin<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>bin<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token string\">'[0-5>'</span> <span class=\"token keyword\">as</span> bin <span class=\"token keyword\">union</span> <span class=\"token keyword\">select</span> <span class=\"token string\">'[5-10>'</span> <span class=\"token keyword\">as</span> bin <span class=\"token keyword\">union</span> <span class=\"token keyword\">select</span> <span class=\"token string\">'[10-15>'</span> <span class=\"token keyword\">as</span> bin <span class=\"token keyword\">union</span> <span class=\"token keyword\">select</span> <span class=\"token string\">'15 or more'</span> <span class=\"token keyword\">as</span> bin </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span>a</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token keyword\">case</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">when</span> duration <span class=\"token operator\">&lt;</span> <span class=\"token number\">300</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'[0-5>'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">when</span> duration <span class=\"token operator\">>=</span> <span class=\"token number\">300</span> <span class=\"token operator\">and</span> duration <span class=\"token operator\">&lt;</span> <span class=\"token number\">600</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'[5-10>'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">when</span> duration <span class=\"token operator\">>=</span> <span class=\"token number\">600</span> <span class=\"token operator\">and</span> duration <span class=\"token operator\">&lt;</span> <span class=\"token number\">900</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'[10-15>'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">else</span> <span class=\"token string\">'15 or more'</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">end</span> bin</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">from</span> Sessions </pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">)</span>b</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>bin <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>bin</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> a<span class=\"token punctuation\">.</span>bin</pre></td></tr></table></figure><h4 id=\"1440-计算布尔表达式的值\"><a class=\"anchor\" href=\"#1440-计算布尔表达式的值\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZXZhbHVhdGUtYm9vbGVhbi1leHByZXNzaW9uLw==\">1440. 计算布尔表达式的值</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表  <code>Variables</code> :</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| name          | varchar |\n| value         | int     |\n+---------------+---------+\nname 是该表主键.\n该表包含了存储的变量及其对应的值.\n</code></pre>\n<p>表  <code>Expressions</code> :</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| left_operand  | varchar |\n| operator      | enum    |\n| right_operand | varchar |\n+---------------+---------+\n(left_operand, operator, right_operand) 是该表主键.\n该表包含了需要计算的布尔表达式.\noperator 是枚举类型, 取值于('&lt;', '&gt;', '=')\nleft_operand 和 right_operand 的值保证存在于 Variables 表单中.\n</code></pre>\n<p>写一个 SQL 查询，以计算表  <code>Expressions</code>  中的布尔表达式.</p>\n<p>返回的结果表没有顺序要求.</p>\n<p>查询结果格式如下例所示.</p>\n<pre><code>Variables 表:\n+------+-------+\n| name | value |\n+------+-------+\n| x    | 66    |\n| y    | 77    |\n+------+-------+\n\nExpressions 表:\n+--------------+----------+---------------+\n| left_operand | operator | right_operand |\n+--------------+----------+---------------+\n| x            | &gt;        | y             |\n| x            | &lt;        | y             |\n| x            | =        | y             |\n| y            | &gt;        | x             |\n| y            | &lt;        | x             |\n| x            | =        | x             |\n+--------------+----------+---------------+\n\nResult 表:\n+--------------+----------+---------------+-------+\n| left_operand | operator | right_operand | value |\n+--------------+----------+---------------+-------+\n| x            | &gt;        | y             | false |\n| x            | &lt;        | y             | true  |\n| x            | =        | y             | false |\n| y            | &gt;        | x             | true  |\n| y            | &lt;        | x             | false |\n| x            | =        | x             | true  |\n+--------------+----------+---------------+-------+\n如上所示, 你需要通过使用 Variables 表来找到 Expressions 表中的每一个布尔表达式的值.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> e<span class=\"token punctuation\">.</span>left_operand<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>operator<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>right_operand<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">case</span> e<span class=\"token punctuation\">.</span>operator</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">when</span> <span class=\"token string\">'>'</span> <span class=\"token keyword\">then</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token operator\">></span>v2<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span><span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'false'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">when</span> <span class=\"token string\">'&lt;'</span> <span class=\"token keyword\">then</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token operator\">&lt;</span>v2<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span><span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'false'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">else</span>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token operator\">=</span>v2<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span><span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'false'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">end</span> <span class=\"token keyword\">value</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> Expressions e</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Variables v1 <span class=\"token keyword\">on</span> v1<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>left_operand </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Variables v2 <span class=\"token keyword\">on</span> v2<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>right_operand</pre></td></tr></table></figure><h4 id=\"1445-苹果和桔子\"><a class=\"anchor\" href=\"#1445-苹果和桔子\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYXBwbGVzLW9yYW5nZXMv\">1445. 苹果和桔子</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Sales</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| sale_date     | date    |\n| fruit         | enum    | \n| sold_num      | int     | \n+---------------+---------+\n(sale_date,fruit) 是该表主键.\n该表包含了每一天中&quot;苹果&quot; 和 &quot;桔子&quot;的销售情况.\n</code></pre>\n<p>写一个 SQL 查询，报告每一天 <strong>苹果</strong> 和 <strong>桔子</strong> 销售的数目的差异.</p>\n<p>返回的结果表，按照格式为 ('YYYY-MM-DD') 的  <code>sale_date</code>  排序.</p>\n<p>查询结果表如下例所示:</p>\n<pre><code>Sales 表:\n+------------+------------+-------------+\n| sale_date  | fruit      | sold_num    |\n+------------+------------+-------------+\n| 2020-05-01 | apples     | 10          |\n| 2020-05-01 | oranges    | 8           |\n| 2020-05-02 | apples     | 15          |\n| 2020-05-02 | oranges    | 15          |\n| 2020-05-03 | apples     | 20          |\n| 2020-05-03 | oranges    | 0           |\n| 2020-05-04 | apples     | 15          |\n| 2020-05-04 | oranges    | 16          |\n+------------+------------+-------------+\n\nResult 表:\n+------------+--------------+\n| sale_date  | diff         |\n+------------+--------------+\n| 2020-05-01 | 2            |\n| 2020-05-02 | 0            |\n| 2020-05-03 | 20           |\n| 2020-05-04 | -1           |\n+------------+--------------+\n\n在 2020-05-01, 卖了 10 个苹果 和 8 个桔子 (差异为 10 - 8 = 2).\n在 2020-05-02, 卖了 15 个苹果 和 15 个桔子 (差异为 15 - 15 = 0).\n在 2020-05-03, 卖了 20 个苹果 和 0 个桔子 (差异为 20 - 0 = 20).\n在 2020-05-04, 卖了 15 个苹果 和 16 个桔子 (差异为 15 - 16 = -1).\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  sale_date<span class=\"token punctuation\">,</span>sold_num<span class=\"token operator\">-</span>ld diff</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> sale_date<span class=\"token punctuation\">,</span>sold_num <span class=\"token punctuation\">,</span> fruit <span class=\"token punctuation\">,</span>lead<span class=\"token punctuation\">(</span>sold_num <span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span>  sale_date <span class=\"token punctuation\">)</span> ld</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Sales</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> fruit<span class=\"token operator\">=</span><span class=\"token string\">'apples'</span></pre></td></tr></table></figure><h4 id=\"1454-活跃用户\"><a class=\"anchor\" href=\"#1454-活跃用户\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWN0aXZlLXVzZXJzLw==\">1454.  活跃用户</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表  <code>Accounts</code> :</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n+---------------+---------+\nid 是该表主键.\n该表包含账户 id 和账户的用户名.\n</code></pre>\n<p>表  <code>Logins</code> :</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| login_date    | date    |\n+---------------+---------+\n该表无主键, 可能包含重复项.\n该表包含登录用户的账户 id 和登录日期. 用户也许一天内登录多次.\n</code></pre>\n<p>写一个 SQL 查询，找到活跃用户的 id 和 name.</p>\n<p>活跃用户是指那些至少连续 5 天登录账户的用户.</p>\n<p>返回的结果表按照 id 排序.</p>\n<p>结果表格式如下例所示:</p>\n<pre><code>Accounts 表:\n+----+----------+\n| id | name     |\n+----+----------+\n| 1  | Winston  |\n| 7  | Jonathan |\n+----+----------+\n\nLogins 表:\n+----+------------+\n| id | login_date |\n+----+------------+\n| 7  | 2020-05-30 |\n| 1  | 2020-05-30 |\n| 7  | 2020-05-31 |\n| 7  | 2020-06-01 |\n| 7  | 2020-06-02 |\n| 7  | 2020-06-02 |\n| 7  | 2020-06-03 |\n| 1  | 2020-06-07 |\n| 7  | 2020-06-10 |\n+----+------------+\n\nResult 表:\n+----+----------+\n| id | name     |\n+----+----------+\n| 7  | Jonathan |\n+----+----------+\nid = 1 的用户 Winston 仅仅在不同的 2 天内登录了 2 次, 所以, Winston 不是活跃用户.\nid = 7 的用户 Jonathon 在不同的 6 天内登录了 7 次, , 6 天中有 5 天是连续的, 所以, Jonathan 是活跃用户.\n</code></pre>\n<p><strong>后续问题:</strong><br />\n 如果活跃用户是那些至少连续  <code>n</code>  天登录账户的用户，你能否写出通用的解决方案？</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> t3<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>login_date<span class=\"token punctuation\">,</span>lead<span class=\"token punctuation\">(</span>login_date<span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> login_date<span class=\"token punctuation\">)</span> ld</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>login_date </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">from</span> Logins</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">,</span>login_date</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">where</span> datediff<span class=\"token punctuation\">(</span>ld<span class=\"token punctuation\">,</span>login_date<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">)</span>t3</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Accounts a</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">on</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> a<span class=\"token punctuation\">.</span>id</pre></td></tr></table></figure><blockquote>\n<p>注意用户当天重复登入</p>\n</blockquote>\n<h4 id=\"1459-矩形面积\"><a class=\"anchor\" href=\"#1459-矩形面积\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVjdGFuZ2xlcy1hcmVhLw==\">1459. 矩形面积</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Points</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| x_value       | int     |\n| y_value       | int     |\n+---------------+---------+\nid 是该表主键.\n每个点都表示为二维空间 (x_value, y_value).\n</code></pre>\n<p>写一个 SQL 语句，报告由表中任意两点可以形成的所有可能的矩形.</p>\n<p>结果表中的每一行包含三列 (p1, p2, area) 如下:</p>\n<ul>\n<li><strong>p1</strong> 和 <strong>p2</strong> 是矩形两个对角的 id 且 p1 &lt; p2.</li>\n<li>矩形的面积由列 <strong>area</strong> 表示.</li>\n</ul>\n<p>请按照面积大小降序排列，如果面积相同的话，则按照 p1 和 p2 升序对结果表排序</p>\n<pre><code>Points 表:\n+----------+-------------+-------------+\n| id       | x_value     | y_value     |\n+----------+-------------+-------------+\n| 1        | 2           | 8           |\n| 2        | 4           | 7           |\n| 3        | 2           | 10          |\n+----------+-------------+-------------+\n\nResult 表:\n+----------+-------------+-------------+\n| p1       | p2          | area        |\n+----------+-------------+-------------+\n| 2        | 3           | 6           |\n| 1        | 2           | 2           |\n+----------+-------------+-------------+\n\np1 应该小于 p2 并且面积大于 0.\np1 = 1 且 p2 = 2 时, 面积等于 |2-4| * |8-7| = 2.\np1 = 2 且 p2 = 3 时, 面积等于 |4-2| * |7-10| = 6.\np1 = 1 且 p2 = 3 时, 是不可能为矩形的, 因为面积等于 0.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>id P1<span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">.</span>id P2<span class=\"token punctuation\">,</span>abs<span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>x_value<span class=\"token operator\">-</span>b<span class=\"token punctuation\">.</span>x_value<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>abs<span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>y_value<span class=\"token operator\">-</span>b<span class=\"token punctuation\">.</span>y_value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> area</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Points a<span class=\"token punctuation\">,</span>Points b</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> a<span class=\"token punctuation\">.</span>id<span class=\"token operator\">&lt;</span>b<span class=\"token punctuation\">.</span>id <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>x_value <span class=\"token operator\">!=</span> b<span class=\"token punctuation\">.</span>x_value <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>y_value <span class=\"token operator\">!=</span> b<span class=\"token punctuation\">.</span>y_value</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> area <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>P1 <span class=\"token punctuation\">,</span>P2</pre></td></tr></table></figure><h4 id=\"1468-计算税后工资\"><a class=\"anchor\" href=\"#1468-计算税后工资\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY2FsY3VsYXRlLXNhbGFyaWVzLw==\">1468. 计算税后工资</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Salaries</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| company_id    | int     |\n| employee_id   | int     |\n| employee_name | varchar |\n| salary        | int     |\n+---------------+---------+\n(company_id, employee_id) 是这个表的主键\n这个表包括员工的company id, id, name 和 salary \n</code></pre>\n<p>写一条查询 SQL 来查找每个员工的税后工资</p>\n<p>每个公司的税率计算依照以下规则</p>\n<ul>\n<li>如果这个公司员工最高工资不到 1000 ，税率为 0%</li>\n<li>如果这个公司员工最高工资在 1000 到 10000 之间，税率为 24%</li>\n<li>如果这个公司员工最高工资大于 10000 ，税率为 49%</li>\n</ul>\n<p>按任意顺序返回结果，税后工资结果取整</p>\n<p>结果表格式如下例所示：</p>\n<pre><code>Salaries 表：\n+------------+-------------+---------------+--------+\n| company_id | employee_id | employee_name | salary |\n+------------+-------------+---------------+--------+\n| 1          | 1           | Tony          | 2000   |\n| 1          | 2           | Pronub        | 21300  |\n| 1          | 3           | Tyrrox        | 10800  |\n| 2          | 1           | Pam           | 300    |\n| 2          | 7           | Bassem        | 450    |\n| 2          | 9           | Hermione      | 700    |\n| 3          | 7           | Bocaben       | 100    |\n| 3          | 2           | Ognjen        | 2200   |\n| 3          | 13          | Nyancat       | 3300   |\n| 3          | 15          | Morninngcat   | 1866   |\n+------------+-------------+---------------+--------+\n\nResult 表：\n+------------+-------------+---------------+--------+\n| company_id | employee_id | employee_name | salary |\n+------------+-------------+---------------+--------+\n| 1          | 1           | Tony          | 1020   |\n| 1          | 2           | Pronub        | 10863  |\n| 1          | 3           | Tyrrox        | 5508   |\n| 2          | 1           | Pam           | 300    |\n| 2          | 7           | Bassem        | 450    |\n| 2          | 9           | Hermione      | 700    |\n| 3          | 7           | Bocaben       | 76     |\n| 3          | 2           | Ognjen        | 1672   |\n| 3          | 13          | Nyancat       | 2508   |\n| 3          | 15          | Morninngcat   | 5911   |\n+------------+-------------+---------------+--------+\n对于公司 1 ，最高工资是 21300 ，其每个员工的税率为 49%\n对于公司 2 ，最高工资是 700 ，其每个员工税率为 0%\n对于公司 3 ，最高工资是 7777 ，其每个员工税率是 24%\n税后工资计算 = 工资 - ( 税率 / 100）*工资\n对于上述案例，Morninngcat 的税后工资 = 7777 - 7777 * ( 24 / 100) = 7777 - 1866.48 = 5910.52 ，取整为 5911\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> company_id<span class=\"token punctuation\">,</span>employee_id <span class=\"token punctuation\">,</span> employee_name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> maxsalary<span class=\"token operator\">&lt;</span><span class=\"token number\">1000</span> <span class=\"token keyword\">then</span> salary</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>       <span class=\"token keyword\">when</span> maxsalary<span class=\"token operator\">&lt;</span><span class=\"token number\">10000</span> <span class=\"token keyword\">then</span> salary<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">-</span><span class=\"token number\">0.24</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>       <span class=\"token keyword\">else</span> salary<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">-</span><span class=\"token number\">0.49</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">end</span> <span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>salary</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> company_id <span class=\"token punctuation\">)</span> maxsalary</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">from</span> Salaries </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr></table></figure><h4 id=\"1479-周内每天的销售情况\"><a class=\"anchor\" href=\"#1479-周内每天的销售情况\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2FsZXMtYnktZGF5LW9mLXRoZS13ZWVrLw==\">1479. 周内每天的销售情况</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>表： <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| customer_id   | int     |\n| order_date    | date    | \n| item_id       | varchar |\n| quantity      | int     |\n+---------------+---------+\n(order_id, item_id) 是该表主键\n该表包含了订单信息\norder_date 是id为 item_id 的商品被id为 customer_id 的消费者订购的日期.\n</code></pre>\n<p>表： <code>Items</code></p>\n<pre><code>+---------------------+---------+\n| Column Name         | Type    |\n+---------------------+---------+\n| item_id             | varchar |\n| item_name           | varchar |\n| item_category       | varchar |\n+---------------------+---------+\nitem_id 是该表主键\nitem_name 是商品的名字\nitem_category 是商品的类别\n</code></pre>\n<p>你是企业主，想要获得分类商品和周内每天的销售报告。</p>\n<p>写一个 SQL 语句，报告 <strong>周内每天</strong> 每个商品类别下订购了多少单位。</p>\n<p>返回结果表单 <strong>按商品类别排序</strong> 。</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Orders 表：\n+------------+--------------+-------------+--------------+-------------+\n| order_id   | customer_id  | order_date  | item_id      | quantity    |\n+------------+--------------+-------------+--------------+-------------+\n| 1          | 1            | 2020-06-01  | 1            | 10          |\n| 2          | 1            | 2020-06-08  | 2            | 10          |\n| 3          | 2            | 2020-06-02  | 1            | 5           |\n| 4          | 3            | 2020-06-03  | 3            | 5           |\n| 5          | 4            | 2020-06-04  | 4            | 1           |\n| 6          | 4            | 2020-06-05  | 5            | 5           |\n| 7          | 5            | 2020-06-05  | 1            | 10          |\n| 8          | 5            | 2020-06-14  | 4            | 5           |\n| 9          | 5            | 2020-06-21  | 3            | 5           |\n+------------+--------------+-------------+--------------+-------------+\n\nItems 表：\n+------------+----------------+---------------+\n| item_id    | item_name      | item_category |\n+------------+----------------+---------------+\n| 1          | LC Alg. Book   | Book          |\n| 2          | LC DB. Book    | Book          |\n| 3          | LC SmarthPhone | Phone         |\n| 4          | LC Phone 2020  | Phone         |\n| 5          | LC SmartGlass  | Glasses       |\n| 6          | LC T-Shirt XL  | T-Shirt       |\n+------------+----------------+---------------+\n\nResult 表：\n+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+\n| Category   | Monday    | Tuesday   | Wednesday | Thursday  | Friday    | Saturday  | Sunday    |\n+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+\n| Book       | 20        | 5         | 0         | 0         | 10        | 0         | 0         |\n| Glasses    | 0         | 0         | 0         | 0         | 5         | 0         | 0         |\n| Phone      | 0         | 0         | 5         | 1         | 0         | 0         | 10        |\n| T-Shirt    | 0         | 0         | 0         | 0         | 0         | 0         | 0         |\n+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+\n在周一(2020-06-01, 2020-06-08)，Book分类(ids: 1, 2)下，总共销售了20个单位(10 + 10)\n在周二(2020-06-02)，Book分类(ids: 1, 2)下，总共销售了5个单位\n在周三(2020-06-03)，Phone分类(ids: 3, 4)下，总共销售了5个单位\n在周四(2020-06-04)，Phone分类(ids: 3, 4)下，总共销售了1个单位\n在周五(2020-06-05)，Book分类(ids: 1, 2)下，总共销售了10个单位，Glasses分类(ids: 5)下，总共销售了5个单位\n在周六, 没有商品销售\n在周天(2020-06-14, 2020-06-21)，Phone分类(ids: 3, 4)下，总共销售了10个单位(5 + 5)\n没有销售 T-Shirt 类别的商品\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> item_category <span class=\"token keyword\">as</span> category<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Monday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">3</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Tuesday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">4</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Wednesday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">5</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Thursday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">6</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Friday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">7</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Saturday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Sunday</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> item_category<span class=\"token punctuation\">,</span> quantity<span class=\"token punctuation\">,</span>dayofweek<span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> num <span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>items i <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> orders o </pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">on</span> i<span class=\"token punctuation\">.</span>item_id<span class=\"token operator\">=</span>o<span class=\"token punctuation\">.</span>item_id<span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> item_category</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> item_category</pre></td></tr></table></figure><h4 id=\"1485-按日期分组销售产品\"><a class=\"anchor\" href=\"#1485-按日期分组销售产品\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ3JvdXAtc29sZC1wcm9kdWN0cy1ieS10aGUtZGF0ZS8=\">1485. 按日期分组销售产品</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表  <code>Activities</code> ：</p>\n<pre><code>+-------------+---------+\n| 列名         | 类型    |\n+-------------+---------+\n| sell_date   | date    |\n| product     | varchar |\n+-------------+---------+\n此表没有主键，它可能包含重复项。\n此表的每一行都包含产品名称和在市场上销售的日期。\n</code></pre>\n<p>编写一个 SQL 查询来查找每个日期、销售的不同产品的数量及其名称。<br />\n每个日期的销售产品名称应按词典序排列。<br />\n返回按  <code>sell_date</code>  排序的结果表。</p>\n<p>查询结果格式如下例所示。</p>\n<pre><code>Activities 表：\n+------------+-------------+\n| sell_date  | product     |\n+------------+-------------+\n| 2020-05-30 | Headphone   |\n| 2020-06-01 | Pencil      |\n| 2020-06-02 | Mask        |\n| 2020-05-30 | Basketball  |\n| 2020-06-01 | Bible       |\n| 2020-06-02 | Mask        |\n| 2020-05-30 | T-Shirt     |\n+------------+-------------+\n\nResult 表：\n+------------+----------+------------------------------+\n| sell_date  | num_sold | products                     |\n+------------+----------+------------------------------+\n| 2020-05-30 | 3        | Basketball,Headphone,T-shirt |\n| 2020-06-01 | 2        | Bible,Pencil                 |\n| 2020-06-02 | 1        | Mask                         |\n+------------+----------+------------------------------+\n对于2020-05-30，出售的物品是 (Headphone, Basketball, T-shirt)，按词典序排列，并用逗号 ',' 分隔。\n对于2020-06-01，出售的物品是 (Pencil, Bible)，按词典序排列，并用逗号分隔。\n对于2020-06-02，出售的物品是 (Mask)，只需返回该物品名。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> sell_date<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> product<span class=\"token punctuation\">)</span> num_sold<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    group_concat<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> product <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> product<span class=\"token punctuation\">)</span> products</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> Activities</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> sell_date</pre></td></tr></table></figure><blockquote>\n<p>行转列</p>\n</blockquote>\n<h4 id=\"1495-上月播放的儿童适宜电影\"><a class=\"anchor\" href=\"#1495-上月播放的儿童适宜电影\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZnJpZW5kbHktbW92aWVzLXN0cmVhbWVkLWxhc3QtbW9udGgv\">1495. 上月播放的儿童适宜电影</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表:  <code>TVProgram</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| program_date  | date    |\n| content_id    | int     |\n| channel       | varchar |\n+---------------+---------+\n(program_date, content_id) 是该表主键.\n该表包含电视上的节目信息.\ncontent_id 是电视一些频道上的节目的 id.\n</code></pre>\n<p>表:  <code>Content</code></p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| content_id       | varchar |\n| title            | varchar |\n| Kids_content     | enum    |\n| content_type     | varchar |\n+------------------+---------+\ncontent_id 是该表主键.\nKids_content 是枚举类型, 取值为('Y', 'N'), 其中: \n'Y' 表示儿童适宜内容, 而'N'表示儿童不宜内容.\ncontent_type 表示内容的类型, 比如电影, 电视剧等.\n</code></pre>\n<p>写一个 SQL 语句，报告在 2020 年 6 月份播放的儿童适宜电影的去重电影名.</p>\n<p>返回的结果表单没有顺序要求.</p>\n<p>查询结果的格式如下例所示.</p>\n<pre><code>TVProgram 表:\n+--------------------+--------------+-------------+\n| program_date       | content_id   | channel     |\n+--------------------+--------------+-------------+\n| 2020-06-10 08:00   | 1            | LC-Channel  |\n| 2020-05-11 12:00   | 2            | LC-Channel  |\n| 2020-05-12 12:00   | 3            | LC-Channel  |\n| 2020-05-13 14:00   | 4            | Disney Ch   |\n| 2020-06-18 14:00   | 4            | Disney Ch   |\n| 2020-07-15 16:00   | 5            | Disney Ch   |\n+--------------------+--------------+-------------+\n\nContent 表:\n+------------+----------------+---------------+---------------+\n| content_id | title          | Kids_content  | content_type  |\n+------------+----------------+---------------+---------------+\n| 1          | Leetcode Movie | N             | Movies        |\n| 2          | Alg. for Kids  | Y             | Series        |\n| 3          | Database Sols  | N             | Series        |\n| 4          | Aladdin        | Y             | Movies        |\n| 5          | Cinderella     | Y             | Movies        |\n+------------+----------------+---------------+---------------+\n\nResult 表:\n+--------------+\n| title        |\n+--------------+\n| Aladdin      |\n+--------------+\n&quot;Leetcode Movie&quot; 是儿童不宜的电影.\n&quot;Alg. for Kids&quot; 不是电影.\n&quot;Database Sols&quot; 不是电影\n&quot;Alladin&quot; 是电影, 儿童适宜, 并且在 2020 年 6 月份播放.\n&quot;Cinderella&quot; 不在 2020 年 6 月份播放.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> title   </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> TVProgram t <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Content c</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> t<span class=\"token punctuation\">.</span>content_id  <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>content_id </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span>  Kids_content <span class=\"token operator\">=</span><span class=\"token string\">'Y'</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">and</span> date_format<span class=\"token punctuation\">(</span>program_date <span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token string\">'2020-06'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">and</span> content_type<span class=\"token operator\">=</span><span class=\"token string\">'Movies'</span></pre></td></tr></table></figure><blockquote>\n<p>LEFT () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmVndHV0LmNvbS9zcWwvZnVuYy1teXNxbC1sZWZ0Lmh0bWw=\">https://www.begtut.com/sql/func-mysql-left.html</span><br />\nREGEXP 语法参见：<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vdGltc3NkL3AvNTg4Mjc0Mi5odG1s\">https://www.cnblogs.com/timssd/p/5882742.html</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vemhhb3BhbnBhbi9wLzEwMTMzMjI0Lmh0bWw=\">https://www.cnblogs.com/zhaopanpan/p/10133224.html</span><br />\nDATE_FORMAT () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudzNzY2hvb2wuY29tLmNuL3NxbC9mdW5jX2RhdGVfZm9ybWF0LmFzcA==\">https://www.w3school.com.cn/sql/func_date_format.asp</span><br />\nEXTRACT () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS9zcWwvZnVuYy1leHRyYWN0Lmh0bWw=\">https://www.runoob.com/sql/func-extract.html</span><br />\nDATEDIFF () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS9zcWwvZnVuYy1kYXRlZGlmZi1teXNxbC5odG1s\">https://www.runoob.com/sql/func-datediff-mysql.html</span><br />\nYEAR () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bi9hcnRpY2xlL2RldGFpbHMvODI1Mjg4Mjk=\">https://blog.csdn.net/moakun/article/details/82528829</span><br />\nMONTH () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueWlpYmFpLmNvbS9teXNxbC9tb250aC5odG1s\">https://www.yiibai.com/mysql/month.html</span></p>\n</blockquote>\n<h4 id=\"1501-可以放心投资的国家\"><a class=\"anchor\" href=\"#1501-可以放心投资的国家\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY291bnRyaWVzLXlvdS1jYW4tc2FmZWx5LWludmVzdC1pbi8=\">1501. 可以放心投资的国家</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表  <code>Person</code> :</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| id             | int     |\n| name           | varchar |\n| phone_number   | varchar |\n+----------------+---------+\nid 是该表主键.\n该表每一行包含一个人的名字和电话号码.\n电话号码的格式是:'xxx-yyyyyyy', 其中xxx是国家码(3个字符), yyyyyyy是电话号码(7个字符), x和y都表示数字. 同时, 国家码和电话号码都可以包含前导0.\n</code></pre>\n<p>表  <code>Country</code> :</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| name           | varchar |\n| country_code   | varchar |\n+----------------+---------+\ncountry_code是该表主键.\n该表每一行包含国家名和国家码. country_code的格式是'xxx', x是数字.\n</code></pre>\n<p>表  <code>Calls</code> :</p>\n<pre><code>+-------------+------+\n| Column Name | Type |\n+-------------+------+\n| caller_id   | int  |\n| callee_id   | int  |\n| duration    | int  |\n+-------------+------+\n该表无主键, 可能包含重复行.\n每一行包含呼叫方id, 被呼叫方id和以分钟为单位的通话时长. caller_id != callee_id\n</code></pre>\n<p>一家电信公司想要投资新的国家。该公司想要投资的国家是：该国的平均通话时长要严格地大于全球平均通话时长.</p>\n<p>写一段 SQL, 找到所有该公司可以投资的国家.</p>\n<p>返回的结果表没有顺序要求.</p>\n<p>查询的结果格式如下例所示.</p>\n<pre><code>Person 表:\n+----+----------+--------------+\n| id | name     | phone_number |\n+----+----------+--------------+\n| 3  | Jonathan | 051-1234567  |\n| 12 | Elvis    | 051-7654321  |\n| 1  | Moncef   | 212-1234567  |\n| 2  | Maroua   | 212-6523651  |\n| 7  | Meir     | 972-1234567  |\n| 9  | Rachel   | 972-0011100  |\n+----+----------+--------------+\n\nCountry 表:\n+----------+--------------+\n| name     | country_code |\n+----------+--------------+\n| Peru     | 051          |\n| Israel   | 972          |\n| Morocco  | 212          |\n| Germany  | 049          |\n| Ethiopia | 251          |\n+----------+--------------+\n\nCalls 表:\n+-----------+-----------+----------+\n| caller_id | callee_id | duration |\n+-----------+-----------+----------+\n| 1         | 9         | 33       |\n| 2         | 9         | 4        |\n| 1         | 2         | 59       |\n| 3         | 12        | 102      |\n| 3         | 12        | 330      |\n| 12        | 3         | 5        |\n| 7         | 9         | 13       |\n| 7         | 1         | 3        |\n| 9         | 7         | 1        |\n| 1         | 7         | 7        |\n+-----------+-----------+----------+\n\nResult 表:\n+----------+\n| country  |\n+----------+\n| Peru     |\n+----------+\n国家Peru的平均通话时长是 (102 + 102 + 330 + 330 + 5 + 5) / 6 = 145.666667\n国家Israel的平均通话时长是 (33 + 4 + 13 + 13 + 3 + 1 + 1 + 7) / 8 = 9.37500\n国家Morocco的平均通话时长是 (33 + 4 + 59 + 59 + 3 + 7) / 6 = 27.5000 \n全球平均通话时长 = (2 * (33 + 3 + 59 + 102 + 330 + 5 + 13 + 3 + 1 + 7)) / 20 = 55.70000\n所以, Peru是唯一的平均通话时长大于全球平均通话时长的国家, 也是唯一的推荐投资的国家.\n</code></pre>\n<p>笛卡尔积</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> c2<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> country </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Calls c1<span class=\"token punctuation\">,</span>Person p<span class=\"token punctuation\">,</span>Country c2</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>c1<span class=\"token punctuation\">.</span>caller_id <span class=\"token operator\">or</span> p<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>c1<span class=\"token punctuation\">.</span>callee_id<span class=\"token punctuation\">)</span> <span class=\"token operator\">and</span> c2<span class=\"token punctuation\">.</span>country_code<span class=\"token operator\">=</span><span class=\"token keyword\">left</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>phone_number<span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> c2<span class=\"token punctuation\">.</span>name </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>duration<span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>duration<span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> Calls<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>思路更清晰</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">with</span> people_country <span class=\"token keyword\">as</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>name country</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">from</span> Person p <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Country c</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">on</span> <span class=\"token keyword\">left</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>phone_number<span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>country_code</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">select</span> country</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">select</span> country<span class=\"token punctuation\">,</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>duration<span class=\"token punctuation\">)</span> avgtime</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">select</span> caller_id id<span class=\"token punctuation\">,</span> duration</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">from</span> Calls</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">union</span> <span class=\"token keyword\">all</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">select</span> callee_id<span class=\"token punctuation\">,</span> duration</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">from</span> Calls</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">)</span> t <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> people_country</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">using</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> country</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">temp</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">where</span> avgtime <span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>duration<span class=\"token punctuation\">)</span> avgtime</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token keyword\">select</span> caller_id<span class=\"token punctuation\">,</span> duration</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">from</span> Calls</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">union</span> <span class=\"token keyword\">all</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">select</span> callee_id<span class=\"token punctuation\">,</span> duration</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token keyword\">from</span> Calls</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1511-消费者下单频率\"><a class=\"anchor\" href=\"#1511-消费者下单频率\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3VzdG9tZXItb3JkZXItZnJlcXVlbmN5Lw==\">1511. 消费者下单频率</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表:  <code>Customers</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| customer_id   | int     |\n| name          | varchar |\n| country       | varchar |\n+---------------+---------+\ncustomer_id 是该表主键.\n该表包含公司消费者的信息.\n</code></pre>\n<p>表:  <code>Product</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| description   | varchar |\n| price         | int     |\n+---------------+---------+\nproduct_id 是该表主键.\n该表包含公司产品的信息.\nprice 是本产品的花销.\n</code></pre>\n<p>表:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| customer_id   | int     |\n| product_id    | int     |\n| order_date    | date    |\n| quantity      | int     |\n+---------------+---------+\norder_id 是该表主键.\n该表包含消费者下单的信息.\ncustomer_id 是买了数量为&quot;quantity&quot;, id为&quot;product_id&quot;产品的消费者的 id.\nOrder_date 是订单发货的日期, 格式为('YYYY-MM-DD').\n</code></pre>\n<p>写一个 SQL 语句，报告消费者的 id 和名字，其中消费者在 2020 年 6 月和 7 月，每月至少花费了 $100.</p>\n<p>结果表无顺序要求.</p>\n<p>查询结果格式如下例所示.</p>\n<pre><code>Customers\n+--------------+-----------+-------------+\n| customer_id  | name      | country     |\n+--------------+-----------+-------------+\n| 1            | Winston   | USA         |\n| 2            | Jonathan  | Peru        |\n| 3            | Moustafa  | Egypt       |\n+--------------+-----------+-------------+\n\nProduct\n+--------------+-------------+-------------+\n| product_id   | description | price       |\n+--------------+-------------+-------------+\n| 10           | LC Phone    | 300         |\n| 20           | LC T-Shirt  | 10          |\n| 30           | LC Book     | 45          |\n| 40           | LC Keychain | 2           |\n+--------------+-------------+-------------+\n\nOrders\n+--------------+-------------+-------------+-------------+-----------+\n| order_id     | customer_id | product_id  | order_date  | quantity  |\n+--------------+-------------+-------------+-------------+-----------+\n| 1            | 1           | 10          | 2020-06-10  | 1         |\n| 2            | 1           | 20          | 2020-07-01  | 1         |\n| 3            | 1           | 30          | 2020-07-08  | 2         |\n| 4            | 2           | 10          | 2020-06-15  | 2         |\n| 5            | 2           | 40          | 2020-07-01  | 10        |\n| 6            | 3           | 20          | 2020-06-24  | 2         |\n| 7            | 3           | 30          | 2020-06-25  | 2         |\n| 9            | 3           | 30          | 2020-05-08  | 3         |\n+--------------+-------------+-------------+-------------+-----------+\n\nResult 表:\n+--------------+------------+\n| customer_id  | name       |  \n+--------------+------------+\n| 1            | Winston    |\n+--------------+------------+ \nWinston 在2020年6月花费了$300(300 * 1), 在7月花费了$100(10 * 1 + 45 * 2).\nJonathan 在2020年6月花费了$600(300 * 2), 在7月花费了$20(2 * 10).\nMoustafa 在2020年6月花费了$110 (10 * 2 + 45 * 2), 在7月花费了$0.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> customer_id<span class=\"token punctuation\">,</span>name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Customers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> customer_id <span class=\"token operator\">in</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> customer_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> customer_id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">month</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>quantity<span class=\"token operator\">*</span>price<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">from</span> Orders o <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Product p <span class=\"token keyword\">on</span> o<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">where</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">6</span> <span class=\"token operator\">or</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">7</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_id<span class=\"token punctuation\">,</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> t1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">where</span> total <span class=\"token operator\">>=</span><span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_id</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1517-find-users-with-valid-e-mails\"><a class=\"anchor\" href=\"#1517-find-users-with-valid-e-mails\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC11c2Vycy13aXRoLXZhbGlkLWUtbWFpbHMv\">1517. Find Users With Valid E-Mails</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Users</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| name          | varchar |\n| mail          | varchar |\n+---------------+---------+\nuser_id is the primary key for this table.\nThis table contains information of the users signed up in a website. Some e-mails are invalid.\n</code></pre>\n<p>Write an SQL query to find the users who have <strong>valid emails</strong>.</p>\n<p>A valid e-mail has a prefix name and a domain where:</p>\n<ul>\n<li><strong>The prefix name</strong> is a string that may contain letters (upper or lower case), digits, underscore  <code>'_'</code> , period  <code>'.'</code>  and/or dash  <code>'-'</code> . The prefix name <strong>must</strong> start with a letter.</li>\n<li><strong>The domain</strong> is  <code>'@leetcode.com'</code> .</li>\n</ul>\n<p>Return the result table in any order.</p>\n<p>The query result format is in the following example.</p>\n<pre><code>Users\n+---------+-----------+-------------------------+\n| user_id | name      | mail                    |\n+---------+-----------+-------------------------+\n| 1       | Winston   | winston@leetcode.com    |\n| 2       | Jonathan  | jonathanisgreat         |\n| 3       | Annabelle | bella-@leetcode.com     |\n| 4       | Sally     | sally.come@leetcode.com |\n| 5       | Marwan    | quarz#2020@leetcode.com |\n| 6       | David     | david69@gmail.com       |\n| 7       | Shapiro   | .shapo@leetcode.com     |\n+---------+-----------+-------------------------+\n\nResult table:\n+---------+-----------+-------------------------+\n| user_id | name      | mail                    |\n+---------+-----------+-------------------------+\n| 1       | Winston   | winston@leetcode.com    |\n| 3       | Annabelle | bella-@leetcode.com     |\n| 4       | Sally     | sally.come@leetcode.com |\n+---------+-----------+-------------------------+\nThe mail of user 2 doesn't have a domain.\nThe mail of user 5 has # sign which is not allowed.\nThe mail of user 6 doesn't have leetcode domain.\nThe mail of user 7 starts with a period.\n</code></pre>\n<p>考察正则表达式的使用</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> Users</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">WHERE</span> mail <span class=\"token operator\">REGEXP</span> <span class=\"token string\">'^[a-zA-Z]+[\\\\w_\\\\.\\\\-]*@leetcode.com$'</span>   </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> user_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> Users</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">where</span> mail <span class=\"token operator\">regexp</span> <span class=\"token string\">'^[a-zA-Z]+[a-zA-Z0-9_\\\\./\\\\-]&#123;0,&#125;@leetcode.com$'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> user_id</pre></td></tr></table></figure><blockquote>\n<p>坑点：<br />\n1、前缀可能是一个字母，比如 “J@leetcode.com”，所以匹配非首字母外的前缀字符数量要用 {0,} 或 *，不能用 +。<br />\n2、题意要求：underscore '', period '.' and/or dash '-'，/ 没加单引号，不留神可能写漏 /。<br />\n3、后缀可能是 “@leetcodeecom”，所以要对 “.” 加转义符号。<br />\n4、后缀可能是 “@LEETCODE.COM”，默认是不区分大小写匹配，所以要加上 “BINARY” 区分大小写。<br />\n语法：<br />\n1、<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vdGltc3NkL3AvNTg4Mjc0Mi5odG1s\">https://www.cnblogs.com/timssd/p/5882742.html</span><br />\n2、<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vemhhb3BhbnBhbi9wLzEwMTMzMjI0Lmh0bWw=\">https://www.cnblogs.com/zhaopanpan/p/10133224.html</span><br />\n3、&quot;双反斜杠 + w&quot; 表示字母、数字、下划线，相对 &quot;a-zA-Z0-9&quot; 的写法更简洁。</p>\n</blockquote>\n<h4 id=\"1527-patients-with-a-condition\"><a class=\"anchor\" href=\"#1527-patients-with-a-condition\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcGF0aWVudHMtd2l0aC1hLWNvbmRpdGlvbi8=\">1527. Patients With a Condition</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Patients</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| patient_id   | int     |\n| patient_name | varchar |\n| conditions   | varchar |\n+--------------+---------+\npatient_id is the primary key for this table.\n'conditions' contains 0 or more code separated by spaces. \nThis table contains information of the patients in the hospital.\n</code></pre>\n<p>Write an SQL query to report the patient_id, patient_name all conditions of patients who have Type I Diabetes. Type I Diabetes always starts with  <code>DIAB1</code>  prefix</p>\n<p>Return the result table in any order.</p>\n<p>The query result format is in the following example.</p>\n<pre><code>Patients\n+------------+--------------+--------------+\n| patient_id | patient_name | conditions   |\n+------------+--------------+--------------+\n| 1          | Daniel       | YFEV COUGH   |\n| 2          | Alice        |              |\n| 3          | Bob          | DIAB100 MYOP |\n| 4          | George       | ACNE DIAB100 |\n| 5          | Alain        | DIAB201      |\n+------------+--------------+--------------+\n\nResult table:\n+------------+--------------+--------------+\n| patient_id | patient_name | conditions   |\n+------------+--------------+--------------+\n| 3          | Bob          | DIAB100 MYOP |\n| 4          | George       | ACNE DIAB100 | \n+------------+--------------+--------------+\nBob and George both have a condition that starts with DIAB1.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  patient_id <span class=\"token punctuation\">,</span> patient_name <span class=\"token punctuation\">,</span>conditions </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Patients</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> conditions <span class=\"token operator\">like</span> <span class=\"token string\">'%DIAB1%'</span></pre></td></tr></table></figure><h4 id=\"1532-the-most-recent-three-orders\"><a class=\"anchor\" href=\"#1532-the-most-recent-three-orders\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdGhlLW1vc3QtcmVjZW50LXRocmVlLW9yZGVycy8=\">1532. The Most Recent Three Orders</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Customers</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| customer_id   | int     |\n| name          | varchar |\n+---------------+---------+\ncustomer_id is the primary key for this table.\nThis table contains information about customers.\n</code></pre>\n<p>Table:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| order_date    | date    |\n| customer_id   | int     |\n| cost          | int     |\n+---------------+---------+\norder_id is the primary key for this table.\nThis table contains information about the orders made by customer_id.\nEach customer has one order per day.\n</code></pre>\n<p>Write an SQL query to find the most recent 3 orders of each user. If a user ordered less than 3 orders return all of their orders.</p>\n<p>Return the result table sorted by  <code>customer_name</code>  in <strong>ascending</strong> order and in case of a tie by the  <code>customer_id</code>  in <strong>ascending</strong> order. If there still a tie, order them by the  <code>order_date</code>  in <strong>descending</strong> order.</p>\n<p>The query result format is in the following example:</p>\n<pre><code>Customers\n+-------------+-----------+\n| customer_id | name      |\n+-------------+-----------+\n| 1           | Winston   |\n| 2           | Jonathan  |\n| 3           | Annabelle |\n| 4           | Marwan    |\n| 5           | Khaled    |\n+-------------+-----------+\n\nOrders\n+----------+------------+-------------+------+\n| order_id | order_date | customer_id | cost |\n+----------+------------+-------------+------+\n| 1        | 2020-07-31 | 1           | 30   |\n| 2        | 2020-07-30 | 2           | 40   |\n| 3        | 2020-07-31 | 3           | 70   |\n| 4        | 2020-07-29 | 4           | 100  |\n| 5        | 2020-06-10 | 1           | 1010 |\n| 6        | 2020-08-01 | 2           | 102  |\n| 7        | 2020-08-01 | 3           | 111  |\n| 8        | 2020-08-03 | 1           | 99   |\n| 9        | 2020-08-07 | 2           | 32   |\n| 10       | 2020-07-15 | 1           | 2    |\n+----------+------------+-------------+------+\n\nResult table:\n+---------------+-------------+----------+------------+\n| customer_name | customer_id | order_id | order_date |\n+---------------+-------------+----------+------------+\n| Annabelle     | 3           | 7        | 2020-08-01 |\n| Annabelle     | 3           | 3        | 2020-07-31 |\n| Jonathan      | 2           | 9        | 2020-08-07 |\n| Jonathan      | 2           | 6        | 2020-08-01 |\n| Jonathan      | 2           | 2        | 2020-07-30 |\n| Marwan        | 4           | 4        | 2020-07-29 |\n| Winston       | 1           | 8        | 2020-08-03 |\n| Winston       | 1           | 1        | 2020-07-31 |\n| Winston       | 1           | 10       | 2020-07-15 |\n+---------------+-------------+----------+------------+\nWinston has 4 orders, we discard the order of &quot;2020-06-10&quot; because it is the oldest order.\nAnnabelle has only 2 orders, we return them.\nJonathan has exactly 3 orders.\nMarwan ordered only one time.\nWe sort the result table by customer_name in ascending order, by customer_id in ascending order and by order_date in descending order in case of a tie.\n</code></pre>\n<p><strong>Follow-up:</strong><br />\nCan you write a general solution for the most recent  <code>n</code>  orders?</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name customer_name <span class=\"token punctuation\">,</span>customer_id<span class=\"token punctuation\">,</span>order_id<span class=\"token punctuation\">,</span>order_date</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span>  name <span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">.</span>customer_id<span class=\"token punctuation\">,</span>order_id<span class=\"token punctuation\">,</span>order_date <span class=\"token punctuation\">,</span>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> o<span class=\"token punctuation\">.</span>customer_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> order_date <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Orders o <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Customers c</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">on</span> o<span class=\"token punctuation\">.</span>customer_id<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span>customer_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">&lt;=</span><span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> customer_name <span class=\"token punctuation\">,</span>customer_id<span class=\"token punctuation\">,</span>order_date <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><h4 id=\"1543-fix-product-name-format\"><a class=\"anchor\" href=\"#1543-fix-product-name-format\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZml4LXByb2R1Y3QtbmFtZS1mb3JtYXQv\">1543. Fix Product Name Format</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Sales</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| sale_id      | int     |\n| product_name | varchar |\n| sale_date    | date    |\n+--------------+---------+\nsale_id is the primary key for this table.\nEach row of this table contains the product name and the date it was sold.\n</code></pre>\n<p>Since table Sales was filled manually in the year 2000,  <code>product_name</code>  may contain leading and/or trailing white spaces, also they are case-insensitive.</p>\n<p>Write an SQL query to report</p>\n<ul>\n<li><code>product_name</code>  in lowercase without leading or trailing white spaces.</li>\n<li><code>sale_date</code>  in the format  <code>('YYYY-MM')</code></li>\n<li><code>total</code>  the number of times the product was sold in this month.</li>\n</ul>\n<p>Return the result table ordered by  <code>product_name</code>  in <strong>ascending order</strong>, in case of a tie order it by  <code>sale_date</code>  in <strong>ascending order</strong>.</p>\n<p>The query result format is in the following example.</p>\n<pre><code>Sales\n+------------+------------------+--------------+\n| sale_id    | product_name     | sale_date    |\n+------------+------------------+--------------+\n| 1          |      LCPHONE     | 2000-01-16   |\n| 2          |    LCPhone       | 2000-01-17   |\n| 3          |     LcPhOnE      | 2000-02-18   |\n| 4          |      LCKeyCHAiN  | 2000-02-19   |\n| 5          |   LCKeyChain     | 2000-02-28   |\n| 6          | Matryoshka       | 2000-03-31   | \n+------------+------------------+--------------+\n\nResult table:\n+--------------+--------------+----------+\n| product_name | sale_date    | total    |\n+--------------+--------------+----------+\n| lcphone      | 2000-01      | 2        |\n| lckeychain   | 2000-02      | 2        | \n| lcphone      | 2000-02      | 1        | \n| matryoshka   | 2000-03      | 1        | \n+--------------+--------------+----------+\n\nIn January, 2 LcPhones were sold, please note that the product names are not case sensitive and may contain spaces.\nIn Februery, 2 LCKeychains and 1 LCPhone were sold.\nIn March, 1 matryoshka was sold.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> trim<span class=\"token punctuation\">(</span>lower<span class=\"token punctuation\">(</span>product_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> product_name<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        date_format<span class=\"token punctuation\">(</span>sale_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> sale_date<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Sales </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> trim<span class=\"token punctuation\">(</span>lower<span class=\"token punctuation\">(</span>product_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> date_format<span class=\"token punctuation\">(</span>sale_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> product_name <span class=\"token keyword\">asc</span><span class=\"token punctuation\">,</span> sale_date <span class=\"token keyword\">asc</span></pre></td></tr></table></figure><blockquote>\n<p>注意大小写、空格</p>\n</blockquote>\n<h4 id=\"1549-the-most-recent-orders-for-each-product\"><a class=\"anchor\" href=\"#1549-the-most-recent-orders-for-each-product\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdGhlLW1vc3QtcmVjZW50LW9yZGVycy1mb3ItZWFjaC1wcm9kdWN0Lw==\">1549. The Most Recent Orders for Each Product</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Customers</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| customer_id   | int     |\n| name          | varchar |\n+---------------+---------+\ncustomer_id is the primary key for this table.\nThis table contains information about the customers.\n</code></pre>\n<p>Table:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| order_date    | date    |\n| customer_id   | int     |\n| product_id    | int     |\n+---------------+---------+\norder_id is the primary key for this table.\nThis table contains information about the orders made by customer_id.\nThere will be no product ordered by the same user more than once in one day.\n</code></pre>\n<p>Table:  <code>Products</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| product_name  | varchar |\n| price         | int     |\n+---------------+---------+\nproduct_id is the primary key for this table.\nThis table contains information about the Products.\n</code></pre>\n<p>Write an SQL query to find the most recent order(s) of each product.</p>\n<p>Return the result table sorted by  <code>product_name</code>  in <strong>ascending</strong> order and in case of a tie by the  <code>product_id</code>  in <strong>ascending</strong> order. If there still a tie, order them by the  <code>order_id</code>  in <strong>ascending</strong> order.</p>\n<p>The query result format is in the following example:</p>\n<pre><code>Customers\n+-------------+-----------+\n| customer_id | name      |\n+-------------+-----------+\n| 1           | Winston   |\n| 2           | Jonathan  |\n| 3           | Annabelle |\n| 4           | Marwan    |\n| 5           | Khaled    |\n+-------------+-----------+\n\nOrders\n+----------+------------+-------------+------------+\n| order_id | order_date | customer_id | product_id |\n+----------+------------+-------------+------------+\n| 1        | 2020-07-31 | 1           | 1          |\n| 2        | 2020-07-30 | 2           | 2          |\n| 3        | 2020-08-29 | 3           | 3          |\n| 4        | 2020-07-29 | 4           | 1          |\n| 5        | 2020-06-10 | 1           | 2          |\n| 6        | 2020-08-01 | 2           | 1          |\n| 7        | 2020-08-01 | 3           | 1          |\n| 8        | 2020-08-03 | 1           | 2          |\n| 9        | 2020-08-07 | 2           | 3          |\n| 10       | 2020-07-15 | 1           | 2          |\n+----------+------------+-------------+------------+\n\nProducts\n+------------+--------------+-------+\n| product_id | product_name | price |\n+------------+--------------+-------+\n| 1          | keyboard     | 120   |\n| 2          | mouse        | 80    |\n| 3          | screen       | 600   |\n| 4          | hard disk    | 450   |\n+------------+--------------+-------+\n\nResult table:\n+--------------+------------+----------+------------+\n| product_name | product_id | order_id | order_date |\n+--------------+------------+----------+------------+\n| keyboard     | 1          | 6        | 2020-08-01 |\n| keyboard     | 1          | 7        | 2020-08-01 |\n| mouse        | 2          | 8        | 2020-08-03 |\n| screen       | 3          | 3        | 2020-08-29 |\n+--------------+------------+----------+------------+\nkeyboard's most recent order is in 2020-08-01, it was ordered two times this day.\nmouse's most recent order is in 2020-08-03, it was ordered only once this day.\nscreen's most recent order is in 2020-08-29, it was ordered only once this day.\nThe hard disk was never ordered and we don't include it in the result table.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_name<span class=\"token punctuation\">,</span>product_id<span class=\"token punctuation\">,</span>order_id<span class=\"token punctuation\">,</span>order_date</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> product_name <span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">.</span>product_id <span class=\"token punctuation\">,</span>order_id<span class=\"token punctuation\">,</span>order_date <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> o<span class=\"token punctuation\">.</span>product_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> order_date <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Orders o <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Products p</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">on</span> o<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span>p<span class=\"token punctuation\">.</span>product_id </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> product_name<span class=\"token punctuation\">,</span>product_id<span class=\"token punctuation\">,</span>order_id</pre></td></tr></table></figure>",
            "tags": [
                "大数据",
                "Hive"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/kawaii/moments/%E5%8F%AF%E7%88%B1%E5%A5%B3%E9%AD%94%E5%A4%B4/",
            "url": "https://github.com/Mayizono/miyazono.github.io/kawaii/moments/%E5%8F%AF%E7%88%B1%E5%A5%B3%E9%AD%94%E5%A4%B4/",
            "title": "力扣数据库",
            "date_published": "2020-08-31T16:00:00.000Z",
            "content_html": "<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXNldC9kYXRhYmFzZS8=\">https://leetcode-cn.com/problemset/database/</span></p>\n<p>题目都是 leetcode 上了可以点击题目会有相应的链接</p>\n<p>由于个人比较喜欢用开窗函数，所以都优先用了开窗 ，当然这些并不一定都是最优解，答案仅供参考</p>\n<p>每道题后面都应相应的难度等级，如果没时间做的话 可以在 leetcode 按出题频率刷题</p>\n<p>我是安顺序刷的题，后续还会继续更新</p>\n<p>祝大家面试取得好的成绩</p>\n</blockquote>\n<h4 id=\"175-组合两个表\"><a class=\"anchor\" href=\"#175-组合两个表\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY29tYmluZS10d28tdGFibGVzLw==\">175. 组合两个表</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表 1:  <code>Person</code></p>\n<pre><code>+-------------+---------+\n| 列名         | 类型     |\n+-------------+---------+\n| PersonId    | int     |\n| FirstName   | varchar |\n| LastName    | varchar |\n+-------------+---------+\nPersonId 是上表主键\n</code></pre>\n<p>表 2:  <code>Address</code></p>\n<pre><code>+-------------+---------+\n| 列名         | 类型    |\n+-------------+---------+\n| AddressId   | int     |\n| PersonId    | int     |\n| City        | varchar |\n| State       | varchar |\n+-------------+---------+\nAddressId 是上表主键\n</code></pre>\n<p>编写一个 SQL 查询，满足条件：无论 person 是否有地址信息，都需要基于上述两表提供 person 的以下信息：</p>\n<pre><code>FirstName, LastName, City, State\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> FirstName<span class=\"token punctuation\">,</span>LastName<span class=\"token punctuation\">,</span>City<span class=\"token punctuation\">,</span>State</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Person  p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span>  Address a </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>PersonId <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>PersonId</pre></td></tr></table></figure><h4 id=\"176-第二高的薪水\"><a class=\"anchor\" href=\"#176-第二高的薪水\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2Vjb25kLWhpZ2hlc3Qtc2FsYXJ5Lw==\">176. 第二高的薪水</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>编写一个 SQL 查询，获取  <code>Employee</code>  表中第二高的薪水（Salary） 。</p>\n<pre><code>+----+--------+\n| Id | Salary |\n+----+--------+\n| 1  | 100    |\n| 2  | 200    |\n| 3  | 300    |\n+----+--------+\n</code></pre>\n<p>例如上述  <code>Employee</code>  表，SQL 查询应该返回  <code>200</code>  作为第二高的薪水。如果不存在第二高的薪水，那么查询应返回  <code>null</code> 。</p>\n<pre><code>+---------------------+\n| SecondHighestSalary |\n+---------------------+\n| 200                 |\n+---------------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    IFNULL<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span> Salary</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>       <span class=\"token keyword\">FROM</span> Employee</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>       <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> Salary <span class=\"token keyword\">DESC</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">1</span> <span class=\"token keyword\">OFFSET</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> SecondHighestSalary</pre></td></tr></table></figure><h4 id=\"177-第n高的薪水\"><a class=\"anchor\" href=\"#177-第n高的薪水\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbnRoLWhpZ2hlc3Qtc2FsYXJ5Lw==\">177. 第 N 高的薪水</span></h4>\n<p>难度中等</p>\n<p>编写一个 SQL 查询，获取  <code>Employee</code>  表中第 <em>n</em> 高的薪水（Salary）。</p>\n<pre><code>+----+--------+\n| Id | Salary |\n+----+--------+\n| 1  | 100    |\n| 2  | 200    |\n| 3  | 300    |\n+----+--------+\n</code></pre>\n<p>例如上述  <code>Employee</code>  表，<em>n = 2</em> 时，应返回第二高的薪水  <code>200</code> 。如果不存在第 <em>n</em> 高的薪水，那么查询应返回  <code>null</code> 。</p>\n<pre><code>+------------------------+\n| getNthHighestSalary(2) |\n+------------------------+\n| 200                    |\n+------------------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">FUNCTION</span> getNthHighestSalary<span class=\"token punctuation\">(</span>N <span class=\"token keyword\">INT</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">RETURNS</span> <span class=\"token keyword\">INT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">BEGIN</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">RETURN</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token keyword\">SELECT</span> IFNULL<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> salary  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token keyword\">select</span> salary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\trank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> salary <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token keyword\">from</span> Employee</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> salary</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t<span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token keyword\">where</span> rk<span class=\"token operator\">=</span>N<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span> SecondHighestSalary</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">END</span></pre></td></tr></table></figure><h4 id=\"178-分数排名\"><a class=\"anchor\" href=\"#178-分数排名\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmFuay1zY29yZXMv\">178. 分数排名</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>编写一个 SQL 查询来实现分数排名。</p>\n<p>如果两个分数相同，则两个分数排名（Rank）相同。请注意，平分后的下一个名次应该是下一个连续的整数值。换句话说，名次之间不应该有 “间隔”。</p>\n<pre><code>+----+-------+\n| Id | Score |\n+----+-------+\n| 1  | 3.50  |\n| 2  | 3.65  |\n| 3  | 4.00  |\n| 4  | 3.85  |\n| 5  | 4.00  |\n| 6  | 3.65  |\n+----+-------+\n</code></pre>\n<p>例如，根据上述给定的  <code>Scores</code>  表，你的查询应该返回（按分数从高到低排列）：</p>\n<pre><code>+-------+------+\n| Score | Rank |\n+-------+------+\n| 4.00  | 1    |\n| 4.00  | 1    |\n| 3.85  | 2    |\n| 3.65  | 3    |\n| 3.65  | 3    |\n| 3.50  | 4    |\n+-------+------+\n</code></pre>\n<p>** 重要提示：** 对于 MySQL 解决方案，如果要转义用作列名的保留字，可以在关键字之前和之后使用撇号。例如 <strong> <code>Rank</code> </strong></p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Score<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dense_rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Score <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">`</span>rank<span class=\"token punctuation\">`</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> Scores</pre></td></tr></table></figure><h4 id=\"180-连续出现的数字\"><a class=\"anchor\" href=\"#180-连续出现的数字\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY29uc2VjdXRpdmUtbnVtYmVycy8=\">180. 连续出现的数字</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>编写一个 SQL 查询，查找所有至少连续出现三次的数字。</p>\n<pre><code>+----+-----+\n| Id | Num |\n+----+-----+\n| 1  |  1  |\n| 2  |  1  |\n| 3  |  1  |\n| 4  |  2  |\n| 5  |  1  |\n| 6  |  2  |\n| 7  |  2  |\n+----+-----+\n</code></pre>\n<p>例如，给定上面的  <code>Logs</code>  表，  <code>1</code>  是唯一连续出现至少三次的数字。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------------+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span> ConsecutiveNums <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">1</span>               <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> Num ConsecutiveNums</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Num<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>lead<span class=\"token punctuation\">(</span>Num<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> n2<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>lead<span class=\"token punctuation\">(</span>Num<span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> n3</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> Logs</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">where</span> Num <span class=\"token operator\">=</span> n2 <span class=\"token operator\">and</span> Num <span class=\"token operator\">=</span> n3</pre></td></tr></table></figure><h4 id=\"181-超过经理收入的员工\"><a class=\"anchor\" href=\"#181-超过经理收入的员工\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZW1wbG95ZWVzLWVhcm5pbmctbW9yZS10aGFuLXRoZWlyLW1hbmFnZXJzLw==\">181. 超过经理收入的员工</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p><code>Employee</code>  表包含所有员工，他们的经理也属于员工。每个员工都有一个 Id，此外还有一列对应员工的经理的 Id。</p>\n<pre><code>+----+-------+--------+-----------+\n| Id | Name  | Salary | ManagerId |\n+----+-------+--------+-----------+\n| 1  | Joe   | 70000  | 3         |\n| 2  | Henry | 80000  | 4         |\n| 3  | Sam   | 60000  | NULL      |\n| 4  | Max   | 90000  | NULL      |\n+----+-------+--------+-----------+\n</code></pre>\n<p>给定  <code>Employee</code>  表，编写一个 SQL 查询，该查询可以获取收入超过他们经理的员工的姓名。在上面的表格中，Joe 是唯一一个收入超过他的经理的员工。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span> Employee <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> Joe      <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>Name  Employee </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Employee a </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">join</span> Employee b</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>ManagerId <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> a<span class=\"token punctuation\">.</span>Salary<span class=\"token operator\">></span>b<span class=\"token punctuation\">.</span>Salary</pre></td></tr></table></figure><h4 id=\"182-查找重复的电子邮箱\"><a class=\"anchor\" href=\"#182-查找重复的电子邮箱\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZHVwbGljYXRlLWVtYWlscy8=\">182. 查找重复的电子邮箱</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>编写一个 SQL 查询，查找  <code>Person</code>  表中所有重复的电子邮箱。</p>\n<p><strong>示例：</strong></p>\n<pre><code>+----+---------+\n| Id | Email   |\n+----+---------+\n| 1  | a@b.com |\n| 2  | c@d.com |\n| 3  | a@b.com |\n+----+---------+\n</code></pre>\n<p>根据以上输入，你的查询应返回以下结果：</p>\n<pre><code>+---------+\n| Email   |\n+---------+\n| a@b.com |\n+---------+\n</code></pre>\n<p>** 说明：** 所有电子邮箱都是小写字母。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Email</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Person</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> Email</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"183-从不订购的客户\"><a class=\"anchor\" href=\"#183-从不订购的客户\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3VzdG9tZXJzLXdoby1uZXZlci1vcmRlci8=\">183. 从不订购的客户</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>某网站包含两个表， <code>Customers</code>  表和  <code>Orders</code>  表。编写一个 SQL 查询，找出所有从不订购任何东西的客户。</p>\n<p><code>Customers</code>  表：</p>\n<pre><code>+----+-------+\n| Id | Name  |\n+----+-------+\n| 1  | Joe   |\n| 2  | Henry |\n| 3  | Sam   |\n| 4  | Max   |\n+----+-------+\n</code></pre>\n<p><code>Orders</code>  表：</p>\n<pre><code>+----+------------+\n| Id | CustomerId |\n+----+------------+\n| 1  | 3          |\n| 2  | 1          |\n+----+------------+\n</code></pre>\n<p>例如给定上述表格，你的查询应返回：</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span> Customers <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> Henry     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> Max       <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">-----------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  c<span class=\"token punctuation\">.</span>Name Customers</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Customers  c <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Orders  o</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> c<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> o<span class=\"token punctuation\">.</span>CustomerId</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span> o<span class=\"token punctuation\">.</span>id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span></pre></td></tr></table></figure><h4 id=\"184-部门工资最高的员工\"><a class=\"anchor\" href=\"#184-部门工资最高的员工\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZGVwYXJ0bWVudC1oaWdoZXN0LXNhbGFyeS8=\">184. 部门工资最高的员工</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Employee</code>  表包含所有员工信息，每个员工有其对应的 Id, salary 和 department Id。</p>\n<pre><code>+----+-------+--------+--------------+\n| Id | Name  | Salary | DepartmentId |\n+----+-------+--------+--------------+\n| 1  | Joe   | 70000  | 1            |\n| 2  | Henry | 80000  | 2            |\n| 3  | Sam   | 60000  | 2            |\n| 4  | Max   | 90000  | 1            |\n+----+-------+--------+--------------+\n</code></pre>\n<p><code>Department</code>  表包含公司所有部门的信息。</p>\n<pre><code>+----+----------+\n| Id | Name     |\n+----+----------+\n| 1  | IT       |\n| 2  | Sales    |\n+----+----------+\n</code></pre>\n<p>编写一个 SQL 查询，找出每个部门工资最高的员工。例如，根据上述给定的表格，Max 在 IT 部门有最高工资，Henry 在 Sales 部门有最高工资。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+----------+--------+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span> Department <span class=\"token operator\">|</span> Employee <span class=\"token operator\">|</span> Salary <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+----------+--------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> IT         <span class=\"token operator\">|</span> Max      <span class=\"token operator\">|</span> <span class=\"token number\">90000</span>  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> Sales      <span class=\"token operator\">|</span> Henry    <span class=\"token operator\">|</span> <span class=\"token number\">80000</span>  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+----------+--------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Department<span class=\"token punctuation\">,</span>Employee<span class=\"token punctuation\">,</span>Salary</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> d<span class=\"token punctuation\">.</span>Name  Department<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>Name Employee<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>Salary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> d<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Salary <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Employee e <span class=\"token keyword\">join</span> Department d</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">on</span> e<span class=\"token punctuation\">.</span>DepartmentId<span class=\"token operator\">=</span>d<span class=\"token punctuation\">.</span>id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>tmp</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"185-部门工资前三高的所有员工\"><a class=\"anchor\" href=\"#185-部门工资前三高的所有员工\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZGVwYXJ0bWVudC10b3AtdGhyZWUtc2FsYXJpZXMv\">185. 部门工资前三高的所有员工</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Employee</code>  表包含所有员工信息，每个员工有其对应的工号  <code>Id</code> ，姓名  <code>Name</code> ，工资  <code>Salary</code>  和部门编号  <code>DepartmentId</code>  。</p>\n<pre><code>+----+-------+--------+--------------+\n| Id | Name  | Salary | DepartmentId |\n+----+-------+--------+--------------+\n| 1  | Joe   | 85000  | 1            |\n| 2  | Henry | 80000  | 2            |\n| 3  | Sam   | 60000  | 2            |\n| 4  | Max   | 90000  | 1            |\n| 5  | Janet | 69000  | 1            |\n| 6  | Randy | 85000  | 1            |\n| 7  | Will  | 70000  | 1            |\n+----+-------+--------+--------------+\n</code></pre>\n<p><code>Department</code>  表包含公司所有部门的信息。</p>\n<pre><code>+----+----------+\n| Id | Name     |\n+----+----------+\n| 1  | IT       |\n| 2  | Sales    |\n+----+----------+\n</code></pre>\n<p>编写一个 SQL 查询，找出每个部门获得前三高工资的所有员工。例如，根据上述给定的表，查询结果应返回：</p>\n<pre><code>+------------+----------+--------+\n| Department | Employee | Salary |\n+------------+----------+--------+\n| IT         | Max      | 90000  |\n| IT         | Randy    | 85000  |\n| IT         | Joe      | 85000  |\n| IT         | Will     | 70000  |\n| Sales      | Henry    | 80000  |\n| Sales      | Sam      | 60000  |\n+------------+----------+--------+\n</code></pre>\n<p><strong>解释：</strong></p>\n<p>IT 部门中，Max 获得了最高的工资，Randy 和 Joe 都拿到了第二高的工资，Will 的工资排第三。销售部门（Sales）只有两名员工，Henry 的工资最高，Sam 的工资排第二。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Department<span class=\"token punctuation\">,</span>Employee<span class=\"token punctuation\">,</span>Salary</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> d<span class=\"token punctuation\">.</span>Name  Department<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>Name Employee<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>Salary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dense_rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> d<span class=\"token punctuation\">.</span>id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Salary <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Employee e <span class=\"token keyword\">join</span> Department d</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">on</span> e<span class=\"token punctuation\">.</span>DepartmentId<span class=\"token operator\">=</span>d<span class=\"token punctuation\">.</span>id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>tmp</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">&lt;=</span><span class=\"token number\">3</span></pre></td></tr></table></figure><h4 id=\"196-删除重复的电子邮箱\"><a class=\"anchor\" href=\"#196-删除重复的电子邮箱\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZGVsZXRlLWR1cGxpY2F0ZS1lbWFpbHMv\">196. 删除重复的电子邮箱</span></h4>\n<p>难度简单</p>\n<p>编写一个 SQL 查询，来删除  <code>Person</code>  表中所有重复的电子邮箱，重复的邮箱里只保留 <strong>Id</strong> <em>最小</em> 的那个。</p>\n<pre><code>+----+------------------+\n| Id | Email            |\n+----+------------------+\n| 1  | john@example.com |\n| 2  | bob@example.com  |\n| 3  | john@example.com |\n+----+------------------+\nId 是这个表的主键。\n</code></pre>\n<p>例如，在运行你的查询语句之后，上面的  <code>Person</code>  表应返回以下几行:</p>\n<pre><code>+----+------------------+\n| Id | Email            |\n+----+------------------+\n| 1  | john@example.com |\n| 2  | bob@example.com  |\n+----+------------------+\n</code></pre>\n<p><strong>提示：</strong></p>\n<ul>\n<li>\n<p>执行 SQL 之后，输出是整个  <code>Person</code>  表。</p>\n</li>\n<li>\n<p>使用  <code>delete</code>  语句。</p>\n</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">DELETE</span> p1 <span class=\"token keyword\">FROM</span> Person p1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Person p2</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">WHERE</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    p1<span class=\"token punctuation\">.</span>Email <span class=\"token operator\">=</span> p2<span class=\"token punctuation\">.</span>Email <span class=\"token operator\">AND</span> p1<span class=\"token punctuation\">.</span>Id <span class=\"token operator\">></span> p2<span class=\"token punctuation\">.</span>Id</pre></td></tr></table></figure><blockquote>\n<p>注意是删除 ，不是查询</p>\n</blockquote>\n<h4 id=\"197-上升的温度\"><a class=\"anchor\" href=\"#197-上升的温度\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmlzaW5nLXRlbXBlcmF0dXJlLw==\">197. 上升的温度</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>给定一个  <code>Weather</code>  表，编写一个 SQL 查询，来查找与之前（昨天的）日期相比温度更高的所有日期的 Id。</p>\n<pre><code>+---------+------------------+------------------+\n| Id(INT) | RecordDate(DATE) | Temperature(INT) |\n+---------+------------------+------------------+\n|       1 |       2015-01-01 |               10 |\n|       2 |       2015-01-02 |               25 |\n|       3 |       2015-01-03 |               20 |\n|       4 |       2015-01-04 |               30 |\n+---------+------------------+------------------+\n</code></pre>\n<p>例如，根据上述给定的  <code>Weather</code>  表格，返回如下 Id:</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span> Id <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Id</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">select</span> Id<span class=\"token punctuation\">,</span>RecordDate<span class=\"token punctuation\">,</span>Temperature<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>lag<span class=\"token punctuation\">(</span>RecordDate<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">9999</span><span class=\"token operator\">-</span><span class=\"token number\">99</span><span class=\"token operator\">-</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> RecordDate<span class=\"token punctuation\">)</span> yd<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>lag<span class=\"token punctuation\">(</span>Temperature<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">999</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> RecordDate <span class=\"token punctuation\">)</span> yt</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> Weather </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span>tmp</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">where</span> Temperature <span class=\"token operator\">></span>yt</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">and</span> datediff<span class=\"token punctuation\">(</span>RecordDate<span class=\"token punctuation\">,</span>yd<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"262-行程和用户\"><a class=\"anchor\" href=\"#262-行程和用户\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdHJpcHMtYW5kLXVzZXJzLw==\">262. 行程和用户</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Trips</code>  表中存所有出租车的行程信息。每段行程有唯一键 Id，Client_Id 和 Driver_Id 是  <code>Users</code>  表中 Users_Id 的外键。Status 是枚举类型，枚举成员为 (‘completed’, ‘cancelled_by_driver’, ‘cancelled_by_client’)。</p>\n<pre><code>+----+-----------+-----------+---------+--------------------+----------+\n| Id | Client_Id | Driver_Id | City_Id |        Status      |Request_at|\n+----+-----------+-----------+---------+--------------------+----------+\n| 1  |     1     |    10     |    1    |     completed      |2013-10-01|\n| 2  |     2     |    11     |    1    | cancelled_by_driver|2013-10-01|\n| 3  |     3     |    12     |    6    |     completed      |2013-10-01|\n| 4  |     4     |    13     |    6    | cancelled_by_client|2013-10-01|\n| 5  |     1     |    10     |    1    |     completed      |2013-10-02|\n| 6  |     2     |    11     |    6    |     completed      |2013-10-02|\n| 7  |     3     |    12     |    6    |     completed      |2013-10-02|\n| 8  |     2     |    12     |    12   |     completed      |2013-10-03|\n| 9  |     3     |    10     |    12   |     completed      |2013-10-03| \n| 10 |     4     |    13     |    12   | cancelled_by_driver|2013-10-03|\n+----+-----------+-----------+---------+--------------------+----------+\n</code></pre>\n<p><code>Users</code>  表存所有用户。每个用户有唯一键 Users_Id。Banned 表示这个用户是否被禁止，Role 则是一个表示（‘client’, ‘driver’, ‘partner’）的枚举类型。</p>\n<pre><code>+----------+--------+--------+\n| Users_Id | Banned |  Role  |\n+----------+--------+--------+\n|    1     |   No   | client |\n|    2     |   Yes  | client |\n|    3     |   No   | client |\n|    4     |   No   | client |\n|    10    |   No   | driver |\n|    11    |   No   | driver |\n|    12    |   No   | driver |\n|    13    |   No   | driver |\n+----------+--------+--------+\n</code></pre>\n<p>写一段 SQL 语句查出 <strong>2013 年 10 月 1 日</strong> 至 <strong>2013 年 10 月 3 日</strong> 期间非禁止用户的取消率。基于上表，你的 SQL 语句应返回如下结果，取消率（Cancellation Rate）保留两位小数。</p>\n<p>取消率的计算方式如下：(被司机或乘客取消的非禁止用户生成的订单数量) / (非禁止用户生成的订单总数)</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+-------------------+</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">|</span>     <span class=\"token keyword\">Day</span>    <span class=\"token operator\">|</span> Cancellation Rate <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+-------------------+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2013</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token operator\">|</span>       <span class=\"token number\">0.33</span>        <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2013</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">02</span> <span class=\"token operator\">|</span>       <span class=\"token number\">0.00</span>        <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2013</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">03</span> <span class=\"token operator\">|</span>       <span class=\"token number\">0.50</span>        <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------------+-------------------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> T<span class=\"token punctuation\">.</span>request_at <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">Day</span><span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t\t<span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span><span class=\"token keyword\">STATUS</span> <span class=\"token operator\">=</span> <span class=\"token string\">'completed'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t\t<span class=\"token operator\">/</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t<span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span><span class=\"token keyword\">STATUS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">`</span>Cancellation Rate<span class=\"token punctuation\">`</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">FROM</span> trips <span class=\"token keyword\">AS</span> T</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">WHERE</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>T<span class=\"token punctuation\">.</span>Client_Id <span class=\"token operator\">NOT</span> <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">SELECT</span> users_id</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">FROM</span> users</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token keyword\">WHERE</span> banned <span class=\"token operator\">=</span> <span class=\"token string\">'Yes'</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">AND</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>T<span class=\"token punctuation\">.</span>Driver_Id <span class=\"token operator\">NOT</span> <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">SELECT</span> users_id</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token keyword\">FROM</span> users</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">WHERE</span> banned <span class=\"token operator\">=</span> <span class=\"token string\">'Yes'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token operator\">AND</span> T<span class=\"token punctuation\">.</span>request_at <span class=\"token operator\">BETWEEN</span> <span class=\"token string\">'2013-10-01'</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'2013-10-03'</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> T<span class=\"token punctuation\">.</span>request_at</pre></td></tr></table></figure><h4 id=\"511-游戏玩法分析-i\"><a class=\"anchor\" href=\"#511-游戏玩法分析-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2FtZS1wbGF5LWFuYWx5c2lzLWkv\">511. 游戏玩法分析 I</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>活动表  <code>Activity</code> ：</p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| player_id    | int     |\n| device_id    | int     |\n| event_date   | date    |\n| games_played | int     |\n+--------------+---------+\n表的主键是 (player_id, event_date)。\n这张表展示了一些游戏玩家在游戏平台上的行为活动。\n每行数据记录了一名玩家在退出平台之前，当天使用同一台设备登录平台后打开的游戏的数目（可能是 0 个）。\n</code></pre>\n<p>写一条 SQL 查询语句获取每位玩家 <strong>第一次登陆平台的日期</strong>。</p>\n<p>查询结果的格式如下所示：</p>\n<pre><code>Activity 表：\n+-----------+-----------+------------+--------------+\n| player_id | device_id | event_date | games_played |\n+-----------+-----------+------------+--------------+\n| 1         | 2         | 2016-03-01 | 5            |\n| 1         | 2         | 2016-05-02 | 6            |\n| 2         | 3         | 2017-06-25 | 1            |\n| 3         | 1         | 2016-03-02 | 0            |\n| 3         | 4         | 2018-07-03 | 5            |\n+-----------+-----------+------------+--------------+\n\nResult 表：\n+-----------+-------------+\n| player_id | first_login |\n+-----------+-------------+\n| 1         | 2016-03-01  |\n| 2         | 2017-06-25  |\n| 3         | 2016-03-02  |\n+-----------+-------------+\n</code></pre>\n<ol>\n<li></li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> player_id <span class=\"token punctuation\">,</span>event_date first_login</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> player_id <span class=\"token punctuation\">,</span>event_date<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> player_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> event_date<span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span> tmp</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><p>2. 最优 （选最小日期）</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> player_id <span class=\"token punctuation\">,</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>event_date<span class=\"token punctuation\">)</span> first_login</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> player_id</pre></td></tr></table></figure><h4 id=\"512-游戏玩法分析-ii\"><a class=\"anchor\" href=\"#512-游戏玩法分析-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2FtZS1wbGF5LWFuYWx5c2lzLWlpLw==\">512. 游戏玩法分析 II</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Activity</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| player_id    | int     |\n| device_id    | int     |\n| event_date   | date    |\n| games_played | int     |\n+--------------+---------+\n(player_id, event_date) 是这个表的两个主键\n这个表显示的是某些游戏玩家的游戏活动情况\n每一行是在某天使用某个设备登出之前登录并玩多个游戏（可能为0）的玩家的记录\n</code></pre>\n<p>请编写一个 SQL 查询，描述每一个玩家首次登陆的设备名称</p>\n<p>查询结果格式在以下示例中：</p>\n<pre><code>Activity table:\n+-----------+-----------+------------+--------------+\n| player_id | device_id | event_date | games_played |\n+-----------+-----------+------------+--------------+\n| 1         | 2         | 2016-03-01 | 5            |\n| 1         | 2         | 2016-05-02 | 6            |\n| 2         | 3         | 2017-06-25 | 1            |\n| 3         | 1         | 2016-03-02 | 0            |\n| 3         | 4         | 2018-07-03 | 5            |\n+-----------+-----------+------------+--------------+\n\nResult table:\n+-----------+-----------+\n| player_id | device_id |\n+-----------+-----------+\n| 1         | 2         |\n| 2         | 3         |\n| 3         | 1         |\n+-----------+-----------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> player_id <span class=\"token punctuation\">,</span>device_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> player_id <span class=\"token punctuation\">,</span>event_date<span class=\"token punctuation\">,</span>device_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> player_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> event_date<span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span> tmp</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"534-游戏玩法分析-iii\"><a class=\"anchor\" href=\"#534-游戏玩法分析-iii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2FtZS1wbGF5LWFuYWx5c2lzLWlpaS8=\">534. 游戏玩法分析 III</span></h4>\n<p>难度中等 20 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Activity</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| player_id    | int     |\n| device_id    | int     |\n| event_date   | date    |\n| games_played | int     |\n+--------------+---------+\n（player_id，event_date）是此表的主键。\n这张表显示了某些游戏的玩家的活动情况。\n每一行是一个玩家的记录，他在某一天使用某个设备注销之前登录并玩了很多游戏（可能是 0 ）。\n</code></pre>\n<p>编写一个 SQL 查询，同时报告每组玩家和日期，以及玩家到目前为止玩了多少游戏。也就是说，在此日期之前玩家所玩的游戏总数。详细情况请查看示例。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Activity table:\n+-----------+-----------+------------+--------------+\n| player_id | device_id | event_date | games_played |\n+-----------+-----------+------------+--------------+\n| 1         | 2         | 2016-03-01 | 5            |\n| 1         | 2         | 2016-05-02 | 6            |\n| 1         | 3         | 2017-06-25 | 1            |\n| 3         | 1         | 2016-03-02 | 0            |\n| 3         | 4         | 2018-07-03 | 5            |\n+-----------+-----------+------------+--------------+\n\nResult table:\n+-----------+------------+---------------------+\n| player_id | event_date | games_played_so_far |\n+-----------+------------+---------------------+\n| 1         | 2016-03-01 | 5                   |\n| 1         | 2016-05-02 | 11                  |\n| 1         | 2017-06-25 | 12                  |\n| 3         | 2016-03-02 | 0                   |\n| 3         | 2018-07-03 | 5                   |\n+-----------+------------+---------------------+\n对于 ID 为 1 的玩家，2016-05-02 共玩了 5+6=11 个游戏，2017-06-25 共玩了 5+6+1=12 个游戏。\n对于 ID 为 3 的玩家，2018-07-03 共玩了 0+5=5 个游戏。\n请注意，对于每个玩家，我们只关心玩家的登录日期。\n</code></pre>\n<p>开窗</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> player_id<span class=\"token punctuation\">,</span>event_date <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>games_played<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> player_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span>  event_date <span class=\"token punctuation\">)</span>games_played_so_far</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr></table></figure><p>自连接</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    a1<span class=\"token punctuation\">.</span>player_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    a1<span class=\"token punctuation\">.</span>event_date<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>a2<span class=\"token punctuation\">.</span>games_played<span class=\"token punctuation\">)</span> games_played_so_far</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Activity a1<span class=\"token punctuation\">,</span>Activity a2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">where</span> a1<span class=\"token punctuation\">.</span>player_id<span class=\"token operator\">=</span>a2<span class=\"token punctuation\">.</span>player_id <span class=\"token operator\">and</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      a1<span class=\"token punctuation\">.</span>event_date<span class=\"token operator\">>=</span>a2<span class=\"token punctuation\">.</span>event_date</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"550-游戏玩法分析-iv\"><a class=\"anchor\" href=\"#550-游戏玩法分析-iv\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2FtZS1wbGF5LWFuYWx5c2lzLWl2Lw==\">550. 游戏玩法分析 IV</span></h4>\n<p>难度中等 17 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Activity</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| player_id    | int     |\n| device_id    | int     |\n| event_date   | date    |\n| games_played | int     |\n+--------------+---------+\n（player_id，event_date）是此表的主键。\n这张表显示了某些游戏的玩家的活动情况。\n每一行是一个玩家的记录，他在某一天使用某个设备注销之前登录并玩了很多游戏（可能是 0）。\n</code></pre>\n<p>编写一个 SQL 查询，报告在首次登录的第二天再次登录的玩家的分数，四舍五入到小数点后两位。换句话说，您需要计算从首次登录日期开始至少连续两天登录的玩家的数量，然后除以玩家总数。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Activity table:\n+-----------+-----------+------------+--------------+\n| player_id | device_id | event_date | games_played |\n+-----------+-----------+------------+--------------+\n| 1         | 2         | 2016-03-01 | 5            |\n| 1         | 2         | 2016-03-02 | 6            |\n| 2         | 3         | 2017-06-25 | 1            |\n| 3         | 1         | 2016-03-02 | 0            |\n| 3         | 4         | 2018-07-03 | 5            |\n+-----------+-----------+------------+--------------+\n\nResult table:\n+-----------+\n| fraction  |\n+-----------+\n| 0.33      |\n+-----------+\n只有 ID 为 1 的玩家在第一天登录后才重新登录，所以答案是 1/3 = 0.33\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>event_date <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> fraction</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> player_id<span class=\"token punctuation\">,</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>event_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> login</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">from</span> activity</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> player_id<span class=\"token punctuation\">)</span> p </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> activity a </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">on</span> p<span class=\"token punctuation\">.</span>player_id<span class=\"token operator\">=</span>a<span class=\"token punctuation\">.</span>player_id <span class=\"token operator\">and</span> datediff<span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>event_date<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>login<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><blockquote>\n<p>这个 avg 用的妙</p>\n<p>is not null 判断后，有 eventdate 值的返回 1，null 的返回 0，avg 相当于求和后 (即符合条件的 id 个数) 除以总 id 数即所求比例</p>\n</blockquote>\n<h4 id=\"569-员工薪水中位数\"><a class=\"anchor\" href=\"#569-员工薪水中位数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbWVkaWFuLWVtcGxveWVlLXNhbGFyeS8=\">569. 员工薪水中位数</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Employee</code>  表包含所有员工。 <code>Employee</code>  表有三列：员工 Id，公司名和薪水。</p>\n<pre><code>+-----+------------+--------+\n|Id   | Company    | Salary |\n+-----+------------+--------+\n|1    | A          | 2341   |\n|2    | A          | 341    |\n|3    | A          | 15     |\n|4    | A          | 15314  |\n|5    | A          | 451    |\n|6    | A          | 513    |\n|7    | B          | 15     |\n|8    | B          | 13     |\n|9    | B          | 1154   |\n|10   | B          | 1345   |\n|11   | B          | 1221   |\n|12   | B          | 234    |\n|13   | C          | 2345   |\n|14   | C          | 2645   |\n|15   | C          | 2645   |\n|16   | C          | 2652   |\n|17   | C          | 65     |\n+-----+------------+--------+\n</code></pre>\n<p>请编写 SQL 查询来查找每个公司的薪水中位数。挑战点：你是否可以在不使用任何内置的 SQL 函数的情况下解决此问题。</p>\n<pre><code>+-----+------------+--------+\n|Id   | Company    | Salary |\n+-----+------------+--------+\n|5    | A          | 451    |\n|6    | A          | 513    |\n|12   | B          | 234    |\n|9    | B          | 1154   |\n|14   | C          | 2645   |\n+-----+------------+--------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Id<span class=\"token punctuation\">,</span>Company<span class=\"token punctuation\">,</span>Salary</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> Id<span class=\"token punctuation\">,</span>Company<span class=\"token punctuation\">,</span>Salary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ROW_NUMBER<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> Company <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Salary<span class=\"token punctuation\">)</span> rk<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> Company<span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Employee</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cnt <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> FLOOR<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cnt <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><blockquote>\n<p>中位数：</p>\n<p>+1 向下取整 +2 向下取整数</p>\n</blockquote>\n<h4 id=\"570-至少有5名直接下属的经理\"><a class=\"anchor\" href=\"#570-至少有5名直接下属的经理\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbWFuYWdlcnMtd2l0aC1hdC1sZWFzdC01LWRpcmVjdC1yZXBvcnRzLw==\">570. 至少有 5 名直接下属的经理</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Employee</code>  表包含所有员工和他们的经理。每个员工都有一个 Id，并且还有一列是经理的 Id。</p>\n<pre><code>+------+----------+-----------+----------+\n|Id    |Name \t  |Department |ManagerId |\n+------+----------+-----------+----------+\n|101   |John \t  |A \t      |null      |\n|102   |Dan \t  |A \t      |101       |\n|103   |James \t  |A \t      |101       |\n|104   |Amy \t  |A \t      |101       |\n|105   |Anne \t  |A \t      |101       |\n|106   |Ron \t  |B \t      |101       |\n+------+----------+-----------+----------+\n</code></pre>\n<p>给定  <code>Employee</code>  表，请编写一个 SQL 查询来查找至少有 5 名直接下属的经理。对于上表，您的 SQL 查询应该返回：</p>\n<pre><code>+-------+\n| Name  |\n+-------+\n| John  |\n+-------+\n</code></pre>\n<p><strong>注意:</strong><br />\n 没有人是自己的下属。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Employee</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> Id <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> ManagerId</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Employee</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> ManagerId</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"571-给定数字的频率查询中位数\"><a class=\"anchor\" href=\"#571-给定数字的频率查询中位数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC1tZWRpYW4tZ2l2ZW4tZnJlcXVlbmN5LW9mLW51bWJlcnMv\">571. 给定数字的频率查询中位数</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Numbers</code>  表保存数字的值及其频率。</p>\n<pre><code>+----------+-------------+\n|  Number  |  Frequency  |\n+----------+-------------|\n|  0       |  7          |\n|  1       |  1          |\n|  2       |  3          |\n|  3       |  1          |\n+----------+-------------+\n</code></pre>\n<p>在此表中，数字为  <code>0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 3</code> ，所以中位数是  <code>(0 + 0) / 2 = 0</code> 。</p>\n<pre><code>+--------+\n| median |\n+--------|\n| 0.0000 |\n+--------+\n</code></pre>\n<p>请编写一个查询来查找所有数字的中位数并将结果命名为  <code>median</code>  。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>number <span class=\"token keyword\">as</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> median</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            Number<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            Frequency<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>Frequency<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Number<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> Frequency prev_sum<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>Frequency<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> Number<span class=\"token punctuation\">)</span> curr_sum</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">from</span> Numbers</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">)</span> t1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>Frequency<span class=\"token punctuation\">)</span> total_sum</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">from</span> Numbers</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">)</span> t2</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">where</span> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    t1<span class=\"token punctuation\">.</span>prev_sum <span class=\"token operator\">&lt;=</span> <span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">.</span>total_sum <span class=\"token keyword\">as</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">and</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    t1<span class=\"token punctuation\">.</span>curr_sum <span class=\"token operator\">>=</span> <span class=\"token punctuation\">(</span>cast<span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">.</span>total_sum <span class=\"token keyword\">as</span> <span class=\"token keyword\">float</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>如果 n1.Number 为中位数，n1.Number（包含本身）前累计的数字应大于等于总数 / 2 同时 n1.Number（不包含本身）前累计数字应小于等于总数 / 2</p>\n<p>例如：0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 3 共 12 个数</p>\n<p>中位数 0（包含本身）前累计的数字 7 &gt;=6  0（不包含本身）前累计数字 0 &lt;=6<br />\n 例如：0，0，0，3，3，3 共 6 个数</p>\n<p>中位数 0（包含本身）前累计的数字 3 &gt;=3  0（不包含本身）前累计数字 0 &lt;=3</p>\n<p>中位数 3（包含本身）前累计的数字 6 &gt;=3  3（不包含本身）前累计数字 3 &lt;=3</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">AVG</span><span class=\"token punctuation\">(</span>Number<span class=\"token punctuation\">)</span>median </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> n1<span class=\"token punctuation\">.</span>Number <span class=\"token keyword\">FROM</span> Numbers n1 <span class=\"token keyword\">JOIN</span> Numbers n2 <span class=\"token keyword\">ON</span> n1<span class=\"token punctuation\">.</span>Number<span class=\"token operator\">>=</span>n2<span class=\"token punctuation\">.</span>Number </pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre> n1<span class=\"token punctuation\">.</span>Number </pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token keyword\">HAVING</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>n2<span class=\"token punctuation\">.</span>Frequency<span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>Frequency<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> Numbers<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token operator\">AND</span> </pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>n2<span class=\"token punctuation\">.</span>Frequency<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token function\">AVG</span><span class=\"token punctuation\">(</span>n1<span class=\"token punctuation\">.</span>Frequency<span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;=</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>Frequency<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> Numbers<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span>s</pre></td></tr></table></figure><h4 id=\"574-当选者\"><a class=\"anchor\" href=\"#574-当选者\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvd2lubmluZy1jYW5kaWRhdGUv\">574. 当选者</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Candidate</code></p>\n<pre><code>+-----+---------+\n| id  | Name    |\n+-----+---------+\n| 1   | A       |\n| 2   | B       |\n| 3   | C       |\n| 4   | D       |\n| 5   | E       |\n+-----+---------+  \n</code></pre>\n<p>表:  <code>Vote</code></p>\n<pre><code>+-----+--------------+\n| id  | CandidateId  |\n+-----+--------------+\n| 1   |     2        |\n| 2   |     4        |\n| 3   |     3        |\n| 4   |     2        |\n| 5   |     5        |\n+-----+--------------+\nid 是自动递增的主键，\nCandidateId 是 Candidate 表中的 id.\n</code></pre>\n<p>请编写 sql 语句来找到当选者的名字，上面的例子将返回当选者  <code>B</code> .</p>\n<pre><code>+------+\n| Name |\n+------+\n| B    |\n+------+\n</code></pre>\n<p>用了 order by 全局排序 不够好</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Name</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> Candidate c</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Vote v</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">on</span> c<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> v<span class=\"token punctuation\">.</span>CandidateId</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> Name</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><p>先过滤再  效率高很多</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Candidate</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> id <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">select</span> CandidateId</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span>    </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">select</span> CandidateId<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> CandidateId <span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">from</span> Vote</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> cnt <span class=\"token keyword\">desc</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"577-员工奖金\"><a class=\"anchor\" href=\"#577-员工奖金\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZW1wbG95ZWUtYm9udXMv\">577. 员工奖金</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>选出所有 bonus &lt; 1000 的员工的 name 及其 bonus。</p>\n<p><code>Employee</code>  表单</p>\n<pre><code>+-------+--------+-----------+--------+\n| empId |  name  | supervisor| salary |\n+-------+--------+-----------+--------+\n|   1   | John   |  3        | 1000   |\n|   2   | Dan    |  3        | 2000   |\n|   3   | Brad   |  null     | 4000   |\n|   4   | Thomas |  3        | 4000   |\n+-------+--------+-----------+--------+\nempId 是这张表单的主关键字\n</code></pre>\n<p><code>Bonus</code>  表单</p>\n<pre><code>+-------+-------+\n| empId | bonus |\n+-------+-------+\n| 2     | 500   |\n| 4     | 2000  |\n+-------+-------+\nempId 是这张表单的主关键字\n</code></pre>\n<p>输出示例：</p>\n<pre><code>+-------+-------+\n| name  | bonus |\n+-------+-------+\n| John  | null  |\n| Dan   | 500   |\n| Brad  | null  |\n+-------+-------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span>bonus</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Employee e</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Bonus b <span class=\"token keyword\">on</span>  e<span class=\"token punctuation\">.</span>empId<span class=\"token operator\">=</span>b<span class=\"token punctuation\">.</span>empId</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span> bonus<span class=\"token operator\">&lt;</span><span class=\"token number\">1000</span> <span class=\"token operator\">or</span> bonus <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span></pre></td></tr></table></figure><h4 id=\"578-查询回答率最高的问题\"><a class=\"anchor\" href=\"#578-查询回答率最高的问题\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2V0LWhpZ2hlc3QtYW5zd2VyLXJhdGUtcXVlc3Rpb24v\">578. 查询回答率最高的问题</span></h4>\n<p>难度中等 3 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>从  <code>survey_log</code>  表中获得回答率最高的问题， <code>survey_log</code>  表包含这些列 **：id**, <strong>action</strong>, <strong>question_id</strong>, <strong>answer_id</strong>, <strong>q_num</strong>, <strong>timestamp</strong>。</p>\n<p>id 表示用户 id；action 有以下几种值：&quot;show&quot;，&quot;answer&quot;，&quot;skip&quot;；当 action 值为 &quot;answer&quot; 时 answer_id 非空，而 action 值为 &quot;show&quot; 或者 &quot;skip&quot; 时 answer_id 为空；q_num 表示当前会话中问题的编号。</p>\n<p>请编写 SQL 查询来找到具有最高回答率的问题。</p>\n<p><strong>示例：</strong></p>\n<pre><code>输入：\n+------+-----------+--------------+------------+-----------+------------+\n| id   | action    | question_id  | answer_id  | q_num     | timestamp  |\n+------+-----------+--------------+------------+-----------+------------+\n| 5    | show      | 285          | null       | 1         | 123        |\n| 5    | answer    | 285          | 124124     | 1         | 124        |\n| 5    | show      | 369          | null       | 2         | 125        |\n| 5    | skip      | 369          | null       | 2         | 126        |\n+------+-----------+--------------+------------+-----------+------------+\n输出：\n+-------------+\n| survey_log  |\n+-------------+\n|    285      |\n+-------------+\n解释：\n问题 285 的回答率为 1/1，而问题 369 回答率为 0/1，因此输出 285 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> question_id  survey_log</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      question_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'answer'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> AnswerCnt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'show'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> ShowCnt</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      survey_log</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> question_id</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> tbl</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token punctuation\">(</span>AnswerCnt <span class=\"token operator\">/</span> ShowCnt<span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><p>直接不嵌套</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> question_id  survey_log</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> survey_log</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> question_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'answer'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'show'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"579-查询员工的累计薪水\"><a class=\"anchor\" href=\"#579-查询员工的累计薪水\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC1jdW11bGF0aXZlLXNhbGFyeS1vZi1hbi1lbXBsb3llZS8=\">579. 查询员工的累计薪水</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><strong>Employee</strong> 表保存了一年内的薪水信息。</p>\n<p>请你编写 SQL 语句，对于每个员工，查询他除最近一个月（即最大月）之外，剩下每个月的近三个月的累计薪水（不足三个月也要计算）。</p>\n<p>结果请按  <code>Id</code>  升序，然后按  <code>Month</code>  降序显示。</p>\n<p><strong>示例：</strong><br />\n<strong>输入：</strong></p>\n<table>\n<thead>\n<tr>\n<th>Id</th>\n<th>Month</th>\n<th>Salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>20</td>\n</tr>\n<tr>\n<td>2</td>\n<td>1</td>\n<td>20</td>\n</tr>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>30</td>\n</tr>\n<tr>\n<td>2</td>\n<td>2</td>\n<td>30</td>\n</tr>\n<tr>\n<td>3</td>\n<td>2</td>\n<td>40</td>\n</tr>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>40</td>\n</tr>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>60</td>\n</tr>\n<tr>\n<td>1</td>\n<td>4</td>\n<td>60</td>\n</tr>\n<tr>\n<td>3</td>\n<td>4</td>\n<td>70</td>\n</tr>\n</tbody>\n</table>\n<p><strong>输出：</strong></p>\n<table>\n<thead>\n<tr>\n<th>Id</th>\n<th>Month</th>\n<th>Salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>90</td>\n</tr>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>50</td>\n</tr>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>20</td>\n</tr>\n<tr>\n<td>2</td>\n<td>1</td>\n<td>20</td>\n</tr>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>100</td>\n</tr>\n<tr>\n<td>3</td>\n<td>2</td>\n<td>40</td>\n</tr>\n</tbody>\n</table>\n<p><strong>解释：</strong></p>\n<p>员工 '1' 除去最近一个月（月份 '4'），有三个月的薪水记录：月份 '3' 薪水为 40，月份 '2' 薪水为 30，月份 '1' 薪水为 20。</p>\n<p>所以近 3 个月的薪水累计分别为 (40 + 30 + 20) = 90，(30 + 20) = 50 和 20。</p>\n<table>\n<thead>\n<tr>\n<th>Id</th>\n<th>Month</th>\n<th>Salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>90</td>\n</tr>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>50</td>\n</tr>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>20</td>\n</tr>\n</tbody>\n</table>\n<p>员工 '2' 除去最近的一个月（月份 '2'）的话，只有月份 '1' 这一个月的薪水记录。</p>\n<table>\n<thead>\n<tr>\n<th>Id</th>\n<th>Month</th>\n<th>Salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>2</td>\n<td>1</td>\n<td>20</td>\n</tr>\n</tbody>\n</table>\n<p>员工 '3' 除去最近一个月（月份 '4'）后有两个月，分别为：月份 '4' 薪水为 60 和 月份 '2' 薪水为 40。所以各月的累计情况如下：</p>\n<table>\n<thead>\n<tr>\n<th>Id</th>\n<th>Month</th>\n<th>Salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>100</td>\n</tr>\n<tr>\n<td>3</td>\n<td>2</td>\n<td>40</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> Id<span class=\"token punctuation\">,</span><span class=\"token keyword\">Month</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>Salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> Id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">Month</span> <span class=\"token keyword\">ROWS</span> <span class=\"token operator\">BETWEEN</span> <span class=\"token number\">2</span> <span class=\"token keyword\">PRECEDING</span> <span class=\"token operator\">AND</span> <span class=\"token keyword\">CURRENT</span> <span class=\"token keyword\">ROW</span><span class=\"token punctuation\">)</span> Salary</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> Id<span class=\"token punctuation\">,</span><span class=\"token keyword\">Month</span><span class=\"token punctuation\">,</span>Salary<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    lead<span class=\"token punctuation\">(</span><span class=\"token keyword\">Month</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> Id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">Month</span><span class=\"token punctuation\">)</span> lm</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">from</span> Employee </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span> lm <span class=\"token operator\">!=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span>  Id<span class=\"token punctuation\">,</span><span class=\"token keyword\">Month</span> <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><h4 id=\"580-统计各专业学生人数\"><a class=\"anchor\" href=\"#580-统计各专业学生人数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY291bnQtc3R1ZGVudC1udW1iZXItaW4tZGVwYXJ0bWVudHMv\">580. 统计各专业学生人数</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>一所大学有 2 个数据表，分别是 <em><strong>student</strong></em> 和 <em><strong>department</strong></em> ，这两个表保存着每个专业的学生数据和院系数据。</p>\n<p>写一个查询语句，查询 <em><strong>department</strong></em> 表中每个专业的学生人数 （即使没有学生的专业也需列出）。</p>\n<p>将你的查询结果按照学生人数降序排列。 如果有两个或两个以上专业有相同的学生数目，将这些部门按照部门名字的字典序从小到大排列。</p>\n<p>*<strong>student*</strong> 表格如下：</p>\n<table>\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>student_id</td>\n<td>Integer</td>\n</tr>\n<tr>\n<td>student_name</td>\n<td>String</td>\n</tr>\n<tr>\n<td>gender</td>\n<td>Character</td>\n</tr>\n<tr>\n<td>dept_id</td>\n<td>Integer</td>\n</tr>\n</tbody>\n</table>\n<p>其中， student_id 是学生的学号， student_name 是学生的姓名， gender 是学生的性别， dept_id 是学生所属专业的专业编号。</p>\n<p>*<strong>department*</strong> 表格如下：</p>\n<table>\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>dept_id</td>\n<td>Integer</td>\n</tr>\n<tr>\n<td>dept_name</td>\n<td>String</td>\n</tr>\n</tbody>\n</table>\n<p>dept_id 是专业编号， dept_name 是专业名字。</p>\n<p>这里是一个示例输入：<br />\n*<strong>student*</strong> 表格：</p>\n<table>\n<thead>\n<tr>\n<th>student_id</th>\n<th>student_name</th>\n<th>gender</th>\n<th>dept_id</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>Jack</td>\n<td>M</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2</td>\n<td>Jane</td>\n<td>F</td>\n<td>1</td>\n</tr>\n<tr>\n<td>3</td>\n<td>Mark</td>\n<td>M</td>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>*<strong>department*</strong> 表格：</p>\n<table>\n<thead>\n<tr>\n<th>dept_id</th>\n<th>dept_name</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>Engineering</td>\n</tr>\n<tr>\n<td>2</td>\n<td>Science</td>\n</tr>\n<tr>\n<td>3</td>\n<td>Law</td>\n</tr>\n</tbody>\n</table>\n<p>示例输出为：</p>\n<table>\n<thead>\n<tr>\n<th>dept_name</th>\n<th>student_number</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Engineering</td>\n<td>2</td>\n</tr>\n<tr>\n<td>Science</td>\n<td>1</td>\n</tr>\n<tr>\n<td>Law</td>\n<td>0</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  dept_name <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span>student_id<span class=\"token punctuation\">)</span> student_number</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> department d <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> student s</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> d<span class=\"token punctuation\">.</span>dept_id<span class=\"token operator\">=</span>s<span class=\"token punctuation\">.</span>dept_id </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> dept_name</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> student_number <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><h4 id=\"584-寻找用户推荐人\"><a class=\"anchor\" href=\"#584-寻找用户推荐人\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC1jdXN0b21lci1yZWZlcmVlLw==\">584. 寻找用户推荐人</span></h4>\n<p>难度简单 9 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>给定表  <code>customer</code>  ，里面保存了所有客户信息和他们的推荐人。</p>\n<pre><code>+------+------+-----------+\n| id   | name | referee_id|\n+------+------+-----------+\n|    1 | Will |      NULL |\n|    2 | Jane |      NULL |\n|    3 | Alex |         2 |\n|    4 | Bill |      NULL |\n|    5 | Zack |         1 |\n|    6 | Mark |         2 |\n+------+------+-----------+\n</code></pre>\n<p>写一个查询语句，返回一个编号列表，列表中编号的推荐人的编号都 <strong>不是</strong> 2。</p>\n<p>对于上面的示例数据，结果为：</p>\n<pre><code>+------+\n| name |\n+------+\n| Will |\n| Jane |\n| Bill |\n| Zack |\n+------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> name <span class=\"token keyword\">FROM</span> customer <span class=\"token keyword\">WHERE</span> referee_id <span class=\"token operator\">!=</span> <span class=\"token number\">2</span> <span class=\"token operator\">OR</span> referee_id <span class=\"token operator\">IS</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><blockquote>\n<p>MySQL 使用三值逻辑 —— TRUE, FALSE 和 UNKNOWN。任何与 NULL 值进行的比较都会与第三种值 UNKNOWN 做比较。这个 “任何值” 包括 NULL 本身！这就是为什么 MySQL 提供 IS NULL 和 IS NOT NULL 两种操作来对 NULL 特殊判断。</p>\n<p>因此，在 WHERE 语句中我们需要做一个额外的条件判断 `referee_id IS NULL'。</p>\n</blockquote>\n<h4 id=\"585-2016年的投资\"><a class=\"anchor\" href=\"#585-2016年的投资\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvaW52ZXN0bWVudHMtaW4tMjAxNi8=\">585. 2016 年的投资</span></h4>\n<p>难度中等 14 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>写一个查询语句，将 2016 年 (<strong>TIV_2016</strong>) 所有成功投资的金额加起来，保留 2 位小数。</p>\n<p>对于一个投保人，他在 2016 年成功投资的条件是：</p>\n<ol>\n<li>他在 2015 年的投保额 (<strong>TIV_2015</strong>) 至少跟一个其他投保人在 2015 年的投保额相同。</li>\n<li>他所在的城市必须与其他投保人都不同（也就是说维度和经度不能跟其他任何一个投保人完全相同）。</li>\n</ol>\n<p><strong>输入格式:</strong><br />\n 表 *<strong>insurance*</strong> 格式如下：</p>\n<table>\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>PID</td>\n<td>INTEGER(11)</td>\n</tr>\n<tr>\n<td>TIV_2015</td>\n<td>NUMERIC(15,2)</td>\n</tr>\n<tr>\n<td>TIV_2016</td>\n<td>NUMERIC(15,2)</td>\n</tr>\n<tr>\n<td>LAT</td>\n<td>NUMERIC(5,2)</td>\n</tr>\n<tr>\n<td>LON</td>\n<td>NUMERIC(5,2)</td>\n</tr>\n</tbody>\n</table>\n<p><strong>PID</strong> 字段是投保人的投保编号， <strong>TIV_2015</strong> 是该投保人在 2015 年的总投保金额， <strong>TIV_2016</strong> 是该投保人在 2016 年的投保金额， <strong>LAT</strong> 是投保人所在城市的维度， <strong>LON</strong> 是投保人所在城市的经度。</p>\n<p><strong>样例输入</strong></p>\n<table>\n<thead>\n<tr>\n<th>PID</th>\n<th>TIV_2015</th>\n<th>TIV_2016</th>\n<th>LAT</th>\n<th>LON</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>10</td>\n<td>5</td>\n<td>10</td>\n<td>10</td>\n</tr>\n<tr>\n<td>2</td>\n<td>20</td>\n<td>20</td>\n<td>20</td>\n<td>20</td>\n</tr>\n<tr>\n<td>3</td>\n<td>10</td>\n<td>30</td>\n<td>20</td>\n<td>20</td>\n</tr>\n<tr>\n<td>4</td>\n<td>10</td>\n<td>40</td>\n<td>40</td>\n<td>40</td>\n</tr>\n</tbody>\n</table>\n<p><strong>样例输出</strong></p>\n<table>\n<thead>\n<tr>\n<th>TIV_2016</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>45.00</td>\n</tr>\n</tbody>\n</table>\n<p><strong>解释</strong></p>\n<pre><code>就如最后一个投保人，第一个投保人同时满足两个条件：\n1. 他在 2015 年的投保金额 TIV_2015 为 '10' ，与第三个和第四个投保人在 2015 年的投保金额相同。\n2. 他所在城市的经纬度是独一无二的。\n\n第二个投保人两个条件都不满足。他在 2015 年的投资 TIV_2015 与其他任何投保人都不相同。\n且他所在城市的经纬度与第三个投保人相同。基于同样的原因，第三个投保人投资失败。\n\n所以返回的结果是第一个投保人和最后一个投保人的 TIV_2016 之和，结果是 45 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>TIV_2016<span class=\"token punctuation\">)</span> TIV_2016</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> PID<span class=\"token punctuation\">,</span>TIV_2016<span class=\"token punctuation\">,</span>cnt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> loc <span class=\"token punctuation\">)</span> lcnt</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">select</span> PID<span class=\"token punctuation\">,</span>TIV_2016<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>TIV_2015<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> TIV_2015 <span class=\"token punctuation\">)</span> cnt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        concat_ws<span class=\"token punctuation\">(</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">,</span>LAT<span class=\"token punctuation\">,</span>LON<span class=\"token punctuation\">)</span> loc</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">from</span> insurance </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">where</span> lcnt<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> cnt<span class=\"token operator\">!=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><blockquote>\n<p>注意去重顺序 不要先对 TIV_2015 去重  不然 local 去重时会丢失数据</p>\n</blockquote>\n<p>优化 窗口</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>TIV_2016<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> TIV_2016</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> TIV_2015<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> cnt_1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> LAT<span class=\"token punctuation\">,</span> LON<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> cnt_2</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        insurance</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span> a </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">WHERE</span> a<span class=\"token punctuation\">.</span>cnt_1 <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>cnt_2 <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span></pre></td></tr></table></figure><h4 id=\"586-订单最多的客户\"><a class=\"anchor\" href=\"#586-订单最多的客户\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3VzdG9tZXItcGxhY2luZy10aGUtbGFyZ2VzdC1udW1iZXItb2Ytb3JkZXJzLw==\">586. 订单最多的客户</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>在表 <strong>orders</strong> 中找到订单数最多客户对应的 <strong>customer_number</strong> 。</p>\n<p>数据保证订单数最多的顾客恰好只有一位。</p>\n<p>表 *<strong>orders*</strong> 定义如下：</p>\n<table>\n<thead>\n<tr>\n<th>Column</th>\n<th>Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>order_number (PK)</td>\n<td>int</td>\n</tr>\n<tr>\n<td>customer_number</td>\n<td>int</td>\n</tr>\n<tr>\n<td>order_date</td>\n<td>date</td>\n</tr>\n<tr>\n<td>required_date</td>\n<td>date</td>\n</tr>\n<tr>\n<td>shipped_date</td>\n<td>date</td>\n</tr>\n<tr>\n<td>status</td>\n<td>char(15)</td>\n</tr>\n<tr>\n<td>comment</td>\n<td>char(200)</td>\n</tr>\n</tbody>\n</table>\n<p><strong>样例输入</strong></p>\n<table>\n<thead>\n<tr>\n<th>order_number</th>\n<th>customer_number</th>\n<th>order_date</th>\n<th>required_date</th>\n<th>shipped_date</th>\n<th>status</th>\n<th>comment</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>2017-04-09</td>\n<td>2017-04-13</td>\n<td>2017-04-12</td>\n<td>Closed</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>2</td>\n<td>2017-04-15</td>\n<td>2017-04-20</td>\n<td>2017-04-18</td>\n<td>Closed</td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>2017-04-16</td>\n<td>2017-04-25</td>\n<td>2017-04-20</td>\n<td>Closed</td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td>3</td>\n<td>2017-04-18</td>\n<td>2017-04-28</td>\n<td>2017-04-25</td>\n<td>Closed</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p><strong>样例输出</strong></p>\n<table>\n<thead>\n<tr>\n<th>customer_number</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<p><strong>解释</strong></p>\n<pre><code>customer_number 为 '3' 的顾客有两个订单，比顾客 '1' 或者 '2' 都要多，因为他们只有一个订单\n所以结果是该顾客的 customer_number ，也就是 3 。\n</code></pre>\n<p><strong>进阶：</strong> 如果有多位顾客订单数并列最多，你能找到他们所有的 customer_number 吗？</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> customer_number</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> orders</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_number </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>  <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><blockquote>\n<p>如果 数据量很大 order by 不太好</p>\n</blockquote>\n<h4 id=\"595-大的国家\"><a class=\"anchor\" href=\"#595-大的国家\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYmlnLWNvdW50cmllcy8=\">595. 大的国家</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>这里有张  <code>World</code>  表</p>\n<pre><code>+-----------------+------------+------------+--------------+---------------+\n| name            | continent  | area       | population   | gdp           |\n+-----------------+------------+------------+--------------+---------------+\n| Afghanistan     | Asia       | 652230     | 25500100     | 20343000      |\n| Albania         | Europe     | 28748      | 2831741      | 12960000      |\n| Algeria         | Africa     | 2381741    | 37100000     | 188681000     |\n| Andorra         | Europe     | 468        | 78115        | 3712000       |\n| Angola          | Africa     | 1246700    | 20609294     | 100990000     |\n+-----------------+------------+------------+--------------+---------------+\n</code></pre>\n<p>如果一个国家的面积超过 300 万平方公里，或者人口超过 2500 万，那么这个国家就是大国家。</p>\n<p>编写一个 SQL 查询，输出表中所有大国家的名称、人口和面积。</p>\n<p>例如，根据上表，我们应该输出:</p>\n<pre><code>+--------------+-------------+--------------+\n| name         | population  | area         |\n+--------------+-------------+--------------+\n| Afghanistan  | 25500100    | 652230       |\n| Algeria      | 37100000    | 2381741      |\n+--------------+-------------+--------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  name <span class=\"token punctuation\">,</span>population<span class=\"token punctuation\">,</span>area  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> World</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> area  <span class=\"token operator\">></span><span class=\"token number\">3000000</span> <span class=\"token operator\">or</span> population <span class=\"token operator\">></span><span class=\"token number\">25000000</span></pre></td></tr></table></figure><h4 id=\"596-超过5名学生的课\"><a class=\"anchor\" href=\"#596-超过5名学生的课\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY2xhc3Nlcy1tb3JlLXRoYW4tNS1zdHVkZW50cy8=\">596. 超过 5 名学生的课</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>有一个 <code>courses</code>  表 ，有: <strong>student (学生)</strong> 和 <strong>class (课程)</strong>。</p>\n<p>请列出所有超过或等于 5 名学生的课。</p>\n<p>例如，表:</p>\n<pre><code>+---------+------------+\n| student | class      |\n+---------+------------+\n| A       | Math       |\n| B       | English    |\n| C       | Math       |\n| D       | Biology    |\n| E       | Math       |\n| F       | Computer   |\n| G       | Math       |\n| H       | Math       |\n| I       | Math       |\n+---------+------------+\n</code></pre>\n<p>应该输出:</p>\n<pre><code>+---------+\n| class   |\n+---------+\n| Math    |\n+---------+\n</code></pre>\n<p><strong>Note:</strong><br />\n 学生在每个课中不应被重复计算。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  class </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> courses</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> class </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> student<span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">5</span></pre></td></tr></table></figure><blockquote>\n<p>一个学生可能多次选课。。记得 distinct</p>\n</blockquote>\n<h4 id=\"597-好友申请-i-总体通过率\"><a class=\"anchor\" href=\"#597-好友申请-i-总体通过率\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZnJpZW5kLXJlcXVlc3RzLWktb3ZlcmFsbC1hY2NlcHRhbmNlLXJhdGUv\">597. 好友申请 I ：总体通过率</span></h4>\n<p>难度简单 21 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>在 Facebook 或者 Twitter 这样的社交应用中，人们经常会发好友申请也会收到其他人的好友申请。现在给如下两个表：</p>\n<p>表： friend_request</p>\n<table>\n<thead>\n<tr>\n<th>sender_id</th>\n<th>send_to_id</th>\n<th>request_date</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>2016_06-01</td>\n</tr>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>2016_06-01</td>\n</tr>\n<tr>\n<td>1</td>\n<td>4</td>\n<td>2016_06-01</td>\n</tr>\n<tr>\n<td>2</td>\n<td>3</td>\n<td>2016_06-02</td>\n</tr>\n<tr>\n<td>3</td>\n<td>4</td>\n<td>2016-06-09</td>\n</tr>\n</tbody>\n</table>\n<p>表： request_accepted</p>\n<table>\n<thead>\n<tr>\n<th>requester_id</th>\n<th>accepter_id</th>\n<th>accept_date</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>2016_06-03</td>\n</tr>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>2016-06-08</td>\n</tr>\n<tr>\n<td>2</td>\n<td>3</td>\n<td>2016-06-08</td>\n</tr>\n<tr>\n<td>3</td>\n<td>4</td>\n<td>2016-06-09</td>\n</tr>\n<tr>\n<td>3</td>\n<td>4</td>\n<td>2016-06-10</td>\n</tr>\n</tbody>\n</table>\n<p>写一个查询语句，求出好友申请的通过率，用 2 位小数表示。通过率由接受好友申请的数目除以申请总数。</p>\n<p>对于上面的样例数据，你的查询语句应该返回如下结果。</p>\n<table>\n<thead>\n<tr>\n<th>accept_rate</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0.80</td>\n</tr>\n</tbody>\n</table>\n<p>注意:</p>\n<p>通过的好友申请不一定都在表 friend_request 中。在这种情况下，你只需要统计总的被通过的申请数（不管它们在不在原来的申请中），并将它除以申请总数，得到通过率<br />\n一个好友申请发送者有可能会给接受者发几条好友申请，也有可能一个好友申请会被通过好几次。这种情况下，重复的好友申请只统计一次。<br />\n如果一个好友申请都没有，通过率为 0.00 。</p>\n<p>解释： 总共有 5 个申请，其中 4 个是不重复且被通过的好友申请，所以成功率是 0.80 。</p>\n<p>进阶:</p>\n<p>你能写一个查询语句得到每个月的通过率吗？<br />\n你能求出每一天的累计通过率吗？</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">round</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ifnull<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> requester_id<span class=\"token punctuation\">,</span> accepter_id <span class=\"token keyword\">from</span> request_accepted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> A<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> sender_id<span class=\"token punctuation\">,</span> send_to_id <span class=\"token keyword\">from</span> friend_request<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> B<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> accept_rate<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"601-体育馆的人流量\"><a class=\"anchor\" href=\"#601-体育馆的人流量\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvaHVtYW4tdHJhZmZpYy1vZi1zdGFkaXVtLw==\">601. 体育馆的人流量</span></h4>\n<p>难度困难 113 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>X 市建了一个新的体育馆，每日人流量信息被记录在这三列信息中：<strong>序号</strong> (id)、<strong>日期</strong> (visit_date)、 <strong>人流量</strong> (people)。</p>\n<p>请编写一个查询语句，找出人流量的高峰期。高峰期时，至少连续三行记录中的人流量不少于 100。</p>\n<p>例如，表  <code>stadium</code> ：</p>\n<pre><code>+------+------------+-----------+\n| id   | visit_date | people    |\n+------+------------+-----------+\n| 1    | 2017-01-01 | 10        |\n| 2    | 2017-01-02 | 109       |\n| 3    | 2017-01-03 | 150       |\n| 4    | 2017-01-04 | 99        |\n| 5    | 2017-01-05 | 145       |\n| 6    | 2017-01-06 | 1455      |\n| 7    | 2017-01-07 | 199       |\n| 8    | 2017-01-08 | 188       |\n+------+------------+-----------+\n</code></pre>\n<p>对于上面的示例数据，输出为：</p>\n<pre><code>+------+------------+-----------+\n| id   | visit_date | people    |\n+------+------------+-----------+\n| 5    | 2017-01-05 | 145       |\n| 6    | 2017-01-06 | 1455      |\n| 7    | 2017-01-07 | 199       |\n| 8    | 2017-01-08 | 188       |\n+------+------------+-----------+ \n</code></pre>\n<p><strong>提示：</strong><br />\n每天只有一行记录，日期随着 id 的增加而增加。</p>\n<p>3 表相连 (244 ms)</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> t1<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> stadium t1<span class=\"token punctuation\">,</span> stadium t2<span class=\"token punctuation\">,</span> stadium t3</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> t1<span class=\"token punctuation\">.</span>people <span class=\"token operator\">>=</span> <span class=\"token number\">100</span> <span class=\"token operator\">and</span> t2<span class=\"token punctuation\">.</span>people <span class=\"token operator\">>=</span> <span class=\"token number\">100</span> <span class=\"token operator\">and</span> t3<span class=\"token punctuation\">.</span>people <span class=\"token operator\">>=</span> <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">and</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token punctuation\">(</span>t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">and</span> t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">-- t1, t2, t3</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token operator\">or</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">and</span> t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">-- t2, t1, t3</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token operator\">or</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">(</span>t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> t2<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">-</span> t1<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">-- t3, t2, t1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> t1<span class=\"token punctuation\">.</span>id</pre></td></tr></table></figure><p>窗口函数 (272 ms)</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>visit_date<span class=\"token punctuation\">,</span>people <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">,</span>lead<span class=\"token punctuation\">(</span>people<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> ld</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">,</span>lead<span class=\"token punctuation\">(</span>people<span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> ld2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">,</span>visit_date</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">,</span>lag<span class=\"token punctuation\">(</span>people<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> lg</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">,</span>lag<span class=\"token punctuation\">(</span>people<span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> lg2</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">,</span>people</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">from</span> stadium</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>ld<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>lg<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>people<span class=\"token operator\">>=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">or</span> <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>ld<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>ld2<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>people<span class=\"token operator\">>=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token operator\">or</span> <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>lg<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>lg2<span class=\"token operator\">>=</span><span class=\"token number\">100</span> <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>people<span class=\"token operator\">>=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"602-好友申请-ii-谁有最多的好友\"><a class=\"anchor\" href=\"#602-好友申请-ii-谁有最多的好友\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZnJpZW5kLXJlcXVlc3RzLWlpLXdoby1oYXMtdGhlLW1vc3QtZnJpZW5kcy8=\">602. 好友申请 II ：谁有最多的好友</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>在 Facebook 或者 Twitter 这样的社交应用中，人们经常会发好友申请也会收到其他人的好友申请。</p>\n<p>表  <code>request_accepted</code>  存储了所有好友申请通过的数据记录，其中， <strong>requester_id</strong> 和 <strong>accepter_id</strong> 都是用户的编号。</p>\n<table>\n<thead>\n<tr>\n<th>requester_id</th>\n<th>accepter_id</th>\n<th>accept_date</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>2</td>\n<td>2016_06-03</td>\n</tr>\n<tr>\n<td>1</td>\n<td>3</td>\n<td>2016-06-08</td>\n</tr>\n<tr>\n<td>2</td>\n<td>3</td>\n<td>2016-06-08</td>\n</tr>\n<tr>\n<td>3</td>\n<td>4</td>\n<td>2016-06-09</td>\n</tr>\n</tbody>\n</table>\n<p>写一个查询语句，求出谁拥有最多的好友和他拥有的好友数目。对于上面的样例数据，结果为：</p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>num</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<p><strong>注意：</strong></p>\n<ul>\n<li>保证拥有最多好友数目的只有 1 个人。</li>\n<li>好友申请只会被接受一次，所以不会有 <strong>requester_id</strong> 和 <strong>accepter_id</strong> 值都相同的重复记录。</li>\n</ul>\n<p><strong>解释：</strong></p>\n<p>编号为 '3' 的人是编号为 '1'，'2' 和 '4' 的好友，所以他总共有 3 个好友，比其他人都多。</p>\n<p><strong>进阶：</strong></p>\n<p>在真实世界里，可能会有多个人拥有好友数相同且最多，你能找到所有这些人吗？</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> rid <span class=\"token keyword\">as</span> <span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span>aid<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token punctuation\">`</span>num<span class=\"token punctuation\">`</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> R1<span class=\"token punctuation\">.</span>requester_id <span class=\"token keyword\">as</span> rid<span class=\"token punctuation\">,</span>R1<span class=\"token punctuation\">.</span>accepter_id <span class=\"token keyword\">as</span> aid</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> request_accepted <span class=\"token keyword\">as</span> R1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">all</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">select</span> R2<span class=\"token punctuation\">.</span>accepter_id <span class=\"token keyword\">as</span> rid<span class=\"token punctuation\">,</span>R2<span class=\"token punctuation\">.</span>requester_id <span class=\"token keyword\">as</span> aid</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">from</span> request_accepted <span class=\"token keyword\">as</span> R2</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> A</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> rid</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> num <span class=\"token keyword\">desc</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"603-连续空余座位\"><a class=\"anchor\" href=\"#603-连续空余座位\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY29uc2VjdXRpdmUtYXZhaWxhYmxlLXNlYXRzLw==\">603. 连续空余座位</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>几个朋友来到电影院的售票处，准备预约连续空余座位。</p>\n<p>你能利用表  <code>cinema</code>  ，帮他们写一个查询语句，获取所有空余座位，并将它们按照 seat_id 排序后返回吗？</p>\n<table>\n<thead>\n<tr>\n<th>seat_id</th>\n<th>free</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2</td>\n<td>0</td>\n</tr>\n<tr>\n<td>3</td>\n<td>1</td>\n</tr>\n<tr>\n<td>4</td>\n<td>1</td>\n</tr>\n<tr>\n<td>5</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>对于如上样例，你的查询语句应该返回如下结果。</p>\n<table>\n<thead>\n<tr>\n<th>seat_id</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3</td>\n</tr>\n<tr>\n<td>4</td>\n</tr>\n<tr>\n<td>5</td>\n</tr>\n</tbody>\n</table>\n<p><strong>注意：</strong></p>\n<ul>\n<li>seat_id 字段是一个自增的整数，free 字段是布尔类型（'1' 表示空余， '0' 表示已被占据）。</li>\n<li>连续空余座位的定义是大于等于 2 个连续空余的座位。</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> seat_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> seat_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>lag<span class=\"token punctuation\">(</span>seat_id<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token operator\">-</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> seat_id<span class=\"token punctuation\">)</span> ls<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>lead<span class=\"token punctuation\">(</span>seat_id<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token operator\">-</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> seat_id<span class=\"token punctuation\">)</span> rs</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> cinema</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> free<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span>  seat_id<span class=\"token operator\">-</span>ls <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">or</span> rs<span class=\"token operator\">-</span>seat_id <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"607-销售员\"><a class=\"anchor\" href=\"#607-销售员\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2FsZXMtcGVyc29uLw==\">607. 销售员</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p><strong>描述</strong></p>\n<p>给定 3 个表：  <code>salesperson</code> ，  <code>company</code> ，  <code>orders</code> 。<br />\n输出所有表  <code>salesperson</code>  中，没有向公司 'RED' 销售任何东西的销售员。</p>\n<p><strong>示例：</strong><br />\n<strong>输入</strong></p>\n<p>表：  <code>salesperson</code></p>\n<pre><code>+----------+------+--------+-----------------+-----------+\n| sales_id | name | salary | commission_rate | hire_date |\n+----------+------+--------+-----------------+-----------+\n|   1      | John | 100000 |     6           | 4/1/2006  |\n|   2      | Amy  | 120000 |     5           | 5/1/2010  |\n|   3      | Mark | 65000  |     12          | 12/25/2008|\n|   4      | Pam  | 25000  |     25          | 1/1/2005  |\n|   5      | Alex | 50000  |     10          | 2/3/2007  |\n+----------+------+--------+-----------------+-----------+\n</code></pre>\n<p>表  <code>salesperson</code>  存储了所有销售员的信息。每个销售员都有一个销售员编号 <strong>sales_id</strong> 和他的名字 <strong>name</strong> 。</p>\n<p>表：  <code>company</code></p>\n<pre><code>+---------+--------+------------+\n| com_id  |  name  |    city    |\n+---------+--------+------------+\n|   1     |  RED   |   Boston   |\n|   2     | ORANGE |   New York |\n|   3     | YELLOW |   Boston   |\n|   4     | GREEN  |   Austin   |\n+---------+--------+------------+\n</code></pre>\n<p>表  <code>company</code>  存储了所有公司的信息。每个公司都有一个公司编号 <strong>com_id</strong> 和它的名字 <strong>name</strong> 。</p>\n<p>表：  <code>orders</code></p>\n<pre><code>+----------+------------+---------+----------+--------+\n| order_id | order_date | com_id  | sales_id | amount |\n+----------+------------+---------+----------+--------+\n| 1        |   1/1/2014 |    3    |    4     | 100000 |\n| 2        |   2/1/2014 |    4    |    5     | 5000   |\n| 3        |   3/1/2014 |    1    |    1     | 50000  |\n| 4        |   4/1/2014 |    1    |    4     | 25000  |\n+----------+----------+---------+----------+--------+\n</code></pre>\n<p>表  <code>orders</code>  存储了所有的销售数据，包括销售员编号 <strong>sales_id</strong> 和公司编号 <strong>com_id</strong> 。</p>\n<p><strong>输出</strong></p>\n<pre><code>+------+\n| name | \n+------+\n| Amy  | \n| Mark | \n| Alex |\n+------+\n</code></pre>\n<p><strong>解释</strong></p>\n<p>根据表  <code>orders</code>  中的订单 '3' 和 '4' ，容易看出只有 'John' 和 'Pam' 两个销售员曾经向公司 'RED' 销售过。</p>\n<p>所以我们需要输出表  <code>salesperson</code>  中所有其他人的名字。\\</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> salesperson</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> sales_id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> sales_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> orders</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">where</span> com_id <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">select</span> com_id </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">from</span> company</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">where</span> name <span class=\"token operator\">=</span><span class=\"token string\">'RED'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"608-树节点\"><a class=\"anchor\" href=\"#608-树节点\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdHJlZS1ub2RlLw==\">608. 树节点</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>给定一个表  <code>tree</code> ，<strong>id</strong> 是树节点的编号， <strong>p_id</strong> 是它父节点的 <strong>id 。</strong></p>\n<pre><code>+----+------+\n| id | p_id |\n+----+------+\n| 1  | null |\n| 2  | 1    |\n| 3  | 1    |\n| 4  | 2    |\n| 5  | 2    |\n+----+------+\n</code></pre>\n<p>树中每个节点属于以下三种类型之一：</p>\n<ul>\n<li>叶子：如果这个节点没有任何孩子节点。</li>\n<li>根：如果这个节点是整棵树的根，即没有父节点。</li>\n<li>内部节点：如果这个节点既不是叶子节点也不是根节点。</li>\n</ul>\n<p>写一个查询语句，输出所有节点的编号和节点的类型，并将结果按照节点编号排序。上面样例的结果为：</p>\n<pre><code>+----+------+\n| id | Type |\n+----+------+\n| 1  | Root |\n| 2  | Inner|\n| 3  | Leaf |\n| 4  | Leaf |\n| 5  | Leaf |\n+----+------+\n</code></pre>\n<p><strong>解释</strong></p>\n<ul>\n<li>\n<p>节点 '1' 是根节点，因为它的父节点是 NULL ，同时它有孩子节点 '2' 和 '3' 。</p>\n</li>\n<li>\n<p>节点 '2' 是内部节点，因为它有父节点 '1' ，也有孩子节点 '4' 和 '5' 。</p>\n</li>\n<li>\n<p>节点 '3', '4' 和 '5' 都是叶子节点，因为它们都有父节点同时没有孩子节点。</p>\n</li>\n<li>\n<p>样例中树的形态如下：</p>\n<p>​\t\t\t  1<br />\n​\t\t\t/   <br />\n​          2       3<br />\n​        /   <br />\n​     4       5</p>\n</li>\n</ul>\n<p><strong>注意</strong></p>\n<p>如果树中只有一个节点，你只需要输出它的根属性。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> p_id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">then</span> <span class=\"token string\">\"Root\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">when</span> id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> ifnull<span class=\"token punctuation\">(</span>p_id<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> tree<span class=\"token punctuation\">)</span> <span class=\"token keyword\">then</span> <span class=\"token string\">\"Leaf\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token string\">\"Inner\"</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span>  <span class=\"token keyword\">Type</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> tree</pre></td></tr></table></figure><h4 id=\"610-判断三角形\"><a class=\"anchor\" href=\"#610-判断三角形\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdHJpYW5nbGUtanVkZ2VtZW50Lw==\">610. 判断三角形</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>一个小学生 Tim 的作业是判断三条线段是否能形成一个三角形。</p>\n<p>然而，这个作业非常繁重，因为有几百组线段需要判断。</p>\n<p>假设表  <code>triangle</code>  保存了所有三条线段的三元组 x, y, z ，你能帮 Tim 写一个查询语句，来判断每个三元组是否可以组成一个三角形吗？</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>y</th>\n<th>z</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>13</td>\n<td>15</td>\n<td>30</td>\n</tr>\n<tr>\n<td>10</td>\n<td>20</td>\n<td>15</td>\n</tr>\n</tbody>\n</table>\n<p>对于如上样例数据，你的查询语句应该返回如下结果：</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>y</th>\n<th>z</th>\n<th>triangle</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>13</td>\n<td>15</td>\n<td>30</td>\n<td>No</td>\n</tr>\n<tr>\n<td>10</td>\n<td>20</td>\n<td>15</td>\n<td>Yes</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">+</span>y<span class=\"token operator\">></span>z <span class=\"token operator\">&amp;&amp;</span> x<span class=\"token operator\">+</span>z<span class=\"token operator\">></span>y <span class=\"token operator\">&amp;&amp;</span> y<span class=\"token operator\">+</span>z<span class=\"token operator\">></span>x<span class=\"token punctuation\">,</span><span class=\"token string\">'Yes'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'No'</span><span class=\"token punctuation\">)</span> triangle</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> triangle</pre></td></tr></table></figure><h4 id=\"612-平面上的最近距离\"><a class=\"anchor\" href=\"#612-平面上的最近距离\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2hvcnRlc3QtZGlzdGFuY2UtaW4tYS1wbGFuZS8=\">612. 平面上的最近距离</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表  <code>point_2d</code>  保存了所有点（多于 2 个点）的坐标 (x,y) ，这些点在平面上两两不重合。</p>\n<p>写一个查询语句找到两点之间的最近距离，保留 2 位小数。</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>y</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>-1</td>\n<td>-1</td>\n</tr>\n<tr>\n<td>0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>-1</td>\n<td>-2</td>\n</tr>\n</tbody>\n</table>\n<p>最近距离在点 (-1,-1) 和 (-1,2) 之间，距离为 1.00 。所以输出应该为：</p>\n<table>\n<thead>\n<tr>\n<th>shortest</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1.00</td>\n</tr>\n</tbody>\n</table>\n<p>** 注意：** 任意点之间的最远距离小于 10000 。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span>SQRT<span class=\"token punctuation\">(</span><span class=\"token function\">MIN</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>POW<span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p2<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> POW<span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> p2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> shortest</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    point_2d p1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    point_2d p2 <span class=\"token keyword\">ON</span> p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">!=</span> p2<span class=\"token punctuation\">.</span>x <span class=\"token operator\">OR</span> p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">!=</span> p2<span class=\"token punctuation\">.</span>y</pre></td></tr></table></figure><p>优化 ：减少重复计算</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span>SQRT<span class=\"token punctuation\">(</span><span class=\"token function\">MIN</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>POW<span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p2<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> POW<span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> p2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> shortest</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    point_2d p1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    point_2d p2 <span class=\"token keyword\">ON</span> <span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;=</span> p2<span class=\"token punctuation\">.</span>x <span class=\"token operator\">AND</span> p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">&lt;</span> p2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token operator\">OR</span> <span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;=</span> p2<span class=\"token punctuation\">.</span>x <span class=\"token operator\">AND</span> p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">></span> p2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token operator\">OR</span> <span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;</span> p2<span class=\"token punctuation\">.</span>x <span class=\"token operator\">AND</span> p1<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> p2<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"613-直线上的最近距离\"><a class=\"anchor\" href=\"#613-直线上的最近距离\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2hvcnRlc3QtZGlzdGFuY2UtaW4tYS1saW5lLw==\">613. 直线上的最近距离</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表  <code>point</code>  保存了一些点在 x 轴上的坐标，这些坐标都是整数。</p>\n<p>写一个查询语句，找到这些点中最近两个点之间的距离。</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>-1</td>\n</tr>\n<tr>\n<td>0</td>\n</tr>\n<tr>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>最近距离显然是 '1' ，是点 '-1' 和 '0' 之间的距离。所以输出应该如下：</p>\n<table>\n<thead>\n<tr>\n<th>shortest</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p>** 注意：** 每个点都与其他点坐标不同，表  <code>table</code>  不会有重复坐标出现。</p>\n<p>** 进阶：** 如果这些点在 x 轴上从左到右都有一个编号，输出结果时需要输出最近点对的编号呢？</p>\n<p>开窗方法 178m</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>l<span class=\"token operator\">-</span>x<span class=\"token punctuation\">)</span> shortest</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> x<span class=\"token punctuation\">,</span>lead<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> x<span class=\"token punctuation\">)</span> l</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token keyword\">point</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr></table></figure><p>join 方法 268m</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">MIN</span><span class=\"token punctuation\">(</span>ABS<span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p2<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> shortest</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">point</span> p1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">point</span> p2 <span class=\"token keyword\">ON</span> p1<span class=\"token punctuation\">.</span>x <span class=\"token operator\">!=</span> p2<span class=\"token punctuation\">.</span>x</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"614-二级关注者\"><a class=\"anchor\" href=\"#614-二级关注者\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2Vjb25kLWRlZ3JlZS1mb2xsb3dlci8=\">614. 二级关注者</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>在 facebook 中，表  <code>follow</code>  会有 2 个字段： <strong>followee</strong>, <strong>follower</strong> ，分别表示被关注者和关注者。</p>\n<p>请写一个 sql 查询语句，对每一个关注者，查询关注他的关注者的数目。</p>\n<p>比方说：</p>\n<pre><code>+-------------+------------+\n| followee    | follower   |\n+-------------+------------+\n|     A       |     B      |\n|     B       |     C      |\n|     B       |     D      |\n|     D       |     E      |\n+-------------+------------+\n</code></pre>\n<p>应该输出：</p>\n<pre><code>+-------------+------------+\n| follower    | num        |\n+-------------+------------+\n|     B       |  2         |\n|     D       |  1         |\n+-------------+------------+\n</code></pre>\n<p><strong>解释：</strong></p>\n<p>B 和 D 都在在 <strong>follower</strong> 字段中出现，作为被关注者，B 被 C 和 D 关注，D 被 E 关注。A 不在 <strong>follower</strong> 字段内，所以 A 不在输出列表中。</p>\n<p><strong>注意：</strong></p>\n<ul>\n<li>被关注者永远不会被他 / 她自己关注。</li>\n<li>将结果按照字典序返回。</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> followee follower<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> follower<span class=\"token punctuation\">)</span> num</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> follow</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> followee  <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> follower</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> follow</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> follower</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> followee</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> follower</pre></td></tr></table></figure><blockquote>\n<p>这里出现了重复关注 ，需要去重</p>\n</blockquote>\n<h4 id=\"615-平均工资部门与公司比较\"><a class=\"anchor\" href=\"#615-平均工资部门与公司比较\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYXZlcmFnZS1zYWxhcnktZGVwYXJ0bWVudHMtdnMtY29tcGFueS8=\">615. 平均工资：部门与公司比较</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>给如下两个表，写一个查询语句，求出在每一个工资发放日，每个部门的平均工资与公司的平均工资的比较结果 （高 / 低 / 相同）。</p>\n<p>表：  <code>salary</code></p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>employee_id</th>\n<th>amount</th>\n<th>pay_date</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>9000</td>\n<td>2017-03-31</td>\n</tr>\n<tr>\n<td>2</td>\n<td>2</td>\n<td>6000</td>\n<td>2017-03-31</td>\n</tr>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>10000</td>\n<td>2017-03-31</td>\n</tr>\n<tr>\n<td>4</td>\n<td>1</td>\n<td>7000</td>\n<td>2017-02-28</td>\n</tr>\n<tr>\n<td>5</td>\n<td>2</td>\n<td>6000</td>\n<td>2017-02-28</td>\n</tr>\n<tr>\n<td>6</td>\n<td>3</td>\n<td>8000</td>\n<td>2017-02-28</td>\n</tr>\n</tbody>\n</table>\n<p><strong>employee_id</strong> 字段是表  <code>employee</code>  中 <strong>employee_id</strong> 字段的外键。</p>\n<table>\n<thead>\n<tr>\n<th>employee_id</th>\n<th>department_id</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>2</td>\n<td>2</td>\n</tr>\n<tr>\n<td>3</td>\n<td>2</td>\n</tr>\n</tbody>\n</table>\n<p>对于如上样例数据，结果为：</p>\n<table>\n<thead>\n<tr>\n<th>pay_month</th>\n<th>department_id</th>\n<th>comparison</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>2017-03</td>\n<td>1</td>\n<td>higher</td>\n</tr>\n<tr>\n<td>2017-03</td>\n<td>2</td>\n<td>lower</td>\n</tr>\n<tr>\n<td>2017-02</td>\n<td>1</td>\n<td>same</td>\n</tr>\n<tr>\n<td>2017-02</td>\n<td>2</td>\n<td>same</td>\n</tr>\n</tbody>\n</table>\n<p><strong>解释</strong></p>\n<p>在三月，公司的平均工资是 (9000+6000+10000)/3 = 8333.33...</p>\n<p>由于部门 '1' 里只有一个 <strong>employee_id</strong> 为 '1' 的员工，所以部门 '1' 的平均工资就是此人的工资 9000 。因为 9000 &gt; 8333.33 ，所以比较结果是 'higher'。</p>\n<p>第二个部门的平均工资为 <strong>employee_id</strong> 为 '2' 和 '3' 两个人的平均工资，为 (6000+10000)/2=8000 。因为 8000 &lt; 8333.33 ，所以比较结果是 'lower' 。</p>\n<p>在二月用同样的公式求平均工资并比较，比较结果为'same' ，因为部门 '1' 和部门 '2' 的平均工资与公司的平均工资相同，都是 7000 。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    pay_month<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    department_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     <span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> avgs<span class=\"token operator\">></span>ts <span class=\"token keyword\">then</span> <span class=\"token string\">'higher'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">when</span> avgs<span class=\"token operator\">&lt;</span>ts <span class=\"token keyword\">then</span> <span class=\"token string\">'lower'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">else</span> <span class=\"token string\">'same'</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> comparison</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        date_format<span class=\"token punctuation\">(</span>pay_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span>pay_month<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        department_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> date_format<span class=\"token punctuation\">(</span>pay_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span>ts<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> date_format<span class=\"token punctuation\">(</span>pay_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>department_id<span class=\"token punctuation\">)</span> avgs</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">from</span> salary s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> employee e</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>employee_id <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>employee_id</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> pay_month<span class=\"token punctuation\">,</span> department_id</pre></td></tr></table></figure><blockquote>\n<p>也可以用 if</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>avgs<span class=\"token operator\">></span>ts<span class=\"token punctuation\">,</span><span class=\"token string\">'higher'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>avgs<span class=\"token operator\">=</span>ts<span class=\"token punctuation\">,</span><span class=\"token string\">'same'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'lower'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> comparison</pre></td></tr></table></figure><h4 id=\"618-学生地理信息报告\"><a class=\"anchor\" href=\"#618-学生地理信息报告\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc3R1ZGVudHMtcmVwb3J0LWJ5LWdlb2dyYXBoeS8=\">618. 学生地理信息报告</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>一所美国大学有来自亚洲、欧洲和美洲的学生，他们的地理信息存放在如下  <code>student</code>  表中。</p>\n<table>\n<thead>\n<tr>\n<th>name</th>\n<th>continent</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Jack</td>\n<td>America</td>\n</tr>\n<tr>\n<td>Pascal</td>\n<td>Europe</td>\n</tr>\n<tr>\n<td>Xi</td>\n<td>Asia</td>\n</tr>\n<tr>\n<td>Jane</td>\n<td>America</td>\n</tr>\n</tbody>\n</table>\n<p>写一个查询语句实现对大洲（continent）列的 <span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU5JTgwJThGJUU4JUE3JTg2JUU4JUExJUE4\">透视表</span> 操作，使得每个学生按照姓名的字母顺序依次排列在对应的大洲下面。输出的标题应依次为美洲（America）、亚洲（Asia）和欧洲（Europe）。数据保证来自美洲的学生不少于来自亚洲或者欧洲的学生。</p>\n<p>对于样例输入，它的对应输出是：</p>\n<table>\n<thead>\n<tr>\n<th>America</th>\n<th>Asia</th>\n<th>Europe</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Jack</td>\n<td>Xi</td>\n<td>Pascal</td>\n</tr>\n<tr>\n<td>Jane</td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>** 进阶：** 如果不能确定哪个大洲的学生数最多，你可以写出一个查询去生成上述学生报告吗？</p>\n<p>开窗</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>continent<span class=\"token operator\">=</span><span class=\"token string\">'America'</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> America<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>continent<span class=\"token operator\">=</span><span class=\"token string\">'Asia'</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> Asia<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>continent<span class=\"token operator\">=</span><span class=\"token string\">'Europe'</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> Europe</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> continent <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> name<span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">from</span> student<span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> rk</pre></td></tr></table></figure><p>变量</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    America<span class=\"token punctuation\">,</span> Asia<span class=\"token punctuation\">,</span> Europe</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token variable\">@as</span>:<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@am</span>:<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">@eu</span>:<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> t<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token variable\">@as</span>:<span class=\"token operator\">=</span><span class=\"token variable\">@as</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">AS</span> asid<span class=\"token punctuation\">,</span> name <span class=\"token keyword\">AS</span> Asia</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        student</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">WHERE</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        continent <span class=\"token operator\">=</span> <span class=\"token string\">'Asia'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> Asia<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> t1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">RIGHT</span> <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token variable\">@am</span>:<span class=\"token operator\">=</span><span class=\"token variable\">@am</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">AS</span> amid<span class=\"token punctuation\">,</span> name <span class=\"token keyword\">AS</span> America</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        student</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">WHERE</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        continent <span class=\"token operator\">=</span> <span class=\"token string\">'America'</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> America<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> t2 <span class=\"token keyword\">ON</span> asid <span class=\"token operator\">=</span> amid</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token variable\">@eu</span>:<span class=\"token operator\">=</span><span class=\"token variable\">@eu</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">AS</span> euid<span class=\"token punctuation\">,</span> name <span class=\"token keyword\">AS</span> Europe</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        student</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">WHERE</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        continent <span class=\"token operator\">=</span> <span class=\"token string\">'Europe'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> Europe<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> t3 <span class=\"token keyword\">ON</span> amid <span class=\"token operator\">=</span> euid</pre></td></tr></table></figure><blockquote>\n<p>官方给出的。。同下方开窗</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> America<span class=\"token punctuation\">,</span>Asia<span class=\"token punctuation\">,</span>Europe </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> rn<span class=\"token punctuation\">,</span>name <span class=\"token keyword\">as</span> America <span class=\"token keyword\">from</span> student</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">where</span> continent<span class=\"token operator\">=</span><span class=\"token string\">'America'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">select</span> row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> rn<span class=\"token punctuation\">,</span>name <span class=\"token keyword\">as</span> Asia <span class=\"token keyword\">from</span> student</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">where</span> continent<span class=\"token operator\">=</span><span class=\"token string\">'Asia'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span> b <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>rn<span class=\"token operator\">=</span>b<span class=\"token punctuation\">.</span>rn</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">select</span> row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> rn<span class=\"token punctuation\">,</span>name <span class=\"token keyword\">as</span> Europe <span class=\"token keyword\">from</span> student</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">where</span> continent<span class=\"token operator\">=</span><span class=\"token string\">'Europe'</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">)</span> c <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>rn<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span>rn</pre></td></tr></table></figure><h4 id=\"619-只出现一次的最大数字\"><a class=\"anchor\" href=\"#619-只出现一次的最大数字\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYmlnZ2VzdC1zaW5nbGUtbnVtYmVyLw==\">619. 只出现一次的最大数字</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表  <code>my_numbers</code>  的 <strong>num</strong> 字段包含很多数字，其中包括很多重复的数字。</p>\n<p>你能写一个 SQL 查询语句，找到只出现过一次的数字中，最大的一个数字吗？</p>\n<pre><code>+---+\n|num|\n+---+\n| 8 |\n| 8 |\n| 3 |\n| 3 |\n| 1 |\n| 4 |\n| 5 |\n| 6 | \n</code></pre>\n<p>对于上面给出的样例数据，你的查询语句应该返回如下结果：</p>\n<pre><code>+---+\n|num|\n+---+\n| 6 |\n</code></pre>\n<p><strong>注意：</strong></p>\n<p>如果没有只出现一次的数字，输出 <strong>null</strong> 。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">MAX</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> num</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        num</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        my_numbers</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> num</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">HAVING</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> t1</pre></td></tr></table></figure><h4 id=\"620-有趣的电影\"><a class=\"anchor\" href=\"#620-有趣的电影\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbm90LWJvcmluZy1tb3ZpZXMv\">620. 有趣的电影</span></h4>\n<p>难度简单 86 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>某城市开了一家新的电影院，吸引了很多人过来看电影。该电影院特别注意用户体验，专门有个 LED 显示板做电影推荐，上面公布着影评和相关电影描述。</p>\n<p>作为该电影院的信息部主管，您需要编写一个 SQL 查询，找出所有影片描述为<strong>非</strong>  <code>boring</code>  (不无聊) 的并且 <strong>id 为奇数</strong> 的影片，结果请按等级  <code>rating</code>  排列。</p>\n<p>例如，下表  <code>cinema</code> :</p>\n<pre><code>+---------+-----------+--------------+-----------+\n|   id    | movie     |  description |  rating   |\n+---------+-----------+--------------+-----------+\n|   1     | War       |   great 3D   |   8.9     |\n|   2     | Science   |   fiction    |   8.5     |\n|   3     | irish     |   boring     |   6.2     |\n|   4     | Ice song  |   Fantacy    |   8.6     |\n|   5     | House card|   Interesting|   9.1     |\n+---------+-----------+--------------+-----------+\n</code></pre>\n<p>对于上面的例子，则正确的输出是为：</p>\n<pre><code>+---------+-----------+--------------+-----------+\n|   id    | movie     |  description |  rating   |\n+---------+-----------+--------------+-----------+\n|   5     | House card|   Interesting|   9.1     |\n|   1     | War       |   great 3D   |   8.9     |\n+---------+-----------+--------------+-----------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  id<span class=\"token punctuation\">,</span>movie<span class=\"token punctuation\">,</span>description<span class=\"token punctuation\">,</span>rating </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> cinema</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> id<span class=\"token operator\">%</span><span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> description <span class=\"token operator\">!=</span><span class=\"token string\">'boring'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> rating <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>id<span class=\"token punctuation\">,</span>movie<span class=\"token punctuation\">,</span>description</pre></td></tr></table></figure><h4 id=\"626-换座位\"><a class=\"anchor\" href=\"#626-换座位\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZXhjaGFuZ2Utc2VhdHMv\">626. 换座位</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>小美是一所中学的信息科技老师，她有一张  <code>seat</code>  座位表，平时用来储存学生名字和与他们相对应的座位 id。</p>\n<p>其中纵列的 <strong>id</strong> 是连续递增的</p>\n<p>小美想改变相邻俩学生的座位。</p>\n<p>你能不能帮她写一个 SQL query 来输出小美想要的结果呢？</p>\n<p><strong>示例：</strong></p>\n<pre><code>+---------+---------+\n|    id   | student |\n+---------+---------+\n|    1    | Abbot   |\n|    2    | Doris   |\n|    3    | Emerson |\n|    4    | Green   |\n|    5    | Jeames  |\n+---------+---------+\n</code></pre>\n<p>假如数据输入的是上表，则输出结果如下：</p>\n<pre><code>+---------+---------+\n|    id   | student |\n+---------+---------+\n|    1    | Doris   |\n|    2    | Abbot   |\n|    3    | Green   |\n|    4    | Emerson |\n|    5    | Jeames  |\n+---------+---------+\n</code></pre>\n<p><strong>注意：</strong></p>\n<p>如果学生人数是奇数，则不需要改变最后一个同学的座位。</p>\n<p>开窗</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> id<span class=\"token operator\">%</span><span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token keyword\">then</span> f</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token keyword\">when</span> id<span class=\"token operator\">%</span><span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> b <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">then</span> b</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token keyword\">else</span> student <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> student</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>student<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    lag<span class=\"token punctuation\">(</span>student<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> f<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    lead<span class=\"token punctuation\">(</span>student<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">)</span> b</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">from</span> seat</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr></table></figure><p>非嵌套</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">%</span><span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        id<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> seat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            id<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">as</span> id<span class=\"token punctuation\">,</span>student </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> seat </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>用异或</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> b<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">.</span>student <span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>seat <span class=\"token keyword\">as</span> a<span class=\"token punctuation\">,</span>seat <span class=\"token keyword\">as</span> b<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> cnt <span class=\"token keyword\">from</span> seat<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> c </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> b<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token operator\">^</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>id<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">-- where a.id=1^(b.id-1)+1; 也可以这样写，更容易理解</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>cnt<span class=\"token operator\">%</span><span class=\"token number\">2</span> <span class=\"token operator\">&amp;&amp;</span> b<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span>cnt <span class=\"token operator\">&amp;&amp;</span> a<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span>cnt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"627-交换工资\"><a class=\"anchor\" href=\"#627-交换工资\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc3dhcC1zYWxhcnkv\">627. 交换工资</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>给定一个  <code>salary</code>  表，如下所示，有 m = 男性 和 f = 女性 的值。交换所有的 f 和 m 值（例如，将所有 f 值更改为 m，反之亦然）。要求只使用一个更新（Update）语句，并且没有中间的临时表。</p>\n<p>注意，您必只能写一个 Update 语句，请不要编写任何 Select 语句。</p>\n<p><strong>例如：</strong></p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>name</th>\n<th>sex</th>\n<th>salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>A</td>\n<td>m</td>\n<td>2500</td>\n</tr>\n<tr>\n<td>2</td>\n<td>B</td>\n<td>f</td>\n<td>1500</td>\n</tr>\n<tr>\n<td>3</td>\n<td>C</td>\n<td>m</td>\n<td>5500</td>\n</tr>\n<tr>\n<td>4</td>\n<td>D</td>\n<td>f</td>\n<td>500</td>\n</tr>\n</tbody>\n</table>\n<p>运行你所编写的更新语句之后，将会得到以下表:</p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>name</th>\n<th>sex</th>\n<th>salary</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>A</td>\n<td>f</td>\n<td>2500</td>\n</tr>\n<tr>\n<td>2</td>\n<td>B</td>\n<td>m</td>\n<td>1500</td>\n</tr>\n<tr>\n<td>3</td>\n<td>C</td>\n<td>f</td>\n<td>5500</td>\n</tr>\n<tr>\n<td>4</td>\n<td>D</td>\n<td>m</td>\n<td>500</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">UPDATE</span> salary</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">SET</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    sex <span class=\"token operator\">=</span> <span class=\"token keyword\">CASE</span> sex</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'m'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'f'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">ELSE</span> <span class=\"token string\">'m'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><blockquote>\n<p>Update 和 set 的使用</p>\n</blockquote>\n<h4 id=\"1045-买下所有产品的客户\"><a class=\"anchor\" href=\"#1045-买下所有产品的客户\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3VzdG9tZXJzLXdoby1ib3VnaHQtYWxsLXByb2R1Y3RzLw==\">1045. 买下所有产品的客户</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Customer</code>  表：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| customer_id | int     |\n| product_key | int     |\n+-------------+---------+\nproduct_key 是 Customer 表的外键。\n</code></pre>\n<p><code>Product</code>  表：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| product_key | int     |\n+-------------+---------+\nproduct_key 是这张表的主键。\n</code></pre>\n<p>写一条 SQL 查询语句，从  <code>Customer</code>  表中查询购买了  <code>Product</code>  表中所有产品的客户的 id。</p>\n<p><strong>示例：</strong></p>\n<pre><code>Customer 表：\n+-------------+-------------+\n| customer_id | product_key |\n+-------------+-------------+\n| 1           | 5           |\n| 2           | 6           |\n| 3           | 5           |\n| 3           | 6           |\n| 1           | 6           |\n+-------------+-------------+\n\nProduct 表：\n+-------------+\n| product_key |\n+-------------+\n| 5           |\n| 6           |\n+-------------+\n\nResult 表：\n+-------------+\n| customer_id |\n+-------------+\n| 1           |\n| 3           |\n+-------------+\n购买了所有产品（5 和 6）的客户的 id 是 1 和 3 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> customer_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Customer</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> product_key<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Product<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1050-合作过至少三次的演员和导演\"><a class=\"anchor\" href=\"#1050-合作过至少三次的演员和导演\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWN0b3JzLWFuZC1kaXJlY3RvcnMtd2hvLWNvb3BlcmF0ZWQtYXQtbGVhc3QtdGhyZWUtdGltZXMv\">1050. 合作过至少三次的演员和导演</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p><code>ActorDirector</code>  表：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| actor_id    | int     |\n| director_id | int     |\n| timestamp   | int     |\n+-------------+---------+\ntimestamp 是这张表的主键.\n</code></pre>\n<p>写一条 SQL 查询语句获取合作过至少三次的演员和导演的 id 对  <code>(actor_id, director_id)</code></p>\n<p><strong>示例：</strong></p>\n<pre><code>ActorDirector 表：\n+-------------+-------------+-------------+\n| actor_id    | director_id | timestamp   |\n+-------------+-------------+-------------+\n| 1           | 1           | 0           |\n| 1           | 1           | 1           |\n| 1           | 1           | 2           |\n| 1           | 2           | 3           |\n| 1           | 2           | 4           |\n| 2           | 1           | 5           |\n| 2           | 1           | 6           |\n+-------------+-------------+-------------+\n\nResult 表：\n+-------------+-------------+\n| actor_id    | director_id |\n+-------------+-------------+\n| 1           | 1           |\n+-------------+-------------+\n唯一的 id 对是 (1, 1)，他们恰好合作了 3 次。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> actor_id<span class=\"token punctuation\">,</span>director_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> ActorDirector</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> actor_id<span class=\"token punctuation\">,</span>director_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">3</span></pre></td></tr></table></figure><h4 id=\"1068-产品销售分析-i\"><a class=\"anchor\" href=\"#1068-产品销售分析-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvZHVjdC1zYWxlcy1hbmFseXNpcy1pLw==\">1068. 产品销售分析 I</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>销售表  <code>Sales</code> ：</p>\n<pre><code>+-------------+-------+\n| Column Name | Type  |\n+-------------+-------+\n| sale_id     | int   |\n| product_id  | int   |\n| year        | int   |\n| quantity    | int   |\n| price       | int   |\n+-------------+-------+\n(sale_id, year) 是销售表 Sales 的主键.\nproduct_id 是产品表 Product 的外键.\n注意: price 表示每单位价格\n</code></pre>\n<p>产品表  <code>Product</code> ：</p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n+--------------+---------+\nproduct_id 是表的主键.\n</code></pre>\n<p>写一条 SQL 查询语句获取产品表  <code>Product</code>  中所有的 <strong>产品名称 product name</strong> 以及 该产品在  <code>Sales</code>  表中相对应的 <strong>上市年份 year</strong> 和 <strong>价格 price</strong>。</p>\n<p>示例：</p>\n<pre><code>Sales 表：\n+---------+------------+------+----------+-------+\n| sale_id | product_id | year | quantity | price |\n+---------+------------+------+----------+-------+ \n| 1       | 100        | 2008 | 10       | 5000  |\n| 2       | 100        | 2009 | 12       | 5000  |\n| 7       | 200        | 2011 | 15       | 9000  |\n+---------+------------+------+----------+-------+\n\nProduct 表：\n+------------+--------------+\n| product_id | product_name |\n+------------+--------------+\n| 100        | Nokia        |\n| 200        | Apple        |\n| 300        | Samsung      |\n+------------+--------------+\n\nResult 表：\n+--------------+-------+-------+\n| product_name | year  | price |\n+--------------+-------+-------+\n| Nokia        | 2008  | 5000  |\n| Nokia        | 2009  | 5000  |\n| Apple        | 2011  | 9000  |\n+--------------+-------+-------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_name<span class=\"token punctuation\">,</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">,</span>price</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Sales s <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Product p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>product_id  <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr></table></figure><h4 id=\"1069-产品销售分析-ii\"><a class=\"anchor\" href=\"#1069-产品销售分析-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvZHVjdC1zYWxlcy1hbmFseXNpcy1paS8=\">1069. 产品销售分析 II</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>销售表： <code>Sales</code></p>\n<pre><code>+-------------+-------+\n| Column Name | Type  |\n+-------------+-------+\n| sale_id     | int   |\n| product_id  | int   |\n| year        | int   |\n| quantity    | int   |\n| price       | int   |\n+-------------+-------+\nsale_id 是这个表的主键。\nproduct_id 是 Product 表的外键。\n请注意价格是每单位的。\n</code></pre>\n<p>产品表： <code>Product</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n+--------------+---------+\nproduct_id 是这个表的主键。\n</code></pre>\n<p>编写一个 SQL 查询，按产品 id  <code>product_id</code>  来统计每个产品的销售总量。</p>\n<p>查询结果格式如下面例子所示:</p>\n<pre><code>Sales 表：\n+---------+------------+------+----------+-------+\n| sale_id | product_id | year | quantity | price |\n+---------+------------+------+----------+-------+ \n| 1       | 100        | 2008 | 10       | 5000  |\n| 2       | 100        | 2009 | 12       | 5000  |\n| 7       | 200        | 2011 | 15       | 9000  |\n+---------+------------+------+----------+-------+\n\nProduct 表：\n+------------+--------------+\n| product_id | product_name |\n+------------+--------------+\n| 100        | Nokia        |\n| 200        | Apple        |\n| 300        | Samsung      |\n+------------+--------------+\n\nResult 表：\n+--------------+----------------+\n| product_id   | total_quantity |\n+--------------+----------------+\n| 100          | 22             |\n| 200          | 15             |\n+--------------+----------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>quantity<span class=\"token punctuation\">)</span> total_quantity</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Sales s <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Product p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>product_id  <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> s<span class=\"token punctuation\">.</span>product_id</pre></td></tr></table></figure><h4 id=\"1070-产品销售分析-iii\"><a class=\"anchor\" href=\"#1070-产品销售分析-iii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvZHVjdC1zYWxlcy1hbmFseXNpcy1paWkv\">1070. 产品销售分析 III</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>销售表  <code>Sales</code> ：</p>\n<pre><code>+-------------+-------+\n| Column Name | Type  |\n+-------------+-------+\n| sale_id     | int   |\n| product_id  | int   |\n| year        | int   |\n| quantity    | int   |\n| price       | int   |\n+-------------+-------+\nsale_id 是此表的主键。\nproduct_id 是产品表的外键。\n请注意，价格是按每单位计的。\n</code></pre>\n<p>产品表  <code>Product</code> ：</p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n+--------------+---------+\nproduct_id 是此表的主键。\n</code></pre>\n<p>编写一个 SQL 查询，选出每个销售产品的 <strong>第一年</strong> 的 <strong>产品 id</strong>、<strong>年份</strong>、<strong>数量</strong> 和 <strong>价格</strong>。</p>\n<p>查询结果格式如下：</p>\n<pre><code>Sales table:\n+---------+------------+------+----------+-------+\n| sale_id | product_id | year | quantity | price |\n+---------+------------+------+----------+-------+ \n| 1       | 100        | 2008 | 10       | 5000  |\n| 2       | 100        | 2009 | 12       | 5000  |\n| 7       | 200        | 2011 | 15       | 9000  |\n+---------+------------+------+----------+-------+\n\nProduct table:\n+------------+--------------+\n| product_id | product_name |\n+------------+--------------+\n| 100        | Nokia        |\n| 200        | Apple        |\n| 300        | Samsung      |\n+------------+--------------+\n\nResult table:\n+------------+------------+----------+-------+\n| product_id | first_year | quantity | price |\n+------------+------------+----------+-------+ \n| 100        | 2008       | 10       | 5000  |\n| 200        | 2011       | 15       | 9000  |\n+------------+------------+----------+-------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_id<span class=\"token punctuation\">,</span><span class=\"token keyword\">year</span> first_year<span class=\"token punctuation\">,</span>quantity<span class=\"token punctuation\">,</span>price</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">,</span>quantity<span class=\"token punctuation\">,</span>price<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> product_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Sales s <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Product p</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>product_id  <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1075-项目员工-i\"><a class=\"anchor\" href=\"#1075-项目员工-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvamVjdC1lbXBsb3llZXMtaS8=\">1075. 项目员工 I</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>项目表  <code>Project</code> ：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| project_id  | int     |\n| employee_id | int     |\n+-------------+---------+\n主键为 (project_id, employee_id)。\nemployee_id 是员工表 Employee 表的外键。\n</code></pre>\n<p>员工表  <code>Employee</code> ：</p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| employee_id      | int     |\n| name             | varchar |\n| experience_years | int     |\n+------------------+---------+\n主键是 employee_id。\n</code></pre>\n<p>请写一个 SQL 语句，查询每一个项目中员工的 <strong>平均</strong> 工作年限，<strong>精确到小数点后两位</strong>。</p>\n<p>查询结果的格式如下：</p>\n<pre><code>Project 表：\n+-------------+-------------+\n| project_id  | employee_id |\n+-------------+-------------+\n| 1           | 1           |\n| 1           | 2           |\n| 1           | 3           |\n| 2           | 1           |\n| 2           | 4           |\n+-------------+-------------+\n\nEmployee 表：\n+-------------+--------+------------------+\n| employee_id | name   | experience_years |\n+-------------+--------+------------------+\n| 1           | Khaled | 3                |\n| 2           | Ali    | 2                |\n| 3           | John   | 1                |\n| 4           | Doe    | 2                |\n+-------------+--------+------------------+\n\nResult 表：\n+-------------+---------------+\n| project_id  | average_years |\n+-------------+---------------+\n| 1           | 2.00          |\n| 2           | 2.50          |\n+-------------+---------------+\n第一个项目中，员工的平均工作年限是 (3 + 2 + 1) / 3 = 2.00；第二个项目中，员工的平均工作年限是 (3 + 2) / 2 = 2.50\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> project_id<span class=\"token punctuation\">,</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>experience_years<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> average_years</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Project p <span class=\"token keyword\">join</span> Employee e</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> p<span class=\"token punctuation\">.</span>employee_id<span class=\"token operator\">=</span>e<span class=\"token punctuation\">.</span>employee_id </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> project_id</pre></td></tr></table></figure><h4 id=\"1076-项目员工ii\"><a class=\"anchor\" href=\"#1076-项目员工ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvamVjdC1lbXBsb3llZXMtaWkv\">1076. 项目员工 II</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Project</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| project_id  | int     |\n| employee_id | int     |\n+-------------+---------+\n主键为 (project_id, employee_id)。\nemployee_id 是员工表 Employee 表的外键。\n</code></pre>\n<p>Table:  <code>Employee</code></p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| employee_id      | int     |\n| name             | varchar |\n| experience_years | int     |\n+------------------+---------+\n主键是 employee_id。\n</code></pre>\n<p>编写一个 SQL 查询，报告所有雇员最多的项目。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Project table:\n+-------------+-------------+\n| project_id  | employee_id |\n+-------------+-------------+\n| 1           | 1           |\n| 1           | 2           |\n| 1           | 3           |\n| 2           | 1           |\n| 2           | 4           |\n+-------------+-------------+\n\nEmployee table:\n+-------------+--------+------------------+\n| employee_id | name   | experience_years |\n+-------------+--------+------------------+\n| 1           | Khaled | 3                |\n| 2           | Ali    | 2                |\n| 3           | John   | 1                |\n| 4           | Doe    | 2                |\n+-------------+--------+------------------+\n\nResult table:\n+-------------+\n| project_id  |\n+-------------+\n| 1           |\n+-------------+\n第一个项目有3名员工，第二个项目有2名员工。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> project_id </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Project </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> project_id </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">`</span>num<span class=\"token punctuation\">`</span> <span class=\"token keyword\">from</span> Project <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> project_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span> <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>开窗</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> project_id <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> project_id<span class=\"token punctuation\">,</span>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>employee_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> ranking <span class=\"token keyword\">from</span> Project <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> project_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">temp</span> <span class=\"token keyword\">where</span> ranking<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1077-项目员工-iii\"><a class=\"anchor\" href=\"#1077-项目员工-iii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvamVjdC1lbXBsb3llZXMtaWlpLw==\">1077. 项目员工 III</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>项目表  <code>Project</code> ：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| project_id  | int     |\n| employee_id | int     |\n+-------------+---------+\n(project_id, employee_id) 是这个表的主键\nemployee_id 是员工表 Employee 的外键\n</code></pre>\n<p>员工表  <code>Employee</code> ：</p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| employee_id      | int     |\n| name             | varchar |\n| experience_years | int     |\n+------------------+---------+\nemployee_id 是这个表的主键\n</code></pre>\n<p>写 一个 SQL 查询语句，报告在每一个项目中经验最丰富的雇员是谁。如果出现经验年数相同的情况，请报告所有具有最大经验年数的员工。</p>\n<p>查询结果格式在以下示例中：</p>\n<pre><code>Project 表：\n+-------------+-------------+\n| project_id  | employee_id |\n+-------------+-------------+\n| 1           | 1           |\n| 1           | 2           |\n| 1           | 3           |\n| 2           | 1           |\n| 2           | 4           |\n+-------------+-------------+\n\nEmployee 表：\n+-------------+--------+------------------+\n| employee_id | name   | experience_years |\n+-------------+--------+------------------+\n| 1           | Khaled | 3                |\n| 2           | Ali    | 2                |\n| 3           | John   | 3                |\n| 4           | Doe    | 2                |\n+-------------+--------+------------------+\n\nResult 表：\n+-------------+---------------+\n| project_id  | employee_id   |\n+-------------+---------------+\n| 1           | 1             |\n| 1           | 3             |\n| 2           | 1             |\n+-------------+---------------+\nemployee_id 为 1 和 3 的员工在 project_id 为 1 的项目中拥有最丰富的经验。在 project_id 为 2 的项目中，employee_id 为 1 的员工拥有最丰富的经验。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> project_id <span class=\"token punctuation\">,</span>employee_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> project_id<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>employee_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> project_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> experience_years <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Project p <span class=\"token keyword\">join</span> Employee e</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">on</span> p<span class=\"token punctuation\">.</span>employee_id<span class=\"token operator\">=</span>e<span class=\"token punctuation\">.</span>employee_id </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> rk<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1082-销售分析-i\"><a class=\"anchor\" href=\"#1082-销售分析-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2FsZXMtYW5hbHlzaXMtaS8=\">1082. 销售分析 I </span></h4>\n<p>难度简单 22</p>\n<p>SQL 架构</p>\n<p>产品表： <code>Product</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n| unit_price   | int     |\n+--------------+---------+\nproduct_id 是这个表的主键.\n</code></pre>\n<p>销售表： <code>Sales</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| seller_id   | int     |\n| product_id  | int     |\n| buyer_id    | int     |\n| sale_date   | date    |\n| quantity    | int     |\n| price       | int     |\n+------ ------+---------+\n这个表没有主键，它可以有重复的行.\nproduct_id 是 Product 表的外键.\n</code></pre>\n<p>编写一个 SQL 查询，查询总销售额最高的销售者，如果有并列的，就都展示出来。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Product 表：\n+------------+--------------+------------+\n| product_id | product_name | unit_price |\n+------------+--------------+------------+\n| 1          | S8           | 1000       |\n| 2          | G4           | 800        |\n| 3          | iPhone       | 1400       |\n+------------+--------------+------------+\n\nSales 表：\n+-----------+------------+----------+------------+----------+-------+\n| seller_id | product_id | buyer_id | sale_date  | quantity | price |\n+-----------+------------+----------+------------+----------+-------+\n| 1         | 1          | 1        | 2019-01-21 | 2        | 2000  |\n| 1         | 2          | 2        | 2019-02-17 | 1        | 800   |\n| 2         | 2          | 3        | 2019-06-02 | 1        | 800   |\n| 3         | 3          | 4        | 2019-05-13 | 2        | 2800  |\n+-----------+------------+----------+------------+----------+-------+\n\nResult 表：\n+-------------+\n| seller_id   |\n+-------------+\n| 1           |\n| 3           |\n+-------------+\nId 为 1 和 3 的销售者，销售总金额都为最高的 2800。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> seller_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> seller_id <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>price<span class=\"token punctuation\">)</span> tp<span class=\"token punctuation\">,</span>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>price<span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Sales</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> seller_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1083-销售分析-ii\"><a class=\"anchor\" href=\"#1083-销售分析-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2FsZXMtYW5hbHlzaXMtaWkv\">1083. 销售分析 II</span></h4>\n<p>难度简单 13</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Product</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n| unit_price   | int     |\n+--------------+---------+\nproduct_id 是这张表的主键\n</code></pre>\n<p>Table:  <code>Sales</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| seller_id   | int     |\n| product_id  | int     |\n| buyer_id    | int     |\n| sale_date   | date    |\n| quantity    | int     |\n| price       | int     |\n+------ ------+---------+\n这个表没有主键，它可以有重复的行.\nproduct_id 是 Product 表的外键.\n</code></pre>\n<p>编写一个 SQL 查询，查询购买了 S8 手机却没有购买 iPhone 的买家。注意这里 S8 和 iPhone 是 Product 表中的产品。</p>\n<p>查询结果格式如下图表示：</p>\n<pre><code>Product table:\n+------------+--------------+------------+\n| product_id | product_name | unit_price |\n+------------+--------------+------------+\n| 1          | S8           | 1000       |\n| 2          | G4           | 800        |\n| 3          | iPhone       | 1400       |\n+------------+--------------+------------+\n\nSales table:\n+-----------+------------+----------+------------+----------+-------+\n| seller_id | product_id | buyer_id | sale_date  | quantity | price |\n+-----------+------------+----------+------------+----------+-------+\n| 1         | 1          | 1        | 2019-01-21 | 2        | 2000  |\n| 1         | 2          | 2        | 2019-02-17 | 1        | 800   |\n| 2         | 1          | 3        | 2019-06-02 | 1        | 800   |\n| 3         | 3          | 3        | 2019-05-13 | 2        | 2800  |\n+-----------+------------+----------+------------+----------+-------+\n\nResult table:\n+-------------+\n| buyer_id    |\n+-------------+\n| 1           |\n+-------------+\nid 为 1 的买家购买了一部 S8，但是却没有购买 iPhone，而 id 为 3 的买家却同时购买了这 2 部手机。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> t<span class=\"token punctuation\">.</span>buyer_id <span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>buyer_id<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>product_name</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> sales s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>product p</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>product_id<span class=\"token operator\">=</span>p<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">and</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'S8'</span> <span class=\"token operator\">or</span> p<span class=\"token punctuation\">.</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'iPhone'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> s<span class=\"token punctuation\">.</span>buyer_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> p<span class=\"token punctuation\">.</span>product_name<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">where</span> t<span class=\"token punctuation\">.</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'S8'</span></pre></td></tr></table></figure><p>效率低</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>buyer_id </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> sales <span class=\"token keyword\">as</span> s <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> product <span class=\"token keyword\">as</span> p </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>product_id<span class=\"token operator\">=</span>p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> buyer_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'S8'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token number\">0</span> <span class=\"token operator\">and</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'iPhone'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><h4 id=\"1084-销售分析iii\"><a class=\"anchor\" href=\"#1084-销售分析iii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2FsZXMtYW5hbHlzaXMtaWlpLw==\">1084. 销售分析 III</span></h4>\n<p>难度简单 13</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Product</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| product_id   | int     |\n| product_name | varchar |\n| unit_price   | int     |\n+--------------+---------+\nproduct_id 是这个表的主键\n</code></pre>\n<p>Table:  <code>Sales</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| seller_id   | int     |\n| product_id  | int     |\n| buyer_id    | int     |\n| sale_date   | date    |\n| quantity    | int     |\n| price       | int     |\n+------ ------+---------+\n这个表没有主键，它可以有重复的行.\nproduct_id 是 Product 表的外键.\n</code></pre>\n<p>编写一个 SQL 查询，报告 2019 年春季才售出的产品。即<strong>仅</strong>在<strong> 2019-01-01</strong> 至<strong> 2019-03-31</strong>（含）之间出售的商品。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Product table:\n+------------+--------------+------------+\n| product_id | product_name | unit_price |\n+------------+--------------+------------+\n| 1          | S8           | 1000       |\n| 2          | G4           | 800        |\n| 3          | iPhone       | 1400       |\n+------------+--------------+------------+\n\nSales table:\n+-----------+------------+----------+------------+----------+-------+\n| seller_id | product_id | buyer_id | sale_date  | quantity | price |\n+-----------+------------+----------+------------+----------+-------+\n| 1         | 1          | 1        | 2019-01-21 | 2        | 2000  |\n| 1         | 2          | 2        | 2019-02-17 | 1        | 800   |\n| 2         | 2          | 3        | 2019-06-02 | 1        | 800   |\n| 3         | 3          | 4        | 2019-05-13 | 2        | 2800  |\n+-----------+------------+----------+------------+----------+-------+\n\nResult table:\n+-------------+--------------+\n| product_id  | product_name |\n+-------------+--------------+\n| 1           | S8           |\n+-------------+--------------+\nid为1的产品仅在2019年春季销售，其他两个产品在之后销售。\n</code></pre>\n<p>876ms</p>\n<p>正常解法</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_id<span class=\"token punctuation\">,</span> product_name  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> product </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> product_id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> product_id <span class=\"token keyword\">from</span> sales </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> sale_date <span class=\"token operator\">></span> <span class=\"token string\">'2019-03-31'</span> <span class=\"token operator\">or</span> sale_date <span class=\"token operator\">&lt;</span> <span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>867ms</p>\n<p>sum = count</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_id<span class=\"token punctuation\">,</span> product_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Sales <span class=\"token keyword\">join</span> Product</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">using</span><span class=\"token punctuation\">(</span>product_id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> product_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>sale_date <span class=\"token operator\">between</span> <span class=\"token string\">\"2019-01-01\"</span> <span class=\"token operator\">and</span> <span class=\"token string\">\"2019-03-31\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>sale_date<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>987ms</p>\n<p>sum 为 0 类似于第一种解法，计算了 sum 效率就低了</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> p<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>product_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> sales s<span class=\"token punctuation\">,</span> product p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> s<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> s<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>sale_date<span class=\"token operator\">></span> <span class=\"token string\">'2019-03-31'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token operator\">and</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>sale_date <span class=\"token operator\">&lt;</span> <span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr></table></figure><p>上一解法 sum 换成 max</p>\n<p>859ms</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> p<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>product_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> sales s<span class=\"token punctuation\">,</span> product p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> s<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> s<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>sale_date<span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token string\">'2019-01-01'</span> <span class=\"token operator\">and</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>sale_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token string\">'2019-03-31'</span></pre></td></tr></table></figure><h4 id=\"1097-游戏玩法分析-v\"><a class=\"anchor\" href=\"#1097-游戏玩法分析-v\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2FtZS1wbGF5LWFuYWx5c2lzLXYv\">1097. 游戏玩法分析 V</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Activity</code>  活动记录表</p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| player_id    | int     |\n| device_id    | int     |\n| event_date   | date    |\n| games_played | int     |\n+--------------+---------+\n（player_id，event_date）是此表的主键\n这张表显示了某些游戏的玩家的活动情况\n每一行是一个玩家的记录，他在某一天使用某个设备注销之前登录并玩了很多游戏（可能是 0）\n</code></pre>\n<p>我们将玩家的安装日期定义为该玩家的第一个登录日。</p>\n<p>我们还将某个日期  <code>X</code>  的第 1 天留存时间定义为安装日期为  <code>X</code>  的玩家的数量，他们在  <code>X</code>  之后的一天重新登录，除以安装日期为  <code>X</code>  的玩家的数量，四舍五入到小数点后两位。</p>\n<p>编写一个 SQL 查询，报告每个安装日期、当天安装游戏的玩家数量和第一天的留存时间。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Activity 表：\n+-----------+-----------+------------+--------------+\n| player_id | device_id | event_date | games_played |\n+-----------+-----------+------------+--------------+\n| 1         | 2         | 2016-03-01 | 5            |\n| 1         | 2         | 2016-03-02 | 6            |\n| 2         | 3         | 2017-06-25 | 1            |\n| 3         | 1         | 2016-03-01 | 0            |\n| 3         | 4         | 2016-07-03 | 5            |\n+-----------+-----------+------------+--------------+\n\nResult 表：\n+------------+----------+----------------+\n| install_dt | installs | Day1_retention |\n+------------+----------+----------------+\n| 2016-03-01 | 2        | 0.50           |\n| 2017-06-25 | 1        | 0.00           |\n+------------+----------+----------------+\n玩家 1 和 3 在 2016-03-01 安装了游戏，但只有玩家 1 在 2016-03-02 重新登录，所以 2016-03-01 的第一天留存时间是 1/2=0.50\n玩家 2 在 2017-06-25 安装了游戏，但在 2017-06-26 没有重新登录，因此 2017-06-25 的第一天留存时间为 0/1=0.00\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> install_dt<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> player_id<span class=\"token punctuation\">)</span>installs<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>       <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>datediff<span class=\"token punctuation\">(</span>event_date<span class=\"token punctuation\">,</span>install_dt<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> player_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> Day1_retention </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>event_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> player_id<span class=\"token punctuation\">)</span> install_dt</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1   </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> install_dt</pre></td></tr></table></figure><h4 id=\"1098-小众书籍\"><a class=\"anchor\" href=\"#1098-小众书籍\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdW5wb3B1bGFyLWJvb2tzLw==\">1098. 小众书籍</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>书籍表  <code>Books</code> ：</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| book_id        | int     |\n| name           | varchar |\n| available_from | date    |\n+----------------+---------+\nbook_id 是这个表的主键。\n</code></pre>\n<p>订单表  <code>Orders</code> ：</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| order_id       | int     |\n| book_id        | int     |\n| quantity       | int     |\n| dispatch_date  | date    |\n+----------------+---------+\norder_id 是这个表的主键。\nbook_id  是 Books 表的外键。\n</code></pre>\n<p>你需要写一段 SQL 命令，筛选出过去一年中订单总量 <strong>少于 10 本</strong> 的 <strong>书籍</strong> 。</p>\n<p>注意：<strong>不考虑</strong> 上架（available from）距今 <strong>不满一个月</strong> 的书籍。并且 <strong>假设今天是</strong> <strong>2019-06-23</strong> 。</p>\n<p>Write an SQL query that reports the books that have sold less than 10 copies in the last year, excluding books that have been available for less than 1 month from today. Assume today is 2019-06-23.</p>\n<p>下面是样例输出结果：</p>\n<pre><code>Books 表：\n+---------+--------------------+----------------+\n| book_id | name               | available_from |\n+---------+--------------------+----------------+\n| 1       | &quot;Kalila And Demna&quot; | 2010-01-01     |\n| 2       | &quot;28 Letters&quot;       | 2012-05-12     |\n| 3       | &quot;The Hobbit&quot;       | 2019-06-10     |\n| 4       | &quot;13 Reasons Why&quot;   | 2019-06-01     |\n| 5       | &quot;The Hunger Games&quot; | 2008-09-21     |\n+---------+--------------------+----------------+\n\nOrders 表：\n+----------+---------+----------+---------------+\n| order_id | book_id | quantity | dispatch_date |\n+----------+---------+----------+---------------+\n| 1        | 1       | 2        | 2018-07-26    |\n| 2        | 1       | 1        | 2018-11-05    |\n| 3        | 3       | 8        | 2019-06-11    |\n| 4        | 4       | 6        | 2019-06-05    |\n| 5        | 4       | 5        | 2019-06-20    |\n| 6        | 5       | 9        | 2009-02-02    |\n| 7        | 5       | 8        | 2010-04-13    |\n+----------+---------+----------+---------------+\n\nResult 表：\n+-----------+--------------------+\n| book_id   | name               |\n+-----------+--------------------+\n| 1         | &quot;Kalila And Demna&quot; |\n| 2         | &quot;28 Letters&quot;       |\n| 5         | &quot;The Hunger Games&quot; |\n+-----------+--------------------+\n</code></pre>\n<blockquote>\n<p>这题中英文 都有歧义，看结果进行分析</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> a<span class=\"token punctuation\">.</span>book_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>name </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> books a <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> orders b <span class=\"token keyword\">ON</span> a<span class=\"token punctuation\">.</span>book_id<span class=\"token operator\">=</span>b<span class=\"token punctuation\">.</span>book_id </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">AND</span> dispatch_date <span class=\"token operator\">BETWEEN</span> DATE_ADD<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-06-23'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">INTERVAL</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">YEAR</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">AND</span> <span class=\"token string\">'2019-06-23'</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">WHERE</span> a<span class=\"token punctuation\">.</span>available_from <span class=\"token operator\">&lt;=</span> DATE_ADD<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-06-23'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">INTERVAL</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">MONTH</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>book_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>name </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">HAVING</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>IFNULL<span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>quantity<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>book_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><blockquote>\n<p>此题有坑，首先订单近一年，再者 quantity 为 null，还有近一月出版，sum 不是订单是本数</p>\n<p>还有就是 date_add 这个函数在 hive 里和 mysql 语法上有点小区别</p>\n</blockquote>\n<h4 id=\"1107-每日新用户统计\"><a class=\"anchor\" href=\"#1107-每日新用户统计\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbmV3LXVzZXJzLWRhaWx5LWNvdW50Lw==\">1107. 每日新用户统计</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Traffic</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| activity      | enum    |\n| activity_date | date    |\n+---------------+---------+\n该表没有主键，它可能有重复的行。\nactivity 列是 ENUM 类型，可能取 ('login', 'logout', 'jobs', 'groups', 'homepage') 几个值之一。\n</code></pre>\n<p>编写一个 SQL 查询，以查询从今天起最多 90 天内，每个日期该日期首次登录的用户数。假设今天是 <strong>2019-06-30</strong>.</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Traffic 表：\n+---------+----------+---------------+\n| user_id | activity | activity_date |\n+---------+----------+---------------+\n| 1       | login    | 2019-05-01    |\n| 1       | homepage | 2019-05-01    |\n| 1       | logout   | 2019-05-01    |\n| 2       | login    | 2019-06-21    |\n| 2       | logout   | 2019-06-21    |\n| 3       | login    | 2019-01-01    |\n| 3       | jobs     | 2019-01-01    |\n| 3       | logout   | 2019-01-01    |\n| 4       | login    | 2019-06-21    |\n| 4       | groups   | 2019-06-21    |\n| 4       | logout   | 2019-06-21    |\n| 5       | login    | 2019-03-01    |\n| 5       | logout   | 2019-03-01    |\n| 5       | login    | 2019-06-21    |\n| 5       | logout   | 2019-06-21    |\n+---------+----------+---------------+\n\nResult 表：\n+------------+-------------+\n| login_date | user_count  |\n+------------+-------------+\n| 2019-05-01 | 1           |\n| 2019-06-21 | 2           |\n+------------+-------------+\n请注意，我们只关心用户数非零的日期.\nID 为 5 的用户第一次登陆于 2019-03-01，因此他不算在 2019-06-21 的的统计内。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> login_date<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> user_count</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> user_id<span class=\"token punctuation\">,</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>activity_date<span class=\"token punctuation\">)</span> login_date</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">from</span> Traffic</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">where</span> activity <span class=\"token operator\">=</span> <span class=\"token string\">'login'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> user_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">having</span> login_date<span class=\"token operator\">>=</span> DATE_ADD<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-06-30'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">INTERVAL</span> <span class=\"token operator\">-</span><span class=\"token number\">90</span> <span class=\"token keyword\">DAY</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> login_date</pre></td></tr></table></figure><h4 id=\"1112-每位学生的最高成绩\"><a class=\"anchor\" href=\"#1112-每位学生的最高成绩\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvaGlnaGVzdC1ncmFkZS1mb3ItZWFjaC1zdHVkZW50Lw==\">1112. 每位学生的最高成绩</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表： <code>Enrollments</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| student_id    | int     |\n| course_id     | int     |\n| grade         | int     |\n+---------------+---------+\n(student_id, course_id) 是该表的主键。\n</code></pre>\n<p>编写一个 SQL 查询，查询每位学生获得的最高成绩和它所对应的科目，若科目成绩并列，取  <code>course_id</code>  最小的一门。查询结果需按  <code>student_id</code>  增序进行排序。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Enrollments 表：\n+------------+-------------------+\n| student_id | course_id | grade |\n+------------+-----------+-------+\n| 2          | 2         | 95    |\n| 2          | 3         | 95    |\n| 1          | 1         | 90    |\n| 1          | 2         | 99    |\n| 3          | 1         | 80    |\n| 3          | 2         | 75    |\n| 3          | 3         | 82    |\n+------------+-----------+-------+\n\nResult 表：\n+------------+-------------------+\n| student_id | course_id | grade |\n+------------+-----------+-------+\n| 1          | 2         | 99    |\n| 2          | 2         | 95    |\n| 3          | 3         | 82    |\n+------------+-----------+-------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span>course_id <span class=\"token punctuation\">,</span>grade</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span>course_id <span class=\"token punctuation\">,</span>grade<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> student_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> grade <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>course_id<span class=\"token punctuation\">)</span> rK</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Enrollments</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1113-报告的记录\"><a class=\"anchor\" href=\"#1113-报告的记录\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVwb3J0ZWQtcG9zdHMv\">1113. 报告的记录</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>动作表： <code>Actions</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| post_id       | int     |\n| action_date   | date    | \n| action        | enum    |\n| extra         | varchar |\n+---------------+---------+\n此表没有主键，所以可能会有重复的行。\naction 字段是 ENUM 类型的，包含:('view', 'like', 'reaction', 'comment', 'report', 'share')\nextra 字段是可选的信息（可能为 null），其中的信息例如有：1.报告理由(a reason for report) 2.反应类型(a type of reaction)\n</code></pre>\n<p>编写一条 SQL，查询每种 <em><strong>报告理由</strong></em>（report reason）在昨天的报告数量。假设今天是 <strong>2019-07-05</strong>。</p>\n<p>查询及结果的格式示例：</p>\n<pre><code>Actions table:\n+---------+---------+-------------+--------+--------+\n| user_id | post_id | action_date | action | extra  |\n+---------+---------+-------------+--------+--------+\n| 1       | 1       | 2019-07-01  | view   | null   |\n| 1       | 1       | 2019-07-01  | like   | null   |\n| 1       | 1       | 2019-07-01  | share  | null   |\n| 2       | 4       | 2019-07-04  | view   | null   |\n| 2       | 4       | 2019-07-04  | report | spam   |\n| 3       | 4       | 2019-07-04  | view   | null   |\n| 3       | 4       | 2019-07-04  | report | spam   |\n| 4       | 3       | 2019-07-02  | view   | null   |\n| 4       | 3       | 2019-07-02  | report | spam   |\n| 5       | 2       | 2019-07-04  | view   | null   |\n| 5       | 2       | 2019-07-04  | report | racism |\n| 5       | 5       | 2019-07-04  | view   | null   |\n| 5       | 5       | 2019-07-04  | report | racism |\n+---------+---------+-------------+--------+--------+\n\nResult table:\n+---------------+--------------+\n| report_reason | report_count |\n+---------------+--------------+\n| spam          | 1            |\n| racism        | 2            |\n+---------------+--------------+ \n注意，我们只关心报告数量非零的结果。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\textra <span class=\"token keyword\">AS</span> report_reason<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> post_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> report_count</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tActions</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">WHERE</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">`</span><span class=\"token keyword\">action</span><span class=\"token punctuation\">`</span> <span class=\"token operator\">=</span> <span class=\"token string\">'report'</span> <span class=\"token operator\">AND</span> action_date <span class=\"token operator\">=</span> date_add<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-07-05'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">Interval</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">day</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\textra<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"1132-报告的记录-ii\"><a class=\"anchor\" href=\"#1132-报告的记录-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVwb3J0ZWQtcG9zdHMtaWkv\">1132. 报告的记录 II</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>动作表：  <code>Actions</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| post_id       | int     |\n| action_date   | date    |\n| action        | enum    |\n| extra         | varchar |\n+---------------+---------+\n这张表没有主键，并有可能存在重复的行。\naction 列的类型是 ENUM，可能的值为 ('view', 'like', 'reaction', 'comment', 'report', 'share')。\nextra 列拥有一些可选信息，例如：报告理由（a reason for report）或反应类型（a type of reaction）等。\n</code></pre>\n<p>移除表：  <code>Removals</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| post_id       | int     |\n| remove_date   | date    | \n+---------------+---------+\n这张表的主键是 post_id。\n这张表的每一行表示一个被移除的帖子，原因可能是由于被举报或被管理员审查。\n</code></pre>\n<p>编写一段 SQL 来查找：在被报告为垃圾广告的帖子中，被移除的帖子的每日平均占比，<strong>四舍五入到小数点后 2 位</strong>。</p>\n<p>查询结果的格式如下：</p>\n<pre><code>Actions table:\n+---------+---------+-------------+--------+--------+\n| user_id | post_id | action_date | action | extra  |\n+---------+---------+-------------+--------+--------+\n| 1       | 1       | 2019-07-01  | view   | null   |\n| 1       | 1       | 2019-07-01  | like   | null   |\n| 1       | 1       | 2019-07-01  | share  | null   |\n| 2       | 2       | 2019-07-04  | view   | null   |\n| 2       | 2       | 2019-07-04  | report | spam   |\n| 3       | 4       | 2019-07-04  | view   | null   |\n| 3       | 4       | 2019-07-04  | report | spam   |\n| 4       | 3       | 2019-07-02  | view   | null   |\n| 4       | 3       | 2019-07-02  | report | spam   |\n| 5       | 2       | 2019-07-03  | view   | null   |\n| 5       | 2       | 2019-07-03  | report | racism |\n| 5       | 5       | 2019-07-03  | view   | null   |\n| 5       | 5       | 2019-07-03  | report | racism |\n+---------+---------+-------------+--------+--------+\n\nRemovals table:\n+---------+-------------+\n| post_id | remove_date |\n+---------+-------------+\n| 2       | 2019-07-20  |\n| 3       | 2019-07-18  |\n+---------+-------------+\n\nResult table:\n+-----------------------+\n| average_daily_percent |\n+-----------------------+\n| 75.00                 |\n+-----------------------+\n2019-07-04 的垃圾广告移除率是 50%，因为有两张帖子被报告为垃圾广告，但只有一个得到移除。\n2019-07-02 的垃圾广告移除率是 100%，因为有一张帖子被举报为垃圾广告并得到移除。\n其余几天没有收到垃圾广告的举报，因此平均值为：(50 + 100) / 2 = 75%\n注意，输出仅需要一个平均值即可，我们并不关注移除操作的日期。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span><span class=\"token function\">AVG</span><span class=\"token punctuation\">(</span>proportion<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> average_daily_percent  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> actions<span class=\"token punctuation\">.</span>action_date<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> removals<span class=\"token punctuation\">.</span>post_id<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> actions<span class=\"token punctuation\">.</span>post_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> proportion</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">FROM</span> actions</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> removals</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">ON</span> actions<span class=\"token punctuation\">.</span>post_id <span class=\"token operator\">=</span> removals<span class=\"token punctuation\">.</span>post_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">WHERE</span> extra <span class=\"token operator\">=</span> <span class=\"token string\">'spam'</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> actions<span class=\"token punctuation\">.</span>action_date</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span> a</pre></td></tr></table></figure><blockquote>\n<p>要理解 spam 的含义</p>\n</blockquote>\n<h4 id=\"1126-查询活跃业务\"><a class=\"anchor\" href=\"#1126-查询活跃业务\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWN0aXZlLWJ1c2luZXNzZXMv\">1126. 查询活跃业务</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>事件表： <code>Events</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| business_id   | int     |\n| event_type    | varchar |\n| occurences    | int     | \n+---------------+---------+\n此表的主键是 (business_id, event_type)。\n表中的每一行记录了某种类型的事件在某些业务中多次发生的信息。\n</code></pre>\n<p>写一段 SQL 来查询所有活跃的业务。</p>\n<p>如果一个业务的某个事件类型的发生次数大于此事件类型在所有业务中的平均发生次数，并且该业务至少有两个这样的事件类型，那么该业务就可被看做是活跃业务。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Events table:\n+-------------+------------+------------+\n| business_id | event_type | occurences |\n+-------------+------------+------------+\n| 1           | reviews    | 7          |\n| 3           | reviews    | 3          |\n| 1           | ads        | 11         |\n| 2           | ads        | 7          |\n| 3           | ads        | 6          |\n| 1           | page views | 3          |\n| 2           | page views | 12         |\n+-------------+------------+------------+\n\n结果表\n+-------------+\n| business_id |\n+-------------+\n| 1           |\n+-------------+ \n'reviews'、 'ads' 和 'page views' 的总平均发生次数分别是 (7+3)/2=5, (11+7+6)/3=8, (3+12)/2=7.5。\nid 为 1 的业务有 7 个 'reviews' 事件（大于 5）和 11 个 'ads' 事件（大于 8），所以它是活跃业务。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> business_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> business_id<span class=\"token punctuation\">,</span>occurences<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>occurences<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> event_type<span class=\"token punctuation\">)</span> avo</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> Events</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span>  occurences <span class=\"token operator\">></span> avo</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> business_id</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">2</span></pre></td></tr></table></figure><h4 id=\"1127-用户购买平台\"><a class=\"anchor\" href=\"#1127-用户购买平台\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdXNlci1wdXJjaGFzZS1wbGF0Zm9ybS8=\">1127. 用户购买平台</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>支出表:  <code>Spending</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| user_id     | int     |\n| spend_date  | date    |\n| platform    | enum    | \n| amount      | int     |\n+-------------+---------+\n这张表记录了用户在一个在线购物网站的支出历史，该在线购物平台同时拥有桌面端（'desktop'）和手机端（'mobile'）的应用程序。\n这张表的主键是 (user_id, spend_date, platform)。\n平台列 platform 是一种 ENUM ，类型为（'desktop', 'mobile'）。\n</code></pre>\n<p>写一段 SQL 来查找每天 <strong>仅</strong> 使用手机端用户、<strong>仅</strong> 使用桌面端用户和 <strong>同时</strong> 使用桌面端和手机端的用户人数和总支出金额。</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Spending table:\n+---------+------------+----------+--------+\n| user_id | spend_date | platform | amount |\n+---------+------------+----------+--------+\n| 1       | 2019-07-01 | mobile   | 100    |\n| 1       | 2019-07-01 | desktop  | 100    |\n| 2       | 2019-07-01 | mobile   | 100    |\n| 2       | 2019-07-02 | mobile   | 100    |\n| 3       | 2019-07-01 | desktop  | 100    |\n| 3       | 2019-07-02 | desktop  | 100    |\n+---------+------------+----------+--------+\n\nResult table:\n+------------+----------+--------------+-------------+\n| spend_date | platform | total_amount | total_users |\n+------------+----------+--------------+-------------+\n| 2019-07-01 | desktop  | 100          | 1           |\n| 2019-07-01 | mobile   | 100          | 1           |\n| 2019-07-01 | both     | 200          | 1           |\n| 2019-07-02 | desktop  | 100          | 1           |\n| 2019-07-02 | mobile   | 100          | 1           |\n| 2019-07-02 | both     | 0            | 0           |\n+------------+----------+--------------+-------------+ \n在 2019-07-01, 用户1 同时 使用桌面端和手机端购买, 用户2 仅 使用了手机端购买，而用户3 仅 使用了桌面端购买。\n在 2019-07-02, 用户2 仅 使用了手机端购买, 用户3 仅 使用了桌面端购买，且没有用户 同时 使用桌面端和手机端购买。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    spend_date<span class=\"token punctuation\">,</span> platform<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ifnull<span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>total_am<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> total_amount<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    ifnull<span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>total_u<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> total_users</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">select</span> p<span class=\"token punctuation\">.</span>spend_date<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>platform<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span>total_am<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">.</span>total_u</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> spend_date<span class=\"token punctuation\">,</span> <span class=\"token string\">\"desktop\"</span> platform <span class=\"token keyword\">from</span> Spending</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> spend_date<span class=\"token punctuation\">,</span> <span class=\"token string\">\"mobile\"</span> platform <span class=\"token keyword\">from</span> Spending</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> spend_date<span class=\"token punctuation\">,</span> <span class=\"token string\">\"both\"</span> platform <span class=\"token keyword\">from</span> Spending</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">)</span> p</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">select</span> spend_date<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> platform<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> platform<span class=\"token punctuation\">,</span> <span class=\"token string\">'both'</span><span class=\"token punctuation\">)</span> plat<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> total_am<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> user_id<span class=\"token punctuation\">)</span> total_u</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">from</span> Spending</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> spend_date<span class=\"token punctuation\">,</span> user_id</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">on</span> p<span class=\"token punctuation\">.</span>platform <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>plat <span class=\"token operator\">and</span> p<span class=\"token punctuation\">.</span>spend_date <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>spend_date</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">temp</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> spend_date<span class=\"token punctuation\">,</span> platform</pre></td></tr></table></figure><blockquote>\n<p>必须保证 desktop mobile both 的顺序 ，所以 先列出三个字段</p>\n</blockquote>\n<h4 id=\"1141-查询近30天活跃用户数\"><a class=\"anchor\" href=\"#1141-查询近30天活跃用户数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdXNlci1hY3Rpdml0eS1mb3ItdGhlLXBhc3QtMzAtZGF5cy1pLw==\">1141. 查询近 30 天活跃用户数</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>活动记录表： <code>Activity</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| session_id    | int     |\n| activity_date | date    |\n| activity_type | enum    |\n+---------------+---------+\n该表是用户在社交网站的活动记录。\n该表没有主键，可能包含重复数据。\nactivity_type 字段为以下四种值 ('open_session', 'end_session', 'scroll_down', 'send_message')。\n每个 session_id 只属于一个用户。\n</code></pre>\n<p>请写 SQL 查询出截至 <strong>2019-07-27</strong>（包含 2019-07-27）<strong>，近</strong> 30 天的每日活跃用户数（当天只要有一条活动记录，即为活跃用户）。</p>\n<p>查询结果示例如下：</p>\n<pre><code>Activity table:\n+---------+------------+---------------+---------------+\n| user_id | session_id | activity_date | activity_type |\n+---------+------------+---------------+---------------+\n| 1       | 1          | 2019-07-20    | open_session  |\n| 1       | 1          | 2019-07-20    | scroll_down   |\n| 1       | 1          | 2019-07-20    | end_session   |\n| 2       | 4          | 2019-07-20    | open_session  |\n| 2       | 4          | 2019-07-21    | send_message  |\n| 2       | 4          | 2019-07-21    | end_session   |\n| 3       | 2          | 2019-07-21    | open_session  |\n| 3       | 2          | 2019-07-21    | send_message  |\n| 3       | 2          | 2019-07-21    | end_session   |\n| 4       | 3          | 2019-06-25    | open_session  |\n| 4       | 3          | 2019-06-25    | end_session   |\n+---------+------------+---------------+---------------+\n\nResult table:\n+------------+--------------+ \n| day        | active_users |\n+------------+--------------+ \n| 2019-07-20 | 2            |\n| 2019-07-21 | 2            |\n+------------+--------------+ \n非活跃用户的记录不需要展示。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> activity_date <span class=\"token keyword\">day</span><span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> user_id<span class=\"token punctuation\">)</span> active_users</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> activity_date <span class=\"token operator\">></span> date_add<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-07-27'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">INTERVAL</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">MONTH</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> activity_date</pre></td></tr></table></figure><h4 id=\"1142-过去30天的用户活动-ii\"><a class=\"anchor\" href=\"#1142-过去30天的用户活动-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdXNlci1hY3Rpdml0eS1mb3ItdGhlLXBhc3QtMzAtZGF5cy1paS8=\">1142. 过去 30 天的用户活动 II</span></h4>\n<p>难度简单 7 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Activity</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| session_id    | int     |\n| activity_date | date    |\n| activity_type | enum    |\n+---------------+---------+\n该表没有主键，它可能有重复的行。\nactivity_type列是一种类型的ENUM（“ open_session”，“ end_session”，“ scroll_down”，“ send_message”）。\n该表显示了社交媒体网站的用户活动。\n请注意，每个会话完全属于一个用户。\n</code></pre>\n<p>编写 SQL 查询以查找截至 2019 年 7 月 27 日（含）的 30 天内每个用户的平均会话数，四舍五入到小数点后两位。我们只统计那些会话期间用户至少进行一项活动的有效会话。</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Activity table:\n+---------+------------+---------------+---------------+\n| user_id | session_id | activity_date | activity_type |\n+---------+------------+---------------+---------------+\n| 1       | 1          | 2019-07-20    | open_session  |\n| 1       | 1          | 2019-07-20    | scroll_down   |\n| 1       | 1          | 2019-07-20    | end_session   |\n| 2       | 4          | 2019-07-20    | open_session  |\n| 2       | 4          | 2019-07-21    | send_message  |\n| 2       | 4          | 2019-07-21    | end_session   |\n| 3       | 2          | 2019-07-21    | open_session  |\n| 3       | 2          | 2019-07-21    | send_message  |\n| 3       | 2          | 2019-07-21    | end_session   |\n| 3       | 5          | 2019-07-21    | open_session  |\n| 3       | 5          | 2019-07-21    | scroll_down   |\n| 3       | 5          | 2019-07-21    | end_session   |\n| 4       | 3          | 2019-06-25    | open_session  |\n| 4       | 3          | 2019-06-25    | end_session   |\n+---------+------------+---------------+---------------+\n\nResult table:\n+---------------------------+ \n| average_sessions_per_user |\n+---------------------------+ \n| 1.33                      |\n+---------------------------+ \nUser 1 和 2 在过去30天内各自进行了1次会话，而用户3进行了2次会话，因此平均值为（1 +1 + 2）/ 3 = 1.33。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> IFNULL<span class=\"token punctuation\">(</span><span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span><span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> session_id<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> user_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> average_sessions_per_user</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Activity</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> activity_date <span class=\"token operator\">></span> date_add<span class=\"token punctuation\">(</span><span class=\"token string\">'2019-07-27'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">INTERVAL</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">MONTH</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><blockquote>\n<p>1 个 session id 代表一次会话</p>\n</blockquote>\n<h4 id=\"1148-文章浏览-i\"><a class=\"anchor\" href=\"#1148-文章浏览-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYXJ0aWNsZS12aWV3cy1pLw==\">1148. 文章浏览 I</span></h4>\n<p>难度简单 3 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p><code>Views</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| article_id    | int     |\n| author_id     | int     |\n| viewer_id     | int     |\n| view_date     | date    |\n+---------------+---------+\n此表无主键，因此可能会存在重复行。\n此表的每一行都表示某人在某天浏览了某位作者的某篇文章。\n请注意，同一人的 author_id 和 viewer_id 是相同的。\n</code></pre>\n<p>请编写一条 SQL 查询以找出所有浏览过自己文章的作者，结果按照 id 升序排列。</p>\n<p>查询结果的格式如下所示：</p>\n<pre><code>Views 表：\n+------------+-----------+-----------+------------+\n| article_id | author_id | viewer_id | view_date  |\n+------------+-----------+-----------+------------+\n| 1          | 3         | 5         | 2019-08-01 |\n| 1          | 3         | 6         | 2019-08-02 |\n| 2          | 7         | 7         | 2019-08-01 |\n| 2          | 7         | 6         | 2019-08-02 |\n| 4          | 7         | 1         | 2019-07-22 |\n| 3          | 4         | 4         | 2019-07-21 |\n| 3          | 4         | 4         | 2019-07-21 |\n+------------+-----------+-----------+------------+\n\n结果表：\n+------+\n| id   |\n+------+\n| 4    |\n| 7    |\n+------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> author_id id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Views</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> author_id<span class=\"token operator\">=</span>  viewer_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> id</pre></td></tr></table></figure><h4 id=\"1149-文章浏览-ii\"><a class=\"anchor\" href=\"#1149-文章浏览-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYXJ0aWNsZS12aWV3cy1paS8=\">1149. 文章浏览 II</span></h4>\n<p>难度中等 4 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Views</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| article_id    | int     |\n| author_id     | int     |\n| viewer_id     | int     |\n| view_date     | date    |\n+---------------+---------+\n此表无主键，因此可能会存在重复行。此表的每一行都表示某人在某天浏览了某位作者的某篇文章。 请注意，同一人的 author_id 和 viewer_id 是相同的。\n</code></pre>\n<p>编写一条 SQL 查询来找出在同一天阅读至少两篇文章的人，结果按照 id 升序排序。</p>\n<p>查询结果的格式如下：</p>\n<pre><code>Views table:\n+------------+-----------+-----------+------------+\n| article_id | author_id | viewer_id | view_date  |\n+------------+-----------+-----------+------------+\n| 1          | 3         | 5         | 2019-08-01 |\n| 3          | 4         | 5         | 2019-08-01 |\n| 1          | 3         | 6         | 2019-08-02 |\n| 2          | 7         | 7         | 2019-08-01 |\n| 2          | 7         | 6         | 2019-08-02 |\n| 4          | 7         | 1         | 2019-07-22 |\n| 3          | 4         | 4         | 2019-07-21 |\n| 3          | 4         | 4         | 2019-07-21 |\n+------------+-----------+-----------+------------+\n\nResult table:\n+------+\n| id   |\n+------+\n| 5    |\n| 6    |\n+------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span> viewer_id <span class=\"token keyword\">AS</span> id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> Views</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> view_date<span class=\"token punctuation\">,</span> viewer_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">HAVING</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">DISTINCT</span> article_id<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> viewer_id</pre></td></tr></table></figure><h4 id=\"1158-市场分析-i\"><a class=\"anchor\" href=\"#1158-市场分析-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbWFya2V0LWFuYWx5c2lzLWkv\">1158. 市场分析 I</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Users</code></p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| user_id        | int     |\n| join_date      | date    |\n| favorite_brand | varchar |\n+----------------+---------+\n此表主键是 user_id，表中描述了购物网站的用户信息，用户可以在此网站上进行商品买卖。\n</code></pre>\n<p>Table:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| order_date    | date    |\n| item_id       | int     |\n| buyer_id      | int     |\n| seller_id     | int     |\n+---------------+---------+\n此表主键是 order_id，外键是 item_id 和（buyer_id，seller_id）。\n</code></pre>\n<p>Table:  <code>Item</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| item_id       | int     |\n| item_brand    | varchar |\n+---------------+---------+\n此表主键是 item_id。\n</code></pre>\n<p>请写出一条 SQL 语句以查询每个用户的注册日期和在 <strong>2019</strong> 年作为买家的订单总数。</p>\n<p>查询结果格式如下：</p>\n<pre><code>Users table:\n+---------+------------+----------------+\n| user_id | join_date  | favorite_brand |\n+---------+------------+----------------+\n| 1       | 2018-01-01 | Lenovo         |\n| 2       | 2018-02-09 | Samsung        |\n| 3       | 2018-01-19 | LG             |\n| 4       | 2018-05-21 | HP             |\n+---------+------------+----------------+\n\nOrders table:\n+----------+------------+---------+----------+-----------+\n| order_id | order_date | item_id | buyer_id | seller_id |\n+----------+------------+---------+----------+-----------+\n| 1        | 2019-08-01 | 4       | 1        | 2         |\n| 2        | 2018-08-02 | 2       | 1        | 3         |\n| 3        | 2019-08-03 | 3       | 2        | 3         |\n| 4        | 2018-08-04 | 1       | 4        | 2         |\n| 5        | 2018-08-04 | 1       | 3        | 4         |\n| 6        | 2019-08-05 | 2       | 2        | 4         |\n+----------+------------+---------+----------+-----------+\n\nItems table:\n+---------+------------+\n| item_id | item_brand |\n+---------+------------+\n| 1       | Samsung    |\n| 2       | Lenovo     |\n| 3       | LG         |\n| 4       | HP         |\n+---------+------------+\n\nResult table:\n+-----------+------------+----------------+\n| buyer_id  | join_date  | orders_in_2019 |\n+-----------+------------+----------------+\n| 1         | 2018-01-01 | 1              |\n| 2         | 2018-02-09 | 2              |\n| 3         | 2018-01-19 | 0              |\n| 4         | 2018-05-21 | 0              |\n+-----------+------------+----------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> user_id buyer_id<span class=\"token punctuation\">,</span>join_date<span class=\"token punctuation\">,</span> ifnull<span class=\"token punctuation\">(</span>cnt<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>orders_in_2019</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Users u <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> buyer_id<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Orders</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token keyword\">year</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">2019</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span>  buyer_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">on</span> u<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span>t1<span class=\"token punctuation\">.</span>buyer_id</pre></td></tr></table></figure><h4 id=\"1159-市场分析-ii\"><a class=\"anchor\" href=\"#1159-市场分析-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbWFya2V0LWFuYWx5c2lzLWlpLw==\">1159. 市场分析 II</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>表:  <code>Users</code></p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| user_id        | int     |\n| join_date      | date    |\n| favorite_brand | varchar |\n+----------------+---------+\nuser_id 是该表的主键\n表中包含一位在线购物网站用户的个人信息，用户可以在该网站出售和购买商品。\n</code></pre>\n<p>表:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| order_date    | date    |\n| item_id       | int     |\n| buyer_id      | int     |\n| seller_id     | int     |\n+---------------+---------+\norder_id 是该表的主键\nitem_id 是 Items 表的外键\nbuyer_id 和 seller_id 是 Users 表的外键\n</code></pre>\n<p>表:  <code>Items</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| item_id       | int     |\n| item_brand    | varchar |\n+---------------+---------+\nitem_id 是该表的主键\n</code></pre>\n<p>写一个 SQL 查询确定每一个用户按日期顺序卖出的第二件商品的品牌是否是他们最喜爱的品牌。如果一个用户卖出少于两件商品，查询的结果是  <code>no</code>  。</p>\n<p>题目保证没有一个用户在一天中卖出超过一件商品</p>\n<p>下面是查询结果格式的例子：</p>\n<pre><code>Users table:\n+---------+------------+----------------+\n| user_id | join_date  | favorite_brand |\n+---------+------------+----------------+\n| 1       | 2019-01-01 | Lenovo         |\n| 2       | 2019-02-09 | Samsung        |\n| 3       | 2019-01-19 | LG             |\n| 4       | 2019-05-21 | HP             |\n+---------+------------+----------------+\n\nOrders table:\n+----------+------------+---------+----------+-----------+\n| order_id | order_date | item_id | buyer_id | seller_id |\n+----------+------------+---------+----------+-----------+\n| 1        | 2019-08-01 | 4       | 1        | 2         |\n| 2        | 2019-08-02 | 2       | 1        | 3         |\n| 3        | 2019-08-03 | 3       | 2        | 3         |\n| 4        | 2019-08-04 | 1       | 4        | 2         |\n| 5        | 2019-08-04 | 1       | 3        | 4         |\n| 6        | 2019-08-05 | 2       | 2        | 4         |\n+----------+------------+---------+----------+-----------+\n\nItems table:\n+---------+------------+\n| item_id | item_brand |\n+---------+------------+\n| 1       | Samsung    |\n| 2       | Lenovo     |\n| 3       | LG         |\n| 4       | HP         |\n+---------+------------+\n\nResult table:\n+-----------+--------------------+\n| seller_id | 2nd_item_fav_brand |\n+-----------+--------------------+\n| 1         | no                 |\n| 2         | yes                |\n| 3         | yes                |\n| 4         | no                 |\n+-----------+--------------------+\n\nid 为 1 的用户的查询结果是 no，因为他什么也没有卖出\nid为 2 和 3 的用户的查询结果是 yes，因为他们卖出的第二件商品的品牌是他们自己最喜爱的品牌\nid为 4 的用户的查询结果是 no，因为他卖出的第二件商品的品牌不是他最喜爱的品牌\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> user_id seller_id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>item_brand<span class=\"token operator\">=</span>favorite_brand<span class=\"token punctuation\">,</span><span class=\"token string\">'yes'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'no'</span><span class=\"token punctuation\">)</span> <span class=\"token number\">2</span>nd_item_fav_brand </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Users u</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> i<span class=\"token punctuation\">.</span>item_id<span class=\"token punctuation\">,</span>seller_id<span class=\"token punctuation\">,</span>item_brand</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> Items i</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">join</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">select</span> seller_id<span class=\"token punctuation\">,</span>item_id<span class=\"token punctuation\">,</span>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> seller_id  <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> order_date <span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">from</span> Orders </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">)</span>t1 </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">on</span> i<span class=\"token punctuation\">.</span>item_id <span class=\"token operator\">=</span> t1<span class=\"token punctuation\">.</span>item_id </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">where</span> rk  <span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">on</span> u<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>seller_id</pre></td></tr></table></figure><h4 id=\"1164-指定日期的产品价格\"><a class=\"anchor\" href=\"#1164-指定日期的产品价格\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcHJvZHVjdC1wcmljZS1hdC1hLWdpdmVuLWRhdGUv\">1164. 指定日期的产品价格</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>产品数据表:  <code>Products</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| new_price     | int     |\n| change_date   | date    |\n+---------------+---------+\n这张表的主键是 (product_id, change_date)。\n这张表的每一行分别记录了 某产品 在某个日期 更改后 的新价格。\n</code></pre>\n<p>写一段 SQL 来查找在 <strong>2019-08-16</strong> 时全部产品的价格，假设所有产品在修改前的价格都是 <strong>10。</strong></p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Products table:\n+------------+-----------+-------------+\n| product_id | new_price | change_date |\n+------------+-----------+-------------+\n| 1          | 20        | 2019-08-14  |\n| 2          | 50        | 2019-08-14  |\n| 1          | 30        | 2019-08-15  |\n| 1          | 35        | 2019-08-16  |\n| 2          | 65        | 2019-08-17  |\n| 3          | 20        | 2019-08-18  |\n+------------+-----------+-------------+\n\nResult table:\n+------------+-------+\n| product_id | price |\n+------------+-------+\n| 2          | 50    |\n| 1          | 35    |\n| 3          | 10    |\n+------------+-------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> p<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>t1<span class=\"token punctuation\">.</span>new_price<span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> price</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Products p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> product_id<span class=\"token punctuation\">,</span>new_price</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">select</span> product_id<span class=\"token punctuation\">,</span>new_price<span class=\"token punctuation\">,</span>change_date<span class=\"token punctuation\">,</span><span class=\"token function\">Max</span><span class=\"token punctuation\">(</span>change_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> product_id  <span class=\"token punctuation\">)</span> md</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">from</span>  Products</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">where</span> change_date<span class=\"token operator\">&lt;=</span><span class=\"token string\">'2019-08-16'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">)</span>tmp</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">where</span> change_date <span class=\"token operator\">=</span> md</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">on</span> p<span class=\"token punctuation\">.</span> product_id <span class=\"token operator\">=</span> t1<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> price <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><h4 id=\"1173-即时食物配送-i\"><a class=\"anchor\" href=\"#1173-即时食物配送-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvaW1tZWRpYXRlLWZvb2QtZGVsaXZlcnktaS8=\">1173. 即时食物配送 I</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>配送表:  <code>Delivery</code></p>\n<pre><code>+-----------------------------+---------+\n| Column Name                 | Type    |\n+-----------------------------+---------+\n| delivery_id                 | int     |\n| customer_id                 | int     |\n| order_date                  | date    |\n| customer_pref_delivery_date | date    |\n+-----------------------------+---------+\ndelivery_id 是表的主键。\n该表保存着顾客的食物配送信息，顾客在某个日期下了订单，并指定了一个期望的配送日期（和下单日期相同或者在那之后）。\n</code></pre>\n<p>如果顾客期望的配送日期和下单日期相同，则该订单称为 「即时订单」，否则称为「计划订单」。</p>\n<p>写一条 SQL 查询语句获取即时订单所占的百分比， <strong>保留两位小数。</strong></p>\n<p>查询结果如下所示：</p>\n<pre><code>Delivery 表:\n+-------------+-------------+------------+-----------------------------+\n| delivery_id | customer_id | order_date | customer_pref_delivery_date |\n+-------------+-------------+------------+-----------------------------+\n| 1           | 1           | 2019-08-01 | 2019-08-02                  |\n| 2           | 5           | 2019-08-02 | 2019-08-02                  |\n| 3           | 1           | 2019-08-11 | 2019-08-11                  |\n| 4           | 3           | 2019-08-24 | 2019-08-26                  |\n| 5           | 4           | 2019-08-21 | 2019-08-22                  |\n| 6           | 2           | 2019-08-11 | 2019-08-13                  |\n+-------------+-------------+------------+-----------------------------+\n\nResult 表:\n+----------------------+\n| immediate_percentage |\n+----------------------+\n| 33.33                |\n+----------------------+\n2 和 3 号订单为即时订单，其他的为计划订单。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>order_date<span class=\"token operator\">=</span>customer_pref_delivery_date<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> immediate_percentage</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Delivery</pre></td></tr></table></figure><h4 id=\"1174-即时食物配送-ii\"><a class=\"anchor\" href=\"#1174-即时食物配送-ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvaW1tZWRpYXRlLWZvb2QtZGVsaXZlcnktaWkv\">1174. 即时食物配送 II</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>配送表:  <code>Delivery</code></p>\n<pre><code>+-----------------------------+---------+\n| Column Name                 | Type    |\n+-----------------------------+---------+\n| delivery_id                 | int     |\n| customer_id                 | int     |\n| order_date                  | date    |\n| customer_pref_delivery_date | date    |\n+-----------------------------+---------+\ndelivery_id 是表的主键。\n该表保存着顾客的食物配送信息，顾客在某个日期下了订单，并指定了一个期望的配送日期（和下单日期相同或者在那之后）。\n</code></pre>\n<p>如果顾客期望的配送日期和下单日期相同，则该订单称为 「即时订单」，否则称为「计划订单」。</p>\n<p>「首次订单」是顾客最早创建的订单。我们保证一个顾客只会有一个「首次订单」。</p>\n<p>写一条 SQL 查询语句获取即时订单在所有用户的首次订单中的比例。<strong>保留两位小数。</strong></p>\n<p>查询结果如下所示：</p>\n<pre><code>Delivery 表：\n+-------------+-------------+------------+-----------------------------+\n| delivery_id | customer_id | order_date | customer_pref_delivery_date |\n+-------------+-------------+------------+-----------------------------+\n| 1           | 1           | 2019-08-01 | 2019-08-02                  |\n| 2           | 2           | 2019-08-02 | 2019-08-02                  |\n| 3           | 1           | 2019-08-11 | 2019-08-12                  |\n| 4           | 3           | 2019-08-24 | 2019-08-24                  |\n| 5           | 3           | 2019-08-21 | 2019-08-22                  |\n| 6           | 2           | 2019-08-11 | 2019-08-13                  |\n| 7           | 4           | 2019-08-09 | 2019-08-09                  |\n+-------------+-------------+------------+-----------------------------+\n\nResult 表：\n+----------------------+\n| immediate_percentage |\n+----------------------+\n| 50.00                |\n+----------------------+\n1 号顾客的 1 号订单是首次订单，并且是计划订单。\n2 号顾客的 2 号订单是首次订单，并且是即时订单。\n3 号顾客的 5 号订单是首次订单，并且是计划订单。\n4 号顾客的 7 号订单是首次订单，并且是即时订单。\n因此，一半顾客的首次订单是即时的。\n</code></pre>\n<p>开窗</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>order_date <span class=\"token operator\">=</span> fo <span class=\"token operator\">&amp;&amp;</span> fo<span class=\"token operator\">=</span>d<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> customer_id<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> immediate_percentage </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> customer_id<span class=\"token punctuation\">,</span>order_date<span class=\"token punctuation\">,</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> customer_id<span class=\"token punctuation\">)</span> fo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>order_date<span class=\"token operator\">=</span>customer_pref_delivery_date<span class=\"token punctuation\">,</span>order_date <span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> d</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Delivery</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr></table></figure><p>另一种思路</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token function\">round</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>order_date <span class=\"token operator\">=</span> customer_pref_delivery_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span> <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> immediate_percentage</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Delivery</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token punctuation\">(</span>customer_id<span class=\"token punctuation\">,</span> order_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">select</span> customer_id<span class=\"token punctuation\">,</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">from</span> delivery</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_id</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1179-重新格式化部门表\"><a class=\"anchor\" href=\"#1179-重新格式化部门表\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVmb3JtYXQtZGVwYXJ0bWVudC10YWJsZS8=\">1179. 重新格式化部门表</span></h4>\n<p>难度</p>\n<p>SQL 架构</p>\n<p>部门表  <code>Department</code> ：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| revenue       | int     |\n| month         | varchar |\n+---------------+---------+\n(id, month) 是表的联合主键。\n这个表格有关于每个部门每月收入的信息。\n月份（month）可以取下列值 [&quot;Jan&quot;,&quot;Feb&quot;,&quot;Mar&quot;,&quot;Apr&quot;,&quot;May&quot;,&quot;Jun&quot;,&quot;Jul&quot;,&quot;Aug&quot;,&quot;Sep&quot;,&quot;Oct&quot;,&quot;Nov&quot;,&quot;Dec&quot;]。\n</code></pre>\n<p>编写一个 SQL 查询来重新格式化表，使得新的表中有一个部门 id 列和一些对应 <strong>每个月</strong> 的收入（revenue）列。</p>\n<p>查询结果格式如下面的示例所示：</p>\n<pre><code>Department 表：\n+------+---------+-------+\n| id   | revenue | month |\n+------+---------+-------+\n| 1    | 8000    | Jan   |\n| 2    | 9000    | Jan   |\n| 3    | 10000   | Feb   |\n| 1    | 7000    | Feb   |\n| 1    | 6000    | Mar   |\n+------+---------+-------+\n\n查询得到的结果表：\n+------+-------------+-------------+-------------+-----+-------------+\n| id   | Jan_Revenue | Feb_Revenue | Mar_Revenue | ... | Dec_Revenue |\n+------+-------------+-------------+-------------+-----+-------------+\n| 1    | 8000        | 7000        | 6000        | ... | null        |\n| 2    | 9000        | null        | null        | ... | null        |\n| 3    | null        | 10000       | null        | ... | null        |\n+------+-------------+-------------+-------------+-----+-------------+\n\n注意，结果表有 13 列 (1个部门 id 列 + 12个月份的收入列)。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Jan'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Jan_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Feb'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Feb_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Mar'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Mar_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Apr'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Apr_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'May'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> May_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Jun'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Jun_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Jul'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Jul_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Aug'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Aug_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Sep'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Sep_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Oct'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Oct_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Nov'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Nov_Revenue<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token punctuation\">`</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">`</span> <span class=\"token keyword\">WHEN</span> <span class=\"token string\">'Dec'</span> <span class=\"token keyword\">THEN</span> revenue <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> Dec_Revenue</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">FROM</span> Department</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1193.</span> 每月交易 I</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">SQL</span>架构</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">Table</span>: <span class=\"token keyword\">Transactions</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+---------+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token keyword\">Column</span> Name   <span class=\"token operator\">|</span> <span class=\"token keyword\">Type</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+---------+</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">|</span> id            <span class=\"token operator\">|</span> <span class=\"token keyword\">int</span>     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">|</span> country       <span class=\"token operator\">|</span> <span class=\"token keyword\">varchar</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">|</span> state         <span class=\"token operator\">|</span> <span class=\"token keyword\">enum</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">|</span> amount        <span class=\"token operator\">|</span> <span class=\"token keyword\">int</span>     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">|</span> trans_date    <span class=\"token operator\">|</span> <span class=\"token keyword\">date</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">---------------+---------+</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>id 是这个表的主键。</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>该表包含有关传入事务的信息。</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>state 列类型为 “<span class=\"token punctuation\">[</span>”批准“，”拒绝“<span class=\"token punctuation\">]</span> 之一。</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>编写一个 <span class=\"token keyword\">sql</span> 查询来查找每个月和每个国家<span class=\"token operator\">/</span>地区的事务数及其总金额、已批准的事务数及其总金额。</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>查询结果格式如下所示：</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">Transactions</span> <span class=\"token keyword\">table</span>:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------+---------+----------+--------+------------+</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token operator\">|</span> id   <span class=\"token operator\">|</span> country <span class=\"token operator\">|</span> state    <span class=\"token operator\">|</span> amount <span class=\"token operator\">|</span> trans_date <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------+---------+----------+--------+------------+</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">121</span>  <span class=\"token operator\">|</span> US      <span class=\"token operator\">|</span> approved <span class=\"token operator\">|</span> <span class=\"token number\">1000</span>   <span class=\"token operator\">|</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">12</span><span class=\"token operator\">-</span><span class=\"token number\">18</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">122</span>  <span class=\"token operator\">|</span> US      <span class=\"token operator\">|</span> declined <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>   <span class=\"token operator\">|</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">12</span><span class=\"token operator\">-</span><span class=\"token number\">19</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">123</span>  <span class=\"token operator\">|</span> US      <span class=\"token operator\">|</span> approved <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>   <span class=\"token operator\">|</span> <span class=\"token number\">2019</span><span class=\"token operator\">-</span><span class=\"token number\">01</span><span class=\"token operator\">-</span><span class=\"token number\">01</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">124</span>  <span class=\"token operator\">|</span> DE      <span class=\"token operator\">|</span> approved <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>   <span class=\"token operator\">|</span> <span class=\"token number\">2019</span><span class=\"token operator\">-</span><span class=\"token number\">01</span><span class=\"token operator\">-</span><span class=\"token number\">07</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">------+---------+----------+--------+------------+</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Result <span class=\"token keyword\">table</span>:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+---------+-------------+----------------+--------------------+-----------------------+</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token keyword\">month</span>    <span class=\"token operator\">|</span> country <span class=\"token operator\">|</span> trans_count <span class=\"token operator\">|</span> approved_count <span class=\"token operator\">|</span> trans_total_amount <span class=\"token operator\">|</span> approved_total_amount <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+---------+-------------+----------------+--------------------+-----------------------+</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2018</span><span class=\"token operator\">-</span><span class=\"token number\">12</span>  <span class=\"token operator\">|</span> US      <span class=\"token operator\">|</span> <span class=\"token number\">2</span>           <span class=\"token operator\">|</span> <span class=\"token number\">1</span>              <span class=\"token operator\">|</span> <span class=\"token number\">3000</span>               <span class=\"token operator\">|</span> <span class=\"token number\">1000</span>                  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2019</span><span class=\"token operator\">-</span><span class=\"token number\">01</span>  <span class=\"token operator\">|</span> US      <span class=\"token operator\">|</span> <span class=\"token number\">1</span>           <span class=\"token operator\">|</span> <span class=\"token number\">1</span>              <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>               <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>                  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token number\">2019</span><span class=\"token operator\">-</span><span class=\"token number\">01</span>  <span class=\"token operator\">|</span> DE      <span class=\"token operator\">|</span> <span class=\"token number\">1</span>           <span class=\"token operator\">|</span> <span class=\"token number\">1</span>              <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>               <span class=\"token operator\">|</span> <span class=\"token number\">2000</span>                  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token operator\">+</span><span class=\"token comment\">----------+---------+-------------+----------------+--------------------+-----------------------+</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> DATE_FORMAT<span class=\"token punctuation\">(</span>trans_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    country<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> trans_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> approved_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> trans_total_amount<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> approved_total_amount</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token keyword\">Transactions</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span> country</pre></td></tr></table></figure><h4 id=\"1193-每月交易-i\"><a class=\"anchor\" href=\"#1193-每月交易-i\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbW9udGhseS10cmFuc2FjdGlvbnMtaS8=\">1193. 每月交易 I</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Transactions</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| country       | varchar |\n| state         | enum    |\n| amount        | int     |\n| trans_date    | date    |\n+---------------+---------+\nid 是这个表的主键。\n该表包含有关传入事务的信息。\nstate 列类型为 “[”批准“，”拒绝“] 之一。\n</code></pre>\n<p>编写一个 sql 查询来查找每个月和每个国家 / 地区的事务数及其总金额、已批准的事务数及其总金额。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Transactions table:\n+------+---------+----------+--------+------------+\n| id   | country | state    | amount | trans_date |\n+------+---------+----------+--------+------------+\n| 121  | US      | approved | 1000   | 2018-12-18 |\n| 122  | US      | declined | 2000   | 2018-12-19 |\n| 123  | US      | approved | 2000   | 2019-01-01 |\n| 124  | DE      | approved | 2000   | 2019-01-07 |\n+------+---------+----------+--------+------------+\n\nResult table:\n+----------+---------+-------------+----------------+--------------------+-----------------------+\n| month    | country | trans_count | approved_count | trans_total_amount | approved_total_amount |\n+----------+---------+-------------+----------------+--------------------+-----------------------+\n| 2018-12  | US      | 2           | 1              | 3000               | 1000                  |\n| 2019-01  | US      | 1           | 1              | 2000               | 2000                  |\n| 2019-01  | DE      | 1           | 1              | 2000               | 2000                  |\n+----------+---------+-------------+----------------+--------------------+-----------------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> DATE_FORMAT<span class=\"token punctuation\">(</span>trans_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    country<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> trans_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> approved_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> trans_total_amount<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">IF</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> approved_total_amount</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token keyword\">Transactions</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span> country</pre></td></tr></table></figure><h4 id=\"1205-每月交易ii\"><a class=\"anchor\" href=\"#1205-每月交易ii\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbW9udGhseS10cmFuc2FjdGlvbnMtaWkv\">1205. 每月交易 II</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Transactions</code>  记录表</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| id             | int     |\n| country        | varchar |\n| state          | enum    |\n| amount         | int     |\n| trans_date     | date    |\n+----------------+---------+\nid 是这个表的主键。\n该表包含有关传入事务的信息。\n状态列是类型为 [approved（已批准）、declined（已拒绝）] 的枚举。\n</code></pre>\n<p><code>Chargebacks</code>  表</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| trans_id       | int     |\n| charge_date    | date    |\n+----------------+---------+\n退单包含有关放置在事务表中的某些事务的传入退单的基本信息。\ntrans_id 是 transactions 表的 id 列的外键。\n每项退单都对应于之前进行的交易，即使未经批准。\n</code></pre>\n<p>编写一个 SQL 查询，以查找每个月和每个国家 / 地区的已批准交易的数量及其总金额、退单的数量及其总金额。</p>\n<p>注意：在您的查询中，给定月份和国家，忽略所有为零的行。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Transactions 表：\n+------+---------+----------+--------+------------+\n| id   | country | state    | amount | trans_date |\n+------+---------+----------+--------+------------+\n| 101  | US      | approved | 1000   | 2019-05-18 |\n| 102  | US      | declined | 2000   | 2019-05-19 |\n| 103  | US      | approved | 3000   | 2019-06-10 |\n| 104  | US      | declined | 4000   | 2019-06-13 |\n| 105  | US      | approved | 5000   | 2019-06-15 |\n+------+---------+----------+--------+------------+\n\nChargebacks 表：\n+------------+------------+\n| trans_id   | trans_date |\n+------------+------------+\n| 102        | 2019-05-29 |\n| 101        | 2019-06-30 |\n| 105        | 2019-09-18 |\n+------------+------------+\n\nResult 表：\n+----------+---------+----------------+-----------------+-------------------+--------------------+\n| month    | country | approved_count | approved_amount | chargeback_count  | chargeback_amount  |\n+----------+---------+----------------+-----------------+-------------------+--------------------+\n| 2019-05  | US      | 1              | 1000            | 1                 | 2000               |\n| 2019-06  | US      | 2              | 8000            | 1                 | 1000               |\n| 2019-09  | US      | 0              | 0               | 1                 | 5000               |\n+----------+---------+----------------+-----------------+-------------------+--------------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    date_format<span class=\"token punctuation\">(</span>trans_date<span class=\"token punctuation\">,</span> <span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    country<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">)</span> approved_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'approved'</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> approved_amount<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'chargeback'</span><span class=\"token punctuation\">)</span> chargeback_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token string\">'chargeback'</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> chargeback_amount</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token keyword\">transactions</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">union</span> <span class=\"token keyword\">all</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> country<span class=\"token punctuation\">,</span> <span class=\"token string\">'chargeback'</span> state<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>trans_date</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">from</span> chargebacks c <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token keyword\">transactions</span> t </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">on</span> c<span class=\"token punctuation\">.</span>trans_id <span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>id</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span> tmp </pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">,</span> country</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">having</span> approved_amount <span class=\"token operator\">or</span> chargeback_amount</pre></td></tr></table></figure><h4 id=\"1194-锦标赛优胜者\"><a class=\"anchor\" href=\"#1194-锦标赛优胜者\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdG91cm5hbWVudC13aW5uZXJzLw==\">1194. 锦标赛优胜者</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Players</code>  玩家表</p>\n<pre><code>+-------------+-------+\n| Column Name | Type  |\n+-------------+-------+\n| player_id   | int   |\n| group_id    | int   |\n+-------------+-------+\n玩家 ID 是此表的主键。\n此表的每一行表示每个玩家的组。\n</code></pre>\n<p><code>Matches</code>  赛事表</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| match_id      | int     |\n| first_player  | int     |\n| second_player | int     | \n| first_score   | int     |\n| second_score  | int     |\n+---------------+---------+\nmatch_id 是此表的主键。\n每一行是一场比赛的记录，第一名和第二名球员包含每场比赛的球员 ID。\n第一个玩家和第二个玩家的分数分别包含第一个玩家和第二个玩家的分数。\n你可以假设，在每一场比赛中，球员都属于同一组。\n</code></pre>\n<p>每组的获胜者是在组内得分最高的选手。如果平局，player_id <strong>最小</strong> 的选手获胜。</p>\n<p>编写一个 SQL 查询来查找每组中的获胜者。</p>\n<p>查询结果格式如下所示</p>\n<pre><code>Players 表:\n+-----------+------------+\n| player_id | group_id   |\n+-----------+------------+\n| 15        | 1          |\n| 25        | 1          |\n| 30        | 1          |\n| 45        | 1          |\n| 10        | 2          |\n| 35        | 2          |\n| 50        | 2          |\n| 20        | 3          |\n| 40        | 3          |\n+-----------+------------+\n\nMatches 表:\n+------------+--------------+---------------+-------------+--------------+\n| match_id   | first_player | second_player | first_score | second_score |\n+------------+--------------+---------------+-------------+--------------+\n| 1          | 15           | 45            | 3           | 0            |\n| 2          | 30           | 25            | 1           | 2            |\n| 3          | 30           | 15            | 2           | 0            |\n| 4          | 40           | 20            | 5           | 2            |\n| 5          | 35           | 50            | 1           | 1            |\n+------------+--------------+---------------+-------------+--------------+\n\nResult 表:\n+-----------+------------+\n| group_id  | player_id  |\n+-----------+------------+ \n| 1         | 15         |\n| 2         | 35         |\n| 3         | 40         |\n+-----------+------------+\n</code></pre>\n<p>union all</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> group_id<span class=\"token punctuation\">,</span> player_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> group_id<span class=\"token punctuation\">,</span> player_id<span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> score</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">-- 每个用户总的 first_score</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">SELECT</span> Players<span class=\"token punctuation\">.</span>group_id<span class=\"token punctuation\">,</span> Players<span class=\"token punctuation\">.</span>player_id<span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>Matches<span class=\"token punctuation\">.</span>first_score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> score</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">FROM</span> Players <span class=\"token keyword\">JOIN</span> Matches <span class=\"token keyword\">ON</span> Players<span class=\"token punctuation\">.</span>player_id <span class=\"token operator\">=</span> Matches<span class=\"token punctuation\">.</span>first_player</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> Players<span class=\"token punctuation\">.</span>player_id</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">UNION</span> <span class=\"token keyword\">ALL</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">-- 每个用户总的 second_score</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">SELECT</span> Players<span class=\"token punctuation\">.</span>group_id<span class=\"token punctuation\">,</span> Players<span class=\"token punctuation\">.</span>player_id<span class=\"token punctuation\">,</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>Matches<span class=\"token punctuation\">.</span>second_score<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> score</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">FROM</span> Players <span class=\"token keyword\">JOIN</span> Matches <span class=\"token keyword\">ON</span> Players<span class=\"token punctuation\">.</span>player_id <span class=\"token operator\">=</span> Matches<span class=\"token punctuation\">.</span>second_player</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> Players<span class=\"token punctuation\">.</span>player_id</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">)</span> s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> player_id</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> score <span class=\"token keyword\">DESC</span><span class=\"token punctuation\">,</span> player_id</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">)</span> result</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> group_id</pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> group_id<span class=\"token punctuation\">,</span> player_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> players<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>player_id <span class=\"token operator\">=</span> first_player<span class=\"token punctuation\">,</span> first_score<span class=\"token punctuation\">,</span> second_score<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> score</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">from</span> players <span class=\"token keyword\">join</span> matches</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">on</span> player_id <span class=\"token operator\">=</span> first_player <span class=\"token operator\">or</span> player_id <span class=\"token operator\">=</span> second_player</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> player_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> score <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span> player_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span> tmp</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> group_id</pre></td></tr></table></figure><h4 id=\"1204-最后一个能进入电梯的人\"><a class=\"anchor\" href=\"#1204-最后一个能进入电梯的人\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbGFzdC1wZXJzb24tdG8tZml0LWluLXRoZS1lbGV2YXRvci8=\">1204. 最后一个能进入电梯的人</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Queue</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| person_id   | int     |\n| person_name | varchar |\n| weight      | int     |\n| turn        | int     |\n+-------------+---------+\nperson_id 是这个表的主键。\n该表展示了所有等待电梯的人的信息。\n表中 person_id 和 turn 列将包含从 1 到 n 的所有数字，其中 n 是表中的行数。\n</code></pre>\n<p>电梯最大载重量为 <strong>1000</strong>。</p>\n<p>写一条 SQL 查询语句查找最后一个能进入电梯且不超过重量限制的  <code>person_name</code>  。题目确保队列中第一位的人可以进入电梯 。</p>\n<p>查询结果如下所示 :</p>\n<pre><code>Queue 表\n+-----------+-------------------+--------+------+\n| person_id | person_name       | weight | turn |\n+-----------+-------------------+--------+------+\n| 5         | George Washington | 250    | 1    |\n| 3         | John Adams        | 350    | 2    |\n| 6         | Thomas Jefferson  | 400    | 3    |\n| 2         | Will Johnliams    | 200    | 4    |\n| 4         | Thomas Jefferson  | 175    | 5    |\n| 1         | James Elephant    | 500    | 6    |\n+-----------+-------------------+--------+------+\n\nResult 表\n+-------------------+\n| person_name       |\n+-------------------+\n| Thomas Jefferson  |\n+-------------------+\n\n为了简化，Queue 表按 turn 列由小到大排序。\n上例中 George Washington(id 5), John Adams(id 3) 和 Thomas Jefferson(id 6) 将可以进入电梯,因为他们的体重和为 250 + 350 + 400 = 1000。\nThomas Jefferson(id 6) 是最后一个体重合适并进入电梯的人。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> person_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> person_name  <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>weight<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> turn<span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">from</span> Queue</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">where</span> t<span class=\"token operator\">&lt;=</span><span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> t <span class=\"token keyword\">desc</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1211-查询结果的质量和占比\"><a class=\"anchor\" href=\"#1211-查询结果的质量和占比\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcXVlcmllcy1xdWFsaXR5LWFuZC1wZXJjZW50YWdlLw==\">1211. 查询结果的质量和占比</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>查询表  <code>Queries</code> ：</p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| query_name  | varchar |\n| result      | varchar |\n| position    | int     |\n| rating      | int     |\n+-------------+---------+\n此表没有主键，并可能有重复的行。\n此表包含了一些从数据库中收集的查询信息。\n“位置”（position）列的值为 1 到 500 。\n“评分”（rating）列的值为 1 到 5 。评分小于 3 的查询被定义为质量很差的查询。\n</code></pre>\n<p>将查询结果的质量  <code>quality</code>  定义为：</p>\n<blockquote>\n<p>各查询结果的评分与其位置之间比率的平均值。</p>\n</blockquote>\n<p>将劣质查询百分比  <code>poor_query_percentage</code>  为：</p>\n<blockquote>\n<p>评分小于 3 的查询结果占全部查询结果的百分比。</p>\n</blockquote>\n<p>编写一组 SQL 来查找每次查询的 <code>名称</code>  ( <code>query_name</code> )、 <code>质量</code>  ( <code>quality</code> ) 和  <code>劣质查询百分比</code>  ( <code>poor_query_percentage</code> )。</p>\n<p><code>质量</code>  ( <code>quality</code> ) 和 <code>劣质查询百分比</code>  ( <code>poor_query_percentage</code> ) 都应四舍五入到小数点后两位。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Queries table:\n+------------+-------------------+----------+--------+\n| query_name | result            | position | rating |\n+------------+-------------------+----------+--------+\n| Dog        | Golden Retriever  | 1        | 5      |\n| Dog        | German Shepherd   | 2        | 5      |\n| Dog        | Mule              | 200      | 1      |\n| Cat        | Shirazi           | 5        | 2      |\n| Cat        | Siamese           | 3        | 3      |\n| Cat        | Sphynx            | 7        | 4      |\n+------------+-------------------+----------+--------+\n\nResult table:\n+------------+---------+-----------------------+\n| query_name | quality | poor_query_percentage |\n+------------+---------+-----------------------+\n| Dog        | 2.50    | 33.33                 |\n| Cat        | 0.66    | 33.33                 |\n+------------+---------+-----------------------+\n\nDog 查询结果的质量为 ((5 / 1) + (5 / 2) + (1 / 200)) / 3 = 2.50\nDog 查询结果的劣质查询百分比为 (1 / 3) * 100 = 33.33\n\nCat 查询结果的质量为 ((2 / 5) + (3 / 3) + (4 / 7)) / 3 = 0.66\nCat 查询结果的劣质查询百分比为 (1 / 3) * 100 = 33.33\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> query_name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>rating<span class=\"token operator\">/</span>position<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> quality<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>rating<span class=\"token operator\">&lt;</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> poor_query_percentage</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Queries</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> query_name</pre></td></tr></table></figure><h4 id=\"1212-查询球队积分\"><a class=\"anchor\" href=\"#1212-查询球队积分\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdGVhbS1zY29yZXMtaW4tZm9vdGJhbGwtdG91cm5hbWVudC8=\">1212. 查询球队积分</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Teams</code></p>\n<pre><code>+---------------+----------+\n| Column Name   | Type     |\n+---------------+----------+\n| team_id       | int      |\n| team_name     | varchar  |\n+---------------+----------+\n此表的主键是 team_id，表中的每一行都代表一支独立足球队。\n</code></pre>\n<p>Table:  <code>Matches</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| match_id      | int     |\n| host_team     | int     |\n| guest_team    | int     | \n| host_goals    | int     |\n| guest_goals   | int     |\n+---------------+---------+\n此表的主键是 match_id，表中的每一行都代表一场已结束的比赛，比赛的主客队分别由它们自己的 id 表示，他们的进球由 host_goals 和 guest_goals 分别表示。\n</code></pre>\n<p>积分规则如下：</p>\n<ul>\n<li>赢一场得三分；</li>\n<li>平一场得一分；</li>\n<li>输一场不得分。</li>\n</ul>\n<p>写出一条 SQL 语句以查询每个队的 <strong>team_id</strong>，<strong>team_name</strong> 和 <strong>num_points</strong>。结果根据 num_points <strong>降序排序</strong>，如果有两队积分相同，那么这两队按 team_id <strong>升序排序</strong>。</p>\n<p>查询结果格式如下：</p>\n<pre><code>Teams table:\n+-----------+--------------+\n| team_id   | team_name    |\n+-----------+--------------+\n| 10        | Leetcode FC  |\n| 20        | NewYork FC   |\n| 30        | Atlanta FC   |\n| 40        | Chicago FC   |\n| 50        | Toronto FC   |\n+-----------+--------------+\n\nMatches table:\n+------------+--------------+---------------+-------------+--------------+\n| match_id   | host_team    | guest_team    | host_goals  | guest_goals  |\n+------------+--------------+---------------+-------------+--------------+\n| 1          | 10           | 20            | 3           | 0            |\n| 2          | 30           | 10            | 2           | 2            |\n| 3          | 10           | 50            | 5           | 1            |\n| 4          | 20           | 30            | 1           | 0            |\n| 5          | 50           | 30            | 1           | 0            |\n+------------+--------------+---------------+-------------+--------------+\n\nResult table:\n+------------+--------------+---------------+\n| team_id    | team_name    | num_points    |\n+------------+--------------+---------------+\n| 10         | Leetcode FC  | 7             |\n| 20         | NewYork FC   | 3             |\n| 50         | Toronto FC   | 3             |\n| 30         | Atlanta FC   | 1             |\n| 40         | Chicago FC   | 0             |\n+------------+--------------+---------------+\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> team_id <span class=\"token punctuation\">,</span> team_name <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>team_id <span class=\"token operator\">=</span> host_team <span class=\"token operator\">&amp;&amp;</span> host_goals<span class=\"token operator\">></span>guest_goals <span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>team_id <span class=\"token operator\">=</span> host_team <span class=\"token operator\">&amp;&amp;</span> host_goals<span class=\"token operator\">=</span>guest_goals<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>team_id <span class=\"token operator\">=</span> guest_team <span class=\"token operator\">&amp;&amp;</span> host_goals<span class=\"token operator\">=</span>guest_goals<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>team_id <span class=\"token operator\">=</span> guest_team <span class=\"token operator\">&amp;&amp;</span> host_goals<span class=\"token operator\">&lt;</span>guest_goals <span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>num_points</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> Teams t <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Matches m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">on</span> t<span class=\"token punctuation\">.</span>team_id <span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>host_team  <span class=\"token operator\">or</span> t<span class=\"token punctuation\">.</span>team_id <span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>guest_team  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> team_id <span class=\"token punctuation\">,</span>team_name</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> num_points <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>team_id</pre></td></tr></table></figure><h4 id=\"1225-报告系统状态的连续日期\"><a class=\"anchor\" href=\"#1225-报告系统状态的连续日期\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVwb3J0LWNvbnRpZ3VvdXMtZGF0ZXMv\">1225. 报告系统状态的连续日期</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Failed</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| fail_date    | date    |\n+--------------+---------+\n该表主键为 fail_date。\n该表包含失败任务的天数.\n</code></pre>\n<p>Table:  <code>Succeeded</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| success_date | date    |\n+--------------+---------+\n该表主键为 success_date。\n该表包含成功任务的天数.\n</code></pre>\n<p>系统 <strong>每天</strong> 运行一个任务。每个任务都独立于先前的任务。任务的状态可以是失败或是成功。</p>\n<p>编写一个 SQL 查询 <strong>2019-01-01</strong> 到 <strong>2019-12-31</strong> 期间任务连续同状态  <code>period_state</code>  的起止日期（ <code>start_date</code>  和  <code>end_date</code> ）。即如果任务失败了，就是失败状态的起止日期，如果任务成功了，就是成功状态的起止日期。</p>\n<p>最后结果按照起始日期  <code>start_date</code>  排序</p>\n<p>查询结果样例如下所示:</p>\n<pre><code>Failed table:\n+-------------------+\n| fail_date         |\n+-------------------+\n| 2018-12-28        |\n| 2018-12-29        |\n| 2019-01-04        |\n| 2019-01-05        |\n+-------------------+\n\nSucceeded table:\n+-------------------+\n| success_date      |\n+-------------------+\n| 2018-12-30        |\n| 2018-12-31        |\n| 2019-01-01        |\n| 2019-01-02        |\n| 2019-01-03        |\n| 2019-01-06        |\n+-------------------+\n\n\nResult table:\n+--------------+--------------+--------------+\n| period_state | start_date   | end_date     |\n+--------------+--------------+--------------+\n| succeeded    | 2019-01-01   | 2019-01-03   |\n| failed       | 2019-01-04   | 2019-01-05   |\n| succeeded    | 2019-01-06   | 2019-01-06   |\n+--------------+--------------+--------------+\n\n结果忽略了 2018 年的记录，因为我们只关心从 2019-01-01 到 2019-12-31 的记录\n从 2019-01-01 到 2019-01-03 所有任务成功，系统状态为 &quot;succeeded&quot;。\n从 2019-01-04 到 2019-01-05 所有任务失败，系统状态为 &quot;failed&quot;。\n从 2019-01-06 到 2019-01-06 所有任务成功，系统状态为 &quot;succeeded&quot;。\n</code></pre>\n<p>开窗函数</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">type</span>  period_state<span class=\"token punctuation\">,</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span> start_date<span class=\"token punctuation\">,</span> <span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> end_date</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">,</span> subdate<span class=\"token punctuation\">(</span><span class=\"token keyword\">date</span><span class=\"token punctuation\">,</span>row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">type</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> diff</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token string\">'failed'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span> fail_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span> <span class=\"token keyword\">from</span> Failed</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">where</span> fail_date <span class=\"token operator\">between</span> <span class=\"token string\">'2019-01-01'</span> <span class=\"token operator\">and</span> <span class=\"token string\">'2019-12-31'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">union</span> <span class=\"token keyword\">all</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token string\">'succeeded'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span> success_date <span class=\"token keyword\">as</span> <span class=\"token keyword\">date</span> <span class=\"token keyword\">from</span> Succeeded</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">where</span> success_date <span class=\"token operator\">between</span> <span class=\"token string\">'2019-01-01'</span> <span class=\"token operator\">and</span> <span class=\"token string\">'2019-12-31'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">)</span> a</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">)</span>b</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span>diff</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> start_date</pre></td></tr></table></figure><h4 id=\"1241-每个帖子的评论数\"><a class=\"anchor\" href=\"#1241-每个帖子的评论数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbnVtYmVyLW9mLWNvbW1lbnRzLXBlci1wb3N0Lw==\">1241. 每个帖子的评论数</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表  <code>Submissions</code>  结构如下：</p>\n<pre><code>+---------------+----------+\n| 列名           | 类型     |\n+---------------+----------+\n| sub_id        | int      |\n| parent_id     | int      |\n+---------------+----------+\n上表没有主键, 所以可能会出现重复的行。\n每行可以是一个帖子或对该帖子的评论。\n如果是帖子的话，parent_id 就是 null。\n对于评论来说，parent_id 就是表中对应帖子的 sub_id。\n</code></pre>\n<p>编写 SQL 语句以查找每个帖子的评论数。</p>\n<p>结果表应包含帖子的  <code>post_id</code>  和对应的评论数  <code>number_of_comments</code>  并且按  <code>post_id</code>  升序排列。</p>\n<p><code>Submissions</code>  可能包含重复的评论。您应该计算每个帖子的唯一评论数。</p>\n<p><code>Submissions</code>  可能包含重复的帖子。您应该将它们视为一个帖子。</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Submissions table:\n+---------+------------+\n| sub_id  | parent_id  |\n+---------+------------+\n| 1       | Null       |\n| 2       | Null       |\n| 1       | Null       |\n| 12      | Null       |\n| 3       | 1          |\n| 5       | 2          |\n| 3       | 1          |\n| 4       | 1          |\n| 9       | 1          |\n| 10      | 2          |\n| 6       | 7          |\n+---------+------------+\n\n结果表：\n+---------+--------------------+\n| post_id | number_of_comments |\n+---------+--------------------+\n| 1       | 3                  |\n| 2       | 2                  |\n| 12      | 0                  |\n+---------+--------------------+\n\n表中 ID 为 1 的帖子有 ID 为 3、4 和 9 的三个评论。表中 ID 为 3 的评论重复出现了，所以我们只对它进行了一次计数。\n表中 ID 为 2 的帖子有 ID 为 5 和 10 的两个评论。\nID 为 12 的帖子在表中没有评论。\n表中 ID 为 6 的评论是对 ID 为 7 的已删除帖子的评论，因此我们将其忽略。\n</code></pre>\n<p>后 join</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> s<span class=\"token punctuation\">.</span>sub_id post_id<span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>number_of_comments<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> number_of_comments</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Submissions s</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">select</span> parent_id <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> sub_id<span class=\"token punctuation\">)</span> number_of_comments</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">from</span> Submissions </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> parent_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span> t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">on</span> s<span class=\"token punctuation\">.</span>sub_id <span class=\"token operator\">=</span> t1<span class=\"token punctuation\">.</span>parent_id</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span> s<span class=\"token punctuation\">.</span>parent_id  <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> post_id<span class=\"token punctuation\">,</span>number_of_comments</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> sub_id</pre></td></tr></table></figure><p>先 join</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> post_id<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>sub_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> number_of_comments</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span> post<span class=\"token punctuation\">.</span>sub_id <span class=\"token keyword\">AS</span> post_id<span class=\"token punctuation\">,</span> sub<span class=\"token punctuation\">.</span>sub_id <span class=\"token keyword\">AS</span> sub_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">FROM</span> Submissions post</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> Submissions sub</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">ON</span> post<span class=\"token punctuation\">.</span>sub_id <span class=\"token operator\">=</span> sub<span class=\"token punctuation\">.</span>parent_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">WHERE</span> post<span class=\"token punctuation\">.</span>parent_id <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span> T</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> post_id</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> post_id <span class=\"token keyword\">ASC</span></pre></td></tr></table></figure><h4 id=\"1251-平均售价\"><a class=\"anchor\" href=\"#1251-平均售价\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYXZlcmFnZS1zZWxsaW5nLXByaWNlLw==\">1251. 平均售价</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Prices</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| start_date    | date    |\n| end_date      | date    |\n| price         | int     |\n+---------------+---------+\n(product_id，start_date，end_date) 是 Prices 表的主键。\nPrices 表的每一行表示的是某个产品在一段时期内的价格。\n每个产品的对应时间段是不会重叠的，这也意味着同一个产品的价格时段不会出现交叉。\n</code></pre>\n<p>Table:  <code>UnitsSold</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| purchase_date | date    |\n| units         | int     |\n+---------------+---------+\nUnitsSold 表没有主键，它可能包含重复项。\nUnitsSold 表的每一行表示的是每种产品的出售日期，单位和产品 id。\n</code></pre>\n<p>编写 SQL 查询以查找每种产品的平均售价。<br />\n <code>average_price</code>  应该四舍五入到小数点后两位。<br />\n查询结果格式如下例所示：</p>\n<pre><code>Prices table:\n+------------+------------+------------+--------+\n| product_id | start_date | end_date   | price  |\n+------------+------------+------------+--------+\n| 1          | 2019-02-17 | 2019-02-28 | 5      |\n| 1          | 2019-03-01 | 2019-03-22 | 20     |\n| 2          | 2019-02-01 | 2019-02-20 | 15     |\n| 2          | 2019-02-21 | 2019-03-31 | 30     |\n+------------+------------+------------+--------+\n \nUnitsSold table:\n+------------+---------------+-------+\n| product_id | purchase_date | units |\n+------------+---------------+-------+\n| 1          | 2019-02-25    | 100   |\n| 1          | 2019-03-01    | 15    |\n| 2          | 2019-02-10    | 200   |\n| 2          | 2019-03-22    | 30    |\n+------------+---------------+-------+\n\nResult table:\n+------------+---------------+\n| product_id | average_price |\n+------------+---------------+\n| 1          | 6.96          |\n| 2          | 16.96         |\n+------------+---------------+\n平均售价 = 产品总价 / 销售的产品数量。\n产品 1 的平均售价 = ((100 * 5)+(15 * 20) )/ 115 = 6.96\n产品 2 的平均售价 = ((200 * 15)+(30 * 30) )/ 230 = 16.96\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    product_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">Round</span><span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>sales<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>units<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> average_price</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        Prices<span class=\"token punctuation\">.</span>product_id <span class=\"token keyword\">AS</span> product_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        Prices<span class=\"token punctuation\">.</span>price <span class=\"token operator\">*</span> UnitsSold<span class=\"token punctuation\">.</span>units <span class=\"token keyword\">AS</span> sales<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        UnitsSold<span class=\"token punctuation\">.</span>units <span class=\"token keyword\">AS</span> units</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">FROM</span> Prices </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">JOIN</span> UnitsSold <span class=\"token keyword\">ON</span> Prices<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> UnitsSold<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">WHERE</span> UnitsSold<span class=\"token punctuation\">.</span>purchase_date <span class=\"token operator\">BETWEEN</span> Prices<span class=\"token punctuation\">.</span>start_date <span class=\"token operator\">AND</span> Prices<span class=\"token punctuation\">.</span>end_date</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span> T</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> product_id</pre></td></tr></table></figure><blockquote>\n<p>2 表关联的时候直接把日期做过滤</p>\n</blockquote>\n<h4 id=\"1264-页面推荐\"><a class=\"anchor\" href=\"#1264-页面推荐\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcGFnZS1yZWNvbW1lbmRhdGlvbnMv\">1264. 页面推荐</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>朋友关系列表：  <code>Friendship</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user1_id      | int     |\n| user2_id      | int     |\n+---------------+---------+\n这张表的主键是 (user1_id, user2_id)。\n这张表的每一行代表着 user1_id 和 user2_id 之间存在着朋友关系。\n</code></pre>\n<p>喜欢列表：  <code>Likes</code></p>\n<pre><code>+-------------+---------+\n| Column Name | Type    |\n+-------------+---------+\n| user_id     | int     |\n| page_id     | int     |\n+-------------+---------+\n这张表的主键是 (user_id, page_id)。\n这张表的每一行代表着 user_id 喜欢 page_id。\n</code></pre>\n<p>写一段 SQL  向 <code>user_id</code>  = 1 的用户，推荐其朋友们喜欢的页面。不要推荐该用户已经喜欢的页面。</p>\n<p>你返回的结果中不应当包含重复项。</p>\n<p>返回结果的格式如下例所示：</p>\n<pre><code>Friendship table:\n+----------+----------+\n| user1_id | user2_id |\n+----------+----------+\n| 1        | 2        |\n| 1        | 3        |\n| 1        | 4        |\n| 2        | 3        |\n| 2        | 4        |\n| 2        | 5        |\n| 6        | 1        |\n+----------+----------+\n \nLikes table:\n+---------+---------+\n| user_id | page_id |\n+---------+---------+\n| 1       | 88      |\n| 2       | 23      |\n| 3       | 24      |\n| 4       | 56      |\n| 5       | 11      |\n| 6       | 33      |\n| 2       | 77      |\n| 3       | 77      |\n| 6       | 88      |\n+---------+---------+\n\nResult table:\n+------------------+\n| recommended_page |\n+------------------+\n| 23               |\n| 24               |\n| 56               |\n| 33               |\n| 77               |\n+------------------+\n用户1 同 用户2, 3, 4, 6 是朋友关系。\n推荐页面为： 页面23 来自于 用户2, 页面24 来自于 用户3, 页面56 来自于 用户3 以及 页面33 来自于 用户6。\n页面77 同时被 用户2 和 用户3 推荐。\n页面88 没有被推荐，因为 用户1 已经喜欢了它。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> page_id  recommended_page</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Likes</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> user_id <span class=\"token operator\">in</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>user1_id<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>user2_id<span class=\"token punctuation\">,</span>user1_id<span class=\"token punctuation\">)</span> user_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span>  Friendship</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">where</span>  user1_id <span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">or</span> user2_id <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">and</span> page_id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> page_id <span class=\"token keyword\">from</span> Likes <span class=\"token keyword\">where</span> user_id<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1270-向公司ceo汇报工作的所有人\"><a class=\"anchor\" href=\"#1270-向公司ceo汇报工作的所有人\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWxsLXBlb3BsZS1yZXBvcnQtdG8tdGhlLWdpdmVuLW1hbmFnZXIv\">1270. 向公司 CEO 汇报工作的所有人</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>员工表： <code>Employees</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| employee_id   | int     |\n| employee_name | varchar |\n| manager_id    | int     |\n+---------------+---------+\nemployee_id 是这个表的主键。\n这个表中每一行中，employee_id 表示职工的 ID，employee_name 表示职工的名字，manager_id 表示该职工汇报工作的直线经理。\n这个公司 CEO 是 employee_id = 1 的人。\n</code></pre>\n<p>用 SQL 查询出所有直接或间接向公司 CEO 汇报工作的职工的 employee_id 。</p>\n<p>由于公司规模较小，经理之间的间接关系不超过 3 个经理。</p>\n<p>可以以任何顺序返回的结果，不需要去重。</p>\n<p>查询结果示例如下：</p>\n<pre><code>Employees table:\n+-------------+---------------+------------+\n| employee_id | employee_name | manager_id |\n+-------------+---------------+------------+\n| 1           | Boss          | 1          |\n| 3           | Alice         | 3          |\n| 2           | Bob           | 1          |\n| 4           | Daniel        | 2          |\n| 7           | Luis          | 4          |\n| 8           | Jhon          | 3          |\n| 9           | Angela        | 8          |\n| 77          | Robert        | 1          |\n+-------------+---------------+------------+\n\nResult table:\n+-------------+\n| employee_id |\n+-------------+\n| 2           |\n| 77          |\n| 4           |\n| 7           |\n+-------------+\n\n公司 CEO 的 employee_id 是 1.\nemployee_id 是 2 和 77 的职员直接汇报给公司 CEO。\nemployee_id 是 4 的职员间接汇报给公司 CEO 4 --&gt; 2 --&gt; 1 。\nemployee_id 是 7 的职员间接汇报给公司 CEO 7 --&gt; 4 --&gt; 2 --&gt; 1 。\nemployee_id 是 3, 8 ，9 的职员不会直接或间接的汇报给公司 CEO。 \n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> employee_id</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>employee_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Employees a </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Employees b <span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>manager_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>employee_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Employees c <span class=\"token keyword\">on</span> b<span class=\"token punctuation\">.</span>manager_id <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>employee_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">where</span> a<span class=\"token punctuation\">.</span>manager_id<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token operator\">or</span> b<span class=\"token punctuation\">.</span>manager_id<span class=\"token operator\">=</span><span class=\"token number\">1</span>  <span class=\"token operator\">or</span> c<span class=\"token punctuation\">.</span>manager_id<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">where</span> employee_id<span class=\"token operator\">!=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"1280-学生们参加各科测试的次数\"><a class=\"anchor\" href=\"#1280-学生们参加各科测试的次数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc3R1ZGVudHMtYW5kLWV4YW1pbmF0aW9ucy8=\">1280. 学生们参加各科测试的次数</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>学生表:  <code>Students</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| student_id    | int     |\n| student_name  | varchar |\n+---------------+---------+\n主键为 student_id（学生ID），该表内的每一行都记录有学校一名学生的信息。\n</code></pre>\n<p>科目表:  <code>Subjects</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| subject_name | varchar |\n+--------------+---------+\n主键为 subject_name（科目名称），每一行记录学校的一门科目名称。\n</code></pre>\n<p>考试表:  <code>Examinations</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| student_id   | int     |\n| subject_name | varchar |\n+--------------+---------+\n这张表压根没有主键，可能会有重复行。\n学生表里的一个学生修读科目表里的每一门科目，而这张考试表的每一行记录就表示学生表里的某个学生参加了一次科目表里某门科目的测试。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>student_name<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>subject_name<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>subject_name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> attended_exams</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> Students a <span class=\"token keyword\">CROSS</span> <span class=\"token keyword\">JOIN</span> Subjects b</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> Examinations e <span class=\"token keyword\">ON</span> a<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">AND</span> b<span class=\"token punctuation\">.</span>subject_name <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>subject_name</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>subject_name</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> a<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>subject_name</pre></td></tr></table></figure><blockquote>\n<p>CROSS JOIN Mysql 中没有 full outer join \thive 中可以用</p>\n</blockquote>\n<h4 id=\"1285-找到连续区间的开始和结束数字\"><a class=\"anchor\" href=\"#1285-找到连续区间的开始和结束数字\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC10aGUtc3RhcnQtYW5kLWVuZC1udW1iZXItb2YtY29udGludW91cy1yYW5nZXMv\">1285. 找到连续区间的开始和结束数字</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表： <code>Logs</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| log_id        | int     |\n+---------------+---------+\nid 是上表的主键。\n上表的每一行包含日志表中的一个 ID。\n</code></pre>\n<p>后来一些 ID 从  <code>Logs</code>  表中删除。编写一个 SQL 查询得到  <code>Logs</code>  表中的连续区间的开始数字和结束数字。</p>\n<p>将查询表按照  <code>start_id</code>  排序。</p>\n<p>查询结果格式如下面的例子：</p>\n<pre><code>Logs 表：\n+------------+\n| log_id     |\n+------------+\n| 1          |\n| 2          |\n| 3          |\n| 7          |\n| 8          |\n| 10         |\n+------------+\n\n结果表：\n+------------+--------------+\n| start_id   | end_id       |\n+------------+--------------+\n| 1          | 3            |\n| 7          | 8            |\n| 10         | 10           |\n+------------+--------------+\n结果表应包含 Logs 表中的所有区间。\n从 1 到 3 在表中。\n从 4 到 6 不在表中。\n从 7 到 8 在表中。\n9 不在表中。\n10 在表中。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">MIN</span><span class=\"token punctuation\">(</span>log_id<span class=\"token punctuation\">)</span> start_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">MAX</span><span class=\"token punctuation\">(</span>log_id<span class=\"token punctuation\">)</span> end_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        log_id<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        log_id <span class=\"token operator\">-</span> row_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">OVER</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> log_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> diff</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">FROM</span> Logs<span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> diff</pre></td></tr></table></figure><blockquote>\n<p>相似 1225 题</p>\n</blockquote>\n<h4 id=\"1294-不同国家的天气类型\"><a class=\"anchor\" href=\"#1294-不同国家的天气类型\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvd2VhdGhlci10eXBlLWluLWVhY2gtY291bnRyeS8=\">1294. 不同国家的天气类型</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>国家表： <code>Countries</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| country_id    | int     |\n| country_name  | varchar |\n+---------------+---------+\ncountry_id 是这张表的主键。\n该表的每行有 country_id 和 country_name 两列。\n</code></pre>\n<p>天气表： <code>Weather</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| country_id    | int     |\n| weather_state | varchar |\n| day           | date    |\n+---------------+---------+\n(country_id, day) 是该表的复合主键。\n该表的每一行记录了某个国家某一天的天气情况。\n</code></pre>\n<p>写一段 SQL 来找到表中每个国家在 2019 年 11 月的天气类型。</p>\n<p>天气类型的定义如下：当 weather_state 的平均值小于或等于 15 返回 <strong>Cold</strong>，当 weather_state 的平均值大于或等于 25 返回 <strong>Hot</strong>，否则返回 <strong>Warm</strong>。</p>\n<p>你可以以任意顺序返回你的查询结果。</p>\n<p>查询结果格式如下所示：</p>\n<pre><code>Countries table:\n+------------+--------------+\n| country_id | country_name |\n+------------+--------------+\n| 2          | USA          |\n| 3          | Australia    |\n| 7          | Peru         |\n| 5          | China        |\n| 8          | Morocco      |\n| 9          | Spain        |\n+------------+--------------+\nWeather table:\n+------------+---------------+------------+\n| country_id | weather_state | day        |\n+------------+---------------+------------+\n| 2          | 15            | 2019-11-01 |\n| 2          | 12            | 2019-10-28 |\n| 2          | 12            | 2019-10-27 |\n| 3          | -2            | 2019-11-10 |\n| 3          | 0             | 2019-11-11 |\n| 3          | 3             | 2019-11-12 |\n| 5          | 16            | 2019-11-07 |\n| 5          | 18            | 2019-11-09 |\n| 5          | 21            | 2019-11-23 |\n| 7          | 25            | 2019-11-28 |\n| 7          | 22            | 2019-12-01 |\n| 7          | 20            | 2019-12-02 |\n| 8          | 25            | 2019-11-05 |\n| 8          | 27            | 2019-11-15 |\n| 8          | 31            | 2019-11-25 |\n| 9          | 7             | 2019-10-23 |\n| 9          | 3             | 2019-12-23 |\n+------------+---------------+------------+\nResult table:\n+--------------+--------------+\n| country_name | weather_type |\n+--------------+--------------+\n| USA          | Cold         |\n| Austraila    | Cold         |\n| Peru         | Hot          |\n| China        | Warm         |\n| Morocco      | Hot          |\n+--------------+--------------+\nUSA 11 月的平均 weather_state 为 (15) / 1 = 15 所以天气类型为 Cold。\nAustralia 11 月的平均 weather_state 为 (-2 + 0 + 3) / 3 = 0.333 所以天气类型为 Cold。\nPeru 11 月的平均 weather_state 为 (25) / 1 = 25 所以天气类型为 Hot。\nChina 11 月的平均 weather_state 为 (16 + 18 + 21) / 3 = 18.333 所以天气类型为 Warm。\nMorocco 11 月的平均 weather_state 为 (25 + 27 + 31) / 3 = 27.667 所以天气类型为 Hot。\n我们并不知道 Spain 在 11 月的 weather_state 情况所以无需将他包含在结果中。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> country_name<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>weather_state<span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;=</span><span class=\"token number\">15</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'Cold'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                        <span class=\"token keyword\">when</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>weather_state<span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">25</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'Hot'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                        <span class=\"token keyword\">else</span> <span class=\"token string\">'Warm'</span> <span class=\"token keyword\">end</span> <span class=\"token punctuation\">)</span> weather_type</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Countries c <span class=\"token keyword\">join</span> Weather w <span class=\"token keyword\">on</span> c<span class=\"token punctuation\">.</span>country_id <span class=\"token operator\">=</span> w<span class=\"token punctuation\">.</span>country_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">where</span> date_format<span class=\"token punctuation\">(</span><span class=\"token keyword\">day</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"%Y-%m\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token string\">'2019-11'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> country_name</pre></td></tr></table></figure><h4 id=\"1303-求团队人数\"><a class=\"anchor\" href=\"#1303-求团队人数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC10aGUtdGVhbS1zaXplLw==\">1303. 求团队人数</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>员工表： <code>Employee</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| employee_id   | int     |\n| team_id       | int     |\n+---------------+---------+\nemployee_id 字段是这张表的主键，表中的每一行都包含每个员工的 ID 和他们所属的团队。\n</code></pre>\n<p>编写一个 SQL 查询，以求得每个员工所在团队的总人数。</p>\n<p>查询结果中的顺序无特定要求。</p>\n<p>查询结果格式示例如下：</p>\n<pre><code>Employee Table:\n+-------------+------------+\n| employee_id | team_id    |\n+-------------+------------+\n|     1       |     8      |\n|     2       |     8      |\n|     3       |     8      |\n|     4       |     7      |\n|     5       |     9      |\n|     6       |     9      |\n+-------------+------------+\nResult table:\n+-------------+------------+\n| employee_id | team_size  |\n+-------------+------------+\n|     1       |     3      |\n|     2       |     3      |\n|     3       |     3      |\n|     4       |     1      |\n|     5       |     2      |\n|     6       |     2      |\n+-------------+------------+\nID 为 1、2、3 的员工是 team_id 为 8 的团队的成员，\nID 为 4 的员工是 team_id 为 7 的团队的成员，\nID 为 5、6 的员工是 team_id 为 9 的团队的成员。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> employee_id<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> team_id<span class=\"token punctuation\">)</span> team_size </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Employee</pre></td></tr></table></figure><h4 id=\"1308-不同性别每日分数总计\"><a class=\"anchor\" href=\"#1308-不同性别每日分数总计\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcnVubmluZy10b3RhbC1mb3ItZGlmZmVyZW50LWdlbmRlcnMv\">1308. 不同性别每日分数总计</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Scores</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| player_name   | varchar |\n| gender        | varchar |\n| day           | date    |\n| score_points  | int     |\n+---------------+---------+\n(gender, day)是该表的主键\n一场比赛是在女队和男队之间举行的\n该表的每一行表示一个名叫 (player_name) 性别为 (gender) 的参赛者在某一天获得了 (score_points) 的分数\n如果参赛者是女性，那么 gender 列为 'F'，如果参赛者是男性，那么 gender 列为 'M'\n</code></pre>\n<p>写一条 SQL 语句查询每种性别在每一天的总分，并按性别和日期对查询结果排序</p>\n<p>下面是查询结果格式的例子：</p>\n<pre><code>Scores表:\n+-------------+--------+------------+--------------+\n| player_name | gender | day        | score_points |\n+-------------+--------+------------+--------------+\n| Aron        | F      | 2020-01-01 | 17           |\n| Alice       | F      | 2020-01-07 | 23           |\n| Bajrang     | M      | 2020-01-07 | 7            |\n| Khali       | M      | 2019-12-25 | 11           |\n| Slaman      | M      | 2019-12-30 | 13           |\n| Joe         | M      | 2019-12-31 | 3            |\n| Jose        | M      | 2019-12-18 | 2            |\n| Priya       | F      | 2019-12-31 | 23           |\n| Priyanka    | F      | 2019-12-30 | 17           |\n+-------------+--------+------------+--------------+\n结果表:\n+--------+------------+-------+\n| gender | day        | total |\n+--------+------------+-------+\n| F      | 2019-12-30 | 17    |\n| F      | 2019-12-31 | 40    |\n| F      | 2020-01-01 | 57    |\n| F      | 2020-01-07 | 80    |\n| M      | 2019-12-18 | 2     |\n| M      | 2019-12-25 | 13    |\n| M      | 2019-12-30 | 26    |\n| M      | 2019-12-31 | 29    |\n| M      | 2020-01-07 | 36    |\n+--------+------------+-------+\n女性队伍:\n第一天是 2019-12-30，Priyanka 获得 17 分，队伍的总分是 17 分\n第二天是 2019-12-31, Priya 获得 23 分，队伍的总分是 40 分\n第三天是 2020-01-01, Aron 获得 17 分，队伍的总分是 57 分\n第四天是 2020-01-07, Alice 获得 23 分，队伍的总分是 80 分\n男性队伍：\n第一天是 2019-12-18, Jose 获得 2 分，队伍的总分是 2 分\n第二天是 2019-12-25, Khali 获得 11 分，队伍的总分是 13 分\n第三天是 2019-12-30, Slaman 获得 13 分，队伍的总分是 26 分\n第四天是 2019-12-31, Joe 获得 3 分，队伍的总分是 29 分\n第五天是 2020-01-07, Bajrang 获得 7 分，队伍的总分是 36 分\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> gender <span class=\"token punctuation\">,</span> <span class=\"token keyword\">day</span>  <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span> score_points<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> gender <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">day</span><span class=\"token punctuation\">)</span>  total</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Scores</pre></td></tr></table></figure><h4 id=\"1321-餐馆营业额变化增长\"><a class=\"anchor\" href=\"#1321-餐馆营业额变化增长\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVzdGF1cmFudC1ncm93dGgv\">1321. 餐馆营业额变化增长</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Customer</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| customer_id   | int     |\n| name          | varchar |\n| visited_on    | date    |\n| amount        | int     |\n+---------------+---------+\n(customer_id, visited_on) 是该表的主键\n该表包含一家餐馆的顾客交易数据\nvisited_on 表示 (customer_id) 的顾客在 visited_on 那天访问了餐馆\namount 是一个顾客某一天的消费总额\n</code></pre>\n<p>你是餐馆的老板，现在你想分析一下可能的营业额变化增长（每天至少有一位顾客）</p>\n<p>写一条 SQL 查询计算以 7 天（某日期 + 该日期前的 6 天）为一个时间段的顾客消费平均值</p>\n<p>查询结果格式的例子如下：</p>\n<ul>\n<li>查询结果按  <code>visited_on</code>  排序</li>\n<li><code>average_amount</code>  要 <strong>保留两位小数</strong>，日期数据的格式为 ('YYYY-MM-DD')</li>\n</ul>\n<pre><code>Customer 表:\n+-------------+--------------+--------------+-------------+\n| customer_id | name         | visited_on   | amount      |\n+-------------+--------------+--------------+-------------+\n| 1           | Jhon         | 2019-01-01   | 100         |\n| 2           | Daniel       | 2019-01-02   | 110         |\n| 3           | Jade         | 2019-01-03   | 120         |\n| 4           | Khaled       | 2019-01-04   | 130         |\n| 5           | Winston      | 2019-01-05   | 110         | \n| 6           | Elvis        | 2019-01-06   | 140         | \n| 7           | Anna         | 2019-01-07   | 150         |\n| 8           | Maria        | 2019-01-08   | 80          |\n| 9           | Jaze         | 2019-01-09   | 110         | \n| 1           | Jhon         | 2019-01-10   | 130         | \n| 3           | Jade         | 2019-01-10   | 150         | \n+-------------+--------------+--------------+-------------+\n\n结果表:\n+--------------+--------------+----------------+\n| visited_on   | amount       | average_amount |\n+--------------+--------------+----------------+\n| 2019-01-07   | 860          | 122.86         |\n| 2019-01-08   | 840          | 120            |\n| 2019-01-09   | 840          | 120            |\n| 2019-01-10   | 1000         | 142.86         |\n+--------------+--------------+----------------+\n\n第一个七天消费平均值从 2019-01-01 到 2019-01-07 是 (100 + 110 + 120 + 130 + 110 + 140 + 150)/7 = 122.86\n第二个七天消费平均值从 2019-01-02 到 2019-01-08 是 (110 + 120 + 130 + 110 + 140 + 150 + 80)/7 = 120\n第三个七天消费平均值从 2019-01-03 到 2019-01-09 是 (120 + 130 + 110 + 140 + 150 + 80 + 110)/7 = 120\n第四个七天消费平均值从 2019-01-04 到 2019-01-10 是 (130 + 110 + 140 + 150 + 80 + 110 + 130 + 150)/7 = 142.86\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  visited_on<span class=\"token punctuation\">,</span>amount<span class=\"token punctuation\">,</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>amount<span class=\"token operator\">/</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> average_amount</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> visited_on<span class=\"token punctuation\">,</span>ant<span class=\"token punctuation\">,</span>lag<span class=\"token punctuation\">(</span>visited_on<span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> visited_on<span class=\"token punctuation\">)</span> lg<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>ant<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> visited_on <span class=\"token keyword\">rows</span> <span class=\"token operator\">between</span> <span class=\"token number\">6</span> <span class=\"token keyword\">PRECEDING</span> <span class=\"token operator\">and</span> <span class=\"token keyword\">current</span> <span class=\"token keyword\">row</span><span class=\"token punctuation\">)</span> amount</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">select</span>  visited_on  <span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span> ant</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">from</span> Customer</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> visited_on</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">where</span> lg <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span></pre></td></tr></table></figure><h4 id=\"1322-广告效果\"><a class=\"anchor\" href=\"#1322-广告效果\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWRzLXBlcmZvcm1hbmNlLw==\">1322. 广告效果</span></h4>\n<p>难度简单 8 收藏分享切换为英文关注反馈</p>\n<p>SQL 架构</p>\n<p>表:  <code>Ads</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| ad_id         | int     |\n| user_id       | int     |\n| action        | enum    |\n+---------------+---------+\n(ad_id, user_id) 是该表的主键\n该表的每一行包含一条广告的 ID(ad_id)，用户的 ID(user_id) 和用户对广告采取的行为 (action)\naction 列是一个枚举类型 ('Clicked', 'Viewed', 'Ignored') 。\n</code></pre>\n<p>一家公司正在运营这些广告并想计算每条广告的效果。</p>\n<p>广告效果用点击通过率（Click-Through Rate：CTR）来衡量，公式如下:</p>\n<p><img data-src=\"https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2020/03/06/sql1.png\" alt=\"img\" /></p>\n<p>写一条 SQL 语句来查询每一条广告的  <code>ctr</code>  ，</p>\n<p><code>ctr</code>  要保留两位小数。结果需要按  <code>ctr</code>  <strong>降序</strong>、按  <code>ad_id</code>  <strong>升序</strong> 进行排序。</p>\n<p>查询结果示例如下：</p>\n<pre><code>Ads 表:\n+-------+---------+---------+\n| ad_id | user_id | action  |\n+-------+---------+---------+\n| 1     | 1       | Clicked |\n| 2     | 2       | Clicked |\n| 3     | 3       | Viewed  |\n| 5     | 5       | Ignored |\n| 1     | 7       | Ignored |\n| 2     | 7       | Viewed  |\n| 3     | 5       | Clicked |\n| 1     | 4       | Viewed  |\n| 2     | 11      | Viewed  |\n| 1     | 2       | Clicked |\n+-------+---------+---------+\n结果表:\n+-------+-------+\n| ad_id | ctr   |\n+-------+-------+\n| 1     | 66.67 |\n| 3     | 50.00 |\n| 2     | 33.33 |\n| 5     | 0.00  |\n+-------+-------+\n对于 ad_id = 1, ctr = (2/(2+1)) * 100 = 66.67\n对于 ad_id = 2, ctr = (1/(1+2)) * 100 = 33.33\n对于 ad_id = 3, ctr = (1/(1+1)) * 100 = 50.00\n对于 ad_id = 5, ctr = 0.00, 注意 ad_id = 5 没有被点击 (Clicked) 或查看 (Viewed) 过\n注意我们不关心 action 为 Ingnored 的广告\n结果按 ctr（降序），ad_id（升序）排序\n</code></pre>\n<p>精简</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> ad_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">ROUND</span><span class=\"token punctuation\">(</span>IFNULL<span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'Clicked'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'Clicked'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span> <span class=\"token operator\">=</span> <span class=\"token string\">'Viewed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> ctr</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">FROM</span> Ads</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> ad_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> ctr <span class=\"token keyword\">DESC</span><span class=\"token punctuation\">,</span> ad_id <span class=\"token keyword\">ASC</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>笨方法</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>ad_id<span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>ctr<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> ctr</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Ads a</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> ad_id<span class=\"token punctuation\">,</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">action</span><span class=\"token operator\">=</span><span class=\"token string\">'Clicked'</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> ctr </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> Ads </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">where</span> <span class=\"token keyword\">action</span> <span class=\"token operator\">!=</span><span class=\"token string\">'Ignored'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> ad_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1 </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>ad_id<span class=\"token operator\">=</span> t1<span class=\"token punctuation\">.</span>ad_id</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> ad_id<span class=\"token punctuation\">,</span>ctr</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> ctr <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>ad_id</pre></td></tr></table></figure><h4 id=\"1327-列出指定时间段内所有的下单产品\"><a class=\"anchor\" href=\"#1327-列出指定时间段内所有的下单产品\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbGlzdC10aGUtcHJvZHVjdHMtb3JkZXJlZC1pbi1hLXBlcmlvZC8=\">1327. 列出指定时间段内所有的下单产品</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表:  <code>Products</code></p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| product_id       | int     |\n| product_name     | varchar |\n| product_category | varchar |\n+------------------+---------+\nproduct_id 是该表主键。\n该表包含该公司产品的数据。\n</code></pre>\n<p>表:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| order_date    | date    |\n| unit          | int     |\n+---------------+---------+\n该表无主键，可能包含重复行。\nproduct_id 是表单 Products 的外键。\nunit 是在日期 order_date 内下单产品的数目。\n</code></pre>\n<p>写一个 SQL 语句，要求获取在 2020 年 2 月份下单的数量不少于 100 的产品的名字和数目。</p>\n<p>返回结果表单的顺序无要求。</p>\n<p>查询结果的格式如下：</p>\n<pre><code>Products 表:\n+-------------+-----------------------+------------------+\n| product_id  | product_name          | product_category |\n+-------------+-----------------------+------------------+\n| 1           | Leetcode Solutions    | Book             |\n| 2           | Jewels of Stringology | Book             |\n| 3           | HP                    | Laptop           |\n| 4           | Lenovo                | Laptop           |\n| 5           | Leetcode Kit          | T-shirt          |\n+-------------+-----------------------+------------------+\n\nOrders 表:\n+--------------+--------------+----------+\n| product_id   | order_date   | unit     |\n+--------------+--------------+----------+\n| 1            | 2020-02-05   | 60       |\n| 1            | 2020-02-10   | 70       |\n| 2            | 2020-01-18   | 30       |\n| 2            | 2020-02-11   | 80       |\n| 3            | 2020-02-17   | 2        |\n| 3            | 2020-02-24   | 3        |\n| 4            | 2020-03-01   | 20       |\n| 4            | 2020-03-04   | 30       |\n| 4            | 2020-03-04   | 60       |\n| 5            | 2020-02-25   | 50       |\n| 5            | 2020-02-27   | 50       |\n| 5            | 2020-03-01   | 50       |\n+--------------+--------------+----------+\n\nResult 表:\n+--------------------+---------+\n| product_name       | unit    |\n+--------------------+---------+\n| Leetcode Solutions | 130     |\n| Leetcode Kit       | 100     |\n+--------------------+---------+\n\n2020 年 2 月份下单 product_id = 1 的产品的数目总和为 (60 + 70) = 130 。\n2020 年 2 月份下单 product_id = 2 的产品的数目总和为 80 。\n2020 年 2 月份下单 product_id = 3 的产品的数目总和为 (2 + 3) = 5 。\n2020 年 2 月份 product_id = 4 的产品并没有下单。\n2020 年 2 月份下单 product_id = 5 的产品的数目总和为 (50 + 50) = 100 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_name<span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>unit<span class=\"token punctuation\">)</span> unit </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Orders o <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Products p</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> o<span class=\"token punctuation\">.</span>product_id<span class=\"token operator\">=</span>p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span> date_format<span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token string\">'2020-02'</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> product_name</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">having</span> unit<span class=\"token operator\">>=</span><span class=\"token number\">100</span></pre></td></tr></table></figure><h4 id=\"1336-每次访问的交易次数\"><a class=\"anchor\" href=\"#1336-每次访问的交易次数\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbnVtYmVyLW9mLXRyYW5zYWN0aW9ucy1wZXItdmlzaXQv\">1336. 每次访问的交易次数</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>表:  <code>Visits</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| visit_date    | date    |\n+---------------+---------+\n(user_id, visit_date) 是该表的主键\n该表的每行表示 user_id 在 visit_date 访问了银行\n</code></pre>\n<p>表:  <code>Transactions</code></p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| user_id          | int     |\n| transaction_date | date    |\n| amount           | int     |\n+------------------+---------+\n该表没有主键，所以可能有重复行\n该表的每一行表示 user_id 在 transaction_date 完成了一笔 amount 数额的交易\n可以保证用户 (user) 在 transaction_date 访问了银行 (也就是说 Visits 表包含 (user_id, transaction_date) 行)\n</code></pre>\n<p>银行想要得到银行客户在一次访问时的交易次数和相应的在一次访问时该交易次数的客户数量的图表</p>\n<p>写一条 SQL 查询多少客户访问了银行但没有进行任何交易，多少客户访问了银行进行了一次交易等等</p>\n<p>结果包含两列：</p>\n<ul>\n<li><code>transactions_count：</code>  客户在一次访问中的交易次数</li>\n<li><code>visits_count：</code>  在  <code>transactions_count</code>  交易次数下相应的一次访问时的客户数量</li>\n</ul>\n<pre><code>transactions_count` 的值从 `0` 到所有用户一次访问中的 `max(transactions_count)\n</code></pre>\n<p>按  <code>transactions_count</code>  排序</p>\n<p>下面是查询结果格式的例子：</p>\n<pre><code>Visits 表:\n+---------+------------+\n| user_id | visit_date |\n+---------+------------+\n| 1       | 2020-01-01 |\n| 2       | 2020-01-02 |\n| 12      | 2020-01-01 |\n| 19      | 2020-01-03 |\n| 1       | 2020-01-02 |\n| 2       | 2020-01-03 |\n| 1       | 2020-01-04 |\n| 7       | 2020-01-11 |\n| 9       | 2020-01-25 |\n| 8       | 2020-01-28 |\n+---------+------------+\nTransactions 表:\n+---------+------------------+--------+\n| user_id | transaction_date | amount |\n+---------+------------------+--------+\n| 1       | 2020-01-02       | 120    |\n| 2       | 2020-01-03       | 22     |\n| 7       | 2020-01-11       | 232    |\n| 1       | 2020-01-04       | 7      |\n| 9       | 2020-01-25       | 33     |\n| 9       | 2020-01-25       | 66     |\n| 8       | 2020-01-28       | 1      |\n| 9       | 2020-01-25       | 99     |\n+---------+------------------+--------+\n结果表:\n+--------------------+--------------+\n| transactions_count | visits_count |\n+--------------------+--------------+\n| 0                  | 4            |\n| 1                  | 5            |\n| 2                  | 0            |\n| 3                  | 1            |\n+--------------------+--------------+\n* 对于 transactions_count = 0, visits 中 (1, &quot;2020-01-01&quot;), (2, &quot;2020-01-02&quot;), (12, &quot;2020-01-01&quot;) 和 (19, &quot;2020-01-03&quot;) 没有进行交易，所以 visits_count = 4 。\n* 对于 transactions_count = 1, visits 中 (2, &quot;2020-01-03&quot;), (7, &quot;2020-01-11&quot;), (8, &quot;2020-01-28&quot;), (1, &quot;2020-01-02&quot;) 和 (1, &quot;2020-01-04&quot;) 进行了一次交易，所以 visits_count = 5 。\n* 对于 transactions_count = 2, 没有客户访问银行进行了两次交易，所以 visits_count = 0 。\n* 对于 transactions_count = 3, visits 中 (9, &quot;2020-01-25&quot;) 进行了三次交易，所以 visits_count = 1 。\n* 对于 transactions_count &gt;= 4, 没有客户访问银行进行了超过3次交易，所以我们停止在 transactions_count = 3 。\n\n如下是这个例子的图表：\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> t5<span class=\"token punctuation\">.</span>rnb <span class=\"token keyword\">AS</span> transactions_count<span class=\"token punctuation\">,</span> IFNULL<span class=\"token punctuation\">(</span>visits_count<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> visits_count</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">SELECT</span> <span class=\"token number\">0</span> <span class=\"token keyword\">AS</span> rnb</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">UNION</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">SELECT</span> ROW_NUMBER<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">OVER</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> rnb</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">FROM</span> <span class=\"token keyword\">Transactions</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">)</span> t5</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">SELECT</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            cnt <span class=\"token keyword\">AS</span> transactions_count</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">,</span><span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>user_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> visits_count</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">FROM</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">SELECT</span> t1<span class=\"token punctuation\">.</span>user_id<span class=\"token punctuation\">,</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">.</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> cnt</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">FROM</span> Visits t1</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> <span class=\"token keyword\">Transactions</span> t2</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">ON</span> t1<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">AND</span> t1<span class=\"token punctuation\">.</span>visit_date <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>transaction_date</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> user_id<span class=\"token punctuation\">,</span> visit_date</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">)</span> t3</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> cnt</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">)</span> t4</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">ON</span> t5<span class=\"token punctuation\">.</span>rnb <span class=\"token operator\">=</span> t4<span class=\"token punctuation\">.</span>transactions_count</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">)</span> t6</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">WHERE</span> transactions_count <span class=\"token operator\">&lt;=</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">.</span>amount<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> cnt</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">FROM</span> Visits t1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> <span class=\"token keyword\">Transactions</span> t2</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">ON</span> t1<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">AND</span> t1<span class=\"token punctuation\">.</span>visit_date <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>transaction_date</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> t1<span class=\"token punctuation\">.</span>user_id<span class=\"token punctuation\">,</span> visit_date</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> cnt <span class=\"token keyword\">DESC</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><blockquote>\n<p>难点 从 0 自增序列，2 交易的人数为 0</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> pcnt transactions_count<span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> visits_count</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> visit_date<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>amount <span class=\"token operator\">is</span>  <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> transaction_date <span class=\"token punctuation\">)</span> pcnt<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span>  visit_date <span class=\"token punctuation\">)</span> tcnt</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Visits v <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token keyword\">Transactions</span> t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">on</span> v<span class=\"token punctuation\">.</span>user_id<span class=\"token operator\">=</span> t<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">and</span> v<span class=\"token punctuation\">.</span>visit_date<span class=\"token operator\">=</span>t<span class=\"token punctuation\">.</span>transaction_date</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> pcnt</pre></td></tr></table></figure><p>这个得出结果是 [0, 4], [1, 5], [3, 3] 少了 [2,0] 还没想到什么好办法能把 [2，0] 加进去。。。</p>\n<h4 id=\"1341-电影评分\"><a class=\"anchor\" href=\"#1341-电影评分\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbW92aWUtcmF0aW5nLw==\">1341. 电影评分</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表： <code>Movies</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| movie_id      | int     |\n| title         | varchar |\n+---------------+---------+\nmovie_id 是这个表的主键。\ntitle 是电影的名字。\n</code></pre>\n<p>表： <code>Users</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| name          | varchar |\n+---------------+---------+\nuser_id 是表的主键。\n</code></pre>\n<p>表： <code>Movie_Rating</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| movie_id      | int     |\n| user_id       | int     |\n| rating        | int     |\n| created_at    | date    |\n+---------------+---------+\n(movie_id, user_id) 是这个表的主键。\n这个表包含用户在其评论中对电影的评分 rating 。\ncreated_at 是用户的点评日期。 \n</code></pre>\n<p>请你编写一组 SQL 查询：</p>\n<ul>\n<li>\n<p>查找评论电影数量最多的用户名。</p>\n<p>如果出现平局，返回字典序较小的用户名。</p>\n</li>\n<li>\n<p>查找在</p>\n<p>2020 年 2 月 平均评分最高</p>\n<p>的电影名称。</p>\n<p>如果出现平局，返回字典序较小的电影名称。</p>\n</li>\n</ul>\n<p>查询分两行返回，查询结果格式如下例所示：</p>\n<pre><code>Movies 表：\n+-------------+--------------+\n| movie_id    |  title       |\n+-------------+--------------+\n| 1           | Avengers     |\n| 2           | Frozen 2     |\n| 3           | Joker        |\n+-------------+--------------+\n\nUsers 表：\n+-------------+--------------+\n| user_id     |  name        |\n+-------------+--------------+\n| 1           | Daniel       |\n| 2           | Monica       |\n| 3           | Maria        |\n| 4           | James        |\n+-------------+--------------+\n\nMovie_Rating 表：\n+-------------+--------------+--------------+-------------+\n| movie_id    | user_id      | rating       | created_at  |\n+-------------+--------------+--------------+-------------+\n| 1           | 1            | 3            | 2020-01-12  |\n| 1           | 2            | 4            | 2020-02-11  |\n| 1           | 3            | 2            | 2020-02-12  |\n| 1           | 4            | 1            | 2020-01-01  |\n| 2           | 1            | 5            | 2020-02-17  | \n| 2           | 2            | 2            | 2020-02-01  | \n| 2           | 3            | 2            | 2020-03-01  |\n| 3           | 1            | 3            | 2020-02-22  | \n| 3           | 2            | 4            | 2020-02-25  | \n+-------------+--------------+--------------+-------------+\n\nResult 表：\n+--------------+\n| results      |\n+--------------+\n| Daniel       |\n| Frozen 2     |\n+--------------+\n\nDaniel 和 Monica 都点评了 3 部电影（&quot;Avengers&quot;, &quot;Frozen 2&quot; 和 &quot;Joker&quot;） 但是 Daniel 字典序比较小。\nFrozen 2 和 Joker 在 2 月的评分都是 3.5，但是 Frozen 2 的字典序比较小。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name results </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> m<span class=\"token punctuation\">.</span>user_id <span class=\"token punctuation\">,</span>u<span class=\"token punctuation\">.</span>name </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> Movie_Rating m <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Users u </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">on</span> m<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> u<span class=\"token punctuation\">.</span>user_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> user_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>name</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">union</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">select</span> title results</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">from</span> Movie_Rating r <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Movies m</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">on</span> r<span class=\"token punctuation\">.</span>movie_id <span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span>movie_id </pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">where</span> date_format<span class=\"token punctuation\">(</span>created_at<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token string\">'2020-02'</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> r<span class=\"token punctuation\">.</span>movie_id</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>rating<span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>title </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1350-院系无效的学生\"><a class=\"anchor\" href=\"#1350-院系无效的学生\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc3R1ZGVudHMtd2l0aC1pbnZhbGlkLWRlcGFydG1lbnRzLw==\">1350. 院系无效的学生</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>院系表:  <code>Departments</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n+---------------+---------+\nid 是该表的主键\n该表包含一所大学每个院系的 id 信息\n</code></pre>\n<p>学生表:  <code>Students</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n| department_id | int     |\n+---------------+---------+\nid 是该表的主键\n该表包含一所大学每个学生的 id 和他/她就读的院系信息\n</code></pre>\n<p>写一条 SQL 语句以查询那些所在院系不存在的学生的 id 和姓名</p>\n<p>可以以任何顺序返回结果</p>\n<p>下面是返回结果格式的例子</p>\n<pre><code>Departments 表:\n+------+--------------------------+\n| id   | name                     |\n+------+--------------------------+\n| 1    | Electrical Engineering   |\n| 7    | Computer Engineering     |\n| 13   | Bussiness Administration |\n+------+--------------------------+\n\nStudents 表:\n+------+----------+---------------+\n| id   | name     | department_id |\n+------+----------+---------------+\n| 23   | Alice    | 1             |\n| 1    | Bob      | 7             |\n| 5    | Jennifer | 13            |\n| 2    | John     | 14            |\n| 4    | Jasmine  | 77            |\n| 3    | Steve    | 74            |\n| 6    | Luis     | 1             |\n| 8    | Jonathan | 7             |\n| 7    | Daiana   | 33            |\n| 11   | Madelynn | 1             |\n+------+----------+---------------+\n\n结果表:\n+------+----------+\n| id   | name     |\n+------+----------+\n| 2    | John     |\n| 7    | Daiana   |\n| 4    | Jasmine  |\n| 3    | Steve    |\n+------+----------+\n\nJohn, Daiana, Steve 和 Jasmine 所在的院系分别是 14, 33, 74 和 77， 其中 14, 33, 74 和 77 并不存在于院系表\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>name  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Students </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> department_id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> id </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span> Departments</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1355-活动参与者\"><a class=\"anchor\" href=\"#1355-活动参与者\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWN0aXZpdHktcGFydGljaXBhbnRzLw==\">1355. 活动参与者</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Friends</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n| activity      | varchar |\n+---------------+---------+\nid 是朋友的 id 和该表的主键\nname 是朋友的名字\nactivity 是朋友参加的活动的名字\n</code></pre>\n<p>表:  <code>Activities</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n+---------------+---------+\nid 是该表的主键\nname 是活动的名字\n</code></pre>\n<p>写一条 SQL 查询那些既没有最多，也没有最少参与者的活动的名字</p>\n<p>可以以任何顺序返回结果，Activities 表的每项活动的参与者都来自 Friends 表</p>\n<p>下面是查询结果格式的例子：</p>\n<pre><code>Friends 表:\n+------+--------------+---------------+\n| id   | name         | activity      |\n+------+--------------+---------------+\n| 1    | Jonathan D.  | Eating        |\n| 2    | Jade W.      | Singing       |\n| 3    | Victor J.    | Singing       |\n| 4    | Elvis Q.     | Eating        |\n| 5    | Daniel A.    | Eating        |\n| 6    | Bob B.       | Horse Riding  |\n+------+--------------+---------------+\n\nActivities 表:\n+------+--------------+\n| id   | name         |\n+------+--------------+\n| 1    | Eating       |\n| 2    | Singing      |\n| 3    | Horse Riding |\n+------+--------------+\n\nResult 表:\n+--------------+\n| activity     |\n+--------------+\n| Singing      |\n+--------------+\n\nEating 活动有三个人参加, 是最多人参加的活动 (Jonathan D. , Elvis Q. and Daniel A.)\nHorse Riding 活动有一个人参加, 是最少人参加的活动 (Bob B.)\nSinging 活动有两个人参加 (Victor J. and Jade W.)\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> activity</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">select</span> activity<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> cnt<span class=\"token punctuation\">)</span> rk1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> cnt <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">select</span>  activity  <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">from</span>  Friends</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span>  activity </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">where</span> rk1 <span class=\"token operator\">!=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> rk2 <span class=\"token operator\">!=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><blockquote>\n<p>不需要关联 Activities 表，因为 至少有一人参加</p>\n</blockquote>\n<h4 id=\"1364-顾客的可信联系人数量\"><a class=\"anchor\" href=\"#1364-顾客的可信联系人数量\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbnVtYmVyLW9mLXRydXN0ZWQtY29udGFjdHMtb2YtYS1jdXN0b21lci8=\">1364. 顾客的可信联系人数量</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>顾客表： <code>Customers</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| customer_id   | int     |\n| customer_name | varchar |\n| email         | varchar |\n+---------------+---------+\ncustomer_id 是这张表的主键。\n此表的每一行包含了某在线商店顾客的姓名和电子邮件。\n</code></pre>\n<p>联系方式表： <code>Contacts</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | id      |\n| contact_name  | varchar |\n| contact_email | varchar |\n+---------------+---------+\n(user_id, contact_email) 是这张表的主键。\n此表的每一行表示编号为 user_id 的顾客的某位联系人的姓名和电子邮件。\n此表包含每位顾客的联系人信息，但顾客的联系人不一定存在于顾客表中。\n</code></pre>\n<p>发票表： <code>Invoices</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| invoice_id   | int     |\n| price        | int     |\n| user_id      | int     |\n+--------------+---------+\ninvoice_id 是这张表的主键。\n此表的每一行分别表示编号为 user_id 的顾客拥有有一张编号为 invoice_id、价格为 price 的发票。\n</code></pre>\n<p>为每张发票  <code>invoice_id</code>  编写一个 SQL 查询以查找以下内容：</p>\n<ul>\n<li><code>customer_name</code> ：与发票相关的顾客名称。</li>\n<li><code>price</code> ：发票的价格。</li>\n<li><code>contacts_cnt</code> ：该顾客的联系人数量。</li>\n<li><code>trusted_contacts_cnt</code> ：可信联系人的数量：既是该顾客的联系人又是商店顾客的联系人数量（即：可信联系人的电子邮件存在于客户表中）。</li>\n</ul>\n<p>将查询的结果按照  <code>invoice_id</code>  排序。</p>\n<p>查询结果的格式如下例所示：</p>\n<pre><code>Customers table:\n+-------------+---------------+--------------------+\n| customer_id | customer_name | email              |\n+-------------+---------------+--------------------+\n| 1           | Alice         | alice@leetcode.com |\n| 2           | Bob           | bob@leetcode.com   |\n| 13          | John          | john@leetcode.com  |\n| 6           | Alex          | alex@leetcode.com  |\n+-------------+---------------+--------------------+\nContacts table:\n+-------------+--------------+--------------------+\n| user_id     | contact_name | contact_email      |\n+-------------+--------------+--------------------+\n| 1           | Bob          | bob@leetcode.com   |\n| 1           | John         | john@leetcode.com  |\n| 1           | Jal          | jal@leetcode.com   |\n| 2           | Omar         | omar@leetcode.com  |\n| 2           | Meir         | meir@leetcode.com  |\n| 6           | Alice        | alice@leetcode.com |\n+-------------+--------------+--------------------+\nInvoices table:\n+------------+-------+---------+\n| invoice_id | price | user_id |\n+------------+-------+---------+\n| 77         | 100   | 1       |\n| 88         | 200   | 1       |\n| 99         | 300   | 2       |\n| 66         | 400   | 2       |\n| 55         | 500   | 13      |\n| 44         | 60    | 6       |\n+------------+-------+---------+\nResult table:\n+------------+---------------+-------+--------------+----------------------+\n| invoice_id | customer_name | price | contacts_cnt | trusted_contacts_cnt |\n+------------+---------------+-------+--------------+----------------------+\n| 44         | Alex          | 60    | 1            | 1                    |\n| 55         | John          | 500   | 0            | 0                    |\n| 66         | Bob           | 400   | 2            | 0                    |\n| 77         | Alice         | 100   | 3            | 2                    |\n| 88         | Alice         | 200   | 3            | 2                    |\n| 99         | Bob           | 300   | 2            | 0                    |\n+------------+---------------+-------+--------------+----------------------+\nAlice 有三位联系人，其中两位(Bob 和 John)是可信联系人。\nBob 有两位联系人, 他们中的任何一位都不是可信联系人。\nAlex 只有一位联系人(Alice)，并是一位可信联系人。\nJohn 没有任何联系人。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> invoice_id <span class=\"token punctuation\">,</span>customer_name<span class=\"token punctuation\">,</span>price<span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>cnt<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> contacts_cnt<span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>bc<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> trusted_contacts_cnt </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Invoices i</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> user_id <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> cnt</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Contacts</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> user_id</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span> t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">on</span> i<span class=\"token punctuation\">.</span>user_id<span class=\"token operator\">=</span>t1<span class=\"token punctuation\">.</span>user_id</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">select</span>  user_id <span class=\"token punctuation\">,</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> bc</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">from</span> Contacts</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">where</span> contact_name <span class=\"token operator\">in</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">select</span> customer_name</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">from</span> Customers</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> user_id </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">on</span> i<span class=\"token punctuation\">.</span>user_id <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>user_id</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Customers c</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">on</span> i<span class=\"token punctuation\">.</span>user_id<span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>customer_id</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> invoice_id</pre></td></tr></table></figure><blockquote>\n<p>就是麻烦点 各种 join</p>\n</blockquote>\n<h4 id=\"1369-获取最近第二次的活动\"><a class=\"anchor\" href=\"#1369-获取最近第二次的活动\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ2V0LXRoZS1zZWNvbmQtbW9zdC1yZWNlbnQtYWN0aXZpdHkv\">1369. 获取最近第二次的活动</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>表:  <code>UserActivity</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| username      | varchar |\n| activity      | varchar |\n| startDate     | Date    |\n| endDate       | Date    |\n+---------------+---------+\n该表不包含主键\n该表包含每个用户在一段时间内进行的活动的信息\n名为 username 的用户在 startDate 到 endDate 日内有一次活动\n</code></pre>\n<p>写一条 SQL 查询展示每一位用户 <strong>最近第二次</strong> 的活动</p>\n<p>如果用户仅有一次活动，返回该活动</p>\n<p>一个用户不能同时进行超过一项活动，以 <strong>任意</strong> 顺序返回结果</p>\n<p>下面是查询结果格式的例子：</p>\n<pre><code>UserActivity 表:\n+------------+--------------+-------------+-------------+\n| username   | activity     | startDate   | endDate     |\n+------------+--------------+-------------+-------------+\n| Alice      | Travel       | 2020-02-12  | 2020-02-20  |\n| Alice      | Dancing      | 2020-02-21  | 2020-02-23  |\n| Alice      | Travel       | 2020-02-24  | 2020-02-28  |\n| Bob        | Travel       | 2020-02-11  | 2020-02-18  |\n+------------+--------------+-------------+-------------+\n\nResult 表:\n+------------+--------------+-------------+-------------+\n| username   | activity     | startDate   | endDate     |\n+------------+--------------+-------------+-------------+\n| Alice      | Dancing      | 2020-02-21  | 2020-02-23  |\n| Bob        | Travel       | 2020-02-11  | 2020-02-18  |\n+------------+--------------+-------------+-------------+\n\nAlice 最近第二次的活动是从 2020-02-24 到 2020-02-28 的旅行, 在此之前的 2020-02-21 到 2020-02-23 她进行了舞蹈\nBob 只有一条记录，我们就取这条记录\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> username<span class=\"token punctuation\">,</span> activity <span class=\"token punctuation\">,</span>startDate<span class=\"token punctuation\">,</span>endDate </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> username<span class=\"token punctuation\">,</span> activity <span class=\"token punctuation\">,</span>startDate<span class=\"token punctuation\">,</span>endDate <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> username <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> startDate <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    lag<span class=\"token punctuation\">(</span> startDate <span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> username <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> startDate <span class=\"token punctuation\">)</span> lg</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> UserActivity</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span> rk<span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token operator\">or</span>  <span class=\"token punctuation\">(</span>rk <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span>  lg <span class=\"token operator\">is</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1378-使用唯一标识码替换员工id\"><a class=\"anchor\" href=\"#1378-使用唯一标识码替换员工id\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVwbGFjZS1lbXBsb3llZS1pZC13aXRoLXRoZS11bmlxdWUtaWRlbnRpZmllci8=\">1378. 使用唯一标识码替换员工 ID</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p><code>Employees</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n+---------------+---------+\nid 是这张表的主键。\n这张表的每一行分别代表了某公司其中一位员工的名字和 ID 。\n</code></pre>\n<p><code>EmployeeUNI</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| unique_id     | int     |\n+---------------+---------+\n(id, unique_id) 是这张表的主键。\n这张表的每一行包含了该公司某位员工的 ID 和他的唯一标识码（unique ID）。\n</code></pre>\n<p>写一段 SQL 查询来展示每位用户的 <strong>唯一标识码（unique ID ）</strong>；如果某位员工没有唯一标识码，使用 null 填充即可。</p>\n<p>你可以以 <strong>任意</strong> 顺序返回结果表。</p>\n<p>查询结果的格式如下例所示：</p>\n<pre><code>Employees table:\n+----+----------+\n| id | name     |\n+----+----------+\n| 1  | Alice    |\n| 7  | Bob      |\n| 11 | Meir     |\n| 90 | Winston  |\n| 3  | Jonathan |\n+----+----------+\n\nEmployeeUNI table:\n+----+-----------+\n| id | unique_id |\n+----+-----------+\n| 3  | 1         |\n| 11 | 2         |\n| 90 | 3         |\n+----+-----------+\n\nEmployeeUNI table:\n+-----------+----------+\n| unique_id | name     |\n+-----------+----------+\n| null      | Alice    |\n| null      | Bob      |\n| 2         | Meir     |\n| 3         | Winston  |\n| 1         | Jonathan |\n+-----------+----------+\n\nAlice and Bob 没有唯一标识码, 因此我们使用 null 替代。\nMeir 的唯一标识码是 2 。\nWinston 的唯一标识码是 3 。\nJonathan 唯一标识码是 1 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> unique_id<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Employees  e <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> EmployeeUNI u</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> e<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> u<span class=\"token punctuation\">.</span>id</pre></td></tr></table></figure><h4 id=\"1384-按年度列出销售总额\"><a class=\"anchor\" href=\"#1384-按年度列出销售总额\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdG90YWwtc2FsZXMtYW1vdW50LWJ5LXllYXIv\">1384. 按年度列出销售总额</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p><code>Product</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| product_name  | varchar |\n+---------------+---------+\nproduct_id 是这张表的主键。\nproduct_name 是产品的名称。\n</code></pre>\n<p><code>Sales</code>  表：</p>\n<pre><code>+---------------------+---------+\n| Column Name         | Type    |\n+---------------------+---------+\n| product_id          | int     |\n| period_start        | varchar |\n| period_end          | date    |\n| average_daily_sales | int     |\n+---------------------+---------+\nproduct_id 是这张表的主键。\nperiod_start 和 period_end 是该产品销售期的起始日期和结束日期，且这两个日期包含在销售期内。\naverage_daily_sales 列存储销售期内该产品的日平均销售额。\n</code></pre>\n<p>编写一段 SQL 查询每个产品每年的总销售额，并包含 product_id, product_name 以及 report_year 等信息。</p>\n<p>销售年份的日期介于 2018 年到 2020 年之间。你返回的结果需要按 product_id 和 report_year <strong>排序</strong>。</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Product table:\n+------------+--------------+\n| product_id | product_name |\n+------------+--------------+\n| 1          | LC Phone     |\n| 2          | LC T-Shirt   |\n| 3          | LC Keychain  |\n+------------+--------------+\n\nSales table:\n+------------+--------------+-------------+---------------------+\n| product_id | period_start | period_end  | average_daily_sales |\n+------------+--------------+-------------+---------------------+\n| 1          | 2019-01-25   | 2019-02-28  | 100                 |\n| 2          | 2018-12-01   | 2020-01-01  | 10                  |\n| 3          | 2019-12-01   | 2020-01-31  | 1                   |\n+------------+--------------+-------------+---------------------+\n\nResult table:\n+------------+--------------+-------------+--------------+\n| product_id | product_name | report_year | total_amount |\n+------------+--------------+-------------+--------------+\n| 1          | LC Phone     |    2019     | 3500         |\n| 2          | LC T-Shirt   |    2018     | 310          |\n| 2          | LC T-Shirt   |    2019     | 3650         |\n| 2          | LC T-Shirt   |    2020     | 10           |\n| 3          | LC Keychain  |    2019     | 31           |\n| 3          | LC Keychain  |    2020     | 31           |\n+------------+--------------+-------------+--------------+\nLC Phone 在 2019-01-25 至 2019-02-28 期间销售，该产品销售时间总计35天。销售总额 35*100 = 3500。\nLC T-shirt 在 2018-12-01 至 2020-01-01 期间销售，该产品在2018年、2019年、2020年的销售时间分别是31天、365天、1天，2018年、2019年、2020年的销售总额分别是31*10=310、365*10=3650、1*10=10。\nLC Keychain 在 2019-12-01 至 2020-01-31 期间销售，该产品在2019年、2020年的销售时间分别是：31天、31天，2019年、2020年的销售总额分别是31*1=31、31*1=31。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token keyword\">select</span> Sales<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span> product_name<span class=\"token punctuation\">,</span> <span class=\"token string\">'2018'</span> <span class=\"token keyword\">as</span> <span class=\"token string\">'report_year'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_start<span class=\"token operator\">&lt;</span><span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>datediff<span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_end<span class=\"token operator\">&lt;</span><span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">,</span> period_end<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2018-12-31'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_start<span class=\"token operator\">>=</span><span class=\"token string\">'2018-01-01'</span><span class=\"token punctuation\">,</span> period_start<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2018-01-01'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>average_daily_sales<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total_amount</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> Sales  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">join</span> Product <span class=\"token keyword\">on</span> Sales<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> Product<span class=\"token punctuation\">.</span>product_id </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span>  total_amount<span class=\"token operator\">></span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">union</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">select</span> Sales<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span> product_name<span class=\"token punctuation\">,</span> <span class=\"token string\">'2019'</span> <span class=\"token keyword\">as</span> <span class=\"token string\">'report_year'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> period_start<span class=\"token operator\">&lt;</span><span class=\"token string\">'2020-01-01'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>datediff<span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_end<span class=\"token operator\">&lt;</span><span class=\"token string\">'2020-01-01'</span><span class=\"token punctuation\">,</span> period_end<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2019-12-31'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_start<span class=\"token operator\">>=</span><span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">,</span> period_start<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2019-01-01'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>average_daily_sales <span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total_amount</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">from</span> Sales  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">join</span> Product <span class=\"token keyword\">on</span> <span class=\"token punctuation\">(</span>Sales<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> Product<span class=\"token punctuation\">.</span>product_id <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">having</span>  total_amount<span class=\"token operator\">></span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">union</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">select</span> Sales<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">,</span> product_name<span class=\"token punctuation\">,</span> <span class=\"token string\">'2020'</span> <span class=\"token keyword\">as</span> <span class=\"token string\">'report_year'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>datediff<span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_end<span class=\"token operator\">&lt;</span><span class=\"token string\">'2021-01-01'</span><span class=\"token punctuation\">,</span> period_end<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2020-12-31'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>period_start<span class=\"token operator\">>=</span><span class=\"token string\">'2020-01-01'</span><span class=\"token punctuation\">,</span> period_start<span class=\"token punctuation\">,</span> <span class=\"token keyword\">date</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2020-01-01'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>average_daily_sales <span class=\"token keyword\">as</span> total_amount</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">from</span> Sales  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">join</span> Product  <span class=\"token keyword\">on</span> <span class=\"token punctuation\">(</span>Sales<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> Product<span class=\"token punctuation\">.</span>product_id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">having</span> total_amount<span class=\"token operator\">></span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> product_id<span class=\"token punctuation\">,</span> report_year</pre></td></tr></table></figure><blockquote>\n<p>各个年份进行 union, 就是年份判断的时候麻烦些</p>\n</blockquote>\n<h4 id=\"1393-股票的资本损益\"><a class=\"anchor\" href=\"#1393-股票的资本损益\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY2FwaXRhbC1nYWlubG9zcy8=\">1393. 股票的资本损益</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Stocks</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| stock_name    | varchar |\n| operation     | enum    |\n| operation_day | int     |\n| price         | int     |\n+---------------+---------+\n(stock_name, day) 是这张表的主键\noperation 列使用的是一种枚举类型，包括：('Sell','Buy')\n此表的每一行代表了名为 stock_name 的某支股票在 operation_day 这一天的操作价格。\n保证股票的每次'Sell'操作前，都有相应的'Buy'操作。\n</code></pre>\n<p>编写一个 SQL 查询来报告每支股票的资本损益。</p>\n<p>股票的资本损益是一次或多次买卖股票后的全部收益或损失。</p>\n<p>以任意顺序返回结果即可。</p>\n<p>SQL 查询结果的格式如下例所示：</p>\n<pre><code>Stocks 表:\n+---------------+-----------+---------------+--------+\n| stock_name    | operation | operation_day | price  |\n+---------------+-----------+---------------+--------+\n| Leetcode      | Buy       | 1             | 1000   |\n| Corona Masks  | Buy       | 2             | 10     |\n| Leetcode      | Sell      | 5             | 9000   |\n| Handbags      | Buy       | 17            | 30000  |\n| Corona Masks  | Sell      | 3             | 1010   |\n| Corona Masks  | Buy       | 4             | 1000   |\n| Corona Masks  | Sell      | 5             | 500    |\n| Corona Masks  | Buy       | 6             | 1000   |\n| Handbags      | Sell      | 29            | 7000   |\n| Corona Masks  | Sell      | 10            | 10000  |\n+---------------+-----------+---------------+--------+\n\nResult 表:\n+---------------+-------------------+\n| stock_name    | capital_gain_loss |\n+---------------+-------------------+\n| Corona Masks  | 9500              |\n| Leetcode      | 8000              |\n| Handbags      | -23000            |\n+---------------+-------------------+\nLeetcode 股票在第一天以1000美元的价格买入，在第五天以9000美元的价格卖出。资本收益=9000-1000=8000美元。\nHandbags 股票在第17天以30000美元的价格买入，在第29天以7000美元的价格卖出。资本损失=7000-30000=-23000美元。\nCorona Masks 股票在第1天以10美元的价格买入，在第3天以1010美元的价格卖出。在第4天以1000美元的价格再次购买，在第5天以500美元的价格出售。最后，它在第6天以1000美元的价格被买走，在第10天以10000美元的价格被卖掉。资本损益是每次（’Buy'-&gt;'Sell'）操作资本收益或损失的和=（1010-10）+（500-1000）+（10000-1000）=1000-500+9000=9500美元。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> stock_name<span class=\"token punctuation\">,</span>sell<span class=\"token operator\">-</span>buy capital_gain_loss</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> stock_name <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>       <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>operation<span class=\"token operator\">=</span><span class=\"token string\">'Buy'</span><span class=\"token punctuation\">,</span> price<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> stock_name <span class=\"token punctuation\">)</span> buy<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>       <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>operation<span class=\"token operator\">=</span><span class=\"token string\">'Sell'</span><span class=\"token punctuation\">,</span>price<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> stock_name<span class=\"token punctuation\">)</span> sell</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Stocks s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> stock_name<span class=\"token punctuation\">,</span>buy<span class=\"token punctuation\">,</span>sell</pre></td></tr></table></figure><h4 id=\"1398-购买了产品a和产品b却没有购买产品c的顾客\"><a class=\"anchor\" href=\"#1398-购买了产品a和产品b却没有购买产品c的顾客\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3VzdG9tZXJzLXdoby1ib3VnaHQtcHJvZHVjdHMtYS1hbmQtYi1idXQtbm90LWMv\">1398. 购买了产品 A 和产品 B 却没有购买产品 C 的顾客</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Customers</code>  表：</p>\n<pre><code>+---------------------+---------+\n| Column Name         | Type    |\n+---------------------+---------+\n| customer_id         | int     |\n| customer_name       | varchar |\n+---------------------+---------+\ncustomer_id 是这张表的主键。\ncustomer_name 是顾客的名称。\n</code></pre>\n<p><code>Orders</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| customer_id   | int     |\n| product_name  | varchar |\n+---------------+---------+\norder_id 是这张表的主键。\ncustomer_id 是购买了名为 &quot;product_name&quot; 产品顾客的id。\n</code></pre>\n<p>请你设计 SQL 查询来报告购买了产品 A 和产品 B 却没有购买产品 C 的顾客的 ID 和姓名（  <code>customer_id</code>  和  <code>customer_name</code>  ），我们将基于此结果为他们推荐产品 C 。<br />\n您返回的查询结果需要按照  <code>customer_id</code>  <strong>排序</strong>。</p>\n<p>查询结果如下例所示。</p>\n<pre><code>Customers table:\n+-------------+---------------+\n| customer_id | customer_name |\n+-------------+---------------+\n| 1           | Daniel        |\n| 2           | Diana         |\n| 3           | Elizabeth     |\n| 4           | Jhon          |\n+-------------+---------------+\n\nOrders table:\n+------------+--------------+---------------+\n| order_id   | customer_id  | product_name  |\n+------------+--------------+---------------+\n| 10         |     1        |     A         |\n| 20         |     1        |     B         |\n| 30         |     1        |     D         |\n| 40         |     1        |     C         |\n| 50         |     2        |     A         |\n| 60         |     3        |     A         |\n| 70         |     3        |     B         |\n| 80         |     3        |     D         |\n| 90         |     4        |     C         |\n+------------+--------------+---------------+\n\nResult table:\n+-------------+---------------+\n| customer_id | customer_name |\n+-------------+---------------+\n| 3           | Elizabeth     |\n+-------------+---------------+\n只有 customer_id 为 3 的顾客购买了产品 A 和产品 B ，却没有购买产品 C 。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  o<span class=\"token punctuation\">.</span>customer_id<span class=\"token punctuation\">,</span> customer_name </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Orders o <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span>  Customers c</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> o<span class=\"token punctuation\">.</span>customer_id<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span>customer_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>product_name <span class=\"token operator\">=</span><span class=\"token string\">'A'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'B'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>product_name<span class=\"token operator\">=</span><span class=\"token string\">'C'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><h4 id=\"1407-排名靠前的旅行者\"><a class=\"anchor\" href=\"#1407-排名靠前的旅行者\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdG9wLXRyYXZlbGxlcnMv\">1407. 排名靠前的旅行者</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表单:  <code>Users</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n+---------------+---------+\nid 是该表单主键.\nname 是用户名字.\n</code></pre>\n<p>表单:  <code>Rides</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| user_id       | int     |\n| distance      | int     |\n+---------------+---------+\nid 是该表单主键.\nuser_id 是本次行程的用户的 id, 而该用户此次行程距离为 distance.\n</code></pre>\n<p>写一段 SQL , 报告每个用户的旅行距离.</p>\n<p>返回的结果表单，以  <code>travelled_distance</code>  降序排列，如果有两个或者更多的用户旅行了相同的距离，那么再以  <code>name</code>  升序排列.</p>\n<p>查询结果格式，如下例所示.</p>\n<pre><code>Users 表单:\n+------+-----------+\n| id   | name      |\n+------+-----------+\n| 1    | Alice     |\n| 2    | Bob       |\n| 3    | Alex      |\n| 4    | Donald    |\n| 7    | Lee       |\n| 13   | Jonathan  |\n| 19   | Elvis     |\n+------+-----------+\n\nRides 表单:\n+------+----------+----------+\n| id   | user_id  | distance |\n+------+----------+----------+\n| 1    | 1        | 120      |\n| 2    | 2        | 317      |\n| 3    | 3        | 222      |\n| 4    | 7        | 100      |\n| 5    | 13       | 312      |\n| 6    | 19       | 50       |\n| 7    | 7        | 120      |\n| 8    | 19       | 400      |\n| 9    | 7        | 230      |\n+------+----------+----------+\n\nResult 表单:\n+----------+--------------------+\n| name     | travelled_distance |\n+----------+--------------------+\n| Elvis    | 450                |\n| Lee      | 450                |\n| Bob      | 317                |\n| Jonathan | 312                |\n| Alex     | 222                |\n| Alice    | 120                |\n| Donald   | 0                  |\n+----------+--------------------+\nElvis 和 Lee 旅行了 450 英里, Elvis 是排名靠前的旅行者, 因为他的名字在字母表上的排序比 Lee 更小.\nBob, Jonathan, Alex 和 Alice 只有一次行程, 我们只按此次行程的全部距离对他们排序.\nDonald 没有任何行程, 他的旅行距离为 0.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>ifnull<span class=\"token punctuation\">(</span>distance<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> travelled_distance </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Users u <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Rides r</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> u<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span>user_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> name</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> travelled_distance  <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span> name</pre></td></tr></table></figure><h4 id=\"1412-查找成绩处于中游的学生\"><a class=\"anchor\" href=\"#1412-查找成绩处于中游的学生\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC10aGUtcXVpZXQtc3R1ZGVudHMtaW4tYWxsLWV4YW1zLw==\">1412. 查找成绩处于中游的学生</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>表:  <code>Student</code></p>\n<pre><code>+---------------------+---------+\n| Column Name         | Type    |\n+---------------------+---------+\n| student_id          | int     |\n| student_name        | varchar |\n+---------------------+---------+\nstudent_id 是该表主键.\nstudent_name 学生名字.\n</code></pre>\n<p>表:  <code>Exam</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| exam_id       | int     |\n| student_id    | int     |\n| score         | int     |\n+---------------+---------+\n(exam_id, student_id) 是该表主键.\n学生 student_id 在测验 exam_id 中得分为 score.\n</code></pre>\n<p>成绩处于中游的学生是指至少参加了一次测验，且得分既不是最高分也不是最低分的学生。</p>\n<p>写一个 SQL 语句，找出在所有测验中都处于中游的学生  <code>(student_id, student_name)</code> 。</p>\n<p>不要返回从来没有参加过测验的学生。返回结果表按照  <code>student_id</code>  排序。</p>\n<p>查询结果格式如下。</p>\n<pre><code>Student 表：\n+-------------+---------------+\n| student_id  | student_name  |\n+-------------+---------------+\n| 1           | Daniel        |\n| 2           | Jade          |\n| 3           | Stella        |\n| 4           | Jonathan      |\n| 5           | Will          |\n+-------------+---------------+\n\nExam 表：\n+------------+--------------+-----------+\n| exam_id    | student_id   | score     |\n+------------+--------------+-----------+\n| 10         |     1        |    70     |\n| 10         |     2        |    80     |\n| 10         |     3        |    90     |\n| 20         |     1        |    80     |\n| 30         |     1        |    70     |\n| 30         |     3        |    80     |\n| 30         |     4        |    90     |\n| 40         |     1        |    60     |\n| 40         |     2        |    70     |\n| 40         |     4        |    80     |\n+------------+--------------+-----------+\n\nResult 表：\n+-------------+---------------+\n| student_id  | student_name  |\n+-------------+---------------+\n| 2           | Jade          |\n+-------------+---------------+\n\n对于测验 1: 学生 1 和 3 分别获得了最低分和最高分。\n对于测验 2: 学生 1 既获得了最高分, 也获得了最低分。\n对于测验 3 和 4: 学生 1 和 4 分别获得了最低分和最高分。\n学生 2 和 5 没有在任一场测验中获得了最高分或者最低分。\n因为学生 5 从来没有参加过任何测验, 所以他被排除于结果表。\n由此, 我们仅仅返回学生 2 的信息。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> e<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span>student_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Exam e <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Student s</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> e<span class=\"token punctuation\">.</span>student_id<span class=\"token operator\">=</span>s<span class=\"token punctuation\">.</span>student_id</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span> e<span class=\"token punctuation\">.</span>student_id <span class=\"token operator\">not</span> <span class=\"token operator\">in</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">select</span> student_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">select</span> student_id<span class=\"token punctuation\">,</span>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> exam_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> score <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rkmax<span class=\"token punctuation\">,</span> rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> exam_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> score <span class=\"token punctuation\">)</span> rkmin</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">from</span> Exam </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">where</span> rkmax <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">or</span> rkmin <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> e<span class=\"token punctuation\">.</span>student_id<span class=\"token punctuation\">,</span>student_name</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> e<span class=\"token punctuation\">.</span>student_id</pre></td></tr></table></figure><h4 id=\"1421-净现值查询\"><a class=\"anchor\" href=\"#1421-净现值查询\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvbnB2LXF1ZXJpZXMv\">1421. 净现值查询</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>NPV</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| year          | int     |\n| npv           | int     |\n+---------------+---------+\n(id, year) 是该表主键.\n该表有每一笔存货的年份, id 和对应净现值的信息.\n</code></pre>\n<p>表:  <code>Queries</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| year          | int     |\n+---------------+---------+\n(id, year) 是该表主键.\n该表有每一次查询所对应存货的 id 和年份的信息.\n</code></pre>\n<p>写一个 SQL, 找到 Queries 表中每一次查询的净现值.</p>\n<p>结果表没有顺序要求.</p>\n<p>查询结果的格式如下所示:</p>\n<pre><code>NPV 表:\n+------+--------+--------+\n| id   | year   | npv    |\n+------+--------+--------+\n| 1    | 2018   | 100    |\n| 7    | 2020   | 30     |\n| 13   | 2019   | 40     |\n| 1    | 2019   | 113    |\n| 2    | 2008   | 121    |\n| 3    | 2009   | 12     |\n| 11   | 2020   | 99     |\n| 7    | 2019   | 0      |\n+------+--------+--------+\n\nQueries 表:\n+------+--------+\n| id   | year   |\n+------+--------+\n| 1    | 2019   |\n| 2    | 2008   |\n| 3    | 2009   |\n| 7    | 2018   |\n| 7    | 2019   |\n| 7    | 2020   |\n| 13   | 2019   |\n+------+--------+\n\n结果表:\n+------+--------+--------+\n| id   | year   | npv    |\n+------+--------+--------+\n| 1    | 2019   | 113    |\n| 2    | 2008   | 121    |\n| 3    | 2009   | 12     |\n| 7    | 2018   | 0      |\n| 7    | 2019   | 0      |\n| 7    | 2020   | 30     |\n| 13   | 2019   | 40     |\n+------+--------+--------+\n\n(7, 2018)的净现值不在 NPV 表中, 我们把它看作是 0.\n所有其它查询的净现值都能在 NPV 表中找到.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> q<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>q<span class=\"token punctuation\">.</span><span class=\"token keyword\">year</span><span class=\"token punctuation\">,</span>ifnull<span class=\"token punctuation\">(</span>npv<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> npv</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Queries q <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> NPV n</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> q<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> n<span class=\"token punctuation\">.</span>id <span class=\"token operator\">and</span> q<span class=\"token punctuation\">.</span><span class=\"token keyword\">year</span> <span class=\"token operator\">=</span> n<span class=\"token punctuation\">.</span><span class=\"token keyword\">year</span></pre></td></tr></table></figure><blockquote>\n<p>npv 净现值概念 了解下</p>\n</blockquote>\n<h4 id=\"1435-制作会话柱状图\"><a class=\"anchor\" href=\"#1435-制作会话柱状图\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3JlYXRlLWEtc2Vzc2lvbi1iYXItY2hhcnQv\">1435. 制作会话柱状图</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表： <code>Sessions</code></p>\n<pre><code>+---------------------+---------+\n| Column Name         | Type    |\n+---------------------+---------+\n| session_id          | int     |\n| duration            | int     |\n+---------------------+---------+\nsession_id 是该表主键\nduration 是用户访问应用的时间, 以秒为单位\n</code></pre>\n<p>你想知道用户在你的 app 上的访问时长情况。因此决定统计访问时长区间分别为 &quot;[0-5&gt;&quot;, &quot;[5-10&gt;&quot;, &quot;[10-15&gt;&quot; 和 &quot;15 or more&quot; （单位：分钟）的会话数量，并以此绘制柱状图。</p>\n<p>写一个 SQL 查询来报告（访问时长区间，会话总数）。结果可用任何顺序呈现。</p>\n<p><strong>下方为查询的输出格式：</strong></p>\n<pre><code>Sessions 表：\n+-------------+---------------+\n| session_id  | duration      |\n+-------------+---------------+\n| 1           | 30            |\n| 2           | 199           |\n| 3           | 299           |\n| 4           | 580           |\n| 5           | 1000          |\n+-------------+---------------+\n\nResult 表：\n+--------------+--------------+\n| bin          | total        |\n+--------------+--------------+\n| [0-5&gt;        | 3            |\n| [5-10&gt;       | 1            |\n| [10-15&gt;      | 0            |\n| 15 or more   | 1            |\n+--------------+--------------+\n\n对于 session_id 1，2 和 3 ，它们的访问时间大于等于 0 分钟且小于 5 分钟。\n对于 session_id 4，它的访问时间大于等于 5 分钟且小于 10 分钟。\n没有会话的访问时间大于等于 10 分钟且小于 15 分钟。\n对于 session_id 5, 它的访问时间大于等于 15 分钟。\n</code></pre>\n<p>Union</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token string\">'[0-5>'</span> <span class=\"token keyword\">as</span> bin<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total <span class=\"token keyword\">from</span> Sessions <span class=\"token keyword\">where</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">>=</span><span class=\"token number\">0</span> <span class=\"token operator\">and</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">&lt;</span><span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token string\">'[5-10>'</span> <span class=\"token keyword\">as</span> bin<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total <span class=\"token keyword\">from</span> Sessions <span class=\"token keyword\">where</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">>=</span><span class=\"token number\">5</span> <span class=\"token operator\">and</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">&lt;</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token string\">'[10-15>'</span> <span class=\"token keyword\">as</span> bin<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total <span class=\"token keyword\">from</span> Sessions <span class=\"token keyword\">where</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">>=</span><span class=\"token number\">10</span> <span class=\"token operator\">and</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">&lt;</span><span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">union</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token string\">'15 or more'</span><span class=\"token keyword\">as</span> bin<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total <span class=\"token keyword\">from</span> Sessions <span class=\"token keyword\">where</span> duration<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">>=</span><span class=\"token number\">15</span></pre></td></tr></table></figure><p>还有很多其他解法</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>bin<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>bin<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token string\">'[0-5>'</span> <span class=\"token keyword\">as</span> bin <span class=\"token keyword\">union</span> <span class=\"token keyword\">select</span> <span class=\"token string\">'[5-10>'</span> <span class=\"token keyword\">as</span> bin <span class=\"token keyword\">union</span> <span class=\"token keyword\">select</span> <span class=\"token string\">'[10-15>'</span> <span class=\"token keyword\">as</span> bin <span class=\"token keyword\">union</span> <span class=\"token keyword\">select</span> <span class=\"token string\">'15 or more'</span> <span class=\"token keyword\">as</span> bin </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">)</span>a</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token keyword\">case</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">when</span> duration <span class=\"token operator\">&lt;</span> <span class=\"token number\">300</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'[0-5>'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">when</span> duration <span class=\"token operator\">>=</span> <span class=\"token number\">300</span> <span class=\"token operator\">and</span> duration <span class=\"token operator\">&lt;</span> <span class=\"token number\">600</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'[5-10>'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">when</span> duration <span class=\"token operator\">>=</span> <span class=\"token number\">600</span> <span class=\"token operator\">and</span> duration <span class=\"token operator\">&lt;</span> <span class=\"token number\">900</span> <span class=\"token keyword\">then</span> <span class=\"token string\">'[10-15>'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">else</span> <span class=\"token string\">'15 or more'</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">end</span> bin</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">from</span> Sessions </pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">)</span>b</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">on</span> a<span class=\"token punctuation\">.</span>bin <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>bin</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> a<span class=\"token punctuation\">.</span>bin</pre></td></tr></table></figure><h4 id=\"1440-计算布尔表达式的值\"><a class=\"anchor\" href=\"#1440-计算布尔表达式的值\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZXZhbHVhdGUtYm9vbGVhbi1leHByZXNzaW9uLw==\">1440. 计算布尔表达式的值</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表  <code>Variables</code> :</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| name          | varchar |\n| value         | int     |\n+---------------+---------+\nname 是该表主键.\n该表包含了存储的变量及其对应的值.\n</code></pre>\n<p>表  <code>Expressions</code> :</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| left_operand  | varchar |\n| operator      | enum    |\n| right_operand | varchar |\n+---------------+---------+\n(left_operand, operator, right_operand) 是该表主键.\n该表包含了需要计算的布尔表达式.\noperator 是枚举类型, 取值于('&lt;', '&gt;', '=')\nleft_operand 和 right_operand 的值保证存在于 Variables 表单中.\n</code></pre>\n<p>写一个 SQL 查询，以计算表  <code>Expressions</code>  中的布尔表达式.</p>\n<p>返回的结果表没有顺序要求.</p>\n<p>查询结果格式如下例所示.</p>\n<pre><code>Variables 表:\n+------+-------+\n| name | value |\n+------+-------+\n| x    | 66    |\n| y    | 77    |\n+------+-------+\n\nExpressions 表:\n+--------------+----------+---------------+\n| left_operand | operator | right_operand |\n+--------------+----------+---------------+\n| x            | &gt;        | y             |\n| x            | &lt;        | y             |\n| x            | =        | y             |\n| y            | &gt;        | x             |\n| y            | &lt;        | x             |\n| x            | =        | x             |\n+--------------+----------+---------------+\n\nResult 表:\n+--------------+----------+---------------+-------+\n| left_operand | operator | right_operand | value |\n+--------------+----------+---------------+-------+\n| x            | &gt;        | y             | false |\n| x            | &lt;        | y             | true  |\n| x            | =        | y             | false |\n| y            | &gt;        | x             | true  |\n| y            | &lt;        | x             | false |\n| x            | =        | x             | true  |\n+--------------+----------+---------------+-------+\n如上所示, 你需要通过使用 Variables 表来找到 Expressions 表中的每一个布尔表达式的值.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> e<span class=\"token punctuation\">.</span>left_operand<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>operator<span class=\"token punctuation\">,</span>e<span class=\"token punctuation\">.</span>right_operand<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">case</span> e<span class=\"token punctuation\">.</span>operator</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">when</span> <span class=\"token string\">'>'</span> <span class=\"token keyword\">then</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token operator\">></span>v2<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span><span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'false'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">when</span> <span class=\"token string\">'&lt;'</span> <span class=\"token keyword\">then</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token operator\">&lt;</span>v2<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span><span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'false'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">else</span>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token operator\">=</span>v2<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span><span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'false'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">end</span> <span class=\"token keyword\">value</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> Expressions e</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Variables v1 <span class=\"token keyword\">on</span> v1<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>left_operand </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Variables v2 <span class=\"token keyword\">on</span> v2<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>right_operand</pre></td></tr></table></figure><h4 id=\"1445-苹果和桔子\"><a class=\"anchor\" href=\"#1445-苹果和桔子\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYXBwbGVzLW9yYW5nZXMv\">1445. 苹果和桔子</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Sales</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| sale_date     | date    |\n| fruit         | enum    | \n| sold_num      | int     | \n+---------------+---------+\n(sale_date,fruit) 是该表主键.\n该表包含了每一天中&quot;苹果&quot; 和 &quot;桔子&quot;的销售情况.\n</code></pre>\n<p>写一个 SQL 查询，报告每一天 <strong>苹果</strong> 和 <strong>桔子</strong> 销售的数目的差异.</p>\n<p>返回的结果表，按照格式为 ('YYYY-MM-DD') 的  <code>sale_date</code>  排序.</p>\n<p>查询结果表如下例所示:</p>\n<pre><code>Sales 表:\n+------------+------------+-------------+\n| sale_date  | fruit      | sold_num    |\n+------------+------------+-------------+\n| 2020-05-01 | apples     | 10          |\n| 2020-05-01 | oranges    | 8           |\n| 2020-05-02 | apples     | 15          |\n| 2020-05-02 | oranges    | 15          |\n| 2020-05-03 | apples     | 20          |\n| 2020-05-03 | oranges    | 0           |\n| 2020-05-04 | apples     | 15          |\n| 2020-05-04 | oranges    | 16          |\n+------------+------------+-------------+\n\nResult 表:\n+------------+--------------+\n| sale_date  | diff         |\n+------------+--------------+\n| 2020-05-01 | 2            |\n| 2020-05-02 | 0            |\n| 2020-05-03 | 20           |\n| 2020-05-04 | -1           |\n+------------+--------------+\n\n在 2020-05-01, 卖了 10 个苹果 和 8 个桔子 (差异为 10 - 8 = 2).\n在 2020-05-02, 卖了 15 个苹果 和 15 个桔子 (差异为 15 - 15 = 0).\n在 2020-05-03, 卖了 20 个苹果 和 0 个桔子 (差异为 20 - 0 = 20).\n在 2020-05-04, 卖了 15 个苹果 和 16 个桔子 (差异为 15 - 16 = -1).\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  sale_date<span class=\"token punctuation\">,</span>sold_num<span class=\"token operator\">-</span>ld diff</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> sale_date<span class=\"token punctuation\">,</span>sold_num <span class=\"token punctuation\">,</span> fruit <span class=\"token punctuation\">,</span>lead<span class=\"token punctuation\">(</span>sold_num <span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span>  sale_date <span class=\"token punctuation\">)</span> ld</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> Sales</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> fruit<span class=\"token operator\">=</span><span class=\"token string\">'apples'</span></pre></td></tr></table></figure><h4 id=\"1454-活跃用户\"><a class=\"anchor\" href=\"#1454-活跃用户\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvYWN0aXZlLXVzZXJzLw==\">1454.  活跃用户</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表  <code>Accounts</code> :</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| name          | varchar |\n+---------------+---------+\nid 是该表主键.\n该表包含账户 id 和账户的用户名.\n</code></pre>\n<p>表  <code>Logins</code> :</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| login_date    | date    |\n+---------------+---------+\n该表无主键, 可能包含重复项.\n该表包含登录用户的账户 id 和登录日期. 用户也许一天内登录多次.\n</code></pre>\n<p>写一个 SQL 查询，找到活跃用户的 id 和 name.</p>\n<p>活跃用户是指那些至少连续 5 天登录账户的用户.</p>\n<p>返回的结果表按照 id 排序.</p>\n<p>结果表格式如下例所示:</p>\n<pre><code>Accounts 表:\n+----+----------+\n| id | name     |\n+----+----------+\n| 1  | Winston  |\n| 7  | Jonathan |\n+----+----------+\n\nLogins 表:\n+----+------------+\n| id | login_date |\n+----+------------+\n| 7  | 2020-05-30 |\n| 1  | 2020-05-30 |\n| 7  | 2020-05-31 |\n| 7  | 2020-06-01 |\n| 7  | 2020-06-02 |\n| 7  | 2020-06-02 |\n| 7  | 2020-06-03 |\n| 1  | 2020-06-07 |\n| 7  | 2020-06-10 |\n+----+------------+\n\nResult 表:\n+----+----------+\n| id | name     |\n+----+----------+\n| 7  | Jonathan |\n+----+----------+\nid = 1 的用户 Winston 仅仅在不同的 2 天内登录了 2 次, 所以, Winston 不是活跃用户.\nid = 7 的用户 Jonathon 在不同的 6 天内登录了 7 次, , 6 天中有 5 天是连续的, 所以, Jonathan 是活跃用户.\n</code></pre>\n<p><strong>后续问题:</strong><br />\n 如果活跃用户是那些至少连续  <code>n</code>  天登录账户的用户，你能否写出通用的解决方案？</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> t3<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>login_date<span class=\"token punctuation\">,</span>lead<span class=\"token punctuation\">(</span>login_date<span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> login_date<span class=\"token punctuation\">)</span> ld</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>login_date </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">from</span> Logins</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> id<span class=\"token punctuation\">,</span>login_date</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">)</span>t2</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">where</span> datediff<span class=\"token punctuation\">(</span>ld<span class=\"token punctuation\">,</span>login_date<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">)</span>t3</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Accounts a</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">on</span> t3<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> a<span class=\"token punctuation\">.</span>id</pre></td></tr></table></figure><blockquote>\n<p>注意用户当天重复登入</p>\n</blockquote>\n<h4 id=\"1459-矩形面积\"><a class=\"anchor\" href=\"#1459-矩形面积\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcmVjdGFuZ2xlcy1hcmVhLw==\">1459. 矩形面积</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表:  <code>Points</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| id            | int     |\n| x_value       | int     |\n| y_value       | int     |\n+---------------+---------+\nid 是该表主键.\n每个点都表示为二维空间 (x_value, y_value).\n</code></pre>\n<p>写一个 SQL 语句，报告由表中任意两点可以形成的所有可能的矩形.</p>\n<p>结果表中的每一行包含三列 (p1, p2, area) 如下:</p>\n<ul>\n<li><strong>p1</strong> 和 <strong>p2</strong> 是矩形两个对角的 id 且 p1 &lt; p2.</li>\n<li>矩形的面积由列 <strong>area</strong> 表示.</li>\n</ul>\n<p>请按照面积大小降序排列，如果面积相同的话，则按照 p1 和 p2 升序对结果表排序</p>\n<pre><code>Points 表:\n+----------+-------------+-------------+\n| id       | x_value     | y_value     |\n+----------+-------------+-------------+\n| 1        | 2           | 8           |\n| 2        | 4           | 7           |\n| 3        | 2           | 10          |\n+----------+-------------+-------------+\n\nResult 表:\n+----------+-------------+-------------+\n| p1       | p2          | area        |\n+----------+-------------+-------------+\n| 2        | 3           | 6           |\n| 1        | 2           | 2           |\n+----------+-------------+-------------+\n\np1 应该小于 p2 并且面积大于 0.\np1 = 1 且 p2 = 2 时, 面积等于 |2-4| * |8-7| = 2.\np1 = 2 且 p2 = 3 时, 面积等于 |4-2| * |7-10| = 6.\np1 = 1 且 p2 = 3 时, 是不可能为矩形的, 因为面积等于 0.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> a<span class=\"token punctuation\">.</span>id P1<span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">.</span>id P2<span class=\"token punctuation\">,</span>abs<span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>x_value<span class=\"token operator\">-</span>b<span class=\"token punctuation\">.</span>x_value<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>abs<span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>y_value<span class=\"token operator\">-</span>b<span class=\"token punctuation\">.</span>y_value<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> area</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Points a<span class=\"token punctuation\">,</span>Points b</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> a<span class=\"token punctuation\">.</span>id<span class=\"token operator\">&lt;</span>b<span class=\"token punctuation\">.</span>id <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>x_value <span class=\"token operator\">!=</span> b<span class=\"token punctuation\">.</span>x_value <span class=\"token operator\">and</span> a<span class=\"token punctuation\">.</span>y_value <span class=\"token operator\">!=</span> b<span class=\"token punctuation\">.</span>y_value</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> area <span class=\"token keyword\">desc</span><span class=\"token punctuation\">,</span>P1 <span class=\"token punctuation\">,</span>P2</pre></td></tr></table></figure><h4 id=\"1468-计算税后工资\"><a class=\"anchor\" href=\"#1468-计算税后工资\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY2FsY3VsYXRlLXNhbGFyaWVzLw==\">1468. 计算税后工资</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p><code>Salaries</code>  表：</p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| company_id    | int     |\n| employee_id   | int     |\n| employee_name | varchar |\n| salary        | int     |\n+---------------+---------+\n(company_id, employee_id) 是这个表的主键\n这个表包括员工的company id, id, name 和 salary \n</code></pre>\n<p>写一条查询 SQL 来查找每个员工的税后工资</p>\n<p>每个公司的税率计算依照以下规则</p>\n<ul>\n<li>如果这个公司员工最高工资不到 1000 ，税率为 0%</li>\n<li>如果这个公司员工最高工资在 1000 到 10000 之间，税率为 24%</li>\n<li>如果这个公司员工最高工资大于 10000 ，税率为 49%</li>\n</ul>\n<p>按任意顺序返回结果，税后工资结果取整</p>\n<p>结果表格式如下例所示：</p>\n<pre><code>Salaries 表：\n+------------+-------------+---------------+--------+\n| company_id | employee_id | employee_name | salary |\n+------------+-------------+---------------+--------+\n| 1          | 1           | Tony          | 2000   |\n| 1          | 2           | Pronub        | 21300  |\n| 1          | 3           | Tyrrox        | 10800  |\n| 2          | 1           | Pam           | 300    |\n| 2          | 7           | Bassem        | 450    |\n| 2          | 9           | Hermione      | 700    |\n| 3          | 7           | Bocaben       | 100    |\n| 3          | 2           | Ognjen        | 2200   |\n| 3          | 13          | Nyancat       | 3300   |\n| 3          | 15          | Morninngcat   | 1866   |\n+------------+-------------+---------------+--------+\n\nResult 表：\n+------------+-------------+---------------+--------+\n| company_id | employee_id | employee_name | salary |\n+------------+-------------+---------------+--------+\n| 1          | 1           | Tony          | 1020   |\n| 1          | 2           | Pronub        | 10863  |\n| 1          | 3           | Tyrrox        | 5508   |\n| 2          | 1           | Pam           | 300    |\n| 2          | 7           | Bassem        | 450    |\n| 2          | 9           | Hermione      | 700    |\n| 3          | 7           | Bocaben       | 76     |\n| 3          | 2           | Ognjen        | 1672   |\n| 3          | 13          | Nyancat       | 2508   |\n| 3          | 15          | Morninngcat   | 5911   |\n+------------+-------------+---------------+--------+\n对于公司 1 ，最高工资是 21300 ，其每个员工的税率为 49%\n对于公司 2 ，最高工资是 700 ，其每个员工税率为 0%\n对于公司 3 ，最高工资是 7777 ，其每个员工税率是 24%\n税后工资计算 = 工资 - ( 税率 / 100）*工资\n对于上述案例，Morninngcat 的税后工资 = 7777 - 7777 * ( 24 / 100) = 7777 - 1866.48 = 5910.52 ，取整为 5911\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> company_id<span class=\"token punctuation\">,</span>employee_id <span class=\"token punctuation\">,</span> employee_name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> maxsalary<span class=\"token operator\">&lt;</span><span class=\"token number\">1000</span> <span class=\"token keyword\">then</span> salary</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>       <span class=\"token keyword\">when</span> maxsalary<span class=\"token operator\">&lt;</span><span class=\"token number\">10000</span> <span class=\"token keyword\">then</span> salary<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">-</span><span class=\"token number\">0.24</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>       <span class=\"token keyword\">else</span> salary<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">-</span><span class=\"token number\">0.49</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">end</span> <span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>salary</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>salary<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> company_id <span class=\"token punctuation\">)</span> maxsalary</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">from</span> Salaries </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr></table></figure><h4 id=\"1479-周内每天的销售情况\"><a class=\"anchor\" href=\"#1479-周内每天的销售情况\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvc2FsZXMtYnktZGF5LW9mLXRoZS13ZWVrLw==\">1479. 周内每天的销售情况</span></h4>\n<p>难度困难</p>\n<p>SQL 架构</p>\n<p>表： <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| customer_id   | int     |\n| order_date    | date    | \n| item_id       | varchar |\n| quantity      | int     |\n+---------------+---------+\n(order_id, item_id) 是该表主键\n该表包含了订单信息\norder_date 是id为 item_id 的商品被id为 customer_id 的消费者订购的日期.\n</code></pre>\n<p>表： <code>Items</code></p>\n<pre><code>+---------------------+---------+\n| Column Name         | Type    |\n+---------------------+---------+\n| item_id             | varchar |\n| item_name           | varchar |\n| item_category       | varchar |\n+---------------------+---------+\nitem_id 是该表主键\nitem_name 是商品的名字\nitem_category 是商品的类别\n</code></pre>\n<p>你是企业主，想要获得分类商品和周内每天的销售报告。</p>\n<p>写一个 SQL 语句，报告 <strong>周内每天</strong> 每个商品类别下订购了多少单位。</p>\n<p>返回结果表单 <strong>按商品类别排序</strong> 。</p>\n<p>查询结果格式如下例所示：</p>\n<pre><code>Orders 表：\n+------------+--------------+-------------+--------------+-------------+\n| order_id   | customer_id  | order_date  | item_id      | quantity    |\n+------------+--------------+-------------+--------------+-------------+\n| 1          | 1            | 2020-06-01  | 1            | 10          |\n| 2          | 1            | 2020-06-08  | 2            | 10          |\n| 3          | 2            | 2020-06-02  | 1            | 5           |\n| 4          | 3            | 2020-06-03  | 3            | 5           |\n| 5          | 4            | 2020-06-04  | 4            | 1           |\n| 6          | 4            | 2020-06-05  | 5            | 5           |\n| 7          | 5            | 2020-06-05  | 1            | 10          |\n| 8          | 5            | 2020-06-14  | 4            | 5           |\n| 9          | 5            | 2020-06-21  | 3            | 5           |\n+------------+--------------+-------------+--------------+-------------+\n\nItems 表：\n+------------+----------------+---------------+\n| item_id    | item_name      | item_category |\n+------------+----------------+---------------+\n| 1          | LC Alg. Book   | Book          |\n| 2          | LC DB. Book    | Book          |\n| 3          | LC SmarthPhone | Phone         |\n| 4          | LC Phone 2020  | Phone         |\n| 5          | LC SmartGlass  | Glasses       |\n| 6          | LC T-Shirt XL  | T-Shirt       |\n+------------+----------------+---------------+\n\nResult 表：\n+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+\n| Category   | Monday    | Tuesday   | Wednesday | Thursday  | Friday    | Saturday  | Sunday    |\n+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+\n| Book       | 20        | 5         | 0         | 0         | 10        | 0         | 0         |\n| Glasses    | 0         | 0         | 0         | 0         | 5         | 0         | 0         |\n| Phone      | 0         | 0         | 5         | 1         | 0         | 0         | 10        |\n| T-Shirt    | 0         | 0         | 0         | 0         | 0         | 0         | 0         |\n+------------+-----------+-----------+-----------+-----------+-----------+-----------+-----------+\n在周一(2020-06-01, 2020-06-08)，Book分类(ids: 1, 2)下，总共销售了20个单位(10 + 10)\n在周二(2020-06-02)，Book分类(ids: 1, 2)下，总共销售了5个单位\n在周三(2020-06-03)，Phone分类(ids: 3, 4)下，总共销售了5个单位\n在周四(2020-06-04)，Phone分类(ids: 3, 4)下，总共销售了1个单位\n在周五(2020-06-05)，Book分类(ids: 1, 2)下，总共销售了10个单位，Glasses分类(ids: 5)下，总共销售了5个单位\n在周六, 没有商品销售\n在周天(2020-06-14, 2020-06-21)，Phone分类(ids: 3, 4)下，总共销售了10个单位(5 + 5)\n没有销售 T-Shirt 类别的商品\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> item_category <span class=\"token keyword\">as</span> category<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Monday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">3</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Tuesday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">4</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Wednesday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">5</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Thursday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">6</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Friday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">7</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Saturday<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> <span class=\"token keyword\">when</span> num <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token keyword\">then</span> quantity <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> Sunday</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> item_category<span class=\"token punctuation\">,</span> quantity<span class=\"token punctuation\">,</span>dayofweek<span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> num <span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>items i <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> orders o </pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">on</span> i<span class=\"token punctuation\">.</span>item_id<span class=\"token operator\">=</span>o<span class=\"token punctuation\">.</span>item_id<span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> item_category</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> item_category</pre></td></tr></table></figure><h4 id=\"1485-按日期分组销售产品\"><a class=\"anchor\" href=\"#1485-按日期分组销售产品\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZ3JvdXAtc29sZC1wcm9kdWN0cy1ieS10aGUtZGF0ZS8=\">1485. 按日期分组销售产品</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表  <code>Activities</code> ：</p>\n<pre><code>+-------------+---------+\n| 列名         | 类型    |\n+-------------+---------+\n| sell_date   | date    |\n| product     | varchar |\n+-------------+---------+\n此表没有主键，它可能包含重复项。\n此表的每一行都包含产品名称和在市场上销售的日期。\n</code></pre>\n<p>编写一个 SQL 查询来查找每个日期、销售的不同产品的数量及其名称。<br />\n每个日期的销售产品名称应按词典序排列。<br />\n返回按  <code>sell_date</code>  排序的结果表。</p>\n<p>查询结果格式如下例所示。</p>\n<pre><code>Activities 表：\n+------------+-------------+\n| sell_date  | product     |\n+------------+-------------+\n| 2020-05-30 | Headphone   |\n| 2020-06-01 | Pencil      |\n| 2020-06-02 | Mask        |\n| 2020-05-30 | Basketball  |\n| 2020-06-01 | Bible       |\n| 2020-06-02 | Mask        |\n| 2020-05-30 | T-Shirt     |\n+------------+-------------+\n\nResult 表：\n+------------+----------+------------------------------+\n| sell_date  | num_sold | products                     |\n+------------+----------+------------------------------+\n| 2020-05-30 | 3        | Basketball,Headphone,T-shirt |\n| 2020-06-01 | 2        | Bible,Pencil                 |\n| 2020-06-02 | 1        | Mask                         |\n+------------+----------+------------------------------+\n对于2020-05-30，出售的物品是 (Headphone, Basketball, T-shirt)，按词典序排列，并用逗号 ',' 分隔。\n对于2020-06-01，出售的物品是 (Pencil, Bible)，按词典序排列，并用逗号分隔。\n对于2020-06-02，出售的物品是 (Mask)，只需返回该物品名。\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> sell_date<span class=\"token punctuation\">,</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> product<span class=\"token punctuation\">)</span> num_sold<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    group_concat<span class=\"token punctuation\">(</span><span class=\"token keyword\">distinct</span> product <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> product<span class=\"token punctuation\">)</span> products</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> Activities</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> sell_date</pre></td></tr></table></figure><blockquote>\n<p>行转列</p>\n</blockquote>\n<h4 id=\"1495-上月播放的儿童适宜电影\"><a class=\"anchor\" href=\"#1495-上月播放的儿童适宜电影\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZnJpZW5kbHktbW92aWVzLXN0cmVhbWVkLWxhc3QtbW9udGgv\">1495. 上月播放的儿童适宜电影</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表:  <code>TVProgram</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| program_date  | date    |\n| content_id    | int     |\n| channel       | varchar |\n+---------------+---------+\n(program_date, content_id) 是该表主键.\n该表包含电视上的节目信息.\ncontent_id 是电视一些频道上的节目的 id.\n</code></pre>\n<p>表:  <code>Content</code></p>\n<pre><code>+------------------+---------+\n| Column Name      | Type    |\n+------------------+---------+\n| content_id       | varchar |\n| title            | varchar |\n| Kids_content     | enum    |\n| content_type     | varchar |\n+------------------+---------+\ncontent_id 是该表主键.\nKids_content 是枚举类型, 取值为('Y', 'N'), 其中: \n'Y' 表示儿童适宜内容, 而'N'表示儿童不宜内容.\ncontent_type 表示内容的类型, 比如电影, 电视剧等.\n</code></pre>\n<p>写一个 SQL 语句，报告在 2020 年 6 月份播放的儿童适宜电影的去重电影名.</p>\n<p>返回的结果表单没有顺序要求.</p>\n<p>查询结果的格式如下例所示.</p>\n<pre><code>TVProgram 表:\n+--------------------+--------------+-------------+\n| program_date       | content_id   | channel     |\n+--------------------+--------------+-------------+\n| 2020-06-10 08:00   | 1            | LC-Channel  |\n| 2020-05-11 12:00   | 2            | LC-Channel  |\n| 2020-05-12 12:00   | 3            | LC-Channel  |\n| 2020-05-13 14:00   | 4            | Disney Ch   |\n| 2020-06-18 14:00   | 4            | Disney Ch   |\n| 2020-07-15 16:00   | 5            | Disney Ch   |\n+--------------------+--------------+-------------+\n\nContent 表:\n+------------+----------------+---------------+---------------+\n| content_id | title          | Kids_content  | content_type  |\n+------------+----------------+---------------+---------------+\n| 1          | Leetcode Movie | N             | Movies        |\n| 2          | Alg. for Kids  | Y             | Series        |\n| 3          | Database Sols  | N             | Series        |\n| 4          | Aladdin        | Y             | Movies        |\n| 5          | Cinderella     | Y             | Movies        |\n+------------+----------------+---------------+---------------+\n\nResult 表:\n+--------------+\n| title        |\n+--------------+\n| Aladdin      |\n+--------------+\n&quot;Leetcode Movie&quot; 是儿童不宜的电影.\n&quot;Alg. for Kids&quot; 不是电影.\n&quot;Database Sols&quot; 不是电影\n&quot;Alladin&quot; 是电影, 儿童适宜, 并且在 2020 年 6 月份播放.\n&quot;Cinderella&quot; 不在 2020 年 6 月份播放.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token keyword\">distinct</span> title   </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> TVProgram t <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Content c</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">on</span> t<span class=\"token punctuation\">.</span>content_id  <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>content_id </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">where</span>  Kids_content <span class=\"token operator\">=</span><span class=\"token string\">'Y'</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">and</span> date_format<span class=\"token punctuation\">(</span>program_date <span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token string\">'2020-06'</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">and</span> content_type<span class=\"token operator\">=</span><span class=\"token string\">'Movies'</span></pre></td></tr></table></figure><blockquote>\n<p>LEFT () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmVndHV0LmNvbS9zcWwvZnVuYy1teXNxbC1sZWZ0Lmh0bWw=\">https://www.begtut.com/sql/func-mysql-left.html</span><br />\nREGEXP 语法参见：<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vdGltc3NkL3AvNTg4Mjc0Mi5odG1s\">https://www.cnblogs.com/timssd/p/5882742.html</span><br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vemhhb3BhbnBhbi9wLzEwMTMzMjI0Lmh0bWw=\">https://www.cnblogs.com/zhaopanpan/p/10133224.html</span><br />\nDATE_FORMAT () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudzNzY2hvb2wuY29tLmNuL3NxbC9mdW5jX2RhdGVfZm9ybWF0LmFzcA==\">https://www.w3school.com.cn/sql/func_date_format.asp</span><br />\nEXTRACT () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS9zcWwvZnVuYy1leHRyYWN0Lmh0bWw=\">https://www.runoob.com/sql/func-extract.html</span><br />\nDATEDIFF () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS9zcWwvZnVuYy1kYXRlZGlmZi1teXNxbC5odG1s\">https://www.runoob.com/sql/func-datediff-mysql.html</span><br />\nYEAR () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vYWt1bi9hcnRpY2xlL2RldGFpbHMvODI1Mjg4Mjk=\">https://blog.csdn.net/moakun/article/details/82528829</span><br />\nMONTH () 函数参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueWlpYmFpLmNvbS9teXNxbC9tb250aC5odG1s\">https://www.yiibai.com/mysql/month.html</span></p>\n</blockquote>\n<h4 id=\"1501-可以放心投资的国家\"><a class=\"anchor\" href=\"#1501-可以放心投资的国家\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY291bnRyaWVzLXlvdS1jYW4tc2FmZWx5LWludmVzdC1pbi8=\">1501. 可以放心投资的国家</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>表  <code>Person</code> :</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| id             | int     |\n| name           | varchar |\n| phone_number   | varchar |\n+----------------+---------+\nid 是该表主键.\n该表每一行包含一个人的名字和电话号码.\n电话号码的格式是:'xxx-yyyyyyy', 其中xxx是国家码(3个字符), yyyyyyy是电话号码(7个字符), x和y都表示数字. 同时, 国家码和电话号码都可以包含前导0.\n</code></pre>\n<p>表  <code>Country</code> :</p>\n<pre><code>+----------------+---------+\n| Column Name    | Type    |\n+----------------+---------+\n| name           | varchar |\n| country_code   | varchar |\n+----------------+---------+\ncountry_code是该表主键.\n该表每一行包含国家名和国家码. country_code的格式是'xxx', x是数字.\n</code></pre>\n<p>表  <code>Calls</code> :</p>\n<pre><code>+-------------+------+\n| Column Name | Type |\n+-------------+------+\n| caller_id   | int  |\n| callee_id   | int  |\n| duration    | int  |\n+-------------+------+\n该表无主键, 可能包含重复行.\n每一行包含呼叫方id, 被呼叫方id和以分钟为单位的通话时长. caller_id != callee_id\n</code></pre>\n<p>一家电信公司想要投资新的国家。该公司想要投资的国家是：该国的平均通话时长要严格地大于全球平均通话时长.</p>\n<p>写一段 SQL, 找到所有该公司可以投资的国家.</p>\n<p>返回的结果表没有顺序要求.</p>\n<p>查询的结果格式如下例所示.</p>\n<pre><code>Person 表:\n+----+----------+--------------+\n| id | name     | phone_number |\n+----+----------+--------------+\n| 3  | Jonathan | 051-1234567  |\n| 12 | Elvis    | 051-7654321  |\n| 1  | Moncef   | 212-1234567  |\n| 2  | Maroua   | 212-6523651  |\n| 7  | Meir     | 972-1234567  |\n| 9  | Rachel   | 972-0011100  |\n+----+----------+--------------+\n\nCountry 表:\n+----------+--------------+\n| name     | country_code |\n+----------+--------------+\n| Peru     | 051          |\n| Israel   | 972          |\n| Morocco  | 212          |\n| Germany  | 049          |\n| Ethiopia | 251          |\n+----------+--------------+\n\nCalls 表:\n+-----------+-----------+----------+\n| caller_id | callee_id | duration |\n+-----------+-----------+----------+\n| 1         | 9         | 33       |\n| 2         | 9         | 4        |\n| 1         | 2         | 59       |\n| 3         | 12        | 102      |\n| 3         | 12        | 330      |\n| 12        | 3         | 5        |\n| 7         | 9         | 13       |\n| 7         | 1         | 3        |\n| 9         | 7         | 1        |\n| 1         | 7         | 7        |\n+-----------+-----------+----------+\n\nResult 表:\n+----------+\n| country  |\n+----------+\n| Peru     |\n+----------+\n国家Peru的平均通话时长是 (102 + 102 + 330 + 330 + 5 + 5) / 6 = 145.666667\n国家Israel的平均通话时长是 (33 + 4 + 13 + 13 + 3 + 1 + 1 + 7) / 8 = 9.37500\n国家Morocco的平均通话时长是 (33 + 4 + 59 + 59 + 3 + 7) / 6 = 27.5000 \n全球平均通话时长 = (2 * (33 + 3 + 59 + 102 + 330 + 5 + 13 + 3 + 1 + 7)) / 20 = 55.70000\n所以, Peru是唯一的平均通话时长大于全球平均通话时长的国家, 也是唯一的推荐投资的国家.\n</code></pre>\n<p>笛卡尔积</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> c2<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> country </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Calls c1<span class=\"token punctuation\">,</span>Person p<span class=\"token punctuation\">,</span>Country c2</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> <span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>c1<span class=\"token punctuation\">.</span>caller_id <span class=\"token operator\">or</span> p<span class=\"token punctuation\">.</span>id<span class=\"token operator\">=</span>c1<span class=\"token punctuation\">.</span>callee_id<span class=\"token punctuation\">)</span> <span class=\"token operator\">and</span> c2<span class=\"token punctuation\">.</span>country_code<span class=\"token operator\">=</span><span class=\"token keyword\">left</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>phone_number<span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> c2<span class=\"token punctuation\">.</span>name </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">having</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>duration<span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>duration<span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> Calls<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>思路更清晰</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">with</span> people_country <span class=\"token keyword\">as</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>name country</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">from</span> Person p <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Country c</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">on</span> <span class=\"token keyword\">left</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>phone_number<span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>country_code</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">select</span> country</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">select</span> country<span class=\"token punctuation\">,</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>duration<span class=\"token punctuation\">)</span> avgtime</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">select</span> caller_id id<span class=\"token punctuation\">,</span> duration</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">from</span> Calls</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">union</span> <span class=\"token keyword\">all</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">select</span> callee_id<span class=\"token punctuation\">,</span> duration</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">from</span> Calls</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">)</span> t <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> people_country</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">using</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> country</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">)</span> <span class=\"token keyword\">temp</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">where</span> avgtime <span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">select</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>duration<span class=\"token punctuation\">)</span> avgtime</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token keyword\">select</span> caller_id<span class=\"token punctuation\">,</span> duration</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">from</span> Calls</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">union</span> <span class=\"token keyword\">all</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">select</span> callee_id<span class=\"token punctuation\">,</span> duration</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token keyword\">from</span> Calls</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1511-消费者下单频率\"><a class=\"anchor\" href=\"#1511-消费者下单频率\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvY3VzdG9tZXItb3JkZXItZnJlcXVlbmN5Lw==\">1511. 消费者下单频率</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>表:  <code>Customers</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| customer_id   | int     |\n| name          | varchar |\n| country       | varchar |\n+---------------+---------+\ncustomer_id 是该表主键.\n该表包含公司消费者的信息.\n</code></pre>\n<p>表:  <code>Product</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| description   | varchar |\n| price         | int     |\n+---------------+---------+\nproduct_id 是该表主键.\n该表包含公司产品的信息.\nprice 是本产品的花销.\n</code></pre>\n<p>表:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| customer_id   | int     |\n| product_id    | int     |\n| order_date    | date    |\n| quantity      | int     |\n+---------------+---------+\norder_id 是该表主键.\n该表包含消费者下单的信息.\ncustomer_id 是买了数量为&quot;quantity&quot;, id为&quot;product_id&quot;产品的消费者的 id.\nOrder_date 是订单发货的日期, 格式为('YYYY-MM-DD').\n</code></pre>\n<p>写一个 SQL 语句，报告消费者的 id 和名字，其中消费者在 2020 年 6 月和 7 月，每月至少花费了 $100.</p>\n<p>结果表无顺序要求.</p>\n<p>查询结果格式如下例所示.</p>\n<pre><code>Customers\n+--------------+-----------+-------------+\n| customer_id  | name      | country     |\n+--------------+-----------+-------------+\n| 1            | Winston   | USA         |\n| 2            | Jonathan  | Peru        |\n| 3            | Moustafa  | Egypt       |\n+--------------+-----------+-------------+\n\nProduct\n+--------------+-------------+-------------+\n| product_id   | description | price       |\n+--------------+-------------+-------------+\n| 10           | LC Phone    | 300         |\n| 20           | LC T-Shirt  | 10          |\n| 30           | LC Book     | 45          |\n| 40           | LC Keychain | 2           |\n+--------------+-------------+-------------+\n\nOrders\n+--------------+-------------+-------------+-------------+-----------+\n| order_id     | customer_id | product_id  | order_date  | quantity  |\n+--------------+-------------+-------------+-------------+-----------+\n| 1            | 1           | 10          | 2020-06-10  | 1         |\n| 2            | 1           | 20          | 2020-07-01  | 1         |\n| 3            | 1           | 30          | 2020-07-08  | 2         |\n| 4            | 2           | 10          | 2020-06-15  | 2         |\n| 5            | 2           | 40          | 2020-07-01  | 10        |\n| 6            | 3           | 20          | 2020-06-24  | 2         |\n| 7            | 3           | 30          | 2020-06-25  | 2         |\n| 9            | 3           | 30          | 2020-05-08  | 3         |\n+--------------+-------------+-------------+-------------+-----------+\n\nResult 表:\n+--------------+------------+\n| customer_id  | name       |  \n+--------------+------------+\n| 1            | Winston    |\n+--------------+------------+ \nWinston 在2020年6月花费了$300(300 * 1), 在7月花费了$100(10 * 1 + 45 * 2).\nJonathan 在2020年6月花费了$600(300 * 2), 在7月花费了$20(2 * 10).\nMoustafa 在2020年6月花费了$110 (10 * 2 + 45 * 2), 在7月花费了$0.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> customer_id<span class=\"token punctuation\">,</span>name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Customers</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> customer_id <span class=\"token operator\">in</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> customer_id</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> customer_id<span class=\"token punctuation\">,</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">month</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>quantity<span class=\"token operator\">*</span>price<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">from</span> Orders o <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Product p <span class=\"token keyword\">on</span> o<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>product_id</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">where</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">6</span> <span class=\"token operator\">or</span> <span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token number\">7</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_id<span class=\"token punctuation\">,</span><span class=\"token keyword\">month</span><span class=\"token punctuation\">(</span>order_date<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> t1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">where</span> total <span class=\"token operator\">>=</span><span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> customer_id</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">having</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">>=</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"1517-find-users-with-valid-e-mails\"><a class=\"anchor\" href=\"#1517-find-users-with-valid-e-mails\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZmluZC11c2Vycy13aXRoLXZhbGlkLWUtbWFpbHMv\">1517. Find Users With Valid E-Mails</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Users</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| user_id       | int     |\n| name          | varchar |\n| mail          | varchar |\n+---------------+---------+\nuser_id is the primary key for this table.\nThis table contains information of the users signed up in a website. Some e-mails are invalid.\n</code></pre>\n<p>Write an SQL query to find the users who have <strong>valid emails</strong>.</p>\n<p>A valid e-mail has a prefix name and a domain where:</p>\n<ul>\n<li><strong>The prefix name</strong> is a string that may contain letters (upper or lower case), digits, underscore  <code>'_'</code> , period  <code>'.'</code>  and/or dash  <code>'-'</code> . The prefix name <strong>must</strong> start with a letter.</li>\n<li><strong>The domain</strong> is  <code>'@leetcode.com'</code> .</li>\n</ul>\n<p>Return the result table in any order.</p>\n<p>The query result format is in the following example.</p>\n<pre><code>Users\n+---------+-----------+-------------------------+\n| user_id | name      | mail                    |\n+---------+-----------+-------------------------+\n| 1       | Winston   | winston@leetcode.com    |\n| 2       | Jonathan  | jonathanisgreat         |\n| 3       | Annabelle | bella-@leetcode.com     |\n| 4       | Sally     | sally.come@leetcode.com |\n| 5       | Marwan    | quarz#2020@leetcode.com |\n| 6       | David     | david69@gmail.com       |\n| 7       | Shapiro   | .shapo@leetcode.com     |\n+---------+-----------+-------------------------+\n\nResult table:\n+---------+-----------+-------------------------+\n| user_id | name      | mail                    |\n+---------+-----------+-------------------------+\n| 1       | Winston   | winston@leetcode.com    |\n| 3       | Annabelle | bella-@leetcode.com     |\n| 4       | Sally     | sally.come@leetcode.com |\n+---------+-----------+-------------------------+\nThe mail of user 2 doesn't have a domain.\nThe mail of user 5 has # sign which is not allowed.\nThe mail of user 6 doesn't have leetcode domain.\nThe mail of user 7 starts with a period.\n</code></pre>\n<p>考察正则表达式的使用</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">FROM</span> Users</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">WHERE</span> mail <span class=\"token operator\">REGEXP</span> <span class=\"token string\">'^[a-zA-Z]+[\\\\w_\\\\.\\\\-]*@leetcode.com$'</span>   </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> user_id<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> Users</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">where</span> mail <span class=\"token operator\">regexp</span> <span class=\"token string\">'^[a-zA-Z]+[a-zA-Z0-9_\\\\./\\\\-]&#123;0,&#125;@leetcode.com$'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> user_id</pre></td></tr></table></figure><blockquote>\n<p>坑点：<br />\n1、前缀可能是一个字母，比如 “J@leetcode.com”，所以匹配非首字母外的前缀字符数量要用 {0,} 或 *，不能用 +。<br />\n2、题意要求：underscore '', period '.' and/or dash '-'，/ 没加单引号，不留神可能写漏 /。<br />\n3、后缀可能是 “@leetcodeecom”，所以要对 “.” 加转义符号。<br />\n4、后缀可能是 “@LEETCODE.COM”，默认是不区分大小写匹配，所以要加上 “BINARY” 区分大小写。<br />\n语法：<br />\n1、<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vdGltc3NkL3AvNTg4Mjc0Mi5odG1s\">https://www.cnblogs.com/timssd/p/5882742.html</span><br />\n2、<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vemhhb3BhbnBhbi9wLzEwMTMzMjI0Lmh0bWw=\">https://www.cnblogs.com/zhaopanpan/p/10133224.html</span><br />\n3、&quot;双反斜杠 + w&quot; 表示字母、数字、下划线，相对 &quot;a-zA-Z0-9&quot; 的写法更简洁。</p>\n</blockquote>\n<h4 id=\"1527-patients-with-a-condition\"><a class=\"anchor\" href=\"#1527-patients-with-a-condition\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvcGF0aWVudHMtd2l0aC1hLWNvbmRpdGlvbi8=\">1527. Patients With a Condition</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Patients</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| patient_id   | int     |\n| patient_name | varchar |\n| conditions   | varchar |\n+--------------+---------+\npatient_id is the primary key for this table.\n'conditions' contains 0 or more code separated by spaces. \nThis table contains information of the patients in the hospital.\n</code></pre>\n<p>Write an SQL query to report the patient_id, patient_name all conditions of patients who have Type I Diabetes. Type I Diabetes always starts with  <code>DIAB1</code>  prefix</p>\n<p>Return the result table in any order.</p>\n<p>The query result format is in the following example.</p>\n<pre><code>Patients\n+------------+--------------+--------------+\n| patient_id | patient_name | conditions   |\n+------------+--------------+--------------+\n| 1          | Daniel       | YFEV COUGH   |\n| 2          | Alice        |              |\n| 3          | Bob          | DIAB100 MYOP |\n| 4          | George       | ACNE DIAB100 |\n| 5          | Alain        | DIAB201      |\n+------------+--------------+--------------+\n\nResult table:\n+------------+--------------+--------------+\n| patient_id | patient_name | conditions   |\n+------------+--------------+--------------+\n| 3          | Bob          | DIAB100 MYOP |\n| 4          | George       | ACNE DIAB100 | \n+------------+--------------+--------------+\nBob and George both have a condition that starts with DIAB1.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span>  patient_id <span class=\"token punctuation\">,</span> patient_name <span class=\"token punctuation\">,</span>conditions </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> Patients</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">where</span> conditions <span class=\"token operator\">like</span> <span class=\"token string\">'%DIAB1%'</span></pre></td></tr></table></figure><h4 id=\"1532-the-most-recent-three-orders\"><a class=\"anchor\" href=\"#1532-the-most-recent-three-orders\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdGhlLW1vc3QtcmVjZW50LXRocmVlLW9yZGVycy8=\">1532. The Most Recent Three Orders</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Customers</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| customer_id   | int     |\n| name          | varchar |\n+---------------+---------+\ncustomer_id is the primary key for this table.\nThis table contains information about customers.\n</code></pre>\n<p>Table:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| order_date    | date    |\n| customer_id   | int     |\n| cost          | int     |\n+---------------+---------+\norder_id is the primary key for this table.\nThis table contains information about the orders made by customer_id.\nEach customer has one order per day.\n</code></pre>\n<p>Write an SQL query to find the most recent 3 orders of each user. If a user ordered less than 3 orders return all of their orders.</p>\n<p>Return the result table sorted by  <code>customer_name</code>  in <strong>ascending</strong> order and in case of a tie by the  <code>customer_id</code>  in <strong>ascending</strong> order. If there still a tie, order them by the  <code>order_date</code>  in <strong>descending</strong> order.</p>\n<p>The query result format is in the following example:</p>\n<pre><code>Customers\n+-------------+-----------+\n| customer_id | name      |\n+-------------+-----------+\n| 1           | Winston   |\n| 2           | Jonathan  |\n| 3           | Annabelle |\n| 4           | Marwan    |\n| 5           | Khaled    |\n+-------------+-----------+\n\nOrders\n+----------+------------+-------------+------+\n| order_id | order_date | customer_id | cost |\n+----------+------------+-------------+------+\n| 1        | 2020-07-31 | 1           | 30   |\n| 2        | 2020-07-30 | 2           | 40   |\n| 3        | 2020-07-31 | 3           | 70   |\n| 4        | 2020-07-29 | 4           | 100  |\n| 5        | 2020-06-10 | 1           | 1010 |\n| 6        | 2020-08-01 | 2           | 102  |\n| 7        | 2020-08-01 | 3           | 111  |\n| 8        | 2020-08-03 | 1           | 99   |\n| 9        | 2020-08-07 | 2           | 32   |\n| 10       | 2020-07-15 | 1           | 2    |\n+----------+------------+-------------+------+\n\nResult table:\n+---------------+-------------+----------+------------+\n| customer_name | customer_id | order_id | order_date |\n+---------------+-------------+----------+------------+\n| Annabelle     | 3           | 7        | 2020-08-01 |\n| Annabelle     | 3           | 3        | 2020-07-31 |\n| Jonathan      | 2           | 9        | 2020-08-07 |\n| Jonathan      | 2           | 6        | 2020-08-01 |\n| Jonathan      | 2           | 2        | 2020-07-30 |\n| Marwan        | 4           | 4        | 2020-07-29 |\n| Winston       | 1           | 8        | 2020-08-03 |\n| Winston       | 1           | 1        | 2020-07-31 |\n| Winston       | 1           | 10       | 2020-07-15 |\n+---------------+-------------+----------+------------+\nWinston has 4 orders, we discard the order of &quot;2020-06-10&quot; because it is the oldest order.\nAnnabelle has only 2 orders, we return them.\nJonathan has exactly 3 orders.\nMarwan ordered only one time.\nWe sort the result table by customer_name in ascending order, by customer_id in ascending order and by order_date in descending order in case of a tie.\n</code></pre>\n<p><strong>Follow-up:</strong><br />\nCan you write a general solution for the most recent  <code>n</code>  orders?</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> name customer_name <span class=\"token punctuation\">,</span>customer_id<span class=\"token punctuation\">,</span>order_id<span class=\"token punctuation\">,</span>order_date</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span>  name <span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">.</span>customer_id<span class=\"token punctuation\">,</span>order_id<span class=\"token punctuation\">,</span>order_date <span class=\"token punctuation\">,</span>rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> o<span class=\"token punctuation\">.</span>customer_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> order_date <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Orders o <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Customers c</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">on</span> o<span class=\"token punctuation\">.</span>customer_id<span class=\"token operator\">=</span>c<span class=\"token punctuation\">.</span>customer_id</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">&lt;=</span><span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> customer_name <span class=\"token punctuation\">,</span>customer_id<span class=\"token punctuation\">,</span>order_date <span class=\"token keyword\">desc</span></pre></td></tr></table></figure><h4 id=\"1543-fix-product-name-format\"><a class=\"anchor\" href=\"#1543-fix-product-name-format\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvZml4LXByb2R1Y3QtbmFtZS1mb3JtYXQv\">1543. Fix Product Name Format</span></h4>\n<p>难度简单</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Sales</code></p>\n<pre><code>+--------------+---------+\n| Column Name  | Type    |\n+--------------+---------+\n| sale_id      | int     |\n| product_name | varchar |\n| sale_date    | date    |\n+--------------+---------+\nsale_id is the primary key for this table.\nEach row of this table contains the product name and the date it was sold.\n</code></pre>\n<p>Since table Sales was filled manually in the year 2000,  <code>product_name</code>  may contain leading and/or trailing white spaces, also they are case-insensitive.</p>\n<p>Write an SQL query to report</p>\n<ul>\n<li><code>product_name</code>  in lowercase without leading or trailing white spaces.</li>\n<li><code>sale_date</code>  in the format  <code>('YYYY-MM')</code></li>\n<li><code>total</code>  the number of times the product was sold in this month.</li>\n</ul>\n<p>Return the result table ordered by  <code>product_name</code>  in <strong>ascending order</strong>, in case of a tie order it by  <code>sale_date</code>  in <strong>ascending order</strong>.</p>\n<p>The query result format is in the following example.</p>\n<pre><code>Sales\n+------------+------------------+--------------+\n| sale_id    | product_name     | sale_date    |\n+------------+------------------+--------------+\n| 1          |      LCPHONE     | 2000-01-16   |\n| 2          |    LCPhone       | 2000-01-17   |\n| 3          |     LcPhOnE      | 2000-02-18   |\n| 4          |      LCKeyCHAiN  | 2000-02-19   |\n| 5          |   LCKeyChain     | 2000-02-28   |\n| 6          | Matryoshka       | 2000-03-31   | \n+------------+------------------+--------------+\n\nResult table:\n+--------------+--------------+----------+\n| product_name | sale_date    | total    |\n+--------------+--------------+----------+\n| lcphone      | 2000-01      | 2        |\n| lckeychain   | 2000-02      | 2        | \n| lcphone      | 2000-02      | 1        | \n| matryoshka   | 2000-03      | 1        | \n+--------------+--------------+----------+\n\nIn January, 2 LcPhones were sold, please note that the product names are not case sensitive and may contain spaces.\nIn Februery, 2 LCKeychains and 1 LCPhone were sold.\nIn March, 1 matryoshka was sold.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> trim<span class=\"token punctuation\">(</span>lower<span class=\"token punctuation\">(</span>product_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> product_name<span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        date_format<span class=\"token punctuation\">(</span>sale_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> sale_date<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> total </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> Sales </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> trim<span class=\"token punctuation\">(</span>lower<span class=\"token punctuation\">(</span>product_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> date_format<span class=\"token punctuation\">(</span>sale_date<span class=\"token punctuation\">,</span><span class=\"token string\">'%Y-%m'</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> product_name <span class=\"token keyword\">asc</span><span class=\"token punctuation\">,</span> sale_date <span class=\"token keyword\">asc</span></pre></td></tr></table></figure><blockquote>\n<p>注意大小写、空格</p>\n</blockquote>\n<h4 id=\"1549-the-most-recent-orders-for-each-product\"><a class=\"anchor\" href=\"#1549-the-most-recent-orders-for-each-product\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZWV0Y29kZS1jbi5jb20vcHJvYmxlbXMvdGhlLW1vc3QtcmVjZW50LW9yZGVycy1mb3ItZWFjaC1wcm9kdWN0Lw==\">1549. The Most Recent Orders for Each Product</span></h4>\n<p>难度中等</p>\n<p>SQL 架构</p>\n<p>Table:  <code>Customers</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| customer_id   | int     |\n| name          | varchar |\n+---------------+---------+\ncustomer_id is the primary key for this table.\nThis table contains information about the customers.\n</code></pre>\n<p>Table:  <code>Orders</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| order_id      | int     |\n| order_date    | date    |\n| customer_id   | int     |\n| product_id    | int     |\n+---------------+---------+\norder_id is the primary key for this table.\nThis table contains information about the orders made by customer_id.\nThere will be no product ordered by the same user more than once in one day.\n</code></pre>\n<p>Table:  <code>Products</code></p>\n<pre><code>+---------------+---------+\n| Column Name   | Type    |\n+---------------+---------+\n| product_id    | int     |\n| product_name  | varchar |\n| price         | int     |\n+---------------+---------+\nproduct_id is the primary key for this table.\nThis table contains information about the Products.\n</code></pre>\n<p>Write an SQL query to find the most recent order(s) of each product.</p>\n<p>Return the result table sorted by  <code>product_name</code>  in <strong>ascending</strong> order and in case of a tie by the  <code>product_id</code>  in <strong>ascending</strong> order. If there still a tie, order them by the  <code>order_id</code>  in <strong>ascending</strong> order.</p>\n<p>The query result format is in the following example:</p>\n<pre><code>Customers\n+-------------+-----------+\n| customer_id | name      |\n+-------------+-----------+\n| 1           | Winston   |\n| 2           | Jonathan  |\n| 3           | Annabelle |\n| 4           | Marwan    |\n| 5           | Khaled    |\n+-------------+-----------+\n\nOrders\n+----------+------------+-------------+------------+\n| order_id | order_date | customer_id | product_id |\n+----------+------------+-------------+------------+\n| 1        | 2020-07-31 | 1           | 1          |\n| 2        | 2020-07-30 | 2           | 2          |\n| 3        | 2020-08-29 | 3           | 3          |\n| 4        | 2020-07-29 | 4           | 1          |\n| 5        | 2020-06-10 | 1           | 2          |\n| 6        | 2020-08-01 | 2           | 1          |\n| 7        | 2020-08-01 | 3           | 1          |\n| 8        | 2020-08-03 | 1           | 2          |\n| 9        | 2020-08-07 | 2           | 3          |\n| 10       | 2020-07-15 | 1           | 2          |\n+----------+------------+-------------+------------+\n\nProducts\n+------------+--------------+-------+\n| product_id | product_name | price |\n+------------+--------------+-------+\n| 1          | keyboard     | 120   |\n| 2          | mouse        | 80    |\n| 3          | screen       | 600   |\n| 4          | hard disk    | 450   |\n+------------+--------------+-------+\n\nResult table:\n+--------------+------------+----------+------------+\n| product_name | product_id | order_id | order_date |\n+--------------+------------+----------+------------+\n| keyboard     | 1          | 6        | 2020-08-01 |\n| keyboard     | 1          | 7        | 2020-08-01 |\n| mouse        | 2          | 8        | 2020-08-03 |\n| screen       | 3          | 3        | 2020-08-29 |\n+--------------+------------+----------+------------+\nkeyboard's most recent order is in 2020-08-01, it was ordered two times this day.\nmouse's most recent order is in 2020-08-03, it was ordered only once this day.\nscreen's most recent order is in 2020-08-29, it was ordered only once this day.\nThe hard disk was never ordered and we don't include it in the result table.\n</code></pre>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> product_name<span class=\"token punctuation\">,</span>product_id<span class=\"token punctuation\">,</span>order_id<span class=\"token punctuation\">,</span>order_date</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">select</span> product_name <span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">.</span>product_id <span class=\"token punctuation\">,</span>order_id<span class=\"token punctuation\">,</span>order_date <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> o<span class=\"token punctuation\">.</span>product_id <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> order_date <span class=\"token keyword\">desc</span><span class=\"token punctuation\">)</span> rk</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> Orders o <span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> Products p</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">on</span> o<span class=\"token punctuation\">.</span>product_id <span class=\"token operator\">=</span>p<span class=\"token punctuation\">.</span>product_id </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span>t1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">where</span> rk <span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> product_name<span class=\"token punctuation\">,</span>product_id<span class=\"token punctuation\">,</span>order_id</pre></td></tr></table></figure>",
            "tags": [
                "大数据",
                "Hive"
            ]
        },
        {
            "id": "https://github.com/Mayizono/miyazono.github.io/bigdata/hive/Hive%20%E5%AD%A6%E4%B9%A0/",
            "url": "https://github.com/Mayizono/miyazono.github.io/bigdata/hive/Hive%20%E5%AD%A6%E4%B9%A0/",
            "title": "Hive学习",
            "date_published": "2019-10-10T16:00:00.000Z",
            "content_html": "<h1 id=\"hive-学习\"><a class=\"anchor\" href=\"#hive-学习\">#</a> Hive 学习</h1>\n<hr />\n<h3 id=\"01-什么是hive\"><a class=\"anchor\" href=\"#01-什么是hive\">#</a> 0.1 什么是 hive</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> Hive：由Facebook开源用于解决<span class=\"token string\">'海量结构化日志'</span>的数据统计<span class=\"token string\">'工具'</span>。</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2.</span> Hive是基于Hadoop的一个<span class=\"token string\">'数据仓库工具'</span>，可以将结构化的数据文件<span class=\"token string\">'映射'</span>为一张表，并提供类<span class=\"token keyword\">SQL</span>查询功能。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">3.</span> <span class=\"token string\">'本质'</span>：将HQL转化成MapReduce程序</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">4.</span> <span class=\"token string\">'原理介绍'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   \t（<span class=\"token number\">1</span>）Hive处理的数据存储在HDFS</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    （<span class=\"token number\">2</span>）Hive分析数据底层的实现是MapReduce</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    （<span class=\"token number\">3</span>）执行程序运行在Yarn上</pre></td></tr></table></figure><h3 id=\"02-优缺点\"><a class=\"anchor\" href=\"#02-优缺点\">#</a> 0.2 优缺点</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 1. 优点：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token number\">1.</span> 操作接口采用类<span class=\"token keyword\">SQL</span>语法，提供快速开发的能力（简单、容易上手）。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token number\">2.</span> 避免了去写MapReduce，减少开发人员的学习成本。</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token number\">3.</span> Hive的执行延迟比较高，因此Hive常用于数据分析，对实时性要求不高的场合。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token number\">4.</span> Hive优势在于处理大数据，对于处理小数据没有优势，因为Hive的执行延迟比较高。</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token number\">5.</span> Hive支持用户自定义函数，用户可以根据自己的需求来实现自己的函数。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">-- 2. 缺点</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token number\">1.</span> Hive的HQL表达能力有限</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token number\">2.</span> 迭代式算法无法表达</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token number\">3.</span> 数据挖掘方面不擅长，由于MapReduce数据处理流程的限制，效率更高的算法却无法实现。</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token number\">4.</span> Hive的效率比较低</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    （<span class=\"token number\">1</span>）Hive自动生成的MapReduce作业，通常情况下不够智能化</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    （<span class=\"token number\">2</span>）Hive调优比较困难，粒度较粗</pre></td></tr></table></figure><h3 id=\"03-hive架构原理\"><a class=\"anchor\" href=\"#03-hive架构原理\">#</a> 0.3 Hive 架构原理</h3>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20200720000427.png\" alt=\"image\" /></p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 1. 用户接口：Client</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tCLI（command<span class=\"token operator\">-</span>line interface）、JDBC<span class=\"token operator\">/</span>ODBC<span class=\"token punctuation\">(</span>jdbc访问hive<span class=\"token punctuation\">)</span>、WEBUI（浏览器访问hive）</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 2. 元数据：Metastore</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t元数据包括：</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t   a、表名</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t   b、表所属的数据库（默认是<span class=\"token keyword\">default</span>）</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t   c、表的拥有者</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t   d、列<span class=\"token operator\">/</span>分区字段</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t   e、表的类型（是否是外部表）、</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t   f、表的数据所在目录等；</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token string\">'默认存储在自带的derby数据库中，推荐使用MySQL存储Metastore'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">-- 3. Hadoop</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t使用HDFS进行存储，使用MapReduce进行计算。</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">-- 4. 驱动器：Driver</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token number\">1.</span> <span class=\"token string\">'解析器'</span>（<span class=\"token keyword\">SQL</span> Parser）：将<span class=\"token keyword\">SQL</span>字符串转换成抽象语法树AST，这一步一般都用第三方工具库完成，</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t   比如antlr；对AST进行语法分析，比如表是否存在、字段是否存在、<span class=\"token keyword\">SQL</span>语义是否有误。</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token number\">2.</span> <span class=\"token string\">'编译器'</span>（Physical <span class=\"token keyword\">Plan</span>）：将AST编译生成逻辑执行计划。</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token number\">3.</span> <span class=\"token string\">'优化器'</span>（Query Optimizer）：对逻辑执行计划进行优化。</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token number\">4.</span> <span class=\"token string\">'执行器'</span>（Execution）：把逻辑执行计划转换成可以运行的物理计划。对于Hive来说，就是MR<span class=\"token operator\">/</span>Spark。</pre></td></tr></table></figure><h3 id=\"04-hive与数据库的比较\"><a class=\"anchor\" href=\"#04-hive与数据库的比较\">#</a> 0.4 hive 与数据库的比较</h3>\n<blockquote>\n<p>由于 Hive 采用了类似 SQL 的查询语言 HQL (Hive Query Language)，因此很容易将 Hive 理解为数据库。其实从结构上来看，Hive 和数据库除了拥有类似的查询语言，再无类似之处</p>\n</blockquote>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 1. 查询语言</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    hive有类似<span class=\"token keyword\">sql</span>的hql查询语言</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 2. 数据更新</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token number\">1.</span> hive针对数据仓库而设计，适合读多写少的场景</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token number\">2.</span> mysql的数据需要经常进行修改。</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">-- 3.  执行延迟</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token number\">1.</span> hive没有索引 <span class=\"token operator\">+</span> 基于mr计算，延迟性高；</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token number\">2.</span> 这个低是有条件的，即数据规模较小，当数据规模大到超过数据库的处理能力的时候，Hive的并行计算显然能体现出优势</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">-- 4. 数据规模</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token number\">1.</span> 支持大数据规模的数据</pre></td></tr></table></figure><h3 id=\"05-tez引擎\"><a class=\"anchor\" href=\"#05-tez引擎\">#</a> 0.5 tez 引擎</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> <span class=\"token string\">'mr引擎'</span>：每个任务及任务之间都需要落盘</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2.</span> <span class=\"token string\">'Tez引擎'</span>：可以将多个有依赖的作业转换为一个作业，这样只需写一次HDFS，且中间节点较少，从而大大提升作业的计算性能。</pre></td></tr></table></figure><p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20200720001522.png\" alt=\"image\" /></p>\n<h2 id=\"一-hivejdbc客户端基本操作\"><a class=\"anchor\" href=\"#一-hivejdbc客户端基本操作\">#</a> 一、HiveJDBC 客户端基本操作</h2>\n<h3 id=\"11-hviejdbc的登入与退出\"><a class=\"anchor\" href=\"#11-hviejdbc的登入与退出\">#</a> 1.1 HvieJDBC 的登入与退出</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 方式一：使用 beeline 方式</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>访问方式：beeline <span class=\"token operator\">-</span>u jdbc:hive2:<span class=\"token comment\">//hadoop102:10000 -n lianzp</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>退出方式：！quit  、<span class=\"token operator\">!</span><span class=\"token keyword\">exit</span> 、 ctrl <span class=\"token operator\">+</span> c</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>前提：mysql服务和hiveservice2服务一定要启动</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">-- 方式二： 使用 hive 的方式</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>访问方式：hive</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>退出方式：quit； <span class=\"token keyword\">exit</span>；</pre></td></tr></table></figure><h3 id=\"12-hive常用的交互命令\"><a class=\"anchor\" href=\"#12-hive常用的交互命令\">#</a> 1.2 Hive 常用的交互命令</h3>\n<blockquote>\n<ul>\n<li>\n<p>“-e” 不进入 hive 的交互窗口执行 sql 语句 **</p>\n</li>\n<li>\n<p>“-f” 执行脚本中 sql 语句 **</p>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"13-hive数据类型\"><a class=\"anchor\" href=\"#13-hive数据类型\">#</a> 1.3 Hive 数据类型</h3>\n<ul>\n<li>基本数据类型</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Hive 数据类型</th>\n<th>Java 数据类型</th>\n<th>长度</th>\n<th>例子</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>TINYINT</td>\n<td>byte</td>\n<td>1byte 有符号整数</td>\n<td>20</td>\n</tr>\n<tr>\n<td>SMALINT</td>\n<td>short</td>\n<td>2byte 有符号整数</td>\n<td>20</td>\n</tr>\n<tr>\n<td>INT</td>\n<td>int</td>\n<td>4byte 有符号整数</td>\n<td>20</td>\n</tr>\n<tr>\n<td>BIGINT</td>\n<td>long</td>\n<td>8byte 有符号整数</td>\n<td>20</td>\n</tr>\n<tr>\n<td>BOOLEAN</td>\n<td>boolean</td>\n<td>布尔类型，true 或者 false</td>\n<td>TRUE  FALSE</td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>float</td>\n<td>单精度浮点数</td>\n<td>3.14159</td>\n</tr>\n<tr>\n<td>DOUBLE</td>\n<td>double</td>\n<td>双精度浮点数</td>\n<td>3.14159</td>\n</tr>\n<tr>\n<td>STRING</td>\n<td>string</td>\n<td>字符系列。可以指定字符集。可以使用单引号或者双引号。</td>\n<td>‘now is the time’ “for all good men”</td>\n</tr>\n<tr>\n<td>TIMESTAMP</td>\n<td></td>\n<td>时间类型</td>\n<td></td>\n</tr>\n<tr>\n<td>BINARY</td>\n<td></td>\n<td>字节数组</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<ul>\n<li>\n<p>重点关注：int，string，double,bigint ；</p>\n</li>\n<li>\n<p>使用注意事项：在 sql 中需要指定字段的长度，而在 hive 中不需要，可以理解为可变参数 ；</p>\n</li>\n<li>\n<p>数据类型的字节数：</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">byte</th>\n<th style=\"text-align:center\">short</th>\n<th style=\"text-align:center\">int</th>\n<th style=\"text-align:center\">long</th>\n<th>float</th>\n<th style=\"text-align:center\">double</th>\n<th style=\"text-align:center\">char</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">1</td>\n<td style=\"text-align:center\">2</td>\n<td style=\"text-align:center\">4</td>\n<td style=\"text-align:center\">8</td>\n<td>4</td>\n<td style=\"text-align:center\">8</td>\n<td style=\"text-align:center\">2</td>\n</tr>\n</tbody>\n</table>\n<p>其中 float 的取值范围比 long 还要大。</p>\n</blockquote>\n<ul>\n<li>\n<p>集合数据类型</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">数据类型</th>\n<th style=\"text-align:left\">描述</th>\n<th>语法示例</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">STRUCT</td>\n<td style=\"text-align:left\">和 c 语言中的 struct 类似，都可以通过 “点” 符号访问元素内容。例如，如果某个列的数据类型是 STRUCT {first STRING, last STRING}, 那么第 1 个元素可以通过字段.first 来引用。</td>\n<td>struct () 例如 struct&lt;street:string, city:string&gt;</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">MAP</td>\n<td style=\"text-align:left\">MAP 是一组键 - 值对元组集合，使用数组表示法可以访问数据。例如，如果某个列的数据类型是 MAP，其中键值对是’first’-&gt;’John’和’last’-&gt;’Doe’，那么可以通过字段名 [‘last’] 获取最后一个元素</td>\n<td>map () 例如 map&lt;string, int&gt;</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">ARRAY</td>\n<td style=\"text-align:left\">数组是一组具有相同类型和名称的变量的集合。这些变量称为数组的元素，每个数组元素都有一个编号，编号从零开始。例如，数组值为 [‘John’, ‘Doe’]，那么第 2 个元素可以通过数组名 [1] 进行引用。</td>\n<td>Array () 例如 array&lt;string&gt;</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ul>\n<p>创建表的实例:</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> test<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name string<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>friends array<span class=\"token operator\">&lt;</span>string<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">/*-- 数组的格式 --*/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>children map<span class=\"token operator\">&lt;</span>string<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token comment\">/*-- 集合的格式 --*/</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>address struct<span class=\"token operator\">&lt;</span>street:string<span class=\"token punctuation\">,</span> city:string<span class=\"token operator\">></span><span class=\"token comment\">/* --Struct 格式 -- */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">','</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">/*  行 格式      划分属性    以‘，’分割  ，统称为列分割符 */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>collection items <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'_'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">/* 集合（数组，集合，Struct） 多个元素之间以‘_’ 分割，则要求所有的数据的格式均是一样的 */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>map <span class=\"token keyword\">keys</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">':'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">/* 指明集合中 key 和 value 以‘：’ 进行分割 */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">lines</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\n'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">/* 行数据，以换行符进行分割 */</span></pre></td></tr></table></figure><p>获取集合中属性的方式：</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">*</span> \t数组：使用索引的方式：字段名<span class=\"token punctuation\">[</span><span class=\"token keyword\">index</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">*</span>\t集合：使用<span class=\"token keyword\">key</span>的值获取：字段名<span class=\"token punctuation\">[</span><span class=\"token keyword\">key</span>的值<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">*</span>\tStruct：使用：字段<span class=\"token punctuation\">.</span>属性值</pre></td></tr></table></figure><h3 id=\"14-类型转化\"><a class=\"anchor\" href=\"#14-类型转化\">#</a> 1.4 类型转化</h3>\n<ol>\n<li>\n<p>隐式类型转换规则</p>\n<ul>\n<li>\n<p>任何整数类型都可以隐式地转换为一个范围更广的类型，如 TINYINT 可以转换成 INT，INT 可以转换成 BIGINT；</p>\n</li>\n<li>\n<p>所有整数类型、FLOAT 和<strong> STRING</strong> 类型都可以隐式地转换成 DOUBLE；</p>\n</li>\n<li>\n<p>TINYINT、SMALLINT、INT 都可以转换为 FLOAT；</p>\n</li>\n<li>\n<p>BOOLEAN 类型不可以转换为任何其它的类型。</p>\n</li>\n</ul>\n</li>\n<li>\n<p><strong>CAST 操作显示进行数据类型转换</strong></p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> cast <span class=\"token punctuation\">(</span><span class=\"token string\">'1'</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">3</span>  <span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* 4 */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token string\">'1'</span> <span class=\"token operator\">+</span> <span class=\"token number\">3</span> <span class=\"token punctuation\">;</span> <span class=\"token comment\">/* 4.0 */</span></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"二-ddl数据定义\"><a class=\"anchor\" href=\"#二-ddl数据定义\">#</a> 二、DDL 数据定义</h2>\n<h3 id=\"21-数据库操作\"><a class=\"anchor\" href=\"#21-数据库操作\">#</a> 2.1 数据库操作</h3>\n<h4 id=\"211显示和查询数据库与表信息\"><a class=\"anchor\" href=\"#211显示和查询数据库与表信息\">#</a> 2.1.1 显示和查询数据库与表信息</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span>显示数据库</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">show</span> <span class=\"token keyword\">databases</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2.</span>切换数据库</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">use</span> 数据库名；</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">3.</span>查询数据库详细信息</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">desc</span> <span class=\"token keyword\">database</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">extended</span><span class=\"token punctuation\">]</span> 数据库名</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">4.</span>查询表的详细信息</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">desc</span> <span class=\"token punctuation\">[</span>formatted<span class=\"token punctuation\">]</span> 表名</pre></td></tr></table></figure><h4 id=\"212-创建数据库\"><a class=\"anchor\" href=\"#212-创建数据库\">#</a> 2.1.2 创建数据库</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">DATABASE</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span><span class=\"token punctuation\">]</span> database_name</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token keyword\">COMMENT</span> database_comment<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>LOCATION hdfs_path<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token keyword\">WITH</span> DBPROPERTIES <span class=\"token punctuation\">(</span>property_name<span class=\"token operator\">=</span>property_value<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>实例：</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span><span class=\"token keyword\">create</span> <span class=\"token keyword\">database</span> db_hive<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2.</span><span class=\"token keyword\">create</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> db_hive<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">/* 加上 if not exists 后，当该数据库已存在时，不抛异常，也不做创建数据库的操作 */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">3.</span><span class=\"token keyword\">create</span> <span class=\"token keyword\">database</span> db_hive2 location <span class=\"token string\">'/db_hive2.db'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">/* 指定数据创建时，在 hdfs 上的路径，如果没有此操作，则默认的路径为：/user/hive/warehouse/ 数据库名 */</span></pre></td></tr></table></figure><h4 id=\"213-删除数据库\"><a class=\"anchor\" href=\"#213-删除数据库\">#</a> 2.1.3 删除数据库</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span>删除空的数据库（何为空的数据库？指该数据中没有表）</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">drop</span> <span class=\"token keyword\">database</span> db_hive2 <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2.</span>当数据库不存在时，避免抛异常</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">drop</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> db_hive2 <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">3.</span>当数据库不为空时，加上<span class=\"token keyword\">cascade</span>进行删除</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">drop</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> db_hive2  <span class=\"token keyword\">cascade</span> <span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"22-表的操作\"><a class=\"anchor\" href=\"#22-表的操作\">#</a> 2.2 表的操作</h3>\n<h4 id=\"221-建表语法\"><a class=\"anchor\" href=\"#221-建表语法\">#</a> 2.2.1 建表语法</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">CREATE</span> <span class=\"token punctuation\">[</span>EXTERNAL<span class=\"token punctuation\">]</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span><span class=\"token punctuation\">]</span> table_name </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>col_name data_type <span class=\"token punctuation\">[</span><span class=\"token keyword\">COMMENT</span> col_comment<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token keyword\">COMMENT</span> table_comment<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>PARTITIONED <span class=\"token keyword\">BY</span> <span class=\"token punctuation\">(</span>col_name data_type <span class=\"token punctuation\">[</span><span class=\"token keyword\">COMMENT</span> col_comment<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token keyword\">CLUSTERED</span> <span class=\"token keyword\">BY</span> <span class=\"token punctuation\">(</span>col_name<span class=\"token punctuation\">,</span> col_name<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>SORTED <span class=\"token keyword\">BY</span> <span class=\"token punctuation\">(</span>col_name <span class=\"token punctuation\">[</span><span class=\"token keyword\">ASC</span><span class=\"token operator\">|</span><span class=\"token keyword\">DESC</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">INTO</span> num_buckets BUCKETS<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token keyword\">ROW</span> FORMAT row_format<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>STORED <span class=\"token keyword\">AS</span> file_format<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>LOCATION hdfs_path<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>TBLPROPERTIES <span class=\"token punctuation\">(</span>property_name<span class=\"token operator\">=</span>property_value<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token keyword\">AS</span> select_statement<span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>各个参数说明：</p>\n<ol>\n<li>\n<p>EXTERNAL ：表示外部表，在删除表时，只会删除 mysql 中的元数据，在 hdfs 的真实数据不会被删除，如果没 EXTERNAL ，则删除表的时候，元数据和真实数据均为被删除。</p>\n</li>\n<li>\n<p>IF NOT EXISTS ：当表存在时，添加此操作，则不会抛异常，同时也不会执行建表操作。</p>\n</li>\n<li>\n<p>COMMENT  ：字段或表的注释；</p>\n</li>\n<li>\n<p>PARTITIONED BY ： 分区 ** <code>（后面详细讲）</code> **；</p>\n</li>\n<li>\n<p>CLUSTERED BY ： 分桶 **（后面详细讲）**；</p>\n</li>\n<li>\n<p>SORTED BY ：文件在 hdfs 的存储格式 ，存储的方式有：SEQUENCEFILE（二进制序列文件）、TEXTFILE（文本）、RCFILE（列式存储格式文件）</p>\n<p>如果文件数据是纯文本，可以使用 STORED AS TEXTFILE。如果数据需要压缩，使用 STORED AS SEQUENCEFILE；</p>\n</li>\n<li>\n<p>ROW FORMAT row_format ：列分割符；</p>\n</li>\n<li>\n<p>LOCATION hdfs_path：指定表在 HDFS 上的存储位置；默认为当前库下。</p>\n</li>\n<li>\n<p>AS select_statement ：建表时进行加载数据，通过 as 后面的查询语句。</p>\n</li>\n</ol>\n<h4 id=\"222-管理表与外部表\"><a class=\"anchor\" href=\"#222-管理表与外部表\">#</a> 2.2.2 管理表与外部表</h4>\n<p>区别：</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span>管理表：也称内部表，当删除管理表时，hdfs中的数据和mysql中的元数据均会被删除 <span class=\"token comment\">-- 控制表的生命周期</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2.</span>外部表：当删除管理表时，hdfs中的数据不会被删除，mysql中的元数据会被删除  <span class=\"token comment\">-- 不能控制表的生命周期</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>在实战过程中，我们一般都是使用外部表。</pre></td></tr></table></figure><p>内外部表的定义、查看和转换</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span>定义：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>创建表单时，加上 external 关键字则表示为外部表。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2.</span>查看：</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>通过 <span class=\"token keyword\">desc</span> formatted 表名 。</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">3.</span>转换：</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 表名 <span class=\"token keyword\">set</span> tblproperties<span class=\"token punctuation\">(</span><span class=\"token string\">'EXTERNAL'</span><span class=\"token operator\">=</span><span class=\"token string\">'TRUE'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>注意事项：</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>a、<span class=\"token boolean\">TRUE</span> :   转换为外部表；</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>b、<span class=\"token boolean\">FALSE</span> ： 转换为内部表<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>c、<span class=\"token punctuation\">(</span><span class=\"token string\">'EXTERNAL'</span><span class=\"token operator\">=</span><span class=\"token string\">'TRUE'</span><span class=\"token punctuation\">)</span>和<span class=\"token punctuation\">(</span><span class=\"token string\">'EXTERNAL'</span><span class=\"token operator\">=</span><span class=\"token string\">'FALSE'</span><span class=\"token punctuation\">)</span>为固定写法，均需要大写！</pre></td></tr></table></figure><h4 id=\"223-修改表\"><a class=\"anchor\" href=\"#223-修改表\">#</a> 2.2.3 修改表</h4>\n<ol>\n<li>重命名表</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 旧表名 <span class=\"token keyword\">rename</span> <span class=\"token keyword\">to</span> 新表名 ；</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> dept_partition2 <span class=\"token keyword\">rename</span> <span class=\"token keyword\">to</span> dept_partition3<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>更新列</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 表名 change 旧列名 新列名 数据类型  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> emp change ename naem string <span class=\"token keyword\">first</span> deptno<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>增加列</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 表名 <span class=\"token keyword\">add</span> 列名 数据类型 <span class=\"token punctuation\">[</span>字段注释<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">first</span> <span class=\"token operator\">/</span> <span class=\"token keyword\">after</span>  列名<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> emp <span class=\"token keyword\">add</span> loc string <span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"4\">\n<li>删除表</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">drop</span> <span class=\"token keyword\">table</span> 表名</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">drop</span> <span class=\"token keyword\">table</span> emp <span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"三-dml-操作\"><a class=\"anchor\" href=\"#三-dml-操作\">#</a> 三、DML 操作</h2>\n<p><strong>注意事项：</strong></p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>当导入数据时，如果加载本地的文件，并是将数据加载到有分区和分桶表的hive表中时，因为此导入数据的过程会跑mr程序，该本地文件需要在所有节点都需要，不然会报文件不存在异常。</pre></td></tr></table></figure><h3 id=\"31-数据的导入\"><a class=\"anchor\" href=\"#31-数据的导入\">#</a> 3.1 数据的导入</h3>\n<h4 id=\"311-方式一\"><a class=\"anchor\" href=\"#311-方式一\">#</a> 3.1.1 方式一</h4>\n<ul>\n<li>使用 load</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">load</span> <span class=\"token keyword\">data</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">]</span> inpath <span class=\"token string\">'数据的路径'</span>  <span class=\"token punctuation\">[</span>overwrite<span class=\"token punctuation\">]</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">table</span> 表名 <span class=\"token punctuation\">[</span><span class=\"token keyword\">partition</span> <span class=\"token punctuation\">(</span>分区字段 <span class=\"token operator\">=</span> value1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>分区字段 <span class=\"token operator\">=</span> value2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">local</span> : 如果使用了，则<span class=\"token string\">'数据的路径'</span>写linux本地的路径；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t    如果未使用，则<span class=\"token string\">'数据的路径'</span>写hdfs上的路径； </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">partition</span> <span class=\"token punctuation\">(</span>分区字段 <span class=\"token operator\">=</span> value1<span class=\"token punctuation\">)</span>   ：表示数据上传到哪一个分区，后面详细介绍。  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>overwrite : 表示覆盖写。</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>本地 ： <span class=\"token keyword\">load</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">local</span> inpath <span class=\"token string\">'/opt/module/hive/datas/emp'</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">table</span> emp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>hdfs :  <span class=\"token keyword\">load</span> <span class=\"token keyword\">data</span> inpath <span class=\"token string\">'/user/hive/warehouse/emp'</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">table</span> emp<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"312-方式二\"><a class=\"anchor\" href=\"#312-方式二\">#</a> 3.1.2  方式二</h4>\n<ul>\n<li>通过查询语句向表中进行添加</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">table</span> 表名 <span class=\"token keyword\">select</span> 字段 <span class=\"token keyword\">from</span> 表名； <span class=\"token comment\">-- 追加的方式，原数据不会丢失</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">insert</span> overwrite <span class=\"token keyword\">table</span> 表名 <span class=\"token keyword\">select</span> 字段 <span class=\"token keyword\">from</span> 表名； <span class=\"token comment\">-- 覆盖原数据的方式，原数据被覆盖</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">table</span> 表名 <span class=\"token keyword\">select</span> 字段 <span class=\"token keyword\">from</span> 表名 <span class=\"token keyword\">partition</span> <span class=\"token punctuation\">(</span>分区字段 <span class=\"token operator\">=</span> <span class=\"token keyword\">Value</span><span class=\"token punctuation\">)</span>； 多分区的插入模式</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">table</span> emp <span class=\"token keyword\">select</span> id <span class=\"token punctuation\">,</span>name <span class=\"token keyword\">from</span> emp1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">insert</span> overwrite <span class=\"token keyword\">table</span> emp  <span class=\"token keyword\">select</span> id <span class=\"token punctuation\">,</span>name <span class=\"token keyword\">from</span> emp1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">table</span> emp <span class=\"token keyword\">select</span> id <span class=\"token punctuation\">,</span>name <span class=\"token keyword\">from</span> emp1 <span class=\"token keyword\">partition</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">month</span> <span class=\"token operator\">=</span> <span class=\"token string\">'2020-02-04'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"313-方式三\"><a class=\"anchor\" href=\"#313-方式三\">#</a> 3.1.3 方式三</h4>\n<ul>\n<li>创建表并使用查询语句加载数据（As Select）</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>建表语句 <span class=\"token operator\">+</span> <span class=\"token keyword\">as</span>  <span class=\"token operator\">+</span> 查询语句</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">create</span>  <span class=\"token punctuation\">[</span>external<span class=\"token punctuation\">]</span> <span class=\"token keyword\">table</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span><span class=\"token punctuation\">]</span> emp <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>id <span class=\"token keyword\">int</span> <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>name string</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">as</span> <span class=\"token keyword\">select</span> id <span class=\"token punctuation\">,</span> name <span class=\"token keyword\">from</span> emp1<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"314-方式四\"><a class=\"anchor\" href=\"#314-方式四\">#</a> 3.1.4 方式四</h4>\n<ul>\n<li>创建表时使用 location 的方式</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>建表语句 <span class=\"token operator\">+</span> location <span class=\"token operator\">+</span> <span class=\"token string\">'hdfs数据路径'</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>数据路径：只能是hdfs上的路径，当该路径是一个目录时，则表示加载该文件夹下的所有文件</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">create</span>  <span class=\"token punctuation\">[</span>external<span class=\"token punctuation\">]</span> <span class=\"token keyword\">table</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span><span class=\"token punctuation\">]</span> emp <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>id <span class=\"token keyword\">int</span> <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>name string</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>location <span class=\"token string\">'/user/hive/warehouse/emp'</span> <span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"315-方式五\"><a class=\"anchor\" href=\"#315-方式五\">#</a> 3.1.5 方式五</h4>\n<ul>\n<li>使用 import 方式</li>\n</ul>\n<p>注意：必须使用 export 的方式导出以后（导出了元数据和真实数据），再使用 import 进行导入。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token keyword\">table</span> student2  <span class=\"token keyword\">from</span> <span class=\"token string\">'/user/hive/warehouse/export/student'</span></pre></td></tr></table></figure><h3 id=\"32-数据的导出\"><a class=\"anchor\" href=\"#32-数据的导出\">#</a> 3.2 数据的导出</h3>\n<ul>\n<li>说明：数据的导出的方式，使用的情况很少。</li>\n</ul>\n<h4 id=\"321-方式一\"><a class=\"anchor\" href=\"#321-方式一\">#</a> 3.2.1 方式一</h4>\n<ul>\n<li>insert 方式</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">insert</span>  overwrite    <span class=\"token punctuation\">[</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">]</span> directory <span class=\"token string\">'输出文件路径'</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'分割符'</span><span class=\"token punctuation\">]</span> 查询语句</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>overwrite ：overwrite 是覆盖原文件的数据写入</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">]</span> ：加它，表示导出到本地，不加，则表示导出到hdfs上</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token string\">'输出文件路径'</span> ： 配合<span class=\"token keyword\">local</span>来的，加了<span class=\"token keyword\">local</span>，则写本地linux路径，不加，则写hdfs路径</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'分割符'</span><span class=\"token punctuation\">]</span> ：表示文件输出的格式</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">-- 导入到本地</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">1</span>）<span class=\"token keyword\">insert</span> overwrite <span class=\"token keyword\">local</span> directory <span class=\"token string\">'/opt/module/hive/datas/export/student'</span>  <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> student<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">-- 导出到本地，并指定导出的行数据的分割符</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">2</span>）<span class=\"token keyword\">insert</span> overwrite <span class=\"token keyword\">local</span> directory <span class=\"token string\">'/opt/module/hive/datas/export/student1'</span> <span class=\"token keyword\">ROW</span> FORMAT DELIMITED <span class=\"token keyword\">FIELDS</span> <span class=\"token keyword\">TERMINATED</span> <span class=\"token keyword\">BY</span> <span class=\"token string\">'\\t'</span>  <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> student<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">-- 导出到 hdfs 上，并指定导出的行数据的分割符</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">3</span>）<span class=\"token keyword\">insert</span> overwrite directory <span class=\"token string\">'/user/lianzp/student2'</span><span class=\"token keyword\">ROW</span> FORMAT DELIMITED <span class=\"token keyword\">FIELDS</span> <span class=\"token keyword\">TERMINATED</span> <span class=\"token keyword\">BY</span> <span class=\"token string\">'\\t'</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> student<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"322-方式二\"><a class=\"anchor\" href=\"#322-方式二\">#</a> 3.2.2 方式二</h4>\n<ul>\n<li>hadoop 的 shell 命令</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>hdfs dfs <span class=\"token operator\">-</span>get hdfs数据的输出路径 linux输入路径</pre></td></tr></table></figure><h4 id=\"323-方式三\"><a class=\"anchor\" href=\"#323-方式三\">#</a> 3.2.3 方式三</h4>\n<ul>\n<li>hive 的 shell 命令</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>hive <span class=\"token operator\">-</span>e 查询语句 <span class=\"token operator\">></span> linux输入路径</pre></td></tr></table></figure><h4 id=\"324-方式四\"><a class=\"anchor\" href=\"#324-方式四\">#</a> 3.2.4 方式四</h4>\n<ul>\n<li>export 的方式</li>\n</ul>\n<p>说明：export 和 import 主要用于两个 hadoop 平台集群之间的 hive 表迁移。</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>export <span class=\"token keyword\">table</span> 表名 <span class=\"token keyword\">to</span>  <span class=\"token string\">'文件输出路径'</span>  <span class=\"token comment\">-- 此路径为 hdfs 路径</span></pre></td></tr></table></figure><h4 id=\"325-方式五\"><a class=\"anchor\" href=\"#325-方式五\">#</a> 3.2.5 方式五</h4>\n<ul>\n<li>Sqoop 导出   -- &gt;  后续有课程单独讲解</li>\n</ul>\n<h3 id=\"33-清除表中数据\"><a class=\"anchor\" href=\"#33-清除表中数据\">#</a> 3.3 清除表中数据</h3>\n<ul>\n<li>使用 truncate</li>\n</ul>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">truncate</span> <span class=\"token keyword\">table</span> 表名 ；</pre></td></tr></table></figure><h2 id=\"四-查询\"><a class=\"anchor\" href=\"#四-查询\">#</a> 四、查询</h2>\n<h3 id=\"41-关键词的总结\"><a class=\"anchor\" href=\"#41-关键词的总结\">#</a> 4.1 关键词的总结</h3>\n<pre><code class=\"language-mysql\">-- 建表：\n1) partitioned by :分区表\n2）clustered by  : 分桶表\n\n-- 查询：\n1） order by : 全排序\n2） distribute by : 查询中做分区\n3） sort by : 查询中每个MapReduce内部排序\n4） cluster by : 查询中做分区排序\n\n-- 窗口函数：\n1) partition by :窗口函数中做分区\n2) order by ：窗口函数中做排序\n</code></pre>\n<h3 id=\"42-sql执行的顺序\"><a class=\"anchor\" href=\"#42-sql执行的顺序\">#</a> 4.2 sql 执行的顺序</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> <span class=\"token keyword\">from</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2.</span> <span class=\"token keyword\">on</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">3.</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">4.</span> <span class=\"token keyword\">where</span> <span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 不能使用列的别名</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">5.</span> <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> <span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 不能使用列的别名</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">6.</span> <span class=\"token keyword\">having</span> <span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 可以使用列的别名</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">7.</span> <span class=\"token keyword\">select</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">8.</span> <span class=\"token keyword\">distinct</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">9.</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 可以使用列的别名</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">10.</span> <span class=\"token keyword\">limit</span> <span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 可以使用列的别名</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>注意事项： 表名一旦使用了别名，所有的位置均需使用表的别名。</pre></td></tr></table></figure><h3 id=\"43-查询语法\"><a class=\"anchor\" href=\"#43-查询语法\">#</a> 4.3 查询语法</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">SELECT</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">ALL</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">DISTINCT</span><span class=\"token punctuation\">]</span> select_expr<span class=\"token punctuation\">,</span> select_expr<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">FROM</span> table_reference</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">[</span><span class=\"token keyword\">WHERE</span> where_condition<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">[</span><span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> col_list<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">[</span><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> col_list<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">[</span>CLUST <span class=\"token keyword\">BY</span> col_list</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token operator\">|</span> <span class=\"token punctuation\">[</span>DISTRIBUTE <span class=\"token keyword\">BY</span> col_list<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>SORT <span class=\"token keyword\">BY</span> col_list<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token punctuation\">[</span><span class=\"token keyword\">LIMIT</span> number<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token keyword\">DISTINCT</span> ：去重；</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> CLUST <span class=\"token keyword\">BY</span> col_list</pre></td></tr></table></figure><h3 id=\"44-基本查询\"><a class=\"anchor\" href=\"#44-基本查询\">#</a> 4.4  基本查询</h3>\n<h4 id=\"441-全表和特定列查询\"><a class=\"anchor\" href=\"#441-全表和特定列查询\">#</a> 4.4.1 全表和特定列查询</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> 表名 ；  <span class=\"token comment\">-- 全表查询</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">select</span> 列名<span class=\"token number\">1</span>、列名<span class=\"token number\">2</span> <span class=\"token keyword\">from</span> 表名 ； <span class=\"token comment\">-- 特定列查询</span></pre></td></tr></table></figure><h4 id=\"442-别名\"><a class=\"anchor\" href=\"#442-别名\">#</a> 4.4.2  别名</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>定义： 在查询中紧跟列名，也可以在列名与别名之间加<span class=\"token keyword\">as</span>；</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>注意事项：</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">1</span>）在hive中，中文的别名使用 一对 <span class=\"token punctuation\">`</span><span class=\"token punctuation\">`</span> 来注释；</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span>）<span class=\"token keyword\">as</span> 一般可以省略 ；</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">3</span>） <span class=\"token keyword\">where</span> 、 <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> 后面不能使用列的别名；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">4</span>）<span class=\"token keyword\">having</span> 、<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> 、<span class=\"token keyword\">limit</span> 可以使用列的别名 ；</pre></td></tr></table></figure><h4 id=\"443-算术运算符\"><a class=\"anchor\" href=\"#443-算术运算符\">#</a> 4.4.3 算术运算符</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">运算符</th>\n<th style=\"text-align:center\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">A+B</td>\n<td style=\"text-align:center\">A 和 B 相加</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">A-B</td>\n<td style=\"text-align:center\">A 减去 B</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">A*B</td>\n<td style=\"text-align:center\">A 和 B 相乘</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">A/B</td>\n<td style=\"text-align:center\">A 除以 B</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">A%B</td>\n<td style=\"text-align:center\">A 对 B 取余</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">A&amp;B</td>\n<td style=\"text-align:center\">A 和 B 按位取与</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">A|B</td>\n<td style=\"text-align:center\">A 和 B 按位取或</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">A^B</td>\n<td style=\"text-align:center\">A 和 B 按位取异或</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">~A</td>\n<td style=\"text-align:center\">A 按位取反</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"444-常用函数\"><a class=\"anchor\" href=\"#444-常用函数\">#</a> 4.4.4 常用函数</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  c求和 ： sum（）；</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2</span>） 求平均数 ： <span class=\"token function\">avg</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>  求最大值 ： max（）；</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">4</span>） 求最小值 ： min（）；</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">5</span>） 求个数 ： count（）；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">1</span>） count（）：不计算<span class=\"token boolean\">null</span>值；</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">2</span>） <span class=\"token function\">avg</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> : 计算平均数时，分母也是不计算<span class=\"token boolean\">null</span>个数的；</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">3</span>） 所以： <span class=\"token function\">avg</span> <span class=\"token punctuation\">(</span>字段<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">sum</span> <span class=\"token punctuation\">(</span>字段<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>字段<span class=\"token punctuation\">)</span>，因此我们在计算一些列的平均值时，一般使用count（<span class=\"token operator\">*</span>）或者是count（<span class=\"token number\">1</span>）；</pre></td></tr></table></figure><h4 id=\"445-where-语句\"><a class=\"anchor\" href=\"#445-where-语句\">#</a> 4.4.5 Where 语句</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>） 条件的筛选；</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2</span>） 紧跟<span class=\"token keyword\">from</span>后面。</pre></td></tr></table></figure><h4 id=\"446-比较运算符\"><a class=\"anchor\" href=\"#446-比较运算符\">#</a> 4.4.6 比较运算符</h4>\n<table>\n<thead>\n<tr>\n<th>操作符</th>\n<th style=\"text-align:center\">支持的数据类型</th>\n<th style=\"text-align:left\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>A=B</td>\n<td style=\"text-align:center\">基本数据类型</td>\n<td style=\"text-align:left\">如果 A 等于 B 则返回 TRUE，反之返回 FALSE</td>\n</tr>\n<tr>\n<td>A&lt;=&gt;B</td>\n<td style=\"text-align:center\">基本数据类型</td>\n<td style=\"text-align:left\">如果 A 和 B 都为 NULL，则返回 TRUE，如果一边为 NULL，返回 False</td>\n</tr>\n<tr>\n<td>A&lt;&gt;B, A!=B</td>\n<td style=\"text-align:center\">基本数据类型</td>\n<td style=\"text-align:left\">A 或者 B 为 NULL 则返回 NULL；如果 A 不等于 B，则返回 TRUE，反之返回 FALSE</td>\n</tr>\n<tr>\n<td>A&lt;B</td>\n<td style=\"text-align:center\">基本数据类型</td>\n<td style=\"text-align:left\">A 或者 B 为 NULL，则返回 NULL；如果 A 小于 B，则返回 TRUE，反之返回 FALSE</td>\n</tr>\n<tr>\n<td>A&lt;=B</td>\n<td style=\"text-align:center\">基本数据类型</td>\n<td style=\"text-align:left\">A 或者 B 为 NULL，则返回 NULL；如果 A 小于等于 B，则返回 TRUE，反之返回 FALSE</td>\n</tr>\n<tr>\n<td>A&gt;B</td>\n<td style=\"text-align:center\">基本数据类型</td>\n<td style=\"text-align:left\">A 或者 B 为 NULL，则返回 NULL；如果 A 大于 B，则返回 TRUE，反之返回 FALSE</td>\n</tr>\n<tr>\n<td>A&gt;=B</td>\n<td style=\"text-align:center\">基本数据类型</td>\n<td style=\"text-align:left\">A 或者 B 为 NULL，则返回 NULL；如果 A 大于等于 B，则返回 TRUE，反之返回 FALSE</td>\n</tr>\n<tr>\n<td>A [NOT] BETWEEN B AND C</td>\n<td style=\"text-align:center\">基本数据类型</td>\n<td style=\"text-align:left\">如果 A，B 或者 C 任一为 NULL，则结果为 NULL。如果 A 的值大于等于 B 而且小于或等于 C，则结果为 TRUE，反之为 FALSE。如果使用 NOT 关键字则可达到相反的效果。</td>\n</tr>\n<tr>\n<td>A IS NULL</td>\n<td style=\"text-align:center\">所有数据类型</td>\n<td style=\"text-align:left\">如果 A 等于 NULL，则返回 TRUE，反之返回 FALSE</td>\n</tr>\n<tr>\n<td>A IS NOT NULL</td>\n<td style=\"text-align:center\">所有数据类型</td>\n<td style=\"text-align:left\">如果 A 不等于 NULL，则返回 TRUE，反之返回 FALSE</td>\n</tr>\n<tr>\n<td>IN (数值 1, 数值 2)</td>\n<td style=\"text-align:center\">所有数据类型</td>\n<td style=\"text-align:left\">使用 IN 运算显示列表中的值</td>\n</tr>\n<tr>\n<td>A [NOT] LIKE B</td>\n<td style=\"text-align:center\">STRING 类型</td>\n<td style=\"text-align:left\">B 是一个 SQL 下的简单正则表达式，也叫通配符模式，如果 A 与其匹配的话，则返回 TRUE；反之返回 FALSE。B 的表达式说明如下：‘x%’表示 A 必须以字母‘x’开头，‘% x’表示 A 必须以字母’x’结尾，而‘% x%’表示 A 包含有字母’x’, 可以位于开头，结尾或者字符串中间。如果使用 NOT 关键字则可达到相反的效果。</td>\n</tr>\n<tr>\n<td>A RLIKE B, A REGEXP B</td>\n<td style=\"text-align:center\">STRING 类型</td>\n<td style=\"text-align:left\">B 是基于 java 的正则表达式，如果 A 与其匹配，则返回 TRUE；反之返回 FALSE。匹配使用的是 JDK 中的正则表达式接口实现的，因为正则也依据其中的规则。例如，正则表达式必须和整个字符串 A 相匹配，而不是只需与其字符串匹配。</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"447-like-和-rlike\"><a class=\"anchor\" href=\"#447-like-和-rlike\">#</a> 4.4.7 like 和 rlike</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>） <span class=\"token operator\">like</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">%</span> : 代表零个或者是多个字符（即时任意字符）\t</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>_ : 代表一个字符；</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\\ :  转义字符；</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">2</span>） <span class=\"token operator\">Rlike</span> ：后面紧跟随正则表达式</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> \\ : 转义字符，即屏蔽特殊字符的含义：\\$<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token operator\">^</span> : 从头开始匹配，如：name  <span class=\"token operator\">rlike</span> <span class=\"token operator\">^</span>a  : 表示以a开头的name</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> $ : 匹配结尾 ，如  name <span class=\"token operator\">Rlike</span> t$ ：匹配以t结尾的name</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token operator\">*</span> ： <span class=\"token number\">0</span><span class=\"token operator\">-</span>n 个 ，如 name <span class=\"token operator\">rlike</span> a<span class=\"token operator\">*</span> : 匹配 <span class=\"token number\">0</span><span class=\"token operator\">-</span>n a的name</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> : 表示范围，如 <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token operator\">-</span><span class=\"token number\">9</span><span class=\"token punctuation\">,</span>a<span class=\"token operator\">-</span>z<span class=\"token punctuation\">]</span>:匹配<span class=\"token number\">0</span><span class=\"token operator\">-</span><span class=\"token number\">9</span>或者是a<span class=\"token operator\">-</span>z都可以。</pre></td></tr></table></figure><h4 id=\"448-逻辑运算符\"><a class=\"anchor\" href=\"#448-逻辑运算符\">#</a> 4.4.8  逻辑运算符</h4>\n<table>\n<thead>\n<tr>\n<th>操作符</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>AND</td>\n<td>逻辑并</td>\n</tr>\n<tr>\n<td>OR</td>\n<td>逻辑或</td>\n</tr>\n<tr>\n<td>NOT</td>\n<td>逻辑否</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"45-分组\"><a class=\"anchor\" href=\"#45-分组\">#</a> 4.5 分组</h3>\n<h4 id=\"451-group-by\"><a class=\"anchor\" href=\"#451-group-by\">#</a> 4.5.1 group by</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">-</span> 常和聚合函数在一起<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">-</span> 出现在 <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> 中的字段可以出现在 <span class=\"token keyword\">select</span>中，也可以不出现，</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  但是出现在 <span class=\"token keyword\">select</span>中字段（除函数和常量外）必须在<span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> 出现过的字段。</pre></td></tr></table></figure><h4 id=\"451-having\"><a class=\"anchor\" href=\"#451-having\">#</a> 4.5.1 Having</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">having</span>  与 <span class=\"token keyword\">where</span> 的不同</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span>） <span class=\"token keyword\">where</span> 后面不能写分组函数，但是 <span class=\"token keyword\">having</span> 可以 ；</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2</span>） <span class=\"token keyword\">having</span> 只用于 <span class=\"token keyword\">Group</span> <span class=\"token keyword\">by</span> 分组统计语句；</pre></td></tr></table></figure><h3 id=\"46-join\"><a class=\"anchor\" href=\"#46-join\">#</a> 4.6  join</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span>） 常见的<span class=\"token number\">7</span>种 <span class=\"token keyword\">join</span> 要会写；</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2</span>） 不支持非等值连接；</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">3</span>） 支持满外连接 ： <span class=\"token keyword\">full</span> <span class=\"token keyword\">join</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>  关于主表和从表： <span class=\"token comment\">-- 左右外连接，主表数据全要，从表数据只要交集的部分。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> \t左外连接 ： 左边为主表，右边为从表 ；</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t右外连接 ： 右边为主表，左边为从表。</pre></td></tr></table></figure><h3 id=\"47-排序\"><a class=\"anchor\" href=\"#47-排序\">#</a> 4.7 排序</h3>\n<h4 id=\"471-全局排序-order-by\"><a class=\"anchor\" href=\"#471-全局排序-order-by\">#</a> 4.7.1 全局排序 ： Order By</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  全局排序，只能有一个Reducer ；</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2</span>） <span class=\"token keyword\">DESC</span> : 降序 ；</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>  <span class=\"token keyword\">ASC</span> : 升序（<span class=\"token string\">'默认值'</span>）；</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">4</span>） <span class=\"token keyword\">Order</span> <span class=\"token keyword\">by</span> 子句必须在<span class=\"token keyword\">SELECT</span>语句的结尾 ；</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>  排序的字段可以是多个；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>示例：</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">select</span> id <span class=\"token punctuation\">,</span> name <span class=\"token punctuation\">,</span>sal <span class=\"token keyword\">from</span> emp <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> sal <span class=\"token keyword\">desc</span> <span class=\"token punctuation\">,</span>name <span class=\"token keyword\">asc</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">-- 先按照薪水降序，薪水相同的，则按照名字进行升序排序；</span></pre></td></tr></table></figure><h4 id=\"472-mapreduce内部排序-sort-by\"><a class=\"anchor\" href=\"#472-mapreduce内部排序-sort-by\">#</a> 4.7.2 mapreduce 内部排序 ：sort  by</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  理解：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>理解为在 reduce 中进行排序。所以一般是需要有多个 reduce 才有作用，是在每个reduce中进行排序，属于局部排序，而不是全局排序。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2</span>） 使用场景：</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>当数据量很大时，不要进行全局排序，只需要进行局部排序。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">3</span>） 一般不单独使用，因为无法控制什么样的数据进入同一个 reduce 中；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">-- 一般配合 distribute by 使用，分区排序就是指定什么样的数据会进入同一个 reduce 中。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">4</span>） 单独使用时，进入同一个 reduce 任务中的数据是随机的。 <span class=\"token comment\">-- 伪随机，就是每次计算的结果是一样的，但是进入每一个 reduce 中的数据是随机的。</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">1</span>） 设置reducer的个数：</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">set</span> mapreduce<span class=\"token punctuation\">.</span>job<span class=\"token punctuation\">.</span>reduces<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 设置 reduce 个数为 3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">2</span>） 根据部门编号降序查看员工信息 ： </pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp sort <span class=\"token keyword\">by</span> deptno <span class=\"token keyword\">desc</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">-- 此时生成 3 个结果文件，并且每个结果文件中均是按照 deptno 进行降序排序。</span></pre></td></tr></table></figure><h4 id=\"473-分区排序-distribute-by\"><a class=\"anchor\" href=\"#473-分区排序-distribute-by\">#</a> 4.7.3 分区排序 ： distribute by</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> 理解 ： 类似在 MapReduce 中的自定义分区（<span class=\"token keyword\">partition</span> ）<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2.</span> 一般就是配合 sort <span class=\"token keyword\">by</span> 使用；</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">3.</span> 同样，在使用的时候，不能是一个reduce，需要多个reduce；</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">4.</span> 什么样的数据会进行同一个reduce 呢 ？</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token number\">1</span>）首先，这个分区不是很智能，使用的方式是：分区的字段的 （ hashcode  <span class=\"token operator\">%</span> reduce的个数 ），计算值相等的，则进入同一个reduce；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token number\">2</span>）不会使用toString方式进行分区。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">5.</span> distribute <span class=\"token keyword\">by</span> 必须写在sort <span class=\"token keyword\">by</span> 的前面；</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">6.</span> tez 引擎会进行reduce的优化，即假设设置为<span class=\"token number\">3</span>个reduce，但是运行时有可能是<span class=\"token number\">2</span>个reduce，所以验证时<span class=\"token number\">032</span>，需使用mr引擎。<span class=\"token comment\">-- set hive.execution.engine=mr;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">insert</span> overwrite <span class=\"token keyword\">local</span> directory <span class=\"token string\">'/opt/module/hive/datas/distribute-result'</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp distribute <span class=\"token keyword\">by</span> deptno sort <span class=\"token keyword\">by</span> empno <span class=\"token keyword\">desc</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 假设 reduce = 3 ；</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">-- 先按照 deptno 进行分区 (m = hashcode (deptno) % 3 , m 值相等的数据进入同一个分区），然后在分区内进行局部排序，最后将查询的结果导出到本地指定的一个文件中。</span></pre></td></tr></table></figure><h4 id=\"474-cluster-by\"><a class=\"anchor\" href=\"#474-cluster-by\">#</a> 4.7.4  Cluster By</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span> 理解 ：当distribute <span class=\"token keyword\">by</span> 和 sort <span class=\"token keyword\">by</span> 的字段相同时，可以使用Cluster <span class=\"token keyword\">by</span> 进行替代；</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2.</span> 不能指定排序的顺序，只能是升序。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>方式一 ：<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp  cluster <span class=\"token keyword\">by</span> deptno <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>方式二 ：<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp distribute <span class=\"token keyword\">by</span> deptno sort <span class=\"token keyword\">by</span> deptno <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">-- 方式一和方式二是等价的。</span></pre></td></tr></table></figure><h2 id=\"五-分区表和分桶表\"><a class=\"anchor\" href=\"#五-分区表和分桶表\">#</a> 五、 分区表和分桶表</h2>\n<h3 id=\"51-分区表\"><a class=\"anchor\" href=\"#51-分区表\">#</a> 5.1 分区表</h3>\n<p>分区表的解析：</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 理解：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span>） Hive 中的分区就是分目录 ；</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2</span>） 分区表对应一个hdfs文件系统的独立的文件；</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">3</span>） 实际上是把一个大的数据集根据业务的需求分割成多个小的数集；</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">4</span>） 在查询时，通过<span class=\"token keyword\">where</span>语句进行条件筛选，指定数据在哪个分区内，提高查询的效率；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>  同时用于解决数据倾斜的问题。</pre></td></tr></table></figure><h4 id=\"511-分区表的基本操作\"><a class=\"anchor\" href=\"#511-分区表的基本操作\">#</a> 5.1.1 分区表的基本操作</h4>\n<ol>\n<li>创建分区表</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span><span class=\"token punctuation\">]</span> 表名 <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>字段<span class=\"token number\">1</span> 数据类型<span class=\"token number\">1</span>，</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>字段<span class=\"token number\">2</span> 数据类型<span class=\"token number\">2</span>，</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>字段<span class=\"token number\">3</span> 数据类型<span class=\"token number\">3</span>，</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> <span class=\"token punctuation\">(</span>字段<span class=\"token number\">1</span> 数据类型<span class=\"token number\">1</span> ， 字段<span class=\"token number\">2</span> 数据类型<span class=\"token number\">2</span> ，<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">-- 分区，字段不能与表中属性字段相同</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">clustered</span> <span class=\"token keyword\">by</span> <span class=\"token punctuation\">(</span>字段<span class=\"token number\">1</span> ， 字段<span class=\"token number\">2</span> ， <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">-- 分桶，字段来自于表中的字段，所以是没有数据类型的。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">-- 分区的字段也是可以作为表的字段使用。</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> dept_partition<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>deptno <span class=\"token keyword\">int</span> <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>dname string <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>loc string</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">month</span> string <span class=\"token punctuation\">,</span> <span class=\"token keyword\">day</span> string<span class=\"token punctuation\">)</span> <span class=\"token comment\">-- 二级分区，先按照月进行分区，在月中再根据 day 进行分区</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>加载数据</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>方式一 ： 常规加载数据 <span class=\"token keyword\">load</span>方式</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">load</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">local</span> inpath <span class=\"token string\">'本地数据路径'</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">table</span> 表名 <span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> <span class=\"token punctuation\">(</span>字段<span class=\"token number\">1</span><span class=\"token string\">'***'</span><span class=\"token punctuation\">,</span>字段<span class=\"token number\">2</span>  <span class=\"token string\">'***'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">load</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">local</span> inpath <span class=\"token string\">'/opt/module/hive/datas/2020-04-04.log'</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">table</span> dept_partition <span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">month</span><span class=\"token operator\">=</span><span class=\"token string\">'2020-04'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">day</span><span class=\"token operator\">=</span><span class=\"token string\">'04'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>方式二：上传数据后修复 <span class=\"token comment\">-- 因为单独上传数据到指定的目录下，hive 是不能自动读取，需要进行数据的修复</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>第一步： 根据分区字段的信息，创建文件夹，此文件夹与表的路径相同</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>第二步： 本地的数据上传到指定的目录下，使用 【 hdfs dfs <span class=\"token operator\">-</span>put 本地数据路径 hdfs文件路径 】</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>第三步： 进行数据的修复 ，使用语句 【msck repair <span class=\"token keyword\">table</span> 表名】</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>方式三： 上传数据后添加分区的方式 <span class=\"token comment\">-- 该方式使用的情况最多</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>第一步和第二步与方式二完全相同；</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>第三步： 执行添加分区的方式</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 表名 <span class=\"token keyword\">add</span> <span class=\"token keyword\">partition</span> <span class=\"token punctuation\">(</span>字段<span class=\"token number\">1</span><span class=\"token operator\">=</span><span class=\"token string\">'***'</span><span class=\"token punctuation\">,</span>字段<span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token string\">'***'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">-- 实例：</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>第一步：hdfs dfs <span class=\"token operator\">-</span>mkdir <span class=\"token operator\">-</span>p  <span class=\"token operator\">/</span><span class=\"token keyword\">user</span><span class=\"token operator\">/</span>hive<span class=\"token operator\">/</span>warehouse<span class=\"token operator\">/</span>dept_partition<span class=\"token operator\">/</span><span class=\"token keyword\">month</span><span class=\"token operator\">=</span><span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">/</span><span class=\"token keyword\">day</span><span class=\"token operator\">=</span><span class=\"token number\">04</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>第二步：hdfs dfs <span class=\"token operator\">-</span>put <span class=\"token operator\">/</span>opt<span class=\"token operator\">/</span>module<span class=\"token operator\">/</span>hive<span class=\"token operator\">/</span>datas<span class=\"token operator\">/</span><span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">04.</span>logs <span class=\"token operator\">/</span><span class=\"token keyword\">user</span><span class=\"token operator\">/</span>hive<span class=\"token operator\">/</span>warehouse<span class=\"token operator\">/</span>dept_partition<span class=\"token operator\">/</span><span class=\"token keyword\">month</span><span class=\"token operator\">=</span><span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">/</span><span class=\"token keyword\">day</span><span class=\"token operator\">=</span><span class=\"token number\">04</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>第三步：</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>方式二： msck repair <span class=\"token keyword\">table</span> dept_partition<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>方式二： <span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> dept_partition <span class=\"token keyword\">add</span> <span class=\"token keyword\">partition</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">month</span><span class=\"token operator\">=</span><span class=\"token string\">'2020-04'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">day</span><span class=\"token operator\">=</span><span class=\"token string\">'04'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>根据分区进行查询</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>查询语句 <span class=\"token operator\">+</span> <span class=\"token keyword\">where</span> 分区字段<span class=\"token operator\">=</span><span class=\"token string\">'***'</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">select</span>  <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> dept_partition <span class=\"token keyword\">where</span> <span class=\"token keyword\">day</span><span class=\"token operator\">=</span><span class=\"token string\">'04'</span> <span class=\"token operator\">or</span> <span class=\"token keyword\">day</span><span class=\"token operator\">=</span><span class=\"token string\">'05'</span> ；</pre></td></tr></table></figure><ol start=\"4\">\n<li>增加分区</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 表名 <span class=\"token keyword\">add</span> <span class=\"token keyword\">partition</span> <span class=\"token punctuation\">(</span>字段<span class=\"token number\">1</span><span class=\"token operator\">=</span><span class=\"token string\">\"***\"</span><span class=\"token punctuation\">,</span>字段<span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token string\">'***'</span><span class=\"token punctuation\">)</span>  <span class=\"token keyword\">partition</span>  <span class=\"token punctuation\">(</span>字段<span class=\"token number\">1</span><span class=\"token operator\">=</span><span class=\"token string\">\"***\"</span><span class=\"token punctuation\">,</span>字段<span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token string\">'***'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>增加多个分区时，分区与分区之间使用空格隔开。</pre></td></tr></table></figure><ol start=\"5\">\n<li>删除分区</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 表名 <span class=\"token keyword\">drop</span> <span class=\"token keyword\">partition</span> <span class=\"token punctuation\">(</span>字段<span class=\"token number\">1</span><span class=\"token operator\">=</span><span class=\"token string\">\"***\"</span><span class=\"token punctuation\">,</span>字段<span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token string\">'***'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token keyword\">partition</span>  <span class=\"token punctuation\">(</span>字段<span class=\"token number\">1</span><span class=\"token operator\">=</span><span class=\"token string\">\"***\"</span><span class=\"token punctuation\">,</span>字段<span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token string\">'***'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>删除的多个分区之间使用<span class=\"token string\">','</span>进行分隔。</pre></td></tr></table></figure><ol start=\"6\">\n<li>查看多个分区</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">show</span> partitions 表名；</pre></td></tr></table></figure><h4 id=\"512-动态分区调整\"><a class=\"anchor\" href=\"#512-动态分区调整\">#</a> 5.1.2 动态分区调整</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 理解：为什么要使用动态分区呢？</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>在实际的情况中，我们的数据通过前端收集过来以后，一般都是存储在hdfs上面，我们只需要通过 <span class=\"token keyword\">insert</span> <span class=\"token operator\">+</span> 查询语句的方式将数据导入到指定的数据表，在此时需要指定按照什么字段进行分区。</pre></td></tr></table></figure><ol>\n<li>前期的准备工作 --<strong> 开启动态分区参数设置</strong></li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>（<span class=\"token number\">1</span>）开启动态分区功能（默认<span class=\"token boolean\">true</span>，开启）</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>hive<span class=\"token punctuation\">.</span><span class=\"token keyword\">exec</span><span class=\"token punctuation\">.</span>dynamic<span class=\"token punctuation\">.</span><span class=\"token keyword\">partition</span><span class=\"token operator\">=</span><span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>（<span class=\"token number\">2</span>）设置为非严格模式（动态分区的模式，默认strict，表示必须指定至少一个分区为静态分区，nonstrict模式表示允许所有的分区字段都可以使用动态分区。）</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>hive<span class=\"token punctuation\">.</span><span class=\"token keyword\">exec</span><span class=\"token punctuation\">.</span>dynamic<span class=\"token punctuation\">.</span><span class=\"token keyword\">partition</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">mode</span><span class=\"token operator\">=</span>nonstrict</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>（<span class=\"token number\">3</span>）在所有执行MR的节点上，最大一共可以创建多少个动态分区。默认<span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>hive<span class=\"token punctuation\">.</span><span class=\"token keyword\">exec</span><span class=\"token punctuation\">.</span>max<span class=\"token punctuation\">.</span>dynamic<span class=\"token punctuation\">.</span>partitions<span class=\"token operator\">=</span><span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>（<span class=\"token number\">4</span>）在每个执行MR的节点上，最大可以创建多少个动态分区。该参数需要根据实际的数据来设定。比如：源数据中包含了一年的数据，即<span class=\"token keyword\">day</span>字段有<span class=\"token number\">365</span>个值，那么该参数就需要设置成大于<span class=\"token number\">365</span>，如果使用默认值<span class=\"token number\">100</span>，则会报错。</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>hive<span class=\"token punctuation\">.</span><span class=\"token keyword\">exec</span><span class=\"token punctuation\">.</span>max<span class=\"token punctuation\">.</span>dynamic<span class=\"token punctuation\">.</span>partitions<span class=\"token punctuation\">.</span>pernode<span class=\"token operator\">=</span><span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>（<span class=\"token number\">5</span>）整个MR Job中，最大可以创建多少个HDFS文件。默认<span class=\"token number\">100000</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>hive<span class=\"token punctuation\">.</span><span class=\"token keyword\">exec</span><span class=\"token punctuation\">.</span>max<span class=\"token punctuation\">.</span>created<span class=\"token punctuation\">.</span>files<span class=\"token operator\">=</span><span class=\"token number\">100000</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>（<span class=\"token number\">6</span>）当有空分区生成时，是否抛出异常。一般不需要设置。默认<span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>hive<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">.</span><span class=\"token keyword\">on</span><span class=\"token punctuation\">.</span>empty<span class=\"token punctuation\">.</span><span class=\"token keyword\">partition</span><span class=\"token operator\">=</span><span class=\"token boolean\">false</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>实操</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 需求：将 dept 表中的数据按照地区（loc 字段），插入到目标表 dept——partition 的分区中：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">1</span>）创建目标dept_partition表</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> dept_partition <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>id <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>name string</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>partitioned <span class=\"token keyword\">by</span> <span class=\"token punctuation\">(</span>loc string<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> 插入数据</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">table</span> dept_partition <span class=\"token keyword\">partition</span> <span class=\"token punctuation\">(</span>loc<span class=\"token punctuation\">)</span> <span class=\"token keyword\">select</span> deptno <span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> loc <span class=\"token keyword\">from</span> dept<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"52-分桶表\"><a class=\"anchor\" href=\"#52-分桶表\">#</a> 5.2 分桶表</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 理解：为什么会有分桶表？或者说分桶表是用来解决什么问题呢？</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span>）提供一个数据隔离和优化查询的便利方式，如当某一个表或者是某一个分区的数据量特别大时，通过分桶的方式，可以将数据再进行分解成多个模块，这样在进行查询时，提供了查询的效率。 <span class=\"token comment\">-- 说明查询的分区操作时自动的。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2</span>）什么样的数据会进入同一个桶中呢？</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>通过 （分桶字段的）hashcode <span class=\"token operator\">%</span> 桶的个数 ，取模数相等的进入同一个桶内。（不适用于TEZ引擎）</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">3</span>）分桶表针对的是数据文件；而分区是针对数据路径。</pre></td></tr></table></figure><p>创建分桶表</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>在创建表单时，增加如下语法子句：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">clustered</span> <span class=\"token keyword\">by</span> <span class=\"token punctuation\">(</span>字段<span class=\"token number\">1</span>，字段<span class=\"token number\">2</span>，<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">into</span> num buckets<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">1</span>） 字段<span class=\"token number\">1</span><span class=\"token operator\">-</span>n : 均来自于表中的字段；</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">2</span>） num : 表示分桶的个数。</pre></td></tr></table></figure><h3 id=\"53-抽样查询\"><a class=\"anchor\" href=\"#53-抽样查询\">#</a> 5.3  抽样查询</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 理解：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>当数据特别大的时候，我们不要通过查询所有的数据来获取数据的情况。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>例如：工厂生产的产品，OQC 是按比例抽样来判定产品的良率。</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span>  <span class=\"token keyword\">from</span> dept tablesample <span class=\"token punctuation\">(</span>bucket <span class=\"token number\">1</span> <span class=\"token keyword\">out</span> <span class=\"token keyword\">of</span> <span class=\"token number\">4</span> <span class=\"token keyword\">on</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">on</span> :表示依据哪个字段进行抽样；</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">4</span> ： 表示按照<span class=\"token keyword\">on</span>后面的字段将数据分成几份。</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">1</span> ： 则表示第一份，<span class=\"token number\">2</span> 表示第二份。</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>如上只是抽样方法中非常简单的一种，还有很多种方式。</pre></td></tr></table></figure><h2 id=\"六-函数-重点\"><a class=\"anchor\" href=\"#六-函数-重点\">#</a> 六 、函数 （重点）</h2>\n<h3 id=\"61-常用函数\"><a class=\"anchor\" href=\"#61-常用函数\">#</a> 6.1 常用函数</h3>\n<p>日期函数：</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>） unix_timestamp : 返回当前或指定的时间戳；</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">SELECT</span>  unix_timestamp<span class=\"token punctuation\">(</span><span class=\"token string\">\"2020-05-02 11:22:00\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">1588418520</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2</span>） from_unixtime : 将时间戳转化为日期格式</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">SELECT</span> FROM_unixtime<span class=\"token punctuation\">(</span><span class=\"token number\">1588418520</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">05</span><span class=\"token operator\">-</span><span class=\"token number\">02</span> <span class=\"token number\">11</span>:<span class=\"token number\">22</span>:<span class=\"token number\">00</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">current_date</span> : 当前日期</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">4</span>）<span class=\"token keyword\">current_timestamp</span>: 当前日期 <span class=\"token operator\">+</span> 时间；</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">5</span>）to_date : 获取日期部分</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">6</span>）<span class=\"token keyword\">year</span><span class=\"token operator\">/</span><span class=\"token keyword\">month</span><span class=\"token operator\">/</span><span class=\"token keyword\">day</span><span class=\"token operator\">/</span><span class=\"token keyword\">hour</span><span class=\"token operator\">/</span><span class=\"token keyword\">minute</span><span class=\"token operator\">/</span><span class=\"token keyword\">second</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> : 获取年、月、日、小时、分、秒</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">7</span>）weekofyear<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>: 当前时间是一年中的第几周</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">8</span>）dayofmonth<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>: 当前时间是一个月中的第几天</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">9</span>）months_between<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> : 两个日期间的月份</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> datediff<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> : 两个日期相差的天数</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> add_months：日期加减月</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">12</span><span class=\"token punctuation\">)</span> date_add：日期加天数</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">13</span><span class=\"token punctuation\">)</span> date_sub：日期减天数</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token number\">14</span><span class=\"token punctuation\">)</span> last_day: 日期的当月的最后一天</pre></td></tr></table></figure><p>取整函数</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> round： 四舍五入</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> ceil：  向上取整</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> floor： 向下取整</pre></td></tr></table></figure><p>字符串函数</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>）upper： 转大写</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2</span>）lower： 转小写</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">3</span>）length： 长度</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">4</span>）trim：  前后去空格</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">5</span>）lpad： 向左补齐，到指定长度</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">6</span>）rpad：  向右补齐，到指定长度</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">7</span>）regexp_replace： <span class=\"token keyword\">SELECT</span> regexp_replace<span class=\"token punctuation\">(</span><span class=\"token string\">'100-200'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'(\\\\d+)'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'num'</span><span class=\"token punctuation\">)</span> ；</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t使用正则表达式匹配目标字符串，匹配成功后替换！</pre></td></tr></table></figure><p>集合操作</p>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>） size： 集合中元素的个数</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2</span>） map_keys： 返回map中的<span class=\"token keyword\">key</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">3</span>） map_values: 返回map中的<span class=\"token keyword\">value</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">4</span>） array_contains: 判断array中是否包含某个元素</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">5</span>） sort_array： 将array中的元素排序</pre></td></tr></table></figure><h3 id=\"62-系统内置函数\"><a class=\"anchor\" href=\"#62-系统内置函数\">#</a> 6.2 系统内置函数</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>） 查看系统自带的函数</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">show</span> functions<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> 查询函数的用法</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">desc</span> <span class=\"token keyword\">function</span> <span class=\"token keyword\">extended</span> 函数名</pre></td></tr></table></figure><h3 id=\"63-常用的内置函数\"><a class=\"anchor\" href=\"#63-常用的内置函数\">#</a> 6.3 常用的内置函数</h3>\n<h4 id=\"631-空字段赋值-nvl\"><a class=\"anchor\" href=\"#631-空字段赋值-nvl\">#</a> 6.3.1 空字段赋值 NVL</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>nvl<span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span>default_value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">1</span>）如果<span class=\"token keyword\">value</span> 为<span class=\"token boolean\">null</span>，则返回default_value ，否则返回vaule；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">2</span>）如果两个值（<span class=\"token keyword\">value</span> <span class=\"token punctuation\">,</span> default_value）均为<span class=\"token boolean\">null</span>，则返回<span class=\"token boolean\">null</span>；</pre></td></tr></table></figure><h4 id=\"632-case-when\"><a class=\"anchor\" href=\"#632-case-when\">#</a> 6.3.2 CASE WHEN</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  dept_id<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> sex <span class=\"token keyword\">when</span> <span class=\"token string\">'男'</span> <span class=\"token keyword\">then</span> <span class=\"token number\">1</span> <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> male_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">case</span> sex <span class=\"token keyword\">when</span> <span class=\"token string\">'女'</span> <span class=\"token keyword\">then</span> <span class=\"token number\">1</span> <span class=\"token keyword\">else</span> <span class=\"token number\">0</span> <span class=\"token keyword\">end</span><span class=\"token punctuation\">)</span> female_count</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  emp_sex</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  dept_id<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">/*  解读：</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  1. 按照 dept_id 进行分组，同一组的数据先进行计算；</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  2. 假设 dept_id=10 的数据有 10 条，则 10 数据分别在 sum 函数中进行计算，计算完成以后得出一个结果；</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  3. 一组数据最后得到一条数据结果。</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  */</span></pre></td></tr></table></figure><h4 id=\"633-行转列\"><a class=\"anchor\" href=\"#633-行转列\">#</a> 6.3.3 行转列</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 相关函数</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span>） concat<span class=\"token punctuation\">(</span><span class=\"token string\">'str1'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'str2'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'str3'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> : 表示将str1<span class=\"token operator\">/</span>str2<span class=\"token operator\">/</span>str3<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 依次进行连接，str1<span class=\"token operator\">/</span>str2<span class=\"token operator\">/</span>str3<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 可以说任何数据类型；</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 示例：SELECT  concat ('132','-','456'); ==> 132-456</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> concat_ws<span class=\"token punctuation\">(</span><span class=\"token string\">'连接符'</span>，<span class=\"token string\">'str1'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'str2'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> : 表示使用<span class=\"token string\">'连接符'</span>将str1<span class=\"token operator\">/</span>str2<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>依次进行连接，str1<span class=\"token operator\">/</span>str2<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>只能是字符串或者是字符串数组。</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">SELECT</span>  concat_ws<span class=\"token punctuation\">(</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'java'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">></span> java<span class=\"token operator\">-</span>maven<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">SELECT</span>  concat_ws<span class=\"token punctuation\">(</span><span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span><span class=\"token string\">'java'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">null</span> <span class=\"token comment\">-- 当连接符为 null 时，结果返回 null</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">SELECT</span>  concat_ws<span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'www'</span><span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">(</span><span class=\"token string\">'facebook'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'com'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> ；<span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">></span> www<span class=\"token punctuation\">.</span>facebook<span class=\"token punctuation\">.</span>com</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">3</span>） collect_set<span class=\"token punctuation\">(</span>col<span class=\"token punctuation\">)</span> : 函数只接受基本数据类型，它的主要作用是将某字段的值进行去重汇总，产生array类型字段</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">SELECT</span> COLLECT_set<span class=\"token punctuation\">(</span>deptno<span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> emp<span class=\"token punctuation\">;</span> <span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span><span class=\"token number\">30</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h4 id=\"634-列转行\"><a class=\"anchor\" href=\"#634-列转行\">#</a> 6.3.4 列转行</h4>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 语法：</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lateral <span class=\"token keyword\">view</span> explode <span class=\"token punctuation\">(</span>split<span class=\"token punctuation\">(</span>字段，分割符<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> 表名 <span class=\"token keyword\">as</span> 列名</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">-- 说明：</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>lateral <span class=\"token keyword\">view</span> : 侧写；</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>explode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>: 将指定的集合拆解分成多行 <span class=\"token comment\">-- 炸裂</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>split<span class=\"token punctuation\">(</span>字段，分割符<span class=\"token punctuation\">)</span> : 将指定的字符串按照分割符封装成一个集合。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">-- 示例：</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">SELECT</span> movie<span class=\"token punctuation\">,</span>category_name </pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">FROM</span> movie_info </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>lateral <span class=\"token keyword\">VIEW</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>explode<span class=\"token punctuation\">(</span>split<span class=\"token punctuation\">(</span>category<span class=\"token punctuation\">,</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> movie_info_tmp  <span class=\"token keyword\">AS</span> category_name <span class=\"token punctuation\">;</span> <span class=\"token comment\">-- categor_name 为炸裂的列名，move_info_tmp 为侧写的表名</span></pre></td></tr></table></figure><p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20200630212310.png\" alt=\"image-20200630212310025\" /></p>\n<p><img data-src=\"https://miyazono-1255488789.cos.ap-shanghai.myqcloud.com/markdown/20200630212551.png\" alt=\"image-20200630212550900\" /></p>\n<h3 id=\"64-开窗函数\"><a class=\"anchor\" href=\"#64-开窗函数\">#</a> 6.4 开窗函数</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>相关函数说明：开窗函数是为每一条数据进行开窗</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span>） <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> : 单独使用此函数，默认的窗口大小为结果集的大小。</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2</span>） <span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> : 在窗口函数中进行分区</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> \t<span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> 字段<span class=\"token punctuation\">)</span> ：对结果集内进行分区，每条数据的开窗大小为该结果集中分区集的大小。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> 字段<span class=\"token punctuation\">)</span> ： 在窗口函数中只用到了<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> 排序时，也会对每条数据进行开一个窗口，默认的开窗大小为：从结果集的开始位置到当前处理数据的位置。</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">-- 实例：</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">-- 1. 查询在 2017 年 4 月份购买过的顾客及总人数</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">-- 解析，顾客全部要，多个顾客，多行，人数为一个值，一行，则是需要进行开窗，因为不是一一匹配的。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">SELECT</span>  name <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>   <span class=\"token keyword\">OVER</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">`</span>人数<span class=\"token punctuation\">`</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">from</span> business </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">WHERE</span>  SUBSTRING<span class=\"token punctuation\">(</span>orderdate<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token string\">'2017-04'</span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> name <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">-- 2. 查询顾客的购买明细及月购买总额</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> name <span class=\"token punctuation\">,</span>orderdate <span class=\"token punctuation\">,</span>cost <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">sum</span> <span class=\"token punctuation\">(</span>cost<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">MONTH</span> <span class=\"token punctuation\">(</span>orderdate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">from</span> business<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">-- 3. 上述的场景，将每个顾客的 cost 按照日期进行累加</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">SELECT</span> name <span class=\"token punctuation\">,</span>orderdate <span class=\"token punctuation\">,</span>cost <span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token function\">sum</span> <span class=\"token punctuation\">(</span>cost<span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">partition</span> <span class=\"token keyword\">by</span> name <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> orderdate<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">from</span> business<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token number\">4</span>） <span class=\"token keyword\">CURRENT</span> <span class=\"token keyword\">ROW</span>：当前行</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tn <span class=\"token keyword\">PRECEDING</span>：往前n行数据</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tn <span class=\"token keyword\">FOLLOWING</span>：往后n行数据</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token number\">5</span>）<span class=\"token keyword\">UNBOUNDED</span>：起点，</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token keyword\">UNBOUNDED</span> <span class=\"token keyword\">PRECEDING</span> 表示从前面的起点 </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">UNBOUNDED</span> <span class=\"token keyword\">FOLLOWING</span> 表示到后面的终点</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token number\">6</span>）LAG<span class=\"token punctuation\">(</span>col<span class=\"token punctuation\">,</span>n<span class=\"token punctuation\">,</span>default_val<span class=\"token punctuation\">)</span>：往前第n行数据</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token number\">7</span>）LEAD<span class=\"token punctuation\">(</span>col<span class=\"token punctuation\">,</span>n<span class=\"token punctuation\">,</span> default_val<span class=\"token punctuation\">)</span>：往后第n行数据</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token number\">8</span>）NTILE<span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span>：把有序窗口的行分发到指定数据的组中，各个组有编号，编号从<span class=\"token number\">1</span>开始，对于每一行，NTILE返回此行所属的组的编号。注意：n必须为<span class=\"token keyword\">int</span>类型。</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>示例：</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">-- 需求：查询前 20% 时间的订单信息</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">select</span> name<span class=\"token punctuation\">,</span>orderdate<span class=\"token punctuation\">,</span>cost<span class=\"token punctuation\">,</span> ntile<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> orderdate<span class=\"token punctuation\">)</span> sorted</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">from</span> business</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">)</span> t</pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token keyword\">where</span> sorted <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"65-rank\"><a class=\"anchor\" href=\"#65-rank\">#</a> 6.5 Rank</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">-- 函数说明</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> RANK<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> 排序相同时会重复，总数不会变<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token comment\">-- 1 2 2 4 5 5 7</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> DENSE_RANK<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> 排序相同时会重复，总数会减少<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">-- 1 2 2 3 3 4 4 5</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> ROW_NUMBER<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> 会根据顺序计算。</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">-- 1 2 3 4 5 6</span></pre></td></tr></table></figure><h3 id=\"66-自定义函数\"><a class=\"anchor\" href=\"#66-自定义函数\">#</a> 6.6 自定义函数</h3>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>自定函数的分类：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span>） UDF（<span class=\"token keyword\">User</span><span class=\"token operator\">-</span>Defined<span class=\"token operator\">-</span><span class=\"token keyword\">Function</span>） <span class=\"token comment\">-- 一进一出</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span>） UDAF（<span class=\"token keyword\">User</span><span class=\"token operator\">-</span>Defined Aggregation <span class=\"token keyword\">Function</span>） <span class=\"token comment\">-- 聚集函数，多进一出</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t类似于：count<span class=\"token operator\">/</span>max<span class=\"token operator\">/</span>min</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">3</span>） UDTF（<span class=\"token keyword\">User</span><span class=\"token operator\">-</span>Defined <span class=\"token keyword\">Table</span><span class=\"token operator\">-</span>Generating Functions） <span class=\"token comment\">-- 一进多出</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t如lateral <span class=\"token keyword\">view</span> explode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"661-自定义udf函数\"><a class=\"anchor\" href=\"#661-自定义udf函数\">#</a> 6.6.1 自定义 UDF 函数</h4>\n<ol>\n<li>需求：UDF 实现计算给定字符串的长度</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>示例：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">select</span> my_len<span class=\"token punctuation\">(</span><span class=\"token string\">\"abcd\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token number\">4</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>创建一个 Maven 工程</li>\n<li>导入依赖</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>dependencies<span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t\t<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>dependency<span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t\t<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>groupId<span class=\"token punctuation\">></span></span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hive<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>groupId<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t\t<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>artifactId<span class=\"token punctuation\">></span></span>hive<span class=\"token operator\">-</span>exec<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>artifactId<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span>version<span class=\"token punctuation\">></span></span><span class=\"token number\">3.1</span><span class=\"token number\">.2</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>version<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>dependency<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>dependencies<span class=\"token operator\">></span></pre></td></tr></table></figure><ol start=\"4\">\n<li>创建一个类继承于 GenericUDF</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>lianzp<span class=\"token punctuation\">.</span>hive</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>ql<span class=\"token punctuation\">.</span>exec<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">UDFArgumentException</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>ql<span class=\"token punctuation\">.</span>exec<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">UDFArgumentLengthException</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>ql<span class=\"token punctuation\">.</span>exec<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">UDFArgumentTypeException</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>ql<span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">HiveException</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>ql<span class=\"token punctuation\">.</span>udf<span class=\"token punctuation\">.</span>generic<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">GenericUDF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>serde2<span class=\"token punctuation\">.</span>objectinspector<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ObjectInspector</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>serde2<span class=\"token punctuation\">.</span>objectinspector<span class=\"token punctuation\">.</span>primitive<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">PrimitiveObjectInspectorFactory</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * 自定义 UDF 函数，需要继承 GenericUDF 类</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * 需求：计算指定字符串的长度</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyStringLength</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">GenericUDF</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     * @param arguments 输入参数类型的鉴别器对象</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     * @return 返回值类型的鉴别器对象</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     * @throws UDFArgumentException</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ObjectInspector</span> <span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ObjectInspector</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> arguments<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">UDFArgumentException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token comment\">// 判断输入参数的个数</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UDFArgumentLengthException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Input Args Length Error!!!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// 判断输入参数的类型</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>arguments<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCategory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ObjectInspector<span class=\"token punctuation\">.</span>Category</span><span class=\"token punctuation\">.</span>PRIMITIVE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UDFArgumentTypeException</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"Input Args Type Error!!!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token comment\">// 函数本身返回值为 int，需要返回 int 类型的鉴别器对象</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">PrimitiveObjectInspectorFactory</span><span class=\"token punctuation\">.</span>javaIntObjectInspector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>     * 函数的逻辑处理</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>     * @param arguments 输入的参数</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>     * @return 返回值</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>     * @throws HiveException</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">evaluate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DeferredObject</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> arguments<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">HiveException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>       <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>           <span class=\"token keyword\">return</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>       <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>       <span class=\"token keyword\">return</span> arguments<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getDisplayString</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> children<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li>打成 jar 包上传到服务器 /opt/module/hive/datas/myudf.jar</li>\n<li>将 jar 包添加到 hive 的 classpath</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">add</span> jar <span class=\"token operator\">/</span>opt<span class=\"token operator\">/</span>module<span class=\"token operator\">/</span>hive<span class=\"token operator\">/</span>datas<span class=\"token operator\">/</span>myudf<span class=\"token punctuation\">.</span>jar<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"7\">\n<li>创建临时函数与开发好的 java class 关联</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">temporary</span> <span class=\"token keyword\">function</span> my_len <span class=\"token keyword\">as</span> <span class=\"token string\">\"com.lianzp.hive. MyStringLength\"</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"8\">\n<li>即可在 hql 中使用自定义的函数 my_len</li>\n</ol>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">select</span> ename<span class=\"token punctuation\">,</span>my_len<span class=\"token punctuation\">(</span>ename<span class=\"token punctuation\">)</span> ename_len <span class=\"token keyword\">from</span> emp<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h4 id=\"662-自定义udtf函数\"><a class=\"anchor\" href=\"#662-自定义udtf函数\">#</a> 6.6.2 自定义 UDTF 函数</h4>\n<p>和 udf 的最大区别就是自定义函数不同。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>lianzp<span class=\"token punctuation\">.</span>udtf</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>ql<span class=\"token punctuation\">.</span>exec<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">UDFArgumentException</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>ql<span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">HiveException</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>ql<span class=\"token punctuation\">.</span>udf<span class=\"token punctuation\">.</span>generic<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">GenericUDTF</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>serde2<span class=\"token punctuation\">.</span>objectinspector<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ObjectInspector</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>serde2<span class=\"token punctuation\">.</span>objectinspector<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ObjectInspectorFactory</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>serde2<span class=\"token punctuation\">.</span>objectinspector<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">StructObjectInspector</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>hadoop<span class=\"token punctuation\">.</span>hive<span class=\"token punctuation\">.</span>serde2<span class=\"token punctuation\">.</span>objectinspector<span class=\"token punctuation\">.</span>primitive<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">PrimitiveObjectInspectorFactory</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ArrayList</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">List</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyUDTF</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">GenericUDTF</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> outList <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">StructObjectInspector</span> <span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StructObjectInspector</span> argOIs<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">UDFArgumentException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">//1. 定义输出数据的列名和类型</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> fieldNames <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ObjectInspector</span><span class=\"token punctuation\">></span></span> fieldOIs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">//2. 添加输出数据的列名和类型</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        fieldNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lineToWord\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        fieldOIs<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PrimitiveObjectInspectorFactory</span><span class=\"token punctuation\">.</span>javaStringObjectInspector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ObjectInspectorFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">getStandardStructObjectInspector</span><span class=\"token punctuation\">(</span>fieldNames<span class=\"token punctuation\">,</span> fieldOIs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">HiveException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\">//1. 获取原始数据</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token class-name\">String</span> arg <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token comment\">//2. 获取数据传入的第二个参数，此处为分隔符</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token class-name\">String</span> splitKey <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token comment\">//3. 将原始数据按照传入的分隔符进行切分</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> fields <span class=\"token operator\">=</span> arg<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>splitKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token comment\">//4. 遍历切分后的结果，并写出</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> field <span class=\"token operator\">:</span> fields<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token comment\">// 集合为复用的，首先清空集合</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            outList<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            <span class=\"token comment\">// 将每一个单词添加至集合</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            outList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>field<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            <span class=\"token comment\">// 将集合内容写出</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>outList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">HiveException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"七-压缩与存储\"><a class=\"anchor\" href=\"#七-压缩与存储\">#</a> 七 、 压缩与存储</h2>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>总结几点：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">1</span>）不同存储格式的存储文件的大小对比总结：</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ORC <span class=\"token operator\">></span>  Parquet <span class=\"token operator\">></span>  textFile</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span>）存储文件的查询速度测试：基本相差不大。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">-- 在实际的项目开发当中，hive 表的数据存储格式一般选择：orc 或 parquet；压缩方式一般选择 snappy，lzo。</span></pre></td></tr></table></figure><p>压缩方式：</p>\n<table>\n<thead>\n<tr>\n<th>压缩格式</th>\n<th>工具</th>\n<th>算法</th>\n<th>文件扩展名</th>\n<th>是否可切分</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DEFLATE</td>\n<td>无</td>\n<td>DEFLATE</td>\n<td>.deflate</td>\n<td>否</td>\n</tr>\n<tr>\n<td>Gzip</td>\n<td>gzip</td>\n<td>DEFLATE</td>\n<td>.gz</td>\n<td>否</td>\n</tr>\n<tr>\n<td>bzip2</td>\n<td>bzip2</td>\n<td>bzip2</td>\n<td>.bz2</td>\n<td>是</td>\n</tr>\n<tr>\n<td>LZO</td>\n<td>lzop</td>\n<td>LZO</td>\n<td>.lzo</td>\n<td>是</td>\n</tr>\n<tr>\n<td>Snappy</td>\n<td>无</td>\n<td>Snappy</td>\n<td>.snappy</td>\n<td>否</td>\n</tr>\n</tbody>\n</table>\n<p>编码 / 解码器：</p>\n<table>\n<thead>\n<tr>\n<th>压缩格式</th>\n<th>对应的编码 / 解码器</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DEFLATE</td>\n<td>org.apache.hadoop.io.compress.DefaultCodec</td>\n</tr>\n<tr>\n<td>gzip</td>\n<td>org.apache.hadoop.io.compress.GzipCodec</td>\n</tr>\n<tr>\n<td>bzip2</td>\n<td>org.apache.hadoop.io.compress.BZip2Codec</td>\n</tr>\n<tr>\n<td>LZO</td>\n<td>com.hadoop.compression.lzo.LzopCodec</td>\n</tr>\n<tr>\n<td>Snappy</td>\n<td>org.apache.hadoop.io.compress.SnappyCodec</td>\n</tr>\n</tbody>\n</table>\n<p>压缩性能的比较：</p>\n<table>\n<thead>\n<tr>\n<th>压缩算法</th>\n<th>原始文件大小</th>\n<th>压缩文件大小</th>\n<th>压缩速度</th>\n<th>解压速度</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>gzip</td>\n<td>8.3GB</td>\n<td>1.8GB</td>\n<td>17.5MB/s</td>\n<td>58MB/s</td>\n</tr>\n<tr>\n<td>bzip2</td>\n<td>8.3GB</td>\n<td>1.1GB</td>\n<td>2.4MB/s</td>\n<td>9.5MB/s</td>\n</tr>\n<tr>\n<td>LZO</td>\n<td>8.3GB</td>\n<td>2.9GB</td>\n<td>49.3MB/s</td>\n<td>74.6MB/s</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight sql\"><figcaption data-lang=\"SQL\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> log_parquet_snappy<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>track_time string<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>url string<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>session_id string<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>referer string<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ip string<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>end_user_id string<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>city_id string</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">row</span> format delimited <span class=\"token keyword\">fields</span> <span class=\"token keyword\">terminated</span> <span class=\"token keyword\">by</span> <span class=\"token string\">'\\t'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>stored <span class=\"token keyword\">as</span> parquet  <span class=\"token comment\">-- 指明文件的存储格式</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>tblproperties<span class=\"token punctuation\">(</span><span class=\"token string\">\"parquet.compression\"</span><span class=\"token operator\">=</span><span class=\"token string\">\"SNAPPY\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">-- 指明文件的压缩方式</span></pre></td></tr></table></figure>",
            "tags": [
                "大数据",
                "Hive"
            ]
        }
    ]
}